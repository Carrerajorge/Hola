<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Test Client</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #4ecca3;
        }
        .controls {
            background: #16213e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .form-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }
        .form-row:last-child { margin-bottom: 0; }
        input[type="text"] {
            flex: 1;
            min-width: 150px;
            padding: 0.6rem 0.8rem;
            border: 1px solid #4ecca3;
            border-radius: 4px;
            background: #0f3460;
            color: #fff;
            font-size: 0.9rem;
        }
        input::placeholder { color: #888; }
        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.85; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-connect { background: #4ecca3; color: #1a1a2e; }
        .btn-disconnect { background: #e74c3c; color: #fff; }
        .btn-clear { background: #666; color: #fff; }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #16213e;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }
        .status-dot.connecting { background: #f1c40f; animation: pulse 1s infinite; }
        .status-dot.connected { background: #4ecca3; }
        .status-dot.disconnected { background: #666; }
        .status-dot.error { background: #e74c3c; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .stat { font-size: 0.85rem; color: #aaa; }
        .stat span { color: #4ecca3; font-weight: 600; }
        .events-container {
            background: #16213e;
            border-radius: 8px;
            overflow: hidden;
        }
        .events-header {
            background: #0f3460;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }
        .events-log {
            height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
        }
        .event {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            border-left: 3px solid #4ecca3;
            background: rgba(78, 204, 163, 0.1);
        }
        .event.connected { border-color: #4ecca3; }
        .event.trace { border-color: #3498db; background: rgba(52, 152, 219, 0.1); }
        .event.tool_call { border-color: #9b59b6; background: rgba(155, 89, 182, 0.1); }
        .event.tool_result { border-color: #1abc9c; background: rgba(26, 188, 156, 0.1); }
        .event.heartbeat { border-color: #95a5a6; background: rgba(149, 165, 166, 0.1); }
        .event.final { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .event.error { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .event.timeout { border-color: #f39c12; background: rgba(243, 156, 18, 0.1); }
        .event-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            color: #aaa;
            font-size: 0.75rem;
        }
        .event-type { 
            font-weight: 600;
            text-transform: uppercase;
            color: #4ecca3;
        }
        .event.trace .event-type { color: #3498db; }
        .event.tool_call .event-type { color: #9b59b6; }
        .event.tool_result .event-type { color: #1abc9c; }
        .event.heartbeat .event-type { color: #95a5a6; }
        .event.final .event-type { color: #2ecc71; }
        .event.error .event-type { color: #e74c3c; }
        .event-data {
            word-break: break-all;
            white-space: pre-wrap;
        }
        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
            input[type="text"] { min-width: 100%; }
            .stats { flex-direction: column; gap: 0.5rem; }
            .events-log { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŒŠ SSE Test Client</h1>
        
        <div class="controls">
            <div class="form-row">
                <input type="text" id="sessionId" placeholder="Session ID (e.g., test123)" value="test-session-1">
                <input type="text" id="prompt" placeholder="Prompt message">
            </div>
            <div class="form-row">
                <input type="text" id="lastEventId" placeholder="Last-Event-ID (for replay)">
                <button id="connectBtn" class="btn-connect">Connect</button>
                <button id="disconnectBtn" class="btn-disconnect" disabled>Disconnect</button>
                <button id="clearBtn" class="btn-clear">Clear Log</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status">
                <div id="statusDot" class="status-dot disconnected"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="stats">
                <div class="stat">Events: <span id="eventCount">0</span></div>
                <div class="stat">Heartbeats: <span id="heartbeatCount">0</span></div>
                <div class="stat">Last Event ID: <span id="currentEventId">-</span></div>
            </div>
        </div>

        <div class="events-container">
            <div class="events-header">
                <span>Event Log</span>
                <span id="connectionTime">-</span>
            </div>
            <div id="eventsLog" class="events-log"></div>
        </div>
    </div>

    <script>
        const elements = {
            sessionId: document.getElementById('sessionId'),
            prompt: document.getElementById('prompt'),
            lastEventId: document.getElementById('lastEventId'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            clearBtn: document.getElementById('clearBtn'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            eventCount: document.getElementById('eventCount'),
            heartbeatCount: document.getElementById('heartbeatCount'),
            currentEventId: document.getElementById('currentEventId'),
            connectionTime: document.getElementById('connectionTime'),
            eventsLog: document.getElementById('eventsLog')
        };

        let eventSource = null;
        let eventCount = 0;
        let heartbeatCount = 0;
        let connectionStartTime = null;
        let connectionTimer = null;

        function setStatus(status, text) {
            elements.statusDot.className = `status-dot ${status}`;
            elements.statusText.textContent = text;
        }

        function updateConnectionTime() {
            if (!connectionStartTime) {
                elements.connectionTime.textContent = '-';
                return;
            }
            const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            elements.connectionTime.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function logEvent(type, data, eventId) {
            const div = document.createElement('div');
            div.className = `event ${type}`;
            
            const now = new Date().toLocaleTimeString();
            const idStr = eventId ? `ID: ${eventId}` : '';
            
            div.innerHTML = `
                <div class="event-header">
                    <span class="event-type">${type}</span>
                    <span>${now} ${idStr}</span>
                </div>
                <div class="event-data">${JSON.stringify(data, null, 2)}</div>
            `;
            
            elements.eventsLog.appendChild(div);
            elements.eventsLog.scrollTop = elements.eventsLog.scrollHeight;
            
            if (type === 'heartbeat') {
                heartbeatCount++;
                elements.heartbeatCount.textContent = heartbeatCount;
            } else {
                eventCount++;
                elements.eventCount.textContent = eventCount;
            }
            
            if (eventId) {
                elements.currentEventId.textContent = eventId;
                elements.lastEventId.value = eventId;
            }
        }

        function connect() {
            const sessionId = elements.sessionId.value.trim();
            if (!sessionId) {
                alert('Please enter a Session ID');
                return;
            }

            const params = new URLSearchParams({ session_id: sessionId });
            const prompt = elements.prompt.value.trim();
            if (prompt) params.append('prompt', prompt);

            const baseUrl = window.location.origin.replace(':5000', ':8000');
            let url = `${baseUrl}/chat/stream?${params}`;

            setStatus('connecting', 'Connecting...');
            elements.connectBtn.disabled = true;

            const lastEventId = elements.lastEventId.value.trim();
            
            eventSource = new EventSource(url);
            
            if (lastEventId) {
                eventSource.close();
                const headers = { 'Last-Event-ID': lastEventId };
                fetch(url, { headers })
                    .then(() => {
                        eventSource = new EventSource(url);
                        setupEventHandlers();
                    })
                    .catch(err => {
                        logEvent('error', { message: 'Failed to reconnect with Last-Event-ID' });
                        disconnect();
                    });
            } else {
                setupEventHandlers();
            }
        }

        function setupEventHandlers() {
            eventSource.onopen = () => {
                setStatus('connected', 'Connected');
                elements.connectBtn.disabled = true;
                elements.disconnectBtn.disabled = false;
                connectionStartTime = Date.now();
                connectionTimer = setInterval(updateConnectionTime, 1000);
            };

            eventSource.onerror = (err) => {
                console.error('SSE Error:', err);
                if (eventSource.readyState === EventSource.CLOSED) {
                    setStatus('disconnected', 'Disconnected');
                    logEvent('error', { message: 'Connection closed' });
                } else {
                    setStatus('error', 'Error - Reconnecting...');
                    logEvent('error', { message: 'Connection error, attempting reconnect...' });
                }
            };

            const eventTypes = ['connected', 'trace', 'tool_call', 'tool_result', 'final', 'error', 'heartbeat', 'timeout'];
            
            eventTypes.forEach(type => {
                eventSource.addEventListener(type, (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        logEvent(type, data, e.lastEventId);
                        
                        if (type === 'final' || type === 'timeout') {
                            setTimeout(disconnect, 1000);
                        }
                    } catch (err) {
                        logEvent(type, { raw: e.data, parseError: err.message }, e.lastEventId);
                    }
                });
            });
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            setStatus('disconnected', 'Disconnected');
            elements.connectBtn.disabled = false;
            elements.disconnectBtn.disabled = true;
            
            if (connectionTimer) {
                clearInterval(connectionTimer);
                connectionTimer = null;
            }
            connectionStartTime = null;
            updateConnectionTime();
        }

        function clearLog() {
            elements.eventsLog.innerHTML = '';
            eventCount = 0;
            heartbeatCount = 0;
            elements.eventCount.textContent = '0';
            elements.heartbeatCount.textContent = '0';
            elements.currentEventId.textContent = '-';
        }

        elements.connectBtn.addEventListener('click', connect);
        elements.disconnectBtn.addEventListener('click', disconnect);
        elements.clearBtn.addEventListener('click', clearLog);

        elements.sessionId.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') connect();
        });
        elements.prompt.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') connect();
        });
    </script>
</body>
</html>
