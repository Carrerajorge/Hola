import React, { useState, useEffect, useRef, useCallback } from "react";
import {
  Plus,
  Upload,
  Search,
  Image,
  Video,
  Bot,
  Plug,
  Globe,
  FileText,
  ChevronRight,
  ChevronDown,
  X,
  Loader2,
  CheckCircle2,
  Maximize2,
  Minimize2,
  Users,
  Calendar,
  Contact,
  Settings2,
  Wand2,
  Sparkles,
  Presentation,
  Clock
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { HoverCard, HoverCardContent, HoverCardTrigger } from "@/components/ui/hover-card";
import { cn } from "@/lib/utils";
import { SourceListItem } from "@/components/ui/source-list-item";
import { RecordingPanel } from "@/components/recording-panel";
import { useConnectedSources } from "@/hooks/use-connected-sources";
import { useCommandHistory } from "@/hooks/use-command-history";
import { VirtualComputer } from "@/components/virtual-computer";
import { getFileTheme } from "@/lib/fileTypeTheme";
import "@/components/ui/glass-effects.css";

interface UploadedFile {
  id?: string;
  name: string;
  type: string;
  mimeType?: string;
  size: number;
  dataUrl?: string;
  storagePath?: string;
  status?: string;
  content?: string;
  spreadsheetData?: {
    uploadId: string;
    sheets: Array<{ name: string; rowCount: number; columnCount: number }>;
    previewData?: { headers: string[]; data: any[][] };
  };
}

import { type BrowserSessionState } from "@/hooks/use-browser-session";

interface BrowserSession {
  state: BrowserSessionState;
  cancel: () => void;
}

export interface ComposerProps {
  input: string;
  setInput: (value: string) => void;
  textareaRef: React.RefObject<HTMLTextAreaElement | null>;
  composerRef: React.RefObject<HTMLDivElement | null>;
  fileInputRef: React.RefObject<HTMLInputElement | null>;
  uploadedFiles: UploadedFile[];
  removeFile: (index: number) => void;
  handleSubmit: () => void;
  handleFileUpload: (e: React.ChangeEvent<HTMLInputElement>) => void;
  handlePaste: (e: React.ClipboardEvent<HTMLTextAreaElement>) => void;
  handleDragOver: (e: React.DragEvent) => void;
  handleDragEnter: (e: React.DragEvent) => void;
  handleDragLeave: (e: React.DragEvent) => void;
  handleDrop: (e: React.DragEvent) => void;
  isDraggingOver: boolean;
  selectedTool: "web" | "agent" | "image" | null;
  setSelectedTool: (tool: "web" | "agent" | "image" | null) => void;
  selectedDocTool: "word" | "excel" | "ppt" | "figma" | null;
  setSelectedDocTool: (tool: "word" | "excel" | "ppt" | "figma" | null) => void;
  closeDocEditor: () => void;
  openBlankDocEditor: (type: "word" | "excel" | "ppt", options?: { showInstructions?: boolean }) => void;
  aiState: "idle" | "thinking" | "responding" | "agent_working";
  isRecording: boolean;
  isPaused: boolean;
  recordingTime: number;
  toggleVoiceRecording: () => void;
  discardVoiceRecording: () => void;
  pauseVoiceRecording: () => void;
  resumeVoiceRecording: () => void;
  sendVoiceRecording: () => void;
  handleStopChat: () => void;
  isAgentRunning?: boolean;
  handleAgentStop?: () => void;
  setIsVoiceChatOpen: (value: boolean) => void;
  browserSession: BrowserSession;
  isBrowserOpen: boolean;
  setIsBrowserOpen: (value: boolean) => void;
  isBrowserMaximized: boolean;
  setIsBrowserMaximized: (value: boolean) => void;
  browserUrl: string;
  variant: "default" | "document";
  placeholder: string;
  selectedDocText?: string;
  handleDocTextDeselect?: () => void;
  onCloseSidebar?: () => void;
  setPreviewUploadedImage?: (value: { name: string; dataUrl: string } | null) => void;
  isFigmaConnected?: boolean;
  isFigmaConnecting?: boolean;
  handleFigmaConnect?: () => void;
  handleFigmaDisconnect?: () => void;
  onOpenGoogleForms?: () => void;
  onOpenApps?: () => void;
  isGoogleFormsActive?: boolean;
  setIsGoogleFormsActive?: (value: boolean) => void;
  onTextareaFocus?: () => void;
  isFilesLoading?: boolean;
}

function formatFileSize(bytes: number): string {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
}

export function Composer({
  input,
  setInput,
  textareaRef,
  composerRef,
  fileInputRef,
  uploadedFiles,
  removeFile,
  handleSubmit,
  handleFileUpload,
  handlePaste,
  handleDragOver,
  handleDragEnter,
  handleDragLeave,
  handleDrop,
  isDraggingOver,
  selectedTool,
  setSelectedTool,
  selectedDocTool,
  setSelectedDocTool,
  closeDocEditor,
  openBlankDocEditor,
  aiState,
  isRecording,
  isPaused,
  recordingTime,
  toggleVoiceRecording,
  discardVoiceRecording,
  pauseVoiceRecording,
  resumeVoiceRecording,
  sendVoiceRecording,
  handleStopChat,
  isAgentRunning,
  handleAgentStop,
  setIsVoiceChatOpen,
  browserSession,
  isBrowserOpen,
  setIsBrowserOpen,
  isBrowserMaximized,
  setIsBrowserMaximized,
  browserUrl,
  variant,
  placeholder,
  selectedDocText,
  handleDocTextDeselect,
  onCloseSidebar,
  setPreviewUploadedImage,
  isFigmaConnected,
  isFigmaConnecting,
  handleFigmaConnect,
  handleFigmaDisconnect,
  onOpenGoogleForms,
  onOpenApps,
  isGoogleFormsActive,
  setIsGoogleFormsActive,
  onTextareaFocus,
  isFilesLoading = false,
}: ComposerProps) {
  const isDocumentMode = variant === "document";
  const hasContent = input.trim().length > 0 || uploadedFiles.length > 0;

  const [showKnowledgeBase, setShowKnowledgeBase] = useState(false);

  const [showMentionPopover, setShowMentionPopover] = useState(false);
  const [mentionSearch, setMentionSearch] = useState("");
  const [mentionIndex, setMentionIndex] = useState(0);
  const [recentTemplates, setRecentTemplates] = useState<string[]>([]);

  const quickActionTemplates = [
    {
      id: "image",
      label: "Generar imagen",
      icon: Sparkles,
      template: "Genera una imagen de ",
      color: "from-pink-500 to-rose-500",
      bgColor: "bg-pink-50 dark:bg-pink-950/30",
      textColor: "text-pink-600 dark:text-pink-400",
      borderColor: "border-pink-200 dark:border-pink-800",
    },
    {
      id: "document",
      label: "Crear documento",
      icon: FileText,
      template: "Crea un documento Word sobre ",
      color: "from-blue-500 to-blue-600",
      bgColor: "bg-blue-50 dark:bg-blue-950/30",
      textColor: "text-blue-600 dark:text-blue-400",
      borderColor: "border-blue-200 dark:border-blue-800",
    },
    {
      id: "presentation",
      label: "Crear presentación",
      icon: Presentation,
      template: "Crea una presentación PowerPoint sobre ",
      color: "from-orange-500 to-amber-500",
      bgColor: "bg-orange-50 dark:bg-orange-950/30",
      textColor: "text-orange-600 dark:text-orange-400",
      borderColor: "border-orange-200 dark:border-orange-800",
    },
    {
      id: "web",
      label: "Buscar en web",
      icon: Search,
      template: "Busca en la web información sobre ",
      color: "from-cyan-500 to-teal-500",
      bgColor: "bg-cyan-50 dark:bg-cyan-950/30",
      textColor: "text-cyan-600 dark:text-cyan-400",
      borderColor: "border-cyan-200 dark:border-cyan-800",
    },
  ];

  useEffect(() => {
    const stored = localStorage.getItem("recentQuickTemplates");
    if (stored) {
      try {
        setRecentTemplates(JSON.parse(stored));
      } catch {
        setRecentTemplates([]);
      }
    }
  }, []);

  const handleQuickAction = useCallback((templateId: string, template: string) => {
    setInput(template);
    textareaRef.current?.focus();
    setTimeout(() => {
      if (textareaRef.current) {
        textareaRef.current.setSelectionRange(template.length, template.length);
      }
    }, 0);

    const newRecent = [templateId, ...recentTemplates.filter((id: string) => id !== templateId)].slice(0, 4);
    setRecentTemplates(newRecent);
    localStorage.setItem("recentQuickTemplates", JSON.stringify(newRecent));
  }, [setInput, textareaRef, recentTemplates]);

  const { connectedSources, getSourceActive, setSourceActive } = useConnectedSources();
  const { addToHistory, navigateUp, navigateDown, resetNavigation } = useCommandHistory();

  const mentionSources = connectedSources.map((source: any) => ({
    ...source,
    mention: source.id === 'gmail' ? '@Gmail' : source.id === 'googleForms' ? '@GoogleForms' : `@${source.name}`,
    action: source.id === 'googleForms' ? () => onOpenGoogleForms?.() : () => { }
  }));

  const filteredSources = mentionSources.filter((source: any) =>
    source.name.toLowerCase().includes(mentionSearch.toLowerCase()) ||
    source.mention.toLowerCase().includes(mentionSearch.toLowerCase())
  );

  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const value = e.target.value;
    setInput(value);
    resetNavigation();

    const cursorPos = e.target.selectionStart || 0;
    const textBeforeCursor = value.slice(0, cursorPos);
    const atMatch = textBeforeCursor.match(/@(\w*)$/);

    if (atMatch) {
      setShowMentionPopover(true);
      setMentionSearch(atMatch[1]);
      setMentionIndex(0);
    } else {
      setShowMentionPopover(false);
      setMentionSearch("");
    }
  };

  const handleSubmitWithHistory = () => {
    if (input.trim()) {
      addToHistory(input.trim());
    }
    handleSubmit();
  };

  const handleHistoryNavigation = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    const textarea = e.currentTarget;
    const cursorPosition = textarea.selectionStart;
    const textLength = textarea.value.length;

    if (e.key === "ArrowUp" && cursorPosition === 0) {
      const historyItem = navigateUp(input);
      if (historyItem !== null) {
        e.preventDefault();
        setInput(historyItem);
        setTimeout(() => {
          textarea.setSelectionRange(historyItem.length, historyItem.length);
        }, 0);
      }
    } else if (e.key === "ArrowDown" && cursorPosition === textLength) {
      const historyItem = navigateDown();
      if (historyItem !== null) {
        e.preventDefault();
        setInput(historyItem);
        setTimeout(() => {
          textarea.setSelectionRange(historyItem.length, historyItem.length);
        }, 0);
      }
    }
  };

  const insertMention = (source: typeof mentionSources[0]) => {
    const cursorPos = textareaRef.current?.selectionStart || 0;
    const textBeforeCursor = input.slice(0, cursorPos);
    const textAfterCursor = input.slice(cursorPos);
    const atMatch = textBeforeCursor.match(/@(\w*)$/);

    if (atMatch) {
      const newText = textBeforeCursor.slice(0, -atMatch[0].length) + source.mention + ' ' + textAfterCursor;
      setInput(newText);
    }

    setShowMentionPopover(false);
    setMentionSearch("");
    textareaRef.current?.focus();

    setSourceActive(source.id, true);
    if (source.id === 'googleForms') {
      setIsGoogleFormsActive?.(true);
    }
  };

  const handleMentionKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (!showMentionPopover || filteredSources.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setMentionIndex((prev: number) => (prev + 1) % filteredSources.length);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setMentionIndex((prev: number) => (prev - 1 + filteredSources.length) % filteredSources.length);
    } else if (e.key === 'Enter' || e.key === 'Tab') {
      e.preventDefault();
      insertMention(filteredSources[mentionIndex]);
    } else if (e.key === 'Escape') {
      setShowMentionPopover(false);
    }
  };

  const toggleKnowledgeSource = (sourceId: string) => {
    const currentValue = getSourceActive(sourceId);
    setSourceActive(sourceId, !currentValue);

    if (sourceId === 'googleForms') {
      setIsGoogleFormsActive?.(!currentValue);
    }
  };

  const renderAttachmentPreview = () => {
    if (uploadedFiles.length === 0) return null;

    if (isDocumentMode) {
      return (
        <div className="flex flex-wrap gap-2 mb-2 px-1" data-testid="inline-attachments-container">
          {uploadedFiles.map((file, index) => (
            <div
              key={file.id || index}
              className={cn(
                "relative group rounded-lg border overflow-hidden",
                file.status === "error"
                  ? "bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800"
                  : "bg-card border-border"
              )}
              data-testid={`inline-file-${index}`}
            >
              <button
                className="absolute top-1 right-1 bg-black/60 hover:bg-black/80 rounded-full p-0.5 text-white z-10 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-white/50"
                onClick={() => removeFile(index)}
                aria-label={`Remove file ${file.name}`}
                title={`Remove file ${file.name}`}
                data-testid={`button-remove-file-${index}`}
              >
                <X className="h-3 w-3" />
              </button>
              {file.type.startsWith("image/") && file.dataUrl ? (
                <div className="relative w-16 h-16">
                  <img
                    src={file.dataUrl}
                    alt={file.name}
                    className="w-full h-full object-cover rounded-lg"
                  />
                  {(file.status === "uploading" || file.status === "processing") && (
                    <div className="absolute inset-0 bg-black/40 flex items-center justify-center rounded-lg">
                      <Loader2 className="h-4 w-4 animate-spin text-white" />
                    </div>
                  )}
                  {file.status === "ready" && (
                    <div className="absolute bottom-0 right-0 bg-green-500 rounded-tl-md p-0.5">
                      <CheckCircle2 className="h-2.5 w-2.5 text-white" />
                    </div>
                  )}
                </div>
              ) : (
                <div className="flex items-center gap-2 px-2 py-1.5 pr-6 max-w-[180px]">
                  <div className={cn(
                    "flex items-center justify-center w-8 h-8 rounded flex-shrink-0",
                    (file.name.toLowerCase().endsWith(".pdf") || file.type.includes("pdf")) ? "bg-red-500" :
                      (file.name.toLowerCase().endsWith(".docx") || file.name.toLowerCase().endsWith(".doc") || file.type.includes("word") || file.type.includes("document") || file.type.includes("wordprocessing")) ? "bg-blue-600" :
                        (file.name.toLowerCase().endsWith(".xlsx") || file.name.toLowerCase().endsWith(".xls") || file.name.toLowerCase().endsWith(".csv") || file.type.includes("sheet") || file.type.includes("excel") || file.type.includes("spreadsheet")) ? "bg-green-600" :
                          (file.name.toLowerCase().endsWith(".pptx") || file.name.toLowerCase().endsWith(".ppt") || file.type.includes("presentation") || file.type.includes("powerpoint")) ? "bg-orange-500" :
                            "bg-muted-foreground"
                  )}>
                    <span className="text-white text-[10px] font-bold">
                      {(file.name.toLowerCase().endsWith(".pdf") || file.type.includes("pdf")) ? "PDF" :
                        (file.name.toLowerCase().endsWith(".docx") || file.name.toLowerCase().endsWith(".doc") || file.type.includes("word") || file.type.includes("document") || file.type.includes("wordprocessing")) ? "DOC" :
                          (file.name.toLowerCase().endsWith(".xlsx") || file.name.toLowerCase().endsWith(".xls") || file.name.toLowerCase().endsWith(".csv") || file.type.includes("sheet") || file.type.includes("excel") || file.type.includes("spreadsheet")) ? "XLS" :
                            (file.name.toLowerCase().endsWith(".pptx") || file.name.toLowerCase().endsWith(".ppt") || file.type.includes("presentation") || file.type.includes("powerpoint")) ? "PPT" :
                              "FILE"}
                    </span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <span className="text-xs font-medium truncate block">{file.name}</span>
                    <span className="text-[10px] text-muted-foreground">
                      {file.status === "uploading" ? "Subiendo..." :
                        file.status === "processing" ? "Procesando..." :
                          file.status === "error" ? "Error" :
                            formatFileSize(file.size)}
                    </span>
                  </div>
                  {(file.status === "uploading" || file.status === "processing") && (
                    <Loader2 className="h-3 w-3 animate-spin text-blue-500 flex-shrink-0" />
                  )}
                  {file.status === "ready" && (
                    <CheckCircle2 className="h-3 w-3 text-green-500 flex-shrink-0" />
                  )}
                </div>
              )}
            </div>
          ))}
        </div>
      );
    }

    return (
      <div className="flex items-center gap-2 pl-2">
        {uploadedFiles.map((file, index) => {
          const theme = getFileTheme(file.name, file.mimeType);
          const isImage = file.type?.startsWith("image/") || file.mimeType?.startsWith("image/");

          if (isImage && file.dataUrl) {
            return (
              <div key={file.id} className="relative group">
                <div
                  className="relative w-14 h-14 rounded-lg overflow-hidden cursor-pointer border border-border hover:border-primary transition-colors"
                  onClick={() => setPreviewUploadedImage?.({ name: file.name, dataUrl: file.dataUrl! })}
                  data-testid={`preview-image-${index}`}
                >
                  <img
                    src={file.dataUrl}
                    alt={file.name}
                    className="w-full h-full object-cover"
                  />
                  {(file.status === "uploading" || file.status === "processing") && (
                    <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
                      <Loader2 className="h-4 w-4 text-white animate-spin" />
                    </div>
                  )}
                </div>
                <button
                  className="absolute -top-1.5 -right-1.5 w-5 h-5 rounded-full bg-destructive text-white flex items-center justify-center opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity shadow-md focus:outline-none focus:ring-2 focus:ring-destructive/50"
                  onClick={(e: React.MouseEvent) => { e.stopPropagation(); removeFile(index); }}
                  aria-label={`Remove file ${file.name}`}
                  title={`Remove file ${file.name}`}
                  data-testid={`button-remove-file-${index}`}
                >
                  <X className="h-3 w-3" />
                </button>
              </div>
            );
          }


          return (
            <TooltipProvider key={file.id}>
              <Tooltip>
                <TooltipTrigger asChild>
                  <div
                    className={cn(
                      "relative group flex items-center gap-2 px-2 py-1.5 rounded-lg text-xs transition-all duration-200 cursor-pointer",
                      file.status === "uploading" && "bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800",
                      file.status === "processing" && "bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800",
                      file.status === "ready" && "bg-muted/50 border border-border hover:bg-muted",
                      file.status === "error" && "bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800"
                    )}
                  >
                    <div className={cn(
                      "flex items-center justify-center w-7 h-7 rounded shrink-0",
                      theme.bgColor
                    )}>
                      {file.status === "uploading" || file.status === "processing" ? (
                        <Loader2 className="h-4 w-4 text-white animate-spin" />
                      ) : (
                        <span className="text-white text-xs font-bold">
                          {theme.icon}
                        </span>
                      )}
                    </div>
                    <span className="max-w-[100px] truncate font-medium">{file.name}</span>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-5 w-5 shrink-0 text-muted-foreground hover:text-red-500 transition-colors"
                      onClick={(e: React.MouseEvent) => { e.stopPropagation(); removeFile(index); }}
                      aria-label={`Remove file ${file.name}`}
                      data-testid={`button-remove-file-${index}`}
                    >
                      <X className="h-3 w-3" />
                    </Button>
                  </div>
                </TooltipTrigger>
                <TooltipContent side="top">
                  <p className="text-xs">{file.name} ({formatFileSize(file.size)})</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          );
        })}
      </div>
    );
  };

  const renderToolsPopover = () => (
    <Popover>
      <PopoverTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          aria-label="Open tools menu"
          title="Open tools menu"
          className={cn(
            "liquid-plus-button h-10 w-10 flex-shrink-0 focus-visible:ring-2 focus-visible:ring-primary/50",
            isDocumentMode && "h-11 w-11"
          )}
        >
          <Plus className="h-5 w-5" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className={cn("p-1", isDocumentMode ? "w-48" : "w-56 p-2")} align="start" side="top">
        <div className={cn(isDocumentMode ? "flex flex-col" : "grid gap-1")}>
          {isDocumentMode ? (
            <>
              <Button
                variant="ghost"
                className="justify-start gap-3 text-sm h-10 glass-menu-item"
                onClick={() => fileInputRef.current?.click()}
                data-testid="button-upload-files"
              >
                <div className="flex items-center justify-center w-6 h-6 rounded-lg bg-muted">
                  <Upload className="h-4 w-4" />
                </div>
                Upload Files
              </Button>
              <Button
                variant="ghost"
                className="justify-start gap-2 text-sm h-9 glass-menu-item"
                onClick={() => setIsBrowserOpen(!isBrowserOpen)}
              >
                <Search className="h-4 w-4" />
                Web Search
              </Button>
              <Button variant="ghost" className="justify-start gap-2 text-sm h-9 glass-menu-item">
                <Image className="h-4 w-4" />
                Image Generation
              </Button>
              <Button variant="ghost" className="justify-start gap-2 text-sm h-9 glass-menu-item">
                <Video className="h-4 w-4" />
                Video Generation
              </Button>
              <Button variant="ghost" className="justify-start gap-2 text-sm h-9 glass-menu-item">
                <Bot className="h-4 w-4" />
                Agente
              </Button>
              <Button variant="ghost" className="justify-start gap-2 text-sm h-9 glass-menu-item">
                <Plug className="h-4 w-4" />
                Connectors MPC
              </Button>
            </>
          ) : (
            <>
              <label className="cursor-pointer">
                <input
                  type="file"
                  className="hidden"
                  multiple
                  accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.webp"
                  onChange={handleFileUpload}
                />
                <Button variant="ghost" className="w-full justify-start gap-2 text-sm h-9 glass-menu-item" asChild>
                  <span>
                    <Upload className="h-4 w-4" />
                    Subir archivo
                  </span>
                </Button>
              </label>
              <Button
                variant="ghost"
                className="justify-start gap-2 text-sm h-9 glass-menu-item"
                onClick={() => { setShowKnowledgeBase(true); onCloseSidebar?.(); }}
                data-testid="button-knowledge-base"
              >
                <Users className="h-4 w-4" />
                Conocimientos de la empresa
              </Button>
              <Button
                variant="ghost"
                className="justify-start gap-3 text-sm h-10 glass-menu-item"
                onClick={() => { setSelectedTool("web"); onCloseSidebar?.(); }}
              >
                <div className="flex items-center justify-center w-6 h-6 rounded-lg bg-cyan-100 dark:bg-cyan-900/30">
                  <Globe className="h-4 w-4 text-cyan-600 dark:text-cyan-400" />
                </div>
                Navegar en la web
              </Button>
              <Button
                variant="ghost"
                className="justify-start gap-3 text-sm h-10 glass-menu-item"
                onClick={() => { setSelectedTool("image"); onCloseSidebar?.(); }}
              >
                <div className="flex items-center justify-center w-6 h-6 rounded-lg bg-pink-100 dark:bg-pink-900/30">
                  <Image className="h-4 w-4 text-pink-600 dark:text-pink-400" />
                </div>
                Generar imagen
              </Button>

              <HoverCard openDelay={100} closeDelay={100}>
                <HoverCardTrigger asChild>
                  <Button variant="ghost" className="justify-between gap-2 text-sm h-9 w-full glass-menu-item">
                    <span className="flex items-center gap-2">
                      <FileText className="h-4 w-4" />
                      Crear documento
                    </span>
                    <ChevronRight className="h-4 w-4" />
                  </Button>
                </HoverCardTrigger>
                <HoverCardContent side="right" align="start" className="w-48 p-2">
                  <div className="grid gap-1">
                    <Button
                      variant="ghost"
                      className="justify-start gap-2 text-sm h-9 glass-menu-item"
                      onClick={() => openBlankDocEditor("word")}
                      data-testid="button-create-word"
                    >
                      <div className="flex items-center justify-center w-5 h-5 rounded bg-blue-600">
                        <span className="text-white text-xs font-bold">W</span>
                      </div>
                      Documento Word
                    </Button>
                    <Button
                      variant="ghost"
                      className="justify-start gap-2 text-sm h-9 glass-menu-item"
                      onClick={() => openBlankDocEditor("excel")}
                      data-testid="button-create-excel"
                    >
                      <div className="flex items-center justify-center w-5 h-5 rounded bg-green-600">
                        <span className="text-white text-xs font-bold">X</span>
                      </div>
                      Hoja Excel
                    </Button>
                    <Button
                      variant="ghost"
                      className="justify-start gap-2 text-sm h-9 glass-menu-item"
                      onClick={() => openBlankDocEditor("ppt")}
                      data-testid="button-create-ppt"
                    >
                      <div className="flex items-center justify-center w-5 h-5 rounded bg-orange-500">
                        <span className="text-white text-xs font-bold">P</span>
                      </div>
                      Presentación PPT
                    </Button>
                    <Button
                      variant="ghost"
                      className="justify-start gap-2 text-sm h-9 glass-menu-item"
                      onClick={() => { setSelectedDocTool("figma"); onCloseSidebar?.(); }}
                    >
                      <div className="flex items-center justify-center w-5 h-5 rounded bg-card border border-border">
                        <svg width="10" height="14" viewBox="0 0 38 57" fill="none">
                          <path d="M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z" fill="#1ABCFE" />
                          <path d="M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z" fill="#0ACF83" />
                          <path d="M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z" fill="#FF7262" />
                          <path d="M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z" fill="#F24E1E" />
                          <path d="M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z" fill="#A259FF" />
                        </svg>
                      </div>
                      Diagrama Figma
                    </Button>
                  </div>
                </HoverCardContent>
              </HoverCard>

              <Button
                variant="ghost"
                className="justify-start gap-2 text-sm h-9 glass-menu-item"
                onClick={() => { setSelectedTool("agent"); onCloseSidebar?.(); }}
              >
                <Bot className="h-4 w-4" />
                Agente
              </Button>
            </>
          )}
        </div>
      </PopoverContent>
    </Popover>
  );

  const renderSelectedToolLogo = () => {
    if (!selectedTool) return null;

    return (
      <div className="relative group shrink-0">
        <div
          className={cn(
            "relative flex items-center justify-center w-10 h-10 rounded-xl cursor-pointer overflow-hidden",
            "transition-all duration-500 ease-out",
            "hover:shadow-lg hover:shadow-current/30",
            "before:absolute before:inset-0 before:rounded-xl before:opacity-0 before:transition-opacity before:duration-300",
            "hover:before:opacity-100 before:bg-gradient-to-br before:from-white/20 before:to-transparent",
            "after:absolute after:inset-0 after:rounded-xl after:opacity-0 after:transition-all after:duration-700",
            "hover:after:opacity-100 after:animate-pulse",
            selectedTool === "web" && "bg-gradient-to-br from-cyan-500 to-cyan-700 after:bg-cyan-400/20",
            selectedTool === "agent" && "bg-gradient-to-br from-purple-500 to-purple-700 after:bg-purple-400/20",
            selectedTool === "image" && "bg-gradient-to-br from-pink-500 to-rose-600 after:bg-pink-400/20",
            "animate-[liquid-float_3s_ease-in-out_infinite]"
          )}
          data-testid="button-selected-tool"
        >
          {selectedTool === "web" ? (
            <Globe className="h-5 w-5 text-white z-10 drop-shadow-md" />
          ) : selectedTool === "image" ? (
            <Image className="h-5 w-5 text-white z-10 drop-shadow-md" />
          ) : (
            <Bot className="h-5 w-5 text-white z-10 drop-shadow-md" />
          )}
        </div>
        <button
          onClick={() => setSelectedTool(null)}
          aria-label="Close tool"
          className={cn(
            "absolute -top-1 -right-1 w-4 h-4 rounded-full",
            "bg-red-500 hover:bg-red-600 text-white",
            "flex items-center justify-center",
            "opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100",
            "transition-all duration-200 ease-out",
            "shadow-md hover:shadow-lg"
          )}
          data-testid="button-close-tool"
        >
          <X className="h-2.5 w-2.5" />
        </button>
      </div>
    );
  };

  const renderSelectedDocToolLogo = () => {
    if (!selectedDocTool) return null;

    return (
      <div className="relative group shrink-0">
        <div
          className={cn(
            "relative flex items-center justify-center w-10 h-10 rounded-xl cursor-pointer overflow-hidden",
            "transition-all duration-500 ease-out",
            "hover:shadow-lg hover:shadow-current/30",
            isDocumentMode ? "" : "before:absolute before:inset-0 before:rounded-xl before:opacity-0 before:transition-opacity before:duration-300 hover:before:opacity-100 before:bg-gradient-to-br before:from-white/20 before:to-transparent after:absolute after:inset-0 after:rounded-xl after:opacity-0 after:transition-all after:duration-700 hover:after:opacity-100 after:animate-pulse",
            selectedDocTool === "word" && "bg-gradient-to-br from-blue-500 to-blue-700",
            selectedDocTool === "excel" && "bg-gradient-to-br from-green-500 to-green-700",
            selectedDocTool === "ppt" && "bg-gradient-to-br from-orange-400 to-orange-600",
            selectedDocTool === "figma" && "bg-gradient-to-br from-purple-500 to-pink-500",
            !isDocumentMode && selectedDocTool === "word" && "after:bg-blue-400/20",
            !isDocumentMode && selectedDocTool === "excel" && "after:bg-green-400/20",
            !isDocumentMode && selectedDocTool === "figma" && "after:bg-purple-400/20",
            "animate-[liquid-float_3s_ease-in-out_infinite]"
          )}
          data-testid="button-selected-doc-tool"
        >
          {selectedDocTool === "figma" ? (
            <svg width="16" height="24" viewBox="0 0 38 57" fill="none" className="z-10 drop-shadow-md">
              <path d="M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z" fill="#1ABCFE" />
              <path d="M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z" fill="#0ACF83" />
              <path d="M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z" fill="#FF7262" />
              <path d="M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z" fill="#F24E1E" />
              <path d="M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z" fill="#A259FF" />
            </svg>
          ) : (
            <span className="text-white text-base font-bold z-10 drop-shadow-md">
              {selectedDocTool === "word" ? "W" : selectedDocTool === "excel" ? "E" : "P"}
            </span>
          )}
        </div>
        <button
          onClick={isDocumentMode ? closeDocEditor : () => setSelectedDocTool(null)}
          aria-label="Close document tool"
          className={cn(
            "absolute -top-1 -right-1 w-4 h-4 rounded-full",
            "bg-red-500 hover:bg-red-600 text-white",
            "flex items-center justify-center",
            "opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100",
            "transition-all duration-200 ease-out",
            "shadow-md hover:shadow-lg"
          )}
          data-testid="button-close-doc-tool"
        >
          <X className="h-2.5 w-2.5" />
        </button>
      </div>
    );
  };

  const containerClass = isDocumentMode
    ? cn(
      "p-4 sm:p-6 w-full max-w-3xl mx-auto relative bg-background z-10",
      isDraggingOver && "ring-2 ring-primary rounded-2xl"
    )
    : "shrink-0 w-full px-4 pb-4 pt-2 bg-background";

  const inputContainerClass = isDocumentMode
    ? "relative flex flex-col rounded-xl bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm border border-zinc-100 dark:border-zinc-800 px-4 py-3 focus-within:border-zinc-300 dark:focus-within:border-zinc-600 transition-colors duration-200"
    : cn(
      // Professional Premium Container
      "max-w-3xl mx-auto relative transition-all duration-300 ease-out overflow-visible",
      // Glass Background & Blur
      "bg-white/70 dark:bg-zinc-900/70 backdrop-blur-xl",
      // Premium Border
      "border border-black/5 dark:border-white/10",
      // Shape & Spacing
      "rounded-[26px] px-5 py-4",
      // Elevated Shadow
      "shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgb(0,0,0,0.08)]",
      // Focus State (Subtle Glow)
      "focus-within:shadow-[0_0_0_2px_rgba(var(--primary),0.1),0_8px_40px_rgba(0,0,0,0.1)] focus-within:border-primary/30",

      selectedDocText && "border-primary/20",
      isDraggingOver && "border-primary/50 bg-primary/5 ring-4 ring-primary/10"
    );

  return (
    <div
      ref={composerRef}
      className={containerClass}
      onDragOver={handleDragOver}
      onDragEnter={handleDragEnter}
      onDragLeave={handleDragLeave}
      onDrop={handleDrop}
    >
      {isDraggingOver && (
        <div className="absolute inset-0 z-50 bg-primary/10 backdrop-blur-sm rounded-2xl flex items-center justify-center border-2 border-dashed border-primary pointer-events-none">
          <div className="flex flex-col items-center gap-2 text-primary">
            <Upload className="h-8 w-8" />
            <span className="text-sm font-medium">Suelta los archivos aquí</span>
          </div>
        </div>
      )}

      {isDocumentMode && (
        <>
          <div className="absolute left-4 sm:left-6 bottom-[calc(100%+8px)] z-20">
            <VirtualComputer
              state={browserSession.state}
              onCancel={browserSession.cancel}
              compact={true}
            />
          </div>

          {(isBrowserOpen || input.trim().length > 0) && !isBrowserMaximized && (
            <div className="absolute left-4 sm:left-6 bottom-[calc(100%-16px)] w-[120px] border rounded-lg overflow-hidden shadow-lg bg-card z-20 transition-all duration-200">
              <div className="flex items-center justify-between px-1 py-0.5 bg-muted/50 border-b">
                <span className="text-[8px] font-medium text-muted-foreground">Computadora Virtual</span>
                <div className="flex items-center">
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-4 w-4 text-muted-foreground hover:text-foreground"
                    onClick={() => setIsBrowserMaximized(true)}
                  >
                    <Maximize2 className="h-2 w-2" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-4 w-4 text-muted-foreground hover:text-foreground"
                    onClick={() => setIsBrowserOpen(false)}
                  >
                    <X className="h-2 w-2" />
                  </Button>
                </div>
              </div>
              <div className="bg-card relative h-[100px]">
                <iframe
                  src={browserUrl}
                  className="w-full h-full border-0"
                  sandbox="allow-scripts allow-same-origin allow-forms"
                  title="Virtual Browser"
                />
                {aiState !== "idle" && (
                  <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                    <Loader2 className="h-4 w-4 animate-spin text-blue-500" />
                  </div>
                )}
              </div>
            </div>
          )}

          {isBrowserMaximized && (
            <div className="fixed inset-4 z-50 border rounded-lg overflow-hidden shadow-lg bg-card">
              <div className="flex items-center justify-between px-2 py-1 bg-muted/50 border-b">
                <span className="text-xs font-medium text-muted-foreground">Computadora Virtual</span>
                <div className="flex items-center gap-1">
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-6 w-6 text-muted-foreground hover:text-foreground"
                    onClick={() => setIsBrowserMaximized(false)}
                  >
                    <Minimize2 className="h-3 w-3" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-6 w-6 text-muted-foreground hover:text-foreground"
                    onClick={() => { setIsBrowserOpen(false); setIsBrowserMaximized(false); }}
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </div>
              </div>
              <div className="bg-card relative h-[calc(100%-28px)]">
                <iframe
                  src={browserUrl}
                  className="w-full h-full border-0"
                  sandbox="allow-scripts allow-same-origin allow-forms"
                  title="Virtual Browser"
                />
                {aiState !== "idle" && (
                  <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                    <Loader2 className="h-6 w-6 animate-spin text-blue-500" />
                  </div>
                )}
              </div>
            </div>
          )}
        </>
      )}

      <input
        type="file"
        ref={fileInputRef}
        onChange={handleFileUpload}
        className="hidden"
        multiple
        accept="*/*"
        data-testid="input-file-upload"
        aria-label="Subir archivos"
      />

      <div className={inputContainerClass}>
        {renderAttachmentPreview()}

        {isDocumentMode && selectedDocText && handleDocTextDeselect && (
          <div className="mb-3 animate-in fade-in duration-150" data-testid="selected-doc-text-banner">
            <div className="bg-zinc-200/60 dark:bg-zinc-700/40 rounded-lg px-3 py-1.5 text-sm text-zinc-600 dark:text-zinc-300 flex items-center gap-2">
              <FileText className="h-3.5 w-3.5 flex-shrink-0 opacity-70" />
              <span className="truncate flex-1" data-testid="selected-doc-text-preview">
                {selectedDocText.length > 50 ? selectedDocText.substring(0, 50) + '...' : selectedDocText}
              </span>
              <button
                onClick={handleDocTextDeselect}
                className="text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-200 flex-shrink-0 p-0.5 rounded hover:bg-zinc-300/50 dark:hover:bg-zinc-600/50 transition-colors"
                aria-label="Deselect text"
                data-testid="button-deselect-doc-text"
              >
                <X className="h-3 w-3" />
              </button>
            </div>
          </div>
        )}


        <div className="flex flex-col relative">
          <Textarea
            ref={textareaRef}
            value={input}
            onChange={handleInputChange}
            onFocus={onTextareaFocus}
            onKeyDown={(e: React.KeyboardEvent<HTMLTextAreaElement>) => {
              handleMentionKeyDown(e);
              if (showMentionPopover) return;
              handleHistoryNavigation(e);
              const filesStillLoading = isFilesLoading || uploadedFiles.some(f => f.status === "uploading" || f.status === "processing");
              if ((e.metaKey || e.ctrlKey) && e.key === "Enter" && !filesStillLoading) {
                e.preventDefault();
                handleSubmitWithHistory();
                return;
              }
              if (e.key === "Enter" && !e.shiftKey && !filesStillLoading) {
                e.preventDefault();
                handleSubmitWithHistory();
              }
            }}
            onPaste={handlePaste}
            placeholder={placeholder}
            aria-label="Message input"
            aria-describedby="composer-hint"
            className="min-h-[24px] max-h-[180px] w-full resize-none border-0 bg-transparent p-0 shadow-none focus-visible:ring-0 focus-visible:ring-offset-0 text-[15px] text-zinc-800 dark:text-zinc-100 placeholder:text-zinc-400/70 dark:placeholder:text-zinc-500/60 leading-relaxed overflow-y-auto scrollbar-none"
            rows={1}
          />

          <div className="flex items-center justify-between mt-2 pt-1 border-t border-border/40">
            <div className="flex items-center gap-2">
              {renderToolsPopover()}
              {!isDocumentMode && renderSelectedToolLogo()}
              {renderSelectedDocToolLogo()}

              {showKnowledgeBase && (
                <div className="flex items-center gap-2">
                  <div className="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-sky-100/80 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400 text-[13px] font-medium" data-testid="knowledge-base-active">
                    <Users className="h-4 w-4" />
                    <span className="max-w-[140px] truncate" data-testid="knowledge-base-label">Conocimientos de la e...</span>
                    <button
                      onClick={() => setShowKnowledgeBase(false)}
                      className="ml-0.5 hover:bg-sky-200/50 dark:hover:bg-sky-800/50 rounded p-0.5 transition-colors focus:outline-none"
                      aria-label="Close knowledge base"
                      data-testid="button-close-knowledge-base"
                    >
                      <X className="h-3 w-3" />
                    </button>
                  </div>

                  {connectedSources.filter(s => getSourceActive(s.id)).map(source => (
                    <div key={source.id} className="flex items-center justify-center w-7 h-7 rounded-lg bg-sky-100/60 dark:bg-sky-900/20 text-sky-600 dark:text-sky-400">
                      {source.icon}
                    </div>
                  ))}

                  <Popover>
                    <PopoverTrigger asChild>
                      <button
                        className="flex items-center justify-center w-7 h-7 rounded-lg hover:bg-sky-100/60 dark:hover:bg-sky-900/30 text-sky-600 dark:text-sky-400 transition-colors"
                        aria-label="Select sources"
                        data-testid="button-fuentes-dropdown"
                      >
                        <ChevronDown className="h-4 w-4" />
                      </button>
                    </PopoverTrigger>
                    <PopoverContent align="start" className="w-52 p-1 bg-white dark:bg-zinc-800 border-zinc-200 dark:border-zinc-700" data-testid="fuentes-popover">
                      <div className="grid gap-0.5">
                        <div className="px-2 py-1 text-[10px] font-medium text-zinc-400 uppercase tracking-wider">
                          Fuentes conectadas
                        </div>

                        {connectedSources.length === 0 ? (
                          <div className="px-2 py-2 text-xs text-zinc-400 text-center">
                            No hay fuentes
                          </div>
                        ) : (
                          connectedSources.map(source => (
                            <SourceListItem
                              key={source.id}
                              icon={source.icon}
                              label={source.name}
                              variant="toggle"
                              checked={getSourceActive(source.id)}
                              onCheckedChange={() => toggleKnowledgeSource(source.id)}
                              data-testid={`source-${source.id}`}
                            />
                          ))
                        )}

                        <div className="border-t border-zinc-100 dark:border-zinc-700 mt-0.5 pt-0.5">
                          <SourceListItem
                            icon={
                              <svg className="h-3.5 w-3.5" viewBox="0 0 16 16" fill="currentColor">
                                <circle cx="4" cy="8" r="1.5" />
                                <circle cx="8" cy="8" r="1.5" />
                                <circle cx="12" cy="8" r="1.5" />
                                <circle cx="4" cy="4" r="1.5" />
                                <circle cx="8" cy="4" r="1.5" />
                                <circle cx="12" cy="4" r="1.5" />
                              </svg>
                            }
                            label="Conectar más"
                            variant="connect"
                            onConnect={() => onOpenApps?.()}
                            data-testid="source-connect-more"
                          />
                        </div>
                      </div>
                    </PopoverContent>
                  </Popover>
                </div>
              )}
            </div>

            <div className="flex items-center gap-2">
              {/* Character counter */}
              {input.length > 0 && (
                <span className="text-[11px] text-muted-foreground tabular-nums" data-testid="char-counter">
                  {input.length.toLocaleString()} / 10,000
                </span>
              )}

              {/* Keyboard shortcut hint */}
              <span className="hidden sm:flex items-center text-[10px] text-muted-foreground/70">
                <kbd className="px-1 py-0.5 rounded bg-muted/50 text-[9px] font-mono">⌘K</kbd>
                <span className="ml-1">comandos</span>
              </span>

              <RecordingPanel
                isRecording={isRecording}
                isPaused={isPaused}
                recordingTime={recordingTime}
                canSend={hasContent}
                onDiscard={discardVoiceRecording}
                onPause={pauseVoiceRecording}
                onResume={resumeVoiceRecording}
                onSend={sendVoiceRecording}
                onToggleRecording={toggleVoiceRecording}
                onOpenVoiceChat={() => setIsVoiceChatOpen(true)}
                onStopChat={handleStopChat}
                onSubmit={handleSubmit}
                aiState={aiState}
                hasContent={hasContent}
                isAgentRunning={isAgentRunning}
                onAgentStop={handleAgentStop}
                isFilesLoading={isFilesLoading}
              />
            </div>
          </div>
        </div>

        {showMentionPopover && filteredSources.length > 0 && (
          <div
            className="absolute bottom-full left-0 mb-2 w-56 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-xl shadow-lg z-50 overflow-hidden"
            data-testid="mention-popover"
          >
            <div className="px-3 py-1.5 text-[11px] font-medium text-zinc-500 border-b border-zinc-100 dark:border-zinc-700 uppercase tracking-wide">
              Fuentes
            </div>
            <div className="py-0.5">
              {filteredSources.map((source, index) => (
                <button
                  key={source.id}
                  onClick={() => insertMention(source)}
                  className={cn(
                    "w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-700/50 transition-colors text-left",
                    index === mentionIndex && "bg-zinc-100 dark:bg-zinc-700"
                  )}
                  data-testid={`mention-${source.id}`}
                >
                  <div className="flex items-center justify-center w-6 h-6 rounded bg-zinc-100 dark:bg-zinc-700 text-zinc-500">
                    {source.icon}
                  </div>
                  <div className="flex flex-col">
                    <span className="font-medium text-zinc-800 dark:text-zinc-100 text-sm">{source.name}</span>
                    <span className="text-[11px] text-zinc-400">{source.mention}</span>
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}

      </div>

      <div id="composer-hint" className="text-center text-[10px] text-zinc-400/50 dark:text-zinc-600/60 mt-2 font-normal tracking-wide select-none">
        <span className="sr-only">Press Enter to send, Shift+Enter for new line, or Cmd+Enter to send quickly. </span>
        ILIAGPT puede cometer errores. Verifica la información importante.
      </div>

    </div>
  );
}
