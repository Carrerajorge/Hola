import { useState, useRef } from "react";
import { useLocation } from "wouter";
import { useAuth } from "@/hooks/use-auth";
import { usePinnedGpts } from "@/hooks/use-pinned-gpts";
import {
  Menu,
  Search,
  Library,
  Bot,
  Plus,
  MessageSquare,
  MoreHorizontal,
  Settings,
  PanelLeftClose,
  ChevronDown,
  ChevronRight,
  User,
  CreditCard,
  Shield,
  LogOut,
  Trash2,
  Pencil,
  Archive,
  EyeOff,
  Eye,
  Check,
  X,
  Monitor,
  LayoutGrid,
  FolderPlus,
  Folder,
  FolderOpen,
  Zap,
  SquarePen,
  Pin,
  Download,
  MoveRight
} from "lucide-react";
import { IliaGPTLogo } from "@/components/iliagpt-logo";
import { cn } from "@/lib/utils";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Button } from "@/components/ui/button";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from "@/components/ui/dropdown-menu";
import { Input } from "@/components/ui/input";
import { SearchModal } from "@/components/search-modal";
import { SettingsDialog } from "@/components/settings-dialog";

import { Chat } from "@/hooks/use-chats";
import { Folder as FolderType } from "@/hooks/use-chat-folders";
import { format, isToday, isYesterday, isThisWeek, isThisYear } from "date-fns";
import { DropdownMenuSub, DropdownMenuSubTrigger, DropdownMenuSubContent, DropdownMenuPortal } from "@/components/ui/dropdown-menu";
import { Collapsible, CollapsibleTrigger, CollapsibleContent } from "@/components/ui/collapsible";
import { NewChatButton } from "@/components/chat/NewChatButton";
import { useProcessingChatIds, useChatStreamContent } from "@/stores/streamingStore";
import { CreateProjectModal, type CreateProjectData } from "@/components/create-project-modal";
import { EditProjectModal } from "@/components/edit-project-modal";
import { ProjectMemoriesModal } from "@/components/project-memories-modal";
import { ShareProjectModal } from "@/components/share-project-modal";
import { DeleteConfirmDialog } from "@/components/delete-confirm-dialog";
import { useProjects, type Project } from "@/hooks/use-projects";

interface SidebarProps {
  className?: string;
  chats: Chat[];
  hiddenChats?: Chat[];
  pinnedChats?: Chat[];
  activeChatId: string | null;
  onSelectChat: (id: string) => void;
  onNewChat?: () => void;
  onToggle?: () => void;
  onDeleteChat?: (id: string, e: React.MouseEvent) => void;
  onEditChat?: (id: string, newTitle: string) => void;
  onArchiveChat?: (id: string, e: React.MouseEvent) => void;
  onHideChat?: (id: string, e: React.MouseEvent) => void;
  onPinChat?: (id: string, e: React.MouseEvent) => void;
  onDownloadChat?: (id: string, e: React.MouseEvent) => void;
  onOpenGpts?: () => void;
  onOpenApps?: () => void;
  onOpenSkills?: () => void;
  onOpenLibrary?: () => void;
  processingChatIds?: string[];
  pendingResponseCounts?: Record<string, number>;
  onClearPendingCount?: (chatId: string) => void;
  folders?: FolderType[];
  onCreateFolder?: (name: string) => void;
  onMoveToFolder?: (chatId: string, folderId: string | null) => void;
  selectedProjectId?: string | null;
  onSelectProject?: (projectId: string) => void;
}

/**
 * Enhanced streaming indicator with animated progress ring
 * Shows visual progress as content streams in
 */
function StreamingProgressIndicator({ chatId }: { chatId: string }) {
  const content = useChatStreamContent(chatId);
  const contentLength = content?.length || 0;

  // Estimate progress based on typical response length (~2000 chars)
  const estimatedTotal = 2000;
  const progress = Math.min(contentLength / estimatedTotal, 0.95);
  const circumference = 2 * Math.PI * 6; // radius = 6
  const strokeDashoffset = circumference * (1 - progress);

  return (
    <div className="relative h-5 w-5 flex-shrink-0" title={`${Math.round(progress * 100)}% cargado`}>
      {/* Background circle */}
      <svg className="h-5 w-5 -rotate-90" viewBox="0 0 16 16">
        <circle
          cx="8"
          cy="8"
          r="6"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          className="text-muted-foreground/20"
        />
        {/* Progress arc */}
        <circle
          cx="8"
          cy="8"
          r="6"
          fill="none"
          stroke="url(#progress-gradient)"
          strokeWidth="2"
          strokeLinecap="round"
          strokeDasharray={circumference}
          strokeDashoffset={strokeDashoffset}
          className="transition-all duration-300"
        />
        <defs>
          <linearGradient id="progress-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="hsl(228, 97%, 50%)" />
            <stop offset="100%" stopColor="hsl(260, 97%, 55%)" />
          </linearGradient>
        </defs>
      </svg>
      {/* Pulsing center dot */}
      <div className="absolute inset-0 flex items-center justify-center">
        <div className="h-1.5 w-1.5 rounded-full bg-blue-500 animate-pulse" />
      </div>
    </div>
  );
}

function ChatSpinner() {
  return (
    <svg
      className="h-4 w-4 flex-shrink-0"
      fill="hsl(228, 97%, 42%)"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <g>
        <circle cx="12" cy="3" r="1">
          <animate id="spinner_7Z73" begin="0;spinner_tKsu.end-0.5s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="16.50" cy="4.21" r="1">
          <animate id="spinner_Wd87" begin="spinner_7Z73.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="7.50" cy="4.21" r="1">
          <animate id="spinner_tKsu" begin="spinner_tVVl.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="19.79" cy="7.50" r="1">
          <animate id="spinner_5L0R" begin="spinner_Wd87.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="4.21" cy="7.50" r="1">
          <animate id="spinner_tVVl" begin="spinner_u6j3.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="21.00" cy="12.00" r="1">
          <animate id="spinner_JSUN" begin="spinner_5L0R.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="3.00" cy="12.00" r="1">
          <animate id="spinner_u6j3" begin="spinner_YHwI.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="19.79" cy="16.50" r="1">
          <animate id="spinner_GKXF" begin="spinner_JSUN.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="4.21" cy="16.50" r="1">
          <animate id="spinner_YHwI" begin="spinner_xGMk.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="16.50" cy="19.79" r="1">
          <animate id="spinner_pMgl" begin="spinner_GKXF.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="7.50" cy="19.79" r="1">
          <animate id="spinner_xGMk" begin="spinner_pMgl.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
        <circle cx="12" cy="21" r="1">
          <animate begin="spinner_xGMk.begin+0.1s" attributeName="r" calcMode="spline" dur="0.6s" values="1;2;1" keySplines=".27,.42,.37,.99;.53,0,.61,.73" />
        </circle>
      </g>
    </svg>
  );
}

export function Sidebar({
  className,
  chats,
  hiddenChats = [],
  pinnedChats = [],
  activeChatId,
  onSelectChat,
  onNewChat,
  onToggle,
  onDeleteChat,
  onEditChat,
  onArchiveChat,
  onHideChat,
  onPinChat,
  onDownloadChat,
  onOpenGpts,
  onOpenApps,
  onOpenSkills,
  onOpenLibrary,
  processingChatIds = [],
  pendingResponseCounts = {},
  onClearPendingCount,
  folders = [],
  onCreateFolder,
  onMoveToFolder,
  selectedProjectId,
  onSelectProject
}: SidebarProps) {
  const [, setLocation] = useLocation();
  const { user, logout } = useAuth();
  const { pinnedGpts, unpinGpt } = usePinnedGpts();
  const handleLogout = () => {
    logout();
  };
  const [editingChatId, setEditingChatId] = useState<string | null>(null);
  const [editTitle, setEditTitle] = useState("");
  const [showHidden, setShowHidden] = useState(false);
  const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);
  const [isUserMenuOpen, setIsUserMenuOpen] = useState(false);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const searchButtonRef = useRef<HTMLButtonElement>(null);
  const [expandedFolders, setExpandedFolders] = useState<Set<string>>(new Set());
  const [isCreatingFolder, setIsCreatingFolder] = useState(false);
  const [newFolderName, setNewFolderName] = useState("");
  const [isCreateProjectOpen, setIsCreateProjectOpen] = useState(false);
  const [editingProject, setEditingProject] = useState<Project | null>(null);
  const [memoriesProject, setMemoriesProject] = useState<Project | null>(null);
  const [shareProject, setShareProject] = useState<Project | null>(null);
  const [deletingProject, setDeletingProject] = useState<Project | null>(null);
  const [deletingChatId, setDeletingChatId] = useState<string | null>(null);

  // Projects hook for project folder management
  const { projects, createProject, deleteProject, updateProject, addChatToProject, getProjectForChat } = useProjects();

  const toggleFolder = (folderId: string) => {
    setExpandedFolders(prev => {
      const next = new Set(prev);
      if (next.has(folderId)) {
        next.delete(folderId);
      } else {
        next.add(folderId);
      }
      return next;
    });
  };

  const handleCreateFolder = () => {
    if (newFolderName.trim() && onCreateFolder) {
      onCreateFolder(newFolderName.trim());
      setNewFolderName("");
      setIsCreatingFolder(false);
    }
  };

  const allFolderChatIds = new Set(folders.flatMap(f => f.chatIds));
  const unfolderedChats = chats.filter(chat => !allFolderChatIds.has(chat.id));

  const handleStartEdit = (chat: Chat, e: React.MouseEvent) => {
    e.stopPropagation();
    setEditingChatId(chat.id);
    setEditTitle(chat.title);
  };

  const handleSaveEdit = (chatId: string) => {
    if (onEditChat && editTitle.trim()) {
      onEditChat(chatId, editTitle.trim());
    }
    setEditingChatId(null);
    setEditTitle("");
  };

  const handleCancelEdit = () => {
    setEditingChatId(null);
    setEditTitle("");
  };

  const getChatDateLabel = (timestamp: number) => {
    const date = new Date(timestamp);
    if (isToday(date)) return "Today";
    if (isYesterday(date)) return "Yesterday";
    if (isThisWeek(date)) return "Previous 7 Days";
    if (isThisYear(date)) return format(date, "MMM d");
    return format(date, "yyyy");
  };

  // Group unfoldered chats
  const groupedChats = unfolderedChats.reduce((groups, chat) => {
    const label = getChatDateLabel(chat.timestamp);
    if (!groups[label]) groups[label] = [];
    groups[label].push(chat);
    return groups;
  }, {} as Record<string, Chat[]>);

  const renderChatItem = (chat: Chat, indented = false) => (
    <div
      key={chat.id}
      className={cn(
        "group relative flex w-full items-center px-2 py-2.5 rounded-xl cursor-pointer liquid-hover hover:bg-accent transition-all duration-300",
        activeChatId === chat.id && "bg-accent shadow-sm",
        chat.archived && "opacity-70",
        indented && "ml-4"
      )}
      onClick={() => !editingChatId && onSelectChat(chat.id)}
      data-testid={`chat-item-${chat.id}`}
    >
      {editingChatId === chat.id ? (
        <div className="flex w-full items-center gap-1" onClick={(e) => e.stopPropagation()}>
          <Input
            value={editTitle}
            onChange={(e) => setEditTitle(e.target.value)}
            className="h-7 text-sm flex-1"
            autoFocus
            onKeyDown={(e) => {
              if (e.key === "Enter") handleSaveEdit(chat.id);
              if (e.key === "Escape") handleCancelEdit();
            }}
            data-testid={`input-edit-chat-${chat.id}`}
          />
          <Button
            variant="ghost"
            size="icon"
            className="h-6 w-6"
            onClick={() => handleSaveEdit(chat.id)}
            data-testid={`button-save-edit-${chat.id}`}
          >
            <Check className="h-3 w-3 text-green-500" />
          </Button>
          <Button
            variant="ghost"
            size="icon"
            className="h-6 w-6"
            onClick={handleCancelEdit}
            data-testid={`button-cancel-edit-${chat.id}`}
          >
            <X className="h-3 w-3 text-red-500" />
          </Button>
        </div>
      ) : (
        <>
          {/* 3-dot menu on the LEFT */}
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <button
                type="button"
                className="flex-shrink-0 h-7 w-7 flex items-center justify-center rounded-md opacity-100 hover:bg-muted transition-colors mr-1"
                onClick={(e) => e.stopPropagation()}
                data-testid={`button-chat-menu-${chat.id}`}
              >
                <MoreHorizontal className="h-4 w-4 text-muted-foreground" />
              </button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="w-52" sideOffset={5}>
              <DropdownMenuItem
                onClick={(e) => onPinChat?.(chat.id, e as unknown as React.MouseEvent)}
                data-testid={`menu-pin-${chat.id}`}
              >
                <Pin className="h-4 w-4 mr-2" />
                {chat.pinned ? "Desfijar" : "Fijar chat"}
              </DropdownMenuItem>
              <DropdownMenuItem
                onClick={(e) => handleStartEdit(chat, e as unknown as React.MouseEvent)}
                data-testid={`menu-edit-${chat.id}`}
              >
                <Pencil className="h-4 w-4 mr-2" />
                Editar
              </DropdownMenuItem>
              <DropdownMenuSub>
                <DropdownMenuSubTrigger data-testid={`menu-move-folder-${chat.id}`}>
                  <Folder className="h-4 w-4 mr-2" />
                  Mover a carpeta
                </DropdownMenuSubTrigger>
                <DropdownMenuPortal>
                  <DropdownMenuSubContent>
                    {/* Create new folder option */}
                    <DropdownMenuItem
                      onClick={() => setIsCreatingFolder(true)}
                      data-testid={`menu-create-folder-${chat.id}`}
                    >
                      <FolderPlus className="h-4 w-4 mr-2" />
                      Crear carpeta
                    </DropdownMenuItem>

                    {/* Show existing projects as folder options */}
                    {projects.length > 0 && (
                      <>
                        <DropdownMenuSeparator />
                        <p className="px-2 py-1.5 text-xs text-muted-foreground font-medium">Proyectos</p>
                        {projects.map((project) => {
                          const isInThisProject = project.chatIds.includes(chat.id);
                          return (
                            <DropdownMenuItem
                              key={project.id}
                              onClick={() => {
                                if (isInThisProject) {
                                  // Remove from this project
                                  const updatedChatIds = project.chatIds.filter(id => id !== chat.id);
                                  updateProject(project.id, { chatIds: updatedChatIds });
                                } else {
                                  // Add to this project
                                  addChatToProject(chat.id, project.id);
                                }
                              }}
                              data-testid={`menu-project-${project.id}-${chat.id}`}
                            >
                              <span
                                className="h-3 w-3 rounded-full mr-2 flex-shrink-0"
                                style={{ backgroundColor: project.color }}
                              />
                              <span className="flex-1 truncate">{project.name}</span>
                              {isInThisProject && <Check className="h-4 w-4 ml-2 text-green-500" />}
                            </DropdownMenuItem>
                          );
                        })}
                      </>
                    )}

                    {/* Also show chat folders if any exist */}
                    {folders.length > 0 && (
                      <>
                        <DropdownMenuSeparator />
                        <p className="px-2 py-1.5 text-xs text-muted-foreground font-medium">Carpetas</p>
                        {folders.map((folder) => (
                          <DropdownMenuItem
                            key={folder.id}
                            onClick={() => onMoveToFolder?.(chat.id, folder.id)}
                            data-testid={`menu-folder-${folder.id}-${chat.id}`}
                          >
                            <span
                              className="h-3 w-3 rounded-full mr-2 flex-shrink-0"
                              style={{ backgroundColor: folder.color }}
                            />
                            {folder.name}
                          </DropdownMenuItem>
                        ))}
                        {allFolderChatIds.has(chat.id) && (
                          <DropdownMenuItem
                            onClick={() => onMoveToFolder?.(chat.id, null)}
                            data-testid={`menu-remove-folder-${chat.id}`}
                          >
                            <X className="h-4 w-4 mr-2" />
                            Quitar de carpeta
                          </DropdownMenuItem>
                        )}
                      </>
                    )}
                  </DropdownMenuSubContent>
                </DropdownMenuPortal>
              </DropdownMenuSub>
              <DropdownMenuItem
                onClick={(e) => onDownloadChat?.(chat.id, e as unknown as React.MouseEvent)}
                data-testid={`menu-download-${chat.id}`}
              >
                <Download className="h-4 w-4 mr-2" />
                Descargar
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem
                onClick={(e) => onArchiveChat?.(chat.id, e as unknown as React.MouseEvent)}
                data-testid={`menu-archive-${chat.id}`}
              >
                <Archive className="h-4 w-4 mr-2" />
                {chat.archived ? "Desarchivar" : "Archivar"}
              </DropdownMenuItem>
              <DropdownMenuItem
                onClick={(e) => onHideChat?.(chat.id, e as unknown as React.MouseEvent)}
                data-testid={`menu-hide-${chat.id}`}
              >
                {chat.hidden ? <Eye className="h-4 w-4 mr-2" /> : <EyeOff className="h-4 w-4 mr-2" />}
                {chat.hidden ? "Mostrar" : "Ocultar"}
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem
                onClick={(e) => {
                  e.stopPropagation();
                  handleLogout();
                }}
                data-testid={`menu-logout-${chat.id}`}
              >
                <LogOut className="h-4 w-4 mr-2" />
                Cerrar sesi贸n
              </DropdownMenuItem>
              <DropdownMenuItem
                onClick={(e) => {
                  e.stopPropagation();
                  setDeletingChatId(chat.id);
                }}
                className="text-red-500 focus:text-red-500"
                data-testid={`menu-delete-${chat.id}`}
              >
                <Trash2 className="h-4 w-4 mr-2" />
                Eliminar
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
          {/* Chat title and indicators */}
          <div className="flex items-center gap-2 min-w-0 flex-1 overflow-hidden">
            {chat.archived && <Archive className="h-3 w-3 text-muted-foreground flex-shrink-0" />}
            <TooltipProvider delayDuration={500}>
              <Tooltip>
                <TooltipTrigger asChild>
                  <span className="truncate text-sm font-medium cursor-default">{chat.title}</span>
                </TooltipTrigger>
                <TooltipContent side="right" className="max-w-xs">
                  <p className="text-xs">{chat.title}</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
            {processingChatIds.includes(chat.id) && (
              <StreamingProgressIndicator chatId={chat.id} />
            )}
            {!processingChatIds.includes(chat.id) && pendingResponseCounts[chat.id] > 0 && (
              <span
                className="flex items-center justify-center h-5 min-w-5 px-1.5 rounded-full bg-blue-600 text-white text-xs font-medium flex-shrink-0"
                data-testid={`badge-pending-${chat.id}`}
              >
                {pendingResponseCounts[chat.id]}
              </span>
            )}
          </div>
        </>
      )}
    </div>
  );

  // Order of groups
  const groupOrder = ["Today", "Yesterday", "Previous 7 Days"];
  // Add other dynamic keys that might appear
  Object.keys(groupedChats).forEach(key => {
    if (!groupOrder.includes(key)) groupOrder.push(key);
  });

  return (
    <nav
      className={cn("flex h-screen w-[280px] flex-col liquid-sidebar-light dark:liquid-sidebar text-sidebar-foreground", className)}
      aria-label="Navegaci贸n principal y chats"
      role="navigation"
    >
      <div className="flex h-14 items-center justify-between px-4 py-2">
        <div className="flex items-center gap-2">
          <IliaGPTLogo size={32} />
          <div className="flex flex-col">
            <span className="text-sm font-semibold leading-none liquid-text-gradient">MICHAT</span>
            <span className="text-[10px] text-muted-foreground">AI Platform</span>
          </div>
        </div>
        <Button variant="ghost" size="icon" className="h-8 w-8 liquid-button" onClick={onToggle}>
          <svg className="h-5 w-5 text-muted-foreground" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" strokeWidth="1.5" />
            <line x1="9" y1="3" x2="9" y2="21" stroke="currentColor" strokeWidth="1.5" />
            <path d="M14 9L17 12L14 15" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
          </svg>
        </Button>
      </div>

      <div className="px-2 py-2">
        <NewChatButton onNewChat={onNewChat} variant="full" showTooltip={false} />
        <Button
          ref={searchButtonRef}
          variant="ghost"
          className="w-full justify-start gap-2 px-2 text-sm font-medium liquid-button"
          onClick={() => setIsSearchModalOpen(true)}
          data-testid="button-search-chats"
        >
          <Search className="h-4 w-4" />
          Buscar chats
        </Button>
        <Button
          variant="ghost"
          className="w-full justify-start gap-2 px-2 text-sm font-medium liquid-button"
          onClick={onOpenLibrary}
          data-testid="button-library"
        >
          <Library className="h-4 w-4" />
          Biblioteca
        </Button>
        <Button
          variant="ghost"
          className="w-full justify-start gap-2 px-2 text-sm font-medium liquid-button"
          onClick={onOpenGpts}
          data-testid="button-gpts"
        >
          <Bot className="h-4 w-4" />
          GPTs
        </Button>
        <Button
          variant="ghost"
          className="w-full justify-start gap-2 px-2 text-sm font-medium liquid-button"
          onClick={onOpenSkills}
          data-testid="button-skills"
        >
          <Zap className="h-4 w-4" />
          Skills
        </Button>
        <Button
          variant="ghost"
          className="w-full justify-start gap-2 px-2 text-sm font-medium liquid-button"
          onClick={onOpenApps}
          data-testid="button-apps"
        >
          <LayoutGrid className="h-4 w-4" />
          Aplicaciones
        </Button>
      </div>

      <Separator className="mx-4 my-2 w-auto" />

      <ScrollArea className="flex-1 px-2 liquid-scroll [&_[data-radix-scroll-area-viewport]]:scrollbar-thin [&_[data-radix-scroll-area-viewport]]:scrollbar-thumb-muted-foreground/30 [&_[data-radix-scroll-area-viewport]]:scrollbar-track-transparent hover:[&_[data-radix-scroll-area-viewport]]:scrollbar-thumb-muted-foreground/50">
        <div className="flex flex-col gap-4 pb-4">
          {folders.length > 0 && (
            <div className="flex flex-col gap-0.5">
              <div className="px-2 py-1.5">
                <h3 className="text-xs font-medium text-muted-foreground">Carpetas</h3>
              </div>
              {folders.map((folder) => {
                const folderChats = chats.filter(chat => folder.chatIds.includes(chat.id));
                const isExpanded = expandedFolders.has(folder.id);
                return (
                  <Collapsible key={folder.id} open={isExpanded} onOpenChange={() => toggleFolder(folder.id)}>
                    <CollapsibleTrigger asChild>
                      <div
                        className="flex items-center gap-2 px-2 py-2 rounded-xl cursor-pointer hover:bg-accent transition-all duration-300"
                        data-testid={`folder-${folder.id}`}
                      >
                        {isExpanded ? (
                          <FolderOpen className="h-4 w-4 text-muted-foreground" />
                        ) : (
                          <Folder className="h-4 w-4 text-muted-foreground" />
                        )}
                        <span
                          className="h-2.5 w-2.5 rounded-full flex-shrink-0"
                          style={{ backgroundColor: folder.color }}
                        />
                        <span className="text-sm font-medium flex-1">{folder.name}</span>
                        <span className="text-xs text-muted-foreground">{folderChats.length}</span>
                        <ChevronRight className={cn("h-4 w-4 text-muted-foreground transition-transform", isExpanded && "rotate-90")} />
                      </div>
                    </CollapsibleTrigger>
                    <CollapsibleContent>
                      <div className="flex flex-col gap-0.5 mt-0.5">
                        {folderChats.map((chat) => renderChatItem(chat, true))}
                      </div>
                    </CollapsibleContent>
                  </Collapsible>
                );
              })}
              {isCreatingFolder ? (
                <div className="flex items-center gap-1 px-2 py-1">
                  <Input
                    value={newFolderName}
                    onChange={(e) => setNewFolderName(e.target.value)}
                    placeholder="Nombre de carpeta"
                    className="h-7 text-sm flex-1"
                    autoFocus
                    onKeyDown={(e) => {
                      if (e.key === "Enter") handleCreateFolder();
                      if (e.key === "Escape") {
                        setIsCreatingFolder(false);
                        setNewFolderName("");
                      }
                    }}
                    data-testid="input-new-folder-name"
                  />
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-6 w-6"
                    onClick={handleCreateFolder}
                    data-testid="button-save-folder"
                  >
                    <Check className="h-3 w-3 text-green-500" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-6 w-6"
                    onClick={() => {
                      setIsCreatingFolder(false);
                      setNewFolderName("");
                    }}
                    data-testid="button-cancel-folder"
                  >
                    <X className="h-3 w-3 text-red-500" />
                  </Button>
                </div>
              ) : (
                <Button
                  variant="ghost"
                  size="sm"
                  className="w-full justify-start gap-2 px-2 text-sm text-muted-foreground hover:text-foreground"
                  onClick={() => setIsCreateProjectOpen(true)}
                  data-testid="button-new-folder"
                >
                  <FolderPlus className="h-4 w-4" />
                  Nueva Carpeta
                </Button>
              )}
            </div>
          )}

          {folders.length === 0 && (
            <div className="px-2">
              <Button
                variant="ghost"
                size="sm"
                className="w-full justify-start gap-2 px-2 text-sm text-muted-foreground hover:text-foreground"
                onClick={() => setIsCreateProjectOpen(true)}
                data-testid="button-new-folder"
              >
                <FolderPlus className="h-4 w-4" />
                Nueva Carpeta
              </Button>

              {/* Projects List */}
              {projects.length > 0 && (
                <div className="flex flex-col gap-0.5 mt-2">
                  {projects.map((project) => {
                    const projectChats = chats.filter(chat => project.chatIds.includes(chat.id));
                    const isExpanded = expandedFolders.has(project.id);
                    return (
                      <Collapsible key={project.id} open={isExpanded} onOpenChange={() => toggleFolder(project.id)}>
                        <div className="group flex items-center gap-1 px-2 py-2 rounded-xl hover:bg-accent transition-all duration-300">
                          <CollapsibleTrigger asChild>
                            <button className="p-1 hover:bg-muted rounded cursor-pointer shrink-0">
                              <ChevronRight className={cn("h-4 w-4 text-muted-foreground transition-transform", isExpanded && "rotate-90")} />
                            </button>
                          </CollapsibleTrigger>

                          {/* Three dots menu - ON THE LEFT */}
                          <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                              <button
                                type="button"
                                className="flex-shrink-0 h-7 w-7 flex items-center justify-center rounded-md opacity-100 hover:bg-muted transition-colors"
                                onClick={(e) => e.stopPropagation()}
                                data-testid={`project-menu-${project.id}`}
                              >
                                <MoreHorizontal className="h-4 w-4 text-muted-foreground" />
                              </button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="start" className="w-48" sideOffset={5}>
                              <DropdownMenuItem
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setEditingProject(project);
                                }}
                                data-testid={`project-edit-${project.id}`}
                              >
                                <Pencil className="h-4 w-4 mr-2" />
                                Edit
                              </DropdownMenuItem>
                              <DropdownMenuItem
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setMemoriesProject(project);
                                }}
                                data-testid={`project-memories-${project.id}`}
                              >
                                <Library className="h-4 w-4 mr-2" />
                                Memories
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setShareProject(project);
                                }}
                                data-testid={`project-share-${project.id}`}
                              >
                                <MoveRight className="h-4 w-4 mr-2" />
                                Share
                              </DropdownMenuItem>
                              <DropdownMenuItem
                                onClick={(e) => {
                                  e.stopPropagation();
                                  // Export project as JSON
                                  const exportData = {
                                    ...project,
                                    exportedAt: new Date().toISOString(),
                                    version: "1.0"
                                  };
                                  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
                                  const url = URL.createObjectURL(blob);
                                  const a = document.createElement("a");
                                  a.href = url;
                                  a.download = `${project.name.replace(/[^a-z0-9]/gi, "_")}_project.json`;
                                  document.body.appendChild(a);
                                  a.click();
                                  document.body.removeChild(a);
                                  URL.revokeObjectURL(url);
                                }}
                                data-testid={`project-export-${project.id}`}
                              >
                                <Download className="h-4 w-4 mr-2" />
                                Export
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setDeletingProject(project);
                                }}
                                className="text-red-500 focus:text-red-500"
                                data-testid={`project-delete-${project.id}`}
                              >
                                <Trash2 className="h-4 w-4 mr-2" />
                                Delete
                              </DropdownMenuItem>
                            </DropdownMenuContent>
                          </DropdownMenu>

                          {/* Project content */}
                          <div
                            className={cn(
                              "flex items-center gap-2 flex-1 min-w-0 cursor-pointer p-1 rounded-md transition-colors",
                              selectedProjectId === project.id ? "bg-accent/50 text-accent-foreground" : "hover:bg-muted/50"
                            )}
                            onClick={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              onSelectProject?.(project.id);
                            }}
                            data-testid={`project-${project.id}`}
                          >
                            {project.backgroundImage ? (
                              <div
                                className="h-5 w-5 rounded flex-shrink-0 bg-cover bg-center"
                                style={{ backgroundImage: `url(${project.backgroundImage})` }}
                              />
                            ) : isExpanded ? (
                              <FolderOpen className="h-4 w-4 text-muted-foreground" />
                            ) : (
                              <Folder className="h-4 w-4 text-muted-foreground" />
                            )}
                            <span
                              className="h-2.5 w-2.5 rounded-full flex-shrink-0"
                              style={{ backgroundColor: project.color }}
                            />
                            <span className="text-sm font-medium flex-1 truncate">{project.name}</span>
                            {project.systemPrompt && (
                              <span className="text-xs text-muted-foreground" title="Has system prompt"></span>
                            )}
                            {project.files.length > 0 && (
                              <span className="text-xs text-muted-foreground" title={`${project.files.length} files`}>{project.files.length}</span>
                            )}
                            <span className="text-xs text-muted-foreground">{projectChats.length}</span>
                          </div>
                        </div>
                        <CollapsibleContent>
                          <div className="flex flex-col gap-0.5 mt-0.5">
                            {projectChats.length > 0 ? (
                              projectChats.map((chat) => renderChatItem(chat, true))
                            ) : (
                              <p className="text-xs text-muted-foreground px-6 py-2 italic">
                                No hay chats. Mueve chats aqu铆.
                              </p>
                            )}
                          </div>
                        </CollapsibleContent>
                      </Collapsible>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* Pinned Chats Section */}
          {pinnedChats.length > 0 && (
            <div className="flex flex-col gap-0.5">
              <div className="px-2 py-1.5">
                <h3 className="text-xs font-medium text-muted-foreground flex items-center gap-1">
                  <Pin className="h-3 w-3" />
                  Fijados
                </h3>
              </div>
              {pinnedChats.map((chat) => renderChatItem(chat))}
            </div>
          )}

          {/* Pinned GPTs Section */}
          {pinnedGpts.length > 0 && (
            <div className="flex flex-col gap-0.5">
              <div className="px-2 py-1.5">
                <h3 className="text-xs font-medium text-muted-foreground">GPTs</h3>
              </div>
              {pinnedGpts.map((pinned) => (
                <div
                  key={pinned.gptId}
                  className="group flex w-full items-center justify-between px-2 py-2 rounded-xl cursor-pointer hover:bg-accent transition-all duration-300"
                  onClick={() => setLocation(`/gpts/${pinned.gpt.slug || pinned.gptId}`)}
                  data-testid={`pinned-gpt-${pinned.gptId}`}
                >
                  <div className="flex items-center gap-2 min-w-0">
                    {pinned.gpt.avatar ? (
                      <img
                        src={pinned.gpt.avatar}
                        alt={pinned.gpt.name}
                        className="h-6 w-6 rounded-md object-cover flex-shrink-0"
                      />
                    ) : (
                      <div className="h-6 w-6 rounded-md bg-muted flex items-center justify-center flex-shrink-0">
                        <Bot className="h-4 w-4 text-muted-foreground" />
                      </div>
                    )}
                    <span className="truncate text-sm">{pinned.gpt.name}</span>
                  </div>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-6 w-6 flex-shrink-0"
                        data-testid={`button-pinned-gpt-menu-${pinned.gptId}`}
                      >
                        <MoreHorizontal className="h-4 w-4" />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end" className="w-48">
                      <DropdownMenuItem
                        onClick={(e) => {
                          e.stopPropagation();
                          unpinGpt(pinned.gptId);
                        }}
                        className="flex items-center gap-2"
                        data-testid={`button-unpin-gpt-${pinned.gptId}`}
                      >
                        <Pin className="h-4 w-4" />
                        <span>Desfijar</span>
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </div>
              ))}
            </div>
          )}

          {groupOrder.map((group) => {
            const groupChats = groupedChats[group];
            if (!groupChats || groupChats.length === 0) return null;

            return (
              <div key={group} className="flex flex-col gap-0.5">
                <div className="px-2 py-1.5">
                  <h3 className="text-xs font-medium text-muted-foreground">{group}</h3>
                </div>
                {groupChats.map((chat) => renderChatItem(chat))}
              </div>
            );
          })}
        </div>
      </ScrollArea>

      {/* Hidden Chats Section */}
      {
        hiddenChats.length > 0 && (
          <div className="px-2 border-t">
            <Button
              variant="ghost"
              className="w-full justify-between px-2 py-2 text-sm font-medium text-muted-foreground liquid-button"
              onClick={() => setShowHidden(!showHidden)}
              data-testid="button-toggle-hidden"
            >
              <div className="flex items-center gap-2">
                <EyeOff className="h-4 w-4" />
                <span>Ocultos ({hiddenChats.length})</span>
              </div>
              <ChevronDown className={cn("h-4 w-4 transition-transform", showHidden && "rotate-180")} />
            </Button>
            {showHidden && (
              <div className="flex flex-col gap-0.5 pb-2">
                {hiddenChats.map((chat) => (
                  <div
                    key={chat.id}
                    className="group flex w-full items-center justify-between px-2 py-2 rounded-md cursor-pointer hover:bg-accent transition-colors opacity-70"
                    onClick={() => onSelectChat(chat.id)}
                    data-testid={`hidden-chat-item-${chat.id}`}
                  >
                    <span className="truncate text-sm">{chat.title}</span>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-6 w-6 opacity-0 group-hover:opacity-80"
                      onClick={(e) => {
                        e.stopPropagation();
                        onHideChat?.(chat.id, e);
                      }}
                      data-testid={`button-unhide-${chat.id}`}
                    >
                      <Eye className="h-3 w-3" />
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>
        )
      }

      <div className="mt-auto border-t p-4">
        <div className="flex w-full items-center gap-3 rounded-lg p-2">
          <Popover open={isUserMenuOpen} onOpenChange={setIsUserMenuOpen}>
            <PopoverTrigger asChild>
              <button className="flex flex-1 items-center gap-3 liquid-button cursor-pointer" data-testid="button-user-menu">
                <div className="relative">
                  <Avatar className="h-10 w-10">
                    <AvatarFallback className="bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300">
                      {user?.role === "admin" ? "A" : (user?.firstName?.[0] || user?.email?.[0] || "U").toUpperCase()}
                    </AvatarFallback>
                  </Avatar>
                  {/* Online status indicator */}
                  <span className="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 ring-2 ring-background" title="En l铆nea" />
                </div>
                <div className="flex flex-1 flex-col overflow-hidden text-left">
                  <span className="truncate text-sm font-medium">
                    {user?.role === "admin" ? "Admin" : (user?.firstName || user?.email?.split("@")[0] || "Usuario")}
                  </span>
                  <span className="truncate text-xs text-muted-foreground">
                    {user?.email === "infosiragpt@gmail.com" ? "ENTERPRISE" : "Cuenta personal"}
                  </span>
                </div>
              </button>
            </PopoverTrigger>
            <PopoverContent className="w-auto min-w-56 p-2" align="start" side="top">
              <div className="flex flex-col">
                {/* Profile section */}
                <Button variant="ghost" className="justify-start gap-3 text-sm h-10 font-normal liquid-button" onClick={() => { setIsUserMenuOpen(false); setLocation("/profile"); }} data-testid="button-profile">
                  <User className="h-4 w-4" />
                  Perfil
                </Button>
                {user?.role === "admin" && (
                  <Button variant="ghost" className="justify-start gap-3 text-sm h-10 font-normal liquid-button" onClick={() => { setIsUserMenuOpen(false); setLocation("/billing"); }} data-testid="button-billing">
                    <CreditCard className="h-4 w-4" />
                    Facturaci贸n
                  </Button>
                )}

                <Separator className="my-1.5" />

                {/* Settings section */}
                <Button variant="ghost" className="justify-start gap-3 text-sm h-10 font-normal liquid-button" onClick={() => { setIsUserMenuOpen(false); setLocation("/workspace-settings"); }} data-testid="button-workspace-settings">
                  <Monitor className="h-4 w-4" />
                  Configuraci贸n del espacio de trabajo
                </Button>
                <Button variant="ghost" className="justify-start gap-3 text-sm h-10 font-normal liquid-button" onClick={() => { setIsUserMenuOpen(false); setIsSettingsOpen(true); }} data-testid="button-settings">
                  <Settings className="h-4 w-4" />
                  Configuraci贸n
                </Button>
                <Button variant="ghost" className="justify-start gap-3 text-sm h-10 font-normal liquid-button" onClick={() => { setIsUserMenuOpen(false); setLocation("/privacy"); }} data-testid="button-privacy">
                  <Shield className="h-4 w-4" />
                  Privacidad
                </Button>

                {user?.role === "admin" && (
                  <>
                    <Separator className="my-1.5" />
                    <Button variant="ghost" className="justify-start gap-3 text-sm h-10 font-normal liquid-button" onClick={() => { setIsUserMenuOpen(false); setLocation("/admin"); }} data-testid="button-admin-panel">
                      <Settings className="h-4 w-4" />
                      Admin Panel
                    </Button>
                  </>
                )}

                <Separator className="my-1.5" />
                <Button variant="ghost" className="justify-start gap-3 text-sm h-10 font-normal text-red-500 hover:text-red-600 hover:bg-red-50 liquid-button" onClick={() => { setIsUserMenuOpen(false); handleLogout(); }} data-testid="button-logout">
                  <LogOut className="h-4 w-4" />
                  Cerrar sesi贸n
                </Button>
              </div>
            </PopoverContent>
          </Popover>
        </div>
      </div>

      <SearchModal
        open={isSearchModalOpen}
        onOpenChange={setIsSearchModalOpen}
        chats={chats}
        onSelectChat={onSelectChat}
        triggerRef={searchButtonRef}
      />

      <SettingsDialog
        open={isSettingsOpen}
        onOpenChange={setIsSettingsOpen}
      />

      <CreateProjectModal
        open={isCreateProjectOpen}
        onOpenChange={setIsCreateProjectOpen}
        onCreateProject={async (data) => {
          await createProject(data);
        }}
        knowledgeFiles={[]}
      />

      <EditProjectModal
        open={editingProject !== null}
        onOpenChange={(open) => !open && setEditingProject(null)}
        project={editingProject}
        onSave={(projectId, updates) => {
          updateProject(projectId, updates);
          setEditingProject(null);
        }}
      />

      <ProjectMemoriesModal
        open={memoriesProject !== null}
        onOpenChange={(open) => !open && setMemoriesProject(null)}
        project={memoriesProject}
        onUpdateProject={updateProject}
      />

      <ShareProjectModal
        open={shareProject !== null}
        onOpenChange={(open) => !open && setShareProject(null)}
        project={shareProject}
      />

      <DeleteConfirmDialog
        open={deletingProject !== null}
        onOpenChange={(open) => !open && setDeletingProject(null)}
        title={`驴Eliminar "${deletingProject?.name}"?`}
        description="Esta acci贸n no se puede deshacer. Se eliminar谩n todos los datos del proyecto incluyendo el prompt y los archivos adjuntos."
        onConfirm={() => {
          if (deletingProject) {
            deleteProject(deletingProject.id);
            console.log("[Sidebar] Project deleted:", deletingProject.id);
            setDeletingProject(null);
          }
        }}
      />

      {/* Chat Delete Confirmation Dialog */}
      <DeleteConfirmDialog
        open={deletingChatId !== null}
        onOpenChange={(open) => !open && setDeletingChatId(null)}
        title="驴Eliminar esta conversaci贸n?"
        description="Esta acci贸n no se puede deshacer. Se eliminar谩 permanentemente la conversaci贸n y todos sus mensajes."
        onConfirm={() => {
          if (deletingChatId && onDeleteChat) {
            // Create a synthetic event for the handler
            const syntheticEvent = { stopPropagation: () => { } } as React.MouseEvent;
            onDeleteChat(deletingChatId, syntheticEvent);
            console.log("[Sidebar] Chat deleted:", deletingChatId);
            setDeletingChatId(null);
          }
        }}
      />

    </nav >
  );
}
