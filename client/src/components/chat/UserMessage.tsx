
import React, { memo } from "react";
import {
    X,
    Send,
    Pencil,
    Copy,
    CheckCircle2
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Message } from "@/hooks/use-chats";
import { AttachmentList, formatMessageTime, DocumentBlock } from "./MessageParts";

export interface UserMessageProps {
    message: Message;
    variant: "compact" | "default";
    isEditing: boolean;
    editContent: string;
    copiedMessageId: string | null;
    onEditContentChange: (value: string) => void;
    onCancelEdit: () => void;
    onSendEdit: (id: string) => void;
    onCopyMessage: (content: string, id: string) => void;
    onStartEdit: (msg: Message) => void;
    onOpenPreview: (attachment: NonNullable<Message["attachments"]>[0]) => void;
    onReopenDocument?: (doc: { type: "word" | "excel" | "ppt"; title: string; content: string }) => void;
}

export const UserMessage = memo(function UserMessage({
    message,
    variant,
    isEditing,
    editContent,
    copiedMessageId,
    onEditContentChange,
    onCancelEdit,
    onSendEdit,
    onCopyMessage,
    onStartEdit,
    onOpenPreview,
    onReopenDocument
}: UserMessageProps) {
    if (variant === "compact") {
        return (
            <div className="bg-primary/10 text-primary-foreground px-3 py-2 rounded-lg max-w-full text-sm">
                <span className="text-muted-foreground mr-1 font-medium">
                    Instrucci√≥n:
                </span>
                <span className="text-foreground">{message.content}</span>
            </div>
        );
    }

    return (
        <div className="flex flex-col items-end gap-1">
            {isEditing ? (
                <div className="w-full min-w-[300px] max-w-[500px]">
                    <Textarea
                        value={editContent}
                        onChange={(e: React.ChangeEvent<HTMLTextAreaElement>) => onEditContentChange(e.target.value)}
                        className="w-full px-4 py-3 text-sm min-h-[80px] resize-y rounded-2xl border border-border bg-card focus:border-primary focus:ring-1 focus:ring-primary"
                        autoFocus
                    />
                    <div className="flex items-center justify-end gap-2 mt-2">
                        <Button
                            variant="ghost"
                            size="sm"
                            className="h-8 px-3 text-sm text-muted-foreground hover:text-foreground"
                            onClick={onCancelEdit}
                        >
                            <X className="h-4 w-4 mr-1" />
                            Cancelar
                        </Button>
                        <Button
                            variant="ghost"
                            size="sm"
                            className="h-8 px-3 text-sm text-muted-foreground hover:text-foreground"
                            onClick={() => onSendEdit(message.id)}
                        >
                            <Send className="h-4 w-4 mr-1" />
                            Enviar
                        </Button>
                    </div>
                </div>
            ) : (
                <div className="group">
                    <AttachmentList
                        attachments={message.attachments}
                        variant={variant}
                        onOpenPreview={onOpenPreview}
                        onReopenDocument={onReopenDocument}
                    />
                    {message.content && (
                        <div className="liquid-message-user px-4 py-2.5 text-sm break-words leading-relaxed">
                            {message.content}
                        </div>
                    )}
                    <div className="flex items-center justify-end gap-1.5 mt-2">
                        {message.timestamp && (
                            <span className="text-[10px] text-muted-foreground/60 mr-1">
                                {formatMessageTime(message.timestamp)}
                            </span>
                        )}
                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <Button
                                variant="ghost"
                                size="icon"
                                className="h-6 w-6 text-muted-foreground hover:text-foreground"
                                onClick={() => onCopyMessage(message.content, message.id)}
                                data-testid={`button-copy-user-${message.id}`}
                                title="Copiar mensaje"
                                aria-label="Copiar mensaje"
                            >
                                {copiedMessageId === message.id ? (
                                    <CheckCircle2 className="h-4 w-4 text-green-500" />
                                ) : (
                                    <Copy className="h-4 w-4" />
                                )}
                            </Button>
                            <Button
                                variant="ghost"
                                size="icon"
                                className="h-6 w-6 text-muted-foreground hover:text-foreground"
                                onClick={() => onStartEdit(message)}
                                data-testid={`button-edit-user-${message.id}`}
                                title="Editar mensaje"
                                aria-label="Editar mensaje"
                            >
                                <Pencil className="h-4 w-4" />
                            </Button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}, (prevProps, nextProps) => {
    return (
        prevProps.message.id === nextProps.message.id &&
        prevProps.message.content === nextProps.message.content &&
        prevProps.variant === nextProps.variant &&
        prevProps.isEditing === nextProps.isEditing &&
        prevProps.editContent === nextProps.editContent &&
        prevProps.copiedMessageId === nextProps.copiedMessageId &&
        prevProps.message.attachments === nextProps.message.attachments
    );
});
