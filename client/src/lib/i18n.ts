type TranslationKeys = {
  welcome: string;
  placeholder: string;
  send: string;
  newChat: string;
  upgrade: string;
  upgradeFull: string;
  thinking: string;
  copy: string;
  copied: string;
  share: string;
  settings: string;
  logout: string;
  login: string;
  disclaimer: string;
  today: string;
  yesterday: string;
  previous7Days: string;
  previous30Days: string;
  older: string;
  deleteChat: string;
  confirmDelete: string;
  cancel: string;
  confirm: string;
  search: string;
  noResults: string;
  loading: string;
  error: string;
  retry: string;
  plans: {
    free: string;
    go: string;
    plus: string;
    pro: string;
    business: string;
    enterprise: string;
  };
  planDescriptions: {
    free: string;
    go: string;
    plus: string;
    pro: string;
  };
};

const translations: Record<string, TranslationKeys> = {
  es: {
    welcome: "¿En qué puedo ayudarte hoy?",
    placeholder: "Escribe tu mensaje",
    send: "Enviar",
    newChat: "Nuevo chat",
    upgrade: "Mejorar",
    upgradeFull: "Mejorar el plan a Go",
    thinking: "Pensando",
    copy: "Copiar",
    copied: "Copiado",
    share: "Compartir",
    settings: "Configuración",
    logout: "Cerrar sesión",
    login: "Iniciar sesión",
    disclaimer: "ILIAGPT puede cometer errores. Verifica la información importante.",
    today: "Hoy",
    yesterday: "Ayer",
    previous7Days: "Últimos 7 días",
    previous30Days: "Últimos 30 días",
    older: "Más antiguo",
    deleteChat: "Eliminar chat",
    confirmDelete: "¿Estás seguro de que quieres eliminar este chat?",
    cancel: "Cancelar",
    confirm: "Confirmar",
    search: "Buscar",
    noResults: "Sin resultados",
    loading: "Cargando...",
    error: "Error",
    retry: "Reintentar",
    plans: {
      free: "Gratis",
      go: "Go",
      plus: "Plus",
      pro: "Pro",
      business: "Business",
      enterprise: "Enterprise",
    },
    planDescriptions: {
      free: "Mira lo que la IA puede hacer",
      go: "Logra más con una IA más avanzada",
      plus: "Descubre toda la experiencia",
      pro: "Maximiza tu productividad",
    },
  },
  en: {
    welcome: "How can I help you today?",
    placeholder: "Type your message",
    send: "Send",
    newChat: "New chat",
    upgrade: "Upgrade",
    upgradeFull: "Upgrade to Go",
    thinking: "Thinking",
    copy: "Copy",
    copied: "Copied",
    share: "Share",
    settings: "Settings",
    logout: "Log out",
    login: "Log in",
    disclaimer: "ILIAGPT can make mistakes. Check important info.",
    today: "Today",
    yesterday: "Yesterday",
    previous7Days: "Previous 7 days",
    previous30Days: "Previous 30 days",
    older: "Older",
    deleteChat: "Delete chat",
    confirmDelete: "Are you sure you want to delete this chat?",
    cancel: "Cancel",
    confirm: "Confirm",
    search: "Search",
    noResults: "No results",
    loading: "Loading...",
    error: "Error",
    retry: "Retry",
    plans: {
      free: "Free",
      go: "Go",
      plus: "Plus",
      pro: "Pro",
      business: "Business",
      enterprise: "Enterprise",
    },
    planDescriptions: {
      free: "See what AI can do",
      go: "Achieve more with advanced AI",
      plus: "Discover the full experience",
      pro: "Maximize your productivity",
    },
  },
  pt: {
    welcome: "Como posso ajudá-lo hoje?",
    placeholder: "Digite sua mensagem",
    send: "Enviar",
    newChat: "Novo chat",
    upgrade: "Melhorar",
    upgradeFull: "Melhorar para Go",
    thinking: "Pensando",
    copy: "Copiar",
    copied: "Copiado",
    share: "Compartilhar",
    settings: "Configurações",
    logout: "Sair",
    login: "Entrar",
    disclaimer: "ILIAGPT pode cometer erros. Verifique informações importantes.",
    today: "Hoje",
    yesterday: "Ontem",
    previous7Days: "Últimos 7 dias",
    previous30Days: "Últimos 30 dias",
    older: "Mais antigo",
    deleteChat: "Excluir chat",
    confirmDelete: "Tem certeza de que deseja excluir este chat?",
    cancel: "Cancelar",
    confirm: "Confirmar",
    search: "Buscar",
    noResults: "Sem resultados",
    loading: "Carregando...",
    error: "Erro",
    retry: "Tentar novamente",
    plans: {
      free: "Grátis",
      go: "Go",
      plus: "Plus",
      pro: "Pro",
      business: "Business",
      enterprise: "Enterprise",
    },
    planDescriptions: {
      free: "Veja o que a IA pode fazer",
      go: "Alcance mais com IA avançada",
      plus: "Descubra a experiência completa",
      pro: "Maximize sua produtividade",
    },
  },
  fr: {
    welcome: "Comment puis-je vous aider aujourd'hui?",
    placeholder: "Écrivez votre message",
    send: "Envoyer",
    newChat: "Nouveau chat",
    upgrade: "Améliorer",
    upgradeFull: "Passer à Go",
    thinking: "Réflexion",
    copy: "Copier",
    copied: "Copié",
    share: "Partager",
    settings: "Paramètres",
    logout: "Déconnexion",
    login: "Connexion",
    disclaimer: "ILIAGPT peut faire des erreurs. Vérifiez les informations importantes.",
    today: "Aujourd'hui",
    yesterday: "Hier",
    previous7Days: "7 derniers jours",
    previous30Days: "30 derniers jours",
    older: "Plus ancien",
    deleteChat: "Supprimer le chat",
    confirmDelete: "Êtes-vous sûr de vouloir supprimer ce chat?",
    cancel: "Annuler",
    confirm: "Confirmer",
    search: "Rechercher",
    noResults: "Aucun résultat",
    loading: "Chargement...",
    error: "Erreur",
    retry: "Réessayer",
    plans: {
      free: "Gratuit",
      go: "Go",
      plus: "Plus",
      pro: "Pro",
      business: "Business",
      enterprise: "Enterprise",
    },
    planDescriptions: {
      free: "Découvrez ce que l'IA peut faire",
      go: "Accomplissez plus avec une IA avancée",
      plus: "Découvrez l'expérience complète",
      pro: "Maximisez votre productivité",
    },
  },
  de: {
    welcome: "Wie kann ich Ihnen heute helfen?",
    placeholder: "Schreiben Sie Ihre Nachricht",
    send: "Senden",
    newChat: "Neuer Chat",
    upgrade: "Upgrade",
    upgradeFull: "Auf Go upgraden",
    thinking: "Denken",
    copy: "Kopieren",
    copied: "Kopiert",
    share: "Teilen",
    settings: "Einstellungen",
    logout: "Abmelden",
    login: "Anmelden",
    disclaimer: "ILIAGPT kann Fehler machen. Überprüfen Sie wichtige Informationen.",
    today: "Heute",
    yesterday: "Gestern",
    previous7Days: "Letzte 7 Tage",
    previous30Days: "Letzte 30 Tage",
    older: "Älter",
    deleteChat: "Chat löschen",
    confirmDelete: "Sind Sie sicher, dass Sie diesen Chat löschen möchten?",
    cancel: "Abbrechen",
    confirm: "Bestätigen",
    search: "Suchen",
    noResults: "Keine Ergebnisse",
    loading: "Laden...",
    error: "Fehler",
    retry: "Erneut versuchen",
    plans: {
      free: "Kostenlos",
      go: "Go",
      plus: "Plus",
      pro: "Pro",
      business: "Business",
      enterprise: "Enterprise",
    },
    planDescriptions: {
      free: "Sehen Sie, was KI kann",
      go: "Erreichen Sie mehr mit fortschrittlicher KI",
      plus: "Entdecken Sie das volle Erlebnis",
      pro: "Maximieren Sie Ihre Produktivität",
    },
  },
};

const SUPPORTED_LANGUAGES = ["es", "en", "pt", "fr", "de"] as const;
type SupportedLanguage = typeof SUPPORTED_LANGUAGES[number];

const COUNTRY_TO_LANGUAGE: Record<string, SupportedLanguage> = {
  ES: "es", MX: "es", AR: "es", CO: "es", CL: "es", PE: "es", VE: "es",
  EC: "es", GT: "es", CU: "es", BO: "es", DO: "es", HN: "es", PY: "es",
  SV: "es", NI: "es", CR: "es", PA: "es", UY: "es", PR: "es", GQ: "es",
  US: "en", GB: "en", CA: "en", AU: "en", NZ: "en", IE: "en", ZA: "en",
  IN: "en", PH: "en", SG: "en", MY: "en", NG: "en", KE: "en", GH: "en",
  BR: "pt", PT: "pt", AO: "pt", MZ: "pt",
  FR: "fr", BE: "fr", CH: "fr", LU: "fr", MC: "fr", SN: "fr", CI: "fr",
  DE: "de", AT: "de", LI: "de",
};

function detectLanguageFromNavigator(): SupportedLanguage {
  if (typeof navigator === "undefined") return "es";
  
  const browserLang = navigator.language || (navigator as any).userLanguage;
  if (!browserLang) return "es";
  
  const langCode = browserLang.split("-")[0].toLowerCase();
  
  if (SUPPORTED_LANGUAGES.includes(langCode as SupportedLanguage)) {
    return langCode as SupportedLanguage;
  }
  
  const countryCode = browserLang.split("-")[1]?.toUpperCase();
  if (countryCode && COUNTRY_TO_LANGUAGE[countryCode]) {
    return COUNTRY_TO_LANGUAGE[countryCode];
  }
  
  return "es";
}

function getStoredLanguage(): SupportedLanguage | null {
  if (typeof localStorage === "undefined") return null;
  const stored = localStorage.getItem("app_language");
  if (stored && SUPPORTED_LANGUAGES.includes(stored as SupportedLanguage)) {
    return stored as SupportedLanguage;
  }
  return null;
}

function setStoredLanguage(lang: SupportedLanguage): void {
  if (typeof localStorage !== "undefined") {
    localStorage.setItem("app_language", lang);
  }
}

export function getLanguage(): SupportedLanguage {
  const stored = getStoredLanguage();
  if (stored) return stored;
  
  const detected = detectLanguageFromNavigator();
  setStoredLanguage(detected);
  return detected;
}

export function setLanguage(lang: SupportedLanguage): void {
  setStoredLanguage(lang);
  window.dispatchEvent(new CustomEvent("languageChange", { detail: lang }));
}

export function t(key: string): string {
  const lang = getLanguage();
  const keys = key.split(".");
  let value: any = translations[lang] || translations.es;
  
  for (const k of keys) {
    value = value?.[k];
    if (value === undefined) break;
  }
  
  if (typeof value === "string") return value;
  
  value = translations.es;
  for (const k of keys) {
    value = value?.[k];
    if (value === undefined) break;
  }
  
  return typeof value === "string" ? value : key;
}

export function getLanguageName(code: SupportedLanguage): string {
  const names: Record<SupportedLanguage, string> = {
    es: "Español",
    en: "English",
    pt: "Português",
    fr: "Français",
    de: "Deutsch",
  };
  return names[code] || code;
}

export function getSupportedLanguages(): { code: SupportedLanguage; name: string }[] {
  return SUPPORTED_LANGUAGES.map(code => ({
    code,
    name: getLanguageName(code),
  }));
}

export type { SupportedLanguage, TranslationKeys };
export { SUPPORTED_LANGUAGES };
