// === HANDLER ENVIAR MENSAJE - CORREGIDO ===
const handleSend = async () => {
  // Permitir env铆o si hay instrucci贸n O si hay selecci贸n con instrucci贸n
  const hasInstruction = inputState.userInstruction.trim().length > 0;
  const hasSelection = inputState.selectedText !== null;
  
  // Validaci贸n: necesita al menos una instrucci贸n
  if (!hasInstruction) {
    console.log('No hay instrucci贸n para enviar');
    return;
  }
  
  // Construir el mensaje/payload
  const messagePayload = {
    instruction: inputState.userInstruction.trim(),
    selectedText: inputState.selectedText || null,
    selectionRange: inputState.selectionRange || null,
    timestamp: Date.now()
  };
  
  console.log('Enviando:', messagePayload); // Debug
  
  try {
    // Si hay selecci贸n, procesar como edici贸n de texto
    if (hasSelection) {
      await processSelectionEdit(messagePayload);
    } else {
      // Si no hay selecci贸n, procesar como instrucci贸n normal
      await processNormalInstruction(messagePayload);
    }
    
    // IMPORTANTE: Limpiar estado DESPUS de enviar exitosamente
    setInputState({
      selectedText: null,
      userInstruction: '',
      selectionRange: null
    });
    
  } catch (error) {
    console.error('Error al enviar:', error);
  }
};

// === EVENTO ENTER - VERIFICAR QUE EST CONECTADO ===
const handleKeyDown = (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault(); // Prevenir comportamiento default
    handleSend();
  }
};

// === COMPONENTE INPUT CORREGIDO ===
const InputWithSelection = () => {
  return (
    <div className="input-container">
      {/* Chip de selecci贸n */}
      {inputState.selectedText && (
        <div className="selection-chip">
          <span className="chip-icon"></span>
          <span className="chip-text">
            {inputState.selectedText.length > 30 
              ? inputState.selectedText.substring(0, 30) + '...' 
              : inputState.selectedText}
          </span>
          <button 
            className="chip-remove" 
            onClick={handleRemoveSelection}
            type="button"
          >
            
          </button>
        </div>
      )}
      
      {/* Input y bot贸n */}
      <div className="input-wrapper">
        <input
          type="text"
          value={inputState.userInstruction}
          onChange={handleInputChange}
          onKeyDown={handleKeyDown}  // IMPORTANTE: usar onKeyDown, no onKeyPress
          placeholder={inputState.selectedText 
            ? "Escribe qu茅 hacer con la selecci贸n..." 
            : "Escribe tu mensaje aqu铆..."}
        />
        <button 
          onClick={handleSend}  // IMPORTANTE: verificar que est茅 conectado
          type="button"
          className="send-button"
        >
          Enviar
        </button>
      </div>
    </div>
  );
};

// === SI USAN FORM, AGREGAR onSubmit ===
const InputForm = () => {
  const handleSubmit = (e) => {
    e.preventDefault();  // CRTICO: prevenir refresh de p谩gina
    handleSend();
  };
  
  return (
    <form onSubmit={handleSubmit} className="input-container">
      {/* ... contenido ... */}
      <button type="submit">Enviar</button>
    </form>
  );
};