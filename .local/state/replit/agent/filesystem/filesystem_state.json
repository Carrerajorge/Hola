{"file_contents":{"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/button-group.tsx":{"content":"import { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nconst buttonGroupVariants = cva(\n  \"flex w-fit items-stretch has-[>[data-slot=button-group]]:gap-2 [&>*]:focus-visible:relative [&>*]:focus-visible:z-10 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1\",\n  {\n    variants: {\n      orientation: {\n        horizontal:\n          \"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none\",\n        vertical:\n          \"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none\",\n      },\n    },\n    defaultVariants: {\n      orientation: \"horizontal\",\n    },\n  }\n)\n\nfunction ButtonGroup({\n  className,\n  orientation,\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof buttonGroupVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"button-group\"\n      data-orientation={orientation}\n      className={cn(buttonGroupVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupText({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  asChild?: boolean\n}) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      className={cn(\n        \"bg-muted shadow-xs flex items-center gap-2 rounded-md border px-4 text-sm font-medium [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupSeparator({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"button-group-separator\"\n      orientation={orientation}\n      className={cn(\n        \"bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  ButtonGroup,\n  ButtonGroupSeparator,\n  ButtonGroupText,\n  buttonGroupVariants,\n}\n","path":null,"size_bytes":2209,"size_tokens":null},"replit.md":{"content":"# Sira GPT\n\n## Overview\nSira GPT is an AI-powered chat application offering an intelligent assistant for autonomous web browsing and document creation. It features a modern chat UI with rich content rendering (Markdown, code highlighting, LaTeX) and connects to various AI APIs for generative responses. The project aims to provide a versatile platform for AI-driven tasks, including economic data analysis and multi-intent prompt processing.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n### Frontend\n- **Framework**: React with TypeScript, Vite.\n- **UI/UX**: shadcn/ui (Radix UI) with Tailwind CSS for theming (light/dark mode).\n- **Routing**: Wouter.\n- **State Management**: TanStack React Query (server state), React `useState` (local state).\n- **Content Rendering**: `react-markdown` with plugins for Markdown, code, and math.\n- **Interactive Code Blocks**: Prism.js (async highlighting via Web Worker), Monaco Editor integration, and multi-language execution via Piston API.\n- **Data Visualization**: Recharts (bar, line, area, pie, scatter), ECharts (maps, heatmaps), and TanStack Table (smart tables with sorting, filtering, pagination, virtualization).\n- **Graphics Rendering**: Multi-layer system supporting SVG (D3.js), Canvas 2D, and 3D (Three.js) with capability detection and fallback.\n\n### Backend\n- **Runtime**: Node.js with Express.js.\n- **API Design**: RESTful endpoints.\n- **Build System**: esbuild (server), Vite (client).\n- **LLM Gateway**: Centralized `llmGateway.ts` for enterprise-grade reliability with Circuit Breaker, Exponential Backoff Retries, Per-User Rate Limiting, Request Timeout, Response Caching, Context Truncation, Metrics Collection, and SSE Streaming.\n- **ETL Agent**: Automated economic data processing from official sources (e.g., World Bank API) into normalized schemas and ZIP bundles with Excel workbooks and audit reports.\n- **Multi-Intent Pipeline**: Processes complex user prompts via Plan → Decompose → Execute → Aggregate stages, featuring automatic detection, parallel execution, and error handling.\n- **Document Generation System**: Spec-based document rendering for Excel (.xlsx) and Word (.docx) files with LLM-driven generation and validation repair loops.\n  - `shared/documentSpecs.ts`: Zod schemas for ExcelSpec, DocSpec, CvSpec, ReportSpec, LetterSpec with typed sections.\n  - `server/services/excelSpecRenderer.ts`: Renders Excel workbooks from ExcelSpec JSON using ExcelJS.\n  - `server/services/wordSpecRenderer.ts`: Renders Word documents from DocSpec JSON using docx package.\n  - `server/services/documentOrchestrator.ts`: LLM orchestrator with Gemini integration and 3-attempt repair loop.\n  - API endpoints: `/api/documents/render/excel`, `/api/documents/render/word`, `/api/documents/generate/excel`, `/api/documents/generate/word`.\n- **Professional CV/Resume Generation System**: Three-layer architecture for structured document generation:\n  - **Structured Output Layer**: CvSpec schema with header, work_experience, education, skills (proficiency 1-5), languages, certifications, projects.\n  - **Template Engine**: `server/services/documentTemplates.ts` - 4 CV templates (modern, classic, creative, minimalist) with layout configs (single-column, two-column, sidebar), fonts, colors, skill styles (dots/bars/tags/percentage/text).\n  - **Intelligent Mapping Layer**: `server/services/documentMappingService.ts` - date formatting, skill visual generation (generateSkillDots, generateSkillBar), template selection.\n  - **CV Renderer**: `server/services/cvRenderer.ts` - Professional DOCX generation with two-column layouts, skill badges, photo placeholders, section styling.\n  - **Document Prompts**: `server/services/documentPrompts.ts` - CV-specific prompts with action verbs, quantifiable metrics, industry keywords.\n  - API endpoints: POST `/api/documents/generate/cv`, `/api/documents/generate/report`, `/api/documents/generate/letter`, `/api/documents/render/cv`.\n\n### Data Storage\n- **Database ORM**: Drizzle ORM for PostgreSQL.\n- **Client-side Persistence**: `localStorage` for chat history.\n- **Session Storage**: In-memory `MemStorage`.\n\n### Key Design Patterns\n- **Monorepo**: `client/`, `server/`, `shared/` directories.\n- **Type Safety**: Zod schemas for runtime validation.\n\n## External Dependencies\n### AI Services\n- **xAI Grok API**: Primary AI model provider (`grok-3-fast`, `grok-2-vision-1212`) via OpenAI-compatible SDK. Requires `XAI_API_KEY`.\n- **Google Gemini API**: Default AI model provider (`gemini-3-flash-preview`, `gemini-2.5-flash`, `gemini-2.5-pro`) via `@google/genai` SDK. Requires `GEMINI_API_KEY`.\n\n### Database\n- **PostgreSQL**: Primary database. Configured via `DATABASE_URL`.\n- **Drizzle Kit**: For database migrations.\n\n### CDN Resources\n- **KaTeX**: Math formula rendering.\n- **Highlight.js**: Code syntax highlighting styles (GitHub theme).\n- **Google Fonts**: Geist and Inter font families.\n\n### Key npm Packages\n- `openai`: For xAI API communication.\n- `drizzle-orm`, `drizzle-zod`: Database ORM and schema validation.\n- `react-markdown` and related plugins: Rich text rendering.\n- `framer-motion`: UI animations.\n- `date-fns`: Date formatting.\n- `connect-pg-simple`: PostgreSQL session store (available).\n- `recharts`, `echarts`: Charting libraries.\n- `@tanstack/react-table`, `@tanstack/react-virtual`: Smart tables.\n- `three`: 3D graphics.\n- `d3`: SVG manipulation.\n\n### External APIs\n- **Piston API**: For multi-language code execution.\n- **World Bank API V2**: For economic data (ETL Agent).\n- **FRED API**: (Planned) US Federal Reserve economic data.\n- **IMF SDMX**: (Planned) International Monetary Fund data.\n- **Figma API**: (Disabled by default) Integration for Figma design files. Requires `FIGMA_CLIENT_ID` and `FIGMA_CLIENT_SECRET`.","path":null,"size_bytes":5816,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    limit: '100mb',\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false, limit: '100mb' }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":2596,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Minus } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-1 ring-ring\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Minus />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2143,"size_tokens":null},"client/src/components/chat-interface.tsx":{"content":"import React, { useState, useRef, useEffect } from \"react\";\nimport { \n  Mic,\n  MicOff,\n  ArrowUp, \n  Plus, \n  ChevronDown,\n  ChevronRight,\n  Globe, \n  FileText,\n  FileSpreadsheet,\n  FileIcon,\n  Check,\n  CheckCircle2,\n  Loader2,\n  MoreHorizontal,\n  PanelLeftOpen,\n  X,\n  RefreshCw,\n  ArrowLeft,\n  ArrowRight,\n  Maximize2,\n  Minimize2,\n  Copy,\n  Pencil,\n  Send,\n  ThumbsUp,\n  ThumbsDown,\n  Share2,\n  Volume2,\n  VolumeX,\n  Flag,\n  MessageSquare,\n  Square,\n  Download,\n  GripVertical,\n  Pause,\n  Play,\n  Trash2,\n  Circle\n} from \"lucide-react\";\nimport { Panel, PanelGroup, PanelResizeHandle } from \"react-resizable-panels\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { cn } from \"@/lib/utils\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSub, DropdownMenuSubTrigger, DropdownMenuSubContent, DropdownMenuPortal } from \"@/components/ui/dropdown-menu\";\nimport { HoverCard, HoverCardContent, HoverCardTrigger } from \"@/components/ui/hover-card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Upload, Search, Image, Video, Bot, Plug } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\n\nimport { Message, FigmaDiagram, storeGeneratedImage, getGeneratedImage } from \"@/hooks/use-chats\";\nimport { MarkdownRenderer } from \"@/components/markdown-renderer\";\nimport { useAgent } from \"@/hooks/use-agent\";\nimport { useBrowserSession } from \"@/hooks/use-browser-session\";\nimport { AgentObserver } from \"@/components/agent-observer\";\nimport { VirtualComputer } from \"@/components/virtual-computer\";\nimport { DocumentEditor } from \"@/components/document-editor\";\nimport { EnhancedDocumentEditor } from \"@/components/ribbon\";\nimport { SpreadsheetEditor } from \"@/components/spreadsheet-editor\";\nimport { PPTEditorShell } from \"@/components/ppt\";\nimport { usePptStreaming } from \"@/hooks/usePptStreaming\";\nimport { PPT_STREAMING_SYSTEM_PROMPT } from \"@/lib/pptPrompts\";\nimport { ETLDialog } from \"@/components/etl-dialog\";\nimport { FigmaBlock } from \"@/components/figma-block\";\nimport { CodeExecutionBlock } from \"@/components/code-execution-block\";\nimport { SiraLogo } from \"@/components/sira-logo\";\nimport { ShareChatDialog, ShareIcon } from \"@/components/share-chat-dialog\";\nimport { UpgradePlanDialog } from \"@/components/upgrade-plan-dialog\";\nimport { DocumentGeneratorDialog } from \"@/components/document-generator-dialog\";\nimport { VoiceChatMode } from \"@/components/voice-chat-mode\";\nimport { RecordingPanel } from \"@/components/recording-panel\";\nimport { Composer } from \"@/components/composer\";\nimport { MessageList, parseDocumentBlocks, type DocumentBlock } from \"@/components/message-list\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Database, Sparkles, AudioLines } from \"lucide-react\";\nimport { getFileTheme, getFileCategory, FileCategory } from \"@/lib/fileTypeTheme\";\n\nconst extractTextFromChildren = (children: React.ReactNode): string => {\n  if (typeof children === 'string') return children;\n  if (typeof children === 'number') return String(children);\n  if (!children) return '';\n  if (Array.isArray(children)) {\n    return children.map(extractTextFromChildren).join('');\n  }\n  if (React.isValidElement(children)) {\n    return extractTextFromChildren((children.props as any)?.children);\n  }\n  const childArray = React.Children.toArray(children);\n  return childArray.map(extractTextFromChildren).join('');\n};\n\nconst isNumericValue = (text: string): boolean => {\n  if (!text || typeof text !== 'string') return false;\n  const cleaned = text.trim().replace(/[$€£¥%,\\s]/g, '');\n  return !isNaN(parseFloat(cleaned)) && isFinite(Number(cleaned)) && cleaned.length > 0;\n};\n\nconst extractTableData = (children: React.ReactNode): string[][] => {\n  const data: string[][] = [];\n  const childArray = React.Children.toArray(children);\n  childArray.forEach((section: any) => {\n    if (section?.props?.children) {\n      const rows = React.Children.toArray(section.props.children);\n      rows.forEach((row: any) => {\n        if (row?.props?.children) {\n          const cells = React.Children.toArray(row.props.children);\n          const rowData = cells.map((cell: any) => extractTextFromChildren(cell?.props?.children || ''));\n          data.push(rowData);\n        }\n      });\n    }\n  });\n  return data;\n};\n\nconst downloadTableAsExcel = (children: React.ReactNode) => {\n  const data = extractTableData(children);\n  if (data.length === 0) return;\n  \n  let csv = data.map(row => \n    row.map(cell => `\"${cell.replace(/\"/g, '\"\"')}\"`).join(',')\n  ).join('\\n');\n  \n  const BOM = '\\uFEFF';\n  const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.href = url;\n  link.download = `tabla_${Date.now()}.csv`;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n};\n\nconst copyTableToClipboard = (children: React.ReactNode) => {\n  const data = extractTableData(children);\n  if (data.length === 0) return;\n  const text = data.map(row => row.join('\\t')).join('\\n');\n  navigator.clipboard.writeText(text);\n};\n\nconst DataTableWrapper = ({children}: {children?: React.ReactNode}) => {\n  const [isFullscreen, setIsFullscreen] = useState(false);\n  const [copied, setCopied] = useState(false);\n  const childArray = React.Children.toArray(children);\n  let colCount = 0;\n  childArray.forEach((child: any) => {\n    if (child?.props?.children) {\n      const rows = React.Children.toArray(child.props.children);\n      rows.forEach((row: any) => {\n        if (row?.props?.children) {\n          const cells = React.Children.toArray(row.props.children);\n          colCount = Math.max(colCount, cells.length);\n        }\n      });\n    }\n  });\n  const minWidth = Math.min(Math.max(colCount * 150, 400), 1400);\n  \n  const handleCopy = () => {\n    copyTableToClipboard(children);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n  \n  const renderTable = () => (\n    <table className=\"data-table\" style={{ minWidth: `${minWidth}px` }}>\n      {children}\n    </table>\n  );\n\n  return (\n    <>\n      <div className=\"table-container group relative my-4\">\n        <div className=\"table-actions absolute top-2 right-2 flex gap-1 z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-200\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                type=\"button\"\n                onClick={() => downloadTableAsExcel(children)}\n                className=\"p-1.5 rounded-md bg-background/90 backdrop-blur-sm border border-border hover:bg-accent transition-colors shadow-sm\"\n                data-testid=\"button-download-excel\"\n              >\n                <Download className=\"h-3.5 w-3.5 text-muted-foreground\" />\n              </button>\n            </TooltipTrigger>\n            <TooltipContent>Descargar</TooltipContent>\n          </Tooltip>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                type=\"button\"\n                onClick={() => setIsFullscreen(true)}\n                className=\"p-1.5 rounded-md bg-background/90 backdrop-blur-sm border border-border hover:bg-accent transition-colors shadow-sm\"\n                data-testid=\"button-fullscreen-table\"\n              >\n                <Maximize2 className=\"h-3.5 w-3.5 text-muted-foreground\" />\n              </button>\n            </TooltipTrigger>\n            <TooltipContent>Ampliar</TooltipContent>\n          </Tooltip>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                type=\"button\"\n                onClick={handleCopy}\n                className=\"p-1.5 rounded-md bg-background/90 backdrop-blur-sm border border-border hover:bg-accent transition-colors shadow-sm\"\n                data-testid=\"button-copy-table\"\n              >\n                {copied ? <Check className=\"h-3.5 w-3.5 text-green-500\" /> : <Copy className=\"h-3.5 w-3.5 text-muted-foreground\" />}\n              </button>\n            </TooltipTrigger>\n            <TooltipContent>{copied ? \"Copiado\" : \"Copiar\"}</TooltipContent>\n          </Tooltip>\n        </div>\n        <div className=\"table-wrap\">\n          {renderTable()}\n        </div>\n      </div>\n      \n      {isFullscreen && (\n        <div className=\"fixed inset-0 z-50 bg-background/95 backdrop-blur-sm flex flex-col\">\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h3 className=\"font-semibold\">Vista ampliada</h3>\n            <div className=\"flex gap-2\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => downloadTableAsExcel(children)}\n                data-testid=\"button-download-excel-fullscreen\"\n              >\n                <Download className=\"h-4 w-4 mr-2\" />\n                Descargar\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setIsFullscreen(false)}\n                data-testid=\"button-close-fullscreen\"\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n          <div className=\"flex-1 overflow-auto p-4\">\n            <div className=\"table-wrap\">\n              {renderTable()}\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n};\n\nconst CleanDataTableComponents = {\n  table: DataTableWrapper,\n  thead: ({children}: {children?: React.ReactNode}) => <thead>{children}</thead>,\n  tbody: ({children}: {children?: React.ReactNode}) => <tbody>{children}</tbody>,\n  tr: ({children}: {children?: React.ReactNode}) => <tr>{children}</tr>,\n  th: ({children}: {children?: React.ReactNode}) => {\n    const text = extractTextFromChildren(children);\n    const isNumeric = isNumericValue(text);\n    return (\n      <th scope=\"col\" className={isNumeric ? \"text-right\" : \"\"}>\n        {children}\n      </th>\n    );\n  },\n  td: ({children}: {children?: React.ReactNode}) => {\n    const text = extractTextFromChildren(children);\n    const isNumeric = isNumericValue(text);\n    const isLong = text.length > 50;\n    return (\n      <td className={`${isNumeric ? \"text-right\" : \"\"} ${isLong ? \"wrap-cell\" : \"\"}`}>\n        {children}\n      </td>\n    );\n  }\n};\n\ninterface ContentBlock {\n  id: number;\n  type: 'heading1' | 'heading2' | 'heading3' | 'paragraph' | 'list' | 'numberedList' | 'blockquote' | 'table' | 'hr';\n  content: string;\n  raw: string;\n}\n\nfunction parseContentToBlocks(content: string): ContentBlock[] {\n  const lines = content.split('\\n');\n  const blocks: ContentBlock[] = [];\n  let currentBlock: string[] = [];\n  let blockId = 0;\n  \n  const flushBlock = (type: ContentBlock['type'], raw: string) => {\n    if (raw.trim()) {\n      blocks.push({ id: blockId++, type, content: raw.trim(), raw: raw });\n    }\n  };\n  \n  let i = 0;\n  while (i < lines.length) {\n    const line = lines[i];\n    \n    if (line.startsWith('### ')) {\n      flushBlock('heading3', line);\n    } else if (line.startsWith('## ')) {\n      flushBlock('heading2', line);\n    } else if (line.startsWith('# ')) {\n      flushBlock('heading1', line);\n    } else if (line.startsWith('> ')) {\n      let quoteLines = [line];\n      while (i + 1 < lines.length && lines[i + 1].startsWith('> ')) {\n        i++;\n        quoteLines.push(lines[i]);\n      }\n      flushBlock('blockquote', quoteLines.join('\\n'));\n    } else if (line.match(/^[-*] /)) {\n      let listLines = [line];\n      while (i + 1 < lines.length && lines[i + 1].match(/^[-*] /)) {\n        i++;\n        listLines.push(lines[i]);\n      }\n      flushBlock('list', listLines.join('\\n'));\n    } else if (line.match(/^\\d+\\. /)) {\n      let listLines = [line];\n      while (i + 1 < lines.length && lines[i + 1].match(/^\\d+\\. /)) {\n        i++;\n        listLines.push(lines[i]);\n      }\n      flushBlock('numberedList', listLines.join('\\n'));\n    } else if (line.startsWith('|')) {\n      let tableLines = [line];\n      while (i + 1 < lines.length && lines[i + 1].startsWith('|')) {\n        i++;\n        tableLines.push(lines[i]);\n      }\n      flushBlock('table', tableLines.join('\\n'));\n    } else if (line.match(/^[-*_]{3,}$/)) {\n      flushBlock('hr', line);\n    } else if (line.trim()) {\n      let paraLines = [line];\n      while (i + 1 < lines.length && lines[i + 1].trim() && \n             !lines[i + 1].startsWith('#') && \n             !lines[i + 1].startsWith('>') && \n             !lines[i + 1].match(/^[-*] /) && \n             !lines[i + 1].match(/^\\d+\\. /) &&\n             !lines[i + 1].startsWith('|') &&\n             !lines[i + 1].match(/^[-*_]{3,}$/)) {\n        i++;\n        paraLines.push(lines[i]);\n      }\n      flushBlock('paragraph', paraLines.join('\\n'));\n    }\n    i++;\n  }\n  \n  return blocks;\n}\n\ninterface TextSelection {\n  text: string;\n  startIndex: number;\n  endIndex: number;\n}\n\nfunction EditableDocumentPreview({ \n  content, \n  onChange,\n  onSelectionChange\n}: { \n  content: string; \n  onChange: (newContent: string) => void;\n  onSelectionChange?: (selection: TextSelection | null) => void;\n}) {\n  const [blocks, setBlocks] = useState<ContentBlock[]>(() => parseContentToBlocks(content));\n  const [editingBlockId, setEditingBlockId] = useState<number | null>(null);\n  const [editingText, setEditingText] = useState(\"\");\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  \n  useEffect(() => {\n    setBlocks(parseContentToBlocks(content));\n  }, [content]);\n  \n  useEffect(() => {\n    if (editingBlockId !== null && textareaRef.current) {\n      textareaRef.current.focus();\n      textareaRef.current.select();\n    }\n  }, [editingBlockId]);\n\n  const handleTextSelection = () => {\n    const selection = window.getSelection();\n    if (!selection || selection.isCollapsed || !selection.toString().trim()) {\n      return;\n    }\n    \n    const selectedText = selection.toString();\n    if (!selectedText.trim()) {\n      return;\n    }\n    \n    const startIndex = content.indexOf(selectedText);\n    if (startIndex === -1) {\n      const normalizedContent = content.replace(/\\s+/g, ' ');\n      const normalizedSelection = selectedText.replace(/\\s+/g, ' ');\n      const normalizedStart = normalizedContent.indexOf(normalizedSelection);\n      \n      if (normalizedStart !== -1) {\n        let charCount = 0;\n        let realStart = 0;\n        for (let i = 0; i < content.length && charCount < normalizedStart; i++) {\n          if (!/\\s/.test(content[i]) || (i > 0 && !/\\s/.test(content[i-1]))) {\n            charCount++;\n          }\n          realStart = i + 1;\n        }\n        \n        onSelectionChange?.({\n          text: selectedText,\n          startIndex: realStart,\n          endIndex: realStart + selectedText.length\n        });\n      }\n      return;\n    }\n    \n    onSelectionChange?.({\n      text: selectedText,\n      startIndex,\n      endIndex: startIndex + selectedText.length\n    });\n  };\n  \n  const handleBlockClick = (block: ContentBlock) => {\n    setEditingBlockId(block.id);\n    setEditingText(block.raw);\n  };\n  \n  const handleSaveBlock = () => {\n    if (editingBlockId === null) return;\n    \n    const newBlocks = blocks.map(b => \n      b.id === editingBlockId \n        ? { ...b, raw: editingText, content: editingText.trim() }\n        : b\n    );\n    setBlocks(newBlocks);\n    \n    const newContent = newBlocks.map(b => b.raw).join('\\n\\n');\n    onChange(newContent);\n    setEditingBlockId(null);\n    setEditingText(\"\");\n  };\n  \n  const renderInlineFormatting = (text: string) => {\n    const parts: React.ReactNode[] = [];\n    let remaining = text;\n    let key = 0;\n    \n    while (remaining.length > 0) {\n      const boldMatch = remaining.match(/\\*\\*(.+?)\\*\\*/);\n      const italicMatch = remaining.match(/\\*(.+?)\\*/);\n      \n      if (boldMatch && boldMatch.index !== undefined) {\n        if (boldMatch.index > 0) {\n          parts.push(<span key={key++}>{remaining.slice(0, boldMatch.index)}</span>);\n        }\n        parts.push(<strong key={key++} className=\"font-bold\">{boldMatch[1]}</strong>);\n        remaining = remaining.slice(boldMatch.index + boldMatch[0].length);\n      } else if (italicMatch && italicMatch.index !== undefined && !remaining.startsWith('**')) {\n        if (italicMatch.index > 0) {\n          parts.push(<span key={key++}>{remaining.slice(0, italicMatch.index)}</span>);\n        }\n        parts.push(<em key={key++} className=\"italic\">{italicMatch[1]}</em>);\n        remaining = remaining.slice(italicMatch.index + italicMatch[0].length);\n      } else {\n        parts.push(<span key={key++}>{remaining}</span>);\n        break;\n      }\n    }\n    \n    return parts;\n  };\n  \n  const renderBlock = (block: ContentBlock) => {\n    const isEditing = editingBlockId === block.id;\n    \n    if (isEditing) {\n      return (\n        <div key={block.id} className=\"relative\">\n          <textarea\n            ref={textareaRef}\n            value={editingText}\n            onChange={(e) => setEditingText(e.target.value)}\n            onBlur={handleSaveBlock}\n            onKeyDown={(e) => {\n              if (e.key === 'Escape') {\n                setEditingBlockId(null);\n                setEditingText(\"\");\n              }\n            }}\n            className=\"w-full p-3 border-2 border-blue-500 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-sm font-mono resize-none focus:outline-none\"\n            style={{ minHeight: Math.max(60, editingText.split('\\n').length * 24) }}\n            data-testid={`textarea-block-${block.id}`}\n          />\n          <div className=\"absolute -top-6 left-0 text-xs text-blue-600 bg-blue-100 dark:bg-blue-900 px-2 py-0.5 rounded\">\n            Editando - Click afuera para guardar\n          </div>\n        </div>\n      );\n    }\n    \n    const baseClass = \"cursor-pointer transition-all duration-200 hover:bg-teal-50 dark:hover:bg-teal-900/20 rounded px-2 py-1 -mx-2 border border-transparent hover:border-teal-200 dark:hover:border-teal-800\";\n    \n    switch (block.type) {\n      case 'heading1':\n        return (\n          <h1 \n            key={block.id}\n            onClick={() => handleBlockClick(block)}\n            className={cn(\"text-4xl font-bold mb-6 mt-2 text-teal-700 dark:text-teal-400 italic\", baseClass)}\n            style={{ fontFamily: 'Georgia, serif' }}\n          >\n            {block.content.replace(/^# /, '')}\n          </h1>\n        );\n      case 'heading2':\n        return (\n          <h2 \n            key={block.id}\n            onClick={() => handleBlockClick(block)}\n            className={cn(\"text-xl font-bold mb-3 mt-6 text-teal-700 dark:text-teal-400\", baseClass)}\n          >\n            {block.content.replace(/^## /, '')}\n          </h2>\n        );\n      case 'heading3':\n        return (\n          <h3 \n            key={block.id}\n            onClick={() => handleBlockClick(block)}\n            className={cn(\"text-lg font-bold mb-2 mt-4 text-foreground\", baseClass)}\n          >\n            {block.content.replace(/^### /, '')}\n          </h3>\n        );\n      case 'paragraph':\n        return (\n          <p \n            key={block.id}\n            onClick={() => handleBlockClick(block)}\n            className={cn(\"mb-3 leading-relaxed text-muted-foreground text-sm\", baseClass)}\n          >\n            {renderInlineFormatting(block.content)}\n          </p>\n        );\n      case 'list':\n        return (\n          <ul \n            key={block.id}\n            onClick={() => handleBlockClick(block)}\n            className={cn(\"list-disc list-inside mb-4 space-y-1\", baseClass)}\n          >\n            {block.content.split('\\n').map((item, idx) => (\n              <li key={idx} className=\"text-foreground\">\n                {renderInlineFormatting(item.replace(/^[-*] /, ''))}\n              </li>\n            ))}\n          </ul>\n        );\n      case 'numberedList':\n        return (\n          <ol \n            key={block.id}\n            onClick={() => handleBlockClick(block)}\n            className={cn(\"list-decimal list-inside mb-4 space-y-1\", baseClass)}\n          >\n            {block.content.split('\\n').map((item, idx) => (\n              <li key={idx} className=\"text-foreground\">\n                {renderInlineFormatting(item.replace(/^\\d+\\. /, ''))}\n              </li>\n            ))}\n          </ol>\n        );\n      case 'blockquote':\n        return (\n          <blockquote \n            key={block.id}\n            onClick={() => handleBlockClick(block)}\n            className={cn(\"border-l-4 border-blue-500 pl-4 italic my-4 py-2 bg-muted\", baseClass)}\n          >\n            {block.content.split('\\n').map((line, idx) => (\n              <p key={idx} className=\"text-muted-foreground\">\n                {renderInlineFormatting(line.replace(/^> /, ''))}\n              </p>\n            ))}\n          </blockquote>\n        );\n      case 'table':\n        const rows = block.content.split('\\n').filter(r => !r.match(/^\\|[-:| ]+\\|$/));\n        return (\n          <div key={block.id} onClick={() => handleBlockClick(block)} className={baseClass}>\n            <table className=\"w-full border-collapse border border-border my-4\">\n              <tbody>\n                {rows.map((row, idx) => (\n                  <tr key={idx} className={idx === 0 ? \"bg-muted\" : \"\"}>\n                    {row.split('|').filter(c => c.trim()).map((cell, cidx) => (\n                      idx === 0 ? (\n                        <th key={cidx} className=\"border border-border px-3 py-2 font-semibold text-left\">\n                          {cell.trim()}\n                        </th>\n                      ) : (\n                        <td key={cidx} className=\"border border-border px-3 py-2\">\n                          {cell.trim()}\n                        </td>\n                      )\n                    ))}\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        );\n      case 'hr':\n        return <hr key={block.id} className=\"my-6 border-t-2 border-border\" />;\n      default:\n        return (\n          <p key={block.id} onClick={() => handleBlockClick(block)} className={cn(\"mb-4\", baseClass)}>\n            {block.content}\n          </p>\n        );\n    }\n  };\n  \n  return (\n    <div \n      ref={containerRef}\n      className=\"document-preview space-y-1 select-text\"\n      onMouseUp={handleTextSelection}\n      onDoubleClick={handleTextSelection}\n    >\n      {blocks.length === 0 ? (\n        <p className=\"text-muted-foreground italic\">El documento está vacío. Haz clic para agregar contenido.</p>\n      ) : (\n        blocks.map(renderBlock)\n      )}\n    </div>\n  );\n}\n\ninterface ActiveGpt {\n  id: string;\n  name: string;\n  description: string | null;\n  systemPrompt: string;\n  temperature: string | null;\n  topP: string | null;\n  welcomeMessage: string | null;\n  conversationStarters: string[] | null;\n  avatar: string | null;\n  capabilities?: {\n    webBrowsing?: boolean;\n    codeInterpreter?: boolean;\n    imageGeneration?: boolean;\n    wordCreation?: boolean;\n    excelCreation?: boolean;\n    pptCreation?: boolean;\n  };\n}\n\ntype AiState = \"idle\" | \"thinking\" | \"responding\";\ntype AiProcessStep = { step: string; status: \"pending\" | \"active\" | \"done\" };\n\ninterface ChatInterfaceProps {\n  messages: Message[];\n  onSendMessage: (message: Message) => void;\n  isSidebarOpen?: boolean;\n  onToggleSidebar?: () => void;\n  onCloseSidebar?: () => void;\n  activeGpt?: ActiveGpt | null;\n  aiState: AiState;\n  setAiState: React.Dispatch<React.SetStateAction<AiState>>;\n  aiProcessSteps: AiProcessStep[];\n  setAiProcessSteps: React.Dispatch<React.SetStateAction<AiProcessStep[]>>;\n  chatId?: string | null;\n}\n\ninterface UploadedFile {\n  id?: string;\n  name: string;\n  type: string;\n  mimeType?: string;\n  size: number;\n  dataUrl?: string;\n  storagePath?: string;\n  status?: string;\n  content?: string;\n}\n\nexport function ChatInterface({ \n  messages, \n  onSendMessage, \n  isSidebarOpen = true, \n  onToggleSidebar,\n  onCloseSidebar,\n  activeGpt,\n  aiState,\n  setAiState,\n  aiProcessSteps,\n  setAiProcessSteps,\n  chatId\n}: ChatInterfaceProps) {\n  const { user } = useAuth();\n  const [input, setInput] = useState(\"\");\n  const [streamingContent, setStreamingContent] = useState(\"\");\n  const [isBrowserOpen, setIsBrowserOpen] = useState(false);\n  const [browserUrl, setBrowserUrl] = useState(\"https://www.google.com\");\n  const [isBrowserMaximized, setIsBrowserMaximized] = useState(false);\n  const [uploadedFiles, setUploadedFiles] = useState<UploadedFile[]>([]);\n  const [editingMessageId, setEditingMessageId] = useState<string | null>(null);\n  const [editContent, setEditContent] = useState(\"\");\n  const [messageFeedback, setMessageFeedback] = useState<Record<string, \"up\" | \"down\" | null>>({});\n  const [speakingMessageId, setSpeakingMessageId] = useState<string | null>(null);\n  const [copiedMessageId, setCopiedMessageId] = useState<string | null>(null);\n  const [previewDocument, setPreviewDocument] = useState<DocumentBlock | null>(null);\n  const [editedDocumentContent, setEditedDocumentContent] = useState<string>(\"\");\n  const [textSelection, setTextSelection] = useState<TextSelection | null>(null);\n  const [editingSelectionText, setEditingSelectionText] = useState<string>(\"\");\n  const [originalSelectionText, setOriginalSelectionText] = useState<string>(\"\");\n  const [selectedDocText, setSelectedDocText] = useState<string>(\"\");\n  const [selectedDocTool, setSelectedDocTool] = useState<\"word\" | \"excel\" | \"ppt\" | \"figma\" | null>(null);\n  const [selectedTool, setSelectedTool] = useState<\"web\" | \"agent\" | \"image\" | null>(null);\n  const [activeDocEditor, setActiveDocEditor] = useState<{ type: \"word\" | \"excel\" | \"ppt\"; title: string; content: string } | null>(null);\n  const [isRecording, setIsRecording] = useState(false);\n  const [recordingTime, setRecordingTime] = useState(0);\n  const [isPaused, setIsPaused] = useState(false);\n  const recordingTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const [isETLDialogOpen, setIsETLDialogOpen] = useState(false);\n  const [figmaTokenInput, setFigmaTokenInput] = useState(\"\");\n  const [isFigmaConnecting, setIsFigmaConnecting] = useState(false);\n  const [isFigmaConnected, setIsFigmaConnected] = useState(false);\n  const [showFigmaTokenInput, setShowFigmaTokenInput] = useState(false);\n  const [selectedProvider, setSelectedProvider] = useState<\"xai\" | \"gemini\">(\"gemini\");\n  const [selectedModel, setSelectedModel] = useState<string>(\"gemini-3-flash-preview\");\n  const [isModelSelectorOpen, setIsModelSelectorOpen] = useState(false);\n  const [isUpgradeDialogOpen, setIsUpgradeDialogOpen] = useState(false);\n  const [isDocGeneratorOpen, setIsDocGeneratorOpen] = useState(false);\n  const [docGeneratorType, setDocGeneratorType] = useState<\"word\" | \"excel\">(\"word\");\n  const [isVoiceChatOpen, setIsVoiceChatOpen] = useState(false);\n  const [isGeneratingImage, setIsGeneratingImage] = useState(false);\n  const [pendingGeneratedImage, setPendingGeneratedImage] = useState<{messageId: string; imageData: string} | null>(null);\n  const [lightboxImage, setLightboxImage] = useState<string | null>(null);\n  const [previewUploadedImage, setPreviewUploadedImage] = useState<{ name: string; dataUrl: string } | null>(null);\n  const [previewFileAttachment, setPreviewFileAttachment] = useState<{\n    name: string;\n    type: string;\n    mimeType?: string;\n    imageUrl?: string;\n    storagePath?: string;\n    fileId?: string;\n    content?: string;\n    isLoading?: boolean;\n    isProcessing?: boolean;\n  } | null>(null);\n  const [copiedAttachmentContent, setCopiedAttachmentContent] = useState(false);\n  const [isDraggingOver, setIsDraggingOver] = useState(false);\n  const latestGeneratedImageRef = useRef<{messageId: string; imageData: string} | null>(null);\n  const dragCounterRef = useRef(0);\n  const activeDocEditorRef = useRef<{ type: \"word\" | \"excel\" | \"ppt\"; title: string; content: string } | null>(null);\n  \n  // PPT streaming integration\n  const pptStreaming = usePptStreaming();\n  const applyRewriteRef = useRef<((newText: string) => void) | null>(null);\n  const docInsertContentRef = useRef<((content: string, replaceMode?: boolean) => void) | null>(null);\n  const speechRecognitionRef = useRef<any>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  // Auto-scroll to bottom when AI is thinking or streaming\n  useEffect(() => {\n    if (aiState !== \"idle\" || streamingContent) {\n      messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [aiState, streamingContent, messages.length]);\n\n  useEffect(() => {\n    return () => {\n      if (speechRecognitionRef.current) {\n        speechRecognitionRef.current.stop();\n        speechRecognitionRef.current = null;\n      }\n    };\n  }, []);\n\n  // Recording timer effect\n  useEffect(() => {\n    if (isRecording && !isPaused) {\n      recordingTimerRef.current = setInterval(() => {\n        setRecordingTime(prev => prev + 1);\n      }, 1000);\n    } else {\n      if (recordingTimerRef.current) {\n        clearInterval(recordingTimerRef.current);\n        recordingTimerRef.current = null;\n      }\n    }\n    return () => {\n      if (recordingTimerRef.current) {\n        clearInterval(recordingTimerRef.current);\n      }\n    };\n  }, [isRecording, isPaused]);\n\n  // Close file attachment preview on Escape key\n  useEffect(() => {\n    const handleEscape = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\" && previewFileAttachment) {\n        setPreviewFileAttachment(null);\n      }\n    };\n    \n    document.addEventListener(\"keydown\", handleEscape);\n    return () => document.removeEventListener(\"keydown\", handleEscape);\n  }, [previewFileAttachment]);\n  \n  // Keep ref in sync with state\n  useEffect(() => {\n    activeDocEditorRef.current = activeDocEditor;\n  }, [activeDocEditor]);\n  \n  // Document editor is now only opened manually by the user clicking the buttons\n  // Removed auto-open behavior to prevent unwanted document creation\n  \n  // Check Figma connection status and handle OAuth callback\n  useEffect(() => {\n    const checkFigmaStatus = async () => {\n      try {\n        const response = await fetch(\"/api/figma/status\");\n        const data = await response.json();\n        setIsFigmaConnected(data.connected);\n      } catch (error) {\n        console.error(\"Error checking Figma status:\", error);\n      }\n    };\n    \n    const urlParams = new URLSearchParams(window.location.search);\n    if (urlParams.get('figma_connected') === 'true') {\n      setIsFigmaConnected(true);\n      setIsFigmaConnecting(false);\n      window.history.replaceState({}, '', window.location.pathname);\n    }\n    if (urlParams.get('figma_error')) {\n      setIsFigmaConnecting(false);\n      window.history.replaceState({}, '', window.location.pathname);\n    }\n    \n    checkFigmaStatus();\n  }, []);\n  \n  // Figma connection handler - OAuth flow\n  const handleFigmaConnect = () => {\n    setIsFigmaConnecting(true);\n    window.location.href = \"/api/auth/figma\";\n  };\n  \n  const handleFigmaDisconnect = async () => {\n    try {\n      await fetch(\"/api/figma/disconnect\", { method: \"POST\" });\n      setIsFigmaConnected(false);\n    } catch (error) {\n      console.error(\"Error disconnecting from Figma:\", error);\n    }\n  };\n  \n  // Function to open blank document editor - preserves existing messages\n  const openBlankDocEditor = (type: \"word\" | \"excel\" | \"ppt\") => {\n    const titles = {\n      word: \"Nuevo Documento Word\",\n      excel: \"Nueva Hoja de Cálculo\",\n      ppt: \"Nueva Presentación\"\n    };\n    const templates = {\n      word: \"<p>Comienza a escribir tu documento aquí...</p>\",\n      excel: \"\",\n      ppt: \"<h1>Título de la Presentación</h1><p>Haz clic para agregar subtítulo</p>\"\n    };\n    \n    // Only update document editor state - DO NOT clear messages\n    setSelectedDocTool(type);\n    setActiveDocEditor({\n      type,\n      title: titles[type],\n      content: templates[type]\n    });\n    setEditedDocumentContent(templates[type]);\n    \n    // Close sidebar when opening a document tool\n    onCloseSidebar?.();\n  };\n  \n  const closeDocEditor = () => {\n    setActiveDocEditor(null);\n    setSelectedDocTool(null);\n    setEditedDocumentContent(\"\");\n    docInsertContentRef.current = null;\n  };\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const bottomRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const abortControllerRef = useRef<AbortController | null>(null);\n  const streamIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const streamingContentRef = useRef<string>(\"\");\n  const aiStateRef = useRef<\"idle\" | \"thinking\" | \"responding\">(\"idle\");\n  const composerRef = useRef<HTMLDivElement>(null);\n  \n  // Measure composer height and set CSS variable for proper layout\n  useEffect(() => {\n    const updateComposerHeight = () => {\n      if (composerRef.current) {\n        const h = composerRef.current.getBoundingClientRect().height;\n        document.documentElement.style.setProperty('--composer-height', `${h}px`);\n      }\n    };\n    \n    updateComposerHeight();\n    window.addEventListener('resize', updateComposerHeight);\n    window.addEventListener('orientationchange', updateComposerHeight);\n    \n    return () => {\n      window.removeEventListener('resize', updateComposerHeight);\n      window.removeEventListener('orientationchange', updateComposerHeight);\n    };\n  }, []);\n  \n  // Keep aiStateRef in sync with aiState for reliable access\n  useEffect(() => {\n    aiStateRef.current = aiState;\n  }, [aiState]);\n  const agent = useAgent();\n  const browserSession = useBrowserSession();\n\n  useEffect(() => {\n    if (agent.state.browserSessionId && browserSession.state.sessionId !== agent.state.browserSessionId) {\n      browserSession.subscribeToSession(agent.state.browserSessionId, agent.state.objective || \"Navegando web\");\n    }\n  }, [agent.state.browserSessionId, agent.state.objective, browserSession.state.sessionId]);\n\n  const handleStopChat = () => {\n    // Abort any ongoing fetch request\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n      abortControllerRef.current = null;\n    }\n    \n    // Clear any streaming interval\n    if (streamIntervalRef.current) {\n      clearInterval(streamIntervalRef.current);\n      streamIntervalRef.current = null;\n    }\n    \n    // Clean up PPT streaming if active\n    if (pptStreaming.isStreaming) {\n      pptStreaming.stopStreaming();\n    }\n    \n    // Save the partial content as a message if there's any (use ref for latest value)\n    const currentContent = streamingContentRef.current;\n    if (currentContent && currentContent.trim()) {\n      const partialMsg: Message = {\n        id: (Date.now() + 1).toString(),\n        role: \"assistant\",\n        content: currentContent + \"\\n\\n*[Respuesta detenida por el usuario]*\",\n        timestamp: new Date(),\n      };\n      onSendMessage(partialMsg);\n    } else {\n      // If stopped during \"thinking\" phase (no content yet), show a stopped message\n      const stoppedMsg: Message = {\n        id: (Date.now() + 1).toString(),\n        role: \"assistant\",\n        content: \"*[Solicitud cancelada por el usuario]*\",\n        timestamp: new Date(),\n      };\n      onSendMessage(stoppedMsg);\n    }\n    \n    // Reset states\n    streamingContentRef.current = \"\";\n    setAiState(\"idle\");\n    setStreamingContent(\"\");\n  };\n\n  const handleCopyMessage = (content: string, msgId?: string) => {\n    navigator.clipboard.writeText(content);\n    if (msgId) {\n      setCopiedMessageId(msgId);\n      setTimeout(() => setCopiedMessageId(null), 2000);\n    }\n  };\n\n  const startVoiceRecording = () => {\n    const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;\n    \n    if (!SpeechRecognition) {\n      alert(\"Tu navegador no soporta reconocimiento de voz. Por favor usa Chrome, Edge o Safari.\");\n      return;\n    }\n\n    const recognition = new SpeechRecognition();\n    recognition.continuous = true;\n    recognition.interimResults = true;\n    recognition.lang = 'es-ES';\n\n    let finalTranscript = '';\n    let interimTranscript = '';\n\n    recognition.onstart = () => {\n      setIsRecording(true);\n      setRecordingTime(0);\n      setIsPaused(false);\n      finalTranscript = input;\n    };\n\n    recognition.onresult = (event: any) => {\n      interimTranscript = '';\n      for (let i = event.resultIndex; i < event.results.length; i++) {\n        const transcript = event.results[i][0].transcript;\n        if (event.results[i].isFinal) {\n          finalTranscript += (finalTranscript ? ' ' : '') + transcript;\n        } else {\n          interimTranscript = transcript;\n        }\n      }\n      setInput(finalTranscript + (interimTranscript ? ' ' + interimTranscript : ''));\n    };\n\n    recognition.onerror = (event: any) => {\n      console.error('Speech recognition error:', event.error);\n      setIsRecording(false);\n      setRecordingTime(0);\n      setIsPaused(false);\n      speechRecognitionRef.current = null;\n    };\n\n    recognition.onend = () => {\n      // Don't auto-reset if paused - user might resume\n      if (!isPaused) {\n        setIsRecording(false);\n        speechRecognitionRef.current = null;\n      }\n    };\n\n    speechRecognitionRef.current = recognition;\n    recognition.start();\n  };\n\n  const toggleVoiceRecording = () => {\n    if (isRecording) {\n      stopVoiceRecording();\n    } else {\n      startVoiceRecording();\n    }\n  };\n\n  const pauseVoiceRecording = () => {\n    if (speechRecognitionRef.current && isRecording) {\n      speechRecognitionRef.current.stop();\n      setIsPaused(true);\n    }\n  };\n\n  const resumeVoiceRecording = () => {\n    if (isPaused) {\n      const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;\n      if (!SpeechRecognition) return;\n\n      const recognition = new SpeechRecognition();\n      recognition.continuous = true;\n      recognition.interimResults = true;\n      recognition.lang = 'es-ES';\n\n      let currentInput = input;\n\n      recognition.onstart = () => {\n        setIsPaused(false);\n      };\n\n      recognition.onresult = (event: any) => {\n        let interimTranscript = '';\n        for (let i = event.resultIndex; i < event.results.length; i++) {\n          const transcript = event.results[i][0].transcript;\n          if (event.results[i].isFinal) {\n            currentInput += (currentInput ? ' ' : '') + transcript;\n          } else {\n            interimTranscript = transcript;\n          }\n        }\n        setInput(currentInput + (interimTranscript ? ' ' + interimTranscript : ''));\n      };\n\n      recognition.onerror = (event: any) => {\n        console.error('Speech recognition error:', event.error);\n        setIsRecording(false);\n        setRecordingTime(0);\n        setIsPaused(false);\n        speechRecognitionRef.current = null;\n      };\n\n      recognition.onend = () => {\n        if (!isPaused) {\n          setIsRecording(false);\n          speechRecognitionRef.current = null;\n        }\n      };\n\n      speechRecognitionRef.current = recognition;\n      recognition.start();\n    }\n  };\n\n  const stopVoiceRecording = () => {\n    if (speechRecognitionRef.current) {\n      speechRecognitionRef.current.stop();\n      speechRecognitionRef.current = null;\n    }\n    setIsRecording(false);\n    setRecordingTime(0);\n    setIsPaused(false);\n  };\n\n  const discardVoiceRecording = () => {\n    stopVoiceRecording();\n    setInput(\"\");\n  };\n\n  const sendVoiceRecording = () => {\n    stopVoiceRecording();\n    if (input.trim() || uploadedFiles.length > 0) {\n      handleSubmit();\n    }\n  };\n\n  const handleOpenDocumentPreview = (doc: DocumentBlock) => {\n    setPreviewDocument(doc);\n    setEditedDocumentContent(doc.content);\n  };\n\n  const handleCloseDocumentPreview = () => {\n    setPreviewDocument(null);\n    setEditedDocumentContent(\"\");\n    setTextSelection(null);\n    setEditingSelectionText(\"\");\n    setOriginalSelectionText(\"\");\n  };\n\n  const handleSelectionChange = (selection: TextSelection | null) => {\n    if (selection && selection.text.trim()) {\n      setTextSelection(selection);\n      setEditingSelectionText(selection.text);\n      setOriginalSelectionText(selection.text);\n    }\n  };\n\n  const handleApplySelectionEdit = () => {\n    if (!textSelection || !editedDocumentContent) return;\n    \n    const before = editedDocumentContent.substring(0, textSelection.startIndex);\n    const after = editedDocumentContent.substring(textSelection.endIndex);\n    const newContent = before + editingSelectionText + after;\n    \n    setEditedDocumentContent(newContent);\n    setTextSelection(null);\n    setEditingSelectionText(\"\");\n    setOriginalSelectionText(\"\");\n    \n    window.getSelection()?.removeAllRanges();\n  };\n\n  const handleCancelSelectionEdit = () => {\n    setTextSelection(null);\n    setEditingSelectionText(\"\");\n    setOriginalSelectionText(\"\");\n    window.getSelection()?.removeAllRanges();\n  };\n\n  const handleRevertSelectionEdit = () => {\n    setEditingSelectionText(originalSelectionText);\n  };\n\n  const handleDocTextSelect = (text: string, applyRewrite: (newText: string) => void) => {\n    setSelectedDocText(text);\n    applyRewriteRef.current = applyRewrite;\n  };\n\n  const handleDocTextDeselect = () => {\n    setSelectedDocText(\"\");\n    applyRewriteRef.current = null;\n  };\n\n  const handleDownloadDocument = async (doc: DocumentBlock) => {\n    try {\n      const documentToDownload = {\n        ...doc,\n        content: editedDocumentContent || doc.content\n      };\n      const response = await fetch(\"/api/documents/generate\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(documentToDownload),\n      });\n      \n      if (!response.ok) {\n        throw new Error(\"Failed to generate document\");\n      }\n      \n      const blob = await response.blob();\n      const ext = doc.type === \"word\" ? \"docx\" : doc.type === \"excel\" ? \"xlsx\" : \"pptx\";\n      const filename = `${doc.title.replace(/[^a-zA-Z0-9]/g, \"_\")}.${ext}`;\n      \n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error(\"Document download error:\", error);\n    }\n  };\n\n  const handleDownloadImage = (imageData: string) => {\n    const link = document.createElement(\"a\");\n    link.href = imageData;\n    link.download = `imagen-generada-${Date.now()}.png`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  const handleOpenFileAttachmentPreview = async (att: {\n    type: string;\n    name: string;\n    mimeType?: string;\n    imageUrl?: string;\n    storagePath?: string;\n    fileId?: string;\n  }) => {\n    if (att.type === \"image\" && att.imageUrl) {\n      setLightboxImage(att.imageUrl);\n      return;\n    }\n    \n    if (att.type === \"image\" && att.storagePath) {\n      setLightboxImage(att.storagePath);\n      return;\n    }\n\n    setPreviewFileAttachment({\n      ...att,\n      isLoading: true,\n      isProcessing: false,\n      content: undefined,\n    });\n\n    if (att.fileId) {\n      try {\n        const response = await fetch(`/api/files/${att.fileId}/content`);\n        if (response.ok) {\n          const data = await response.json();\n          if (data.status === \"ready\" && data.content) {\n            setPreviewFileAttachment(prev => prev ? {\n              ...prev,\n              content: data.content,\n              isLoading: false,\n              isProcessing: false,\n            } : null);\n            return;\n          } else if (data.status === \"processing\" || data.status === \"queued\") {\n            setPreviewFileAttachment(prev => prev ? {\n              ...prev,\n              isLoading: false,\n              isProcessing: true,\n              content: undefined,\n            } : null);\n            return;\n          }\n        }\n      } catch (error) {\n        console.error(\"Error fetching file content:\", error);\n      }\n    }\n\n    setPreviewFileAttachment(prev => prev ? {\n      ...prev,\n      isLoading: false,\n      isProcessing: false,\n      content: \"No se pudo cargar el contenido del archivo.\",\n    } : null);\n  };\n\n  const handleCopyAttachmentContent = async () => {\n    if (previewFileAttachment?.content) {\n      await navigator.clipboard.writeText(previewFileAttachment.content);\n      setCopiedAttachmentContent(true);\n      setTimeout(() => setCopiedAttachmentContent(false), 2000);\n    }\n  };\n\n  const handleDownloadFileAttachment = async () => {\n    if (!previewFileAttachment?.storagePath) return;\n    try {\n      const response = await fetch(previewFileAttachment.storagePath);\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = previewFileAttachment.name;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    } catch (error) {\n      console.error(\"Download failed:\", error);\n    }\n  };\n\n  const handleFeedback = (msgId: string, value: \"up\" | \"down\") => {\n    setMessageFeedback(prev => ({\n      ...prev,\n      [msgId]: prev[msgId] === value ? null : value\n    }));\n  };\n\n  const handleShare = async (content: string) => {\n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: \"MICHAT Response\",\n          text: content\n        });\n      } catch (e) {\n        navigator.clipboard.writeText(content);\n      }\n    } else {\n      navigator.clipboard.writeText(content);\n    }\n  };\n\n  const handleReadAloud = (msgId: string, content: string) => {\n    if (speakingMessageId === msgId) {\n      speechSynthesis.cancel();\n      setSpeakingMessageId(null);\n    } else {\n      speechSynthesis.cancel();\n      const utterance = new SpeechSynthesisUtterance(content);\n      utterance.onend = () => setSpeakingMessageId(null);\n      utterance.onerror = () => setSpeakingMessageId(null);\n      speechSynthesis.speak(utterance);\n      setSpeakingMessageId(msgId);\n    }\n  };\n\n  const handleRegenerate = async (msgIndex: number) => {\n    const prevMessages = messages.slice(0, msgIndex);\n    const lastUserMsgIndex = [...prevMessages].reverse().findIndex(m => m.role === \"user\");\n    if (lastUserMsgIndex === -1) return;\n    \n    const contextUpToUser = prevMessages.slice(0, prevMessages.length - lastUserMsgIndex);\n    \n    setAiState(\"thinking\");\n    streamingContentRef.current = \"\";\n    setStreamingContent(\"\");\n    \n    try {\n      abortControllerRef.current = new AbortController();\n      \n      const chatHistory = contextUpToUser.map(m => ({\n        role: m.role,\n        content: m.content\n      }));\n\n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ messages: chatHistory, provider: selectedProvider, model: selectedModel }),\n        signal: abortControllerRef.current.signal\n      });\n\n      const data = await response.json();\n      if (!response.ok) throw new Error(data.error);\n\n      setAiState(\"responding\");\n      const fullContent = data.content;\n      let currentIndex = 0;\n      \n      streamIntervalRef.current = setInterval(() => {\n        if (currentIndex < fullContent.length) {\n          const chunkSize = Math.floor(Math.random() * 3) + 1;\n          const newContent = fullContent.slice(0, currentIndex + chunkSize);\n          streamingContentRef.current = newContent;\n          setStreamingContent(newContent);\n          currentIndex += chunkSize;\n        } else {\n          if (streamIntervalRef.current) {\n            clearInterval(streamIntervalRef.current);\n            streamIntervalRef.current = null;\n          }\n          const aiMsg: Message = {\n            id: (Date.now() + 1).toString(),\n            role: \"assistant\",\n            content: fullContent,\n            timestamp: new Date(),\n          };\n          onSendMessage(aiMsg);\n          streamingContentRef.current = \"\";\n          setStreamingContent(\"\");\n          setAiState(\"idle\");\n          abortControllerRef.current = null;\n        }\n      }, 15);\n    } catch (error: any) {\n      if (error.name === \"AbortError\") return;\n      console.error(\"Regenerate error:\", error);\n      setAiState(\"idle\");\n      abortControllerRef.current = null;\n    }\n  };\n\n  const handleStartEdit = (msg: Message) => {\n    setEditingMessageId(msg.id);\n    setEditContent(msg.content);\n  };\n\n  const handleCancelEdit = () => {\n    setEditingMessageId(null);\n    setEditContent(\"\");\n  };\n\n  const handleSendEdit = (msgId: string) => {\n    if (!editContent.trim()) return;\n    const editedMsg: Message = {\n      id: msgId,\n      role: \"user\",\n      content: editContent,\n      timestamp: new Date(),\n    };\n    onSendMessage(editedMsg);\n    setEditingMessageId(null);\n    setEditContent(\"\");\n  };\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files) return;\n\n    await processFilesForUpload(Array.from(files));\n\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const pollFileStatus = async (fileId: string, trackingId: string) => {\n    const maxAttempts = 30;\n    let attempts = 0;\n\n    const checkStatus = async () => {\n      try {\n        const contentRes = await fetch(`/api/files/${fileId}/content`);\n        \n        if (!contentRes.ok && contentRes.status !== 202) {\n          setUploadedFiles((prev) =>\n            prev.map((f) => (f.id === fileId || f.id === trackingId ? { ...f, id: fileId, status: \"error\" } : f))\n          );\n          return;\n        }\n        \n        const contentData = await contentRes.json();\n\n        if (contentData.status === \"ready\") {\n          setUploadedFiles((prev) =>\n            prev.map((f) => (f.id === fileId || f.id === trackingId \n              ? { ...f, id: fileId, status: \"ready\", content: contentData.content } \n              : f))\n          );\n          return;\n        } else if (contentData.status === \"error\") {\n          setUploadedFiles((prev) =>\n            prev.map((f) => (f.id === fileId || f.id === trackingId ? { ...f, id: fileId, status: \"error\" } : f))\n          );\n          return;\n        }\n\n        attempts++;\n        if (attempts >= maxAttempts) {\n          setUploadedFiles((prev) =>\n            prev.map((f) => (f.id === fileId || f.id === trackingId ? { ...f, status: \"error\" } : f))\n          );\n          console.warn(`File ${fileId} processing timed out`);\n          return;\n        }\n        setTimeout(checkStatus, 2000);\n      } catch (error) {\n        console.error(\"Error polling file status:\", error);\n        setUploadedFiles((prev) =>\n          prev.map((f) => (f.id === fileId || f.id === trackingId ? { ...f, status: \"error\" } : f))\n        );\n      }\n    };\n\n    setTimeout(checkStatus, 2000);\n  };\n\n  const removeFile = (index: number) => {\n    setUploadedFiles((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const ALLOWED_TYPES = [\n    \"text/plain\",\n    \"text/markdown\", \n    \"text/csv\",\n    \"text/html\",\n    \"application/json\",\n    \"application/pdf\",\n    \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n    \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    \"application/vnd.ms-excel\",\n    \"application/vnd.openxmlformats-officedocument.presentationml.presentation\",\n    \"application/vnd.ms-powerpoint\",\n    \"image/png\",\n    \"image/jpeg\",\n    \"image/jpg\",\n    \"image/gif\",\n    \"image/bmp\",\n    \"image/webp\",\n    \"image/tiff\",\n  ];\n\n  const processFilesForUpload = async (files: File[]) => {\n    const validFiles = files.filter(file => \n      ALLOWED_TYPES.includes(file.type) || file.type.startsWith(\"image/\")\n    );\n    \n    if (validFiles.length === 0) return;\n\n    const uploadPromises = validFiles.map(async (file) => {\n      const tempId = `temp-${Date.now()}-${Math.random().toString(36).substring(2)}`;\n      const isImage = file.type.startsWith(\"image/\");\n      \n      let dataUrl: string | undefined;\n      if (isImage) {\n        dataUrl = await new Promise<string>((resolve) => {\n          const reader = new FileReader();\n          reader.onloadend = () => resolve(reader.result as string);\n          reader.readAsDataURL(file);\n        });\n      }\n      \n      const tempFile: UploadedFile = {\n        id: tempId,\n        name: file.name,\n        type: file.type,\n        mimeType: file.type,\n        size: file.size,\n        status: \"uploading\",\n        dataUrl,\n      };\n      setUploadedFiles((prev) => [...prev, tempFile]);\n\n      try {\n        const urlRes = await fetch(\"/api/objects/upload\", { method: \"POST\" });\n        const { uploadURL, storagePath } = await urlRes.json();\n        if (!uploadURL || !storagePath) throw new Error(\"No upload URL received\");\n\n        const uploadRes = await fetch(uploadURL, {\n          method: \"PUT\",\n          headers: { \"Content-Type\": file.type },\n          body: file,\n        });\n        if (!uploadRes.ok) throw new Error(\"Upload failed\");\n\n        if (isImage) {\n          const registerRes = await fetch(\"/api/files/quick\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: file.name, type: file.type, size: file.size, storagePath }),\n          });\n          const registeredFile = await registerRes.json();\n          if (!registerRes.ok) throw new Error(registeredFile.error);\n          \n          setUploadedFiles((prev) =>\n            prev.map((f) => f.id === tempId ? { ...f, id: registeredFile.id, storagePath, status: \"ready\" } : f)\n          );\n        } else {\n          setUploadedFiles((prev) =>\n            prev.map((f) => f.id === tempId ? { ...f, status: \"processing\" } : f)\n          );\n          \n          const registerRes = await fetch(\"/api/files\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: file.name, type: file.type, size: file.size, storagePath }),\n          });\n          const registeredFile = await registerRes.json();\n          if (!registerRes.ok) throw new Error(registeredFile.error);\n\n          setUploadedFiles((prev) =>\n            prev.map((f) => f.id === tempId ? { ...f, id: registeredFile.id, storagePath } : f)\n          );\n\n          pollFileStatusFast(registeredFile.id, tempId);\n        }\n      } catch (error) {\n        console.error(\"File upload error:\", error);\n        setUploadedFiles((prev) =>\n          prev.map((f) => (f.id === tempId ? { ...f, status: \"error\" } : f))\n        );\n      }\n    });\n\n    await Promise.all(uploadPromises);\n  };\n  \n  const pollFileStatusFast = async (fileId: string, trackingId: string) => {\n    const maxTime = 3000;\n    const pollInterval = 200;\n    const startTime = Date.now();\n\n    const checkStatus = async (): Promise<void> => {\n      if (Date.now() - startTime > maxTime) {\n        setUploadedFiles((prev) =>\n          prev.map((f) => (f.id === fileId || f.id === trackingId \n            ? { ...f, id: fileId, status: \"ready\", content: \"\" } \n            : f))\n        );\n        return;\n      }\n\n      try {\n        const contentRes = await fetch(`/api/files/${fileId}/content`);\n        \n        if (!contentRes.ok && contentRes.status !== 202) {\n          setUploadedFiles((prev) =>\n            prev.map((f) => (f.id === fileId || f.id === trackingId ? { ...f, id: fileId, status: \"error\" } : f))\n          );\n          return;\n        }\n        \n        const contentData = await contentRes.json();\n\n        if (contentData.status === \"ready\") {\n          setUploadedFiles((prev) =>\n            prev.map((f) => (f.id === fileId || f.id === trackingId \n              ? { ...f, id: fileId, status: \"ready\", content: contentData.content } \n              : f))\n          );\n          return;\n        } else if (contentData.status === \"error\") {\n          setUploadedFiles((prev) =>\n            prev.map((f) => (f.id === fileId || f.id === trackingId ? { ...f, id: fileId, status: \"error\" } : f))\n          );\n          return;\n        }\n\n        setTimeout(checkStatus, pollInterval);\n      } catch (error) {\n        console.error(\"Polling error:\", error);\n        setUploadedFiles((prev) =>\n          prev.map((f) => (f.id === fileId || f.id === trackingId \n            ? { ...f, id: fileId, status: \"ready\", content: \"\" } \n            : f))\n        );\n      }\n    };\n\n    checkStatus();\n  };\n\n  const handlePaste = async (e: React.ClipboardEvent) => {\n    const items = e.clipboardData?.items;\n    if (!items) return;\n\n    const filesToUpload: File[] = [];\n\n    for (const item of Array.from(items)) {\n      if (item.kind === \"file\") {\n        const file = item.getAsFile();\n        if (file) {\n          const mimeType = file.type || item.type || \"image/png\";\n          const ext = mimeType.split(\"/\")[1] || \"png\";\n          const fileName = file.name && file.name !== \"image.png\" && file.name !== \"\" \n            ? file.name \n            : `pasted-${Date.now()}.${ext}`;\n          const renamedFile = new File([file], fileName, { type: mimeType });\n          filesToUpload.push(renamedFile);\n        }\n      }\n    }\n\n    if (filesToUpload.length > 0) {\n      e.preventDefault();\n      await processFilesForUpload(filesToUpload);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  const handleDragEnter = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    dragCounterRef.current++;\n    if (e.dataTransfer?.types?.includes(\"Files\")) {\n      setIsDraggingOver(true);\n    }\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    dragCounterRef.current--;\n    if (dragCounterRef.current === 0) {\n      setIsDraggingOver(false);\n    }\n  };\n\n  const handleDrop = async (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    dragCounterRef.current = 0;\n    setIsDraggingOver(false);\n\n    const files = e.dataTransfer?.files;\n    if (!files || files.length === 0) return;\n\n    await processFilesForUpload(Array.from(files));\n  };\n\n  const getFileIcon = (type: string, fileName?: string) => {\n    const theme = getFileTheme(fileName, type);\n    const category = getFileCategory(fileName, type);\n    \n    if (category === \"excel\") {\n      return <FileSpreadsheet className={`h-4 w-4 ${theme.textColor}`} />;\n    }\n    if (category === \"image\") {\n      return <Image className={`h-4 w-4 ${theme.textColor}`} />;\n    }\n    return <FileText className={`h-4 w-4 ${theme.textColor}`} />;\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return bytes + \" B\";\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + \" KB\";\n    return (bytes / (1024 * 1024)).toFixed(1) + \" MB\";\n  };\n\n  const adjustTextareaHeight = () => {\n    if (textareaRef.current) {\n      textareaRef.current.style.height = \"auto\";\n      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 200)}px`;\n    }\n  };\n\n  useEffect(() => {\n    adjustTextareaHeight();\n  }, [input]);\n\n  const handleSubmit = async () => {\n    // Don't submit if files are still uploading/processing\n    const filesStillLoading = uploadedFiles.some(f => f.status === \"uploading\" || f.status === \"processing\");\n    if (filesStillLoading) return;\n    \n    if (!input.trim() && uploadedFiles.length === 0) return;\n\n    // If there's selected text from document, rewrite it\n    if (selectedDocText && applyRewriteRef.current && input.trim()) {\n      const rewritePrompt = input.trim();\n      setInput(\"\");\n      setAiState(\"thinking\");\n      \n      try {\n        abortControllerRef.current = new AbortController();\n        const response = await fetch(\"/api/chat\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ \n            messages: [{\n              role: \"user\",\n              content: `Reescribe el siguiente texto según esta instrucción: \"${rewritePrompt}\"\\n\\nTexto original:\\n${selectedDocText}\\n\\nDevuelve SOLO el texto reescrito, sin explicaciones ni comentarios adicionales.`\n            }],\n            provider: selectedProvider,\n            model: selectedModel\n          }),\n          signal: abortControllerRef.current.signal\n        });\n\n        const data = await response.json();\n        if (response.ok && data.content) {\n          applyRewriteRef.current(data.content.trim());\n        }\n        \n        setSelectedDocText(\"\");\n        applyRewriteRef.current = null;\n        setAiState(\"idle\");\n        abortControllerRef.current = null;\n        return;\n      } catch (error: any) {\n        if (error.name !== \"AbortError\") {\n          console.error(\"Rewrite error:\", error);\n        }\n        setAiState(\"idle\");\n        abortControllerRef.current = null;\n        return;\n      }\n    }\n\n    const attachments = uploadedFiles\n      .filter(f => f.status === \"ready\" || f.status === \"processing\")\n      .map(f => ({\n        type: f.type.startsWith(\"image/\") ? \"image\" as const :\n              f.type.includes(\"word\") || f.type.includes(\"document\") ? \"word\" as const :\n              f.type.includes(\"sheet\") || f.type.includes(\"excel\") ? \"excel\" as const :\n              f.type.includes(\"presentation\") || f.type.includes(\"powerpoint\") ? \"ppt\" as const :\n              \"word\" as const,\n        name: f.name,\n        imageUrl: f.dataUrl,\n        storagePath: f.storagePath,\n        fileId: f.id,\n      }));\n    \n    // Set thinking state FIRST to show stop button immediately\n    setAiState(\"thinking\");\n    streamingContentRef.current = \"\";\n    setStreamingContent(\"\");\n    \n    const userInput = input;\n    const currentFiles = [...uploadedFiles];\n    \n    // Initialize process steps based on context\n    const hasFiles = currentFiles.length > 0;\n    const initialSteps: {step: string; status: \"pending\" | \"active\" | \"done\"}[] = [];\n    if (hasFiles) {\n      initialSteps.push({ step: \"Analizando archivos adjuntos\", status: \"active\" });\n    }\n    initialSteps.push({ step: \"Procesando tu mensaje\", status: hasFiles ? \"pending\" : \"active\" });\n    initialSteps.push({ step: \"Buscando información relevante\", status: \"pending\" });\n    initialSteps.push({ step: \"Generando respuesta\", status: \"pending\" });\n    setAiProcessSteps(initialSteps);\n    setInput(\"\");\n    setUploadedFiles([]);\n\n    const userMsg: Message = {\n      id: Date.now().toString(),\n      role: \"user\",\n      content: userInput,\n      timestamp: new Date(),\n      attachments: attachments.length > 0 ? attachments : undefined,\n    };\n\n    onSendMessage(userMsg);\n\n    try {\n      abortControllerRef.current = new AbortController();\n      \n      // Check if this is an image generation request (manual tool selection or auto-detect)\n      const isImageTool = selectedTool === \"image\";\n      let shouldGenerateImage = isImageTool;\n      \n      // Auto-detect image requests if no tool is selected (also skip if doc tool like Figma is selected)\n      if (!isImageTool && !selectedTool && !selectedDocTool) {\n        try {\n          const detectRes = await fetch(\"/api/image/detect\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ message: userInput })\n          });\n          const detectData = await detectRes.json();\n          shouldGenerateImage = detectData.isImageRequest;\n        } catch (e) {\n          console.error(\"Image detection error:\", e);\n        }\n      }\n      \n      // Generate image if needed\n      if (shouldGenerateImage) {\n        setIsGeneratingImage(true);\n        setAiProcessSteps([\n          { step: \"Analizando tu petición\", status: \"done\" },\n          { step: \"Generando imagen con IA\", status: \"active\" },\n          { step: \"Procesando resultado\", status: \"pending\" }\n        ]);\n        \n        try {\n          const imageRes = await fetch(\"/api/image/generate\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ prompt: userInput }),\n            signal: abortControllerRef.current.signal\n          });\n          \n          const imageData = await imageRes.json();\n          \n          if (imageRes.ok && imageData.success) {\n            setAiProcessSteps(prev => prev.map(s => ({ ...s, status: \"done\" as const })));\n            \n            const msgId = (Date.now() + 1).toString();\n            \n            // Store image in separate memory store to prevent loss during localStorage sync\n            storeGeneratedImage(msgId, imageData.imageData);\n            \n            // Save generated image to user's library (fire and forget)\n            if (user) {\n              fetch(\"/api/library\", {\n                method: \"POST\",\n                headers: { \"Content-Type\": \"application/json\" },\n                credentials: \"include\",\n                body: JSON.stringify({\n                  mediaType: \"image\",\n                  title: `Imagen generada - ${new Date().toLocaleDateString('es-ES')}`,\n                  description: userInput.slice(0, 200),\n                  storagePath: imageData.imageData,\n                  mimeType: \"image/png\",\n                  sourceChatId: chatId || null,\n                  metadata: { prompt: userInput }\n                })\n              }).catch(err => console.error(\"Failed to save image to library:\", err));\n            }\n            \n            // Also store in local component state and ref for persistence across remounts\n            const pendingImage = { messageId: msgId, imageData: imageData.imageData };\n            setPendingGeneratedImage(pendingImage);\n            latestGeneratedImageRef.current = pendingImage;\n            \n            const aiMsg: Message = {\n              id: msgId,\n              role: \"assistant\",\n              content: \"Aquí está la imagen que generé basada en tu descripción:\",\n              generatedImage: imageData.imageData,\n              timestamp: new Date(),\n            };\n            onSendMessage(aiMsg);\n            \n            setIsGeneratingImage(false);\n            setAiState(\"idle\");\n            setAiProcessSteps([]);\n            setSelectedTool(null);\n            abortControllerRef.current = null;\n            return;\n          } else {\n            throw new Error(imageData.error || \"Error al generar imagen\");\n          }\n        } catch (imgError: any) {\n          setIsGeneratingImage(false);\n          if (imgError.name === \"AbortError\") {\n            setAiState(\"idle\");\n            setAiProcessSteps([]);\n            abortControllerRef.current = null;\n            return;\n          }\n          // If image generation fails, continue with normal chat to explain\n          console.error(\"Image generation failed:\", imgError);\n        }\n      }\n      \n      const fileContents = currentFiles\n        .filter(f => f.content && f.status === \"ready\")\n        .map(f => `[ARCHIVO ADJUNTO: \"${f.name}\"]\\n${f.content}\\n[FIN DEL ARCHIVO]`)\n        .join(\"\\n\\n\");\n      \n      const messageWithFiles = fileContents \n        ? `${fileContents}\\n\\n[SOLICITUD DEL USUARIO]: ${userInput}`\n        : userInput;\n\n      const chatHistory = [...messages, { ...userMsg, content: messageWithFiles }].map(m => ({\n        role: m.role,\n        content: m.content\n      }));\n\n      // Extract image data URLs from current files\n      const imageDataUrls = currentFiles\n        .filter(f => f.type.startsWith(\"image/\") && f.dataUrl)\n        .map(f => f.dataUrl as string);\n\n      // Determine if we're in document mode for special AI behavior\n      const isDocumentMode = !!activeDocEditorRef.current;\n      const documentType = activeDocEditorRef.current?.type || null;\n      const isFigmaMode = selectedDocTool === \"figma\";\n      const isPptMode = documentType === \"ppt\";\n      \n      // Build chat history with PPT system prompt if in PPT mode\n      const finalChatHistory = isPptMode \n        ? [{ role: \"system\", content: PPT_STREAMING_SYSTEM_PROMPT }, ...chatHistory]\n        : chatHistory;\n      \n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ \n          messages: finalChatHistory,\n          images: imageDataUrls.length > 0 ? imageDataUrls : undefined,\n          documentMode: isDocumentMode && !isPptMode ? { type: documentType } : undefined,\n          figmaMode: isFigmaMode,\n          pptMode: isPptMode,\n          provider: selectedProvider,\n          model: selectedModel,\n          gptConfig: activeGpt ? {\n            id: activeGpt.id,\n            systemPrompt: activeGpt.systemPrompt,\n            temperature: parseFloat(activeGpt.temperature || \"0.7\"),\n            topP: parseFloat(activeGpt.topP || \"1\")\n          } : undefined\n        }),\n        signal: abortControllerRef.current?.signal\n      });\n\n      // Update steps: mark processing done, searching active\n      setAiProcessSteps(prev => prev.map((s, i) => {\n        if (s.step.includes(\"Analizando\")) return { ...s, status: \"done\" };\n        if (s.step.includes(\"Procesando\")) return { ...s, status: \"done\" };\n        if (s.step.includes(\"Buscando\")) return { ...s, status: \"active\" };\n        return s;\n      }));\n      \n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || \"Failed to get response\");\n      }\n      \n      // Update steps: mark searching done, generating active\n      setAiProcessSteps(prev => prev.map(s => {\n        if (s.step.includes(\"Buscando\")) return { ...s, status: \"done\" };\n        if (s.step.includes(\"Generando\")) return { ...s, status: \"active\" };\n        return { ...s, status: s.status === \"pending\" ? \"pending\" : \"done\" };\n      }));\n\n      // Note: Not subscribing to agent/browser updates to keep simple thinking → streaming flow\n\n      // Capture document mode state NOW using ref (avoids closure issues)\n      const shouldWriteToDoc = !!activeDocEditorRef.current;\n      \n      const fullContent = data.content;\n      const responseSources = data.sources || [];\n      const figmaDiagram = data.figmaDiagram as FigmaDiagram | undefined;\n      \n      // If Figma diagram was generated, add it to chat immediately\n      if (figmaDiagram) {\n        setAiState(\"responding\");\n        \n        // Quick streaming effect for the text part\n        let currentIndex = 0;\n        streamIntervalRef.current = setInterval(() => {\n          if (currentIndex < fullContent.length) {\n            const chunkSize = Math.floor(Math.random() * 5) + 3;\n            currentIndex = Math.min(currentIndex + chunkSize, fullContent.length);\n            streamingContentRef.current = fullContent.slice(0, currentIndex);\n            setStreamingContent(fullContent.slice(0, currentIndex));\n          } else {\n            if (streamIntervalRef.current) {\n              clearInterval(streamIntervalRef.current);\n              streamIntervalRef.current = null;\n            }\n            \n            const aiMsg: Message = {\n              id: (Date.now() + 1).toString(),\n              role: \"assistant\",\n              content: fullContent,\n              timestamp: new Date(),\n              figmaDiagram,\n            };\n            onSendMessage(aiMsg);\n            \n            streamingContentRef.current = \"\";\n            setStreamingContent(\"\");\n            setAiState(\"idle\");\n            setAiProcessSteps([]);\n            setSelectedDocTool(null); // Reset tool selection\n            agent.complete();\n            abortControllerRef.current = null;\n          }\n        }, 10);\n        return;\n      }\n      \n      // If PPT mode is active: Stream to PPT editor using special parser\n      if (isPptMode && shouldWriteToDoc) {\n        setAiState(\"responding\");\n        \n        // Clear chat streaming - we write to PPT canvas\n        streamingContentRef.current = \"\";\n        setStreamingContent(\"\");\n        \n        // Start PPT streaming\n        pptStreaming.startStreaming();\n        \n        // Stream content progressively through PPT parser\n        let currentIndex = 0;\n        \n        streamIntervalRef.current = setInterval(() => {\n          if (currentIndex < fullContent.length) {\n            // Get progressive chunk\n            const chunkSize = Math.floor(Math.random() * 8) + 4;\n            const newChunk = fullContent.slice(currentIndex, currentIndex + chunkSize);\n            currentIndex += chunkSize;\n            \n            // Route chunk through PPT stream parser\n            pptStreaming.processChunk(newChunk);\n          } else {\n            if (streamIntervalRef.current) {\n              clearInterval(streamIntervalRef.current);\n              streamIntervalRef.current = null;\n            }\n            \n            // Finalize PPT streaming\n            pptStreaming.stopStreaming();\n            \n            // Add confirmation message in chat\n            const confirmMsg: Message = {\n              id: (Date.now() + 1).toString(),\n              role: \"assistant\",\n              content: \"✓ Presentación generada correctamente\",\n              timestamp: new Date(),\n            };\n            onSendMessage(confirmMsg);\n            \n            setAiState(\"idle\");\n            setAiProcessSteps([]);\n            agent.complete();\n            abortControllerRef.current = null;\n          }\n        }, 20);\n        return;\n      }\n      \n      // If document mode is active: Stream DIRECTLY to document editor in real-time\n      if (shouldWriteToDoc && docInsertContentRef.current) {\n        setAiState(\"responding\");\n        \n        // Clear chat streaming - we write directly to document\n        streamingContentRef.current = \"\";\n        setStreamingContent(\"\");\n        \n        // Stream content progressively to document editor\n        let currentIndex = 0;\n        \n        streamIntervalRef.current = setInterval(() => {\n          if (currentIndex < fullContent.length) {\n            // Get progressive chunk - larger chunks for smoother document typing\n            const chunkSize = Math.floor(Math.random() * 15) + 8;\n            currentIndex = Math.min(currentIndex + chunkSize, fullContent.length);\n            const contentSoFar = fullContent.slice(0, currentIndex);\n            \n            // Replace entire document content with progressively more content\n            // This ensures markdown renders correctly at each step\n            try {\n              if (docInsertContentRef.current) {\n                docInsertContentRef.current(contentSoFar, true); // replaceMode = true\n              }\n            } catch (err) {\n              console.error('[ChatInterface] Error streaming to document:', err);\n            }\n          } else {\n            if (streamIntervalRef.current) {\n              clearInterval(streamIntervalRef.current);\n              streamIntervalRef.current = null;\n            }\n            \n            // Final write with complete content to ensure nothing is missed\n            try {\n              if (docInsertContentRef.current) {\n                docInsertContentRef.current(fullContent, true);\n              }\n            } catch (err) {\n              console.error('[ChatInterface] Error finalizing document:', err);\n            }\n            \n            // Add confirmation message in chat\n            const confirmMsg: Message = {\n              id: (Date.now() + 1).toString(),\n              role: \"assistant\",\n              content: \"✓ Documento generado correctamente\",\n              timestamp: new Date(),\n            };\n            onSendMessage(confirmMsg);\n            \n            setAiState(\"idle\");\n            setAiProcessSteps([]);\n            agent.complete();\n            abortControllerRef.current = null;\n          }\n        }, 25);\n      } else {\n        // Normal chat mode - stream to chat interface\n        setAiState(\"responding\");\n        let currentIndex = 0;\n        \n        streamIntervalRef.current = setInterval(() => {\n          if (currentIndex < fullContent.length) {\n            const chunkSize = Math.floor(Math.random() * 3) + 1;\n            const newContent = fullContent.slice(0, currentIndex + chunkSize);\n            streamingContentRef.current = newContent;\n            setStreamingContent(newContent);\n            currentIndex += chunkSize;\n          } else {\n            if (streamIntervalRef.current) {\n              clearInterval(streamIntervalRef.current);\n              streamIntervalRef.current = null;\n            }\n            \n            const aiMsg: Message = {\n              id: (Date.now() + 1).toString(),\n              role: \"assistant\",\n              content: fullContent,\n              timestamp: new Date(),\n              sources: responseSources.length > 0 ? responseSources : undefined,\n            };\n            onSendMessage(aiMsg);\n            \n            streamingContentRef.current = \"\";\n            setStreamingContent(\"\");\n            setAiState(\"idle\");\n            setAiProcessSteps([]);\n            agent.complete();\n            abortControllerRef.current = null;\n          }\n        }, 15);\n      }\n      \n    } catch (error: any) {\n      // Clean up PPT streaming on any error\n      if (pptStreaming.isStreaming) {\n        pptStreaming.stopStreaming();\n      }\n      \n      if (error.name === \"AbortError\") {\n        return;\n      }\n      console.error(\"Chat error:\", error);\n      const errorMsg: Message = {\n        id: (Date.now() + 1).toString(),\n        role: \"assistant\",\n        content: `Lo siento, hubo un error al procesar tu mensaje. Por favor intenta de nuevo.`,\n        timestamp: new Date(),\n      };\n      onSendMessage(errorMsg);\n      setAiState(\"idle\");\n      setAiProcessSteps([]);\n      abortControllerRef.current = null;\n    }\n  };\n\n  const hasMessages = messages.length > 0;\n\n  return (\n    <div className=\"flex h-full flex-col bg-transparent relative\">\n      {/* Header */}\n      <header className=\"flex h-14 items-center justify-between px-2 sm:px-4 border-b border-white/20 dark:border-white/10 glass-card-light dark:glass-card rounded-none z-10 sticky top-0 flex-shrink-0 safe-area-top\">\n        <div className=\"flex items-center gap-1 sm:gap-2 relative min-w-0\">\n          <div \n            className=\"flex items-center gap-1 sm:gap-2 cursor-pointer hover:bg-muted/50 px-1.5 sm:px-2 py-1 rounded-md transition-colors\"\n            onClick={() => setIsModelSelectorOpen(!isModelSelectorOpen)}\n            data-testid=\"button-model-selector\"\n          >\n            <span className=\"font-semibold text-xs sm:text-sm truncate max-w-[80px] sm:max-w-none\">\n              {selectedProvider === \"xai\" ? \"xAI\" : \"Gemini\"}: {\n                selectedProvider === \"xai\" \n                  ? (selectedModel === \"grok-3-fast\" ? \"Grok 3\" : \"Vision\")\n                  : (selectedModel === \"gemini-3-flash-preview\" ? \"3 Flash\" \n                     : selectedModel === \"gemini-2.5-flash\" ? \"2.5 Flash\" : \"2.5 Pro\")\n              }\n            </span>\n            <ChevronDown className=\"h-3 w-3 text-muted-foreground flex-shrink-0\" />\n          </div>\n          \n          {isModelSelectorOpen && (\n            <div className=\"absolute top-full left-0 mt-1 w-64 bg-popover border border-border rounded-lg shadow-lg z-50\">\n              <div className=\"p-2\">\n                <div className=\"text-xs font-medium text-muted-foreground mb-2 px-2\">xAI</div>\n                <button\n                  className={`w-full text-left px-3 py-2 rounded-md hover:bg-muted/50 text-sm ${selectedProvider === \"xai\" && selectedModel === \"grok-3-fast\" ? \"bg-muted\" : \"\"}`}\n                  onClick={() => { setSelectedProvider(\"xai\"); setSelectedModel(\"grok-3-fast\"); setIsModelSelectorOpen(false); }}\n                  data-testid=\"model-option-grok-3-fast\"\n                >\n                  <div className=\"font-medium\">Grok 3 Fast</div>\n                  <div className=\"text-xs text-muted-foreground\">Respuestas más rápidas</div>\n                </button>\n                <button\n                  className={`w-full text-left px-3 py-2 rounded-md hover:bg-muted/50 text-sm ${selectedProvider === \"xai\" && selectedModel === \"grok-2-vision-1212\" ? \"bg-muted\" : \"\"}`}\n                  onClick={() => { setSelectedProvider(\"xai\"); setSelectedModel(\"grok-2-vision-1212\"); setIsModelSelectorOpen(false); }}\n                  data-testid=\"model-option-grok-2-vision\"\n                >\n                  <div className=\"font-medium\">Grok 2 Vision</div>\n                  <div className=\"text-xs text-muted-foreground\">Análisis de imágenes</div>\n                </button>\n                \n                <div className=\"border-t border-border my-2\"></div>\n                \n                <div className=\"text-xs font-medium text-muted-foreground mb-2 px-2\">Google Gemini</div>\n                <button\n                  className={`w-full text-left px-3 py-2 rounded-md hover:bg-muted/50 text-sm ${selectedProvider === \"gemini\" && selectedModel === \"gemini-3-flash-preview\" ? \"bg-muted\" : \"\"}`}\n                  onClick={() => { setSelectedProvider(\"gemini\"); setSelectedModel(\"gemini-3-flash-preview\"); setIsModelSelectorOpen(false); }}\n                  data-testid=\"model-option-gemini-3-flash\"\n                >\n                  <div className=\"font-medium\">Gemini 3 Flash Preview</div>\n                  <div className=\"text-xs text-muted-foreground\">Más nuevo y rápido (predeterminado)</div>\n                </button>\n                <button\n                  className={`w-full text-left px-3 py-2 rounded-md hover:bg-muted/50 text-sm ${selectedProvider === \"gemini\" && selectedModel === \"gemini-2.5-flash\" ? \"bg-muted\" : \"\"}`}\n                  onClick={() => { setSelectedProvider(\"gemini\"); setSelectedModel(\"gemini-2.5-flash\"); setIsModelSelectorOpen(false); }}\n                  data-testid=\"model-option-gemini-flash\"\n                >\n                  <div className=\"font-medium\">Gemini 2.5 Flash</div>\n                  <div className=\"text-xs text-muted-foreground\">Rápido y eficiente</div>\n                </button>\n                <button\n                  className={`w-full text-left px-3 py-2 rounded-md hover:bg-muted/50 text-sm ${selectedProvider === \"gemini\" && selectedModel === \"gemini-2.5-pro\" ? \"bg-muted\" : \"\"}`}\n                  onClick={() => { setSelectedProvider(\"gemini\"); setSelectedModel(\"gemini-2.5-pro\"); setIsModelSelectorOpen(false); }}\n                  data-testid=\"model-option-gemini-pro\"\n                >\n                  <div className=\"font-medium\">Gemini 2.5 Pro</div>\n                  <div className=\"text-xs text-muted-foreground\">Más capaz y avanzado</div>\n                </button>\n              </div>\n            </div>\n          )}\n        </div>\n        <div className=\"flex items-center gap-0.5 sm:gap-1\">\n          {user?.email !== \"infosiragpt@gmail.com\" && (\n            <Button\n              size=\"sm\"\n              className=\"rounded-full text-[10px] sm:text-xs px-2 sm:px-4 bg-purple-600 hover:bg-purple-700 text-white border-0\"\n              onClick={() => setIsUpgradeDialogOpen(true)}\n              data-testid=\"button-upgrade-header\"\n            >\n              <span className=\"hidden sm:inline\">Mejorar el plan a Go</span>\n              <span className=\"sm:hidden\">Mejorar</span>\n            </Button>\n          )}\n          {chatId && !chatId.startsWith(\"pending-\") ? (\n            <ShareChatDialog chatId={chatId} chatTitle={messages[0]?.content?.slice(0, 30) || \"Chat\"}>\n              <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-share-chat\">\n                <ShareIcon size={20} />\n              </Button>\n            </ShareChatDialog>\n          ) : (\n            <Button \n              variant=\"ghost\" \n              size=\"icon\" \n              data-testid=\"button-share-chat-disabled\"\n              disabled\n              title=\"Envía un mensaje para poder compartir este chat\"\n            >\n              <ShareIcon size={20} />\n            </Button>\n          )}\n          <Button variant=\"ghost\" size=\"icon\">\n            <MoreHorizontal className=\"h-5 w-5 text-muted-foreground\" />\n          </Button>\n        </div>\n      </header>\n\n      {/* Main Content Area with Side Panel */}\n      {(previewDocument || activeDocEditor) ? (\n        <PanelGroup direction=\"horizontal\" className=\"flex-1\">\n          {/* Left Panel: Minimized Chat for Document Mode */}\n          <Panel defaultSize={activeDocEditor ? 25 : 50} minSize={20} maxSize={activeDocEditor ? 35 : 70}>\n            <div className=\"flex flex-col min-w-0 h-full bg-background/50\">\n              {/* Compact Header for Document Mode */}\n              {activeDocEditor && (\n                <div className=\"p-3 border-b border-border/50 bg-muted/30\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className={cn(\n                      \"w-8 h-8 rounded-lg flex items-center justify-center\",\n                      activeDocEditor.type === \"word\" && \"bg-blue-600\",\n                      activeDocEditor.type === \"excel\" && \"bg-green-600\",\n                      activeDocEditor.type === \"ppt\" && \"bg-orange-500\"\n                    )}>\n                      <span className=\"text-white text-sm font-bold\">\n                        {activeDocEditor.type === \"word\" ? \"W\" : activeDocEditor.type === \"excel\" ? \"E\" : \"P\"}\n                      </span>\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium truncate\">Instrucciones</p>\n                      <p className=\"text-xs text-muted-foreground\">El AI escribe directo al documento</p>\n                    </div>\n                  </div>\n                </div>\n              )}\n              \n          {/* Messages Area - Compact for document mode */}\n          {hasMessages && (\n            <div \n              className={cn(\n                \"flex-1 overflow-y-auto space-y-3 overscroll-contain\",\n                activeDocEditor ? \"p-3\" : \"p-4 sm:p-6 md:p-10 space-y-6\"\n              )}\n              style={{ paddingBottom: 'var(--composer-height, 120px)' }}\n            >\n              <MessageList\n                messages={messages}\n                variant={activeDocEditor ? \"compact\" : \"default\"}\n                editingMessageId={editingMessageId}\n                editContent={editContent}\n                setEditContent={setEditContent}\n                copiedMessageId={copiedMessageId}\n                messageFeedback={messageFeedback}\n                speakingMessageId={speakingMessageId}\n                isGeneratingImage={isGeneratingImage}\n                pendingGeneratedImage={pendingGeneratedImage}\n                latestGeneratedImageRef={latestGeneratedImageRef}\n                streamingContent={streamingContent}\n                aiState={aiState}\n                handleCopyMessage={handleCopyMessage}\n                handleStartEdit={handleStartEdit}\n                handleCancelEdit={handleCancelEdit}\n                handleSendEdit={handleSendEdit}\n                handleFeedback={handleFeedback}\n                handleRegenerate={handleRegenerate}\n                handleShare={handleShare}\n                handleReadAloud={handleReadAloud}\n                handleOpenDocumentPreview={handleOpenDocumentPreview}\n                handleOpenFileAttachmentPreview={handleOpenFileAttachmentPreview}\n                handleDownloadImage={handleDownloadImage}\n                setLightboxImage={setLightboxImage}\n              />\n\n              {/* Agent Observer - Show when agent is running */}\n        {agent.state.status !== \"idle\" && (\n          <div className=\"flex w-full max-w-3xl mx-auto gap-4 justify-start\">\n            <AgentObserver\n              steps={agent.state.steps}\n              objective={agent.state.objective}\n              status={agent.state.status}\n              onCancel={agent.cancel}\n            />\n          </div>\n        )}\n\n        {/* Image Generation Loading Skeleton */}\n        {isGeneratingImage && (\n          <div className=\"flex w-full max-w-3xl mx-auto gap-4 justify-start\">\n            <div className=\"flex flex-col gap-2 items-start\">\n              <div className=\"liquid-message-ai-light px-4 py-3 text-sm mb-2\">\n                <div className=\"flex items-center gap-2\">\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  <span>Generando imagen...</span>\n                </div>\n              </div>\n              <div className=\"px-4\">\n                <div className=\"w-64 h-64 bg-muted rounded-lg animate-pulse flex items-center justify-center\">\n                  <Image className=\"h-8 w-8 text-muted-foreground\" />\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Thinking/Responding State */}\n        {aiState !== \"idle\" && !isGeneratingImage && (\n          <div className=\"flex w-full max-w-3xl mx-auto gap-4 justify-start\">\n            <div className=\"flex flex-col gap-2 items-start\">\n              {aiState === \"thinking\" && (\n                <div className=\"liquid-message-ai-light px-4 py-3 text-sm\">\n                  <div className=\"flex items-center\">\n                    <span className=\"thinking-wave\">Pensando</span>\n                    <span className=\"thinking-cursor\">|</span>\n                  </div>\n                </div>\n              )}\n              {aiState === \"responding\" && streamingContent && (\n                <div className=\"px-4 py-3 text-foreground min-w-0\" style={{ fontFamily: \"Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif\", fontSize: \"16px\", lineHeight: \"1.6\", fontWeight: 400 }}>\n                  <MarkdownRenderer\n                    content={streamingContent}\n                    customComponents={{...CleanDataTableComponents}}\n                  />\n                  <span className=\"typing-cursor\">|</span>\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n        \n              <div ref={bottomRef} />\n            </div>\n          )}\n\n          {/* Centered content when no messages */}\n          {!hasMessages && (\n            <div className=\"flex-1 flex flex-col items-center justify-center\">\n              <div className=\"flex flex-col items-center justify-center text-center space-y-4 mb-6\">\n                {activeGpt ? (\n                  <>\n                    <div className=\"w-16 h-16 rounded-2xl bg-muted flex items-center justify-center mb-2\">\n                      {activeGpt.avatar ? (\n                        <img src={activeGpt.avatar} alt={activeGpt.name} className=\"w-full h-full rounded-2xl object-cover\" />\n                      ) : (\n                        <Bot className=\"h-8 w-8 text-muted-foreground\" />\n                      )}\n                    </div>\n                    <h2 className=\"text-xl font-semibold\">{activeGpt.name}</h2>\n                    <p className=\"text-muted-foreground max-w-md\">{activeGpt.welcomeMessage || activeGpt.description || \"¿En qué puedo ayudarte?\"}</p>\n                    {activeGpt.conversationStarters && activeGpt.conversationStarters.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2 mt-4 justify-center max-w-xl\">\n                        {activeGpt.conversationStarters.filter(s => s).map((starter, idx) => (\n                          <button\n                            key={idx}\n                            onClick={() => setInput(starter)}\n                            className=\"px-4 py-2 text-sm border rounded-lg hover:bg-muted/50 transition-colors text-left\"\n                          >\n                            {starter}\n                          </button>\n                        ))}\n                      </div>\n                    )}\n                  </>\n                ) : (\n                  <p className=\"text-muted-foreground\">¿En qué puedo ayudarte?</p>\n                )}\n              </div>\n            </div>\n          )}\n\n          <Composer\n            input={input}\n            setInput={setInput}\n            textareaRef={textareaRef}\n            composerRef={composerRef}\n            fileInputRef={fileInputRef}\n            uploadedFiles={uploadedFiles}\n            removeFile={removeFile}\n            handleSubmit={handleSubmit}\n            handleFileUpload={handleFileUpload}\n            handlePaste={handlePaste}\n            handleDragOver={handleDragOver}\n            handleDragEnter={handleDragEnter}\n            handleDragLeave={handleDragLeave}\n            handleDrop={handleDrop}\n            isDraggingOver={isDraggingOver}\n            selectedTool={selectedTool}\n            setSelectedTool={setSelectedTool}\n            selectedDocTool={selectedDocTool}\n            setSelectedDocTool={setSelectedDocTool}\n            closeDocEditor={closeDocEditor}\n            openBlankDocEditor={openBlankDocEditor}\n            aiState={aiState}\n            isRecording={isRecording}\n            isPaused={isPaused}\n            recordingTime={recordingTime}\n            toggleVoiceRecording={toggleVoiceRecording}\n            discardVoiceRecording={discardVoiceRecording}\n            pauseVoiceRecording={pauseVoiceRecording}\n            resumeVoiceRecording={resumeVoiceRecording}\n            sendVoiceRecording={sendVoiceRecording}\n            handleStopChat={handleStopChat}\n            setIsVoiceChatOpen={setIsVoiceChatOpen}\n            browserSession={browserSession}\n            isBrowserOpen={isBrowserOpen}\n            setIsBrowserOpen={setIsBrowserOpen}\n            isBrowserMaximized={isBrowserMaximized}\n            setIsBrowserMaximized={setIsBrowserMaximized}\n            browserUrl={browserUrl}\n            variant=\"document\"\n            placeholder={selectedDocText ? \"Escribe cómo mejorar el texto...\" : \"Type your message here...\"}\n            selectedDocText={selectedDocText}\n            handleDocTextDeselect={handleDocTextDeselect}\n          />\n            </div>\n          </Panel>\n\n          {/* Resize Handle */}\n          <PanelResizeHandle className=\"w-2 bg-border/50 hover:bg-primary/30 transition-colors cursor-col-resize flex items-center justify-center group\">\n            <GripVertical className=\"h-6 w-6 text-muted-foreground/50 group-hover:text-primary transition-colors\" />\n          </PanelResizeHandle>\n\n          {/* Right: Document Editor Panel */}\n          <Panel defaultSize={activeDocEditor ? 75 : 50} minSize={25}>\n            <div className=\"h-full animate-in slide-in-from-right duration-300\">\n              {(activeDocEditor?.type === \"ppt\") ? (\n                <PPTEditorShell\n                  onClose={closeDocEditor}\n                  onInsertContent={(insertFn) => { docInsertContentRef.current = insertFn; }}\n                />\n              ) : (activeDocEditor?.type === \"excel\" || previewDocument?.type === \"excel\") ? (\n                <SpreadsheetEditor\n                  key=\"excel-editor-stable\"\n                  title={activeDocEditor ? activeDocEditor.title : (previewDocument?.title || \"\")}\n                  content={editedDocumentContent}\n                  onChange={setEditedDocumentContent}\n                  onClose={activeDocEditor ? closeDocEditor : handleCloseDocumentPreview}\n                  onDownload={() => {\n                    if (activeDocEditor) {\n                      handleDownloadDocument({\n                        type: activeDocEditor.type,\n                        title: activeDocEditor.title,\n                        content: editedDocumentContent\n                      });\n                    } else if (previewDocument) {\n                      handleDownloadDocument(previewDocument);\n                    }\n                  }}\n                  onInsertContent={(insertFn) => { docInsertContentRef.current = insertFn; }}\n                />\n              ) : (\n                <EnhancedDocumentEditor\n                  key={activeDocEditor ? `new-${activeDocEditor.type}` : previewDocument?.title}\n                  title={activeDocEditor ? activeDocEditor.title : (previewDocument?.title || \"\")}\n                  content={editedDocumentContent}\n                  onChange={setEditedDocumentContent}\n                  onClose={activeDocEditor ? closeDocEditor : handleCloseDocumentPreview}\n                  onDownload={() => {\n                    if (activeDocEditor) {\n                      handleDownloadDocument({\n                        type: activeDocEditor.type,\n                        title: activeDocEditor.title,\n                        content: editedDocumentContent\n                      });\n                    } else if (previewDocument) {\n                      handleDownloadDocument(previewDocument);\n                    }\n                  }}\n                  onTextSelect={handleDocTextSelect}\n                  onTextDeselect={handleDocTextDeselect}\n                  onInsertContent={(insertFn) => { docInsertContentRef.current = insertFn; }}\n                />\n              )}\n            </div>\n          </Panel>\n        </PanelGroup>\n      ) : (\n        <div className=\"flex-1 flex flex-col min-w-0 overflow-hidden\">\n          {/* Messages Area - only show when there are messages */}\n          {hasMessages && (\n            <div \n              className=\"flex-1 overflow-y-auto p-4 sm:p-6 md:p-10 space-y-6 overscroll-contain\"\n              style={{ paddingBottom: 'var(--composer-height, 120px)' }}\n            >\n              <MessageList\n                messages={messages}\n                variant=\"default\"\n                editingMessageId={editingMessageId}\n                editContent={editContent}\n                setEditContent={setEditContent}\n                copiedMessageId={copiedMessageId}\n                messageFeedback={messageFeedback}\n                speakingMessageId={speakingMessageId}\n                isGeneratingImage={isGeneratingImage}\n                pendingGeneratedImage={pendingGeneratedImage}\n                latestGeneratedImageRef={latestGeneratedImageRef}\n                streamingContent={streamingContent}\n                aiState={aiState}\n                handleCopyMessage={handleCopyMessage}\n                handleStartEdit={handleStartEdit}\n                handleCancelEdit={handleCancelEdit}\n                handleSendEdit={handleSendEdit}\n                handleFeedback={handleFeedback}\n                handleRegenerate={handleRegenerate}\n                handleShare={handleShare}\n                handleReadAloud={handleReadAloud}\n                handleOpenDocumentPreview={handleOpenDocumentPreview}\n                handleOpenFileAttachmentPreview={handleOpenFileAttachmentPreview}\n                handleDownloadImage={handleDownloadImage}\n                setLightboxImage={setLightboxImage}\n              />\n              \n              <div ref={messagesEndRef} />\n\n            </div>\n          )}\n\n          {/* Processing indicators when AI is working (even without messages) */}\n          {!hasMessages && aiState !== \"idle\" && (\n            <div className=\"flex-1 flex flex-col items-center justify-center px-4\">\n              {streamingContent ? (\n                <div className=\"w-full max-w-3xl mx-auto\">\n                  <div className=\"flex flex-col gap-2 max-w-[85%] items-start min-w-0\">\n                    <div className=\"text-sm prose prose-sm dark:prose-invert max-w-none leading-relaxed min-w-0\">\n                      <MarkdownRenderer\n                        content={streamingContent}\n                        customComponents={{...CleanDataTableComponents}}\n                      />\n                      <span className=\"inline-block w-0.5 h-4 bg-primary animate-[pulse_0.33s_ease-in-out_infinite] ml-0.5\" />\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                <motion.div \n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  className=\"w-full max-w-3xl mx-auto\"\n                >\n                  <div className=\"flex items-center gap-3 py-3 px-4 text-sm text-muted-foreground bg-muted/30 rounded-lg\">\n                    <div className=\"flex gap-1\">\n                      <span className=\"w-2 h-2 bg-primary rounded-full animate-bounce\" style={{ animationDelay: '0ms' }} />\n                      <span className=\"w-2 h-2 bg-primary rounded-full animate-bounce\" style={{ animationDelay: '150ms' }} />\n                      <span className=\"w-2 h-2 bg-primary rounded-full animate-bounce\" style={{ animationDelay: '300ms' }} />\n                    </div>\n                    <span className=\"font-medium\">\n                      {aiState === \"thinking\" ? \"Pensando...\" : \"Escribiendo...\"}\n                    </span>\n                  </div>\n                </motion.div>\n              )}\n            </div>\n          )}\n\n          {/* Welcome Screen when no messages AND not processing */}\n          {!hasMessages && aiState === \"idle\" && (\n            <div className=\"flex-1 flex flex-col items-center justify-center px-4\">\n              <motion.div \n                initial={{ scale: 0.8, opacity: 0 }}\n                animate={{ scale: 1, opacity: 1 }}\n                transition={{ duration: 0.5, ease: \"easeOut\" }}\n                className=\"mb-8\"\n              >\n                {activeGpt?.avatar ? (\n                  <div className=\"w-20 h-20 rounded-2xl bg-gradient-to-br from-primary via-primary/80 to-primary/60 flex items-center justify-center shadow-2xl shadow-primary/30\">\n                    <img src={activeGpt.avatar} alt={activeGpt.name} className=\"w-full h-full rounded-2xl object-cover\" />\n                  </div>\n                ) : (\n                  <SiraLogo size={80} />\n                )}\n              </motion.div>\n              <motion.h1 \n                initial={{ y: 20, opacity: 0 }}\n                animate={{ y: 0, opacity: 1 }}\n                transition={{ duration: 0.5, delay: 0.2 }}\n                className=\"text-4xl font-bold text-center mb-3 bg-gradient-to-r from-foreground via-foreground/90 to-foreground/70 bg-clip-text\"\n              >\n                {activeGpt ? activeGpt.name : \"¿En qué puedo ayudarte?\"}\n              </motion.h1>\n              <motion.p \n                initial={{ y: 20, opacity: 0 }}\n                animate={{ y: 0, opacity: 1 }}\n                transition={{ duration: 0.5, delay: 0.3 }}\n                className=\"text-muted-foreground text-center max-w-md text-base\"\n              >\n                {activeGpt \n                  ? (activeGpt.welcomeMessage || activeGpt.description || \"¿En qué puedo ayudarte?\")\n                  : \"Soy MICHAT, tu asistente de IA. Puedo responder preguntas, generar documentos, analizar archivos y mucho más.\"\n                }\n              </motion.p>\n              {activeGpt?.conversationStarters && activeGpt.conversationStarters.length > 0 && (\n                <motion.div\n                  initial={{ y: 20, opacity: 0 }}\n                  animate={{ y: 0, opacity: 1 }}\n                  transition={{ duration: 0.5, delay: 0.4 }}\n                  className=\"flex flex-wrap gap-2 mt-6 justify-center max-w-xl\"\n                >\n                  {activeGpt.conversationStarters.filter(s => s).map((starter, idx) => (\n                    <button\n                      key={idx}\n                      onClick={() => setInput(starter)}\n                      className=\"px-4 py-2 text-sm border rounded-lg hover:bg-muted/50 transition-colors text-left\"\n                      data-testid={`button-starter-${idx}`}\n                    >\n                      {starter}\n                    </button>\n                  ))}\n                </motion.div>\n              )}\n            </div>\n          )}\n          \n          {/* Input Bar */}\n          <Composer\n            input={input}\n            setInput={setInput}\n            textareaRef={textareaRef}\n            composerRef={composerRef}\n            fileInputRef={fileInputRef}\n            uploadedFiles={uploadedFiles}\n            removeFile={removeFile}\n            handleSubmit={handleSubmit}\n            handleFileUpload={handleFileUpload}\n            handlePaste={handlePaste}\n            handleDragOver={handleDragOver}\n            handleDragEnter={handleDragEnter}\n            handleDragLeave={handleDragLeave}\n            handleDrop={handleDrop}\n            isDraggingOver={isDraggingOver}\n            selectedTool={selectedTool}\n            setSelectedTool={setSelectedTool}\n            selectedDocTool={selectedDocTool}\n            setSelectedDocTool={setSelectedDocTool}\n            closeDocEditor={closeDocEditor}\n            openBlankDocEditor={openBlankDocEditor}\n            aiState={aiState}\n            isRecording={isRecording}\n            isPaused={isPaused}\n            recordingTime={recordingTime}\n            toggleVoiceRecording={toggleVoiceRecording}\n            discardVoiceRecording={discardVoiceRecording}\n            pauseVoiceRecording={pauseVoiceRecording}\n            resumeVoiceRecording={resumeVoiceRecording}\n            sendVoiceRecording={sendVoiceRecording}\n            handleStopChat={handleStopChat}\n            setIsVoiceChatOpen={setIsVoiceChatOpen}\n            browserSession={browserSession}\n            isBrowserOpen={isBrowserOpen}\n            setIsBrowserOpen={setIsBrowserOpen}\n            isBrowserMaximized={isBrowserMaximized}\n            setIsBrowserMaximized={setIsBrowserMaximized}\n            browserUrl={browserUrl}\n            variant=\"default\"\n            placeholder=\"Escribe tu mensaje aquí...\"\n            onCloseSidebar={onCloseSidebar}\n            setPreviewUploadedImage={setPreviewUploadedImage}\n            isFigmaConnected={isFigmaConnected}\n            isFigmaConnecting={isFigmaConnecting}\n            handleFigmaConnect={handleFigmaConnect}\n            handleFigmaDisconnect={handleFigmaDisconnect}\n          />\n        </div>\n      )}\n      \n      \n      <ETLDialog \n        open={isETLDialogOpen} \n        onClose={() => setIsETLDialogOpen(false)}\n        onComplete={(summary) => {\n          onSendMessage({\n            id: `etl-${Date.now()}`,\n            role: \"assistant\",\n            content: `ETL Agent completed. ${summary}`,\n            timestamp: new Date()\n          });\n        }}\n      />\n\n      <UpgradePlanDialog \n        open={isUpgradeDialogOpen} \n        onOpenChange={setIsUpgradeDialogOpen} \n      />\n\n      <DocumentGeneratorDialog\n        open={isDocGeneratorOpen}\n        onClose={() => setIsDocGeneratorOpen(false)}\n        documentType={docGeneratorType}\n        onComplete={(message) => {\n          onSendMessage({\n            id: `doc-gen-${Date.now()}`,\n            role: \"assistant\",\n            content: message,\n            timestamp: new Date()\n          });\n        }}\n      />\n\n      {/* Voice Chat Mode - Fullscreen conversation with Grok */}\n      <VoiceChatMode \n        open={isVoiceChatOpen} \n        onClose={() => setIsVoiceChatOpen(false)} \n      />\n\n      {/* Image Lightbox Modal */}\n      {lightboxImage && (\n        <div \n          className=\"fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4\"\n          onClick={() => setLightboxImage(null)}\n        >\n          <div className=\"relative max-w-[90vw] max-h-[90vh]\">\n            <img \n              src={lightboxImage} \n              alt=\"Imagen ampliada\" \n              className=\"max-w-full max-h-[90vh] rounded-lg shadow-2xl\"\n              onClick={(e) => e.stopPropagation()}\n            />\n            <Button\n              variant=\"secondary\"\n              size=\"icon\"\n              className=\"absolute top-4 right-4 h-10 w-10 bg-black/60 hover:bg-black/80 text-white\"\n              onClick={() => setLightboxImage(null)}\n              data-testid=\"button-close-lightbox\"\n            >\n              <X className=\"h-5 w-5\" />\n            </Button>\n            <Button\n              variant=\"secondary\"\n              size=\"icon\"\n              className=\"absolute top-4 right-16 h-10 w-10 bg-black/60 hover:bg-black/80 text-white\"\n              onClick={(e) => { e.stopPropagation(); handleDownloadImage(lightboxImage); }}\n              data-testid=\"button-download-lightbox\"\n            >\n              <Download className=\"h-5 w-5\" />\n            </Button>\n          </div>\n        </div>\n      )}\n\n      {/* File Attachment Preview Modal */}\n      {previewFileAttachment && (\n        <motion.div \n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 0.2 }}\n          className=\"fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4\"\n          onClick={() => setPreviewFileAttachment(null)}\n          data-testid=\"file-attachment-preview-overlay\"\n        >\n          <motion.div \n            initial={{ opacity: 0, scale: 0.95, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: 20 }}\n            transition={{ duration: 0.25, ease: \"easeOut\" }}\n            className=\"relative bg-card rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            {/* Header */}\n            <div className=\"flex items-center justify-between px-6 py-4 border-b border-border\">\n              <div className=\"flex items-center gap-3\">\n                {(() => {\n                  const attTheme = getFileTheme(previewFileAttachment.name, previewFileAttachment.mimeType);\n                  return (\n                    <motion.div \n                      initial={{ scale: 0.8 }}\n                      animate={{ scale: 1 }}\n                      transition={{ delay: 0.1, duration: 0.2 }}\n                      className={cn(\n                        \"flex items-center justify-center w-10 h-10 rounded-lg\",\n                        attTheme.bgColor\n                      )}\n                    >\n                      <span className=\"text-white text-sm font-bold\">\n                        {attTheme.icon}\n                      </span>\n                    </motion.div>\n                  );\n                })()}\n                <div>\n                  <h3 className=\"font-semibold text-lg text-foreground truncate max-w-md\" data-testid=\"preview-file-name\">\n                    {previewFileAttachment.name}\n                  </h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {previewFileAttachment.mimeType || \"Archivo\"}\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {previewFileAttachment.content && !previewFileAttachment.isLoading && !previewFileAttachment.isProcessing && (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={handleCopyAttachmentContent}\n                        data-testid=\"button-copy-attachment-content\"\n                      >\n                        {copiedAttachmentContent ? (\n                          <>\n                            <Check className=\"h-4 w-4 mr-2 text-green-500\" />\n                            Copiado\n                          </>\n                        ) : (\n                          <>\n                            <Copy className=\"h-4 w-4 mr-2\" />\n                            Copiar\n                          </>\n                        )}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>Copiar contenido al portapapeles</TooltipContent>\n                  </Tooltip>\n                )}\n                {previewFileAttachment.storagePath && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleDownloadFileAttachment}\n                    data-testid=\"button-download-attachment\"\n                  >\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Descargar\n                  </Button>\n                )}\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setPreviewFileAttachment(null)}\n                  data-testid=\"button-close-attachment-preview\"\n                >\n                  <X className=\"h-5 w-5\" />\n                </Button>\n              </div>\n            </div>\n            \n            {/* Content */}\n            <div className=\"flex-1 overflow-auto p-6\">\n              {previewFileAttachment.isLoading ? (\n                <motion.div \n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  className=\"flex items-center justify-center h-64\"\n                >\n                  <div className=\"flex flex-col items-center gap-3\">\n                    <motion.div\n                      animate={{ rotate: 360 }}\n                      transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n                    >\n                      <Loader2 className=\"h-8 w-8 text-primary\" />\n                    </motion.div>\n                    <motion.p \n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: 0.2 }}\n                      className=\"text-muted-foreground\"\n                    >\n                      Cargando contenido...\n                    </motion.p>\n                  </div>\n                </motion.div>\n              ) : previewFileAttachment.isProcessing ? (\n                <motion.div \n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  className=\"flex items-center justify-center h-64\"\n                >\n                  <div className=\"flex flex-col items-center gap-4 p-6 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-800\">\n                    <motion.div\n                      animate={{ \n                        scale: [1, 1.1, 1],\n                        rotate: [0, 5, -5, 0]\n                      }}\n                      transition={{ duration: 2, repeat: Infinity, ease: \"easeInOut\" }}\n                    >\n                      <RefreshCw className=\"h-10 w-10 text-amber-600 dark:text-amber-400\" />\n                    </motion.div>\n                    <div className=\"text-center\">\n                      <p className=\"font-medium text-amber-800 dark:text-amber-200\">\n                        Procesando archivo...\n                      </p>\n                      <p className=\"text-sm text-amber-600 dark:text-amber-400 mt-1\">\n                        El contenido estará disponible en breve\n                      </p>\n                    </div>\n                  </div>\n                </motion.div>\n              ) : previewFileAttachment.content ? (\n                <motion.div \n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.3 }}\n                  className=\"prose prose-sm dark:prose-invert max-w-none\"\n                >\n                  <div className=\"bg-muted/30 p-4 rounded-lg overflow-auto max-h-[60vh]\">\n                    <MarkdownRenderer content={previewFileAttachment.content} />\n                  </div>\n                </motion.div>\n              ) : (\n                <motion.div \n                  initial={{ opacity: 0, scale: 0.95 }}\n                  animate={{ opacity: 1, scale: 1 }}\n                  transition={{ duration: 0.3 }}\n                  className=\"flex flex-col items-center justify-center h-64 text-center\"\n                >\n                  <FileText className=\"h-16 w-16 text-muted-foreground/50 mb-4\" />\n                  <p className=\"text-muted-foreground\">\n                    La vista previa no está disponible para este tipo de archivo.\n                  </p>\n                  {previewFileAttachment.storagePath && (\n                    <Button\n                      variant=\"outline\"\n                      className=\"mt-4\"\n                      onClick={handleDownloadFileAttachment}\n                    >\n                      <Download className=\"h-4 w-4 mr-2\" />\n                      Descargar archivo\n                    </Button>\n                  )}\n                </motion.div>\n              )}\n            </div>\n          </motion.div>\n        </motion.div>\n      )}\n\n      {/* Uploaded Image Preview Modal */}\n      {previewUploadedImage && (\n        <motion.div \n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          className=\"fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4\"\n          onClick={() => setPreviewUploadedImage(null)}\n        >\n          <motion.div \n            initial={{ scale: 0.9, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            exit={{ scale: 0.9, opacity: 0 }}\n            className=\"relative max-w-4xl max-h-[90vh] rounded-lg overflow-hidden\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <img \n              src={previewUploadedImage.dataUrl} \n              alt={previewUploadedImage.name}\n              className=\"max-w-full max-h-[90vh] object-contain\"\n            />\n            <button\n              onClick={() => setPreviewUploadedImage(null)}\n              className=\"absolute top-3 right-3 w-8 h-8 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-colors\"\n              data-testid=\"button-close-image-preview\"\n            >\n              <X className=\"h-5 w-5\" />\n            </button>\n            <div className=\"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4\">\n              <p className=\"text-white text-sm truncate\">{previewUploadedImage.name}</p>\n            </div>\n          </motion.div>\n        </motion.div>\n      )}\n\n    </div>\n  );\n}\n\nfunction BotIcon({ className }: { className?: string }) {\n  return (\n    <svg \n      viewBox=\"0 0 24 24\" \n      fill=\"none\" \n      stroke=\"currentColor\" \n      strokeWidth=\"2\" \n      strokeLinecap=\"round\" \n      strokeLinejoin=\"round\" \n      className={className}\n    >\n      <path d=\"M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z\" />\n    </svg>\n  );\n}\n","path":null,"size_bytes":118684,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    data-testid=\"tabs-list\"\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, value, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    value={value}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow\",\n      className\n    )}\n    data-testid={`tabs-trigger-${value}`}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\ninterface TabsContentLoadingProps {\n  className?: string\n}\n\nconst TabsContentLoading: React.FC<TabsContentLoadingProps> = ({ className }) => (\n  <div \n    className={cn(\"mt-2 space-y-3\", className)} \n    data-testid=\"tabs-content-loading\"\n  >\n    <Skeleton className=\"h-4 w-3/4\" />\n    <Skeleton className=\"h-4 w-1/2\" />\n    <Skeleton className=\"h-4 w-2/3\" />\n  </div>\n)\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, value, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    value={value}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    data-testid={`tabs-content-${value}`}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\ninterface LazyTabsContentProps\n  extends React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content> {\n  loadingFallback?: React.ReactNode\n}\n\nfunction LazyTabsContentInner({ \n  value, \n  children, \n  loadingFallback \n}: { \n  value: string\n  children: React.ReactNode\n  loadingFallback?: React.ReactNode \n}) {\n  const [hasBeenActive, setHasBeenActive] = React.useState(false)\n  const containerRef = React.useRef<HTMLDivElement>(null)\n  \n  React.useLayoutEffect(() => {\n    const container = containerRef.current\n    if (!container) return\n    \n    const parentContent = container.closest('[data-state]')\n    if (parentContent?.getAttribute('data-state') === 'active') {\n      setHasBeenActive(true)\n    }\n  }, [])\n  \n  React.useEffect(() => {\n    const container = containerRef.current\n    if (!container) return\n    \n    const parentContent = container.closest('[data-state]')\n    if (!parentContent) return\n    \n    const observer = new MutationObserver(() => {\n      if (parentContent.getAttribute('data-state') === 'active' && !hasBeenActive) {\n        setHasBeenActive(true)\n      }\n    })\n    \n    observer.observe(parentContent, { attributes: true, attributeFilter: ['data-state'] })\n    return () => observer.disconnect()\n  }, [hasBeenActive])\n  \n  const fallback = loadingFallback || <TabsContentLoading />\n  \n  return (\n    <div ref={containerRef} data-lazy-content={value} data-mounted={hasBeenActive}>\n      {hasBeenActive ? children : fallback}\n    </div>\n  )\n}\n\nconst LazyTabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  LazyTabsContentProps\n>(({ className, value, children, loadingFallback, ...props }, ref) => {\n  return (\n    <TabsPrimitive.Content\n      ref={ref}\n      value={value}\n      className={cn(\n        \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n        className\n      )}\n      data-testid={`lazy-tabs-content-${value}`}\n      forceMount\n      {...props}\n    >\n      <LazyTabsContentInner value={value || ''} loadingFallback={loadingFallback}>\n        {children}\n      </LazyTabsContentInner>\n    </TabsPrimitive.Content>\n  )\n})\nLazyTabsContent.displayName = \"LazyTabsContent\"\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent, LazyTabsContent, TabsContentLoading }\n","path":null,"size_bytes":4730,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-primary/10\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":266,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type User, type InsertUser, \n  type File, type InsertFile, \n  type FileChunk, type InsertFileChunk,\n  type FileJob, type InsertFileJob,\n  type AgentRun, type InsertAgentRun,\n  type AgentStep, type InsertAgentStep,\n  type AgentAsset, type InsertAgentAsset,\n  type DomainPolicy, type InsertDomainPolicy,\n  type Chat, type InsertChat,\n  type ChatMessage, type InsertChatMessage,\n  type ChatShare, type InsertChatShare,\n  type Gpt, type InsertGpt,\n  type GptCategory, type InsertGptCategory,\n  type GptVersion, type InsertGptVersion,\n  type AiModel, type InsertAiModel,\n  type Payment, type InsertPayment,\n  type Invoice, type InsertInvoice,\n  type PlatformSetting, type InsertPlatformSetting,\n  type AuditLog, type InsertAuditLog,\n  type AnalyticsSnapshot, type InsertAnalyticsSnapshot,\n  type Report, type InsertReport,\n  type LibraryItem, type InsertLibraryItem,\n  type NotificationEventType, type NotificationPreference, type InsertNotificationPreference,\n  type UserSettings, type InsertUserSettings,\n  type IntegrationProvider, type InsertIntegrationProvider,\n  type IntegrationAccount, type InsertIntegrationAccount,\n  type IntegrationTool, type InsertIntegrationTool,\n  type IntegrationPolicy, type InsertIntegrationPolicy,\n  type ToolCallLog, type InsertToolCallLog,\n  type ConsentLog, type SharedLink, type InsertSharedLink,\n  files, fileChunks, fileJobs, agentRuns, agentSteps, agentAssets, domainPolicies, chats, chatMessages, chatShares,\n  gpts, gptCategories, gptVersions, users,\n  aiModels, payments, invoices, platformSettings, auditLogs, analyticsSnapshots, reports, libraryItems,\n  notificationEventTypes, notificationPreferences, userSettings,\n  integrationProviders, integrationAccounts, integrationTools, integrationPolicies, toolCallLogs,\n  consentLogs, sharedLinks\n} from \"@shared/schema\";\nimport crypto, { randomUUID } from \"crypto\";\nimport { db } from \"./db\";\nimport { eq, sql, desc, and, isNull } from \"drizzle-orm\";\n\nexport interface IStorage {\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  createFile(file: InsertFile): Promise<File>;\n  getFile(id: string): Promise<File | undefined>;\n  getFiles(userId?: string): Promise<File[]>;\n  updateFileStatus(id: string, status: string): Promise<File | undefined>;\n  deleteFile(id: string): Promise<void>;\n  updateFileProgress(id: string, progress: number): Promise<File | undefined>;\n  updateFileError(id: string, error: string): Promise<File | undefined>;\n  updateFileCompleted(id: string): Promise<File | undefined>;\n  updateFileUploadChunks(id: string, uploadedChunks: number, totalChunks: number): Promise<File | undefined>;\n  createFileJob(job: InsertFileJob): Promise<FileJob>;\n  getFileJob(fileId: string): Promise<FileJob | undefined>;\n  updateFileJobStatus(fileId: string, status: string, error?: string): Promise<FileJob | undefined>;\n  createFileChunks(chunks: InsertFileChunk[]): Promise<FileChunk[]>;\n  getFileChunks(fileId: string): Promise<FileChunk[]>;\n  searchSimilarChunks(embedding: number[], limit?: number): Promise<FileChunk[]>;\n  updateFileChunkEmbedding(fileId: string, chunkIndex: number, embedding: number[]): Promise<void>;\n  // Agent CRUD operations\n  createAgentRun(run: InsertAgentRun): Promise<AgentRun>;\n  getAgentRun(id: string): Promise<AgentRun | undefined>;\n  updateAgentRunStatus(id: string, status: string, error?: string): Promise<AgentRun | undefined>;\n  createAgentStep(step: InsertAgentStep): Promise<AgentStep>;\n  getAgentSteps(runId: string): Promise<AgentStep[]>;\n  updateAgentStepStatus(id: string, success: string, error?: string): Promise<AgentStep | undefined>;\n  createAgentAsset(asset: InsertAgentAsset): Promise<AgentAsset>;\n  getAgentAssets(runId: string): Promise<AgentAsset[]>;\n  getDomainPolicy(domain: string): Promise<DomainPolicy | undefined>;\n  createDomainPolicy(policy: InsertDomainPolicy): Promise<DomainPolicy>;\n  // Chat CRUD operations\n  createChat(chat: InsertChat): Promise<Chat>;\n  getChat(id: string): Promise<Chat | undefined>;\n  getChats(userId?: string): Promise<Chat[]>;\n  updateChat(id: string, updates: Partial<InsertChat>): Promise<Chat | undefined>;\n  deleteChat(id: string): Promise<void>;\n  createChatMessage(message: InsertChatMessage): Promise<ChatMessage>;\n  getChatMessages(chatId: string): Promise<ChatMessage[]>;\n  // Chat Share operations\n  createChatShare(share: InsertChatShare): Promise<ChatShare>;\n  getChatShares(chatId: string): Promise<ChatShare[]>;\n  getChatSharesByEmail(email: string): Promise<ChatShare[]>;\n  getChatSharesByUserId(userId: string): Promise<ChatShare[]>;\n  getSharedChatsWithDetails(userId: string): Promise<(Chat & { shareRole: string; shareId: string })[]>;\n  getChatShareByEmailAndChat(email: string, chatId: string): Promise<ChatShare | undefined>;\n  getChatShareByUserAndChat(userId: string, chatId: string): Promise<ChatShare | undefined>;\n  updateChatShare(id: string, updates: Partial<InsertChatShare>): Promise<ChatShare | undefined>;\n  deleteChatShare(id: string): Promise<void>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  // GPT CRUD operations\n  createGpt(gpt: InsertGpt): Promise<Gpt>;\n  getGpt(id: string): Promise<Gpt | undefined>;\n  getGptBySlug(slug: string): Promise<Gpt | undefined>;\n  getGpts(filters?: { visibility?: string; categoryId?: string; creatorId?: string }): Promise<Gpt[]>;\n  getPopularGpts(limit?: number): Promise<Gpt[]>;\n  updateGpt(id: string, updates: Partial<InsertGpt>): Promise<Gpt | undefined>;\n  deleteGpt(id: string): Promise<void>;\n  incrementGptUsage(id: string): Promise<void>;\n  // GPT Category operations\n  createGptCategory(category: InsertGptCategory): Promise<GptCategory>;\n  getGptCategories(): Promise<GptCategory[]>;\n  // GPT Version operations\n  createGptVersion(version: InsertGptVersion): Promise<GptVersion>;\n  getGptVersions(gptId: string): Promise<GptVersion[]>;\n  getLatestGptVersion(gptId: string): Promise<GptVersion | undefined>;\n  // Admin: User management\n  getAllUsers(): Promise<User[]>;\n  updateUser(id: string, updates: Partial<User>): Promise<User | undefined>;\n  deleteUser(id: string): Promise<void>;\n  getUserStats(): Promise<{ total: number; active: number; newThisMonth: number }>;\n  // Admin: AI Models\n  createAiModel(model: InsertAiModel): Promise<AiModel>;\n  getAiModels(): Promise<AiModel[]>;\n  updateAiModel(id: string, updates: Partial<InsertAiModel>): Promise<AiModel | undefined>;\n  deleteAiModel(id: string): Promise<void>;\n  // Admin: Payments\n  createPayment(payment: InsertPayment): Promise<Payment>;\n  getPayments(): Promise<Payment[]>;\n  updatePayment(id: string, updates: Partial<InsertPayment>): Promise<Payment | undefined>;\n  getPaymentStats(): Promise<{ total: string; thisMonth: string; count: number }>;\n  // Admin: Invoices\n  createInvoice(invoice: InsertInvoice): Promise<Invoice>;\n  getInvoices(): Promise<Invoice[]>;\n  updateInvoice(id: string, updates: Partial<InsertInvoice>): Promise<Invoice | undefined>;\n  // Admin: Settings\n  getSetting(key: string): Promise<PlatformSetting | undefined>;\n  getSettings(): Promise<PlatformSetting[]>;\n  upsertSetting(key: string, value: string, description?: string, category?: string): Promise<PlatformSetting>;\n  // Admin: Audit Logs\n  createAuditLog(log: InsertAuditLog): Promise<AuditLog>;\n  getAuditLogs(limit?: number): Promise<AuditLog[]>;\n  // Admin: Analytics\n  createAnalyticsSnapshot(snapshot: InsertAnalyticsSnapshot): Promise<AnalyticsSnapshot>;\n  getAnalyticsSnapshots(days?: number): Promise<AnalyticsSnapshot[]>;\n  getDashboardMetrics(): Promise<{ users: number; queries: number; revenue: string; uptime: number }>;\n  // Admin: Reports\n  createReport(report: InsertReport): Promise<Report>;\n  getReports(): Promise<Report[]>;\n  updateReport(id: string, updates: Partial<InsertReport>): Promise<Report | undefined>;\n  // Admin: Domain Policies\n  getDomainPolicies(): Promise<DomainPolicy[]>;\n  updateDomainPolicy(id: string, updates: Partial<InsertDomainPolicy>): Promise<DomainPolicy | undefined>;\n  deleteDomainPolicy(id: string): Promise<void>;\n  // Library Items CRUD\n  createLibraryItem(item: InsertLibraryItem): Promise<LibraryItem>;\n  getLibraryItems(userId: string, mediaType?: string): Promise<LibraryItem[]>;\n  getLibraryItem(id: string, userId: string): Promise<LibraryItem | null>;\n  deleteLibraryItem(id: string, userId: string): Promise<boolean>;\n  // Notification Preferences\n  getNotificationEventTypes(): Promise<NotificationEventType[]>;\n  getNotificationPreferences(userId: string): Promise<NotificationPreference[]>;\n  upsertNotificationPreference(pref: InsertNotificationPreference): Promise<NotificationPreference>;\n  // User Settings\n  getUserSettings(userId: string): Promise<UserSettings | null>;\n  upsertUserSettings(userId: string, settings: Partial<InsertUserSettings>): Promise<UserSettings>;\n  // Integration Management\n  getIntegrationProviders(): Promise<IntegrationProvider[]>;\n  getIntegrationProvider(id: string): Promise<IntegrationProvider | null>;\n  getIntegrationAccounts(userId: string): Promise<IntegrationAccount[]>;\n  getIntegrationAccount(id: string): Promise<IntegrationAccount | null>;\n  getIntegrationAccountByProvider(userId: string, providerId: string): Promise<IntegrationAccount | null>;\n  createIntegrationAccount(account: InsertIntegrationAccount): Promise<IntegrationAccount>;\n  updateIntegrationAccount(id: string, updates: Partial<InsertIntegrationAccount>): Promise<IntegrationAccount | null>;\n  deleteIntegrationAccount(id: string): Promise<void>;\n  getIntegrationTools(providerId?: string): Promise<IntegrationTool[]>;\n  getIntegrationPolicy(userId: string): Promise<IntegrationPolicy | null>;\n  upsertIntegrationPolicy(userId: string, policy: Partial<InsertIntegrationPolicy>): Promise<IntegrationPolicy>;\n  createToolCallLog(log: InsertToolCallLog): Promise<ToolCallLog>;\n  getToolCallLogs(userId: string, limit?: number): Promise<ToolCallLog[]>;\n  // Consent Logs\n  logConsent(userId: string, consentType: string, value: string, ipAddress?: string, userAgent?: string): Promise<void>;\n  getConsentLogs(userId: string, limit?: number): Promise<ConsentLog[]>;\n  // Shared Links CRUD\n  createSharedLink(data: InsertSharedLink): Promise<SharedLink>;\n  getSharedLinks(userId: string): Promise<SharedLink[]>;\n  getSharedLinkByToken(token: string): Promise<SharedLink | undefined>;\n  updateSharedLink(id: string, data: Partial<InsertSharedLink>): Promise<SharedLink>;\n  revokeSharedLink(id: string): Promise<void>;\n  rotateSharedLinkToken(id: string): Promise<SharedLink>;\n  incrementSharedLinkAccess(id: string): Promise<void>;\n  // Archived/Deleted Chats\n  getArchivedChats(userId: string): Promise<Chat[]>;\n  unarchiveChat(chatId: string): Promise<void>;\n  archiveAllChats(userId: string): Promise<number>;\n  softDeleteChat(chatId: string): Promise<void>;\n  softDeleteAllChats(userId: string): Promise<number>;\n  getDeletedChats(userId: string): Promise<Chat[]>;\n  restoreDeletedChat(chatId: string): Promise<void>;\n  permanentlyDeleteChat(chatId: string): Promise<void>;\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User>;\n\n  constructor() {\n    this.users = new Map();\n  }\n\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(\n      (user) => user.username === username,\n    );\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const [user] = await db.insert(users).values(insertUser).returning();\n    return user;\n  }\n\n  async createFile(insertFile: InsertFile): Promise<File> {\n    const [file] = await db.insert(files).values(insertFile).returning();\n    return file;\n  }\n\n  async getFile(id: string): Promise<File | undefined> {\n    const [file] = await db.select().from(files).where(eq(files.id, id));\n    return file;\n  }\n\n  async getFiles(userId?: string): Promise<File[]> {\n    if (userId) {\n      return db.select().from(files).where(eq(files.userId, userId)).orderBy(desc(files.createdAt));\n    }\n    return db.select().from(files).orderBy(desc(files.createdAt));\n  }\n\n  async updateFileStatus(id: string, status: string): Promise<File | undefined> {\n    const [file] = await db.update(files).set({ status }).where(eq(files.id, id)).returning();\n    return file;\n  }\n\n  async deleteFile(id: string): Promise<void> {\n    await db.delete(files).where(eq(files.id, id));\n  }\n\n  async updateFileProgress(id: string, progress: number): Promise<File | undefined> {\n    const [file] = await db.update(files).set({ processingProgress: progress }).where(eq(files.id, id)).returning();\n    return file;\n  }\n\n  async updateFileError(id: string, error: string): Promise<File | undefined> {\n    const [file] = await db.update(files).set({ processingError: error, status: \"failed\" }).where(eq(files.id, id)).returning();\n    return file;\n  }\n\n  async updateFileCompleted(id: string): Promise<File | undefined> {\n    const [file] = await db.update(files).set({ \n      status: \"completed\", \n      processingProgress: 100, \n      completedAt: new Date() \n    }).where(eq(files.id, id)).returning();\n    return file;\n  }\n\n  async updateFileUploadChunks(id: string, uploadedChunks: number, totalChunks: number): Promise<File | undefined> {\n    const [file] = await db.update(files).set({ \n      uploadedChunks, \n      totalChunks \n    }).where(eq(files.id, id)).returning();\n    return file;\n  }\n\n  async createFileJob(job: InsertFileJob): Promise<FileJob> {\n    const [result] = await db.insert(fileJobs).values(job).returning();\n    return result;\n  }\n\n  async getFileJob(fileId: string): Promise<FileJob | undefined> {\n    const [result] = await db.select().from(fileJobs).where(eq(fileJobs.fileId, fileId));\n    return result;\n  }\n\n  async updateFileJobStatus(fileId: string, status: string, error?: string): Promise<FileJob | undefined> {\n    const updates: Partial<FileJob> = { status };\n    if (status === \"processing\") {\n      updates.startedAt = new Date();\n    }\n    if (status === \"completed\" || status === \"failed\") {\n      updates.completedAt = new Date();\n    }\n    if (error) {\n      updates.lastError = error;\n      updates.retries = sql`${fileJobs.retries} + 1` as any;\n    }\n    const [result] = await db.update(fileJobs).set(updates).where(eq(fileJobs.fileId, fileId)).returning();\n    return result;\n  }\n\n  async createFileChunks(chunks: InsertFileChunk[]): Promise<FileChunk[]> {\n    if (chunks.length === 0) return [];\n    const result = await db.insert(fileChunks).values(chunks).returning();\n    return result;\n  }\n\n  async getFileChunks(fileId: string): Promise<FileChunk[]> {\n    return db.select().from(fileChunks).where(eq(fileChunks.fileId, fileId));\n  }\n\n  async searchSimilarChunks(embedding: number[], limit: number = 5): Promise<FileChunk[]> {\n    const embeddingStr = `[${embedding.join(\",\")}]`;\n    const result = await db.execute(sql`\n      SELECT fc.*, f.name as file_name,\n        fc.embedding <=> ${embeddingStr}::vector AS distance\n      FROM file_chunks fc\n      JOIN files f ON fc.file_id = f.id\n      WHERE fc.embedding IS NOT NULL\n      ORDER BY fc.embedding <=> ${embeddingStr}::vector\n      LIMIT ${limit}\n    `);\n    return result.rows as FileChunk[];\n  }\n\n  async updateFileChunkEmbedding(fileId: string, chunkIndex: number, embedding: number[]): Promise<void> {\n    await db.update(fileChunks)\n      .set({ embedding })\n      .where(and(eq(fileChunks.fileId, fileId), eq(fileChunks.chunkIndex, chunkIndex)));\n  }\n\n  async createAgentRun(run: InsertAgentRun): Promise<AgentRun> {\n    const [result] = await db.insert(agentRuns).values(run).returning();\n    return result;\n  }\n\n  async getAgentRun(id: string): Promise<AgentRun | undefined> {\n    const [result] = await db.select().from(agentRuns).where(eq(agentRuns.id, id));\n    return result;\n  }\n\n  async updateAgentRunStatus(id: string, status: string, error?: string): Promise<AgentRun | undefined> {\n    const updates: Partial<AgentRun> = { status };\n    if (status === \"completed\" || status === \"failed\" || status === \"cancelled\") {\n      updates.completedAt = new Date();\n    }\n    if (error) {\n      updates.error = error;\n    }\n    const [result] = await db.update(agentRuns).set(updates).where(eq(agentRuns.id, id)).returning();\n    return result;\n  }\n\n  async createAgentStep(step: InsertAgentStep): Promise<AgentStep> {\n    const [result] = await db.insert(agentSteps).values(step).returning();\n    return result;\n  }\n\n  async getAgentSteps(runId: string): Promise<AgentStep[]> {\n    return db.select().from(agentSteps).where(eq(agentSteps.runId, runId)).orderBy(agentSteps.stepIndex);\n  }\n\n  async updateAgentStepStatus(id: string, success: string, error?: string): Promise<AgentStep | undefined> {\n    const updates: Partial<AgentStep> = { success, completedAt: new Date() };\n    if (error) {\n      updates.error = error;\n    }\n    const [result] = await db.update(agentSteps).set(updates).where(eq(agentSteps.id, id)).returning();\n    return result;\n  }\n\n  async createAgentAsset(asset: InsertAgentAsset): Promise<AgentAsset> {\n    const [result] = await db.insert(agentAssets).values(asset).returning();\n    return result;\n  }\n\n  async getAgentAssets(runId: string): Promise<AgentAsset[]> {\n    return db.select().from(agentAssets).where(eq(agentAssets.runId, runId));\n  }\n\n  async getDomainPolicy(domain: string): Promise<DomainPolicy | undefined> {\n    const [result] = await db.select().from(domainPolicies).where(eq(domainPolicies.domain, domain));\n    return result;\n  }\n\n  async createDomainPolicy(policy: InsertDomainPolicy): Promise<DomainPolicy> {\n    const [result] = await db.insert(domainPolicies).values(policy).returning();\n    return result;\n  }\n\n  async createChat(chat: InsertChat): Promise<Chat> {\n    const [result] = await db.insert(chats).values(chat).returning();\n    return result;\n  }\n\n  async getChat(id: string): Promise<Chat | undefined> {\n    const [result] = await db.select().from(chats).where(eq(chats.id, id));\n    return result;\n  }\n\n  async getChats(userId?: string): Promise<Chat[]> {\n    if (userId) {\n      return db.select().from(chats).where(eq(chats.userId, userId)).orderBy(desc(chats.updatedAt));\n    }\n    return db.select().from(chats).orderBy(desc(chats.updatedAt));\n  }\n\n  async updateChat(id: string, updates: Partial<InsertChat>): Promise<Chat | undefined> {\n    const [result] = await db.update(chats).set({ ...updates, updatedAt: new Date() }).where(eq(chats.id, id)).returning();\n    return result;\n  }\n\n  async deleteChat(id: string): Promise<void> {\n    await db.delete(chats).where(eq(chats.id, id));\n  }\n\n  async createChatMessage(message: InsertChatMessage): Promise<ChatMessage> {\n    const [result] = await db.insert(chatMessages).values(message).returning();\n    await db.update(chats).set({ updatedAt: new Date() }).where(eq(chats.id, message.chatId));\n    return result;\n  }\n\n  async getChatMessages(chatId: string): Promise<ChatMessage[]> {\n    return db.select().from(chatMessages).where(eq(chatMessages.chatId, chatId)).orderBy(chatMessages.createdAt);\n  }\n\n  // Chat Share operations\n  async createChatShare(share: InsertChatShare): Promise<ChatShare> {\n    const [result] = await db.insert(chatShares).values(share).returning();\n    return result;\n  }\n\n  async getChatShares(chatId: string): Promise<ChatShare[]> {\n    return db.select().from(chatShares).where(eq(chatShares.chatId, chatId)).orderBy(desc(chatShares.createdAt));\n  }\n\n  async getChatSharesByEmail(email: string): Promise<ChatShare[]> {\n    const normalizedEmail = email.toLowerCase().trim();\n    return db.select().from(chatShares).where(sql`LOWER(${chatShares.email}) = ${normalizedEmail}`).orderBy(desc(chatShares.createdAt));\n  }\n\n  async getChatSharesByUserId(userId: string): Promise<ChatShare[]> {\n    return db.select().from(chatShares).where(eq(chatShares.recipientUserId, userId)).orderBy(desc(chatShares.createdAt));\n  }\n\n  async getSharedChatsWithDetails(userId: string): Promise<(Chat & { shareRole: string; shareId: string })[]> {\n    const results = await db\n      .select({\n        id: chats.id,\n        title: chats.title,\n        userId: chats.userId,\n        gptId: chats.gptId,\n        archived: chats.archived,\n        hidden: chats.hidden,\n        deletedAt: chats.deletedAt,\n        createdAt: chats.createdAt,\n        updatedAt: chats.updatedAt,\n        shareRole: chatShares.role,\n        shareId: chatShares.id,\n      })\n      .from(chatShares)\n      .innerJoin(chats, eq(chatShares.chatId, chats.id))\n      .where(eq(chatShares.recipientUserId, userId))\n      .orderBy(desc(chatShares.createdAt));\n    \n    return results as (Chat & { shareRole: string; shareId: string })[];\n  }\n\n  async getChatShareByEmailAndChat(email: string, chatId: string): Promise<ChatShare | undefined> {\n    const normalizedEmail = email.toLowerCase().trim();\n    const [result] = await db.select().from(chatShares)\n      .where(sql`LOWER(${chatShares.email}) = ${normalizedEmail} AND ${chatShares.chatId} = ${chatId}`);\n    return result;\n  }\n\n  async getChatShareByUserAndChat(userId: string, chatId: string): Promise<ChatShare | undefined> {\n    const [result] = await db.select().from(chatShares)\n      .where(sql`${chatShares.recipientUserId} = ${userId} AND ${chatShares.chatId} = ${chatId}`);\n    return result;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const normalizedEmail = email.toLowerCase().trim();\n    const [result] = await db.select().from(users).where(sql`LOWER(${users.email}) = ${normalizedEmail}`);\n    return result;\n  }\n\n  async updateChatShare(id: string, updates: Partial<InsertChatShare>): Promise<ChatShare | undefined> {\n    const [result] = await db.update(chatShares).set(updates).where(eq(chatShares.id, id)).returning();\n    return result;\n  }\n\n  async deleteChatShare(id: string): Promise<void> {\n    await db.delete(chatShares).where(eq(chatShares.id, id));\n  }\n\n  // GPT operations\n  async createGpt(gpt: InsertGpt): Promise<Gpt> {\n    const [result] = await db.insert(gpts).values(gpt).returning();\n    return result;\n  }\n\n  async getGpt(id: string): Promise<Gpt | undefined> {\n    const [result] = await db.select().from(gpts).where(eq(gpts.id, id));\n    return result;\n  }\n\n  async getGptBySlug(slug: string): Promise<Gpt | undefined> {\n    const [result] = await db.select().from(gpts).where(eq(gpts.slug, slug));\n    return result;\n  }\n\n  async getGpts(filters?: { visibility?: string; categoryId?: string; creatorId?: string }): Promise<Gpt[]> {\n    let query = db.select().from(gpts);\n    if (filters?.visibility) {\n      query = query.where(eq(gpts.visibility, filters.visibility)) as typeof query;\n    }\n    if (filters?.categoryId) {\n      query = query.where(eq(gpts.categoryId, filters.categoryId)) as typeof query;\n    }\n    if (filters?.creatorId) {\n      query = query.where(eq(gpts.creatorId, filters.creatorId)) as typeof query;\n    }\n    return query.orderBy(desc(gpts.createdAt));\n  }\n\n  async getPopularGpts(limit: number = 10): Promise<Gpt[]> {\n    return db.select().from(gpts)\n      .where(eq(gpts.visibility, \"public\"))\n      .orderBy(desc(gpts.usageCount))\n      .limit(limit);\n  }\n\n  async updateGpt(id: string, updates: Partial<InsertGpt>): Promise<Gpt | undefined> {\n    const [result] = await db.update(gpts).set({ ...updates, updatedAt: new Date() }).where(eq(gpts.id, id)).returning();\n    return result;\n  }\n\n  async deleteGpt(id: string): Promise<void> {\n    await db.delete(gpts).where(eq(gpts.id, id));\n  }\n\n  async incrementGptUsage(id: string): Promise<void> {\n    await db.update(gpts).set({ usageCount: sql`${gpts.usageCount} + 1` }).where(eq(gpts.id, id));\n  }\n\n  // GPT Category operations\n  async createGptCategory(category: InsertGptCategory): Promise<GptCategory> {\n    const [result] = await db.insert(gptCategories).values(category).returning();\n    return result;\n  }\n\n  async getGptCategories(): Promise<GptCategory[]> {\n    return db.select().from(gptCategories).orderBy(gptCategories.sortOrder);\n  }\n\n  // GPT Version operations\n  async createGptVersion(version: InsertGptVersion): Promise<GptVersion> {\n    const [result] = await db.insert(gptVersions).values(version).returning();\n    return result;\n  }\n\n  async getGptVersions(gptId: string): Promise<GptVersion[]> {\n    return db.select().from(gptVersions).where(eq(gptVersions.gptId, gptId)).orderBy(desc(gptVersions.versionNumber));\n  }\n\n  async getLatestGptVersion(gptId: string): Promise<GptVersion | undefined> {\n    const [result] = await db.select().from(gptVersions)\n      .where(eq(gptVersions.gptId, gptId))\n      .orderBy(desc(gptVersions.versionNumber))\n      .limit(1);\n    return result;\n  }\n\n  // Admin: User management\n  async getAllUsers(): Promise<User[]> {\n    return db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<User | undefined> {\n    const [result] = await db.update(users).set(updates).where(eq(users.id, id)).returning();\n    return result;\n  }\n\n  async deleteUser(id: string): Promise<void> {\n    await db.delete(users).where(eq(users.id, id));\n  }\n\n  async getUserStats(): Promise<{ total: number; active: number; newThisMonth: number }> {\n    const allUsers = await db.select().from(users);\n    const now = new Date();\n    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n    const total = allUsers.length;\n    const active = allUsers.filter(u => u.status === \"active\").length;\n    const newThisMonth = allUsers.filter(u => u.createdAt && u.createdAt >= monthStart).length;\n    return { total, active, newThisMonth };\n  }\n\n  // Admin: AI Models\n  async createAiModel(model: InsertAiModel): Promise<AiModel> {\n    const [result] = await db.insert(aiModels).values(model).returning();\n    return result;\n  }\n\n  async getAiModels(): Promise<AiModel[]> {\n    return db.select().from(aiModels).orderBy(desc(aiModels.createdAt));\n  }\n\n  async updateAiModel(id: string, updates: Partial<InsertAiModel>): Promise<AiModel | undefined> {\n    const [result] = await db.update(aiModels).set(updates).where(eq(aiModels.id, id)).returning();\n    return result;\n  }\n\n  async deleteAiModel(id: string): Promise<void> {\n    await db.delete(aiModels).where(eq(aiModels.id, id));\n  }\n\n  // Admin: Payments\n  async createPayment(payment: InsertPayment): Promise<Payment> {\n    const [result] = await db.insert(payments).values(payment).returning();\n    return result;\n  }\n\n  async getPayments(): Promise<Payment[]> {\n    return db.select().from(payments).orderBy(desc(payments.createdAt));\n  }\n\n  async updatePayment(id: string, updates: Partial<InsertPayment>): Promise<Payment | undefined> {\n    const [result] = await db.update(payments).set(updates).where(eq(payments.id, id)).returning();\n    return result;\n  }\n\n  async getPaymentStats(): Promise<{ total: string; thisMonth: string; count: number }> {\n    const allPayments = await db.select().from(payments);\n    const now = new Date();\n    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n    const completedPayments = allPayments.filter(p => p.status === \"completed\");\n    const thisMonthPayments = completedPayments.filter(p => p.createdAt >= monthStart);\n    const total = completedPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0);\n    const thisMonth = thisMonthPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0);\n    return { total: total.toFixed(2), thisMonth: thisMonth.toFixed(2), count: completedPayments.length };\n  }\n\n  // Admin: Invoices\n  async createInvoice(invoice: InsertInvoice): Promise<Invoice> {\n    const [result] = await db.insert(invoices).values(invoice).returning();\n    return result;\n  }\n\n  async getInvoices(): Promise<Invoice[]> {\n    return db.select().from(invoices).orderBy(desc(invoices.createdAt));\n  }\n\n  async updateInvoice(id: string, updates: Partial<InsertInvoice>): Promise<Invoice | undefined> {\n    const [result] = await db.update(invoices).set(updates).where(eq(invoices.id, id)).returning();\n    return result;\n  }\n\n  // Admin: Settings\n  async getSetting(key: string): Promise<PlatformSetting | undefined> {\n    const [result] = await db.select().from(platformSettings).where(eq(platformSettings.key, key));\n    return result;\n  }\n\n  async getSettings(): Promise<PlatformSetting[]> {\n    return db.select().from(platformSettings).orderBy(platformSettings.category);\n  }\n\n  async upsertSetting(key: string, value: string, description?: string, category?: string): Promise<PlatformSetting> {\n    const existing = await this.getSetting(key);\n    if (existing) {\n      const [result] = await db.update(platformSettings)\n        .set({ value, description, category, updatedAt: new Date() })\n        .where(eq(platformSettings.key, key))\n        .returning();\n      return result;\n    }\n    const [result] = await db.insert(platformSettings)\n      .values({ key, value, description, category })\n      .returning();\n    return result;\n  }\n\n  // Admin: Audit Logs\n  async createAuditLog(log: InsertAuditLog): Promise<AuditLog> {\n    const [result] = await db.insert(auditLogs).values(log).returning();\n    return result;\n  }\n\n  async getAuditLogs(limit: number = 100): Promise<AuditLog[]> {\n    return db.select().from(auditLogs).orderBy(desc(auditLogs.createdAt)).limit(limit);\n  }\n\n  // Admin: Analytics\n  async createAnalyticsSnapshot(snapshot: InsertAnalyticsSnapshot): Promise<AnalyticsSnapshot> {\n    const [result] = await db.insert(analyticsSnapshots).values(snapshot).returning();\n    return result;\n  }\n\n  async getAnalyticsSnapshots(days: number = 30): Promise<AnalyticsSnapshot[]> {\n    const cutoff = new Date();\n    cutoff.setDate(cutoff.getDate() - days);\n    return db.select().from(analyticsSnapshots)\n      .where(sql`${analyticsSnapshots.date} >= ${cutoff}`)\n      .orderBy(analyticsSnapshots.date);\n  }\n\n  async getDashboardMetrics(): Promise<{ users: number; queries: number; revenue: string; uptime: number }> {\n    const userStats = await this.getUserStats();\n    const paymentStats = await this.getPaymentStats();\n    const allUsers = await db.select().from(users);\n    const totalQueries = allUsers.reduce((sum, u) => sum + (u.queryCount || 0), 0);\n    return {\n      users: userStats.total,\n      queries: totalQueries,\n      revenue: paymentStats.total,\n      uptime: 99.9\n    };\n  }\n\n  // Admin: Reports\n  async createReport(report: InsertReport): Promise<Report> {\n    const [result] = await db.insert(reports).values(report).returning();\n    return result;\n  }\n\n  async getReports(): Promise<Report[]> {\n    return db.select().from(reports).orderBy(desc(reports.createdAt));\n  }\n\n  async updateReport(id: string, updates: Partial<InsertReport>): Promise<Report | undefined> {\n    const [result] = await db.update(reports).set(updates).where(eq(reports.id, id)).returning();\n    return result;\n  }\n\n  // Admin: Domain Policies\n  async getDomainPolicies(): Promise<DomainPolicy[]> {\n    return db.select().from(domainPolicies).orderBy(desc(domainPolicies.createdAt));\n  }\n\n  async updateDomainPolicy(id: string, updates: Partial<InsertDomainPolicy>): Promise<DomainPolicy | undefined> {\n    const [result] = await db.update(domainPolicies).set(updates).where(eq(domainPolicies.id, id)).returning();\n    return result;\n  }\n\n  async deleteDomainPolicy(id: string): Promise<void> {\n    await db.delete(domainPolicies).where(eq(domainPolicies.id, id));\n  }\n\n  // Library Items CRUD\n  async createLibraryItem(item: InsertLibraryItem): Promise<LibraryItem> {\n    const [result] = await db.insert(libraryItems).values(item).returning();\n    return result;\n  }\n\n  async getLibraryItems(userId: string, mediaType?: string): Promise<LibraryItem[]> {\n    if (mediaType) {\n      return db.select().from(libraryItems)\n        .where(sql`${libraryItems.userId} = ${userId} AND ${libraryItems.mediaType} = ${mediaType}`)\n        .orderBy(desc(libraryItems.createdAt));\n    }\n    return db.select().from(libraryItems)\n      .where(eq(libraryItems.userId, userId))\n      .orderBy(desc(libraryItems.createdAt));\n  }\n\n  async getLibraryItem(id: string, userId: string): Promise<LibraryItem | null> {\n    const [result] = await db.select().from(libraryItems)\n      .where(sql`${libraryItems.id} = ${id} AND ${libraryItems.userId} = ${userId}`);\n    return result || null;\n  }\n\n  async deleteLibraryItem(id: string, userId: string): Promise<boolean> {\n    const result = await db.delete(libraryItems)\n      .where(sql`${libraryItems.id} = ${id} AND ${libraryItems.userId} = ${userId}`)\n      .returning();\n    return result.length > 0;\n  }\n\n  // Notification Preferences\n  async getNotificationEventTypes(): Promise<NotificationEventType[]> {\n    return db.select().from(notificationEventTypes).orderBy(notificationEventTypes.sortOrder);\n  }\n\n  async getNotificationPreferences(userId: string): Promise<NotificationPreference[]> {\n    return db.select().from(notificationPreferences).where(eq(notificationPreferences.userId, userId));\n  }\n\n  async upsertNotificationPreference(pref: InsertNotificationPreference): Promise<NotificationPreference> {\n    const existing = await db.select().from(notificationPreferences)\n      .where(sql`${notificationPreferences.userId} = ${pref.userId} AND ${notificationPreferences.eventTypeId} = ${pref.eventTypeId}`);\n    if (existing.length > 0) {\n      const [updated] = await db.update(notificationPreferences)\n        .set({ ...pref, updatedAt: new Date() })\n        .where(eq(notificationPreferences.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n    const [created] = await db.insert(notificationPreferences).values(pref).returning();\n    return created;\n  }\n\n  // User Settings\n  async getUserSettings(userId: string): Promise<UserSettings | null> {\n    const [result] = await db.select().from(userSettings).where(eq(userSettings.userId, userId));\n    return result || null;\n  }\n\n  async upsertUserSettings(userId: string, settings: Partial<InsertUserSettings>): Promise<UserSettings> {\n    const defaultFeatureFlags = {\n      memoryEnabled: true,\n      recordingHistoryEnabled: false,\n      webSearchAuto: true,\n      codeInterpreterEnabled: true,\n      canvasEnabled: true,\n      voiceEnabled: true,\n      voiceAdvanced: false,\n      connectorSearchAuto: false\n    };\n\n    const defaultResponsePreferences = {\n      responseStyle: 'default' as const,\n      responseTone: 'professional',\n      customInstructions: ''\n    };\n\n    const defaultUserProfile = {\n      nickname: '',\n      occupation: '',\n      bio: ''\n    };\n\n    const defaultPrivacySettings = {\n      trainingOptIn: false,\n      remoteBrowserDataAccess: false\n    };\n\n    const existing = await this.getUserSettings(userId);\n    \n    if (existing) {\n      const mergedSettings = {\n        responsePreferences: settings.responsePreferences \n          ? { ...existing.responsePreferences, ...settings.responsePreferences }\n          : existing.responsePreferences,\n        userProfile: settings.userProfile\n          ? { ...existing.userProfile, ...settings.userProfile }\n          : existing.userProfile,\n        featureFlags: settings.featureFlags\n          ? { ...existing.featureFlags, ...settings.featureFlags }\n          : existing.featureFlags,\n        privacySettings: settings.privacySettings\n          ? { ...existing.privacySettings, ...settings.privacySettings }\n          : existing.privacySettings,\n        updatedAt: new Date()\n      };\n      \n      const [updated] = await db.update(userSettings)\n        .set(mergedSettings)\n        .where(eq(userSettings.userId, userId))\n        .returning();\n      return updated;\n    }\n\n    const newSettings: InsertUserSettings = {\n      userId,\n      responsePreferences: settings.responsePreferences \n        ? { ...defaultResponsePreferences, ...settings.responsePreferences }\n        : defaultResponsePreferences,\n      userProfile: settings.userProfile\n        ? { ...defaultUserProfile, ...settings.userProfile }\n        : defaultUserProfile,\n      featureFlags: settings.featureFlags\n        ? { ...defaultFeatureFlags, ...settings.featureFlags }\n        : defaultFeatureFlags,\n      privacySettings: settings.privacySettings\n        ? { ...defaultPrivacySettings, ...settings.privacySettings }\n        : defaultPrivacySettings\n    };\n\n    const [created] = await db.insert(userSettings).values(newSettings).returning();\n    return created;\n  }\n\n  // Integration Management\n  async getIntegrationProviders(): Promise<IntegrationProvider[]> {\n    return db.select().from(integrationProviders).orderBy(integrationProviders.name);\n  }\n\n  async getIntegrationProvider(id: string): Promise<IntegrationProvider | null> {\n    const [result] = await db.select().from(integrationProviders).where(eq(integrationProviders.id, id));\n    return result || null;\n  }\n\n  async getIntegrationAccounts(userId: string): Promise<IntegrationAccount[]> {\n    return db.select().from(integrationAccounts)\n      .where(eq(integrationAccounts.userId, userId))\n      .orderBy(desc(integrationAccounts.createdAt));\n  }\n\n  async getIntegrationAccount(id: string): Promise<IntegrationAccount | null> {\n    const [result] = await db.select().from(integrationAccounts).where(eq(integrationAccounts.id, id));\n    return result || null;\n  }\n\n  async getIntegrationAccountByProvider(userId: string, providerId: string): Promise<IntegrationAccount | null> {\n    const [result] = await db.select().from(integrationAccounts)\n      .where(sql`${integrationAccounts.userId} = ${userId} AND ${integrationAccounts.providerId} = ${providerId}`);\n    return result || null;\n  }\n\n  async createIntegrationAccount(account: InsertIntegrationAccount): Promise<IntegrationAccount> {\n    const [result] = await db.insert(integrationAccounts).values(account).returning();\n    return result;\n  }\n\n  async updateIntegrationAccount(id: string, updates: Partial<InsertIntegrationAccount>): Promise<IntegrationAccount | null> {\n    const [result] = await db.update(integrationAccounts)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(integrationAccounts.id, id))\n      .returning();\n    return result || null;\n  }\n\n  async deleteIntegrationAccount(id: string): Promise<void> {\n    await db.delete(integrationAccounts).where(eq(integrationAccounts.id, id));\n  }\n\n  async getIntegrationTools(providerId?: string): Promise<IntegrationTool[]> {\n    if (providerId) {\n      return db.select().from(integrationTools)\n        .where(eq(integrationTools.providerId, providerId))\n        .orderBy(integrationTools.name);\n    }\n    return db.select().from(integrationTools).orderBy(integrationTools.name);\n  }\n\n  async getIntegrationPolicy(userId: string): Promise<IntegrationPolicy | null> {\n    const [result] = await db.select().from(integrationPolicies).where(eq(integrationPolicies.userId, userId));\n    return result || null;\n  }\n\n  async upsertIntegrationPolicy(userId: string, policy: Partial<InsertIntegrationPolicy>): Promise<IntegrationPolicy> {\n    const existing = await this.getIntegrationPolicy(userId);\n    \n    if (existing) {\n      const mergedPolicy = {\n        enabledApps: policy.enabledApps \n          ? Array.from(new Set([...(existing.enabledApps || []), ...policy.enabledApps]))\n          : existing.enabledApps,\n        enabledTools: policy.enabledTools\n          ? Array.from(new Set([...(existing.enabledTools || []), ...policy.enabledTools]))\n          : existing.enabledTools,\n        disabledTools: policy.disabledTools\n          ? Array.from(new Set([...(existing.disabledTools || []), ...policy.disabledTools]))\n          : existing.disabledTools,\n        resourceScopes: policy.resourceScopes ?? existing.resourceScopes,\n        autoConfirmPolicy: policy.autoConfirmPolicy ?? existing.autoConfirmPolicy,\n        sandboxMode: policy.sandboxMode ?? existing.sandboxMode,\n        maxParallelCalls: policy.maxParallelCalls ?? existing.maxParallelCalls,\n        updatedAt: new Date()\n      };\n      \n      const [updated] = await db.update(integrationPolicies)\n        .set(mergedPolicy)\n        .where(eq(integrationPolicies.userId, userId))\n        .returning();\n      return updated;\n    }\n\n    const newPolicy: InsertIntegrationPolicy = {\n      userId,\n      enabledApps: policy.enabledApps || [],\n      enabledTools: policy.enabledTools || [],\n      disabledTools: policy.disabledTools || [],\n      resourceScopes: policy.resourceScopes,\n      autoConfirmPolicy: policy.autoConfirmPolicy || 'ask',\n      sandboxMode: policy.sandboxMode || 'false',\n      maxParallelCalls: policy.maxParallelCalls || 3\n    };\n\n    const [created] = await db.insert(integrationPolicies).values(newPolicy).returning();\n    return created;\n  }\n\n  async createToolCallLog(log: InsertToolCallLog): Promise<ToolCallLog> {\n    const [result] = await db.insert(toolCallLogs).values(log).returning();\n    return result;\n  }\n\n  async getToolCallLogs(userId: string, limit: number = 100): Promise<ToolCallLog[]> {\n    return db.select().from(toolCallLogs)\n      .where(eq(toolCallLogs.userId, userId))\n      .orderBy(desc(toolCallLogs.createdAt))\n      .limit(limit);\n  }\n\n  // Consent Logs\n  async logConsent(userId: string, consentType: string, value: string, ipAddress?: string, userAgent?: string): Promise<void> {\n    await db.insert(consentLogs).values({\n      userId,\n      consentType,\n      value,\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async getConsentLogs(userId: string, limit: number = 50): Promise<ConsentLog[]> {\n    return db.select().from(consentLogs)\n      .where(eq(consentLogs.userId, userId))\n      .orderBy(desc(consentLogs.createdAt))\n      .limit(limit);\n  }\n\n  // Shared Links CRUD\n  async createSharedLink(data: InsertSharedLink): Promise<SharedLink> {\n    const token = data.token || crypto.randomBytes(32).toString('hex');\n    const [result] = await db.insert(sharedLinks).values({ ...data, token }).returning();\n    return result;\n  }\n\n  async getSharedLinks(userId: string): Promise<SharedLink[]> {\n    return db.select().from(sharedLinks)\n      .where(eq(sharedLinks.userId, userId))\n      .orderBy(desc(sharedLinks.createdAt));\n  }\n\n  async getSharedLinkByToken(token: string): Promise<SharedLink | undefined> {\n    const [result] = await db.select().from(sharedLinks).where(eq(sharedLinks.token, token));\n    return result;\n  }\n\n  async updateSharedLink(id: string, data: Partial<InsertSharedLink>): Promise<SharedLink> {\n    const [result] = await db.update(sharedLinks)\n      .set(data)\n      .where(eq(sharedLinks.id, id))\n      .returning();\n    return result;\n  }\n\n  async revokeSharedLink(id: string): Promise<void> {\n    await db.update(sharedLinks)\n      .set({ isRevoked: 'true' })\n      .where(eq(sharedLinks.id, id));\n  }\n\n  async rotateSharedLinkToken(id: string): Promise<SharedLink> {\n    const newToken = crypto.randomBytes(32).toString('hex');\n    const [result] = await db.update(sharedLinks)\n      .set({ token: newToken })\n      .where(eq(sharedLinks.id, id))\n      .returning();\n    return result;\n  }\n\n  async incrementSharedLinkAccess(id: string): Promise<void> {\n    await db.update(sharedLinks)\n      .set({ \n        accessCount: sql`${sharedLinks.accessCount} + 1`,\n        lastAccessedAt: new Date()\n      })\n      .where(eq(sharedLinks.id, id));\n  }\n\n  // Archived/Deleted Chats\n  async getArchivedChats(userId: string): Promise<Chat[]> {\n    return db.select().from(chats)\n      .where(and(eq(chats.userId, userId), eq(chats.archived, 'true')))\n      .orderBy(desc(chats.updatedAt));\n  }\n\n  async unarchiveChat(chatId: string): Promise<void> {\n    await db.update(chats)\n      .set({ archived: 'false', updatedAt: new Date() })\n      .where(eq(chats.id, chatId));\n  }\n\n  async archiveAllChats(userId: string): Promise<number> {\n    const result = await db.update(chats)\n      .set({ archived: 'true', updatedAt: new Date() })\n      .where(and(eq(chats.userId, userId), eq(chats.archived, 'false')))\n      .returning();\n    return result.length;\n  }\n\n  async softDeleteChat(chatId: string): Promise<void> {\n    await db.update(chats)\n      .set({ deletedAt: new Date(), updatedAt: new Date() })\n      .where(eq(chats.id, chatId));\n  }\n\n  async softDeleteAllChats(userId: string): Promise<number> {\n    const result = await db.update(chats)\n      .set({ deletedAt: new Date(), updatedAt: new Date() })\n      .where(and(eq(chats.userId, userId), isNull(chats.deletedAt)))\n      .returning();\n    return result.length;\n  }\n\n  async getDeletedChats(userId: string): Promise<Chat[]> {\n    return db.select().from(chats)\n      .where(and(eq(chats.userId, userId), sql`${chats.deletedAt} IS NOT NULL`))\n      .orderBy(desc(chats.deletedAt));\n  }\n\n  async restoreDeletedChat(chatId: string): Promise<void> {\n    await db.update(chats)\n      .set({ deletedAt: null, updatedAt: new Date() })\n      .where(eq(chats.id, chatId));\n  }\n\n  async permanentlyDeleteChat(chatId: string): Promise<void> {\n    await db.delete(chats).where(eq(chats.id, chatId));\n  }\n}\n\nexport const storage = new MemStorage();\n","path":null,"size_bytes":45026,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1598,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst cardVariants = cva(\n  \"rounded-xl border bg-card text-card-foreground transition-all duration-200\",\n  {\n    variants: {\n      variant: {\n        default: \"shadow\",\n        elevated: \"shadow-lg hover:shadow-xl\",\n        outlined: \"border-2 shadow-none\",\n        interactive: \"shadow cursor-pointer hover:shadow-md hover:scale-[1.02] active:scale-[0.98]\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface CardProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof cardVariants> {}\n\nconst Card = React.forwardRef<HTMLDivElement, CardProps>(\n  ({ className, variant, ...props }, ref) => (\n    <div\n      ref={ref}\n      data-testid={`card-${variant || \"default\"}`}\n      className={cn(cardVariants({ variant }), className)}\n      {...props}\n    />\n  )\n)\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"font-semibold leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent, cardVariants }\n","path":null,"size_bytes":2459,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\n      \"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2859,"size_tokens":null},"client/src/components/ui/input-group.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nfunction InputGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"input-group\"\n      role=\"group\"\n      className={cn(\n        \"group/input-group border-input dark:bg-input/30 shadow-xs relative flex w-full items-center rounded-md border outline-none transition-[color,box-shadow]\",\n        \"h-9 has-[>textarea]:h-auto\",\n\n        // Variants based on alignment.\n        \"has-[>[data-align=inline-start]]:[&>input]:pl-2\",\n        \"has-[>[data-align=inline-end]]:[&>input]:pr-2\",\n        \"has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3\",\n        \"has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3\",\n\n        // Focus state.\n        \"has-[[data-slot=input-group-control]:focus-visible]:ring-ring has-[[data-slot=input-group-control]:focus-visible]:ring-1\",\n\n        // Error state.\n        \"has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40\",\n\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupAddonVariants = cva(\n  \"text-muted-foreground flex h-auto cursor-text select-none items-center justify-center gap-2 py-1.5 text-sm font-medium group-data-[disabled=true]/input-group:opacity-50 [&>kbd]:rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-4\",\n  {\n    variants: {\n      align: {\n        \"inline-start\":\n          \"order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]\",\n        \"inline-end\":\n          \"order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]\",\n        \"block-start\":\n          \"[.border-b]:pb-3 order-first w-full justify-start px-3 pt-3 group-has-[>input]/input-group:pt-2.5\",\n        \"block-end\":\n          \"[.border-t]:pt-3 order-last w-full justify-start px-3 pb-3 group-has-[>input]/input-group:pb-2.5\",\n      },\n    },\n    defaultVariants: {\n      align: \"inline-start\",\n    },\n  }\n)\n\nfunction InputGroupAddon({\n  className,\n  align = \"inline-start\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof inputGroupAddonVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"input-group-addon\"\n      data-align={align}\n      className={cn(inputGroupAddonVariants({ align }), className)}\n      onClick={(e) => {\n        if ((e.target as HTMLElement).closest(\"button\")) {\n          return\n        }\n        e.currentTarget.parentElement?.querySelector(\"input\")?.focus()\n      }}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupButtonVariants = cva(\n  \"flex items-center gap-2 text-sm shadow-none\",\n  {\n    variants: {\n      size: {\n        xs: \"h-6 gap-1 rounded-[calc(var(--radius)-5px)] px-2 has-[>svg]:px-2 [&>svg:not([class*='size-'])]:size-3.5\",\n        sm: \"h-8 gap-1.5 rounded-md px-2.5 has-[>svg]:px-2.5\",\n        \"icon-xs\":\n          \"size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0\",\n        \"icon-sm\": \"size-8 p-0 has-[>svg]:p-0\",\n      },\n    },\n    defaultVariants: {\n      size: \"xs\",\n    },\n  }\n)\n\nfunction InputGroupButton({\n  className,\n  type = \"button\",\n  variant = \"ghost\",\n  size = \"xs\",\n  ...props\n}: Omit<React.ComponentProps<typeof Button>, \"size\"> &\n  VariantProps<typeof inputGroupButtonVariants>) {\n  return (\n    <Button\n      type={type}\n      data-size={size}\n      variant={variant}\n      className={cn(inputGroupButtonVariants({ size }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupText({ className, ...props }: React.ComponentProps<\"span\">) {\n  return (\n    <span\n      className={cn(\n        \"text-muted-foreground flex items-center gap-2 text-sm [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupInput({\n  className,\n  ...props\n}: React.ComponentProps<\"input\">) {\n  return (\n    <Input\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupTextarea({\n  className,\n  ...props\n}: React.ComponentProps<\"textarea\">) {\n  return (\n    <Textarea\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  InputGroup,\n  InputGroupAddon,\n  InputGroupButton,\n  InputGroupText,\n  InputGroupInput,\n  InputGroupTextarea,\n}\n","path":null,"size_bytes":4971,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"import * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8608,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationLink,\n  PaginationItem,\n  PaginationPrevious,\n  PaginationNext,\n  PaginationEllipsis,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/sidebar.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { \n  Menu, \n  Search, \n  Library, \n  Bot, \n  Plus, \n  MessageSquare, \n  MoreHorizontal,\n  Settings,\n  PanelLeftClose,\n  ChevronDown,\n  User,\n  CreditCard,\n  Shield,\n  LogOut,\n  Trash2,\n  Pencil,\n  Archive,\n  EyeOff,\n  Eye,\n  Check,\n  X,\n  Monitor,\n  LayoutGrid\n} from \"lucide-react\";\nimport { SiraLogo } from \"@/components/sira-logo\";\nimport { cn } from \"@/lib/utils\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from \"@/components/ui/dropdown-menu\";\nimport { Input } from \"@/components/ui/input\";\nimport { SearchModal } from \"@/components/search-modal\";\nimport { SettingsDialog } from \"@/components/settings-dialog\";\nimport { UpgradePlanDialog } from \"@/components/upgrade-plan-dialog\";\n\nimport { Chat } from \"@/hooks/use-chats\";\nimport { format, isToday, isYesterday, isThisWeek, isThisYear } from \"date-fns\";\n\ninterface SidebarProps {\n  className?: string;\n  chats: Chat[];\n  hiddenChats?: Chat[];\n  activeChatId: string | null;\n  onSelectChat: (id: string) => void;\n  onNewChat?: () => void;\n  onToggle?: () => void;\n  onDeleteChat?: (id: string, e: React.MouseEvent) => void;\n  onEditChat?: (id: string, newTitle: string) => void;\n  onArchiveChat?: (id: string, e: React.MouseEvent) => void;\n  onHideChat?: (id: string, e: React.MouseEvent) => void;\n  onOpenGpts?: () => void;\n  onOpenApps?: () => void;\n  onOpenLibrary?: () => void;\n}\n\nexport function Sidebar({ \n  className, \n  chats, \n  hiddenChats = [],\n  activeChatId, \n  onSelectChat, \n  onNewChat, \n  onToggle,\n  onDeleteChat,\n  onEditChat,\n  onArchiveChat,\n  onHideChat,\n  onOpenGpts,\n  onOpenApps,\n  onOpenLibrary\n}: SidebarProps) {\n  const [, setLocation] = useLocation();\n  const { user, logout } = useAuth();\n  const handleLogout = () => {\n    logout();\n  };\n  const [editingChatId, setEditingChatId] = useState<string | null>(null);\n  const [editTitle, setEditTitle] = useState(\"\");\n  const [showHidden, setShowHidden] = useState(false);\n  const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);\n  const [isUserMenuOpen, setIsUserMenuOpen] = useState(false);\n  const [isSettingsOpen, setIsSettingsOpen] = useState(false);\n  const [isUpgradeDialogOpen, setIsUpgradeDialogOpen] = useState(false);\n  const searchButtonRef = useRef<HTMLButtonElement>(null);\n  \n  const handleStartEdit = (chat: Chat, e: React.MouseEvent) => {\n    e.stopPropagation();\n    setEditingChatId(chat.id);\n    setEditTitle(chat.title);\n  };\n  \n  const handleSaveEdit = (chatId: string) => {\n    if (onEditChat && editTitle.trim()) {\n      onEditChat(chatId, editTitle.trim());\n    }\n    setEditingChatId(null);\n    setEditTitle(\"\");\n  };\n  \n  const handleCancelEdit = () => {\n    setEditingChatId(null);\n    setEditTitle(\"\");\n  };\n  \n  const getChatDateLabel = (timestamp: number) => {\n    const date = new Date(timestamp);\n    if (isToday(date)) return \"Today\";\n    if (isYesterday(date)) return \"Yesterday\";\n    if (isThisWeek(date)) return \"Previous 7 Days\";\n    if (isThisYear(date)) return format(date, \"MMM d\");\n    return format(date, \"yyyy\");\n  };\n\n  // Group chats\n  const groupedChats = chats.reduce((groups, chat) => {\n    const label = getChatDateLabel(chat.timestamp);\n    if (!groups[label]) groups[label] = [];\n    groups[label].push(chat);\n    return groups;\n  }, {} as Record<string, Chat[]>);\n\n  // Order of groups\n  const groupOrder = [\"Today\", \"Yesterday\", \"Previous 7 Days\"];\n  // Add other dynamic keys that might appear\n  Object.keys(groupedChats).forEach(key => {\n    if (!groupOrder.includes(key)) groupOrder.push(key);\n  });\n  \n  return (\n    <div className={cn(\"flex h-screen w-[260px] flex-col liquid-sidebar-light dark:liquid-sidebar text-sidebar-foreground\", className)}>\n      <div className=\"flex h-14 items-center justify-between px-4 py-2\">\n        <div className=\"flex items-center gap-2\">\n          <SiraLogo size={32} />\n          <div className=\"flex flex-col\">\n            <span className=\"text-sm font-semibold leading-none liquid-text-gradient\">MICHAT</span>\n            <span className=\"text-[10px] text-muted-foreground\">AI Platform</span>\n          </div>\n        </div>\n        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 liquid-button\" onClick={onToggle}>\n          <svg className=\"h-5 w-5 text-muted-foreground\" viewBox=\"0 0 24 24\" fill=\"none\">\n            <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"3\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\n            <line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\n            <path d=\"M14 9L17 12L14 15\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n          </svg>\n        </Button>\n      </div>\n\n      <div className=\"px-2 py-2\">\n        <Button \n          variant=\"ghost\" \n          className=\"w-full justify-start gap-2 px-2 text-sm font-medium liquid-button\"\n          onClick={onNewChat}\n          data-testid=\"button-new-chat\"\n        >\n          <Plus className=\"h-4 w-4\" />\n          Nuevo Chat\n        </Button>\n        <Button \n          ref={searchButtonRef}\n          variant=\"ghost\" \n          className=\"w-full justify-start gap-2 px-2 text-sm font-medium liquid-button\"\n          onClick={() => setIsSearchModalOpen(true)}\n          data-testid=\"button-search-chats\"\n        >\n          <Search className=\"h-4 w-4\" />\n          Buscar chats\n        </Button>\n        <Button \n          variant=\"ghost\" \n          className=\"w-full justify-start gap-2 px-2 text-sm font-medium liquid-button\"\n          onClick={onOpenLibrary}\n          data-testid=\"button-library\"\n        >\n          <Library className=\"h-4 w-4\" />\n          Biblioteca\n        </Button>\n        <Button \n          variant=\"ghost\" \n          className=\"w-full justify-start gap-2 px-2 text-sm font-medium liquid-button\"\n          onClick={onOpenGpts}\n          data-testid=\"button-gpts\"\n        >\n          <Bot className=\"h-4 w-4\" />\n          GPTs\n        </Button>\n        <Button \n          variant=\"ghost\" \n          className=\"w-full justify-start gap-2 px-2 text-sm font-medium liquid-button\"\n          onClick={onOpenApps}\n          data-testid=\"button-apps\"\n        >\n          <LayoutGrid className=\"h-4 w-4\" />\n          Aplicaciones\n        </Button>\n      </div>\n\n      <Separator className=\"mx-4 my-2 w-auto\" />\n\n      <ScrollArea className=\"flex-1 px-2 liquid-scroll\">\n        <div className=\"flex flex-col gap-4 pb-4\">\n          {groupOrder.map((group) => {\n            const groupChats = groupedChats[group];\n            if (!groupChats || groupChats.length === 0) return null;\n\n            return (\n              <div key={group} className=\"flex flex-col gap-0.5\">\n                <div className=\"px-2 py-1.5\">\n                  <h3 className=\"text-xs font-medium text-muted-foreground\">{group}</h3>\n                </div>\n                {groupChats.map((chat) => (\n                  <div\n                    key={chat.id}\n                    className={cn(\n                      \"group flex w-full items-center justify-between px-2 py-2.5 rounded-xl cursor-pointer liquid-hover hover:bg-accent transition-all duration-300\",\n                      activeChatId === chat.id && \"bg-accent shadow-sm\",\n                      chat.archived && \"opacity-70\"\n                    )}\n                    onClick={() => !editingChatId && onSelectChat(chat.id)}\n                    data-testid={`chat-item-${chat.id}`}\n                  >\n                    {editingChatId === chat.id ? (\n                      <div className=\"flex w-full items-center gap-1\" onClick={(e) => e.stopPropagation()}>\n                        <Input\n                          value={editTitle}\n                          onChange={(e) => setEditTitle(e.target.value)}\n                          className=\"h-7 text-sm flex-1\"\n                          autoFocus\n                          onKeyDown={(e) => {\n                            if (e.key === \"Enter\") handleSaveEdit(chat.id);\n                            if (e.key === \"Escape\") handleCancelEdit();\n                          }}\n                          data-testid={`input-edit-chat-${chat.id}`}\n                        />\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6\"\n                          onClick={() => handleSaveEdit(chat.id)}\n                          data-testid={`button-save-edit-${chat.id}`}\n                        >\n                          <Check className=\"h-3 w-3 text-green-500\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6\"\n                          onClick={handleCancelEdit}\n                          data-testid={`button-cancel-edit-${chat.id}`}\n                        >\n                          <X className=\"h-3 w-3 text-red-500\" />\n                        </Button>\n                      </div>\n                    ) : (\n                      <>\n                        <div className=\"flex items-center gap-2 min-w-0 flex-1\">\n                          {chat.archived && <Archive className=\"h-3 w-3 text-muted-foreground flex-shrink-0\" />}\n                          <span className=\"truncate text-sm font-medium\">{chat.title}</span>\n                        </div>\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <div\n                              className=\"opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-accent rounded\"\n                              onClick={(e) => e.stopPropagation()}\n                              data-testid={`button-chat-menu-${chat.id}`}\n                            >\n                              <MoreHorizontal className=\"h-4 w-4 text-foreground\" />\n                            </div>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\" className=\"w-40\">\n                            <DropdownMenuItem\n                              onClick={(e) => handleStartEdit(chat, e as unknown as React.MouseEvent)}\n                              data-testid={`menu-edit-${chat.id}`}\n                            >\n                              <Pencil className=\"h-4 w-4 mr-2\" />\n                              Editar\n                            </DropdownMenuItem>\n                            <DropdownMenuItem\n                              onClick={(e) => onArchiveChat?.(chat.id, e as unknown as React.MouseEvent)}\n                              data-testid={`menu-archive-${chat.id}`}\n                            >\n                              <Archive className=\"h-4 w-4 mr-2\" />\n                              {chat.archived ? \"Desarchivar\" : \"Archivar\"}\n                            </DropdownMenuItem>\n                            <DropdownMenuItem\n                              onClick={(e) => onHideChat?.(chat.id, e as unknown as React.MouseEvent)}\n                              data-testid={`menu-hide-${chat.id}`}\n                            >\n                              <EyeOff className=\"h-4 w-4 mr-2\" />\n                              Ocultar\n                            </DropdownMenuItem>\n                            <DropdownMenuSeparator />\n                            <DropdownMenuItem\n                              onClick={(e) => onDeleteChat?.(chat.id, e as unknown as React.MouseEvent)}\n                              className=\"text-red-500 focus:text-red-500\"\n                              data-testid={`menu-delete-${chat.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4 mr-2\" />\n                              Eliminar\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </>\n                    )}\n                  </div>\n                ))}\n              </div>\n            );\n          })}\n        </div>\n      </ScrollArea>\n\n      {/* Hidden Chats Section */}\n      {hiddenChats.length > 0 && (\n        <div className=\"px-2 border-t\">\n          <Button\n            variant=\"ghost\"\n            className=\"w-full justify-between px-2 py-2 text-sm font-medium text-muted-foreground liquid-button\"\n            onClick={() => setShowHidden(!showHidden)}\n            data-testid=\"button-toggle-hidden\"\n          >\n            <div className=\"flex items-center gap-2\">\n              <EyeOff className=\"h-4 w-4\" />\n              <span>Ocultos ({hiddenChats.length})</span>\n            </div>\n            <ChevronDown className={cn(\"h-4 w-4 transition-transform\", showHidden && \"rotate-180\")} />\n          </Button>\n          {showHidden && (\n            <div className=\"flex flex-col gap-0.5 pb-2\">\n              {hiddenChats.map((chat) => (\n                <div\n                  key={chat.id}\n                  className=\"group flex w-full items-center justify-between px-2 py-2 rounded-md cursor-pointer hover:bg-accent transition-colors opacity-70\"\n                  onClick={() => onSelectChat(chat.id)}\n                  data-testid={`hidden-chat-item-${chat.id}`}\n                >\n                  <span className=\"truncate text-sm\">{chat.title}</span>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-6 w-6 opacity-0 group-hover:opacity-80\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      onHideChat?.(chat.id, e);\n                    }}\n                    data-testid={`button-unhide-${chat.id}`}\n                  >\n                    <Eye className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      <div className=\"mt-auto border-t p-4\">\n        <div className=\"flex w-full items-center gap-3 rounded-lg p-2\">\n          <Popover open={isUserMenuOpen} onOpenChange={setIsUserMenuOpen}>\n            <PopoverTrigger asChild>\n              <button className=\"flex flex-1 items-center gap-3 liquid-button cursor-pointer\" data-testid=\"button-user-menu\">\n                <Avatar className=\"h-10 w-10\">\n                  <AvatarFallback className=\"bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300\">\n                    {user?.role === \"admin\" ? \"A\" : (user?.firstName?.[0] || user?.email?.[0] || \"U\").toUpperCase()}\n                  </AvatarFallback>\n                </Avatar>\n                <div className=\"flex flex-1 flex-col overflow-hidden text-left\">\n                  <span className=\"truncate text-sm font-medium\">\n                    {user?.role === \"admin\" ? \"Admin\" : (user?.firstName || user?.email?.split(\"@\")[0] || \"Usuario\")}\n                  </span>\n                  <span className=\"truncate text-xs text-muted-foreground\">\n                    {user?.email === \"infosiragpt@gmail.com\" ? \"ENTERPRISE\" : \"Cuenta personal\"}\n                  </span>\n                </div>\n              </button>\n            </PopoverTrigger>\n          <PopoverContent className=\"w-auto min-w-56 p-2\" align=\"start\" side=\"top\">\n            <div className=\"flex flex-col\">\n              <Button variant=\"ghost\" className=\"justify-start gap-3 text-sm h-10 font-normal liquid-button\" onClick={() => { setIsUserMenuOpen(false); setLocation(\"/profile\"); }} data-testid=\"button-profile\">\n                <User className=\"h-4 w-4\" />\n                Perfil\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-3 text-sm h-10 font-normal liquid-button\" onClick={() => { setIsUserMenuOpen(false); setLocation(\"/billing\"); }} data-testid=\"button-billing\">\n                <CreditCard className=\"h-4 w-4\" />\n                Facturación\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-3 text-sm h-10 font-normal liquid-button\" onClick={() => { setIsUserMenuOpen(false); setLocation(\"/workspace-settings\"); }} data-testid=\"button-workspace-settings\">\n                <Monitor className=\"h-4 w-4\" />\n                Configuración del espacio de trabajo\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-3 text-sm h-10 font-normal liquid-button\" onClick={() => { setIsUserMenuOpen(false); setIsSettingsOpen(true); }} data-testid=\"button-settings\">\n                <Settings className=\"h-4 w-4\" />\n                Configuración\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-3 text-sm h-10 font-normal liquid-button\" onClick={() => { setIsUserMenuOpen(false); setLocation(\"/privacy\"); }} data-testid=\"button-privacy\">\n                <Shield className=\"h-4 w-4\" />\n                Privacidad\n              </Button>\n              {user?.role === \"admin\" && (\n                <Button variant=\"ghost\" className=\"justify-start gap-3 text-sm h-10 font-normal liquid-button\" onClick={() => { setIsUserMenuOpen(false); setLocation(\"/admin\"); }} data-testid=\"button-admin-panel\">\n                  <Settings className=\"h-4 w-4\" />\n                  Admin Panel\n                </Button>\n              )}\n              <Separator className=\"my-1\" />\n              <Button variant=\"ghost\" className=\"justify-start gap-3 text-sm h-10 font-normal text-red-500 hover:text-red-600 hover:bg-red-50 liquid-button\" onClick={() => { setIsUserMenuOpen(false); handleLogout(); }} data-testid=\"button-logout\">\n                <LogOut className=\"h-4 w-4\" />\n                Cerrar sesión\n              </Button>\n            </div>\n          </PopoverContent>\n          </Popover>\n          {user?.email !== \"infosiragpt@gmail.com\" && (\n            <Button\n              size=\"sm\"\n              className=\"rounded-full text-xs px-4 py-1 h-auto whitespace-nowrap bg-purple-600 hover:bg-purple-700 text-white border-0 flex-shrink-0\"\n              onClick={() => setIsUpgradeDialogOpen(true)}\n              data-testid=\"button-upgrade-plan\"\n            >\n              Mejorar el plan\n            </Button>\n          )}\n        </div>\n      </div>\n\n      <SearchModal\n        open={isSearchModalOpen}\n        onOpenChange={setIsSearchModalOpen}\n        chats={chats}\n        onSelectChat={onSelectChat}\n        triggerRef={searchButtonRef}\n      />\n\n      <SettingsDialog\n        open={isSettingsOpen}\n        onOpenChange={setIsSettingsOpen}\n      />\n\n      <UpgradePlanDialog\n        open={isUpgradeDialogOpen}\n        onOpenChange={setIsUpgradeDialogOpen}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":19061,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverAnchor = PopoverPrimitive.Anchor\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }\n","path":null,"size_bytes":1342,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport tailwindcss from \"@tailwindcss/vite\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\nimport { metaImagesPlugin } from \"./vite-plugin-meta-images\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    tailwindcss(),\n    metaImagesPlugin(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  css: {\n    postcss: {\n      plugins: [],\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    host: \"0.0.0.0\",\n    allowedHosts: true,\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1330,"size_tokens":null},"client/src/components/ui/sonner.tsx":{"content":"\"use client\"\n\nimport { useTheme } from \"next-themes\"\nimport { Toaster as Sonner } from \"sonner\"\n\ntype ToasterProps = React.ComponentProps<typeof Sonner>\n\nconst Toaster = ({ ...props }: ToasterProps) => {\n  const { theme = \"system\" } = useTheme()\n\n  return (\n    <Sonner\n      theme={theme as ToasterProps[\"theme\"]}\n      className=\"toaster group\"\n      toastOptions={{\n        classNames: {\n          toast:\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\n          description: \"group-[.toast]:text-muted-foreground\",\n          actionButton:\n            \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\n          cancelButton:\n            \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\n        },\n      }}\n      {...props}\n    />\n  )\n}\n\nexport { Toaster }\n","path":null,"size_bytes":894,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/field.tsx":{"content":"\"use client\"\n\nimport { useMemo } from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction FieldSet({ className, ...props }: React.ComponentProps<\"fieldset\">) {\n  return (\n    <fieldset\n      data-slot=\"field-set\"\n      className={cn(\n        \"flex flex-col gap-6\",\n        \"has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLegend({\n  className,\n  variant = \"legend\",\n  ...props\n}: React.ComponentProps<\"legend\"> & { variant?: \"legend\" | \"label\" }) {\n  return (\n    <legend\n      data-slot=\"field-legend\"\n      data-variant={variant}\n      className={cn(\n        \"mb-3 font-medium\",\n        \"data-[variant=legend]:text-base\",\n        \"data-[variant=label]:text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-group\"\n      className={cn(\n        \"group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst fieldVariants = cva(\n  \"group/field data-[invalid=true]:text-destructive flex w-full gap-3\",\n  {\n    variants: {\n      orientation: {\n        vertical: [\"flex-col [&>*]:w-full [&>.sr-only]:w-auto\"],\n        horizontal: [\n          \"flex-row items-center\",\n          \"[&>[data-slot=field-label]]:flex-auto\",\n          \"has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px has-[>[data-slot=field-content]]:items-start\",\n        ],\n        responsive: [\n          \"@md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto flex-col [&>*]:w-full [&>.sr-only]:w-auto\",\n          \"@md/field-group:[&>[data-slot=field-label]]:flex-auto\",\n          \"@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px\",\n        ],\n      },\n    },\n    defaultVariants: {\n      orientation: \"vertical\",\n    },\n  }\n)\n\nfunction Field({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof fieldVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"field\"\n      data-orientation={orientation}\n      className={cn(fieldVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction FieldContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-content\"\n      className={cn(\n        \"group/field-content flex flex-1 flex-col gap-1.5 leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLabel({\n  className,\n  ...props\n}: React.ComponentProps<typeof Label>) {\n  return (\n    <Label\n      data-slot=\"field-label\"\n      className={cn(\n        \"group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50\",\n        \"has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>[data-slot=field]]:p-4\",\n        \"has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-label\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug group-data-[disabled=true]/field:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"field-description\"\n      className={cn(\n        \"text-muted-foreground text-sm font-normal leading-normal group-has-[[data-orientation=horizontal]]/field:text-balance\",\n        \"nth-last-2:-mt-1 last:mt-0 [[data-variant=legend]+&]:-mt-1.5\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldSeparator({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  children?: React.ReactNode\n}) {\n  return (\n    <div\n      data-slot=\"field-separator\"\n      data-content={!!children}\n      className={cn(\n        \"relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2\",\n        className\n      )}\n      {...props}\n    >\n      <Separator className=\"absolute inset-0 top-1/2\" />\n      {children && (\n        <span\n          className=\"bg-background text-muted-foreground relative mx-auto block w-fit px-2\"\n          data-slot=\"field-separator-content\"\n        >\n          {children}\n        </span>\n      )}\n    </div>\n  )\n}\n\nfunction FieldError({\n  className,\n  children,\n  errors,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  errors?: Array<{ message?: string } | undefined>\n}) {\n  const content = useMemo(() => {\n    if (children) {\n      return children\n    }\n\n    if (!errors) {\n      return null\n    }\n\n    if (errors?.length === 1 && errors[0]?.message) {\n      return errors[0].message\n    }\n\n    return (\n      <ul className=\"ml-4 flex list-disc flex-col gap-1\">\n        {errors.map(\n          (error, index) =>\n            error?.message && <li key={index}>{error.message}</li>\n        )}\n      </ul>\n    )\n  }, [children, errors])\n\n  if (!content) {\n    return null\n  }\n\n  return (\n    <div\n      role=\"alert\"\n      data-slot=\"field-error\"\n      className={cn(\"text-destructive text-sm font-normal\", className)}\n      {...props}\n    >\n      {content}\n    </div>\n  )\n}\n\nexport {\n  Field,\n  FieldLabel,\n  FieldDescription,\n  FieldError,\n  FieldGroup,\n  FieldLegend,\n  FieldSeparator,\n  FieldSet,\n  FieldContent,\n  FieldTitle,\n}\n","path":null,"size_bytes":6044,"size_tokens":null},"client/src/components/ui/kbd.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Kbd({ className, ...props }: React.ComponentProps<\"kbd\">) {\n  return (\n    <kbd\n      data-slot=\"kbd\"\n      className={cn(\n        \"bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 select-none items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium\",\n        \"[&_svg:not([class*='size-'])]:size-3\",\n        \"[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction KbdGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <kbd\n      data-slot=\"kbd-group\"\n      className={cn(\"inline-flex items-center gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Kbd, KbdGroup }\n","path":null,"size_bytes":862,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n      {children}\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4280,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue | null>(null)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  if (!itemContext) {\n    throw new Error(\"useFormField should be used within <FormItem>\")\n  }\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue | null>(null)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-[0.8rem] text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-[0.8rem] font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4175,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Portal>\n    <TooltipPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </TooltipPrimitive.Portal>\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1267,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1037,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1148,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"grid place-content-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1031,"size_tokens":null},"client/src/index.css":{"content":"@import \"tailwindcss\";\n@import \"tw-animate-css\";\n@import \"./styles/document-editor.css\";\n@import \"./styles/theme.css\";\n@import \"./styles/markdown.css\";\n@import \"./styles/animations.css\";\n@import \"./styles/mobile.css\";\n\n@custom-variant dark (&:is(.dark *));\n\n/* Floating Label Input Styles */\n.floating-label {\n  position: relative;\n  display: flex;\n  align-items: center;\n}\n\n.floating-label input {\n  width: 100%;\n  padding: 0.75rem 1rem;\n  padding-left: 2.5rem;\n  font-size: 0.875rem;\n  background: transparent;\n  border: 1px solid hsl(var(--border));\n  border-radius: 9999px;\n  outline: none;\n  transition: all 0.2s ease;\n}\n\n.floating-label input:focus {\n  border-color: hsl(var(--ring));\n  box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);\n}\n\n.floating-label span {\n  position: absolute;\n  left: 2.5rem;\n  color: hsl(var(--muted-foreground));\n  font-size: 0.875rem;\n  pointer-events: none;\n  transition: all 0.2s ease;\n}\n\n.floating-label input:focus + span,\n.floating-label input:not(:placeholder-shown) + span {\n  transform: translateY(-1.5rem) translateX(-0.5rem);\n  font-size: 0.75rem;\n  color: hsl(var(--foreground));\n  background: hsl(var(--background));\n  padding: 0 0.25rem;\n}\n\n.floating-label .search-icon {\n  position: absolute;\n  left: 0.75rem;\n  color: hsl(var(--muted-foreground));\n  pointer-events: none;\n}\n\n/* ========================================\n   DESIGN TOKEN UTILITY CLASSES\n======================================== */\n\n/* Surface backgrounds using CSS variables */\n.surface-1 {\n  background-color: hsl(var(--bg-surface-1));\n}\n.surface-2 {\n  background-color: hsl(var(--bg-surface-2));\n}\n.surface-3 {\n  background-color: hsl(var(--bg-surface-3));\n}\n\n/* Text colors using CSS variables */\n.text-token-primary {\n  color: hsl(var(--text-primary));\n}\n.text-token-secondary {\n  color: hsl(var(--text-secondary));\n}\n.text-token-tertiary {\n  color: hsl(var(--text-tertiary));\n}\n\n/* Icon colors using CSS variables */\n.icon-token-primary {\n  color: hsl(var(--icon-primary));\n}\n.icon-token-secondary {\n  color: hsl(var(--icon-secondary));\n}\n.icon-token-tertiary {\n  color: hsl(var(--icon-tertiary));\n}\n\n/* Overlay using CSS variable */\n.overlay-bg {\n  background-color: hsl(var(--overlay));\n}\n\n/* ========================================\n   LIQUID UI UTILITY CLASSES\n======================================== */\n\n/* Simple Background - Uses design tokens */\n.liquid-bg {\n  background-color: hsl(var(--background));\n}\n\n.liquid-bg-light {\n  background-color: hsl(var(--background));\n}\n\n/* Simple Card - Uses design tokens */\n.glass-card {\n  background-color: hsl(var(--card));\n  border: 1px solid hsl(var(--border));\n  border-radius: 8px;\n}\n\n.glass-card-light {\n  background-color: hsl(var(--card));\n  border: 1px solid hsl(var(--border));\n  border-radius: 8px;\n}\n\n/* Simple Sidebar - Uses design tokens */\n.liquid-sidebar {\n  background-color: hsl(var(--sidebar));\n  border-right: 1px solid hsl(var(--sidebar-border));\n}\n\n.liquid-sidebar-light {\n  background-color: hsl(var(--sidebar));\n  border-right: 1px solid hsl(var(--sidebar-border));\n}\n\n/* Hidden Blob Elements */\n.liquid-blob {\n  display: none;\n}\n\n/* Simple Button - Uses design tokens */\n.liquid-btn {\n  background-color: hsl(var(--background));\n  border: 1px solid hsl(var(--border));\n  border-radius: 6px;\n  padding: 12px 24px;\n  color: hsl(var(--foreground));\n  font-weight: 500;\n  transition: all 0.2s ease;\n}\n\n.liquid-btn:hover {\n  transform: translateY(-1px);\n  background-color: hsl(var(--primary));\n  color: hsl(var(--primary-foreground));\n}\n\n/* Simple Input - Uses design tokens */\n.liquid-input {\n  background-color: hsl(var(--input));\n  border: 1px solid hsl(var(--border));\n  border-radius: 6px;\n  transition: all 0.2s ease;\n  color: hsl(var(--foreground));\n}\n\n.liquid-input:focus,\n.liquid-input:focus-within {\n  border-color: hsl(var(--ring));\n}\n\n.liquid-input-light {\n  background-color: hsl(var(--input));\n  border: 1px solid hsl(var(--border));\n  border-radius: 6px;\n  transition: all 0.2s ease;\n  color: hsl(var(--foreground));\n}\n\n.liquid-input-light:focus-within {\n  border-color: hsl(var(--ring));\n}\n\n/* Simple Message Bubbles - Uses design tokens */\n.liquid-message-user {\n  background-color: hsl(var(--primary));\n  border-radius: 16px 16px 4px 16px;\n  color: hsl(var(--primary-foreground));\n  overflow-wrap: break-word;\n  word-wrap: break-word;\n  word-break: break-word;\n  max-width: 100%;\n}\n\n.liquid-message-ai {\n  background-color: hsl(var(--card));\n  border: 1px solid hsl(var(--border));\n  border-radius: 16px 16px 16px 4px;\n  color: hsl(var(--card-foreground));\n}\n\n.liquid-message-ai-light {\n  background: transparent;\n  border: none;\n  border-radius: 0;\n  line-height: 1.5;\n  overflow-wrap: break-word;\n  word-wrap: break-word;\n  word-break: break-word;\n}\n\n.liquid-message-ai-light a {\n  word-break: break-all;\n}\n\n.liquid-message-ai-light pre {\n  overflow-x: auto;\n  max-width: 100%;\n}\n\n/* Liquid Hover Effects - Uses design tokens */\n.liquid-hover {\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.liquid-hover:hover {\n  background-color: hsl(var(--accent));\n  transform: translateX(4px);\n}\n\n/* Smooth scrollbar for liquid feel */\n.liquid-scroll::-webkit-scrollbar {\n  width: 6px;\n}\n\n.liquid-scroll::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.liquid-scroll::-webkit-scrollbar-thumb {\n  background-color: hsl(var(--muted-foreground) / 0.3);\n  border-radius: 3px;\n}\n\n.liquid-scroll::-webkit-scrollbar-thumb:hover {\n  background-color: hsl(var(--muted-foreground) / 0.5);\n}\n\n/* Simple glow effect - Uses design tokens */\n.liquid-glow {\n  box-shadow: 0 0 10px hsl(var(--ring) / 0.2);\n}\n\n/* Simple text color - Uses design tokens */\n.liquid-text-gradient {\n  color: hsl(var(--foreground));\n}\n\n/* ========================================\n   CLEAN DATA TABLE COMPONENT\n======================================== */\n\n.table-wrap {\n  overflow-x: auto;\n  -webkit-overflow-scrolling: touch;\n  max-width: 100%;\n  margin: 1rem 0;\n}\n\n.data-table {\n  width: 100%;\n  border-collapse: collapse;\n  table-layout: fixed;\n  background-color: #ffffff;\n  font-family: system-ui, -apple-system, 'Inter', 'Segoe UI', sans-serif;\n}\n\n.dark .data-table {\n  background-color: hsl(var(--card));\n}\n\n.data-table th,\n.data-table td {\n  text-align: left;\n  vertical-align: middle;\n  border-left: none;\n  border-right: none;\n}\n\n.data-table th {\n  font-weight: 600;\n  font-size: 14px;\n  padding: 10px 16px;\n  border-bottom: 2px solid #e5e7eb;\n  color: #111827;\n  background-color: #fafafa;\n  white-space: nowrap;\n}\n\n.dark .data-table th {\n  color: hsl(var(--foreground));\n  background-color: hsl(var(--muted));\n  border-bottom-color: hsl(var(--border));\n}\n\n.data-table td {\n  font-size: 14px;\n  padding: 12px 16px;\n  border-bottom: 1px solid #f3f4f6;\n  color: #111827;\n}\n\n.dark .data-table td {\n  color: hsl(var(--foreground));\n  border-bottom-color: hsl(var(--border));\n}\n\n.data-table tbody tr {\n  transition: background-color 0.15s ease;\n}\n\n.data-table tbody tr:hover {\n  background-color: #f9fafb;\n}\n\n.dark .data-table tbody tr:hover {\n  background-color: hsl(var(--accent));\n}\n\n.data-table th.text-right,\n.data-table td.text-right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n.data-table td.truncate-cell {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.data-table td.wrap-cell {\n  word-break: break-word;\n  white-space: normal;\n}\n\n.sr-only {\n  position: absolute;\n  width: 1px;\n  height: 1px;\n  padding: 0;\n  margin: -1px;\n  overflow: hidden;\n  clip: rect(0, 0, 0, 0);\n  white-space: nowrap;\n  border: 0;\n}\n\n@media (max-width: 768px) {\n  .data-table th,\n  .data-table td {\n    font-size: 13px;\n    padding: 10px 12px;\n  }\n}\n\n@media (max-width: 480px) {\n  .data-table th,\n  .data-table td {\n    font-size: 12px;\n    padding: 8px 10px;\n  }\n}\n","path":null,"size_bytes":7773,"size_tokens":null},"client/src/pages/home.tsx":{"content":"import { Sidebar } from \"@/components/sidebar\";\nimport { MiniSidebar } from \"@/components/mini-sidebar\";\nimport { ChatInterface } from \"@/components/chat-interface\";\nimport { GptExplorer, Gpt } from \"@/components/gpt-explorer\";\nimport { GptBuilder } from \"@/components/gpt-builder\";\nimport { UserLibrary } from \"@/components/user-library\";\nimport { useState, useCallback, useMemo, useEffect, useRef } from \"react\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { useLocation } from \"wouter\";\nimport { Menu } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Sheet, SheetContent, SheetTrigger } from \"@/components/ui/sheet\";\nimport { useChats, Message } from \"@/hooks/use-chats\";\nimport { toast } from \"sonner\";\nimport { useAuth } from \"@/hooks/use-auth\";\n\nexport default function Home() {\n  const isMobile = useIsMobile();\n  const [, setLocation] = useLocation();\n  const { isAuthenticated, isLoading } = useAuth();\n\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      setLocation(\"/welcome\");\n    }\n  }, [isAuthenticated, isLoading, setLocation]);\n  const [isSidebarOpen, setIsSidebarOpen] = useState(!isMobile);\n  const [isNewChatMode, setIsNewChatMode] = useState(false);\n  const [newChatStableKey, setNewChatStableKey] = useState<string | null>(null);\n  const [isGptExplorerOpen, setIsGptExplorerOpen] = useState(false);\n  const [isGptBuilderOpen, setIsGptBuilderOpen] = useState(false);\n  const [isLibraryOpen, setIsLibraryOpen] = useState(false);\n  const [editingGpt, setEditingGpt] = useState<Gpt | null>(null);\n  const [activeGpt, setActiveGpt] = useState<Gpt | null>(null);\n  \n  const { \n    chats, \n    hiddenChats,\n    activeChat, \n    setActiveChatId, \n    createChat, \n    addMessage,\n    deleteChat,\n    editChatTitle,\n    archiveChat,\n    hideChat\n  } = useChats();\n\n  // AI processing state - kept in parent to survive ChatInterface key changes\n  const [aiState, setAiState] = useState<\"idle\" | \"thinking\" | \"responding\">(\"idle\");\n  const [aiProcessSteps, setAiProcessSteps] = useState<{step: string; status: \"pending\" | \"active\" | \"done\"}[]>([]);\n\n  // Store the pending chat ID during new chat creation\n  const pendingChatIdRef = useRef<string | null>(null);\n\n  const handleNewChat = () => {\n    const newKey = `new-chat-${Date.now()}`;\n    setActiveChatId(null);\n    setIsNewChatMode(true);\n    setNewChatStableKey(newKey);\n    pendingChatIdRef.current = null;\n    // Reset AI state for new chat\n    setAiState(\"idle\");\n    setAiProcessSteps([]);\n  };\n  \n  const handleSendNewChatMessage = useCallback((message: Message) => {\n    const { pendingId, stableKey } = createChat();\n    pendingChatIdRef.current = pendingId;\n    // Keep the new chat stable key to prevent component remount\n    setNewChatStableKey(prev => prev || stableKey);\n    setIsNewChatMode(false);\n    addMessage(pendingId, message);\n  }, [createChat, addMessage]);\n  \n  // Stable message sender that uses the correct chat ID\n  const handleSendMessage = useCallback((message: Message) => {\n    const targetChatId = activeChat?.id || pendingChatIdRef.current;\n    if (targetChatId) {\n      addMessage(targetChatId, message);\n    } else {\n      // Fallback: create new chat\n      handleSendNewChatMessage(message);\n    }\n  }, [activeChat?.id, addMessage, handleSendNewChatMessage]);\n\n  const handleSelectChat = (id: string) => {\n    setIsNewChatMode(false);\n    setNewChatStableKey(null);\n    setActiveChatId(id);\n  };\n\n  const chatInterfaceKey = useMemo(() => {\n    // Prioritize newChatStableKey to prevent component remount during new chat creation\n    if (newChatStableKey) return newChatStableKey;\n    if (activeChat) return activeChat.stableKey;\n    return \"default-chat\";\n  }, [activeChat?.stableKey, newChatStableKey]);\n\n  // Get messages from either activeChat or pending chat\n  const currentMessages = useMemo(() => {\n    if (activeChat?.messages) return activeChat.messages;\n    // Check if there's a pending chat with messages\n    const pendingId = pendingChatIdRef.current;\n    if (pendingId) {\n      const pendingChat = chats.find(c => c.id === pendingId);\n      if (pendingChat?.messages) return pendingChat.messages;\n    }\n    return [];\n  }, [activeChat?.messages, chats]);\n\n  const handleOpenGpts = () => {\n    setIsGptExplorerOpen(true);\n  };\n\n  const handleOpenApps = () => {\n    setLocation(\"/workspace-settings?section=apps\");\n  };\n\n  const handleOpenLibrary = () => {\n    setIsLibraryOpen(true);\n  };\n\n  const handleSelectGpt = (gpt: Gpt) => {\n    setActiveGpt(gpt);\n    handleNewChat();\n    toast.success(`Usando ${gpt.name}`);\n  };\n\n  const handleCreateGpt = () => {\n    setEditingGpt(null);\n    setIsGptBuilderOpen(true);\n  };\n\n  return (\n    <div className=\"flex h-screen w-full overflow-hidden bg-background relative\">\n      <div className=\"liquid-blob liquid-blob-1 opacity-30\"></div>\n      <div className=\"liquid-blob liquid-blob-2 opacity-20\"></div>\n      <div className=\"liquid-blob liquid-blob-3 opacity-25\"></div>\n      \n      {/* Desktop Sidebar - Full */}\n      <div className={isSidebarOpen ? \"hidden md:block\" : \"hidden\"}>\n        <Sidebar \n          chats={chats} \n          hiddenChats={hiddenChats}\n          activeChatId={activeChat?.id || null} \n          onSelectChat={handleSelectChat} \n          onNewChat={handleNewChat} \n          onToggle={() => setIsSidebarOpen(false)} \n          onDeleteChat={deleteChat}\n          onEditChat={editChatTitle}\n          onArchiveChat={archiveChat}\n          onHideChat={hideChat}\n          onOpenGpts={handleOpenGpts}\n          onOpenApps={handleOpenApps}\n          onOpenLibrary={handleOpenLibrary}\n        />\n      </div>\n\n      {/* Desktop Sidebar - Mini (collapsed) */}\n      <div className={!isSidebarOpen ? \"hidden md:block\" : \"hidden\"}>\n        <MiniSidebar \n          onNewChat={handleNewChat}\n          onExpand={() => setIsSidebarOpen(true)}\n        />\n      </div>\n\n      {/* Mobile Sidebar */}\n      <div className=\"md:hidden absolute top-4 left-4 z-50\">\n        <Sheet>\n          <SheetTrigger asChild>\n            <Button variant=\"ghost\" size=\"icon\" className=\"bg-card border border-border rounded-lg\">\n              <Menu className=\"h-6 w-6 text-foreground\" />\n            </Button>\n          </SheetTrigger>\n          <SheetContent side=\"left\" className=\"p-0 w-[260px]\">\n            <Sidebar \n              chats={chats} \n              hiddenChats={hiddenChats}\n              activeChatId={activeChat?.id || null} \n              onSelectChat={handleSelectChat} \n              onNewChat={handleNewChat} \n              onToggle={() => setIsSidebarOpen(!isSidebarOpen)} \n              onDeleteChat={deleteChat}\n              onEditChat={editChatTitle}\n              onArchiveChat={archiveChat}\n              onHideChat={hideChat}\n              onOpenGpts={handleOpenGpts}\n              onOpenApps={handleOpenApps}\n              onOpenLibrary={handleOpenLibrary}\n            />\n          </SheetContent>\n        </Sheet>\n      </div>\n\n      {/* Main Content */}\n      <main className=\"flex-1 flex flex-col h-full w-full\">\n        {(activeChat || isNewChatMode || chats.length === 0) && (\n          <ChatInterface \n            key={chatInterfaceKey} \n            messages={currentMessages}\n            onSendMessage={handleSendMessage}\n            isSidebarOpen={isSidebarOpen} \n            onToggleSidebar={() => setIsSidebarOpen(true)}\n            onCloseSidebar={() => setIsSidebarOpen(false)}\n            activeGpt={activeGpt}\n            aiState={aiState}\n            setAiState={setAiState}\n            aiProcessSteps={aiProcessSteps}\n            setAiProcessSteps={setAiProcessSteps}\n            chatId={activeChat?.id || null}\n          />\n        )}\n      </main>\n\n      {/* GPT Explorer Modal */}\n      <GptExplorer\n        open={isGptExplorerOpen}\n        onOpenChange={setIsGptExplorerOpen}\n        onSelectGpt={handleSelectGpt}\n        onCreateGpt={handleCreateGpt}\n      />\n\n      {/* GPT Builder Modal */}\n      <GptBuilder\n        open={isGptBuilderOpen}\n        onOpenChange={setIsGptBuilderOpen}\n        editingGpt={editingGpt}\n        onSave={() => {\n          setIsGptBuilderOpen(false);\n          setEditingGpt(null);\n        }}\n      />\n\n      {/* User Library Modal */}\n      <UserLibrary\n        open={isLibraryOpen}\n        onOpenChange={setIsLibraryOpen}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":8344,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"import * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload\n            .filter((item) => item.type !== \"none\")\n            .map((item, index) => {\n              const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n              const itemConfig = getPayloadConfigFromPayload(config, item, key)\n              const indicatorColor = color || item.payload.fill || item.color\n\n              return (\n                <div\n                  key={item.dataKey}\n                  className={cn(\n                    \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                    indicator === \"dot\" && \"items-center\"\n                  )}\n                >\n                  {formatter && item?.value !== undefined && item.name ? (\n                    formatter(item.value, item.name, item, index, item.payload)\n                  ) : (\n                    <>\n                      {itemConfig?.icon ? (\n                        <itemConfig.icon />\n                      ) : (\n                        !hideIndicator && (\n                          <div\n                            className={cn(\n                              \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                              {\n                                \"h-2.5 w-2.5\": indicator === \"dot\",\n                                \"w-1\": indicator === \"line\",\n                                \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                  indicator === \"dashed\",\n                                \"my-0.5\": nestLabel && indicator === \"dashed\",\n                              }\n                            )}\n                            style={\n                              {\n                                \"--color-bg\": indicatorColor,\n                                \"--color-border\": indicatorColor,\n                              } as React.CSSProperties\n                            }\n                          />\n                        )\n                      )}\n                      <div\n                        className={cn(\n                          \"flex flex-1 justify-between leading-none\",\n                          nestLabel ? \"items-end\" : \"items-center\"\n                        )}\n                      >\n                        <div className=\"grid gap-1.5\">\n                          {nestLabel ? tooltipLabel : null}\n                          <span className=\"text-muted-foreground\">\n                            {itemConfig?.label || item.name}\n                          </span>\n                        </div>\n                        {item.value && (\n                          <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                            {item.value.toLocaleString()}\n                          </span>\n                        )}\n                      </div>\n                    </>\n                  )}\n                </div>\n              )\n            })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload\n          .filter((item) => item.type !== \"none\")\n          .map((item) => {\n            const key = `${nameKey || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n            return (\n              <div\n                key={item.value}\n                className={cn(\n                  \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n                )}\n              >\n                {itemConfig?.icon && !hideIcon ? (\n                  <itemConfig.icon />\n                ) : (\n                  <div\n                    className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                    style={{\n                      backgroundColor: item.color,\n                    }}\n                  />\n                )}\n                {itemConfig?.label}\n              </div>\n            )\n          })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10763,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute right-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5745,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile, writeFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"officeparser\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"esm\",\n    outfile: \"dist/index.mjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    banner: {\n      js: `\nimport { createRequire } from 'module';\nimport { fileURLToPath } from 'url';\nimport { dirname } from 'path';\nconst require = createRequire(import.meta.url);\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n      `.trim(),\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n\n  // Create a minimal CJS entry point that loads the ESM bundle\n  console.log(\"creating start wrapper...\");\n  const startWrapper = `#!/usr/bin/env node\n\"use strict\";\nconst { pathToFileURL } = require(\"url\");\nconst { join } = require(\"path\");\nimport(pathToFileURL(join(__dirname, \"index.mjs\")).href).catch(err => {\n  console.error(\"Failed to start application:\", err);\n  process.exit(1);\n});\n`;\n  await writeFile(\"dist/index.cjs\", startWrapper, \"utf-8\");\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":2187,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"import * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3007,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7606,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // @replit\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \",\n  {\n    variants: {\n      variant: {\n        default:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary:\n          // @replit no hover because we use hover-elevate\n          \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n          // @replit shadow-xs\" - use badge outline variable\n        outline: \"text-foreground border [border-color:var(--badge-outline)]\",\n        success:\n          \"border-transparent bg-green-600 text-white shadow-xs\",\n        warning:\n          \"border-transparent bg-amber-500 text-amber-950 shadow-xs\",\n        info:\n          \"border-transparent bg-blue-600 text-white shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div \n      className={cn(badgeVariants({ variant }), className)} \n      data-testid={`badge-${variant || 'default'}`}\n      {...props} \n    />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1842,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4419,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, timestamp, jsonb, index, uniqueIndex, customType } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nconst vector = customType<{ data: number[]; driverData: string }>({\n  dataType() {\n    return \"vector(1536)\";\n  },\n  toDriver(value: number[]): string {\n    return `[${value.join(\",\")}]`;\n  },\n  fromDriver(value: string): number[] {\n    return value.slice(1, -1).split(\",\").map(Number);\n  },\n});\n\n// Session storage table for Replit Auth\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)]\n);\n\n// Users table (compatible with Replit Auth)\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\"),\n  password: text(\"password\"),\n  email: text(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  phone: varchar(\"phone\"),\n  company: varchar(\"company\"),\n  role: text(\"role\").default(\"user\"),\n  plan: text(\"plan\").default(\"free\"),\n  status: text(\"status\").default(\"active\"),\n  queryCount: integer(\"query_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertUserSchema = createInsertSchema(users).pick({\n  username: true,\n  password: true,\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\n// User Settings table - one settings record per user\nexport const responsePreferencesSchema = z.object({\n  responseStyle: z.enum(['default', 'formal', 'casual', 'concise']).default('default'),\n  responseTone: z.string().default(''),\n  customInstructions: z.string().default(''),\n});\n\nexport const userProfileSchema = z.object({\n  nickname: z.string().default(''),\n  occupation: z.string().default(''),\n  bio: z.string().default(''),\n});\n\nexport const featureFlagsSchema = z.object({\n  memoryEnabled: z.boolean().default(true),\n  recordingHistoryEnabled: z.boolean().default(false),\n  webSearchAuto: z.boolean().default(true),\n  codeInterpreterEnabled: z.boolean().default(true),\n  canvasEnabled: z.boolean().default(true),\n  voiceEnabled: z.boolean().default(true),\n  voiceAdvanced: z.boolean().default(false),\n  connectorSearchAuto: z.boolean().default(false),\n});\n\nexport const privacySettingsSchema = z.object({\n  trainingOptIn: z.boolean().default(false),\n  remoteBrowserDataAccess: z.boolean().default(false),\n});\n\nexport const userSettings = pgTable(\"user_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  responsePreferences: jsonb(\"response_preferences\").$type<z.infer<typeof responsePreferencesSchema>>(),\n  userProfile: jsonb(\"user_profile\").$type<z.infer<typeof userProfileSchema>>(),\n  featureFlags: jsonb(\"feature_flags\").$type<z.infer<typeof featureFlagsSchema>>(),\n  privacySettings: jsonb(\"privacy_settings\").$type<z.infer<typeof privacySettingsSchema>>(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"user_settings_user_id_idx\").on(table.userId),\n]);\n\nexport const insertUserSettingsSchema = createInsertSchema(userSettings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  responsePreferences: responsePreferencesSchema.optional(),\n  userProfile: userProfileSchema.optional(),\n  featureFlags: featureFlagsSchema.optional(),\n  privacySettings: privacySettingsSchema.optional(),\n});\n\nexport type InsertUserSettings = z.infer<typeof insertUserSettingsSchema>;\nexport type UserSettings = typeof userSettings.$inferSelect;\n\n// ========================================\n// Integration Management Tables\n// ========================================\n\n// Integration Providers - Catalog of available providers\nexport const integrationProviders = pgTable(\"integration_providers\", {\n  id: varchar(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  iconUrl: text(\"icon_url\"),\n  authType: text(\"auth_type\").notNull().default(\"oauth2\"),\n  authConfig: jsonb(\"auth_config\"),\n  category: text(\"category\").default(\"general\"),\n  isActive: text(\"is_active\").default(\"true\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertIntegrationProviderSchema = createInsertSchema(integrationProviders).omit({\n  createdAt: true,\n});\n\nexport type InsertIntegrationProvider = z.infer<typeof insertIntegrationProviderSchema>;\nexport type IntegrationProvider = typeof integrationProviders.$inferSelect;\n\n// Integration Accounts - User's connected accounts per provider\nexport const integrationAccounts = pgTable(\"integration_accounts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  providerId: varchar(\"provider_id\").notNull().references(() => integrationProviders.id),\n  externalUserId: text(\"external_user_id\"),\n  displayName: text(\"display_name\"),\n  email: text(\"email\"),\n  avatarUrl: text(\"avatar_url\"),\n  accessToken: text(\"access_token\"),\n  refreshToken: text(\"refresh_token\"),\n  tokenExpiresAt: timestamp(\"token_expires_at\"),\n  scopes: text(\"scopes\"),\n  isDefault: text(\"is_default\").default(\"false\"),\n  status: text(\"status\").default(\"active\"),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"integration_accounts_user_id_idx\").on(table.userId),\n  index(\"integration_accounts_provider_idx\").on(table.providerId),\n]);\n\nexport const insertIntegrationAccountSchema = createInsertSchema(integrationAccounts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertIntegrationAccount = z.infer<typeof insertIntegrationAccountSchema>;\nexport type IntegrationAccount = typeof integrationAccounts.$inferSelect;\n\n// Integration Tools - Available tools/actions per provider\nexport const integrationTools = pgTable(\"integration_tools\", {\n  id: varchar(\"id\").primaryKey(),\n  providerId: varchar(\"provider_id\").notNull().references(() => integrationProviders.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  actionSchema: jsonb(\"action_schema\"),\n  resultSchema: jsonb(\"result_schema\"),\n  requiredScopes: text(\"required_scopes\").array(),\n  dataAccessLevel: text(\"data_access_level\").default(\"read\"),\n  rateLimit: jsonb(\"rate_limit\"),\n  confirmationRequired: text(\"confirmation_required\").default(\"false\"),\n  isActive: text(\"is_active\").default(\"true\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertIntegrationToolSchema = createInsertSchema(integrationTools).omit({\n  createdAt: true,\n});\n\nexport type InsertIntegrationTool = z.infer<typeof insertIntegrationToolSchema>;\nexport type IntegrationTool = typeof integrationTools.$inferSelect;\n\n// Integration Policies - User preferences for enabled apps/tools\nexport const integrationPolicies = pgTable(\"integration_policies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  enabledApps: jsonb(\"enabled_apps\").$type<string[]>().default([]),\n  enabledTools: jsonb(\"enabled_tools\").$type<string[]>().default([]),\n  disabledTools: jsonb(\"disabled_tools\").$type<string[]>().default([]),\n  resourceScopes: jsonb(\"resource_scopes\"),\n  autoConfirmPolicy: text(\"auto_confirm_policy\").default(\"ask\"),\n  sandboxMode: text(\"sandbox_mode\").default(\"false\"),\n  maxParallelCalls: integer(\"max_parallel_calls\").default(3),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"integration_policies_user_id_idx\").on(table.userId),\n]);\n\nexport const insertIntegrationPolicySchema = createInsertSchema(integrationPolicies).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertIntegrationPolicy = z.infer<typeof insertIntegrationPolicySchema>;\nexport type IntegrationPolicy = typeof integrationPolicies.$inferSelect;\n\n// Shared Links - For sharing resources with external users\nexport const sharedLinks = pgTable(\"shared_links\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  resourceType: text(\"resource_type\").notNull(), // 'chat', 'file', 'artifact'\n  resourceId: varchar(\"resource_id\").notNull(),\n  token: varchar(\"token\").notNull().unique(),\n  scope: text(\"scope\").default(\"link_only\"), // 'public', 'link_only', 'organization'\n  permissions: text(\"permissions\").default(\"read\"), // 'read', 'read_write'\n  expiresAt: timestamp(\"expires_at\"),\n  lastAccessedAt: timestamp(\"last_accessed_at\"),\n  accessCount: integer(\"access_count\").default(0),\n  isRevoked: text(\"is_revoked\").default(\"false\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"shared_links_user_idx\").on(table.userId),\n  index(\"shared_links_token_idx\").on(table.token),\n  index(\"shared_links_resource_idx\").on(table.resourceType, table.resourceId),\n]);\n\nexport const insertSharedLinkSchema = createInsertSchema(sharedLinks).omit({\n  id: true,\n  createdAt: true,\n  accessCount: true,\n  lastAccessedAt: true,\n});\n\nexport type InsertSharedLink = z.infer<typeof insertSharedLinkSchema>;\nexport type SharedLink = typeof sharedLinks.$inferSelect;\n\n// Consent Logs - Audit trail for privacy consent changes\nexport const consentLogs = pgTable(\"consent_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  consentType: text(\"consent_type\").notNull(), // 'training_opt_in', 'remote_browser_access'\n  value: text(\"value\").notNull(), // 'true' or 'false'\n  consentVersion: text(\"consent_version\").default(\"1.0\"),\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"consent_logs_user_idx\").on(table.userId),\n]);\n\nexport type ConsentLog = typeof consentLogs.$inferSelect;\n\n// Tool Call Logs - Audit log for tool invocations\nexport const toolCallLogs = pgTable(\"tool_call_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  chatId: varchar(\"chat_id\"),\n  toolId: varchar(\"tool_id\").notNull(),\n  providerId: varchar(\"provider_id\").notNull(),\n  accountId: varchar(\"account_id\").references(() => integrationAccounts.id),\n  inputRedacted: jsonb(\"input_redacted\"),\n  outputRedacted: jsonb(\"output_redacted\"),\n  status: text(\"status\").notNull(),\n  errorCode: text(\"error_code\"),\n  errorMessage: text(\"error_message\"),\n  latencyMs: integer(\"latency_ms\"),\n  idempotencyKey: text(\"idempotency_key\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"tool_call_logs_user_id_idx\").on(table.userId),\n  index(\"tool_call_logs_tool_id_idx\").on(table.toolId),\n  index(\"tool_call_logs_created_at_idx\").on(table.createdAt),\n]);\n\nexport const insertToolCallLogSchema = createInsertSchema(toolCallLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertToolCallLog = z.infer<typeof insertToolCallLogSchema>;\nexport type ToolCallLog = typeof toolCallLogs.$inferSelect;\n\nexport const files = pgTable(\"files\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\"),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(),\n  size: integer(\"size\").notNull(),\n  storagePath: text(\"storage_path\").notNull(),\n  status: text(\"status\").notNull().default(\"pending\"),\n  processingProgress: integer(\"processing_progress\").default(0),\n  processingError: text(\"processing_error\"),\n  completedAt: timestamp(\"completed_at\"),\n  totalChunks: integer(\"total_chunks\"),\n  uploadedChunks: integer(\"uploaded_chunks\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertFileSchema = createInsertSchema(files).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  processingProgress: z.number().min(0).max(100).optional(),\n  processingError: z.string().nullable().optional(),\n  completedAt: z.date().nullable().optional(),\n  totalChunks: z.number().nullable().optional(),\n  uploadedChunks: z.number().optional(),\n});\n\nexport type InsertFile = z.infer<typeof insertFileSchema>;\nexport type File = typeof files.$inferSelect;\n\nexport const fileJobs = pgTable(\"file_jobs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  fileId: varchar(\"file_id\").notNull().references(() => files.id, { onDelete: \"cascade\" }),\n  status: text(\"status\").notNull().default(\"pending\"),\n  retries: integer(\"retries\").default(0),\n  lastError: text(\"last_error\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"file_jobs_file_id_idx\").on(table.fileId),\n  index(\"file_jobs_status_idx\").on(table.status),\n]);\n\nexport const insertFileJobSchema = createInsertSchema(fileJobs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertFileJob = z.infer<typeof insertFileJobSchema>;\nexport type FileJob = typeof fileJobs.$inferSelect;\n\nexport const fileChunks = pgTable(\"file_chunks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  fileId: varchar(\"file_id\").notNull().references(() => files.id, { onDelete: \"cascade\" }),\n  content: text(\"content\").notNull(),\n  embedding: vector(\"embedding\"),\n  pageNumber: integer(\"page_number\"),\n  chunkIndex: integer(\"chunk_index\").notNull(),\n  metadata: jsonb(\"metadata\"),\n}, (table) => [\n  index(\"file_chunks_file_id_idx\").on(table.fileId),\n]);\n\nexport const insertFileChunkSchema = createInsertSchema(fileChunks).omit({\n  id: true,\n});\n\nexport type InsertFileChunk = z.infer<typeof insertFileChunkSchema>;\nexport type FileChunk = typeof fileChunks.$inferSelect;\n\n// Agent Web Navigation Tables\nexport const agentRuns = pgTable(\"agent_runs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\"),\n  status: text(\"status\").notNull().default(\"pending\"), // pending, running, completed, failed, cancelled\n  routerDecision: text(\"router_decision\"), // llm, agent, hybrid\n  objective: text(\"objective\"),\n  startedAt: timestamp(\"started_at\").defaultNow().notNull(),\n  completedAt: timestamp(\"completed_at\"),\n  error: text(\"error\"),\n}, (table) => [\n  index(\"agent_runs_conversation_idx\").on(table.conversationId),\n  index(\"agent_runs_status_idx\").on(table.status),\n]);\n\nexport const insertAgentRunSchema = createInsertSchema(agentRuns).omit({\n  id: true,\n  startedAt: true,\n});\n\nexport type InsertAgentRun = z.infer<typeof insertAgentRunSchema>;\nexport type AgentRun = typeof agentRuns.$inferSelect;\n\nexport const agentSteps = pgTable(\"agent_steps\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  runId: varchar(\"run_id\").notNull().references(() => agentRuns.id, { onDelete: \"cascade\" }),\n  stepType: text(\"step_type\").notNull(), // navigate, extract, click, input, screenshot, document\n  url: text(\"url\"),\n  detail: jsonb(\"detail\"),\n  screenshot: text(\"screenshot\"), // storage path\n  startedAt: timestamp(\"started_at\").defaultNow().notNull(),\n  completedAt: timestamp(\"completed_at\"),\n  success: text(\"success\").default(\"pending\"), // pending, success, failed\n  error: text(\"error\"),\n  stepIndex: integer(\"step_index\").notNull().default(0),\n}, (table) => [\n  index(\"agent_steps_run_idx\").on(table.runId),\n]);\n\nexport const insertAgentStepSchema = createInsertSchema(agentSteps).omit({\n  id: true,\n  startedAt: true,\n});\n\nexport type InsertAgentStep = z.infer<typeof insertAgentStepSchema>;\nexport type AgentStep = typeof agentSteps.$inferSelect;\n\nexport const agentAssets = pgTable(\"agent_assets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  runId: varchar(\"run_id\").notNull().references(() => agentRuns.id, { onDelete: \"cascade\" }),\n  stepId: varchar(\"step_id\").references(() => agentSteps.id, { onDelete: \"set null\" }),\n  assetType: text(\"asset_type\").notNull(), // screenshot, document, extracted_content\n  storagePath: text(\"storage_path\"),\n  content: text(\"content\"),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"agent_assets_run_idx\").on(table.runId),\n]);\n\nexport const insertAgentAssetSchema = createInsertSchema(agentAssets).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAgentAsset = z.infer<typeof insertAgentAssetSchema>;\nexport type AgentAsset = typeof agentAssets.$inferSelect;\n\nexport const cachedPages = pgTable(\"cached_pages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  urlHash: text(\"url_hash\").notNull().unique(),\n  url: text(\"url\").notNull(),\n  title: text(\"title\"),\n  content: text(\"content\"),\n  fetchedAt: timestamp(\"fetched_at\").defaultNow().notNull(),\n  expiresAt: timestamp(\"expires_at\"),\n}, (table) => [\n  index(\"cached_pages_url_hash_idx\").on(table.urlHash),\n]);\n\nexport const insertCachedPageSchema = createInsertSchema(cachedPages).omit({\n  id: true,\n  fetchedAt: true,\n});\n\nexport type InsertCachedPage = z.infer<typeof insertCachedPageSchema>;\nexport type CachedPage = typeof cachedPages.$inferSelect;\n\nexport const domainPolicies = pgTable(\"domain_policies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  domain: text(\"domain\").notNull().unique(),\n  allowNavigation: text(\"allow_navigation\").notNull().default(\"true\"),\n  cookiePolicy: text(\"cookie_policy\").default(\"accept\"), // accept, reject, essential\n  rateLimit: integer(\"rate_limit\").default(10), // requests per minute\n  customHeaders: jsonb(\"custom_headers\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertDomainPolicySchema = createInsertSchema(domainPolicies).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertDomainPolicy = z.infer<typeof insertDomainPolicySchema>;\nexport type DomainPolicy = typeof domainPolicies.$inferSelect;\n\nexport const chats = pgTable(\"chats\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\"),\n  title: text(\"title\").notNull().default(\"New Chat\"),\n  gptId: varchar(\"gpt_id\"),\n  archived: text(\"archived\").default(\"false\"),\n  hidden: text(\"hidden\").default(\"false\"),\n  deletedAt: timestamp(\"deleted_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"chats_user_idx\").on(table.userId),\n]);\n\nexport const insertChatSchema = createInsertSchema(chats).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertChat = z.infer<typeof insertChatSchema>;\nexport type Chat = typeof chats.$inferSelect;\n\nexport const chatMessages = pgTable(\"chat_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  chatId: varchar(\"chat_id\").notNull().references(() => chats.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(), // \"user\" or \"assistant\"\n  content: text(\"content\").notNull(),\n  attachments: jsonb(\"attachments\"), // array of attachments\n  sources: jsonb(\"sources\"), // array of sources\n  figmaDiagram: jsonb(\"figma_diagram\"), // Figma diagram data\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"chat_messages_chat_idx\").on(table.chatId),\n]);\n\nexport const insertChatMessageSchema = createInsertSchema(chatMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertChatMessage = z.infer<typeof insertChatMessageSchema>;\nexport type ChatMessage = typeof chatMessages.$inferSelect;\n\n// Chat sharing - participantes con acceso a chats específicos\nexport const chatShares = pgTable(\"chat_shares\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  chatId: varchar(\"chat_id\").notNull().references(() => chats.id, { onDelete: \"cascade\" }),\n  recipientUserId: varchar(\"recipient_user_id\"),\n  email: text(\"email\").notNull(),\n  role: text(\"role\").notNull().default(\"viewer\"), // owner, editor, viewer\n  invitedBy: varchar(\"invited_by\"),\n  notificationSent: text(\"notification_sent\").default(\"false\"),\n  acceptedAt: timestamp(\"accepted_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"chat_shares_chat_idx\").on(table.chatId),\n  index(\"chat_shares_email_idx\").on(table.email),\n  index(\"chat_shares_recipient_idx\").on(table.recipientUserId),\n]);\n\nexport const insertChatShareSchema = createInsertSchema(chatShares).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertChatShare = z.infer<typeof insertChatShareSchema>;\nexport type ChatShare = typeof chatShares.$inferSelect;\n\n// GPT Categories\nexport const gptCategories = pgTable(\"gpt_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  slug: text(\"slug\").notNull().unique(),\n  description: text(\"description\"),\n  icon: text(\"icon\"),\n  sortOrder: integer(\"sort_order\").default(0),\n});\n\nexport const insertGptCategorySchema = createInsertSchema(gptCategories).omit({\n  id: true,\n});\n\nexport type InsertGptCategory = z.infer<typeof insertGptCategorySchema>;\nexport type GptCategory = typeof gptCategories.$inferSelect;\n\n// Custom GPTs\nexport const gpts = pgTable(\"gpts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  slug: text(\"slug\").notNull().unique(),\n  description: text(\"description\"),\n  avatar: text(\"avatar\"),\n  categoryId: varchar(\"category_id\").references(() => gptCategories.id),\n  creatorId: varchar(\"creator_id\"),\n  visibility: text(\"visibility\").default(\"private\"), // private, public, unlisted\n  systemPrompt: text(\"system_prompt\").notNull(),\n  temperature: text(\"temperature\").default(\"0.7\"),\n  topP: text(\"top_p\").default(\"1\"),\n  maxTokens: integer(\"max_tokens\").default(4096),\n  welcomeMessage: text(\"welcome_message\"),\n  capabilities: jsonb(\"capabilities\"), // { webBrowsing: boolean, codeInterpreter: boolean, imageGeneration: boolean }\n  conversationStarters: jsonb(\"conversation_starters\"), // array of starter prompts\n  usageCount: integer(\"usage_count\").default(0),\n  version: integer(\"version\").default(1),\n  isPublished: text(\"is_published\").default(\"false\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"gpts_category_idx\").on(table.categoryId),\n  index(\"gpts_creator_idx\").on(table.creatorId),\n  index(\"gpts_visibility_idx\").on(table.visibility),\n]);\n\nexport const insertGptSchema = createInsertSchema(gpts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  usageCount: true,\n});\n\nexport type InsertGpt = z.infer<typeof insertGptSchema>;\nexport type Gpt = typeof gpts.$inferSelect;\n\n// GPT Versions for version control\nexport const gptVersions = pgTable(\"gpt_versions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  gptId: varchar(\"gpt_id\").notNull().references(() => gpts.id, { onDelete: \"cascade\" }),\n  versionNumber: integer(\"version_number\").notNull(),\n  systemPrompt: text(\"system_prompt\").notNull(),\n  temperature: text(\"temperature\").default(\"0.7\"),\n  topP: text(\"top_p\").default(\"1\"),\n  maxTokens: integer(\"max_tokens\").default(4096),\n  changeNotes: text(\"change_notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  createdBy: varchar(\"created_by\"),\n}, (table) => [\n  index(\"gpt_versions_gpt_idx\").on(table.gptId),\n]);\n\nexport const insertGptVersionSchema = createInsertSchema(gptVersions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertGptVersion = z.infer<typeof insertGptVersionSchema>;\nexport type GptVersion = typeof gptVersions.$inferSelect;\n\n// Admin Tables\n\n// AI Models Registry\nexport const aiModels = pgTable(\"ai_models\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  provider: text(\"provider\").notNull(),\n  modelId: text(\"model_id\").notNull(),\n  status: text(\"status\").default(\"active\"),\n  costPer1k: text(\"cost_per_1k\").default(\"0.00\"),\n  usagePercent: integer(\"usage_percent\").default(0),\n  description: text(\"description\"),\n  capabilities: jsonb(\"capabilities\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertAiModelSchema = createInsertSchema(aiModels).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAiModel = z.infer<typeof insertAiModelSchema>;\nexport type AiModel = typeof aiModels.$inferSelect;\n\n// Payments\nexport const payments = pgTable(\"payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  amount: text(\"amount\").notNull(),\n  currency: text(\"currency\").default(\"EUR\"),\n  status: text(\"status\").default(\"pending\"),\n  method: text(\"method\"),\n  description: text(\"description\"),\n  stripePaymentId: text(\"stripe_payment_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"payments_user_idx\").on(table.userId),\n]);\n\nexport const insertPaymentSchema = createInsertSchema(payments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPayment = z.infer<typeof insertPaymentSchema>;\nexport type Payment = typeof payments.$inferSelect;\n\n// Invoices\nexport const invoices = pgTable(\"invoices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  paymentId: varchar(\"payment_id\").references(() => payments.id),\n  invoiceNumber: text(\"invoice_number\").notNull(),\n  amount: text(\"amount\").notNull(),\n  currency: text(\"currency\").default(\"EUR\"),\n  status: text(\"status\").default(\"pending\"),\n  dueDate: timestamp(\"due_date\"),\n  paidAt: timestamp(\"paid_at\"),\n  pdfPath: text(\"pdf_path\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"invoices_user_idx\").on(table.userId),\n]);\n\nexport const insertInvoiceSchema = createInsertSchema(invoices).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertInvoice = z.infer<typeof insertInvoiceSchema>;\nexport type Invoice = typeof invoices.$inferSelect;\n\n// Platform Settings\nexport const platformSettings = pgTable(\"platform_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  key: text(\"key\").notNull().unique(),\n  value: text(\"value\"),\n  description: text(\"description\"),\n  category: text(\"category\").default(\"general\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertPlatformSettingSchema = createInsertSchema(platformSettings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertPlatformSetting = z.infer<typeof insertPlatformSettingSchema>;\nexport type PlatformSetting = typeof platformSettings.$inferSelect;\n\n// Audit Logs\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\"),\n  action: text(\"action\").notNull(),\n  resource: text(\"resource\"),\n  resourceId: varchar(\"resource_id\"),\n  details: jsonb(\"details\"),\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"audit_logs_user_idx\").on(table.userId),\n  index(\"audit_logs_action_idx\").on(table.action),\n]);\n\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\nexport type AuditLog = typeof auditLogs.$inferSelect;\n\n// Analytics Snapshots\nexport const analyticsSnapshots = pgTable(\"analytics_snapshots\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  date: timestamp(\"date\").notNull(),\n  totalUsers: integer(\"total_users\").default(0),\n  activeUsers: integer(\"active_users\").default(0),\n  totalQueries: integer(\"total_queries\").default(0),\n  revenue: text(\"revenue\").default(\"0\"),\n  newSignups: integer(\"new_signups\").default(0),\n  churnedUsers: integer(\"churned_users\").default(0),\n  avgResponseTime: integer(\"avg_response_time\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertAnalyticsSnapshotSchema = createInsertSchema(analyticsSnapshots).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAnalyticsSnapshot = z.infer<typeof insertAnalyticsSnapshotSchema>;\nexport type AnalyticsSnapshot = typeof analyticsSnapshots.$inferSelect;\n\n// Reports\nexport const reports = pgTable(\"reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(),\n  status: text(\"status\").default(\"pending\"),\n  parameters: jsonb(\"parameters\"),\n  filePath: text(\"file_path\"),\n  generatedBy: varchar(\"generated_by\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const insertReportSchema = createInsertSchema(reports).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertReport = z.infer<typeof insertReportSchema>;\nexport type Report = typeof reports.$inferSelect;\n\n// Chat Participants for sharing chats\nexport const chatParticipants = pgTable(\"chat_participants\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  chatId: varchar(\"chat_id\").notNull().references(() => chats.id, { onDelete: \"cascade\" }),\n  email: text(\"email\").notNull(),\n  role: text(\"role\").notNull().default(\"viewer\"), // owner, editor, viewer\n  invitedBy: varchar(\"invited_by\"),\n  invitedAt: timestamp(\"invited_at\").defaultNow().notNull(),\n  acceptedAt: timestamp(\"accepted_at\"),\n}, (table) => [\n  index(\"chat_participants_chat_idx\").on(table.chatId),\n  index(\"chat_participants_email_idx\").on(table.email),\n  uniqueIndex(\"chat_participants_unique_idx\").on(table.chatId, table.email),\n]);\n\nexport const insertChatParticipantSchema = createInsertSchema(chatParticipants).omit({\n  id: true,\n  invitedAt: true,\n});\n\nexport type InsertChatParticipant = z.infer<typeof insertChatParticipantSchema>;\nexport type ChatParticipant = typeof chatParticipants.$inferSelect;\n\n// Library Items - User media library\nexport const libraryItems = pgTable(\"library_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull(),\n  mediaType: text(\"media_type\").notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  storagePath: text(\"storage_path\").notNull(),\n  thumbnailPath: text(\"thumbnail_path\"),\n  mimeType: text(\"mime_type\"),\n  size: integer(\"size\"),\n  metadata: jsonb(\"metadata\"),\n  sourceChatId: varchar(\"source_chat_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"library_items_user_idx\").on(table.userId),\n  index(\"library_items_type_idx\").on(table.userId, table.mediaType),\n]);\n\nexport const insertLibraryItemSchema = createInsertSchema(libraryItems).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertLibraryItem = z.infer<typeof insertLibraryItemSchema>;\nexport type LibraryItem = typeof libraryItems.$inferSelect;\n\n// Code Interpreter Runs\nexport const codeInterpreterRuns = pgTable(\"code_interpreter_runs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\"),\n  userId: varchar(\"user_id\"),\n  code: text(\"code\").notNull(),\n  language: text(\"language\").notNull().default(\"python\"),\n  status: text(\"status\").notNull().default(\"pending\"), // pending, running, success, error\n  stdout: text(\"stdout\"),\n  stderr: text(\"stderr\"),\n  executionTimeMs: integer(\"execution_time_ms\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"code_runs_conversation_idx\").on(table.conversationId),\n  index(\"code_runs_user_idx\").on(table.userId),\n]);\n\nexport const insertCodeInterpreterRunSchema = createInsertSchema(codeInterpreterRuns).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertCodeInterpreterRun = z.infer<typeof insertCodeInterpreterRunSchema>;\nexport type CodeInterpreterRun = typeof codeInterpreterRuns.$inferSelect;\n\n// ========================================\n// Notification Preferences System\n// ========================================\n\n// Notification Event Types Catalog\nexport const notificationEventTypes = pgTable(\"notification_event_types\", {\n  id: varchar(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  category: text(\"category\").notNull(), // ai_updates, tasks, social, product\n  severity: text(\"severity\").default(\"normal\"), // low, normal, high, critical\n  defaultOptIn: text(\"default_opt_in\").default(\"true\"),\n  defaultChannels: text(\"default_channels\").default(\"push\"), // none, push, email, push_email\n  frequencyCap: integer(\"frequency_cap\"), // max notifications per hour\n  icon: text(\"icon\"),\n  sortOrder: integer(\"sort_order\").default(0),\n});\n\nexport const insertNotificationEventTypeSchema = createInsertSchema(notificationEventTypes);\nexport type InsertNotificationEventType = z.infer<typeof insertNotificationEventTypeSchema>;\nexport type NotificationEventType = typeof notificationEventTypes.$inferSelect;\n\n// User Notification Preferences\nexport const notificationPreferences = pgTable(\"notification_preferences\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull(),\n  eventTypeId: varchar(\"event_type_id\").notNull().references(() => notificationEventTypes.id, { onDelete: \"cascade\" }),\n  channels: text(\"channels\").notNull().default(\"push\"), // none, push, email, push_email\n  enabled: text(\"enabled\").default(\"true\"),\n  quietHoursStart: text(\"quiet_hours_start\"), // HH:MM format\n  quietHoursEnd: text(\"quiet_hours_end\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"notification_prefs_user_idx\").on(table.userId),\n  uniqueIndex(\"notification_prefs_unique_idx\").on(table.userId, table.eventTypeId),\n]);\n\nexport const insertNotificationPreferenceSchema = createInsertSchema(notificationPreferences).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertNotificationPreference = z.infer<typeof insertNotificationPreferenceSchema>;\nexport type NotificationPreference = typeof notificationPreferences.$inferSelect;\n\n// Notification Delivery Log\nexport const notificationLogs = pgTable(\"notification_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: varchar(\"event_id\").notNull(), // idempotency key\n  userId: varchar(\"user_id\").notNull(),\n  eventTypeId: varchar(\"event_type_id\").notNull(),\n  channel: text(\"channel\").notNull(), // push, email\n  status: text(\"status\").notNull().default(\"pending\"), // pending, sent, delivered, failed, bounced\n  providerResponse: jsonb(\"provider_response\"),\n  errorMessage: text(\"error_message\"),\n  retryCount: integer(\"retry_count\").default(0),\n  sentAt: timestamp(\"sent_at\"),\n  deliveredAt: timestamp(\"delivered_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"notification_logs_user_idx\").on(table.userId),\n  index(\"notification_logs_event_idx\").on(table.eventId),\n  uniqueIndex(\"notification_logs_idempotency_idx\").on(table.eventId, table.channel),\n]);\n\nexport const insertNotificationLogSchema = createInsertSchema(notificationLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertNotificationLog = z.infer<typeof insertNotificationLogSchema>;\nexport type NotificationLog = typeof notificationLogs.$inferSelect;\n\n// Code Interpreter Artifacts (generated files, charts, etc.)\nexport const codeInterpreterArtifacts = pgTable(\"code_interpreter_artifacts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  runId: varchar(\"run_id\").notNull().references(() => codeInterpreterRuns.id, { onDelete: \"cascade\" }),\n  type: text(\"type\").notNull(), // image, file, data\n  name: text(\"name\").notNull(),\n  data: text(\"data\"), // base64 encoded for images, or text content\n  mimeType: text(\"mime_type\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"code_artifacts_run_idx\").on(table.runId),\n]);\n\nexport const insertCodeInterpreterArtifactSchema = createInsertSchema(codeInterpreterArtifacts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertCodeInterpreterArtifact = z.infer<typeof insertCodeInterpreterArtifactSchema>;\nexport type CodeInterpreterArtifact = typeof codeInterpreterArtifacts.$inferSelect;\n","path":null,"size_bytes":37121,"size_tokens":null},"client/src/hooks/use-chats.ts":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { format, isToday, isYesterday, isThisWeek, isThisYear } from \"date-fns\";\n\nexport interface FigmaDiagram {\n  nodes: Array<{\n    id: string;\n    type: \"start\" | \"end\" | \"process\" | \"decision\";\n    label: string;\n    x: number;\n    y: number;\n  }>;\n  connections: Array<{\n    from: string;\n    to: string;\n    label?: string;\n  }>;\n  title?: string;\n}\n\nexport interface Message {\n  id: string;\n  role: \"user\" | \"assistant\";\n  content: string;\n  timestamp: Date;\n  isThinking?: boolean;\n  steps?: { title: string; status: \"pending\" | \"loading\" | \"complete\" }[];\n  attachments?: { type: \"word\" | \"excel\" | \"ppt\" | \"image\" | \"pdf\" | \"text\" | \"code\" | \"archive\" | \"unknown\"; name: string; mimeType?: string; imageUrl?: string; storagePath?: string; fileId?: string }[];\n  sources?: { fileName: string; content: string }[];\n  figmaDiagram?: FigmaDiagram;\n  generatedImage?: string;\n}\n\nexport interface Chat {\n  id: string;\n  stableKey: string; // Stable key for React that doesn't change when pending -> real ID\n  title: string;\n  timestamp: number;\n  messages: Message[];\n  archived?: boolean;\n  hidden?: boolean;\n}\n\nconst STORAGE_KEY = \"sira-gpt-chats\";\nconst PENDING_CHAT_PREFIX = \"pending-\";\nconst pendingToRealIdMap = new Map<string, string>();\nconst pendingMessageQueue = new Map<string, Message[]>();\nconst chatCreationInProgress = new Set<string>();\n\n// Separate in-memory store for generated images (not persisted to localStorage)\nconst generatedImagesStore = new Map<string, string>();\n\nexport function storeGeneratedImage(messageId: string, imageData: string): void {\n  generatedImagesStore.set(messageId, imageData);\n}\n\nexport function getGeneratedImage(messageId: string): string | undefined {\n  return generatedImagesStore.get(messageId);\n}\n\nexport function useChats() {\n  const [chats, setChats] = useState<Chat[]>([]);\n  const [activeChatId, setActiveChatId] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const loadChatsFromServer = useCallback(async () => {\n    try {\n      const res = await fetch(\"/api/chats/bulk\");\n      if (!res.ok) throw new Error(\"Failed to load chats\");\n      const serverChats = await res.json();\n      \n      const formattedChats: Chat[] = serverChats.map((chat: any) => ({\n        id: chat.id,\n        stableKey: `stable-${chat.id}`,\n        title: chat.title,\n        timestamp: new Date(chat.updatedAt).getTime(),\n        archived: chat.archived === \"true\",\n        hidden: chat.hidden === \"true\",\n        messages: (chat.messages || []).map((msg: any) => ({\n          id: msg.id,\n          role: msg.role,\n          content: msg.content,\n          timestamp: new Date(msg.createdAt),\n          attachments: msg.attachments,\n          sources: msg.sources,\n          figmaDiagram: msg.figmaDiagram,\n        })),\n      }));\n      \n      return formattedChats.sort((a, b) => b.timestamp - a.timestamp);\n    } catch (error) {\n      console.error(\"Error loading chats from server:\", error);\n      return null;\n    }\n  }, []);\n\n  useEffect(() => {\n    const initChats = async () => {\n      setIsLoading(true);\n      \n      const serverChats = await loadChatsFromServer();\n      \n      if (serverChats && serverChats.length > 0) {\n        setChats(serverChats);\n        try {\n          localStorage.setItem(STORAGE_KEY, JSON.stringify(serverChats));\n        } catch (e) {\n          console.warn(\"Failed to cache chats to localStorage:\", e);\n          localStorage.removeItem(STORAGE_KEY);\n        }\n        if (!activeChatId) {\n          setActiveChatId(serverChats[0]?.id || null);\n        }\n      } else {\n        const saved = localStorage.getItem(STORAGE_KEY);\n        if (saved) {\n          try {\n            const parsed = JSON.parse(saved);\n            const restored = parsed.map((chat: any) => ({\n              ...chat,\n              stableKey: chat.stableKey || `stable-${chat.id}`, // Ensure stableKey exists\n              messages: chat.messages.map((msg: any) => ({\n                ...msg,\n                timestamp: new Date(msg.timestamp)\n              }))\n            }));\n            setChats(restored);\n            if (!activeChatId && restored.length > 0) {\n              setActiveChatId(restored[0]?.id || null);\n            }\n          } catch (e) {\n            console.error(\"Failed to parse local chats\", e);\n          }\n        }\n      }\n      \n      setIsLoading(false);\n    };\n    \n    initChats();\n  }, []);\n\n  useEffect(() => {\n    if (!isLoading && chats.length > 0) {\n      // Strip sources from messages to save localStorage space\n      const chatsForStorage = chats.map(chat => ({\n        ...chat,\n        messages: chat.messages.map(msg => ({\n          ...msg,\n          sources: undefined, // Don't store sources in localStorage - they take too much space\n          generatedImage: undefined // Don't store generated images in localStorage - they're too large\n        }))\n      }));\n      try {\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(chatsForStorage));\n      } catch (e) {\n        console.warn(\"Failed to save chats to localStorage:\", e);\n        // If storage is full, clear old data and try again\n        localStorage.removeItem(STORAGE_KEY);\n      }\n    }\n  }, [chats, isLoading]);\n\n  const createChat = useCallback((): { pendingId: string; stableKey: string } => {\n    const pendingId = `${PENDING_CHAT_PREFIX}${Date.now()}`;\n    const stableKey = `stable-${Date.now()}`; // Stable key that won't change\n    const pendingChat: Chat = {\n      id: pendingId,\n      stableKey,\n      title: \"Nuevo Chat\",\n      timestamp: Date.now(),\n      messages: []\n    };\n    setChats(prev => [pendingChat, ...prev]);\n    setActiveChatId(pendingId);\n    return { pendingId, stableKey };\n  }, []);\n\n  const flushPendingMessages = async (pendingId: string, realChatId: string) => {\n    while (pendingMessageQueue.has(pendingId) && pendingMessageQueue.get(pendingId)!.length > 0) {\n      const queuedMessages = [...(pendingMessageQueue.get(pendingId) || [])];\n      pendingMessageQueue.set(pendingId, []);\n      \n      for (const msg of queuedMessages) {\n        try {\n          await fetch(`/api/chats/${realChatId}/messages`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({\n              role: msg.role,\n              content: msg.content,\n              attachments: msg.attachments,\n              sources: msg.sources,\n              figmaDiagram: msg.figmaDiagram\n            })\n          });\n        } catch (error) {\n          console.error(\"Error flushing queued message:\", error);\n        }\n      }\n    }\n    pendingMessageQueue.delete(pendingId);\n  };\n\n  const addMessage = useCallback(async (chatId: string, message: Message) => {\n    const resolvedChatId = pendingToRealIdMap.get(chatId) || chatId;\n    const isPending = resolvedChatId.startsWith(PENDING_CHAT_PREFIX);\n    const isCreatingChat = chatCreationInProgress.has(chatId) || chatCreationInProgress.has(resolvedChatId);\n    \n    const title = message.role === \"user\" && message.content\n      ? message.content.slice(0, 30) + (message.content.length > 30 ? \"...\" : \"\")\n      : \"Nuevo Chat\";\n\n    setChats(prev => prev.map(chat => {\n      const matchId = chat.id === chatId || chat.id === resolvedChatId;\n      if (matchId) {\n        const isFirstMessage = chat.messages.length === 0;\n        return {\n          ...chat,\n          messages: [...chat.messages, message],\n          title: isFirstMessage && message.role === \"user\" ? title : chat.title,\n          timestamp: Date.now()\n        };\n      }\n      return chat;\n    }));\n\n    if (isPending && message.role === \"user\" && !isCreatingChat) {\n      chatCreationInProgress.add(chatId);\n      const queue = pendingMessageQueue.get(chatId) || [];\n      queue.push(message);\n      pendingMessageQueue.set(chatId, queue);\n      \n      try {\n        const res = await fetch(\"/api/chats\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ title })\n        });\n        \n        if (res.ok) {\n          const newChat = await res.json();\n          const realChatId = newChat.id;\n          \n          pendingToRealIdMap.set(chatId, realChatId);\n          \n          setChats(prev => prev.map(chat => {\n            if (chat.id === chatId) {\n              return { ...chat, id: realChatId };\n            }\n            return chat;\n          }));\n          setActiveChatId(realChatId);\n\n          await flushPendingMessages(chatId, realChatId);\n        } else {\n          // If server creation fails (e.g., 401), keep using local-only chat\n          // Clear the pending queue to prevent messages from being lost\n          pendingMessageQueue.delete(chatId);\n        }\n      } catch (error) {\n        console.error(\"Error creating chat on first message:\", error);\n        // Clear the pending queue on error to prevent messages from being lost\n        pendingMessageQueue.delete(chatId);\n      } finally {\n        chatCreationInProgress.delete(chatId);\n      }\n    } else if (isPending || isCreatingChat) {\n      const queueKey = chatCreationInProgress.has(chatId) ? chatId : resolvedChatId;\n      const queue = pendingMessageQueue.get(queueKey) || [];\n      queue.push(message);\n      pendingMessageQueue.set(queueKey, queue);\n    } else {\n      try {\n        await fetch(`/api/chats/${resolvedChatId}/messages`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            role: message.role,\n            content: message.content,\n            attachments: message.attachments,\n            sources: message.sources,\n            figmaDiagram: message.figmaDiagram\n          })\n        });\n      } catch (error) {\n        console.error(\"Error saving message to server:\", error);\n      }\n    }\n  }, []);\n\n  const deleteChat = useCallback(async (chatId: string, e?: React.MouseEvent) => {\n    e?.stopPropagation();\n    \n    setChats(prev => {\n      const newChats = prev.filter(c => c.id !== chatId);\n      if (activeChatId === chatId) {\n        setActiveChatId(newChats[0]?.id || null);\n      }\n      return newChats;\n    });\n\n    try {\n      await fetch(`/api/chats/${chatId}`, { method: \"DELETE\" });\n    } catch (error) {\n      console.error(\"Error deleting chat from server:\", error);\n    }\n  }, [activeChatId]);\n\n  const editChatTitle = useCallback(async (chatId: string, newTitle: string) => {\n    setChats(prev => prev.map(chat => \n      chat.id === chatId ? { ...chat, title: newTitle } : chat\n    ));\n\n    try {\n      await fetch(`/api/chats/${chatId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ title: newTitle })\n      });\n    } catch (error) {\n      console.error(\"Error updating chat title:\", error);\n    }\n  }, []);\n\n  const archiveChat = useCallback(async (chatId: string, e?: React.MouseEvent) => {\n    e?.stopPropagation();\n    \n    const chat = chats.find(c => c.id === chatId);\n    const newArchived = !chat?.archived;\n    \n    setChats(prev => prev.map(c => \n      c.id === chatId ? { ...c, archived: newArchived } : c\n    ));\n\n    try {\n      await fetch(`/api/chats/${chatId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ archived: newArchived })\n      });\n    } catch (error) {\n      console.error(\"Error archiving chat:\", error);\n    }\n  }, [chats]);\n\n  const hideChat = useCallback(async (chatId: string, e?: React.MouseEvent) => {\n    e?.stopPropagation();\n    \n    const chat = chats.find(c => c.id === chatId);\n    const newHidden = !chat?.hidden;\n    \n    setChats(prev => prev.map(c => \n      c.id === chatId ? { ...c, hidden: newHidden } : c\n    ));\n\n    try {\n      await fetch(`/api/chats/${chatId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ hidden: newHidden })\n      });\n    } catch (error) {\n      console.error(\"Error hiding chat:\", error);\n    }\n  }, [chats]);\n\n  const activeChat = chats.find(c => c.id === activeChatId) || null;\n  const sortedChats = [...chats].sort((a, b) => b.timestamp - a.timestamp);\n  const visibleChats = sortedChats.filter(c => !c.hidden);\n  const archivedChats = sortedChats.filter(c => c.archived && !c.hidden);\n  const hiddenChats = sortedChats.filter(c => c.hidden);\n\n  const getChatDateLabel = (timestamp: number) => {\n    const date = new Date(timestamp);\n    if (isToday(date)) return \"Today\";\n    if (isYesterday(date)) return \"Yesterday\";\n    if (isThisWeek(date)) return \"Previous 7 Days\";\n    if (isThisYear(date)) return format(date, \"MMM d\");\n    return format(date, \"yyyy\");\n  };\n\n  return {\n    chats: visibleChats,\n    allChats: sortedChats,\n    archivedChats,\n    hiddenChats,\n    activeChatId,\n    activeChat,\n    isLoading,\n    setActiveChatId,\n    createChat,\n    addMessage,\n    deleteChat,\n    editChatTitle,\n    archiveChat,\n    hideChat,\n    getChatDateLabel\n  };\n}\n","path":null,"size_bytes":13072,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-3.5 w-3.5 fill-primary\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1410,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":768,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n\" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n           // @replit: no hover, and add primary border\n           \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm border-destructive-border\",\n        outline:\n          // @replit Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color. Uses shadow-xs. no shadow on active\n          // No hover state\n          \" border [border-color:var(--button-outline)] shadow-xs active:shadow-none \",\n        secondary:\n          // @replit border, no hover, no shadow, secondary border.\n          \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // @replit no hover, transparent border\n        ghost: \"border border-transparent\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        // @replit changed sizes\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2356,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent, DialogTitle } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\ninterface CommandDialogProps extends DialogProps {\n  title?: string;\n}\n\nconst CommandDialog = ({ children, title = \"Command Menu\", ...props }: CommandDialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0\">\n        <DialogTitle className=\"sr-only\">{title}</DialogTitle>\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":5066,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport {\n  ChevronDownIcon,\n  ChevronLeftIcon,\n  ChevronRightIcon,\n} from \"lucide-react\"\nimport { DayButton, DayPicker, getDefaultClassNames } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button, buttonVariants } from \"@/components/ui/button\"\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  captionLayout = \"label\",\n  buttonVariant = \"ghost\",\n  formatters,\n  components,\n  ...props\n}: React.ComponentProps<typeof DayPicker> & {\n  buttonVariant?: React.ComponentProps<typeof Button>[\"variant\"]\n}) {\n  const defaultClassNames = getDefaultClassNames()\n\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\n        \"bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent\",\n        String.raw`rtl:**:[.rdp-button\\_next>svg]:rotate-180`,\n        String.raw`rtl:**:[.rdp-button\\_previous>svg]:rotate-180`,\n        className\n      )}\n      captionLayout={captionLayout}\n      formatters={{\n        formatMonthDropdown: (date) =>\n          date.toLocaleString(\"default\", { month: \"short\" }),\n        ...formatters,\n      }}\n      classNames={{\n        root: cn(\"w-fit\", defaultClassNames.root),\n        months: cn(\n          \"relative flex flex-col gap-4 md:flex-row\",\n          defaultClassNames.months\n        ),\n        month: cn(\"flex w-full flex-col gap-4\", defaultClassNames.month),\n        nav: cn(\n          \"absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1\",\n          defaultClassNames.nav\n        ),\n        button_previous: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_previous\n        ),\n        button_next: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_next\n        ),\n        month_caption: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]\",\n          defaultClassNames.month_caption\n        ),\n        dropdowns: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium\",\n          defaultClassNames.dropdowns\n        ),\n        dropdown_root: cn(\n          \"has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border\",\n          defaultClassNames.dropdown_root\n        ),\n        dropdown: cn(\n          \"bg-popover absolute inset-0 opacity-0\",\n          defaultClassNames.dropdown\n        ),\n        caption_label: cn(\n          \"select-none font-medium\",\n          captionLayout === \"label\"\n            ? \"text-sm\"\n            : \"[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5\",\n          defaultClassNames.caption_label\n        ),\n        table: \"w-full border-collapse\",\n        weekdays: cn(\"flex\", defaultClassNames.weekdays),\n        weekday: cn(\n          \"text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal\",\n          defaultClassNames.weekday\n        ),\n        week: cn(\"mt-2 flex w-full\", defaultClassNames.week),\n        week_number_header: cn(\n          \"w-[--cell-size] select-none\",\n          defaultClassNames.week_number_header\n        ),\n        week_number: cn(\n          \"text-muted-foreground select-none text-[0.8rem]\",\n          defaultClassNames.week_number\n        ),\n        day: cn(\n          \"group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md\",\n          defaultClassNames.day\n        ),\n        range_start: cn(\n          \"bg-accent rounded-l-md\",\n          defaultClassNames.range_start\n        ),\n        range_middle: cn(\"rounded-none\", defaultClassNames.range_middle),\n        range_end: cn(\"bg-accent rounded-r-md\", defaultClassNames.range_end),\n        today: cn(\n          \"bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none\",\n          defaultClassNames.today\n        ),\n        outside: cn(\n          \"text-muted-foreground aria-selected:text-muted-foreground\",\n          defaultClassNames.outside\n        ),\n        disabled: cn(\n          \"text-muted-foreground opacity-50\",\n          defaultClassNames.disabled\n        ),\n        hidden: cn(\"invisible\", defaultClassNames.hidden),\n        ...classNames,\n      }}\n      components={{\n        Root: ({ className, rootRef, ...props }) => {\n          return (\n            <div\n              data-slot=\"calendar\"\n              ref={rootRef}\n              className={cn(className)}\n              {...props}\n            />\n          )\n        },\n        Chevron: ({ className, orientation, ...props }) => {\n          if (orientation === \"left\") {\n            return (\n              <ChevronLeftIcon className={cn(\"size-4\", className)} {...props} />\n            )\n          }\n\n          if (orientation === \"right\") {\n            return (\n              <ChevronRightIcon\n                className={cn(\"size-4\", className)}\n                {...props}\n              />\n            )\n          }\n\n          return (\n            <ChevronDownIcon className={cn(\"size-4\", className)} {...props} />\n          )\n        },\n        DayButton: CalendarDayButton,\n        WeekNumber: ({ children, ...props }) => {\n          return (\n            <td {...props}>\n              <div className=\"flex size-[--cell-size] items-center justify-center text-center\">\n                {children}\n              </div>\n            </td>\n          )\n        },\n        ...components,\n      }}\n      {...props}\n    />\n  )\n}\n\nfunction CalendarDayButton({\n  className,\n  day,\n  modifiers,\n  ...props\n}: React.ComponentProps<typeof DayButton>) {\n  const defaultClassNames = getDefaultClassNames()\n\n  const ref = React.useRef<HTMLButtonElement>(null)\n  React.useEffect(() => {\n    if (modifiers.focused) ref.current?.focus()\n  }, [modifiers.focused])\n\n  return (\n    <Button\n      ref={ref}\n      variant=\"ghost\"\n      size=\"icon\"\n      data-day={day.date.toLocaleDateString()}\n      data-selected-single={\n        modifiers.selected &&\n        !modifiers.range_start &&\n        !modifiers.range_end &&\n        !modifiers.range_middle\n      }\n      data-range-start={modifiers.range_start}\n      data-range-end={modifiers.range_end}\n      data-range-middle={modifiers.range_middle}\n      className={cn(\n        \"data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70\",\n        defaultClassNames.day,\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport { Calendar, CalendarDayButton }\n","path":null,"size_bytes":7569,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { useEffect } from \"react\";\nimport { SettingsProvider } from \"@/contexts/SettingsContext\";\nimport Home from \"@/pages/home\";\nimport ProfilePage from \"@/pages/profile\";\nimport BillingPage from \"@/pages/billing\";\nimport SettingsPage from \"@/pages/settings\";\nimport PrivacyPage from \"@/pages/privacy\";\nimport AdminPage from \"@/pages/admin\";\nimport WorkspaceSettingsPage from \"@/pages/workspace-settings\";\nimport LoginPage from \"@/pages/login\";\nimport SignupPage from \"@/pages/signup\";\nimport LandingPage from \"@/pages/landing\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction AuthCallbackHandler() {\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"auth\") === \"success\") {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      window.history.replaceState({}, \"\", window.location.pathname);\n    }\n  }, []);\n  return null;\n}\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Home} />\n      <Route path=\"/welcome\" component={LandingPage} />\n      <Route path=\"/login\" component={LoginPage} />\n      <Route path=\"/signup\" component={SignupPage} />\n      <Route path=\"/profile\" component={ProfilePage} />\n      <Route path=\"/billing\" component={BillingPage} />\n      <Route path=\"/settings\" component={SettingsPage} />\n      <Route path=\"/privacy\" component={PrivacyPage} />\n      <Route path=\"/admin\" component={AdminPage} />\n      <Route path=\"/workspace-settings\" component={WorkspaceSettingsPage} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <SettingsProvider>\n        <TooltipProvider>\n          <AuthCallbackHandler />\n          <Toaster />\n          <Router />\n        </TooltipProvider>\n      </SettingsProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":2142,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-9 px-2 min-w-9\",\n        sm: \"h-8 px-1.5 min-w-8\",\n        lg: \"h-10 px-2.5 min-w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1486,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7406,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"import * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1237,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":649,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/empty.tsx":{"content":"import { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Empty({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty\"\n      className={cn(\n        \"flex min-w-0 flex-1 flex-col items-center justify-center gap-6 text-balance rounded-lg border-dashed p-6 text-center md:p-12\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-header\"\n      className={cn(\n        \"flex max-w-sm flex-col items-center gap-2 text-center\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst emptyMediaVariants = cva(\n  \"mb-2 flex shrink-0 items-center justify-center [&_svg]:pointer-events-none [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction EmptyMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof emptyMediaVariants>) {\n  return (\n    <div\n      data-slot=\"empty-icon\"\n      data-variant={variant}\n      className={cn(emptyMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-title\"\n      className={cn(\"text-lg font-medium tracking-tight\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <div\n      data-slot=\"empty-description\"\n      className={cn(\n        \"text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-content\"\n      className={cn(\n        \"flex w-full min-w-0 max-w-sm flex-col items-center gap-4 text-balance text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Empty,\n  EmptyHeader,\n  EmptyTitle,\n  EmptyDescription,\n  EmptyContent,\n  EmptyMedia,\n}\n","path":null,"size_bytes":2396,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { WebSocketServer, WebSocket } from \"ws\";\nimport { storage } from \"./storage\";\nimport { ObjectStorageService } from \"./objectStorage\";\nimport { processDocument } from \"./services/documentProcessing\";\nimport { chunkText, generateEmbeddingsBatch } from \"./embeddingService\";\nimport { StepUpdate } from \"./agent\";\nimport { browserSessionManager, SessionEvent } from \"./agent/browser\";\nimport { fileProcessingQueue, FileStatusUpdate } from \"./lib/fileProcessingQueue\";\nimport { setupAuth, registerAuthRoutes } from \"./replit_integrations/auth\";\nimport { pptExportRouter } from \"./routes/pptExport\";\nimport { createChatsRouter } from \"./routes/chatsRouter\";\nimport { createFilesRouter } from \"./routes/filesRouter\";\nimport { createGptRouter } from \"./routes/gptRouter\";\nimport { createDocumentsRouter } from \"./routes/documentsRouter\";\nimport { createAdminRouter } from \"./routes/adminRouter\";\nimport { createAgentRouter } from \"./routes/agentRouter\";\nimport { createFigmaRouter } from \"./routes/figmaRouter\";\nimport { createLibraryRouter } from \"./routes/libraryRouter\";\nimport { createCodeRouter } from \"./routes/codeRouter\";\nimport { createUserRouter } from \"./routes/userRouter\";\nimport { createChatAiRouter } from \"./routes/chatAiRouter\";\nimport { createAuthenticatedWebSocketHandler, AuthenticatedWebSocket } from \"./lib/wsAuth\";\n\nconst agentClients: Map<string, Set<WebSocket>> = new Map();\nconst browserClients: Map<string, Set<WebSocket>> = new Map();\nconst fileStatusClients: Map<string, Set<WebSocket>> = new Map();\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  await setupAuth(app);\n  registerAuthRoutes(app);\n  \n  app.use(\"/api/ppt\", pptExportRouter);\n  app.use(\"/api\", createChatsRouter());\n  app.use(createFilesRouter());\n  app.use(\"/api\", createGptRouter());\n  app.use(\"/api/documents\", createDocumentsRouter());\n  app.use(\"/api/admin\", createAdminRouter());\n  app.use(\"/api\", createAgentRouter(broadcastBrowserEvent));\n  app.use(createFigmaRouter());\n  app.use(createLibraryRouter());\n  app.use(createCodeRouter());\n  app.use(createUserRouter());\n  app.use(\"/api\", createChatAiRouter(broadcastAgentUpdate));\n\n  const objectStorageService = new ObjectStorageService();\n\n  browserSessionManager.addGlobalEventListener((event: SessionEvent) => {\n    broadcastBrowserEvent(event.sessionId, event);\n  });\n\n  const wss = new WebSocketServer({ server: httpServer, path: \"/ws/agent\" });\n  \n  createAuthenticatedWebSocketHandler(wss, true, (ws: AuthenticatedWebSocket) => {\n    let subscribedRunId: string | null = null;\n    \n    ws.on(\"message\", (message) => {\n      try {\n        const data = JSON.parse(message.toString());\n        if (data.type === \"subscribe\" && data.runId) {\n          subscribedRunId = data.runId;\n          if (!agentClients.has(data.runId)) {\n            agentClients.set(data.runId, new Set());\n          }\n          agentClients.get(data.runId)!.add(ws);\n        }\n      } catch (e) {\n        console.error(\"WS message parse error:\", e);\n      }\n    });\n    \n    ws.on(\"close\", () => {\n      if (subscribedRunId) {\n        const clients = agentClients.get(subscribedRunId);\n        if (clients) {\n          clients.delete(ws);\n          if (clients.size === 0) {\n            agentClients.delete(subscribedRunId);\n          }\n        }\n      }\n    });\n  });\n\n  const browserWss = new WebSocketServer({ server: httpServer, path: \"/ws/browser\" });\n\n  const fileStatusWss = new WebSocketServer({ server: httpServer, path: \"/ws/file-status\" });\n\n  createAuthenticatedWebSocketHandler(fileStatusWss, true, (ws: AuthenticatedWebSocket) => {\n    let subscribedFileIds: Set<string> = new Set();\n    \n    ws.on(\"message\", (message) => {\n      try {\n        const data = JSON.parse(message.toString());\n        if (data.type === \"subscribe\" && data.fileId) {\n          subscribedFileIds.add(data.fileId);\n          if (!fileStatusClients.has(data.fileId)) {\n            fileStatusClients.set(data.fileId, new Set());\n          }\n          fileStatusClients.get(data.fileId)!.add(ws);\n          \n          ws.send(JSON.stringify({ type: \"subscribed\", fileId: data.fileId }));\n          \n          const job = fileProcessingQueue.getJob(data.fileId);\n          if (job && ws.readyState === WebSocket.OPEN) {\n            ws.send(JSON.stringify({\n              type: 'file_status',\n              fileId: job.fileId,\n              status: job.status,\n              progress: job.progress,\n              error: job.error,\n            }));\n          }\n        } else if (data.type === \"unsubscribe\" && data.fileId) {\n          subscribedFileIds.delete(data.fileId);\n          const clients = fileStatusClients.get(data.fileId);\n          if (clients) {\n            clients.delete(ws);\n            if (clients.size === 0) {\n              fileStatusClients.delete(data.fileId);\n            }\n          }\n        }\n      } catch (e) {\n        console.error(\"File status WS message parse error:\", e);\n      }\n    });\n    \n    ws.on(\"close\", () => {\n      const fileIds = Array.from(subscribedFileIds);\n      for (const fileId of fileIds) {\n        const clients = fileStatusClients.get(fileId);\n        if (clients) {\n          clients.delete(ws);\n          if (clients.size === 0) {\n            fileStatusClients.delete(fileId);\n          }\n        }\n      }\n    });\n  });\n\n  fileProcessingQueue.setStatusChangeHandler((update: FileStatusUpdate) => {\n    broadcastFileStatus(update);\n  });\n\n  fileProcessingQueue.setProcessCallback(async (job) => {\n    try {\n      await storage.updateFileJobStatus(job.fileId, \"processing\");\n      await storage.updateFileProgress(job.fileId, 10);\n      fileProcessingQueue.updateProgress(job.fileId, 10);\n\n      const objectFile = await objectStorageService.getObjectEntityFile(job.storagePath);\n      const content = await objectStorageService.getFileContent(objectFile);\n      await storage.updateFileProgress(job.fileId, 30);\n      fileProcessingQueue.updateProgress(job.fileId, 30);\n\n      const result = await processDocument(content, job.mimeType, job.fileName);\n      await storage.updateFileProgress(job.fileId, 50);\n      fileProcessingQueue.updateProgress(job.fileId, 50);\n\n      const chunks = chunkText(result.text, 1500, 150);\n      await storage.updateFileProgress(job.fileId, 60);\n      fileProcessingQueue.updateProgress(job.fileId, 60);\n\n      const texts = chunks.map(c => c.content);\n      const embeddings = await generateEmbeddingsBatch(texts);\n      await storage.updateFileProgress(job.fileId, 80);\n      fileProcessingQueue.updateProgress(job.fileId, 80);\n\n      const chunksWithEmbeddings = chunks.map((chunk, i) => ({\n        fileId: job.fileId,\n        content: chunk.content,\n        embedding: embeddings[i],\n        chunkIndex: chunk.chunkIndex,\n        pageNumber: chunk.pageNumber || null,\n        metadata: null,\n      }));\n\n      await storage.createFileChunks(chunksWithEmbeddings);\n      await storage.updateFileProgress(job.fileId, 95);\n      fileProcessingQueue.updateProgress(job.fileId, 95);\n\n      await storage.updateFileCompleted(job.fileId);\n      await storage.updateFileJobStatus(job.fileId, \"completed\");\n      \n      console.log(`[FileQueue] File ${job.fileId} processed: ${chunks.length} chunks created`);\n    } catch (error: any) {\n      console.error(`[FileQueue] Error processing file ${job.fileId}:`, error);\n      await storage.updateFileError(job.fileId, error.message || \"Unknown error\");\n      await storage.updateFileJobStatus(job.fileId, \"failed\", error.message);\n      throw error;\n    }\n  });\n  \n  createAuthenticatedWebSocketHandler(browserWss, true, (ws: AuthenticatedWebSocket) => {\n    let subscribedSessionId: string | null = null;\n    \n    ws.on(\"message\", async (message) => {\n      try {\n        const data = JSON.parse(message.toString());\n        if (data.type === \"subscribe\" && data.sessionId) {\n          subscribedSessionId = data.sessionId;\n          if (!browserClients.has(data.sessionId)) {\n            browserClients.set(data.sessionId, new Set());\n          }\n          browserClients.get(data.sessionId)!.add(ws);\n          \n          ws.send(JSON.stringify({ type: \"subscribed\", sessionId: data.sessionId }));\n          \n          try {\n            const screenshot = await browserSessionManager.getScreenshot(data.sessionId);\n            if (screenshot && ws.readyState === WebSocket.OPEN) {\n              ws.send(JSON.stringify({\n                messageType: \"browser_event\",\n                eventType: \"observation\",\n                sessionId: data.sessionId,\n                timestamp: new Date(),\n                data: { type: \"screenshot\", screenshot }\n              }));\n            }\n          } catch (e) {\n          }\n        }\n      } catch (e) {\n        console.error(\"Browser WS message parse error:\", e);\n      }\n    });\n    \n    ws.on(\"close\", () => {\n      if (subscribedSessionId) {\n        const clients = browserClients.get(subscribedSessionId);\n        if (clients) {\n          clients.delete(ws);\n          if (clients.size === 0) {\n            browserClients.delete(subscribedSessionId);\n          }\n        }\n      }\n    });\n  });\n\n  return httpServer;\n}\n\nfunction broadcastBrowserEvent(sessionId: string, event: SessionEvent) {\n  const clients = browserClients.get(sessionId);\n  if (!clients) return;\n  \n  const message = JSON.stringify({ \n    messageType: \"browser_event\", \n    eventType: event.type,\n    sessionId: event.sessionId,\n    timestamp: event.timestamp,\n    data: event.data\n  });\n  clients.forEach((client) => {\n    if (client.readyState === WebSocket.OPEN) {\n      client.send(message);\n    }\n  });\n}\n\nfunction broadcastAgentUpdate(runId: string, update: StepUpdate) {\n  const clients = agentClients.get(runId);\n  if (!clients) return;\n  \n  const message = JSON.stringify({ type: \"step_update\", ...update });\n  clients.forEach((client) => {\n    if (client.readyState === WebSocket.OPEN) {\n      client.send(message);\n    }\n  });\n}\n\nfunction broadcastFileStatus(update: FileStatusUpdate) {\n  const clients = fileStatusClients.get(update.fileId);\n  if (!clients) return;\n  \n  const message = JSON.stringify(update);\n  clients.forEach((client) => {\n    if (client.readyState === WebSocket.OPEN) {\n      client.send(message);\n    }\n  });\n}\n","path":null,"size_bytes":10352,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\nimport { motion, AnimatePresence } from \"framer-motion\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    data-testid=\"accordion-item\"\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      data-testid=\"accordion-trigger\"\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst contentAnimationVariants = {\n  collapsed: {\n    height: 0,\n    opacity: 0,\n  },\n  expanded: {\n    height: \"auto\",\n    opacity: 1,\n  },\n}\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => {\n  const [isOpen, setIsOpen] = React.useState(false)\n  const contentRef = React.useRef<HTMLDivElement>(null)\n\n  React.useEffect(() => {\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.attributeName === \"data-state\") {\n          const target = mutation.target as HTMLElement\n          setIsOpen(target.getAttribute(\"data-state\") === \"open\")\n        }\n      })\n    })\n\n    if (contentRef.current) {\n      const initialState = contentRef.current.getAttribute(\"data-state\") === \"open\"\n      setIsOpen(initialState)\n      observer.observe(contentRef.current, { attributes: true })\n    }\n\n    return () => observer.disconnect()\n  }, [])\n\n  return (\n    <AccordionPrimitive.Content\n      ref={(node) => {\n        contentRef.current = node\n        if (typeof ref === \"function\") {\n          ref(node)\n        } else if (ref) {\n          ref.current = node\n        }\n      }}\n      className=\"overflow-hidden text-sm\"\n      data-testid=\"accordion-content\"\n      forceMount\n      {...props}\n    >\n      <motion.div\n        initial=\"collapsed\"\n        animate={isOpen ? \"expanded\" : \"collapsed\"}\n        variants={contentAnimationVariants}\n        transition={{\n          duration: 0.25,\n          ease: \"easeInOut\",\n        }}\n        data-testid=\"accordion-content-animated\"\n      >\n        <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n      </motion.div>\n    </AccordionPrimitive.Content>\n  )\n})\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":3462,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/item.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction ItemGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      role=\"list\"\n      data-slot=\"item-group\"\n      className={cn(\"group/item-group flex flex-col\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"item-separator\"\n      orientation=\"horizontal\"\n      className={cn(\"my-0\", className)}\n      {...props}\n    />\n  )\n}\n\nconst itemVariants = cva(\n  \"group/item [a]:hover:bg-accent/50 focus-visible:border-ring focus-visible:ring-ring/50 [a]:transition-colors flex flex-wrap items-center rounded-md border border-transparent text-sm outline-none transition-colors duration-100 focus-visible:ring-[3px]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline: \"border-border\",\n        muted: \"bg-muted/50\",\n      },\n      size: {\n        default: \"gap-4 p-4 \",\n        sm: \"gap-2.5 px-4 py-3\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction Item({\n  className,\n  variant = \"default\",\n  size = \"default\",\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> &\n  VariantProps<typeof itemVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n  return (\n    <Comp\n      data-slot=\"item\"\n      data-variant={variant}\n      data-size={size}\n      className={cn(itemVariants({ variant, size, className }))}\n      {...props}\n    />\n  )\n}\n\nconst itemMediaVariants = cva(\n  \"flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:translate-y-0.5 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted size-8 rounded-sm border [&_svg:not([class*='size-'])]:size-4\",\n        image:\n          \"size-10 overflow-hidden rounded-sm [&_img]:size-full [&_img]:object-cover\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction ItemMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof itemMediaVariants>) {\n  return (\n    <div\n      data-slot=\"item-media\"\n      data-variant={variant}\n      className={cn(itemMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction ItemContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-content\"\n      className={cn(\n        \"flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-title\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"item-description\"\n      className={cn(\n        \"text-muted-foreground line-clamp-2 text-balance text-sm font-normal leading-normal\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemActions({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-actions\"\n      className={cn(\"flex items-center gap-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-header\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-footer\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Item,\n  ItemMedia,\n  ItemContent,\n  ItemActions,\n  ItemGroup,\n  ItemSeparator,\n  ItemTitle,\n  ItemDescription,\n  ItemHeader,\n  ItemFooter,\n}\n","path":null,"size_bytes":4494,"size_tokens":null},"client/src/components/ui/spinner.tsx":{"content":"import { Loader2Icon } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Spinner({ className, ...props }: React.ComponentProps<\"svg\">) {\n  return (\n    <Loader2Icon\n      role=\"status\"\n      aria-label=\"Loading\"\n      className={cn(\"size-4 animate-spin\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Spinner }\n","path":null,"size_bytes":331,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":724,"size_tokens":null},"vite-plugin-meta-images.ts":{"content":"import type { Plugin } from 'vite';\nimport fs from 'fs';\nimport path from 'path';\n\n/**\n * Vite plugin that updates og:image and twitter:image meta tags\n * to point to the app's opengraph image with the correct Replit domain.\n */\nexport function metaImagesPlugin(): Plugin {\n  return {\n    name: 'vite-plugin-meta-images',\n    transformIndexHtml(html) {\n      const baseUrl = getDeploymentUrl();\n      if (!baseUrl) {\n        log('[meta-images] no Replit deployment domain found, skipping meta tag updates');\n        return html;\n      }\n\n      // Check if opengraph image exists in public directory\n      const publicDir = path.resolve(process.cwd(), 'client', 'public');\n      const opengraphPngPath = path.join(publicDir, 'opengraph.png');\n      const opengraphJpgPath = path.join(publicDir, 'opengraph.jpg');\n      const opengraphJpegPath = path.join(publicDir, 'opengraph.jpeg');\n\n      let imageExt: string | null = null;\n      if (fs.existsSync(opengraphPngPath)) {\n        imageExt = 'png';\n      } else if (fs.existsSync(opengraphJpgPath)) {\n        imageExt = 'jpg';\n      } else if (fs.existsSync(opengraphJpegPath)) {\n        imageExt = 'jpeg';\n      }\n\n      if (!imageExt) {\n        log('[meta-images] OpenGraph image not found, skipping meta tag updates');\n        return html;\n      }\n\n      const imageUrl = `${baseUrl}/opengraph.${imageExt}`;\n\n      log('[meta-images] updating meta image tags to:', imageUrl);\n\n      html = html.replace(\n        /<meta\\s+property=\"og:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta property=\"og:image\" content=\"${imageUrl}\" />`\n      );\n\n      html = html.replace(\n        /<meta\\s+name=\"twitter:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta name=\"twitter:image\" content=\"${imageUrl}\" />`\n      );\n\n      return html;\n    },\n  };\n}\n\nfunction getDeploymentUrl(): string | null {\n  if (process.env.REPLIT_INTERNAL_APP_DOMAIN) {\n    const url = `https://${process.env.REPLIT_INTERNAL_APP_DOMAIN}`;\n    log('[meta-images] using internal app domain:', url);\n    return url;\n  }\n\n  if (process.env.REPLIT_DEV_DOMAIN) {\n    const url = `https://${process.env.REPLIT_DEV_DOMAIN}`;\n    log('[meta-images] using dev domain:', url);\n    return url;\n  }\n\n  return null;\n}\n\nfunction log(...args: any[]): void {\n  if (process.env.NODE_ENV === 'production') {\n    console.log(...args);\n  }\n}\n","path":null,"size_bytes":2333,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-primary/20\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":792,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5124,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"/**\n * Dialog Component with Full Accessibility Support\n * \n * This component is built on Radix UI Dialog which provides comprehensive\n * WAI-ARIA dialog (modal) pattern implementation out of the box.\n * \n * ## Accessibility Features (provided by Radix UI):\n * \n * ### Focus Management\n * - **Focus Trap**: When the dialog opens, focus is trapped within it.\n *   Users cannot tab out of the dialog until it is closed.\n * - **Initial Focus**: Focus automatically moves to the first focusable element.\n * - **Focus Restoration**: When closed, focus returns to the trigger element.\n * \n * ### Keyboard Navigation\n * - **Escape**: Closes the dialog (built-in behavior).\n * - **Tab**: Cycles through focusable elements within the dialog.\n * - **Shift+Tab**: Cycles backwards through focusable elements.\n * \n * ### ARIA Attributes (automatically applied by Radix):\n * - `role=\"dialog\"` on DialogContent\n * - `aria-modal=\"true\"` on DialogContent\n * - `aria-labelledby` linking to DialogTitle\n * - `aria-describedby` linking to DialogDescription\n * \n * ### Screen Reader Support\n * - Dialog title and description are announced when opened.\n * - Close button has \"Close\" as screen reader text.\n * \n * @see https://www.radix-ui.com/primitives/docs/components/dialog\n * @see https://www.w3.org/WAI/ARIA/apg/patterns/dialog-modal/\n */\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\n/**\n * Root component that manages dialog state.\n * Controls open/closed state and provides context to child components.\n */\nconst Dialog = DialogPrimitive.Root\n\n/**\n * Button that triggers the dialog to open.\n * Focus returns to this element when the dialog closes.\n */\nconst DialogTrigger = DialogPrimitive.Trigger\n\n/**\n * Portal for rendering dialog outside the DOM hierarchy.\n * Ensures proper stacking context and accessibility.\n */\nconst DialogPortal = DialogPrimitive.Portal\n\n/**\n * Accessible close button component.\n * Can be used to create custom close buttons within the dialog.\n */\nconst DialogClose = DialogPrimitive.Close\n\n/**\n * Semi-transparent overlay behind the dialog.\n * Clicking the overlay closes the dialog by default.\n * \n * @accessibility\n * - Provides visual indication that the dialog is modal\n * - Dims background content to focus user attention\n */\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    data-testid=\"dialog-overlay\"\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\n/**\n * Main dialog content container.\n * \n * @accessibility\n * - Automatically receives `role=\"dialog\"` and `aria-modal=\"true\"`\n * - Focus is trapped within this element when open\n * - Escape key closes the dialog\n * - Links to DialogTitle via `aria-labelledby`\n * - Links to DialogDescription via `aria-describedby`\n */\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      data-testid=\"dialog-content\"\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close\n        data-testid=\"dialog-close-button\"\n        className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\"\n      >\n        <X className=\"h-4 w-4\" aria-hidden=\"true\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\n/**\n * Container for dialog header content (title and description).\n * Provides consistent spacing and alignment.\n */\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\n/**\n * Container for dialog footer content (action buttons).\n * Provides consistent spacing and responsive layout.\n */\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\n/**\n * Dialog title component.\n * \n * @accessibility\n * - Automatically linked to DialogContent via `aria-labelledby`\n * - Announced by screen readers when dialog opens\n * - Required for proper accessibility - every dialog should have a title\n */\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    data-testid=\"dialog-title\"\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\n/**\n * Dialog description component.\n * \n * @accessibility\n * - Automatically linked to DialogContent via `aria-describedby`\n * - Provides additional context announced by screen readers\n * - Optional but recommended for dialogs with complex content\n */\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    data-testid=\"dialog-description\"\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogTrigger,\n  DialogClose,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":7135,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"server/objectStorage.ts":{"content":"import { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport {\n  ObjectAclPolicy,\n  ObjectPermission,\n  canAccessObject,\n  getObjectAclPolicy,\n  setObjectAclPolicy,\n} from \"./objectAcl\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\nexport class ObjectStorageService {\n  constructor() {}\n\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      throw new Error(\n        \"PUBLIC_OBJECT_SEARCH_PATHS not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PUBLIC_OBJECT_SEARCH_PATHS env var (comma-separated paths).\"\n      );\n    }\n    return paths;\n  }\n\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  async searchPublicObject(filePath: string): Promise<File | null> {\n    for (const searchPath of this.getPublicObjectSearchPaths()) {\n      const fullPath = `${searchPath}/${filePath}`;\n      const { bucketName, objectName } = parseObjectPath(fullPath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      const file = bucket.file(objectName);\n      const [exists] = await file.exists();\n      if (exists) {\n        return file;\n      }\n    }\n    return null;\n  }\n\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      const [metadata] = await file.getMetadata();\n      const aclPolicy = await getObjectAclPolicy(file);\n      const isPublic = aclPolicy?.visibility === \"public\";\n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `${isPublic ? \"public\" : \"private\"}, max-age=${cacheTtlSec}`,\n      });\n      const stream = file.createReadStream();\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  async getObjectEntityUploadURL(): Promise<string> {\n    const { uploadURL } = await this.getObjectEntityUploadURLWithPath();\n    return uploadURL;\n  }\n\n  async getObjectEntityUploadURLWithPath(): Promise<{ uploadURL: string; storagePath: string }> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    if (!privateObjectDir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    const objectId = randomUUID();\n    const entityId = `uploads/${objectId}`;\n    const fullPath = `${privateObjectDir}/${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n    const uploadURL = await signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 900,\n    });\n    return { uploadURL, storagePath: `/objects/${entityId}` };\n  }\n\n  async getObjectEntityFile(objectPath: string): Promise<File> {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  normalizeObjectEntityPath(rawPath: string): string {\n    if (!rawPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return rawPath;\n    }\n    const url = new URL(rawPath);\n    const rawObjectPath = url.pathname;\n    let objectEntityDir = this.getPrivateObjectDir();\n    if (!objectEntityDir.endsWith(\"/\")) {\n      objectEntityDir = `${objectEntityDir}/`;\n    }\n    if (!rawObjectPath.startsWith(objectEntityDir)) {\n      return rawObjectPath;\n    }\n    const entityId = rawObjectPath.slice(objectEntityDir.length);\n    return `/objects/${entityId}`;\n  }\n\n  async trySetObjectEntityAclPolicy(\n    rawPath: string,\n    aclPolicy: ObjectAclPolicy\n  ): Promise<string> {\n    const normalizedPath = this.normalizeObjectEntityPath(rawPath);\n    if (!normalizedPath.startsWith(\"/\")) {\n      return normalizedPath;\n    }\n    const objectFile = await this.getObjectEntityFile(normalizedPath);\n    await setObjectAclPolicy(objectFile, aclPolicy);\n    return normalizedPath;\n  }\n\n  async canAccessObjectEntity({\n    userId,\n    objectFile,\n    requestedPermission,\n  }: {\n    userId?: string;\n    objectFile: File;\n    requestedPermission?: ObjectPermission;\n  }): Promise<boolean> {\n    return canAccessObject({\n      userId,\n      objectFile,\n      requestedPermission: requestedPermission ?? ObjectPermission.READ,\n    });\n  }\n\n  async getFileContent(file: File): Promise<Buffer> {\n    const [content] = await file.download();\n    return content;\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n  return { bucketName, objectName };\n}\n\nasync function signObjectURL({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n","path":null,"size_bytes":7786,"size_tokens":null},"server/objectAcl.ts":{"content":"import { File } from \"@google-cloud/storage\";\n\nconst ACL_POLICY_METADATA_KEY = \"custom:aclPolicy\";\n\nexport enum ObjectAccessGroupType {}\n\nexport interface ObjectAccessGroup {\n  type: ObjectAccessGroupType;\n  id: string;\n}\n\nexport enum ObjectPermission {\n  READ = \"read\",\n  WRITE = \"write\",\n}\n\nexport interface ObjectAclRule {\n  group: ObjectAccessGroup;\n  permission: ObjectPermission;\n}\n\nexport interface ObjectAclPolicy {\n  owner: string;\n  visibility: \"public\" | \"private\";\n  aclRules?: Array<ObjectAclRule>;\n}\n\nfunction isPermissionAllowed(\n  requested: ObjectPermission,\n  granted: ObjectPermission,\n): boolean {\n  if (requested === ObjectPermission.READ) {\n    return [ObjectPermission.READ, ObjectPermission.WRITE].includes(granted);\n  }\n  return granted === ObjectPermission.WRITE;\n}\n\nabstract class BaseObjectAccessGroup implements ObjectAccessGroup {\n  constructor(\n    public readonly type: ObjectAccessGroupType,\n    public readonly id: string,\n  ) {}\n  public abstract hasMember(userId: string): Promise<boolean>;\n}\n\nfunction createObjectAccessGroup(\n  group: ObjectAccessGroup,\n): BaseObjectAccessGroup {\n  switch (group.type) {\n    default:\n      throw new Error(`Unknown access group type: ${group.type}`);\n  }\n}\n\nexport async function setObjectAclPolicy(\n  objectFile: File,\n  aclPolicy: ObjectAclPolicy,\n): Promise<void> {\n  const [exists] = await objectFile.exists();\n  if (!exists) {\n    throw new Error(`Object not found: ${objectFile.name}`);\n  }\n  await objectFile.setMetadata({\n    metadata: {\n      [ACL_POLICY_METADATA_KEY]: JSON.stringify(aclPolicy),\n    },\n  });\n}\n\nexport async function getObjectAclPolicy(\n  objectFile: File,\n): Promise<ObjectAclPolicy | null> {\n  const [metadata] = await objectFile.getMetadata();\n  const aclPolicy = metadata?.metadata?.[ACL_POLICY_METADATA_KEY];\n  if (!aclPolicy) {\n    return null;\n  }\n  return JSON.parse(aclPolicy as string);\n}\n\nexport async function canAccessObject({\n  userId,\n  objectFile,\n  requestedPermission,\n}: {\n  userId?: string;\n  objectFile: File;\n  requestedPermission: ObjectPermission;\n}): Promise<boolean> {\n  const aclPolicy = await getObjectAclPolicy(objectFile);\n  if (!aclPolicy) {\n    return false;\n  }\n  if (\n    aclPolicy.visibility === \"public\" &&\n    requestedPermission === ObjectPermission.READ\n  ) {\n    return true;\n  }\n  if (!userId) {\n    return false;\n  }\n  if (aclPolicy.owner === userId) {\n    return true;\n  }\n  for (const rule of aclPolicy.aclRules || []) {\n    const accessGroup = createObjectAccessGroup(rule.group);\n    if (\n      (await accessGroup.hasMember(userId)) &&\n      isPermissionAllowed(requestedPermission, rule.permission)\n    ) {\n      return true;\n    }\n  }\n  return false;\n}\n","path":null,"size_bytes":2700,"size_tokens":null},"client/src/components/search-modal.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { Search, X, MessageSquare, Loader2 } from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { Chat } from \"@/hooks/use-chats\";\nimport { format } from \"date-fns\";\n\ninterface SearchModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  chats: Chat[];\n  onSelectChat: (id: string) => void;\n  triggerRef?: React.RefObject<HTMLButtonElement | null>;\n}\n\nfunction useDebounce<T>(value: T, delay: number): T {\n  const [debouncedValue, setDebouncedValue] = useState<T>(value);\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedValue(value);\n    }, delay);\n\n    return () => {\n      clearTimeout(timer);\n    };\n  }, [value, delay]);\n\n  return debouncedValue;\n}\n\nexport function SearchModal({\n  open,\n  onOpenChange,\n  chats,\n  onSelectChat,\n  triggerRef,\n}: SearchModalProps) {\n  const [query, setQuery] = useState(\"\");\n  const [isSearching, setIsSearching] = useState(false);\n  const [results, setResults] = useState<Chat[]>([]);\n  const [selectedIndex, setSelectedIndex] = useState(0);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const resultsRef = useRef<HTMLDivElement>(null);\n\n  const debouncedQuery = useDebounce(query, 300);\n\n  const searchChats = useCallback((searchQuery: string, allChats: Chat[]) => {\n    if (!searchQuery.trim()) {\n      return [];\n    }\n\n    const lowerQuery = searchQuery.toLowerCase();\n\n    return allChats.filter((chat) => {\n      const titleMatch = chat.title.toLowerCase().includes(lowerQuery);\n\n      const lastMessage = chat.messages[chat.messages.length - 1];\n      const lastMessageMatch = lastMessage\n        ? lastMessage.content.toLowerCase().includes(lowerQuery)\n        : false;\n\n      const anyMessageMatch = chat.messages.some((msg) =>\n        msg.content.toLowerCase().includes(lowerQuery)\n      );\n\n      return titleMatch || lastMessageMatch || anyMessageMatch;\n    });\n  }, []);\n\n  useEffect(() => {\n    if (!debouncedQuery.trim()) {\n      setResults([]);\n      setIsSearching(false);\n      return;\n    }\n\n    setIsSearching(true);\n    \n    const timer = setTimeout(() => {\n      const searchResults = searchChats(debouncedQuery, chats);\n      setResults(searchResults);\n      setSelectedIndex(0);\n      setIsSearching(false);\n    }, 100);\n\n    return () => clearTimeout(timer);\n  }, [debouncedQuery, chats, searchChats]);\n\n  useEffect(() => {\n    if (open) {\n      setQuery(\"\");\n      setResults([]);\n      setSelectedIndex(0);\n      setTimeout(() => {\n        inputRef.current?.focus();\n      }, 50);\n    } else {\n      triggerRef?.current?.focus();\n    }\n  }, [open, triggerRef]);\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      setSelectedIndex((prev) => Math.min(prev + 1, results.length - 1));\n    } else if (e.key === \"ArrowUp\") {\n      e.preventDefault();\n      setSelectedIndex((prev) => Math.max(prev - 1, 0));\n    } else if (e.key === \"Enter\" && results.length > 0) {\n      e.preventDefault();\n      handleSelectResult(results[selectedIndex].id);\n    }\n  };\n\n  const handleSelectResult = (chatId: string) => {\n    onSelectChat(chatId);\n    onOpenChange(false);\n  };\n\n  const getLastMessagePreview = (chat: Chat) => {\n    const lastMessage = chat.messages[chat.messages.length - 1];\n    if (!lastMessage) return \"Sin mensajes\";\n    const preview = lastMessage.content.slice(0, 60);\n    return preview + (lastMessage.content.length > 60 ? \"...\" : \"\");\n  };\n\n  const highlightMatch = (text: string, query: string) => {\n    if (!query.trim()) return text;\n    \n    const parts = text.split(new RegExp(`(${query})`, \"gi\"));\n    return parts.map((part, i) =>\n      part.toLowerCase() === query.toLowerCase() ? (\n        <mark key={i} className=\"bg-yellow-200 dark:bg-yellow-800 rounded px-0.5\">\n          {part}\n        </mark>\n      ) : (\n        part\n      )\n    );\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent\n        className=\"max-w-xl p-0 gap-0 overflow-hidden\"\n        aria-describedby={undefined}\n        onKeyDown={handleKeyDown}\n        data-testid=\"modal-search\"\n      >\n        <DialogHeader className=\"sr-only\">\n          <DialogTitle>Buscar chats</DialogTitle>\n        </DialogHeader>\n\n        <div className=\"flex items-center border-b px-3 py-2\">\n          <Search className=\"h-4 w-4 text-muted-foreground mr-2 flex-shrink-0\" />\n          <Input\n            ref={inputRef}\n            value={query}\n            onChange={(e) => setQuery(e.target.value)}\n            placeholder=\"Buscar chats...\"\n            className=\"border-0 focus-visible:ring-0 focus-visible:ring-offset-0 px-0 h-10\"\n            aria-label=\"Buscar conversaciones\"\n            data-testid=\"input-search-modal\"\n          />\n          {query && (\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-6 w-6 flex-shrink-0\"\n              onClick={() => setQuery(\"\")}\n              aria-label=\"Limpiar búsqueda\"\n              data-testid=\"button-clear-search\"\n            >\n              <X className=\"h-3 w-3\" />\n            </Button>\n          )}\n        </div>\n\n        <ScrollArea className=\"max-h-[300px]\" ref={resultsRef}>\n          <div \n            className=\"p-2\" \n            role=\"listbox\" \n            aria-label=\"Resultados de búsqueda\"\n            aria-activedescendant={results.length > 0 ? `search-result-option-${results[selectedIndex]?.id}` : undefined}\n          >\n            {isSearching && (\n              <div\n                className=\"flex items-center justify-center py-8 text-muted-foreground\"\n                data-testid=\"search-loading\"\n              >\n                <Loader2 className=\"h-5 w-5 animate-spin mr-2\" />\n                <span>Buscando...</span>\n              </div>\n            )}\n\n            {!isSearching && query.trim() && results.length === 0 && (\n              <div\n                className=\"flex flex-col items-center justify-center py-8 text-muted-foreground\"\n                data-testid=\"search-no-results\"\n              >\n                <Search className=\"h-8 w-8 mb-2 opacity-50\" />\n                <p>No se encontraron resultados</p>\n                <p className=\"text-sm\">Intenta con otros términos</p>\n              </div>\n            )}\n\n            {!isSearching && !query.trim() && (\n              <div\n                className=\"flex flex-col items-center justify-center py-8 text-muted-foreground\"\n                data-testid=\"search-empty-state\"\n              >\n                <Search className=\"h-8 w-8 mb-2 opacity-50\" />\n                <p>Escribe para buscar</p>\n              </div>\n            )}\n\n            {!isSearching && results.length > 0 && (\n              <div className=\"flex flex-col gap-1\">\n                {results.map((chat, index) => (\n                  <button\n                    key={chat.id}\n                    id={`search-result-option-${chat.id}`}\n                    className={cn(\n                      \"flex items-start gap-3 w-full p-3 rounded-lg text-left transition-colors\",\n                      \"hover:bg-accent\",\n                      selectedIndex === index && \"bg-accent\"\n                    )}\n                    onClick={() => handleSelectResult(chat.id)}\n                    role=\"option\"\n                    aria-selected={selectedIndex === index}\n                    data-testid={`search-result-${chat.id}`}\n                  >\n                    <MessageSquare className=\"h-4 w-4 mt-1 text-muted-foreground flex-shrink-0\" />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center justify-between gap-2\">\n                        <span className=\"font-medium text-sm truncate\">\n                          {highlightMatch(chat.title, debouncedQuery)}\n                        </span>\n                        <span className=\"text-xs text-muted-foreground flex-shrink-0\">\n                          {format(new Date(chat.timestamp), \"dd/MM\")}\n                        </span>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground truncate mt-0.5\">\n                        {highlightMatch(getLastMessagePreview(chat), debouncedQuery)}\n                      </p>\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        </ScrollArea>\n\n        <div className=\"border-t px-3 py-2 text-xs text-muted-foreground flex items-center justify-between\">\n          <span>{results.length > 0 ? `${results.length} resultado${results.length !== 1 ? 's' : ''}` : ''}</span>\n          <div className=\"flex items-center gap-2\">\n            <kbd className=\"px-1.5 py-0.5 bg-muted rounded text-[10px]\">↑↓</kbd>\n            <span>navegar</span>\n            <kbd className=\"px-1.5 py-0.5 bg-muted rounded text-[10px]\">↵</kbd>\n            <span>seleccionar</span>\n            <kbd className=\"px-1.5 py-0.5 bg-muted rounded text-[10px]\">esc</kbd>\n            <span>cerrar</span>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":9399,"size_tokens":null},"client/src/components/mini-sidebar.tsx":{"content":"import { Plus, Search, Library, Bot, User } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { SiraLogo } from \"@/components/sira-logo\";\n\ninterface MiniSidebarProps {\n  className?: string;\n  onNewChat?: () => void;\n  onExpand?: () => void;\n}\n\nexport function MiniSidebar({ className, onNewChat, onExpand }: MiniSidebarProps) {\n  const { user } = useAuth();\n  const isAdmin = user?.role === \"admin\";\n  const displayName = isAdmin ? \"Admin\" : (user?.firstName || user?.email?.split(\"@\")[0] || \"Usuario\");\n  const avatarInitial = isAdmin ? \"A\" : (user?.firstName?.[0] || user?.email?.[0] || \"U\").toUpperCase();\n  return (\n    <TooltipProvider delayDuration={100}>\n      <div className={cn(\n        \"flex h-screen w-[60px] flex-col items-center py-3 liquid-sidebar-light dark:liquid-sidebar border-r border-border\",\n        className\n      )}>\n        <div className=\"flex flex-col items-center gap-1 mb-4\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                className=\"h-10 w-10 rounded-xl hover:bg-accent transition-all duration-200\"\n                onClick={onExpand}\n              >\n                <SiraLogo size={28} />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              <p>Expandir Sidebar</p>\n            </TooltipContent>\n          </Tooltip>\n        </div>\n\n        <div className=\"flex flex-col items-center gap-1\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                className=\"h-10 w-10 rounded-xl hover:bg-accent transition-all duration-200\"\n                onClick={onNewChat}\n                data-testid=\"mini-button-new-chat\"\n              >\n                <Plus className=\"h-5 w-5 text-foreground\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              <p>New Chat</p>\n            </TooltipContent>\n          </Tooltip>\n\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                className=\"h-10 w-10 rounded-xl hover:bg-accent transition-all duration-200\"\n                data-testid=\"mini-button-search\"\n              >\n                <Search className=\"h-5 w-5 text-foreground\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              <p>Search chats</p>\n            </TooltipContent>\n          </Tooltip>\n\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                className=\"h-10 w-10 rounded-xl hover:bg-accent transition-all duration-200\"\n                data-testid=\"mini-button-library\"\n              >\n                <Library className=\"h-5 w-5 text-foreground\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              <p>Library</p>\n            </TooltipContent>\n          </Tooltip>\n\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                className=\"h-10 w-10 rounded-xl hover:bg-accent transition-all duration-200\"\n                data-testid=\"mini-button-gpts\"\n              >\n                <Bot className=\"h-5 w-5 text-foreground\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              <p>GPTs</p>\n            </TooltipContent>\n          </Tooltip>\n        </div>\n\n        <div className=\"mt-auto\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                className=\"h-10 w-10 rounded-xl hover:bg-accent transition-all duration-200\"\n                data-testid=\"mini-button-user\"\n              >\n                <Avatar className=\"h-8 w-8\">\n                  <AvatarFallback className=\"bg-muted text-muted-foreground text-sm\">{avatarInitial}</AvatarFallback>\n                </Avatar>\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              <p>{displayName}</p>\n            </TooltipContent>\n          </Tooltip>\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":4732,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/node-postgres\";\nimport pg from \"pg\";\nimport * as schema from \"@shared/schema\";\n\nconst { Pool } = pg;\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n});\n\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":259,"size_tokens":null},"server/documentParser.ts":{"content":"import mammoth from \"mammoth\";\nimport ExcelJS from \"exceljs\";\nimport * as pdfParse from \"pdf-parse\";\nimport officeParser from \"officeparser\";\n\nconst pdf = (pdfParse as any).default || pdfParse;\n\nexport async function extractText(content: Buffer, mimeType: string): Promise<string> {\n  if (mimeType === \"text/plain\") {\n    return content.toString(\"utf-8\");\n  }\n  \n  if (mimeType === \"text/markdown\" || mimeType === \"text/md\") {\n    return content.toString(\"utf-8\");\n  }\n\n  if (mimeType === \"application/json\") {\n    try {\n      const json = JSON.parse(content.toString(\"utf-8\"));\n      return JSON.stringify(json, null, 2);\n    } catch {\n      return content.toString(\"utf-8\");\n    }\n  }\n\n  if (mimeType === \"text/csv\") {\n    return content.toString(\"utf-8\");\n  }\n\n  if (mimeType === \"text/html\") {\n    const html = content.toString(\"utf-8\");\n    return html.replace(/<[^>]*>/g, \" \").replace(/\\s+/g, \" \").trim();\n  }\n\n  if (mimeType === \"application/pdf\") {\n    try {\n      const data = await pdf(content);\n      return data.text;\n    } catch (error) {\n      console.error(\"Error parsing PDF:\", error);\n      throw new Error(\"Failed to parse PDF\");\n    }\n  }\n\n  if (mimeType === \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\") {\n    try {\n      const result = await mammoth.extractRawText({ buffer: content });\n      return result.value;\n    } catch (error) {\n      console.error(\"Error parsing DOCX:\", error);\n      throw new Error(\"Failed to parse DOCX\");\n    }\n  }\n\n  if (mimeType === \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\" ||\n      mimeType === \"application/vnd.ms-excel\") {\n    try {\n      const workbook = new ExcelJS.Workbook();\n      await workbook.xlsx.load(content);\n      \n      let text = \"\";\n      workbook.eachSheet((worksheet) => {\n        const sheetName = worksheet.name;\n        text += `Sheet: ${sheetName}\\n`;\n        \n        worksheet.eachRow({ includeEmpty: false }, (row) => {\n          const values: string[] = [];\n          row.eachCell({ includeEmpty: true }, (cell) => {\n            let cellValue = '';\n            if (cell.value === null || cell.value === undefined) {\n              cellValue = '';\n            } else if (typeof cell.value === 'object') {\n              if ('text' in cell.value) {\n                cellValue = cell.value.text;\n              } else if ('result' in cell.value) {\n                cellValue = String(cell.value.result ?? '');\n              } else if ('richText' in cell.value) {\n                cellValue = cell.value.richText.map((rt: any) => rt.text).join('');\n              } else {\n                cellValue = cell.text ?? String(cell.value);\n              }\n            } else {\n              cellValue = String(cell.value);\n            }\n            \n            if (cellValue.includes(',') || cellValue.includes('\\n') || cellValue.includes('\"')) {\n              cellValue = '\"' + cellValue.replace(/\"/g, '\"\"') + '\"';\n            }\n            values.push(cellValue);\n          });\n          text += values.join(',') + \"\\n\";\n        });\n        \n        text += \"\\n\";\n      });\n      \n      return text.trim();\n    } catch (error) {\n      console.error(\"Error parsing Excel:\", error);\n      throw new Error(\"Failed to parse Excel\");\n    }\n  }\n\n  if (mimeType === \"application/vnd.openxmlformats-officedocument.presentationml.presentation\" ||\n      mimeType === \"application/vnd.ms-powerpoint\") {\n    try {\n      const text = await officeParser.parseOfficeAsync(content);\n      if (!text || text.trim().length === 0) {\n        throw new Error(\"No text extracted from PowerPoint\");\n      }\n      return text;\n    } catch (error) {\n      console.error(\"Error parsing PowerPoint:\", error);\n      throw new Error(\"Failed to parse PowerPoint\");\n    }\n  }\n\n  return content.toString(\"utf-8\");\n}\n","path":null,"size_bytes":3807,"size_tokens":null},"server/embeddingService.ts":{"content":"import { LIMITS } from \"./lib/constants\";\n\nexport interface TextChunk {\n  content: string;\n  chunkIndex: number;\n  pageNumber?: number;\n}\n\nexport function chunkText(text: string, chunkSize = 1000, overlap = 200): TextChunk[] {\n  const chunks: TextChunk[] = [];\n  const cleanedText = text.replace(/\\s+/g, \" \").trim();\n  \n  if (cleanedText.length <= chunkSize) {\n    return [{ content: cleanedText, chunkIndex: 0 }];\n  }\n\n  let startIndex = 0;\n  let chunkIndex = 0;\n\n  while (startIndex < cleanedText.length) {\n    let endIndex = Math.min(startIndex + chunkSize, cleanedText.length);\n    \n    if (endIndex < cleanedText.length) {\n      const lastSpace = cleanedText.lastIndexOf(\" \", endIndex);\n      if (lastSpace > startIndex) {\n        endIndex = lastSpace;\n      }\n    }\n\n    const chunkContent = cleanedText.slice(startIndex, endIndex).trim();\n    if (chunkContent.length > 0) {\n      chunks.push({ content: chunkContent, chunkIndex });\n      chunkIndex++;\n    }\n\n    startIndex = endIndex - overlap;\n    if (startIndex >= cleanedText.length || endIndex >= cleanedText.length) break;\n  }\n\n  return chunks;\n}\n\nfunction simpleHash(str: string): number {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return hash;\n}\n\nfunction extractKeywords(text: string): string[] {\n  const stopWords = new Set([\n    'el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas', 'de', 'del', 'al',\n    'y', 'o', 'a', 'en', 'que', 'es', 'por', 'para', 'con', 'no', 'se', 'su',\n    'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of',\n    'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had',\n    'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might',\n    'this', 'that', 'these', 'those', 'it', 'its', 'as', 'if', 'then', 'than'\n  ]);\n  \n  return text\n    .toLowerCase()\n    .replace(/[^\\w\\sáéíóúñü]/g, ' ')\n    .split(/\\s+/)\n    .filter(word => word.length > 2 && !stopWords.has(word));\n}\n\nconst EMBEDDING_DIMENSIONS = 1536;\n\nexport async function generateEmbedding(text: string): Promise<number[]> {\n  const keywords = extractKeywords(text.slice(0, LIMITS.MAX_EMBEDDING_INPUT));\n  const embedding = new Array(EMBEDDING_DIMENSIONS).fill(0);\n  \n  keywords.forEach((word, idx) => {\n    const hash = Math.abs(simpleHash(word));\n    const position = hash % embedding.length;\n    embedding[position] += 1 / (idx + 1);\n  });\n  \n  const magnitude = Math.sqrt(embedding.reduce((sum, val) => sum + val * val, 0));\n  if (magnitude > 0) {\n    for (let i = 0; i < embedding.length; i++) {\n      embedding[i] /= magnitude;\n    }\n  }\n  \n  return embedding;\n}\n\nexport async function generateEmbeddingsBatch(texts: string[]): Promise<number[][]> {\n  if (texts.length === 0) return [];\n  \n  const embeddings: number[][] = [];\n  \n  for (const text of texts) {\n    const embedding = await generateEmbedding(text);\n    embeddings.push(embedding);\n  }\n  \n  return embeddings;\n}\n\nexport function cosineSimilarity(a: number[], b: number[]): number {\n  if (a.length !== b.length) return 0;\n  \n  let dotProduct = 0;\n  let normA = 0;\n  let normB = 0;\n  \n  for (let i = 0; i < a.length; i++) {\n    dotProduct += a[i] * b[i];\n    normA += a[i] * a[i];\n    normB += b[i] * b[i];\n  }\n  \n  const magnitude = Math.sqrt(normA) * Math.sqrt(normB);\n  return magnitude === 0 ? 0 : dotProduct / magnitude;\n}\n","path":null,"size_bytes":3431,"size_tokens":null},"client/src/components/ObjectUploader.tsx":{"content":"import { useState, useRef, useCallback, useEffect } from \"react\";\nimport type { ReactNode } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { FileUploadProgress } from \"@/components/FileUploadProgress\";\nimport { getFileUploader, type UploadProgress, type ValidationResult } from \"@/lib/fileUploader\";\nimport { cn } from \"@/lib/utils\";\nimport { Upload, X, FileIcon } from \"lucide-react\";\n\ninterface ObjectUploaderProps {\n  maxNumberOfFiles?: number;\n  maxFileSize?: number;\n  onGetUploadParameters?: () => Promise<{\n    method: \"PUT\";\n    url: string;\n  }>;\n  onComplete?: (result: { successful: Array<{ storagePath: string; name: string }> }) => void;\n  onFileUploaded?: (fileId: string, storagePath: string, fileName: string) => void;\n  buttonClassName?: string;\n  children: ReactNode;\n}\n\ninterface UploadingFile {\n  id: string;\n  file: File;\n  progress: UploadProgress;\n}\n\nexport function ObjectUploader({\n  maxNumberOfFiles = 1,\n  maxFileSize,\n  onComplete,\n  onFileUploaded,\n  buttonClassName,\n  children,\n}: ObjectUploaderProps) {\n  const [showModal, setShowModal] = useState(false);\n  const [isDragging, setIsDragging] = useState(false);\n  const [uploadingFiles, setUploadingFiles] = useState<UploadingFile[]>([]);\n  const [pendingFiles, setPendingFiles] = useState<File[]>([]);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const uploaderRef = useRef(getFileUploader());\n  const dropZoneRef = useRef<HTMLDivElement>(null);\n\n  const handleFilesSelected = useCallback(async (files: FileList | File[]) => {\n    const fileArray = Array.from(files).slice(0, maxNumberOfFiles);\n    \n    const newUploadingFiles: UploadingFile[] = fileArray.map((file) => ({\n      id: `pending_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`,\n      file,\n      progress: {\n        fileId: '',\n        phase: 'validating' as const,\n        uploadProgress: 0,\n        processingProgress: 0,\n      },\n    }));\n\n    setUploadingFiles(newUploadingFiles);\n\n    for (const uploadingFile of newUploadingFiles) {\n      try {\n        const result = await uploaderRef.current.uploadFile(\n          uploadingFile.file,\n          (progress) => {\n            setUploadingFiles((prev) =>\n              prev.map((f) =>\n                f.id === uploadingFile.id ? { ...f, progress } : f\n              )\n            );\n          }\n        );\n\n        setUploadingFiles((prev) =>\n          prev.map((f) =>\n            f.id === uploadingFile.id\n              ? {\n                  ...f,\n                  progress: {\n                    ...f.progress,\n                    fileId: result.fileId,\n                    phase: 'completed',\n                    uploadProgress: 100,\n                  },\n                }\n              : f\n          )\n        );\n\n        onFileUploaded?.(result.fileId, result.storagePath, uploadingFile.file.name);\n      } catch (error: any) {\n        setUploadingFiles((prev) =>\n          prev.map((f) =>\n            f.id === uploadingFile.id\n              ? {\n                  ...f,\n                  progress: {\n                    ...f.progress,\n                    phase: 'error',\n                    error: error.message || 'Error al subir el archivo',\n                  },\n                }\n              : f\n          )\n        );\n      }\n    }\n\n    const successful = newUploadingFiles\n      .filter((f) => f.progress.phase !== 'error')\n      .map((f) => ({\n        storagePath: '',\n        name: f.file.name,\n      }));\n\n    if (successful.length > 0) {\n      onComplete?.({ successful });\n    }\n  }, [maxNumberOfFiles, onComplete, onFileUploaded]);\n\n  const handleRetry = useCallback(async (fileId: string) => {\n    const fileToRetry = uploadingFiles.find((f) => f.id === fileId);\n    if (!fileToRetry) return;\n\n    setUploadingFiles((prev) =>\n      prev.map((f) =>\n        f.id === fileId\n          ? {\n              ...f,\n              progress: {\n                fileId: '',\n                phase: 'validating',\n                uploadProgress: 0,\n                processingProgress: 0,\n              },\n            }\n          : f\n      )\n    );\n\n    try {\n      const result = await uploaderRef.current.uploadFile(\n        fileToRetry.file,\n        (progress) => {\n          setUploadingFiles((prev) =>\n            prev.map((f) =>\n              f.id === fileId ? { ...f, progress } : f\n            )\n          );\n        }\n      );\n\n      setUploadingFiles((prev) =>\n        prev.map((f) =>\n          f.id === fileId\n            ? {\n                ...f,\n                progress: {\n                  ...f.progress,\n                  fileId: result.fileId,\n                  phase: 'completed',\n                  uploadProgress: 100,\n                },\n              }\n            : f\n        )\n      );\n\n      onFileUploaded?.(result.fileId, result.storagePath, fileToRetry.file.name);\n    } catch (error: any) {\n      setUploadingFiles((prev) =>\n        prev.map((f) =>\n          f.id === fileId\n            ? {\n                ...f,\n                progress: {\n                  ...f.progress,\n                  phase: 'error',\n                  error: error.message || 'Error al subir el archivo',\n                },\n              }\n            : f\n        )\n      );\n    }\n  }, [uploadingFiles, onFileUploaded]);\n\n  const handleCancel = useCallback((fileId: string) => {\n    uploaderRef.current.cancel();\n    setUploadingFiles((prev) => prev.filter((f) => f.id !== fileId));\n  }, []);\n\n  const handleRemoveFile = useCallback((fileId: string) => {\n    setUploadingFiles((prev) => prev.filter((f) => f.id !== fileId));\n  }, []);\n\n  const handleDragEnter = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(true);\n  }, []);\n\n  const handleDragLeave = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (dropZoneRef.current && !dropZoneRef.current.contains(e.relatedTarget as Node)) {\n      setIsDragging(false);\n    }\n  }, []);\n\n  const handleDragOver = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n  }, []);\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n\n    const files = e.dataTransfer.files;\n    if (files.length > 0) {\n      handleFilesSelected(files);\n    }\n  }, [handleFilesSelected]);\n\n  const handleFileInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (files && files.length > 0) {\n      handleFilesSelected(files);\n    }\n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n  }, [handleFilesSelected]);\n\n  const openFilePicker = useCallback(() => {\n    fileInputRef.current?.click();\n  }, []);\n\n  const handleCloseModal = useCallback(() => {\n    const hasActiveUploads = uploadingFiles.some(\n      (f) => f.progress.phase === 'uploading' || f.progress.phase === 'validating'\n    );\n    \n    if (!hasActiveUploads) {\n      setShowModal(false);\n      setUploadingFiles([]);\n    }\n  }, [uploadingFiles]);\n\n  const allCompleted = uploadingFiles.length > 0 && \n    uploadingFiles.every((f) => f.progress.phase === 'completed' || f.progress.phase === 'error');\n\n  return (\n    <div>\n      <Button\n        onClick={() => setShowModal(true)}\n        className={buttonClassName}\n        variant=\"ghost\"\n        size=\"icon\"\n        data-testid=\"button-open-uploader\"\n      >\n        {children}\n      </Button>\n\n      <Dialog open={showModal} onOpenChange={handleCloseModal}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Subir archivos</DialogTitle>\n            <DialogDescription>\n              Arrastra archivos aquí o haz clic para seleccionar\n            </DialogDescription>\n          </DialogHeader>\n\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            multiple={maxNumberOfFiles > 1}\n            onChange={handleFileInputChange}\n            className=\"hidden\"\n            data-testid=\"input-file-upload\"\n          />\n\n          {uploadingFiles.length === 0 ? (\n            <div\n              ref={dropZoneRef}\n              onDragEnter={handleDragEnter}\n              onDragLeave={handleDragLeave}\n              onDragOver={handleDragOver}\n              onDrop={handleDrop}\n              onClick={openFilePicker}\n              className={cn(\n                \"border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-all duration-200\",\n                isDragging\n                  ? \"border-primary bg-primary/5\"\n                  : \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50\"\n              )}\n              data-testid=\"dropzone-upload\"\n            >\n              <div className=\"flex flex-col items-center gap-3\">\n                <div\n                  className={cn(\n                    \"w-12 h-12 rounded-full flex items-center justify-center transition-colors\",\n                    isDragging ? \"bg-primary/10\" : \"bg-muted\"\n                  )}\n                >\n                  <Upload\n                    className={cn(\n                      \"h-6 w-6 transition-colors\",\n                      isDragging ? \"text-primary\" : \"text-muted-foreground\"\n                    )}\n                  />\n                </div>\n                <div>\n                  <p className=\"text-sm font-medium\">\n                    {isDragging ? \"Suelta el archivo aquí\" : \"Arrastra archivos aquí\"}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    o haz clic para seleccionar\n                  </p>\n                </div>\n              </div>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {uploadingFiles.map((file) => (\n                <FileUploadProgress\n                  key={file.id}\n                  fileName={file.file.name}\n                  phase={file.progress.phase}\n                  uploadProgress={file.progress.uploadProgress}\n                  processingProgress={file.progress.processingProgress}\n                  error={file.progress.error}\n                  onCancel={() => handleCancel(file.id)}\n                  onRetry={() => handleRetry(file.id)}\n                />\n              ))}\n              \n              {allCompleted && (\n                <div className=\"flex justify-end gap-2 pt-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      setUploadingFiles([]);\n                    }}\n                    data-testid=\"button-upload-more\"\n                  >\n                    Subir más\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    onClick={handleCloseModal}\n                    data-testid=\"button-done-upload\"\n                  >\n                    Listo\n                  </Button>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":11228,"size_tokens":null},"server/agent/pipeline/tools/web-navigate.ts":{"content":"import { ToolDefinition, ExecutionContext, ToolResult, Artifact } from \"../types\";\nimport { browserSessionManager } from \"../../browser\";\nimport { extractWithReadability } from \"../../extractor\";\nimport { ObjectStorageService } from \"../../../objectStorage\";\nimport crypto from \"crypto\";\n\nconst objectStorage = new ObjectStorageService();\n\nexport const webNavigateTool: ToolDefinition = {\n  id: \"web_navigate\",\n  name: \"Navigate Web Page\",\n  description: \"Navigate to a URL and capture the page content, optionally taking a screenshot\",\n  category: \"web\",\n  capabilities: [\"navigate\", \"browse\", \"fetch\", \"url\", \"website\", \"webpage\"],\n  inputSchema: {\n    url: { type: \"string\", description: \"The URL to navigate to\", required: true },\n    takeScreenshot: { type: \"boolean\", description: \"Whether to capture a screenshot\", default: true },\n    waitForSelector: { type: \"string\", description: \"CSS selector to wait for before capturing\" },\n    timeout: { type: \"number\", description: \"Navigation timeout in ms\", default: 30000 }\n  },\n  outputSchema: {\n    html: { type: \"string\", description: \"The page HTML content\" },\n    title: { type: \"string\", description: \"The page title\" },\n    url: { type: \"string\", description: \"The final URL after any redirects\" },\n    screenshot: { type: \"string\", description: \"Path to the screenshot if taken\" }\n  },\n  timeout: 60000,\n  \n  async execute(context: ExecutionContext, params: Record<string, any>): Promise<ToolResult> {\n    const { url, takeScreenshot = true, waitForSelector, timeout = 30000 } = params;\n    \n    console.log(\"WEB_NAVIGATE: Starting with URL:\", url);\n    \n    let sessionId: string | null = null;\n    const artifacts: Artifact[] = [];\n    \n    try {\n      console.log(\"WEB_NAVIGATE: Creating browser session...\");\n      sessionId = await browserSessionManager.createSession(\n        `Navigate to ${url}`,\n        { timeout },\n        undefined\n      );\n      console.log(\"WEB_NAVIGATE: Session created:\", sessionId);\n      \n      browserSessionManager.startScreenshotStreaming(sessionId, 1500);\n      console.log(\"WEB_NAVIGATE: Screenshot streaming started\");\n      \n      context.onProgress({\n        runId: context.runId,\n        stepId: `nav_${context.stepIndex}`,\n        status: \"progress\",\n        message: `Navigating to ${url}...`,\n        progress: 30,\n        detail: { browserSessionId: sessionId, url }\n      });\n      \n      const result = await browserSessionManager.navigate(sessionId, url);\n      \n      if (!result.success) {\n        return {\n          success: false,\n          error: result.error || \"Navigation failed\"\n        };\n      }\n\n      if (waitForSelector) {\n        const waitScript = `\n          new Promise((resolve, reject) => {\n            const selector = ${JSON.stringify(waitForSelector)};\n            const timeout = ${Math.min(timeout, 10000)};\n            const start = Date.now();\n            const check = () => {\n              if (document.querySelector(selector)) {\n                resolve(true);\n              } else if (Date.now() - start > timeout) {\n                resolve(false);\n              } else {\n                requestAnimationFrame(check);\n              }\n            };\n            check();\n          })\n        `;\n        await browserSessionManager.evaluate(sessionId, waitScript);\n      }\n\n      if (takeScreenshot && result.screenshot) {\n        try {\n          const screenshotBuffer = Buffer.from(result.screenshot.replace(/^data:image\\/png;base64,/, \"\"), \"base64\");\n          const { uploadURL, storagePath } = await objectStorage.getObjectEntityUploadURLWithPath();\n          await fetch(uploadURL, {\n            method: \"PUT\",\n            headers: { \"Content-Type\": \"image/png\" },\n            body: screenshotBuffer\n          });\n          \n          artifacts.push({\n            id: crypto.randomUUID(),\n            type: \"screenshot\",\n            name: `screenshot_${new URL(url).hostname}.png`,\n            storagePath,\n            mimeType: \"image/png\",\n            metadata: { url, title: result.data?.title }\n          });\n        } catch (e) {\n          console.error(\"Failed to save screenshot:\", e);\n        }\n      }\n\n      const pageState = await browserSessionManager.getPageState(sessionId);\n      \n      let extractedContent: any = null;\n      if (pageState?.visibleText) {\n        extractedContent = {\n          textContent: pageState.visibleText,\n          title: pageState.title,\n          links: pageState.links\n        };\n        \n        artifacts.push({\n          id: crypto.randomUUID(),\n          type: \"text\",\n          name: `content_${new URL(url).hostname}.txt`,\n          content: pageState.visibleText.slice(0, 50000),\n          metadata: {\n            title: pageState.title,\n            linksCount: pageState.links?.length || 0\n          }\n        });\n      }\n\n      return {\n        success: true,\n        data: {\n          url: result.data?.url || url,\n          title: result.data?.title || pageState?.title,\n          textContent: extractedContent?.textContent?.slice(0, 50000),\n          links: extractedContent?.links?.slice(0, 50),\n          duration: result.duration\n        },\n        artifacts,\n        metadata: {\n          finalUrl: result.data?.url || url,\n          title: result.data?.title || pageState?.title,\n          duration: result.duration\n        }\n      };\n    } catch (error: any) {\n      console.error(\"WEB_NAVIGATE: Error:\", error.message, error.stack);\n      return {\n        success: false,\n        error: error.message\n      };\n    } finally {\n      if (sessionId) {\n        browserSessionManager.stopScreenshotStreaming(sessionId);\n        // Delay closing to allow frontend to receive final screenshot\n        setTimeout(async () => {\n          await browserSessionManager.closeSession(sessionId!).catch(() => {});\n        }, 5000);\n      }\n    }\n  }\n};\n","path":null,"size_bytes":5847,"size_tokens":null},"client/src/hooks/use-browser-session.ts":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\n\nexport interface BrowserAction {\n  type: string;\n  params: Record<string, any>;\n  timestamp: Date;\n}\n\nexport interface BrowserEvent {\n  type: \"started\" | \"action\" | \"observation\" | \"error\" | \"completed\" | \"cancelled\";\n  sessionId: string;\n  timestamp: Date;\n  data: any;\n}\n\nexport interface BrowserSessionState {\n  sessionId: string | null;\n  status: \"idle\" | \"connecting\" | \"active\" | \"completed\" | \"error\" | \"cancelled\";\n  objective: string;\n  currentUrl: string;\n  currentTitle: string;\n  screenshot: string | null;\n  actions: BrowserAction[];\n  events: BrowserEvent[];\n  error: string | null;\n}\n\nconst initialState: BrowserSessionState = {\n  sessionId: null,\n  status: \"idle\",\n  objective: \"\",\n  currentUrl: \"\",\n  currentTitle: \"\",\n  screenshot: null,\n  actions: [],\n  events: [],\n  error: null,\n};\n\nexport function useBrowserSession() {\n  const [state, setState] = useState<BrowserSessionState>(initialState);\n  const wsRef = useRef<WebSocket | null>(null);\n  const pollingRef = useRef<NodeJS.Timeout | null>(null);\n\n  const fetchScreenshot = useCallback(async (sessionId: string) => {\n    try {\n      const response = await fetch(`/api/browser/session/${sessionId}/screenshot`);\n      if (response.ok) {\n        const data = await response.json();\n        if (data.screenshot) {\n          setState(prev => {\n            if (prev.sessionId === sessionId) {\n              return { ...prev, screenshot: data.screenshot };\n            }\n            return prev;\n          });\n        }\n      }\n    } catch (e) {\n      // Silently ignore polling errors\n    }\n  }, []);\n\n  const fetchSessionState = useCallback(async (sessionId: string) => {\n    try {\n      const response = await fetch(`/api/browser/session/${sessionId}`);\n      if (response.ok) {\n        const session = await response.json();\n        setState(prev => {\n          if (prev.sessionId === sessionId) {\n            let newStatus = prev.status;\n            if (session.status === \"completed\") newStatus = \"completed\";\n            else if (session.status === \"error\") newStatus = \"error\";\n            else if (session.status === \"cancelled\") newStatus = \"cancelled\";\n            else if (session.status === \"active\" || session.status === \"running\") newStatus = \"active\";\n            \n            return { \n              ...prev, \n              status: newStatus,\n              currentUrl: session.currentUrl || prev.currentUrl,\n              currentTitle: session.currentTitle || prev.currentTitle,\n            };\n          }\n          return prev;\n        });\n        return session;\n      }\n    } catch (e) {\n      // Silently ignore\n    }\n    return null;\n  }, []);\n\n  const startPolling = useCallback((sessionId: string) => {\n    if (pollingRef.current) {\n      clearInterval(pollingRef.current);\n    }\n    \n    fetchScreenshot(sessionId);\n    fetchSessionState(sessionId);\n    \n    pollingRef.current = setInterval(async () => {\n      const session = await fetchSessionState(sessionId);\n      if (session && (session.status === \"completed\" || session.status === \"error\" || session.status === \"cancelled\")) {\n        if (pollingRef.current) {\n          clearInterval(pollingRef.current);\n          pollingRef.current = null;\n        }\n      } else {\n        fetchScreenshot(sessionId);\n      }\n    }, 1500);\n  }, [fetchScreenshot, fetchSessionState]);\n\n  const stopPolling = useCallback(() => {\n    if (pollingRef.current) {\n      clearInterval(pollingRef.current);\n      pollingRef.current = null;\n    }\n  }, []);\n\n  const subscribeToSession = useCallback((sessionId: string, objective: string) => {\n    if (wsRef.current) {\n      wsRef.current.close();\n    }\n    stopPolling();\n\n    setState({\n      ...initialState,\n      sessionId,\n      status: \"connecting\",\n      objective,\n    });\n\n    startPolling(sessionId);\n    setState(prev => ({ ...prev, status: \"active\" }));\n\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const ws = new WebSocket(`${protocol}//${window.location.host}/ws/browser`);\n    wsRef.current = ws;\n\n    ws.onopen = () => {\n      ws.send(JSON.stringify({ type: \"subscribe\", sessionId }));\n    };\n\n    ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        \n        if (data.type === \"subscribed\") {\n          setState(prev => ({ ...prev, status: \"active\" }));\n        } else if (data.messageType === \"browser_event\") {\n          const eventType = data.eventType as BrowserEvent[\"type\"];\n          const browserEvent: BrowserEvent = {\n            type: eventType,\n            sessionId: data.sessionId,\n            timestamp: new Date(data.timestamp),\n            data: data.data,\n          };\n\n          setState(prev => {\n            const newState = { ...prev, events: [...prev.events, browserEvent] };\n\n            if (browserEvent.data?.screenshot) {\n              newState.screenshot = browserEvent.data.screenshot;\n            }\n\n            if (browserEvent.data?.url) {\n              newState.currentUrl = browserEvent.data.url;\n            }\n\n            if (browserEvent.data?.title) {\n              newState.currentTitle = browserEvent.data.title;\n            }\n\n            if (browserEvent.data?.action) {\n              newState.actions = [...prev.actions, {\n                type: browserEvent.data.action,\n                params: browserEvent.data,\n                timestamp: browserEvent.timestamp,\n              }];\n            }\n\n            if (eventType === \"completed\") {\n              newState.status = \"completed\";\n              stopPolling();\n            } else if (eventType === \"error\") {\n              newState.status = \"error\";\n              newState.error = browserEvent.data?.error || \"Unknown error\";\n              stopPolling();\n            } else if (eventType === \"cancelled\") {\n              newState.status = \"cancelled\";\n              stopPolling();\n            }\n\n            return newState;\n          });\n        }\n      } catch (e) {\n        console.error(\"Error parsing browser event:\", e);\n      }\n    };\n\n    ws.onerror = (error) => {\n      console.error(\"Browser WebSocket error, using polling fallback:\", error);\n    };\n    \n    ws.onclose = () => {\n      wsRef.current = null;\n    };\n  }, [startPolling, stopPolling]);\n\n  const createSession = useCallback(async (objective: string, config?: any) => {\n    try {\n      setState(prev => ({ ...prev, status: \"connecting\", objective }));\n      \n      const response = await fetch(\"/api/browser/session\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ objective, config }),\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to create session\");\n      }\n      \n      const { sessionId } = await response.json();\n      subscribeToSession(sessionId, objective);\n      \n      return sessionId;\n    } catch (error: any) {\n      setState(prev => ({ ...prev, status: \"error\", error: error.message }));\n      throw error;\n    }\n  }, [subscribeToSession]);\n\n  const navigate = useCallback(async (url: string) => {\n    if (!state.sessionId) return null;\n    \n    try {\n      const response = await fetch(`/api/browser/session/${state.sessionId}/navigate`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ url }),\n      });\n      return await response.json();\n    } catch (error) {\n      console.error(\"Navigate error:\", error);\n      return null;\n    }\n  }, [state.sessionId]);\n\n  const click = useCallback(async (selector: string) => {\n    if (!state.sessionId) return null;\n    \n    try {\n      const response = await fetch(`/api/browser/session/${state.sessionId}/click`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ selector }),\n      });\n      return await response.json();\n    } catch (error) {\n      console.error(\"Click error:\", error);\n      return null;\n    }\n  }, [state.sessionId]);\n\n  const type = useCallback(async (selector: string, text: string) => {\n    if (!state.sessionId) return null;\n    \n    try {\n      const response = await fetch(`/api/browser/session/${state.sessionId}/type`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ selector, text }),\n      });\n      return await response.json();\n    } catch (error) {\n      console.error(\"Type error:\", error);\n      return null;\n    }\n  }, [state.sessionId]);\n\n  const scroll = useCallback(async (direction: \"up\" | \"down\", amount?: number) => {\n    if (!state.sessionId) return null;\n    \n    try {\n      const response = await fetch(`/api/browser/session/${state.sessionId}/scroll`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ direction, amount }),\n      });\n      return await response.json();\n    } catch (error) {\n      console.error(\"Scroll error:\", error);\n      return null;\n    }\n  }, [state.sessionId]);\n\n  const getPageState = useCallback(async () => {\n    if (!state.sessionId) return null;\n    \n    try {\n      const response = await fetch(`/api/browser/session/${state.sessionId}/state`);\n      return await response.json();\n    } catch (error) {\n      console.error(\"Get state error:\", error);\n      return null;\n    }\n  }, [state.sessionId]);\n\n  const cancel = useCallback(async () => {\n    if (!state.sessionId) return;\n    \n    try {\n      await fetch(`/api/browser/session/${state.sessionId}/cancel`, { method: \"POST\" });\n      stopPolling();\n      setState(prev => ({ ...prev, status: \"cancelled\" }));\n    } catch (error) {\n      console.error(\"Cancel error:\", error);\n    }\n  }, [state.sessionId, stopPolling]);\n\n  const close = useCallback(async () => {\n    if (!state.sessionId) return;\n    \n    try {\n      await fetch(`/api/browser/session/${state.sessionId}`, { method: \"DELETE\" });\n      stopPolling();\n      if (wsRef.current) {\n        wsRef.current.close();\n        wsRef.current = null;\n      }\n      setState(initialState);\n    } catch (error) {\n      console.error(\"Close error:\", error);\n    }\n  }, [state.sessionId, stopPolling]);\n\n  const reset = useCallback(() => {\n    stopPolling();\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n    setState(initialState);\n  }, [stopPolling]);\n\n  useEffect(() => {\n    return () => {\n      stopPolling();\n      if (wsRef.current) {\n        wsRef.current.close();\n      }\n    };\n  }, [stopPolling]);\n\n  return {\n    state,\n    createSession,\n    subscribeToSession,\n    navigate,\n    click,\n    type,\n    scroll,\n    getPageState,\n    cancel,\n    close,\n    reset,\n  };\n}\n","path":null,"size_bytes":10791,"size_tokens":null},"server/agent/browser/index.ts":{"content":"export * from \"./types\";\nexport { browserSessionManager } from \"./session-manager\";\nexport { actionController } from \"./action-controller\";\nexport { observationCollector } from \"./observation-collector\";\n","path":null,"size_bytes":204,"size_tokens":null},"server/agent/browser/observation-collector.ts":{"content":"import { browserSessionManager } from \"./session-manager\";\nimport { Observation, PageState, NetworkRequest } from \"./types\";\n\nexport interface StructuredData {\n  metaTags: Record<string, string>;\n  jsonLd: any[];\n  openGraph: Record<string, string>;\n  twitterCard: Record<string, string>;\n  microdata: any[];\n  tables: any[][];\n  lists: string[][];\n}\n\nexport interface ExtractedContent {\n  title: string;\n  description: string;\n  mainContent: string;\n  structuredData: StructuredData;\n  links: { text: string; href: string }[];\n  images: { src: string; alt: string }[];\n  forms: { action: string; inputs: string[] }[];\n}\n\nclass ObservationCollector {\n  async collectFullObservation(sessionId: string): Promise<{\n    state: PageState | null;\n    screenshot: string | null;\n    structured: StructuredData | null;\n  }> {\n    const state = await browserSessionManager.getPageState(sessionId);\n    const screenshot = await browserSessionManager.getScreenshot(sessionId);\n    const structured = state ? this.extractStructuredData(state) : null;\n\n    return { state, screenshot, structured };\n  }\n\n  extractStructuredData(state: PageState): StructuredData {\n    const openGraph: Record<string, string> = {};\n    const twitterCard: Record<string, string> = {};\n\n    Object.entries(state.metaTags).forEach(([key, value]) => {\n      if (key.startsWith(\"og:\")) {\n        openGraph[key.replace(\"og:\", \"\")] = value;\n      } else if (key.startsWith(\"twitter:\")) {\n        twitterCard[key.replace(\"twitter:\", \"\")] = value;\n      }\n    });\n\n    return {\n      metaTags: state.metaTags,\n      jsonLd: state.jsonLd,\n      openGraph,\n      twitterCard,\n      microdata: [],\n      tables: [],\n      lists: []\n    };\n  }\n\n  async extractContent(sessionId: string): Promise<ExtractedContent | null> {\n    const state = await browserSessionManager.getPageState(sessionId);\n    if (!state) return null;\n\n    const structured = this.extractStructuredData(state);\n\n    return {\n      title: state.title,\n      description: state.metaTags[\"description\"] || \n                   structured.openGraph[\"description\"] || \n                   structured.twitterCard[\"description\"] || \"\",\n      mainContent: state.visibleText,\n      structuredData: structured,\n      links: state.links,\n      images: state.images,\n      forms: state.forms\n    };\n  }\n\n  async extractDataBySelector(\n    sessionId: string, \n    selectors: Record<string, string>\n  ): Promise<Record<string, string | null>> {\n    const session = browserSessionManager.getSession(sessionId);\n    if (!session) return {};\n\n    const result = await browserSessionManager.evaluate(sessionId, `\n      (function() {\n        const selectors = ${JSON.stringify(selectors)};\n        const result = {};\n        for (const [key, selector] of Object.entries(selectors)) {\n          const el = document.querySelector(selector);\n          result[key] = el ? el.textContent?.trim() || el.getAttribute('value') || null : null;\n        }\n        return result;\n      })()\n    `);\n\n    return result.success ? result.data : {};\n  }\n\n  async extractTable(sessionId: string, tableSelector: string): Promise<string[][]> {\n    const result = await browserSessionManager.evaluate(sessionId, `\n      (function() {\n        const table = document.querySelector('${tableSelector}');\n        if (!table) return [];\n        \n        const rows = [];\n        table.querySelectorAll('tr').forEach(tr => {\n          const cells = [];\n          tr.querySelectorAll('th, td').forEach(cell => {\n            cells.push(cell.textContent?.trim() || '');\n          });\n          if (cells.length > 0) rows.push(cells);\n        });\n        return rows;\n      })()\n    `);\n\n    return result.success ? result.data : [];\n  }\n\n  async extractList(sessionId: string, listSelector: string): Promise<string[]> {\n    const result = await browserSessionManager.evaluate(sessionId, `\n      (function() {\n        const list = document.querySelector('${listSelector}');\n        if (!list) return [];\n        \n        return Array.from(list.querySelectorAll('li')).map(li => li.textContent?.trim() || '');\n      })()\n    `);\n\n    return result.success ? result.data : [];\n  }\n\n  formatObservationForLLM(state: PageState | null, screenshot: string | null): string {\n    if (!state) return \"No page state available.\";\n\n    const sections: string[] = [\n      `# Current Page State`,\n      `**URL:** ${state.url}`,\n      `**Title:** ${state.title}`,\n      ``,\n      `## Visible Text (truncated):`,\n      state.visibleText.slice(0, 2000),\n      ``,\n      `## Available Links (${state.links.length} total):`,\n      ...state.links.slice(0, 15).map(l => `- [${l.text.slice(0, 50)}](${l.href})`),\n      ``,\n      `## Forms on Page (${state.forms.length}):`,\n      ...state.forms.slice(0, 5).map(f => `- Action: ${f.action}, Fields: ${f.inputs.join(\", \")}`),\n    ];\n\n    if (Object.keys(state.metaTags).length > 0) {\n      sections.push(``, `## Meta Tags:`);\n      Object.entries(state.metaTags).slice(0, 10).forEach(([k, v]) => {\n        sections.push(`- ${k}: ${v.slice(0, 100)}`);\n      });\n    }\n\n    if (state.jsonLd.length > 0) {\n      sections.push(``, `## Structured Data (JSON-LD):`, JSON.stringify(state.jsonLd[0], null, 2).slice(0, 500));\n    }\n\n    return sections.join(\"\\n\");\n  }\n}\n\nexport const observationCollector = new ObservationCollector();\n","path":null,"size_bytes":5328,"size_tokens":null},"server/services/parserRegistry.ts":{"content":"import type { FileParser, DetectedFileType, ParsedResult } from \"../parsers/base\";\nimport { PdfParser } from \"../parsers/pdfParser\";\nimport { DocxParser } from \"../parsers/docxParser\";\nimport { XlsxParser } from \"../parsers/xlsxParser\";\nimport { PptxParser } from \"../parsers/pptxParser\";\nimport { TextParser } from \"../parsers/textParser\";\nimport { FallbackParser } from \"../parsers/fallbackParser\";\nimport { ImageParser } from \"../parsers/imageParser\";\n\nclass ParserRegistry {\n  private parsers: FileParser[] = [];\n  private fallback: FileParser;\n\n  constructor() {\n    this.fallback = new FallbackParser();\n    this.registerParser(new PdfParser());\n    this.registerParser(new DocxParser());\n    this.registerParser(new XlsxParser());\n    this.registerParser(new PptxParser());\n    this.registerParser(new TextParser());\n    this.registerParser(new ImageParser());\n  }\n\n  registerParser(parser: FileParser): void {\n    this.parsers.push(parser);\n  }\n\n  getParser(type: DetectedFileType): FileParser {\n    for (const parser of this.parsers) {\n      if (parser.supportedMimeTypes.includes(type.mimeType)) {\n        return parser;\n      }\n    }\n    return this.fallback;\n  }\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    const parser = this.getParser(type);\n    return parser.parse(content, type);\n  }\n}\n\nexport const parserRegistry = new ParserRegistry();\n","path":null,"size_bytes":1396,"size_tokens":null},"server/agent/pipeline/tools/index.ts":{"content":"import { toolRegistry } from \"../registry\";\nimport { webNavigateTool } from \"./web-navigate\";\nimport { extractContentTool } from \"./extract-content\";\nimport { generateFileTool } from \"./generate-file\";\nimport { transformDataTool } from \"./transform-data\";\nimport { respondTool } from \"./respond\";\nimport { searchWebTool } from \"./search-web\";\nimport { analyzeDataTool } from \"./analyze-data\";\n\nexport function registerBuiltinTools(): void {\n  toolRegistry.register(webNavigateTool);\n  toolRegistry.register(extractContentTool);\n  toolRegistry.register(generateFileTool);\n  toolRegistry.register(transformDataTool);\n  toolRegistry.register(respondTool);\n  toolRegistry.register(searchWebTool);\n  toolRegistry.register(analyzeDataTool);\n}\n\nexport * from \"./web-navigate\";\nexport * from \"./extract-content\";\nexport * from \"./generate-file\";\nexport * from \"./transform-data\";\nexport * from \"./respond\";\nexport * from \"./search-web\";\nexport * from \"./analyze-data\";\n","path":null,"size_bytes":961,"size_tokens":null},"server/agent/pipeline/planner.ts":{"content":"import OpenAI from \"openai\";\nimport crypto from \"crypto\";\nimport { toolRegistry } from \"./registry\";\nimport { ExecutionPlan, PlanStep, InterpretedIntent } from \"./types\";\n\nfunction getOpenAIClient(): OpenAI {\n  if (!process.env.XAI_API_KEY) {\n    throw new Error(\"XAI_API_KEY is not configured\");\n  }\n  return new OpenAI({ \n    baseURL: \"https://api.x.ai/v1\", \n    apiKey: process.env.XAI_API_KEY \n  });\n}\n\nasync function callWithRetry<T>(\n  fn: () => Promise<T>,\n  maxRetries: number = 3,\n  delayMs: number = 1000\n): Promise<T> {\n  let lastError: Error | null = null;\n  \n  for (let attempt = 0; attempt < maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error: any) {\n      lastError = error;\n      console.warn(`API call failed (attempt ${attempt + 1}/${maxRetries}):`, error.message);\n      \n      if (attempt < maxRetries - 1) {\n        await new Promise(resolve => setTimeout(resolve, delayMs * Math.pow(2, attempt)));\n      }\n    }\n  }\n  \n  throw lastError || new Error(\"API call failed after retries\");\n}\n\nexport async function interpretIntent(userMessage: string): Promise<InterpretedIntent> {\n  const openai = getOpenAIClient();\n  const tools = toolRegistry.getToolManifest();\n  \n  const response = await callWithRetry(() => openai.chat.completions.create({\n    model: \"grok-3-fast\",\n    messages: [\n      {\n        role: \"system\",\n        content: `You are an intent interpreter. Analyze the user's request and extract:\n1. The main action they want to perform\n2. Key entities (URLs, file names, data types, etc.)\n3. Any constraints or requirements\n4. What output format they expect\n\nRespond in JSON format:\n{\n  \"action\": \"brief action description\",\n  \"entities\": { \"key\": \"value\" },\n  \"constraints\": [\"constraint1\", \"constraint2\"],\n  \"expectedOutput\": \"description of expected output\",\n  \"confidence\": 0.0-1.0\n}`\n      },\n      {\n        role: \"user\",\n        content: userMessage\n      }\n    ],\n    response_format: { type: \"json_object\" }\n  }));\n\n  try {\n    const parsed = JSON.parse(response.choices[0]?.message?.content || \"{}\");\n    return {\n      action: parsed.action || \"unknown\",\n      entities: parsed.entities || {},\n      constraints: parsed.constraints || [],\n      expectedOutput: parsed.expectedOutput || \"text response\",\n      confidence: parsed.confidence || 0.5\n    };\n  } catch {\n    return {\n      action: \"process request\",\n      entities: {},\n      constraints: [],\n      expectedOutput: \"text response\",\n      confidence: 0.3\n    };\n  }\n}\n\n// Detect URLs in text\nfunction detectUrls(text: string): string[] {\n  const urlRegex = /https?:\\/\\/[^\\s<>\"{}|\\\\^`\\[\\]()]+/gi;\n  const urls = text.match(urlRegex) || [];\n  // Clean up any trailing punctuation\n  return urls.map(url => url.replace(/[.,;:!?]+$/, ''));\n}\n\n// Detect search intent\nfunction hasSearchIntent(text: string): boolean {\n  const searchPatterns = [\n    /\\b(busca|buscar|búsqueda|search|find|look up|lookup|google|investigar|investiga)\\b/i,\n    /\\b(qué es|what is|quién es|who is|dónde|where|cómo|how to)\\b/i,\n    /\\?$/  // Questions often indicate search intent\n  ];\n  return searchPatterns.some(p => p.test(text));\n}\n\nexport async function createPlan(\n  runId: string,\n  objective: string,\n  intent: InterpretedIntent\n): Promise<ExecutionPlan> {\n  const openai = getOpenAIClient();\n  const tools = toolRegistry.getToolManifest();\n  \n  // Check for URLs first - force web_navigate if URL detected\n  const detectedUrls = detectUrls(objective);\n  \n  if (detectedUrls.length > 0) {\n    return {\n      id: `plan_${crypto.randomUUID()}`,\n      runId,\n      objective,\n      interpretedIntent: intent,\n      steps: [{\n        id: `step_0_${crypto.randomUUID().slice(0, 8)}`,\n        toolId: \"web_navigate\",\n        description: `Navigate to ${detectedUrls[0]}`,\n        params: { url: detectedUrls[0], takeScreenshot: true }\n      }],\n      createdAt: new Date(),\n      estimatedDuration: 30000\n    };\n  }\n  \n  // Check for search intent - force search_web\n  const searchIntent = hasSearchIntent(objective);\n  \n  if (searchIntent) {\n    return {\n      id: `plan_${crypto.randomUUID()}`,\n      runId,\n      objective,\n      interpretedIntent: intent,\n      steps: [{\n        id: `step_0_${crypto.randomUUID().slice(0, 8)}`,\n        toolId: \"search_web\",\n        description: `Search the web for: ${objective}`,\n        params: { query: objective, engine: \"duckduckgo\", maxResults: 5 }\n      }],\n      createdAt: new Date(),\n      estimatedDuration: 30000\n    };\n  }\n  \n  const toolDescriptions = tools.map(t => \n    `- ${t.id}: ${t.description} (capabilities: ${t.capabilities.join(\", \")})`\n  ).join(\"\\n\");\n\n  const response = await callWithRetry(() => openai.chat.completions.create({\n    model: \"grok-3-fast\",\n    messages: [\n      {\n        role: \"system\",\n        content: `You are an execution planner. Given a user objective and available tools, create a step-by-step execution plan.\n\nAvailable tools:\n${toolDescriptions}\n\nCreate a plan as JSON array of steps:\n[\n  {\n    \"toolId\": \"tool_id\",\n    \"description\": \"what this step does\",\n    \"params\": { \"param1\": \"value1\" },\n    \"dependsOn\": [\"previous_step_id\"],\n    \"optional\": false\n  }\n]\n\nRules:\n- Use only available tools\n- Each step should have a clear purpose\n- Set dependencies between steps when outputs are needed\n- Mark truly optional steps as optional: true\n- Keep the plan minimal but complete\n- Extract URLs, file names, and data from the entities provided`\n      },\n      {\n        role: \"user\",\n        content: `Objective: ${objective}\n\nInterpreted intent:\n- Action: ${intent.action}\n- Entities: ${JSON.stringify(intent.entities)}\n- Constraints: ${intent.constraints.join(\", \")}\n- Expected output: ${intent.expectedOutput}\n\nCreate an execution plan.`\n      }\n    ],\n    response_format: { type: \"json_object\" }\n  }));\n\n  let steps: PlanStep[] = [];\n  \n  try {\n    const parsed = JSON.parse(response.choices[0]?.message?.content || \"{}\");\n    const rawSteps = parsed.steps || parsed.plan || [];\n    \n    steps = rawSteps.map((step: any, index: number) => ({\n      id: `step_${index}_${crypto.randomUUID().slice(0, 8)}`,\n      toolId: step.toolId || step.tool || \"respond\",\n      description: step.description || `Step ${index + 1}`,\n      params: step.params || {},\n      dependsOn: step.dependsOn || (index > 0 ? [steps[index - 1]?.id] : undefined),\n      condition: step.condition,\n      optional: step.optional || false,\n      timeout: step.timeout,\n      retryPolicy: step.retryPolicy\n    }));\n  } catch (e) {\n    console.error(\"Failed to parse plan:\", e);\n    steps = [{\n      id: `step_0_${crypto.randomUUID().slice(0, 8)}`,\n      toolId: \"respond\",\n      description: \"Generate response\",\n      params: { objective }\n    }];\n  }\n\n  if (steps.length === 0) {\n    steps = [{\n      id: `step_0_${crypto.randomUUID().slice(0, 8)}`,\n      toolId: \"respond\",\n      description: \"Generate response\",\n      params: { objective }\n    }];\n  }\n\n  return {\n    id: `plan_${crypto.randomUUID()}`,\n    runId,\n    objective,\n    interpretedIntent: intent,\n    steps,\n    createdAt: new Date(),\n    estimatedDuration: steps.length * 5000\n  };\n}\n\nexport async function refinePlan(\n  plan: ExecutionPlan,\n  feedback: string\n): Promise<ExecutionPlan> {\n  const openai = getOpenAIClient();\n  const response = await callWithRetry(() => openai.chat.completions.create({\n    model: \"grok-3-fast\",\n    messages: [\n      {\n        role: \"system\",\n        content: `You are refining an execution plan based on feedback. Modify the plan to address the issues.\nReturn the complete updated plan in the same JSON format.`\n      },\n      {\n        role: \"user\",\n        content: `Current plan:\n${JSON.stringify(plan.steps, null, 2)}\n\nFeedback: ${feedback}\n\nProvide the refined plan.`\n      }\n    ],\n    response_format: { type: \"json_object\" }\n  }));\n\n  try {\n    const parsed = JSON.parse(response.choices[0]?.message?.content || \"{}\");\n    const rawSteps = parsed.steps || parsed.plan || plan.steps;\n    \n    return {\n      ...plan,\n      id: `plan_${crypto.randomUUID()}`,\n      steps: rawSteps.map((step: any, index: number) => ({\n        id: step.id || `step_${index}_${crypto.randomUUID().slice(0, 8)}`,\n        toolId: step.toolId,\n        description: step.description,\n        params: step.params || {},\n        dependsOn: step.dependsOn,\n        condition: step.condition,\n        optional: step.optional || false,\n        timeout: step.timeout,\n        retryPolicy: step.retryPolicy\n      })),\n      createdAt: new Date()\n    };\n  } catch {\n    return plan;\n  }\n}\n","path":null,"size_bytes":8537,"size_tokens":null},"server/agent/pipeline/engine.ts":{"content":"import crypto from \"crypto\";\nimport { storage } from \"../../storage\";\nimport { toolRegistry } from \"./registry\";\nimport { interpretIntent, createPlan, refinePlan } from \"./planner\";\nimport { pipelineExecutor, StepCallback } from \"./executor\";\nimport { registerBuiltinTools } from \"./tools\";\nimport {\n  ExecutionPlan,\n  PipelineResult,\n  PipelineConfig,\n  DEFAULT_PIPELINE_CONFIG,\n  ProgressUpdate,\n  StepResult,\n  Artifact\n} from \"./types\";\n\nlet initialized = false;\n\nexport function initializePipeline(): void {\n  if (initialized) return;\n  registerBuiltinTools();\n  initialized = true;\n}\n\nexport interface PipelineRunOptions {\n  objective: string;\n  conversationId?: string;\n  userId?: string;\n  config?: Partial<PipelineConfig>;\n  onProgress?: (update: ProgressUpdate) => void;\n}\n\nexport async function runPipeline(options: PipelineRunOptions): Promise<PipelineResult> {\n  const { objective, conversationId, userId, config, onProgress } = options;\n  const startTime = Date.now();\n  \n  initializePipeline();\n  \n  let runId = \"\";\n  \n  try {\n    const agentRun = await storage.createAgentRun({\n      conversationId,\n      status: \"pending\",\n      routerDecision: \"pipeline\",\n      objective\n    });\n    \n    runId = agentRun.id;\n\n    onProgress?.({\n      runId,\n      stepId: \"init\",\n      status: \"started\",\n      message: \"Interpreting request...\"\n    });\n\n    const intent = await interpretIntent(objective);\n    \n    onProgress?.({\n      runId,\n      stepId: \"plan\",\n      status: \"started\",\n      message: \"Creating execution plan...\",\n      detail: { intent }\n    });\n\n    const plan = await createPlan(agentRun.id, objective, intent);\n    \n    onProgress?.({\n      runId,\n      stepId: \"plan\",\n      status: \"completed\",\n      message: `Plan created with ${plan.steps.length} steps`,\n      detail: { \n        steps: plan.steps.map(s => ({ id: s.id, tool: s.toolId, description: s.description }))\n      }\n    });\n\n    await storage.updateAgentRunStatus(agentRun.id, \"running\");\n\n    const { results, artifacts } = await pipelineExecutor.execute(plan, onProgress);\n\n    const successCount = results.filter(r => r.status === \"completed\").length;\n    const failCount = results.filter(r => r.status === \"failed\").length;\n    const success = failCount === 0 || successCount > 0;\n\n    await storage.updateAgentRunStatus(\n      agentRun.id, \n      success ? \"completed\" : \"failed\",\n      success ? undefined : \"Some steps failed\"\n    );\n\n    const lastResult = results.filter(r => r.status === \"completed\").pop();\n    let summary = \"\";\n    \n    if (lastResult?.output?.data?.response) {\n      summary = lastResult.output.data.response;\n    } else if (lastResult?.output?.data?.textContent) {\n      summary = lastResult.output.data.textContent.slice(0, 5000);\n    } else if (lastResult?.output?.data) {\n      summary = JSON.stringify(lastResult.output.data).slice(0, 5000);\n    }\n\n    const totalDuration = Date.now() - startTime;\n\n    onProgress?.({\n      runId,\n      stepId: \"complete\",\n      status: \"completed\",\n      message: `Pipeline completed: ${successCount}/${results.length} steps successful`,\n      detail: { totalDuration, successCount, failCount }\n    });\n\n    return {\n      runId: agentRun.id,\n      planId: plan.id,\n      success,\n      summary,\n      steps: results,\n      artifacts,\n      errors: results.filter(r => r.status === \"failed\").map(r => r.output?.error || \"Unknown error\"),\n      totalDuration,\n      metadata: {\n        objective,\n        intent,\n        stepsPlanned: plan.steps.length,\n        stepsExecuted: results.length\n      }\n    };\n  } catch (error: any) {\n    console.error(\"Pipeline execution error:\", error);\n    \n    const errorRunId = runId || crypto.randomUUID();\n    \n    onProgress?.({\n      runId: errorRunId,\n      stepId: \"error\",\n      status: \"failed\",\n      message: error.message\n    });\n\n    return {\n      runId: errorRunId,\n      planId: \"\",\n      success: false,\n      summary: `Error: ${error.message}`,\n      steps: [],\n      artifacts: [],\n      errors: [error.message],\n      totalDuration: Date.now() - startTime\n    };\n  }\n}\n\nexport function cancelPipeline(runId: string): boolean {\n  pipelineExecutor.cancel(runId);\n  return true;\n}\n\nexport function getAvailableTools(): { id: string; name: string; description: string; category: string }[] {\n  initializePipeline();\n  return toolRegistry.getToolManifest();\n}\n","path":null,"size_bytes":4376,"size_tokens":null},"server/agent/pipeline/index.ts":{"content":"export * from \"./types\";\nexport * from \"./registry\";\nexport * from \"./planner\";\nexport * from \"./executor\";\nexport * from \"./engine\";\nexport { registerBuiltinTools } from \"./tools\";\nexport { runBrowserLoop, planNextAction, executeAction, evaluateProgress } from \"./browser-planner\";\nexport { multiIntentManager } from \"./multiIntentManager\";\nexport { multiIntentPipeline, MultiIntentPipeline } from \"./multiIntentPipeline\";\n","path":null,"size_bytes":424,"size_tokens":null},"server/agent/pipeline/types.ts":{"content":"export interface ToolDefinition {\n  id: string;\n  name: string;\n  description: string;\n  category: ToolCategory;\n  inputSchema: Record<string, ParameterSchema>;\n  outputSchema: Record<string, ParameterSchema>;\n  capabilities: string[];\n  requiresApproval?: boolean;\n  rateLimit?: { requests: number; windowMs: number };\n  timeout?: number;\n  execute: (context: ExecutionContext, params: Record<string, any>) => Promise<ToolResult>;\n  validate?: (params: Record<string, any>) => ValidationResult;\n}\n\nexport type ToolCategory = \n  | \"web\" \n  | \"data\" \n  | \"file\" \n  | \"transform\" \n  | \"api\" \n  | \"analysis\" \n  | \"utility\";\n\nexport interface ParameterSchema {\n  type: \"string\" | \"number\" | \"boolean\" | \"array\" | \"object\";\n  description: string;\n  required?: boolean;\n  default?: any;\n  enum?: any[];\n  items?: ParameterSchema;\n  properties?: Record<string, ParameterSchema>;\n}\n\nexport interface ExecutionContext {\n  runId: string;\n  planId: string;\n  stepIndex: number;\n  userId?: string;\n  conversationId?: string;\n  previousResults: StepResult[];\n  artifacts: Map<string, Artifact>;\n  variables: Map<string, any>;\n  onProgress: (update: ProgressUpdate) => void;\n  isCancelled: () => boolean;\n}\n\nexport interface ProgressUpdate {\n  runId: string;\n  stepId: string;\n  status: \"started\" | \"progress\" | \"completed\" | \"failed\" | \"skipped\";\n  progress?: number;\n  message?: string;\n  detail?: any;\n}\n\nexport interface ToolResult {\n  success: boolean;\n  data?: any;\n  error?: string;\n  artifacts?: Artifact[];\n  metadata?: Record<string, any>;\n}\n\nexport interface ValidationResult {\n  valid: boolean;\n  errors?: string[];\n  warnings?: string[];\n}\n\nexport interface Artifact {\n  id: string;\n  type: ArtifactType;\n  name: string;\n  content?: string;\n  storagePath?: string;\n  mimeType?: string;\n  size?: number;\n  metadata?: Record<string, any>;\n}\n\nexport type ArtifactType = \n  | \"text\" \n  | \"json\" \n  | \"html\" \n  | \"markdown\" \n  | \"image\" \n  | \"document\" \n  | \"spreadsheet\"\n  | \"screenshot\"\n  | \"file\";\n\nexport interface PlanStep {\n  id: string;\n  toolId: string;\n  description: string;\n  params: Record<string, any>;\n  dependsOn?: string[];\n  condition?: string;\n  retryPolicy?: RetryPolicy;\n  timeout?: number;\n  optional?: boolean;\n}\n\nexport interface RetryPolicy {\n  maxRetries: number;\n  delayMs: number;\n  backoffMultiplier?: number;\n}\n\nexport interface ExecutionPlan {\n  id: string;\n  runId: string;\n  objective: string;\n  interpretedIntent: InterpretedIntent;\n  steps: PlanStep[];\n  createdAt: Date;\n  estimatedDuration?: number;\n}\n\nexport interface InterpretedIntent {\n  action: string;\n  entities: Record<string, any>;\n  constraints: string[];\n  expectedOutput: string;\n  confidence: number;\n}\n\nexport interface StepResult {\n  stepId: string;\n  toolId: string;\n  status: \"pending\" | \"running\" | \"completed\" | \"failed\" | \"skipped\";\n  startedAt?: Date;\n  completedAt?: Date;\n  input: Record<string, any>;\n  output?: ToolResult;\n  retryCount: number;\n  duration?: number;\n  validated: boolean;\n  validationErrors?: string[];\n}\n\nexport interface PipelineResult {\n  runId: string;\n  planId: string;\n  success: boolean;\n  summary: string;\n  steps: StepResult[];\n  artifacts: Artifact[];\n  errors?: string[];\n  totalDuration: number;\n  metadata?: Record<string, any>;\n}\n\nexport interface PipelineConfig {\n  maxSteps: number;\n  defaultTimeout: number;\n  enableParallelExecution: boolean;\n  maxParallelSteps: number;\n  auditLevel: \"minimal\" | \"standard\" | \"verbose\";\n  sandboxMode: boolean;\n}\n\nexport const DEFAULT_PIPELINE_CONFIG: PipelineConfig = {\n  maxSteps: 20,\n  defaultTimeout: 60000,\n  enableParallelExecution: true,\n  maxParallelSteps: 3,\n  auditLevel: \"standard\",\n  sandboxMode: true\n};\n","path":null,"size_bytes":3690,"size_tokens":null},"server/agent/router.ts":{"content":"import OpenAI from \"openai\";\n\nconst openai = new OpenAI({ \n  baseURL: \"https://api.x.ai/v1\", \n  apiKey: process.env.XAI_API_KEY \n});\n\nexport type RouteDecision = \"llm\" | \"agent\" | \"hybrid\";\n\nexport interface RouteResult {\n  decision: RouteDecision;\n  confidence: number;\n  urls: string[];\n  objective?: string;\n  reasoning: string;\n}\n\nconst URL_REGEX = /https?:\\/\\/[^\\s<>\"{}|\\\\^`\\[\\]]+/gi;\nconst DOMAIN_REGEX = /(?:^|\\s)((?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\\.)+[a-z]{2,})/gi;\n\nconst WEB_ACTION_KEYWORDS = [\n  \"busca\", \"buscar\", \"search\", \"find\", \"encuentra\",\n  \"navega\", \"navigate\", \"go to\", \"ir a\", \"abre\", \"open\",\n  \"extrae\", \"extract\", \"scrape\", \"obtén\", \"get\",\n  \"lee\", \"read\", \"muéstrame\", \"show me\",\n  \"descarga\", \"download\", \"investiga\", \"research\",\n  \"compara\", \"compare\", \"analiza\", \"analyze\",\n  \"visita\", \"visit\", \"revisa\", \"check\", \"consulta\"\n];\n\nconst CONTENT_CREATION_KEYWORDS = [\n  \"escribe\", \"write\", \"crea\", \"create\", \"genera\", \"generate\",\n  \"redacta\", \"compose\", \"haz\", \"make\", \"diseña\", \"design\"\n];\n\nexport function extractUrls(text: string): string[] {\n  // Remove content inside [ARCHIVO ADJUNTO] blocks to avoid extracting URLs from attached files\n  let textWithoutAttachments = text;\n  // Use [\\s\\S] instead of . with s flag for multiline matching\n  const attachmentPattern = /\\[ARCHIVO ADJUNTO:[\\s\\S]*?\\[FIN DEL ARCHIVO\\]/g;\n  textWithoutAttachments = textWithoutAttachments.replace(attachmentPattern, '');\n  \n  const urls: string[] = [];\n  const urlMatches = textWithoutAttachments.match(URL_REGEX);\n  if (urlMatches) {\n    urls.push(...urlMatches);\n  }\n  return Array.from(new Set(urls));\n}\n\n// Extract only the user's request from a message that may contain file content\nfunction extractUserRequest(text: string): string {\n  // If message has the [SOLICITUD DEL USUARIO] marker, extract only that part\n  const userRequestMatch = text.match(/\\[SOLICITUD DEL USUARIO\\]:\\s*([\\s\\S]+)$/);\n  if (userRequestMatch) {\n    return userRequestMatch[1].trim();\n  }\n  // Otherwise return the full text (no attachments)\n  return text;\n}\n\nexport function hasWebActionIntent(text: string): boolean {\n  const lowerText = text.toLowerCase();\n  return WEB_ACTION_KEYWORDS.some(keyword => lowerText.includes(keyword));\n}\n\nexport function hasContentCreationIntent(text: string): boolean {\n  const lowerText = text.toLowerCase();\n  return CONTENT_CREATION_KEYWORDS.some(keyword => lowerText.includes(keyword));\n}\n\nexport async function routeMessage(message: string): Promise<RouteResult> {\n  // Extract only the user's actual request (not file content) for routing decisions\n  const userRequest = extractUserRequest(message);\n  const urls = extractUrls(message);\n  const hasUrls = urls.length > 0;\n  // Check intents only on the user's request, not on file content\n  const hasWebIntent = hasWebActionIntent(userRequest);\n  const hasContentIntent = hasContentCreationIntent(userRequest);\n  \n  // Check if message has file attachments - if so, likely a file processing request\n  const hasAttachments = message.includes(\"[ARCHIVO ADJUNTO:\");\n  \n  // If there are file attachments and no explicit URLs in user's request, route to LLM\n  if (hasAttachments && !hasUrls) {\n    return {\n      decision: \"llm\",\n      confidence: 0.95,\n      urls: [],\n      reasoning: \"File attachments detected - processing with LLM\"\n    };\n  }\n\n  if (!hasUrls && !hasWebIntent) {\n    return {\n      decision: \"llm\",\n      confidence: 0.9,\n      urls: [],\n      reasoning: \"No URLs or web action intent detected\"\n    };\n  }\n\n  if (hasUrls && !hasContentIntent) {\n    return {\n      decision: \"agent\",\n      confidence: 0.85,\n      urls,\n      objective: `Navigate and extract information from: ${urls.join(\", \")}`,\n      reasoning: \"URLs detected with extraction intent\"\n    };\n  }\n\n  if (hasWebIntent && !hasUrls) {\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"grok-3-fast\",\n        messages: [\n          {\n            role: \"system\",\n            content: `You are a routing classifier. Analyze the user's message and determine if it requires web browsing/navigation to complete.\n            \nRespond with JSON only:\n{\n  \"requires_web\": boolean,\n  \"confidence\": number (0-1),\n  \"search_query\": string or null (if web search needed),\n  \"reasoning\": string\n}`\n          },\n          { role: \"user\", content: message }\n        ],\n        temperature: 0.1\n      });\n\n      const content = response.choices[0]?.message?.content || \"{}\";\n      const parsed = JSON.parse(content.replace(/```json\\n?|\\n?```/g, \"\"));\n\n      if (parsed.requires_web && parsed.confidence > 0.7) {\n        return {\n          decision: \"agent\",\n          confidence: parsed.confidence,\n          urls: [],\n          objective: parsed.search_query || message,\n          reasoning: parsed.reasoning\n        };\n      }\n    } catch (e) {\n      console.error(\"Router LLM error:\", e);\n    }\n  }\n\n  if (hasUrls && hasContentIntent) {\n    return {\n      decision: \"hybrid\",\n      confidence: 0.8,\n      urls,\n      objective: `Extract from ${urls.join(\", \")} and create content`,\n      reasoning: \"URLs detected with content creation intent - needs extraction then generation\"\n    };\n  }\n\n  return {\n    decision: \"llm\",\n    confidence: 0.7,\n    urls,\n    reasoning: \"Defaulting to LLM response\"\n  };\n}\n","path":null,"size_bytes":5294,"size_tokens":null},"client/src/components/agent-observer.tsx":{"content":"import { AgentStep } from \"@/hooks/use-agent\";\n\ninterface AgentObserverProps {\n  steps: AgentStep[];\n  objective?: string;\n  status: \"idle\" | \"running\" | \"completed\" | \"failed\" | \"cancelled\";\n  onCancel?: () => void;\n}\n\nexport function AgentObserver(_props: AgentObserverProps) {\n  return null;\n}\n","path":null,"size_bytes":297,"size_tokens":null},"server/agent/browser/session-manager.ts":{"content":"import { chromium, Browser, Page, BrowserContext, Request, Response } from \"playwright\";\nimport crypto from \"crypto\";\nimport { \n  SessionConfig, \n  DEFAULT_SESSION_CONFIG, \n  BrowserAction, \n  ActionResult, \n  Observation,\n  NetworkRequest,\n  PageState,\n  SessionEvent,\n  SessionEventCallback,\n  ComputerSession\n} from \"./types\";\n\ninterface ActiveSession {\n  id: string;\n  browser: Browser;\n  context: BrowserContext;\n  page: Page;\n  config: SessionConfig;\n  objective: string;\n  actions: BrowserAction[];\n  observations: Observation[];\n  networkRequests: NetworkRequest[];\n  callbacks: Set<SessionEventCallback>;\n  screenshotInterval?: ReturnType<typeof setInterval>;\n  createdAt: Date;\n  status: \"active\" | \"paused\" | \"completed\" | \"error\" | \"cancelled\";\n}\n\nclass BrowserSessionManager {\n  private sessions: Map<string, ActiveSession> = new Map();\n  private globalCallbacks: Set<SessionEventCallback> = new Set();\n\n  async createSession(\n    objective: string,\n    config: Partial<SessionConfig> = {},\n    onEvent?: SessionEventCallback\n  ): Promise<string> {\n    const sessionConfig = { ...DEFAULT_SESSION_CONFIG, ...config };\n    const sessionId = crypto.randomUUID();\n\n    const browser = await chromium.launch({\n      headless: true,\n      args: [\n        \"--no-sandbox\",\n        \"--disable-setuid-sandbox\",\n        \"--disable-dev-shm-usage\",\n        \"--disable-accelerated-2d-canvas\",\n        \"--disable-gpu\",\n        `--window-size=${sessionConfig.viewport!.width},${sessionConfig.viewport!.height}`\n      ]\n    });\n\n    const context = await browser.newContext({\n      viewport: sessionConfig.viewport,\n      userAgent: sessionConfig.userAgent || \n        \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n      acceptDownloads: true\n    });\n\n    const page = await context.newPage();\n\n    const session: ActiveSession = {\n      id: sessionId,\n      browser,\n      context,\n      page,\n      config: sessionConfig,\n      objective,\n      actions: [],\n      observations: [],\n      networkRequests: [],\n      callbacks: new Set(),\n      createdAt: new Date(),\n      status: \"active\"\n    };\n\n    if (onEvent) {\n      session.callbacks.add(onEvent);\n    }\n\n    if (sessionConfig.enableNetworkCapture) {\n      this.setupNetworkCapture(session);\n    }\n\n    this.sessions.set(sessionId, session);\n    \n    this.emitEvent(session, {\n      type: \"started\",\n      sessionId,\n      timestamp: new Date(),\n      data: { objective, config: sessionConfig }\n    });\n\n    return sessionId;\n  }\n\n  private setupNetworkCapture(session: ActiveSession): void {\n    session.page.on(\"request\", (request: Request) => {\n      const req: NetworkRequest = {\n        url: request.url(),\n        method: request.method()\n      };\n      session.networkRequests.push(req);\n    });\n\n    session.page.on(\"response\", (response: Response) => {\n      const url = response.url();\n      const existing = session.networkRequests.find(r => r.url === url && !r.status);\n      if (existing) {\n        existing.status = response.status();\n        existing.mimeType = response.headers()[\"content-type\"];\n      }\n    });\n  }\n\n  private emitEvent(session: ActiveSession, event: SessionEvent): void {\n    session.callbacks.forEach(cb => {\n      try { cb(event); } catch (e) { console.error(\"Event callback error:\", e); }\n    });\n    this.globalCallbacks.forEach(cb => {\n      try { cb(event); } catch (e) { console.error(\"Global callback error:\", e); }\n    });\n  }\n\n  async navigate(sessionId: string, url: string): Promise<ActionResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    const action: BrowserAction = {\n      type: \"navigate\",\n      params: { url },\n      timestamp: new Date()\n    };\n    session.actions.push(action);\n\n    const startTime = Date.now();\n\n    try {\n      if (session.config.allowedDomains && session.config.allowedDomains.length > 0) {\n        const domain = new URL(url).hostname;\n        const allowed = session.config.allowedDomains.some(d => \n          domain === d || domain.endsWith(`.${d}`)\n        );\n        if (!allowed) {\n          return {\n            success: false,\n            action,\n            error: `Domain ${domain} not in allowed list`,\n            duration: Date.now() - startTime\n          };\n        }\n      }\n\n      await session.page.goto(url, {\n        waitUntil: \"networkidle\",\n        timeout: session.config.timeout\n      });\n\n      const screenshot = await this.captureScreenshot(session);\n      \n      this.emitEvent(session, {\n        type: \"action\",\n        sessionId,\n        timestamp: new Date(),\n        data: { action: \"navigate\", url, screenshot }\n      });\n\n      return {\n        success: true,\n        action,\n        data: {\n          url: session.page.url(),\n          title: await session.page.title()\n        },\n        screenshot,\n        duration: Date.now() - startTime\n      };\n    } catch (error: any) {\n      this.emitEvent(session, {\n        type: \"error\",\n        sessionId,\n        timestamp: new Date(),\n        data: { action: \"navigate\", error: error.message }\n      });\n\n      return {\n        success: false,\n        action,\n        error: error.message,\n        duration: Date.now() - startTime\n      };\n    }\n  }\n\n  async click(sessionId: string, selector: string): Promise<ActionResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    const action: BrowserAction = {\n      type: \"click\",\n      params: { selector },\n      timestamp: new Date()\n    };\n    session.actions.push(action);\n\n    const startTime = Date.now();\n\n    try {\n      await session.page.click(selector, { timeout: 10000 });\n      await session.page.waitForLoadState(\"networkidle\", { timeout: 5000 }).catch(() => {});\n      \n      const screenshot = await this.captureScreenshot(session);\n\n      this.emitEvent(session, {\n        type: \"action\",\n        sessionId,\n        timestamp: new Date(),\n        data: { action: \"click\", selector, screenshot }\n      });\n\n      return {\n        success: true,\n        action,\n        data: { newUrl: session.page.url() },\n        screenshot,\n        duration: Date.now() - startTime\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        action,\n        error: error.message,\n        duration: Date.now() - startTime\n      };\n    }\n  }\n\n  async type(sessionId: string, selector: string, text: string): Promise<ActionResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    const action: BrowserAction = {\n      type: \"type\",\n      params: { selector, text },\n      timestamp: new Date()\n    };\n    session.actions.push(action);\n\n    const startTime = Date.now();\n\n    try {\n      await session.page.fill(selector, text, { timeout: 10000 });\n      \n      const screenshot = await this.captureScreenshot(session);\n\n      this.emitEvent(session, {\n        type: \"action\",\n        sessionId,\n        timestamp: new Date(),\n        data: { action: \"type\", selector, textLength: text.length, screenshot }\n      });\n\n      return {\n        success: true,\n        action,\n        screenshot,\n        duration: Date.now() - startTime\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        action,\n        error: error.message,\n        duration: Date.now() - startTime\n      };\n    }\n  }\n\n  async scroll(sessionId: string, direction: \"up\" | \"down\", amount: number = 300): Promise<ActionResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    const action: BrowserAction = {\n      type: \"scroll\",\n      params: { direction, amount },\n      timestamp: new Date()\n    };\n    session.actions.push(action);\n\n    const startTime = Date.now();\n\n    try {\n      const scrollAmount = direction === \"down\" ? amount : -amount;\n      await session.page.evaluate((y) => window.scrollBy(0, y), scrollAmount);\n      await session.page.waitForTimeout(300);\n      \n      const screenshot = await this.captureScreenshot(session);\n\n      this.emitEvent(session, {\n        type: \"action\",\n        sessionId,\n        timestamp: new Date(),\n        data: { action: \"scroll\", direction, amount, screenshot }\n      });\n\n      return {\n        success: true,\n        action,\n        screenshot,\n        duration: Date.now() - startTime\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        action,\n        error: error.message,\n        duration: Date.now() - startTime\n      };\n    }\n  }\n\n  async wait(sessionId: string, ms: number): Promise<ActionResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    const action: BrowserAction = {\n      type: \"wait\",\n      params: { ms },\n      timestamp: new Date()\n    };\n    session.actions.push(action);\n\n    const startTime = Date.now();\n\n    await session.page.waitForTimeout(ms);\n    const screenshot = await this.captureScreenshot(session);\n\n    return {\n      success: true,\n      action,\n      screenshot,\n      duration: Date.now() - startTime\n    };\n  }\n\n  async evaluate(sessionId: string, script: string): Promise<ActionResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    const action: BrowserAction = {\n      type: \"evaluate\",\n      params: { script },\n      timestamp: new Date()\n    };\n    session.actions.push(action);\n\n    const startTime = Date.now();\n\n    try {\n      const result = await session.page.evaluate(script);\n      \n      return {\n        success: true,\n        action,\n        data: result,\n        duration: Date.now() - startTime\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        action,\n        error: error.message,\n        duration: Date.now() - startTime\n      };\n    }\n  }\n\n  private async captureScreenshot(session: ActiveSession): Promise<string> {\n    try {\n      const buffer = await session.page.screenshot({ \n        type: \"png\",\n        fullPage: false\n      });\n      return `data:image/png;base64,${buffer.toString(\"base64\")}`;\n    } catch {\n      return \"\";\n    }\n  }\n\n  async getPageState(sessionId: string): Promise<PageState | null> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return null;\n\n    try {\n      const state = await session.page.evaluate(`\n        (function() {\n          var walker = document.createTreeWalker(\n            document.body,\n            NodeFilter.SHOW_TEXT,\n            null\n          );\n          var visibleText = \"\";\n          var node;\n          while (node = walker.nextNode()) {\n            var parent = node.parentElement;\n            if (parent && getComputedStyle(parent).display !== \"none\") {\n              var txt = node.textContent;\n              if (txt) visibleText += txt.trim() + \" \";\n            }\n          }\n          visibleText = visibleText.slice(0, 10000);\n\n          var links = Array.from(document.querySelectorAll(\"a[href]\")).slice(0, 50).map(function(a) {\n            return {\n              text: a.textContent ? a.textContent.trim() : \"\",\n              href: a.href\n            };\n          });\n\n          var forms = Array.from(document.querySelectorAll(\"form\")).slice(0, 10).map(function(f) {\n            return {\n              action: f.action,\n              inputs: Array.from(f.querySelectorAll(\"input, textarea, select\")).map(function(i) {\n                return i.name || i.id || \"\";\n              }).filter(Boolean)\n            };\n          });\n\n          var images = Array.from(document.querySelectorAll(\"img[src]\")).slice(0, 20).map(function(i) {\n            return {\n              src: i.src,\n              alt: i.alt\n            };\n          });\n\n          var metaTags = {};\n          document.querySelectorAll(\"meta[name], meta[property]\").forEach(function(m) {\n            var name = m.getAttribute(\"name\") || m.getAttribute(\"property\") || \"\";\n            var content = m.getAttribute(\"content\") || \"\";\n            if (name && content) metaTags[name] = content;\n          });\n\n          var jsonLd = [];\n          document.querySelectorAll('script[type=\"application/ld+json\"]').forEach(function(s) {\n            try {\n              jsonLd.push(JSON.parse(s.textContent || \"\"));\n            } catch(e) {}\n          });\n\n          return {\n            url: window.location.href,\n            title: document.title,\n            visibleText: visibleText,\n            links: links,\n            forms: forms,\n            images: images,\n            metaTags: metaTags,\n            jsonLd: jsonLd\n          };\n        })()\n      `);\n\n      const observation: Observation = {\n        sessionId,\n        timestamp: new Date(),\n        type: \"state\",\n        data: state\n      };\n      session.observations.push(observation);\n\n      this.emitEvent(session, {\n        type: \"observation\",\n        sessionId,\n        timestamp: new Date(),\n        data: { type: \"state\", state }\n      });\n\n      return state as PageState;\n    } catch (error) {\n      console.error(\"Failed to get page state:\", error);\n      return null;\n    }\n  }\n\n  async getScreenshot(sessionId: string): Promise<string | null> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return null;\n\n    const screenshot = await this.captureScreenshot(session);\n    \n    const observation: Observation = {\n      sessionId,\n      timestamp: new Date(),\n      type: \"screenshot\",\n      data: { screenshot }\n    };\n    session.observations.push(observation);\n\n    this.emitEvent(session, {\n      type: \"observation\",\n      sessionId,\n      timestamp: new Date(),\n      data: { type: \"screenshot\", screenshot }\n    });\n\n    return screenshot;\n  }\n\n  startScreenshotStreaming(sessionId: string, intervalMs: number = 2000): void {\n    const session = this.sessions.get(sessionId);\n    if (!session) return;\n\n    if (session.screenshotInterval) {\n      clearInterval(session.screenshotInterval);\n    }\n\n    session.screenshotInterval = setInterval(async () => {\n      if (session.status !== \"active\") {\n        this.stopScreenshotStreaming(sessionId);\n        return;\n      }\n      await this.getScreenshot(sessionId);\n    }, intervalMs);\n  }\n\n  stopScreenshotStreaming(sessionId: string): void {\n    const session = this.sessions.get(sessionId);\n    if (!session) return;\n\n    if (session.screenshotInterval) {\n      clearInterval(session.screenshotInterval);\n      session.screenshotInterval = undefined;\n    }\n  }\n\n  async closeSession(sessionId: string): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return;\n\n    this.stopScreenshotStreaming(sessionId);\n\n    session.status = \"completed\";\n\n    this.emitEvent(session, {\n      type: \"completed\",\n      sessionId,\n      timestamp: new Date(),\n      data: {\n        actions: session.actions.length,\n        observations: session.observations.length,\n        duration: Date.now() - session.createdAt.getTime()\n      }\n    });\n\n    try {\n      await session.context.clearCookies();\n      await session.context.close();\n      await session.browser.close();\n    } catch (e) {\n      console.error(\"Error closing session:\", e);\n    }\n\n    this.sessions.delete(sessionId);\n  }\n\n  cancelSession(sessionId: string): void {\n    const session = this.sessions.get(sessionId);\n    if (!session) return;\n\n    session.status = \"cancelled\";\n\n    this.emitEvent(session, {\n      type: \"cancelled\",\n      sessionId,\n      timestamp: new Date(),\n      data: { reason: \"User cancelled\" }\n    });\n\n    this.closeSession(sessionId).catch(() => {});\n  }\n\n  getSession(sessionId: string): ComputerSession | null {\n    const session = this.sessions.get(sessionId);\n    if (!session) return null;\n\n    return {\n      id: session.id,\n      status: session.status,\n      startedAt: session.createdAt,\n      objective: session.objective,\n      actions: session.actions,\n      observations: session.observations,\n      currentUrl: session.page.url(),\n      currentTitle: undefined\n    };\n  }\n\n  addGlobalEventListener(callback: SessionEventCallback): void {\n    this.globalCallbacks.add(callback);\n  }\n\n  removeGlobalEventListener(callback: SessionEventCallback): void {\n    this.globalCallbacks.delete(callback);\n  }\n\n  addSessionEventListener(sessionId: string, callback: SessionEventCallback): void {\n    const session = this.sessions.get(sessionId);\n    if (session) {\n      session.callbacks.add(callback);\n    }\n  }\n\n  getActiveSessionCount(): number {\n    return this.sessions.size;\n  }\n\n  async cleanup(): Promise<void> {\n    const sessionIds = Array.from(this.sessions.keys());\n    for (const id of sessionIds) {\n      await this.closeSession(id);\n    }\n  }\n}\n\nexport const browserSessionManager = new BrowserSessionManager();\n","path":null,"size_bytes":16933,"size_tokens":null},"server/parsers/textParser.ts":{"content":"import type { FileParser, ParsedResult, DetectedFileType } from \"./base\";\n\nexport class TextParser implements FileParser {\n  name = \"text\";\n  supportedMimeTypes = [\n    \"text/plain\",\n    \"text/markdown\",\n    \"text/md\",\n    \"text/csv\",\n    \"text/html\",\n    \"application/json\",\n  ];\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    const text = content.toString(\"utf-8\");\n\n    if (type.mimeType === \"application/json\") {\n      try {\n        const json = JSON.parse(text);\n        return { text: JSON.stringify(json, null, 2) };\n      } catch {\n        return { text };\n      }\n    }\n\n    if (type.mimeType === \"text/html\") {\n      const stripped = text.replace(/<[^>]*>/g, \" \").replace(/\\s+/g, \" \").trim();\n      return { text: stripped };\n    }\n\n    return { text };\n  }\n}\n","path":null,"size_bytes":808,"size_tokens":null},"server/agent/security.ts":{"content":"import { storage } from \"../storage\";\n\nexport interface SecurityCheck {\n  allowed: boolean;\n  reason?: string;\n  rateLimit?: number;\n}\n\nconst BLOCKED_DOMAINS = [\n  \"localhost\",\n  \"127.0.0.1\",\n  \"0.0.0.0\",\n  \"::1\",\n  \"internal\",\n  \".local\",\n  \".internal\"\n];\n\nconst SENSITIVE_DOMAINS = [\n  \"bank\",\n  \"paypal\",\n  \"venmo\",\n  \"stripe.com\",\n  \"checkout\",\n  \"login\",\n  \"signin\",\n  \"auth\"\n];\n\nconst requestCounts: Map<string, { count: number; resetAt: number }> = new Map();\n\nexport function extractDomain(url: string): string | null {\n  try {\n    const parsed = new URL(url);\n    return parsed.hostname.toLowerCase();\n  } catch {\n    return null;\n  }\n}\n\nexport async function checkDomainPolicy(url: string): Promise<SecurityCheck> {\n  const domain = extractDomain(url);\n  if (!domain) {\n    return { allowed: false, reason: \"Invalid URL\" };\n  }\n\n  for (const blocked of BLOCKED_DOMAINS) {\n    if (domain === blocked || domain.endsWith(blocked)) {\n      return { allowed: false, reason: \"Access to internal domains is blocked\" };\n    }\n  }\n\n  for (const sensitive of SENSITIVE_DOMAINS) {\n    if (domain.includes(sensitive)) {\n      return { \n        allowed: false, \n        reason: \"Access to sensitive/financial domains requires explicit user permission\" \n      };\n    }\n  }\n\n  try {\n    const policy = await storage.getDomainPolicy(domain);\n    if (policy) {\n      if (policy.allowNavigation === \"false\") {\n        return { allowed: false, reason: \"Domain blocked by policy\" };\n      }\n      return { allowed: true, rateLimit: policy.rateLimit || 10 };\n    }\n  } catch (e) {\n    console.error(\"Error checking domain policy:\", e);\n  }\n\n  return { allowed: true, rateLimit: 10 };\n}\n\nexport function checkRateLimit(domain: string, limit: number = 10): boolean {\n  const now = Date.now();\n  const windowMs = 60000;\n  \n  const key = domain;\n  const record = requestCounts.get(key);\n\n  if (!record || now > record.resetAt) {\n    requestCounts.set(key, { count: 1, resetAt: now + windowMs });\n    return true;\n  }\n\n  if (record.count >= limit) {\n    return false;\n  }\n\n  record.count++;\n  return true;\n}\n\nexport function resetRateLimits(): void {\n  requestCounts.clear();\n}\n\nexport function sanitizeUrl(url: string): string {\n  try {\n    const parsed = new URL(url);\n    \n    parsed.username = \"\";\n    parsed.password = \"\";\n    \n    if (![\"http:\", \"https:\"].includes(parsed.protocol)) {\n      throw new Error(\"Invalid protocol\");\n    }\n\n    return parsed.href;\n  } catch {\n    throw new Error(\"Invalid URL format\");\n  }\n}\n\nexport function isValidObjective(objective: string): boolean {\n  const blockedPatterns = [\n    /password/i,\n    /credit\\s*card/i,\n    /social\\s*security/i,\n    /ssn/i,\n    /bank\\s*account/i,\n    /hack/i,\n    /exploit/i,\n    /malware/i,\n    /phishing/i\n  ];\n\n  for (const pattern of blockedPatterns) {\n    if (pattern.test(objective)) {\n      return false;\n    }\n  }\n\n  return true;\n}\n","path":null,"size_bytes":2895,"size_tokens":null},"server/agent/pipeline/tools/search-web.ts":{"content":"import { ToolDefinition, ExecutionContext, ToolResult } from \"../types\";\nimport { browserSessionManager } from \"../../browser\";\nimport { extractWithReadability } from \"../../extractor\";\n\nexport const searchWebTool: ToolDefinition = {\n  id: \"search_web\",\n  name: \"Search Web\",\n  description: \"Search the web using a search engine and return results\",\n  category: \"web\",\n  capabilities: [\"search\", \"find\", \"lookup\", \"query\", \"google\", \"web search\"],\n  inputSchema: {\n    query: { type: \"string\", description: \"The search query\", required: true },\n    engine: { \n      type: \"string\", \n      description: \"Search engine to use\",\n      enum: [\"google\", \"duckduckgo\", \"bing\"],\n      default: \"duckduckgo\"\n    },\n    maxResults: { type: \"number\", description: \"Maximum results to return\", default: 5 }\n  },\n  outputSchema: {\n    results: { type: \"array\", description: \"Search results with title, url, snippet\" },\n    query: { type: \"string\", description: \"The executed query\" }\n  },\n  timeout: 60000,\n  \n  async execute(context: ExecutionContext, params: Record<string, any>): Promise<ToolResult> {\n    const { query, engine = \"duckduckgo\", maxResults = 5 } = params;\n    \n    if (!query) {\n      return {\n        success: false,\n        error: \"No search query provided\"\n      };\n    }\n\n    let sessionId: string | null = null;\n    \n    try {\n      sessionId = await browserSessionManager.createSession(\n        `Search: ${query}`,\n        { timeout: 30000 },\n        undefined\n      );\n      \n      browserSessionManager.startScreenshotStreaming(sessionId, 1500);\n      \n      const searchUrls: Record<string, string> = {\n        google: `https://www.google.com/search?q=${encodeURIComponent(query)}`,\n        duckduckgo: `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`,\n        bing: `https://www.bing.com/search?q=${encodeURIComponent(query)}`\n      };\n      \n      const searchUrl = searchUrls[engine] || searchUrls.duckduckgo;\n      \n      context.onProgress({\n        runId: context.runId,\n        stepId: `search_${context.stepIndex}`,\n        status: \"progress\",\n        message: `Searching for: ${query}`,\n        progress: 30,\n        detail: { browserSessionId: sessionId, query }\n      });\n\n      const navResult = await browserSessionManager.navigate(sessionId, searchUrl);\n      \n      if (!navResult.success) {\n        return {\n          success: false,\n          error: navResult.error || \"Failed to load search results\"\n        };\n      }\n\n      const pageState = await browserSessionManager.getPageState(sessionId);\n      \n      const results: { title: string; url: string; snippet: string }[] = [];\n      \n      if (pageState?.links) {\n        for (const link of pageState.links) {\n          if (link.href && !link.href.includes(\"duckduckgo\") && !link.href.includes(\"google.com\") && !link.href.includes(\"bing.com\")) {\n            if (results.length >= maxResults) break;\n            results.push({\n              title: link.text || link.href,\n              url: link.href,\n              snippet: \"\"\n            });\n          }\n        }\n      }\n\n      return {\n        success: true,\n        data: {\n          query,\n          engine,\n          results: results.slice(0, maxResults),\n          totalFound: results.length\n        },\n        metadata: {\n          query,\n          engine,\n          resultsCount: results.length\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    } finally {\n      if (sessionId) {\n        browserSessionManager.stopScreenshotStreaming(sessionId);\n        // Delay closing to allow frontend to receive final screenshot\n        setTimeout(async () => {\n          await browserSessionManager.closeSession(sessionId!).catch(() => {});\n        }, 5000);\n      }\n    }\n  }\n};\n","path":null,"size_bytes":3810,"size_tokens":null},"server/agent/extractor.ts":{"content":"import { Readability } from \"@mozilla/readability\";\nimport { JSDOM } from \"jsdom\";\n\nexport interface ExtractedContent {\n  title: string;\n  byline: string | null;\n  content: string;\n  textContent: string;\n  excerpt: string | null;\n  siteName: string | null;\n  length: number;\n  links: ExtractedLink[];\n  images: ExtractedImage[];\n  metadata: Record<string, string>;\n}\n\nexport interface ExtractedLink {\n  text: string;\n  href: string;\n  isInternal: boolean;\n}\n\nexport interface ExtractedImage {\n  src: string;\n  alt: string;\n  width?: number;\n  height?: number;\n}\n\nexport function extractWithReadability(html: string, url: string): ExtractedContent | null {\n  try {\n    const dom = new JSDOM(html, { url });\n    const document = dom.window.document;\n    \n    const reader = new Readability(document.cloneNode(true) as Document);\n    const article = reader.parse();\n    \n    if (!article) return null;\n\n    const baseUrl = new URL(url);\n    const links = extractLinks(document, baseUrl);\n    const images = extractImages(document, baseUrl);\n    const metadata = extractMetadata(document);\n\n    return {\n      title: article.title || \"\",\n      byline: article.byline || null,\n      content: article.content || \"\",\n      textContent: article.textContent || \"\",\n      excerpt: article.excerpt || null,\n      siteName: article.siteName || null,\n      length: article.length || 0,\n      links,\n      images,\n      metadata\n    };\n  } catch (error) {\n    console.error(\"Readability extraction error:\", error);\n    return null;\n  }\n}\n\nexport function extractRawText(html: string): string {\n  try {\n    const dom = new JSDOM(html);\n    const document = dom.window.document;\n    \n    const scripts = document.querySelectorAll(\"script, style, noscript\");\n    scripts.forEach(el => el.remove());\n    \n    return document.body?.textContent?.trim() || \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractLinks(document: Document, baseUrl: URL): ExtractedLink[] {\n  const links: ExtractedLink[] = [];\n  const anchors = document.querySelectorAll(\"a[href]\");\n  \n  anchors.forEach((anchor: Element) => {\n    const href = anchor.getAttribute(\"href\");\n    if (!href || href.startsWith(\"#\") || href.startsWith(\"javascript:\")) return;\n    \n    try {\n      const absoluteUrl = new URL(href, baseUrl.origin);\n      links.push({\n        text: anchor.textContent?.trim() || \"\",\n        href: absoluteUrl.href,\n        isInternal: absoluteUrl.hostname === baseUrl.hostname\n      });\n    } catch {}\n  });\n\n  return links.slice(0, 100);\n}\n\nfunction extractImages(document: Document, baseUrl: URL): ExtractedImage[] {\n  const images: ExtractedImage[] = [];\n  const imgElements = document.querySelectorAll(\"img[src]\");\n  \n  imgElements.forEach((img: Element) => {\n    const src = img.getAttribute(\"src\");\n    if (!src) return;\n    \n    try {\n      const absoluteUrl = new URL(src, baseUrl.origin);\n      images.push({\n        src: absoluteUrl.href,\n        alt: img.getAttribute(\"alt\") || \"\",\n        width: parseInt(img.getAttribute(\"width\") || \"0\") || undefined,\n        height: parseInt(img.getAttribute(\"height\") || \"0\") || undefined\n      });\n    } catch {}\n  });\n\n  return images.slice(0, 50);\n}\n\nfunction extractMetadata(document: Document): Record<string, string> {\n  const metadata: Record<string, string> = {};\n  \n  const metaTags = document.querySelectorAll(\"meta[name], meta[property]\");\n  metaTags.forEach((meta: Element) => {\n    const name = meta.getAttribute(\"name\") || meta.getAttribute(\"property\");\n    const content = meta.getAttribute(\"content\");\n    if (name && content) {\n      metadata[name] = content;\n    }\n  });\n\n  const title = document.querySelector(\"title\");\n  if (title?.textContent) {\n    metadata[\"title\"] = title.textContent;\n  }\n\n  const canonical = document.querySelector(\"link[rel='canonical']\");\n  if (canonical) {\n    metadata[\"canonical\"] = canonical.getAttribute(\"href\") || \"\";\n  }\n\n  return metadata;\n}\n\nexport function summarizeForLLM(extracted: ExtractedContent, maxLength: number = 8000): string {\n  let summary = `# ${extracted.title}\\n\\n`;\n  \n  if (extracted.byline) {\n    summary += `*By: ${extracted.byline}*\\n\\n`;\n  }\n  \n  if (extracted.excerpt) {\n    summary += `> ${extracted.excerpt}\\n\\n`;\n  }\n\n  summary += \"## Content\\n\\n\";\n  \n  let content = extracted.textContent;\n  if (content.length > maxLength - summary.length) {\n    content = content.slice(0, maxLength - summary.length - 100) + \"\\n\\n[Content truncated...]\";\n  }\n  \n  summary += content;\n\n  return summary;\n}\n","path":null,"size_bytes":4489,"size_tokens":null},"server/agent/orchestrator.ts":{"content":"import { browserWorker, NavigationResult } from \"./browser-worker\";\nimport { extractWithReadability, summarizeForLLM, ExtractedContent } from \"./extractor\";\nimport { routeMessage, RouteResult, extractUrls } from \"./router\";\nimport { storage } from \"../storage\";\nimport { ObjectStorageService } from \"../objectStorage\";\nimport { openai, MODELS } from \"../lib/openai\";\nimport crypto from \"crypto\";\n\nexport interface AgentTask {\n  runId: string;\n  objective: string;\n  urls: string[];\n  conversationId?: string;\n}\n\nexport interface StepUpdate {\n  runId: string;\n  stepId: string;\n  stepType: string;\n  url?: string;\n  status: \"started\" | \"completed\" | \"failed\";\n  detail?: any;\n  screenshot?: string;\n  error?: string;\n}\n\nexport type StepCallback = (update: StepUpdate) => void;\n\nclass AgentOrchestrator {\n  private objectStorage: ObjectStorageService;\n  private activeRuns: Map<string, { cancelled: boolean }> = new Map();\n\n  constructor() {\n    this.objectStorage = new ObjectStorageService();\n  }\n\n  async executeTask(task: AgentTask, onStep?: StepCallback): Promise<{\n    success: boolean;\n    content: string;\n    sources: { fileName: string; content: string }[];\n    error?: string;\n  }> {\n    const runControl = { cancelled: false };\n    this.activeRuns.set(task.runId, runControl);\n\n    let sessionId: string | null = null;\n    const extractedContents: ExtractedContent[] = [];\n    const sources: { fileName: string; content: string }[] = [];\n    let stepIndex = 0;\n\n    try {\n      await storage.updateAgentRunStatus(task.runId, \"running\");\n      \n      sessionId = await browserWorker.createSession();\n\n      for (const url of task.urls) {\n        if (runControl.cancelled) {\n          await storage.updateAgentRunStatus(task.runId, \"cancelled\");\n          return { success: false, content: \"\", sources: [], error: \"Cancelled by user\" };\n        }\n\n        const stepId = crypto.randomUUID();\n        \n        onStep?.({\n          runId: task.runId,\n          stepId,\n          stepType: \"navigate\",\n          url,\n          status: \"started\"\n        });\n\n        await storage.createAgentStep({\n          runId: task.runId,\n          stepType: \"navigate\",\n          url,\n          success: \"pending\",\n          stepIndex: stepIndex++\n        });\n\n        const navResult = await browserWorker.navigate(sessionId, url, true);\n\n        if (!navResult.success) {\n          onStep?.({\n            runId: task.runId,\n            stepId,\n            stepType: \"navigate\",\n            url,\n            status: \"failed\",\n            error: navResult.error\n          });\n          continue;\n        }\n\n        let screenshotPath: string | undefined;\n        if (navResult.screenshot) {\n          try {\n            const { uploadURL, storagePath } = await this.objectStorage.getObjectEntityUploadURLWithPath();\n            await fetch(uploadURL, {\n              method: \"PUT\",\n              headers: { \"Content-Type\": \"image/png\" },\n              body: navResult.screenshot\n            });\n            screenshotPath = storagePath;\n\n            await storage.createAgentAsset({\n              runId: task.runId,\n              stepId,\n              assetType: \"screenshot\",\n              storagePath,\n              metadata: { url, title: navResult.title }\n            });\n          } catch (e) {\n            console.error(\"Failed to save screenshot:\", e);\n          }\n        }\n\n        onStep?.({\n          runId: task.runId,\n          stepId,\n          stepType: \"navigate\",\n          url,\n          status: \"completed\",\n          screenshot: screenshotPath,\n          detail: { title: navResult.title, timing: navResult.timing }\n        });\n\n        if (runControl.cancelled) continue;\n\n        const extractStepId = crypto.randomUUID();\n        onStep?.({\n          runId: task.runId,\n          stepId: extractStepId,\n          stepType: \"extract\",\n          url,\n          status: \"started\"\n        });\n\n        await storage.createAgentStep({\n          runId: task.runId,\n          stepType: \"extract\",\n          url,\n          success: \"pending\",\n          stepIndex: stepIndex++\n        });\n\n        const extracted = navResult.html ? extractWithReadability(navResult.html, url) : null;\n\n        if (extracted) {\n          extractedContents.push(extracted);\n          sources.push({\n            fileName: extracted.title || url,\n            content: extracted.excerpt || extracted.textContent.slice(0, 200) + \"...\"\n          });\n\n          await storage.createAgentAsset({\n            runId: task.runId,\n            stepId: extractStepId,\n            assetType: \"extracted_content\",\n            content: extracted.textContent.slice(0, 50000),\n            metadata: { \n              title: extracted.title,\n              byline: extracted.byline,\n              siteName: extracted.siteName,\n              length: extracted.length\n            }\n          });\n\n          onStep?.({\n            runId: task.runId,\n            stepId: extractStepId,\n            stepType: \"extract\",\n            url,\n            status: \"completed\",\n            detail: { \n              title: extracted.title,\n              length: extracted.length,\n              linksCount: extracted.links.length\n            }\n          });\n        } else {\n          onStep?.({\n            runId: task.runId,\n            stepId: extractStepId,\n            stepType: \"extract\",\n            url,\n            status: \"failed\",\n            error: \"Could not extract readable content\"\n          });\n        }\n      }\n\n      if (sessionId) {\n        await browserWorker.destroySession(sessionId);\n      }\n\n      if (runControl.cancelled) {\n        await storage.updateAgentRunStatus(task.runId, \"cancelled\");\n        return { success: false, content: \"\", sources: [], error: \"Cancelled\" };\n      }\n\n      const synthesisStepId = crypto.randomUUID();\n      onStep?.({\n        runId: task.runId,\n        stepId: synthesisStepId,\n        stepType: \"synthesize\",\n        status: \"started\"\n      });\n\n      const contextFromPages = extractedContents\n        .map((ec, i) => `--- Source ${i + 1}: ${ec.title} ---\\n${summarizeForLLM(ec, 4000)}`)\n        .join(\"\\n\\n\");\n\n      const response = await openai.chat.completions.create({\n        model: \"grok-3-fast\",\n        messages: [\n          {\n            role: \"system\",\n            content: `You are Sira GPT, an AI assistant that has just browsed the web and extracted information. \nBased on the extracted content below, provide a comprehensive response to the user's objective.\nCite your sources when referencing specific information.\nRespond in the same language as the user's objective.`\n          },\n          {\n            role: \"user\",\n            content: `Objective: ${task.objective}\\n\\nExtracted Web Content:\\n${contextFromPages}`\n          }\n        ]\n      });\n\n      const content = response.choices[0]?.message?.content || \"No se pudo generar una respuesta.\";\n\n      onStep?.({\n        runId: task.runId,\n        stepId: synthesisStepId,\n        stepType: \"synthesize\",\n        status: \"completed\",\n        detail: { responseLength: content.length }\n      });\n\n      await storage.updateAgentRunStatus(task.runId, \"completed\");\n      this.activeRuns.delete(task.runId);\n\n      return { success: true, content, sources };\n    } catch (error: any) {\n      console.error(\"Agent orchestrator error:\", error);\n      \n      if (sessionId) {\n        await browserWorker.destroySession(sessionId).catch(() => {});\n      }\n      \n      await storage.updateAgentRunStatus(task.runId, \"failed\", error.message);\n      this.activeRuns.delete(task.runId);\n      \n      return { \n        success: false, \n        content: `Error durante la navegación: ${error.message}`, \n        sources: [],\n        error: error.message \n      };\n    }\n  }\n\n  cancelRun(runId: string): boolean {\n    const run = this.activeRuns.get(runId);\n    if (run) {\n      run.cancelled = true;\n      return true;\n    }\n    return false;\n  }\n\n  isRunActive(runId: string): boolean {\n    return this.activeRuns.has(runId);\n  }\n}\n\nexport const agentOrchestrator = new AgentOrchestrator();\n","path":null,"size_bytes":8071,"size_tokens":null},"server/agent/browser/action-controller.ts":{"content":"import { browserSessionManager } from \"./session-manager\";\nimport { ActionResult, PageState, SessionEventCallback } from \"./types\";\n\nexport type ActionType = \"navigate\" | \"click\" | \"type\" | \"scroll\" | \"wait\" | \"screenshot\" | \"getState\" | \"evaluate\" | \"download\";\n\nexport interface ActionCommand {\n  type: ActionType;\n  params: Record<string, any>;\n}\n\nexport interface ActionControllerConfig {\n  maxActionsPerSession?: number;\n  actionTimeout?: number;\n  screenshotOnEveryAction?: boolean;\n}\n\nconst DEFAULT_CONFIG: ActionControllerConfig = {\n  maxActionsPerSession: 100,\n  actionTimeout: 30000,\n  screenshotOnEveryAction: true\n};\n\nclass ActionController {\n  private config: ActionControllerConfig;\n  private actionCounts: Map<string, number> = new Map();\n\n  constructor(config: Partial<ActionControllerConfig> = {}) {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n  }\n\n  async executeAction(sessionId: string, command: ActionCommand): Promise<ActionResult> {\n    const count = (this.actionCounts.get(sessionId) || 0) + 1;\n    \n    if (count > this.config.maxActionsPerSession!) {\n      return {\n        success: false,\n        action: { type: command.type, params: command.params, timestamp: new Date() },\n        error: `Maximum actions (${this.config.maxActionsPerSession}) exceeded for session`,\n        duration: 0\n      };\n    }\n    \n    this.actionCounts.set(sessionId, count);\n\n    switch (command.type) {\n      case \"navigate\":\n        return browserSessionManager.navigate(sessionId, command.params.url);\n      \n      case \"click\":\n        return browserSessionManager.click(sessionId, command.params.selector);\n      \n      case \"type\":\n        return browserSessionManager.type(\n          sessionId, \n          command.params.selector, \n          command.params.text\n        );\n      \n      case \"scroll\":\n        return browserSessionManager.scroll(\n          sessionId,\n          command.params.direction || \"down\",\n          command.params.amount || 300\n        );\n      \n      case \"wait\":\n        return browserSessionManager.wait(sessionId, command.params.ms || 1000);\n      \n      case \"evaluate\":\n        return browserSessionManager.evaluate(sessionId, command.params.script);\n      \n      case \"screenshot\":\n        const screenshot = await browserSessionManager.getScreenshot(sessionId);\n        return {\n          success: !!screenshot,\n          action: { type: \"screenshot\", params: {}, timestamp: new Date() },\n          screenshot: screenshot || undefined,\n          duration: 0\n        };\n      \n      case \"getState\":\n        const state = await browserSessionManager.getPageState(sessionId);\n        return {\n          success: !!state,\n          action: { type: \"getState\", params: {}, timestamp: new Date() },\n          data: state,\n          duration: 0\n        };\n      \n      default:\n        return {\n          success: false,\n          action: { type: command.type, params: command.params, timestamp: new Date() },\n          error: `Unknown action type: ${command.type}`,\n          duration: 0\n        };\n    }\n  }\n\n  async executeSequence(\n    sessionId: string, \n    commands: ActionCommand[],\n    onAction?: (index: number, result: ActionResult) => void\n  ): Promise<ActionResult[]> {\n    const results: ActionResult[] = [];\n\n    for (let i = 0; i < commands.length; i++) {\n      const result = await this.executeAction(sessionId, commands[i]);\n      results.push(result);\n      \n      if (onAction) {\n        onAction(i, result);\n      }\n\n      if (!result.success) {\n        break;\n      }\n    }\n\n    return results;\n  }\n\n  resetActionCount(sessionId: string): void {\n    this.actionCounts.delete(sessionId);\n  }\n\n  getActionCount(sessionId: string): number {\n    return this.actionCounts.get(sessionId) || 0;\n  }\n}\n\nexport const actionController = new ActionController();\n","path":null,"size_bytes":3820,"size_tokens":null},"server/agent/pipeline/browser-planner.ts":{"content":"import OpenAI from \"openai\";\nimport crypto from \"crypto\";\nimport { browserSessionManager } from \"../browser\";\nimport { guardrails } from \"../guardrails\";\nimport { ExecutionPlan, PlanStep } from \"./types\";\n\ninterface BrowserObservation {\n  url: string;\n  title: string;\n  screenshot?: string;\n  visibleText: string;\n  links: { text: string; href: string }[];\n  forms: { action: string; inputs: string[] }[];\n  error?: string;\n}\n\ninterface PlannerState {\n  sessionId: string;\n  objective: string;\n  currentStep: number;\n  observations: BrowserObservation[];\n  actions: { action: string; result: string; timestamp: Date }[];\n  status: \"planning\" | \"acting\" | \"observing\" | \"evaluating\" | \"completed\" | \"failed\";\n}\n\nfunction getOpenAIClient(): OpenAI {\n  if (!process.env.XAI_API_KEY) {\n    throw new Error(\"XAI_API_KEY is not configured\");\n  }\n  return new OpenAI({ \n    baseURL: \"https://api.x.ai/v1\", \n    apiKey: process.env.XAI_API_KEY \n  });\n}\n\nexport async function planNextAction(\n  state: PlannerState,\n  maxIterations: number = 10\n): Promise<{ action: string; params: Record<string, any>; reasoning: string } | null> {\n  if (state.actions.length >= maxIterations) {\n    return null;\n  }\n\n  const openai = getOpenAIClient();\n  \n  const lastObservation = state.observations[state.observations.length - 1];\n  const recentActions = state.actions.slice(-5).map(a => \n    `- ${a.action}: ${a.result}`\n  ).join(\"\\n\");\n\n  const response = await openai.chat.completions.create({\n    model: \"grok-3-fast\",\n    messages: [\n      {\n        role: \"system\",\n        content: `You are a browser automation agent. Given an objective and current page state, decide the next action.\n\nAvailable actions:\n- navigate: Go to a URL { \"url\": \"https://...\" }\n- click: Click an element { \"selector\": \"css selector\" }\n- type: Enter text { \"selector\": \"css selector\", \"text\": \"text to type\" }\n- scroll: Scroll page { \"direction\": \"down\" | \"up\", \"amount\": 300 }\n- wait: Wait for content { \"ms\": 1000 }\n- extract: Get data from page { \"selector\": \"css selector\" }\n- complete: Task is done { \"summary\": \"what was accomplished\" }\n\nRespond in JSON:\n{\n  \"action\": \"action_name\",\n  \"params\": { ... },\n  \"reasoning\": \"why this action\"\n}`\n      },\n      {\n        role: \"user\",\n        content: `Objective: ${state.objective}\n\nCurrent page:\n- URL: ${lastObservation?.url || \"none\"}\n- Title: ${lastObservation?.title || \"none\"}\n- Visible text (excerpt): ${lastObservation?.visibleText?.slice(0, 1000) || \"none\"}\n- Available links: ${lastObservation?.links?.slice(0, 10).map(l => `\"${l.text}\" -> ${l.href}`).join(\", \") || \"none\"}\n- Forms: ${lastObservation?.forms?.length || 0} forms available\n\nRecent actions:\n${recentActions || \"None yet\"}\n\nWhat should be the next action?`\n      }\n    ],\n    response_format: { type: \"json_object\" }\n  });\n\n  try {\n    const parsed = JSON.parse(response.choices[0]?.message?.content || \"{}\");\n    return {\n      action: parsed.action || \"complete\",\n      params: parsed.params || {},\n      reasoning: parsed.reasoning || \"No reasoning provided\"\n    };\n  } catch {\n    return null;\n  }\n}\n\nexport async function executeAction(\n  sessionId: string,\n  action: string,\n  params: Record<string, any>\n): Promise<{ success: boolean; result: string; observation?: BrowserObservation }> {\n  const validation = await guardrails.validateAction(sessionId, action, params.url || params.selector || \"unknown\", params);\n  \n  if (!validation.allowed) {\n    return { success: false, result: `Blocked: ${validation.reason}` };\n  }\n\n  try {\n    let result: any;\n    \n    switch (action) {\n      case \"navigate\":\n        result = await browserSessionManager.navigate(sessionId, params.url);\n        break;\n      case \"click\":\n        result = await browserSessionManager.click(sessionId, params.selector);\n        break;\n      case \"type\":\n        result = await browserSessionManager.type(sessionId, params.selector, params.text);\n        break;\n      case \"scroll\":\n        result = await browserSessionManager.scroll(sessionId, params.direction, params.amount);\n        break;\n      case \"wait\":\n        result = await browserSessionManager.wait(sessionId, params.ms || 1000);\n        break;\n      case \"complete\":\n        return { success: true, result: params.summary || \"Task completed\" };\n      default:\n        return { success: false, result: `Unknown action: ${action}` };\n    }\n\n    const pageState = await browserSessionManager.getPageState(sessionId);\n    const screenshot = await browserSessionManager.getScreenshot(sessionId);\n\n    const observation: BrowserObservation = {\n      url: pageState?.url || \"\",\n      title: pageState?.title || \"\",\n      screenshot: screenshot || undefined,\n      visibleText: pageState?.visibleText || \"\",\n      links: pageState?.links || [],\n      forms: pageState?.forms || [],\n    };\n\n    return {\n      success: result.success,\n      result: result.success ? \"Action completed\" : result.error || \"Action failed\",\n      observation\n    };\n  } catch (error: any) {\n    return { success: false, result: error.message };\n  }\n}\n\nexport async function evaluateProgress(\n  state: PlannerState\n): Promise<{ shouldContinue: boolean; feedback: string; confidence: number }> {\n  const openai = getOpenAIClient();\n  \n  const lastObservation = state.observations[state.observations.length - 1];\n  const actionsSummary = state.actions.map(a => a.action).join(\" -> \");\n\n  const response = await openai.chat.completions.create({\n    model: \"grok-3-fast\",\n    messages: [\n      {\n        role: \"system\",\n        content: `Evaluate if the browser automation task is making progress toward the objective.\n\nRespond in JSON:\n{\n  \"shouldContinue\": true/false,\n  \"feedback\": \"what's working or not\",\n  \"confidence\": 0.0-1.0,\n  \"isComplete\": true/false\n}`\n      },\n      {\n        role: \"user\",\n        content: `Objective: ${state.objective}\n\nActions taken: ${actionsSummary}\nNumber of actions: ${state.actions.length}\n\nCurrent page:\n- URL: ${lastObservation?.url || \"none\"}\n- Title: ${lastObservation?.title || \"none\"}\n\nIs the task making progress? Is it complete?`\n      }\n    ],\n    response_format: { type: \"json_object\" }\n  });\n\n  try {\n    const parsed = JSON.parse(response.choices[0]?.message?.content || \"{}\");\n    return {\n      shouldContinue: parsed.shouldContinue !== false && !parsed.isComplete,\n      feedback: parsed.feedback || \"\",\n      confidence: parsed.confidence || 0.5\n    };\n  } catch {\n    return { shouldContinue: true, feedback: \"\", confidence: 0.5 };\n  }\n}\n\nexport async function runBrowserLoop(\n  objective: string,\n  config?: { maxIterations?: number; allowedDomains?: string[] },\n  onProgress?: (state: PlannerState) => void\n): Promise<{ success: boolean; summary: string; observations: BrowserObservation[] }> {\n  const maxIterations = config?.maxIterations || 15;\n  \n  const sessionId = await browserSessionManager.createSession(objective, {\n    allowedDomains: config?.allowedDomains\n  });\n\n  const state: PlannerState = {\n    sessionId,\n    objective,\n    currentStep: 0,\n    observations: [],\n    actions: [],\n    status: \"planning\"\n  };\n\n  try {\n    for (let i = 0; i < maxIterations; i++) {\n      state.status = \"planning\";\n      onProgress?.(state);\n\n      const nextAction = await planNextAction(state, maxIterations);\n      \n      if (!nextAction || nextAction.action === \"complete\") {\n        state.status = \"completed\";\n        onProgress?.(state);\n        \n        await browserSessionManager.closeSession(sessionId);\n        \n        return {\n          success: true,\n          summary: nextAction?.params?.summary || \"Task completed successfully\",\n          observations: state.observations\n        };\n      }\n\n      state.status = \"acting\";\n      onProgress?.(state);\n\n      const result = await executeAction(sessionId, nextAction.action, nextAction.params);\n      \n      state.actions.push({\n        action: `${nextAction.action}(${JSON.stringify(nextAction.params)})`,\n        result: result.result,\n        timestamp: new Date()\n      });\n\n      if (result.observation) {\n        state.observations.push(result.observation);\n      }\n\n      state.status = \"observing\";\n      onProgress?.(state);\n\n      if (!result.success) {\n        const evaluation = await evaluateProgress(state);\n        \n        if (!evaluation.shouldContinue || evaluation.confidence < 0.3) {\n          state.status = \"failed\";\n          onProgress?.(state);\n          \n          await browserSessionManager.closeSession(sessionId);\n          \n          return {\n            success: false,\n            summary: `Task failed: ${result.result}. ${evaluation.feedback}`,\n            observations: state.observations\n          };\n        }\n      }\n\n      state.status = \"evaluating\";\n      state.currentStep = i + 1;\n      onProgress?.(state);\n\n      if (i > 0 && i % 5 === 0) {\n        const evaluation = await evaluateProgress(state);\n        \n        if (!evaluation.shouldContinue) {\n          state.status = evaluation.confidence > 0.7 ? \"completed\" : \"failed\";\n          onProgress?.(state);\n          \n          await browserSessionManager.closeSession(sessionId);\n          \n          return {\n            success: evaluation.confidence > 0.7,\n            summary: evaluation.feedback,\n            observations: state.observations\n          };\n        }\n      }\n    }\n\n    state.status = \"completed\";\n    onProgress?.(state);\n    \n    await browserSessionManager.closeSession(sessionId);\n    \n    return {\n      success: true,\n      summary: `Completed after ${maxIterations} iterations`,\n      observations: state.observations\n    };\n  } catch (error: any) {\n    state.status = \"failed\";\n    onProgress?.(state);\n    \n    await browserSessionManager.closeSession(sessionId).catch(() => {});\n    \n    return {\n      success: false,\n      summary: `Error: ${error.message}`,\n      observations: state.observations\n    };\n  }\n}\n","path":null,"size_bytes":9862,"size_tokens":null},"server/services/documentProcessing.ts":{"content":"import type { ParsedResult } from \"../parsers/base\";\nimport { detectFileType } from \"./detectorChain\";\nimport { parserRegistry } from \"./parserRegistry\";\n\nexport interface ProcessingResult extends ParsedResult {\n  detectedMimeType: string;\n  parserUsed: string;\n}\n\nexport async function processDocument(\n  content: Buffer,\n  providedMimeType?: string,\n  filename?: string\n): Promise<ProcessingResult> {\n  const detectedType = detectFileType(content, providedMimeType, filename);\n  const parser = parserRegistry.getParser(detectedType);\n  const result = await parser.parse(content, detectedType);\n\n  return {\n    ...result,\n    detectedMimeType: detectedType.mimeType,\n    parserUsed: parser.name,\n  };\n}\n","path":null,"size_bytes":704,"size_tokens":null},"server/parsers/pdfParser.ts":{"content":"import type { FileParser, ParsedResult, DetectedFileType } from \"./base\";\n\nexport class PdfParser implements FileParser {\n  name = \"pdf\";\n  supportedMimeTypes = [\"application/pdf\"];\n  private readonly TIMEOUT_MS = 60000;\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    const startTime = Date.now();\n    let timeoutId: NodeJS.Timeout | null = null;\n    \n    try {\n      const pdfParse = require(\"pdf-parse\");\n      \n      const parsePromise = this.parseWithPageStructure(pdfParse, content);\n      const timeoutPromise = new Promise<never>((_, reject) => {\n        timeoutId = setTimeout(() => reject(new Error(`PDF parsing timed out after ${this.TIMEOUT_MS}ms`)), this.TIMEOUT_MS);\n      });\n\n      const result = await Promise.race([parsePromise, timeoutPromise]);\n      \n      if (timeoutId) clearTimeout(timeoutId);\n      \n      return result;\n    } catch (error) {\n      if (timeoutId) clearTimeout(timeoutId);\n      const elapsed = Date.now() - startTime;\n      console.error(`[PdfParser] Failed after ${elapsed}ms:`, error);\n      \n      if (error instanceof Error) {\n        if (error.message.includes('timed out')) {\n          throw new Error(`PDF parsing timed out - file may be too large or complex (${Math.round(content.length / 1024)}KB)`);\n        }\n        throw new Error(`Failed to parse PDF: ${error.message}`);\n      }\n      throw new Error(\"Failed to parse PDF: Unknown error\");\n    }\n  }\n\n  private async parseWithPageStructure(pdfParse: any, content: Buffer): Promise<ParsedResult> {\n    const pageTexts: string[] = [];\n    let currentPage = 0;\n\n    const options = {\n      pagerender: (pageData: any) => {\n        return pageData.getTextContent().then((textContent: any) => {\n          currentPage++;\n          let pageText = '';\n          let lastY: number | null = null;\n          \n          for (const item of textContent.items) {\n            if (item.str) {\n              const text = this.normalizeText(item.str);\n              if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {\n                pageText += '\\n';\n              }\n              pageText += text;\n              lastY = item.transform[5];\n            }\n          }\n          \n          pageTexts.push(pageText.trim());\n          return pageText;\n        });\n      }\n    };\n\n    const data = await pdfParse(content, options);\n    \n    const metadata = this.extractMetadata(data);\n    const formattedText = this.formatOutput(metadata, pageTexts, data.numpages);\n\n    return {\n      text: formattedText,\n      metadata: {\n        pages: data.numpages,\n        title: metadata.title,\n        author: metadata.author,\n        creationDate: metadata.creationDate,\n        producer: metadata.producer,\n        info: data.info,\n      },\n    };\n  }\n\n  private normalizeText(text: string): string {\n    return text\n      .replace(/\\u0000/g, '')\n      .replace(/[\\u2018\\u2019]/g, \"'\")\n      .replace(/[\\u201C\\u201D]/g, '\"')\n      .replace(/\\u2013/g, '-')\n      .replace(/\\u2014/g, '--')\n      .replace(/\\u2026/g, '...')\n      .replace(/\\u00A0/g, ' ')\n      .normalize('NFKC');\n  }\n\n  private extractMetadata(data: any): Record<string, string | undefined> {\n    const info = data.info || {};\n    \n    return {\n      title: info.Title || undefined,\n      author: info.Author || undefined,\n      creationDate: this.formatPdfDate(info.CreationDate),\n      modificationDate: this.formatPdfDate(info.ModDate),\n      producer: info.Producer || undefined,\n      creator: info.Creator || undefined,\n      subject: info.Subject || undefined,\n      keywords: info.Keywords || undefined,\n    };\n  }\n\n  private formatPdfDate(dateStr: string | undefined): string | undefined {\n    if (!dateStr) return undefined;\n    \n    const match = dateStr.match(/D:(\\d{4})(\\d{2})(\\d{2})(\\d{2})?(\\d{2})?(\\d{2})?/);\n    if (match) {\n      const [, year, month, day, hour = '00', minute = '00', second = '00'] = match;\n      return `${year}-${month}-${day} ${hour}:${minute}:${second}`;\n    }\n    return dateStr;\n  }\n\n  private formatOutput(metadata: Record<string, string | undefined>, pageTexts: string[], totalPages: number): string {\n    const parts: string[] = [];\n    \n    parts.push('=== Document Info ===');\n    if (metadata.title) parts.push(`Title: ${metadata.title}`);\n    if (metadata.author) parts.push(`Author: ${metadata.author}`);\n    if (metadata.creationDate) parts.push(`Created: ${metadata.creationDate}`);\n    if (metadata.subject) parts.push(`Subject: ${metadata.subject}`);\n    parts.push(`Pages: ${totalPages}`);\n    parts.push('');\n\n    for (let i = 0; i < pageTexts.length; i++) {\n      const pageNum = i + 1;\n      const pageContent = pageTexts[i];\n      \n      if (pageContent && pageContent.trim()) {\n        parts.push(`=== Page ${pageNum} ===`);\n        parts.push(pageContent);\n        parts.push('');\n      }\n    }\n\n    return parts.join('\\n').trim();\n  }\n}\n","path":null,"size_bytes":4891,"size_tokens":null},"server/agent/guardrails.ts":{"content":"import { storage } from \"../storage\";\nimport { checkDomainPolicy, checkRateLimit, sanitizeUrl, isValidObjective, extractDomain } from \"./security\";\n\nexport interface PIIMatch {\n  type: \"email\" | \"phone\" | \"ssn\" | \"credit_card\" | \"ip_address\" | \"date_of_birth\";\n  value: string;\n  redacted: string;\n  start: number;\n  end: number;\n}\n\nexport interface AuditLogEntry {\n  id: string;\n  sessionId: string;\n  timestamp: Date;\n  action: string;\n  target: string;\n  status: \"allowed\" | \"blocked\" | \"flagged\";\n  reason?: string;\n  metadata?: Record<string, any>;\n}\n\nexport interface DownloadPolicy {\n  allowed: boolean;\n  maxSizeBytes: number;\n  allowedMimeTypes: string[];\n  blockExecutables: boolean;\n}\n\nexport interface GuardrailsConfig {\n  enablePIIRedaction: boolean;\n  enableAuditLog: boolean;\n  enableDownloadControls: boolean;\n  maxDownloadSizeMB: number;\n  allowedDownloadTypes: string[];\n}\n\nconst DEFAULT_CONFIG: GuardrailsConfig = {\n  enablePIIRedaction: true,\n  enableAuditLog: true,\n  enableDownloadControls: true,\n  maxDownloadSizeMB: 100,\n  allowedDownloadTypes: [\n    \"application/pdf\",\n    \"text/plain\",\n    \"text/csv\",\n    \"text/html\",\n    \"application/json\",\n    \"image/png\",\n    \"image/jpeg\",\n    \"image/gif\",\n    \"image/webp\",\n    \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n    \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    \"application/zip\"\n  ]\n};\n\nconst PII_PATTERNS: { type: PIIMatch[\"type\"]; pattern: RegExp; redactFn: (match: string) => string }[] = [\n  {\n    type: \"email\",\n    pattern: /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b/g,\n    redactFn: (m) => m.replace(/^(.{2}).*(@.*)$/, \"$1***$2\")\n  },\n  {\n    type: \"phone\",\n    pattern: /\\b(?:\\+?1[-.\\s]?)?(?:\\(?\\d{3}\\)?[-.\\s]?)?\\d{3}[-.\\s]?\\d{4}\\b/g,\n    redactFn: () => \"***-***-****\"\n  },\n  {\n    type: \"ssn\",\n    pattern: /\\b\\d{3}[-.\\s]?\\d{2}[-.\\s]?\\d{4}\\b/g,\n    redactFn: () => \"***-**-****\"\n  },\n  {\n    type: \"credit_card\",\n    pattern: /\\b(?:\\d{4}[-.\\s]?){3}\\d{4}\\b/g,\n    redactFn: (m) => \"****-****-****-\" + m.slice(-4)\n  },\n  {\n    type: \"ip_address\",\n    pattern: /\\b(?:\\d{1,3}\\.){3}\\d{1,3}\\b/g,\n    redactFn: () => \"***.***.***.***\"\n  },\n  {\n    type: \"date_of_birth\",\n    pattern: /\\b(?:0[1-9]|1[0-2])[-/](?:0[1-9]|[12]\\d|3[01])[-/](?:19|20)\\d{2}\\b/g,\n    redactFn: () => \"**/**/**\"\n  }\n];\n\nconst BLOCKED_EXECUTABLES = [\n  \".exe\", \".bat\", \".cmd\", \".sh\", \".ps1\", \".vbs\",\n  \".msi\", \".dll\", \".jar\", \".app\", \".dmg\", \".pkg\",\n  \".deb\", \".rpm\", \".scr\", \".com\", \".pif\"\n];\n\nconst auditLog: AuditLogEntry[] = [];\n\nclass Guardrails {\n  private config: GuardrailsConfig;\n\n  constructor(config: Partial<GuardrailsConfig> = {}) {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n  }\n\n  detectPII(text: string): PIIMatch[] {\n    const matches: PIIMatch[] = [];\n    \n    for (const { type, pattern, redactFn } of PII_PATTERNS) {\n      const regex = new RegExp(pattern.source, pattern.flags);\n      let match;\n      while ((match = regex.exec(text)) !== null) {\n        matches.push({\n          type,\n          value: match[0],\n          redacted: redactFn(match[0]),\n          start: match.index,\n          end: match.index + match[0].length\n        });\n      }\n    }\n\n    return matches.sort((a, b) => a.start - b.start);\n  }\n\n  redactPII(text: string): { text: string; matches: PIIMatch[] } {\n    if (!this.config.enablePIIRedaction) {\n      return { text, matches: [] };\n    }\n\n    const matches = this.detectPII(text);\n    if (matches.length === 0) {\n      return { text, matches: [] };\n    }\n\n    let result = text;\n    let offset = 0;\n\n    for (const match of matches) {\n      const start = match.start + offset;\n      const end = match.end + offset;\n      result = result.slice(0, start) + match.redacted + result.slice(end);\n      offset += match.redacted.length - match.value.length;\n    }\n\n    return { text: result, matches };\n  }\n\n  async checkDownload(\n    url: string, \n    mimeType?: string, \n    size?: number, \n    filename?: string\n  ): Promise<DownloadPolicy> {\n    if (!this.config.enableDownloadControls) {\n      return {\n        allowed: true,\n        maxSizeBytes: this.config.maxDownloadSizeMB * 1024 * 1024,\n        allowedMimeTypes: this.config.allowedDownloadTypes,\n        blockExecutables: true\n      };\n    }\n\n    if (filename) {\n      const ext = filename.toLowerCase().slice(filename.lastIndexOf(\".\"));\n      if (BLOCKED_EXECUTABLES.includes(ext)) {\n        await this.logAction(\"\", \"download\", url, \"blocked\", \"Executable files are blocked\");\n        return {\n          allowed: false,\n          maxSizeBytes: 0,\n          allowedMimeTypes: [],\n          blockExecutables: true\n        };\n      }\n    }\n\n    const maxBytes = this.config.maxDownloadSizeMB * 1024 * 1024;\n    if (size && size > maxBytes) {\n      await this.logAction(\"\", \"download\", url, \"blocked\", `File too large: ${size} bytes`);\n      return {\n        allowed: false,\n        maxSizeBytes: maxBytes,\n        allowedMimeTypes: this.config.allowedDownloadTypes,\n        blockExecutables: true\n      };\n    }\n\n    if (mimeType && !this.config.allowedDownloadTypes.includes(mimeType)) {\n      if (!mimeType.startsWith(\"text/\") && !mimeType.startsWith(\"image/\")) {\n        await this.logAction(\"\", \"download\", url, \"flagged\", `Uncommon MIME type: ${mimeType}`);\n      }\n    }\n\n    return {\n      allowed: true,\n      maxSizeBytes: maxBytes,\n      allowedMimeTypes: this.config.allowedDownloadTypes,\n      blockExecutables: true\n    };\n  }\n\n  async logAction(\n    sessionId: string,\n    action: string,\n    target: string,\n    status: AuditLogEntry[\"status\"],\n    reason?: string,\n    metadata?: Record<string, any>\n  ): Promise<void> {\n    if (!this.config.enableAuditLog) return;\n\n    const entry: AuditLogEntry = {\n      id: crypto.randomUUID(),\n      sessionId,\n      timestamp: new Date(),\n      action,\n      target,\n      status,\n      reason,\n      metadata\n    };\n\n    auditLog.push(entry);\n\n    if (auditLog.length > 10000) {\n      auditLog.splice(0, 1000);\n    }\n\n    if (status === \"blocked\" || status === \"flagged\") {\n      console.log(`[AUDIT] ${status.toUpperCase()}: ${action} on ${target} - ${reason || \"No reason\"}`);\n    }\n  }\n\n  getAuditLog(sessionId?: string, limit: number = 100): AuditLogEntry[] {\n    let entries = [...auditLog];\n    \n    if (sessionId) {\n      entries = entries.filter(e => e.sessionId === sessionId);\n    }\n    \n    return entries.slice(-limit);\n  }\n\n  async validateAction(\n    sessionId: string,\n    actionType: string,\n    target: string,\n    params?: Record<string, any>\n  ): Promise<{ allowed: boolean; reason?: string }> {\n    if (actionType === \"navigate\") {\n      try {\n        const sanitized = sanitizeUrl(target);\n        const policy = await checkDomainPolicy(sanitized);\n        \n        if (!policy.allowed) {\n          await this.logAction(sessionId, actionType, target, \"blocked\", policy.reason);\n          return { allowed: false, reason: policy.reason };\n        }\n\n        const domain = extractDomain(sanitized);\n        if (domain && !checkRateLimit(domain, policy.rateLimit)) {\n          await this.logAction(sessionId, actionType, target, \"blocked\", \"Rate limit exceeded\");\n          return { allowed: false, reason: \"Rate limit exceeded for this domain\" };\n        }\n\n        await this.logAction(sessionId, actionType, target, \"allowed\");\n        return { allowed: true };\n      } catch (e: any) {\n        await this.logAction(sessionId, actionType, target, \"blocked\", e.message);\n        return { allowed: false, reason: e.message };\n      }\n    }\n\n    if (actionType === \"type\" && params?.text) {\n      const { matches } = this.detectPII(params.text) ? { matches: this.detectPII(params.text) } : { matches: [] };\n      if (matches.length > 0) {\n        await this.logAction(sessionId, actionType, target, \"flagged\", \"Input contains PII\", {\n          piiTypes: matches.map(m => m.type)\n        });\n      }\n    }\n\n    if (actionType === \"download\") {\n      const policy = await this.checkDownload(target, params?.mimeType, params?.size, params?.filename);\n      if (!policy.allowed) {\n        return { allowed: false, reason: \"Download blocked by policy\" };\n      }\n    }\n\n    await this.logAction(sessionId, actionType, target, \"allowed\");\n    return { allowed: true };\n  }\n\n  async sanitizeOutput(text: string, sessionId?: string): Promise<string> {\n    const { text: redacted, matches } = this.redactPII(text);\n    \n    if (matches.length > 0 && sessionId) {\n      await this.logAction(sessionId, \"output_sanitize\", \"response\", \"flagged\", \n        `Redacted ${matches.length} PII instances`, {\n          piiTypes: Array.from(new Set(matches.map(m => m.type)))\n        }\n      );\n    }\n\n    return redacted;\n  }\n}\n\nexport const guardrails = new Guardrails();\nexport { checkDomainPolicy, checkRateLimit, sanitizeUrl, isValidObjective, extractDomain };\n","path":null,"size_bytes":8854,"size_tokens":null},"server/agent/pipeline/tools/respond.ts":{"content":"import { ToolDefinition, ExecutionContext, ToolResult } from \"../types\";\nimport OpenAI from \"openai\";\n\nconst openai = new OpenAI({ \n  baseURL: \"https://api.x.ai/v1\", \n  apiKey: process.env.XAI_API_KEY \n});\n\nexport const respondTool: ToolDefinition = {\n  id: \"respond\",\n  name: \"Generate Response\",\n  description: \"Generate a natural language response based on context and gathered information\",\n  category: \"utility\",\n  capabilities: [\"respond\", \"answer\", \"summarize\", \"explain\", \"conclude\"],\n  inputSchema: {\n    objective: { type: \"string\", description: \"The original user objective\", required: true },\n    context: { type: \"string\", description: \"Additional context or gathered data\" },\n    tone: { \n      type: \"string\", \n      description: \"Response tone\",\n      enum: [\"professional\", \"casual\", \"technical\", \"friendly\"],\n      default: \"professional\"\n    },\n    language: { type: \"string\", description: \"Response language\", default: \"auto\" }\n  },\n  outputSchema: {\n    response: { type: \"string\", description: \"The generated response\" }\n  },\n  \n  async execute(context: ExecutionContext, params: Record<string, any>): Promise<ToolResult> {\n    const { objective, context: additionalContext, tone = \"professional\", language = \"auto\" } = params;\n    \n    try {\n      const previousData = context.previousResults\n        .filter(r => r.status === \"completed\" && r.output?.data)\n        .map(r => {\n          if (r.output?.data?.textContent) {\n            return `[From ${r.toolId}]: ${r.output.data.textContent.slice(0, 5000)}`;\n          }\n          if (r.output?.data?.result) {\n            return `[From ${r.toolId}]: ${JSON.stringify(r.output.data.result).slice(0, 5000)}`;\n          }\n          return `[From ${r.toolId}]: ${JSON.stringify(r.output?.data).slice(0, 3000)}`;\n        })\n        .join(\"\\n\\n\");\n\n      const languageInstruction = language === \"auto\" \n        ? \"Respond in the same language as the user's objective.\"\n        : `Respond in ${language}.`;\n\n      const response = await openai.chat.completions.create({\n        model: \"grok-3-fast\",\n        messages: [\n          {\n            role: \"system\",\n            content: `You are Sira GPT, an intelligent assistant. Generate a helpful, comprehensive response.\n\nTone: ${tone}\n${languageInstruction}\n\nYou have access to information gathered from previous steps. Use this information to provide an accurate, well-structured response.\nIf citing sources, mention them naturally in your response.\nBe thorough but concise.`\n          },\n          {\n            role: \"user\",\n            content: `User objective: ${objective}\n\n${additionalContext ? `Additional context: ${additionalContext}\\n\\n` : \"\"}${previousData ? `Information gathered:\\n${previousData}` : \"\"}\n\nGenerate a comprehensive response addressing the user's objective.`\n          }\n        ]\n      });\n\n      const responseText = response.choices[0]?.message?.content || \"No se pudo generar una respuesta.\";\n\n      return {\n        success: true,\n        data: {\n          response: responseText\n        },\n        metadata: {\n          tone,\n          language,\n          previousStepsUsed: context.previousResults.filter(r => r.status === \"completed\").length\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n};\n","path":null,"size_bytes":3332,"size_tokens":null},"server/agent/browser-worker.ts":{"content":"import { chromium, Browser, Page, BrowserContext } from \"playwright\";\nimport crypto from \"crypto\";\n\nexport interface BrowserSession {\n  id: string;\n  browser: Browser;\n  context: BrowserContext;\n  page: Page;\n  createdAt: Date;\n}\n\nexport interface NavigationResult {\n  success: boolean;\n  url: string;\n  title: string;\n  html?: string;\n  screenshot?: Buffer;\n  error?: string;\n  timing: {\n    navigationMs: number;\n    renderMs: number;\n  };\n}\n\nexport interface ClickResult {\n  success: boolean;\n  selector: string;\n  newUrl?: string;\n  error?: string;\n}\n\nexport interface InputResult {\n  success: boolean;\n  selector: string;\n  error?: string;\n}\n\nclass BrowserWorker {\n  private sessions: Map<string, BrowserSession> = new Map();\n  private browser: Browser | null = null;\n\n  async initialize(): Promise<void> {\n    if (this.browser) return;\n    \n    try {\n      this.browser = await chromium.launch({\n        headless: true,\n        args: [\n          \"--no-sandbox\",\n          \"--disable-setuid-sandbox\",\n          \"--disable-dev-shm-usage\",\n          \"--disable-accelerated-2d-canvas\",\n          \"--disable-gpu\",\n          \"--window-size=1920,1080\"\n        ]\n      });\n    } catch (error) {\n      console.error(\"Failed to initialize browser:\", error);\n      throw error;\n    }\n  }\n\n  async createSession(): Promise<string> {\n    await this.initialize();\n    \n    const sessionId = crypto.randomUUID();\n    const context = await this.browser!.newContext({\n      viewport: { width: 1920, height: 1080 },\n      userAgent: \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n    });\n    \n    const page = await context.newPage();\n    \n    this.sessions.set(sessionId, {\n      id: sessionId,\n      browser: this.browser!,\n      context,\n      page,\n      createdAt: new Date()\n    });\n\n    return sessionId;\n  }\n\n  async navigate(sessionId: string, url: string, takeScreenshot: boolean = true): Promise<NavigationResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    const startTime = Date.now();\n    \n    try {\n      await session.page.goto(url, {\n        waitUntil: \"networkidle\",\n        timeout: 30000\n      });\n      \n      const navigationTime = Date.now() - startTime;\n      \n      await session.page.waitForLoadState(\"domcontentloaded\");\n      const renderTime = Date.now() - startTime - navigationTime;\n      \n      const title = await session.page.title();\n      const html = await session.page.content();\n      \n      let screenshot: Buffer | undefined;\n      if (takeScreenshot) {\n        screenshot = await session.page.screenshot({ \n          type: \"png\",\n          fullPage: false \n        });\n      }\n\n      return {\n        success: true,\n        url: session.page.url(),\n        title,\n        html,\n        screenshot,\n        timing: {\n          navigationMs: navigationTime,\n          renderMs: renderTime\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        url,\n        title: \"\",\n        error: error.message,\n        timing: {\n          navigationMs: Date.now() - startTime,\n          renderMs: 0\n        }\n      };\n    }\n  }\n\n  async click(sessionId: string, selector: string): Promise<ClickResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    try {\n      await session.page.click(selector, { timeout: 10000 });\n      await session.page.waitForLoadState(\"networkidle\", { timeout: 10000 }).catch(() => {});\n      \n      return {\n        success: true,\n        selector,\n        newUrl: session.page.url()\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        selector,\n        error: error.message\n      };\n    }\n  }\n\n  async type(sessionId: string, selector: string, text: string): Promise<InputResult> {\n    const session = this.sessions.get(sessionId);\n    if (!session) throw new Error(`Session ${sessionId} not found`);\n\n    try {\n      await session.page.fill(selector, text, { timeout: 10000 });\n      return { success: true, selector };\n    } catch (error: any) {\n      return { success: false, selector, error: error.message };\n    }\n  }\n\n  async pressKey(sessionId: string, key: string): Promise<boolean> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return false;\n\n    try {\n      await session.page.keyboard.press(key);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  async screenshot(sessionId: string, fullPage: boolean = false): Promise<Buffer | null> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return null;\n\n    try {\n      return await session.page.screenshot({ \n        type: \"png\", \n        fullPage \n      });\n    } catch {\n      return null;\n    }\n  }\n\n  async getHtml(sessionId: string): Promise<string | null> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return null;\n\n    try {\n      return await session.page.content();\n    } catch {\n      return null;\n    }\n  }\n\n  async getUrl(sessionId: string): Promise<string | null> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return null;\n\n    return session.page.url();\n  }\n\n  async destroySession(sessionId: string): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) return;\n\n    try {\n      await session.context.close();\n    } catch (e) {\n      console.error(\"Error closing session:\", e);\n    }\n    \n    this.sessions.delete(sessionId);\n  }\n\n  async cleanup(): Promise<void> {\n    const sessionIds = Array.from(this.sessions.keys());\n    for (const id of sessionIds) {\n      await this.destroySession(id);\n    }\n    \n    if (this.browser) {\n      await this.browser.close();\n      this.browser = null;\n    }\n  }\n\n  getSessionCount(): number {\n    return this.sessions.size;\n  }\n}\n\nexport const browserWorker = new BrowserWorker();\n","path":null,"size_bytes":5968,"size_tokens":null},"client/src/components/virtual-computer.tsx":{"content":"import { useState } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Monitor, \n  X, \n  Minimize2, \n  Maximize2, \n  RefreshCw,\n  Globe,\n  MousePointer2,\n  Keyboard,\n  ArrowUp,\n  ArrowDown,\n  Loader2,\n  CheckCircle2,\n  XCircle,\n  ChevronDown,\n  ChevronUp\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { BrowserSessionState, BrowserAction } from \"@/hooks/use-browser-session\";\n\ninterface VirtualComputerProps {\n  state: BrowserSessionState;\n  onClose?: () => void;\n  onCancel?: () => void;\n  className?: string;\n  compact?: boolean;\n}\n\nexport function VirtualComputer({ state, onClose, onCancel, className, compact = false }: VirtualComputerProps) {\n  const [isMinimized, setIsMinimized] = useState(false);\n  const [isTimelineExpanded, setIsTimelineExpanded] = useState(true);\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  const getStatusColor = () => {\n    switch (state.status) {\n      case \"idle\": return \"text-gray-400\";\n      case \"connecting\": return \"text-yellow-500\";\n      case \"active\": return \"text-green-500\";\n      case \"completed\": return \"text-blue-500\";\n      case \"error\": return \"text-red-500\";\n      case \"cancelled\": return \"text-gray-500\";\n      default: return \"text-gray-400\";\n    }\n  };\n\n  const getStatusIcon = () => {\n    switch (state.status) {\n      case \"idle\": return <Monitor className=\"h-3 w-3\" />;\n      case \"connecting\": return <Loader2 className=\"h-3 w-3 animate-spin\" />;\n      case \"active\": return <div className=\"h-2 w-2 rounded-full bg-green-500 animate-pulse\" />;\n      case \"completed\": return <CheckCircle2 className=\"h-3 w-3\" />;\n      case \"error\": return <XCircle className=\"h-3 w-3\" />;\n      default: return null;\n    }\n  };\n\n  const getStatusText = () => {\n    switch (state.status) {\n      case \"idle\": return \"En espera\";\n      case \"connecting\": return \"Conectando\";\n      case \"active\": return \"Activo\";\n      case \"completed\": return \"Completado\";\n      case \"error\": return \"Error\";\n      case \"cancelled\": return \"Cancelado\";\n      default: return state.status;\n    }\n  };\n\n  const getActionIcon = (type: string) => {\n    switch (type) {\n      case \"navigate\": return <Globe className=\"h-3 w-3\" />;\n      case \"click\": return <MousePointer2 className=\"h-3 w-3\" />;\n      case \"type\": return <Keyboard className=\"h-3 w-3\" />;\n      case \"scroll\": return <ArrowDown className=\"h-3 w-3\" />;\n      default: return <Monitor className=\"h-3 w-3\" />;\n    }\n  };\n\n  const formatTime = (date: Date) => {\n    return new Date(date).toLocaleTimeString(\"es-ES\", { \n      hour: \"2-digit\", \n      minute: \"2-digit\", \n      second: \"2-digit\" \n    });\n  };\n\n  const getActionDescription = (action: BrowserAction) => {\n    switch (action.type) {\n      case \"navigate\":\n        return `Navegando a ${action.params.url?.slice(0, 40)}...`;\n      case \"click\":\n        return `Clic en ${action.params.selector?.slice(0, 30)}`;\n      case \"type\":\n        return `Escribiendo \"${action.params.text?.slice(0, 20)}...\"`;\n      case \"scroll\":\n        return `Scroll ${action.params.direction === \"down\" ? \"abajo\" : \"arriba\"}`;\n      default:\n        return action.type;\n    }\n  };\n\n  if (compact && !isExpanded) {\n    if (state.status === \"idle\" && !state.sessionId) {\n      return null;\n    }\n    \n    return (\n      <motion.div\n        initial={{ opacity: 0, scale: 0.9 }}\n        animate={{ opacity: 1, scale: 1 }}\n        className={cn(\n          \"w-[2cm] h-[2cm] border border-border/50 rounded-lg overflow-hidden bg-background/95 backdrop-blur-sm shadow-lg cursor-pointer flex flex-col\",\n          className\n        )}\n        onClick={() => setIsExpanded(true)}\n        data-testid=\"virtual-computer-compact\"\n      >\n        <div className=\"flex items-center justify-center gap-1 px-1 py-0.5 bg-muted/50 border-b border-border/50\">\n          <Monitor className=\"h-2 w-2 text-primary\" />\n          <div className={cn(\"flex items-center\", getStatusColor())}>\n            {getStatusIcon()}\n          </div>\n        </div>\n        <div className=\"flex-1 bg-black/90 flex items-center justify-center relative\">\n          {state.screenshot ? (\n            <img\n              src={state.screenshot}\n              alt=\"Preview\"\n              className=\"w-full h-full object-cover\"\n            />\n          ) : (\n            <Monitor className=\"h-3 w-3 text-muted-foreground\" />\n          )}\n          {state.status === \"active\" && (\n            <div className=\"absolute bottom-0.5 right-0.5\">\n              <div className=\"h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse\" />\n            </div>\n          )}\n        </div>\n      </motion.div>\n    );\n  }\n\n  if (compact && isExpanded) {\n    return (\n      <AnimatePresence>\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          exit={{ opacity: 0, scale: 0.9 }}\n          className=\"fixed inset-4 z-50 border border-border/50 rounded-xl overflow-hidden bg-background/95 backdrop-blur-sm shadow-2xl flex flex-col\"\n          data-testid=\"virtual-computer-expanded\"\n        >\n          <div className=\"flex items-center justify-between px-3 py-2 bg-muted/50 border-b border-border/50\">\n            <div className=\"flex items-center gap-2\">\n              <Monitor className=\"h-4 w-4 text-primary\" />\n              <span className=\"text-sm font-medium\">Computadora Virtual</span>\n              <div className={cn(\"flex items-center gap-1\", getStatusColor())}>\n                {getStatusIcon()}\n                <span className=\"text-xs\">{getStatusText()}</span>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-1\">\n              {state.status === \"active\" && onCancel && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-6 w-6\"\n                  onClick={onCancel}\n                  data-testid=\"button-cancel-session\"\n                >\n                  <X className=\"h-3 w-3\" />\n                </Button>\n              )}\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-6 w-6\"\n                onClick={() => setIsExpanded(false)}\n                data-testid=\"button-minimize-expanded\"\n              >\n                <Minimize2 className=\"h-3 w-3\" />\n              </Button>\n            </div>\n          </div>\n\n          {state.currentUrl && (\n            <div className=\"flex items-center gap-2 px-3 py-1.5 bg-muted/30 border-b border-border/30\">\n              <Globe className=\"h-3 w-3 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground truncate flex-1\" data-testid=\"text-current-url\">\n                {state.currentUrl}\n              </span>\n            </div>\n          )}\n\n          <div className=\"flex-1 relative bg-black/90 flex items-center justify-center\">\n            {state.screenshot ? (\n              <img\n                src={state.screenshot}\n                alt=\"Browser Screenshot\"\n                className=\"w-full h-full object-contain\"\n                data-testid=\"img-screenshot\"\n              />\n            ) : (\n              <div className=\"flex flex-col items-center gap-2 text-muted-foreground\">\n                {state.status === \"connecting\" || state.status === \"active\" ? (\n                  <>\n                    <Loader2 className=\"h-8 w-8 animate-spin\" />\n                    <span className=\"text-sm\">Cargando vista previa...</span>\n                  </>\n                ) : (\n                  <>\n                    <Monitor className=\"h-8 w-8\" />\n                    <span className=\"text-sm\">Sin vista previa disponible</span>\n                  </>\n                )}\n              </div>\n            )}\n            {state.status === \"active\" && (\n              <div className=\"absolute bottom-2 right-2 flex items-center gap-1 px-2 py-1 bg-black/70 rounded-full\">\n                <div className=\"h-2 w-2 rounded-full bg-green-500 animate-pulse\" />\n                <span className=\"text-xs text-white\">En vivo</span>\n              </div>\n            )}\n          </div>\n\n          {state.objective && (\n            <div className=\"px-3 py-2 border-t border-border/30 bg-muted/20\">\n              <p className=\"text-xs text-muted-foreground\">\n                <span className=\"font-medium\">Objetivo:</span> {state.objective}\n              </p>\n            </div>\n          )}\n\n          {state.error && (\n            <div className=\"px-3 py-2 bg-red-500/10 border-t border-red-500/20\">\n              <p className=\"text-xs text-red-500\" data-testid=\"text-error\">\n                Error: {state.error}\n              </p>\n            </div>\n          )}\n        </motion.div>\n      </AnimatePresence>\n    );\n  }\n\n  return (\n    <AnimatePresence>\n      <motion.div\n        initial={{ opacity: 0, y: -20 }}\n        animate={{ opacity: 1, y: 0 }}\n        exit={{ opacity: 0, y: -20 }}\n        className={cn(\n          \"border border-border/50 rounded-xl overflow-hidden bg-background/95 backdrop-blur-sm shadow-lg\",\n          className\n        )}\n        data-testid=\"virtual-computer\"\n      >\n        <div className=\"flex items-center justify-between px-3 py-2 bg-muted/50 border-b border-border/50\">\n          <div className=\"flex items-center gap-2\">\n            <Monitor className=\"h-4 w-4 text-primary\" />\n            <span className=\"text-sm font-medium\">Computadora Virtual</span>\n            <div className={cn(\"flex items-center gap-1\", getStatusColor())}>\n              {getStatusIcon()}\n              <span className=\"text-xs\">{getStatusText()}</span>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-1\">\n            {state.status === \"active\" && onCancel && (\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-6 w-6\"\n                onClick={onCancel}\n                data-testid=\"button-cancel-session\"\n              >\n                <X className=\"h-3 w-3\" />\n              </Button>\n            )}\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-6 w-6\"\n              onClick={() => setIsMinimized(!isMinimized)}\n              data-testid=\"button-toggle-minimize\"\n            >\n              {isMinimized ? <Maximize2 className=\"h-3 w-3\" /> : <Minimize2 className=\"h-3 w-3\" />}\n            </Button>\n          </div>\n        </div>\n\n        {!isMinimized && (\n          <>\n            {state.currentUrl && (\n              <div className=\"flex items-center gap-2 px-3 py-1.5 bg-muted/30 border-b border-border/30\">\n                <Globe className=\"h-3 w-3 text-muted-foreground\" />\n                <span className=\"text-xs text-muted-foreground truncate flex-1\" data-testid=\"text-current-url\">\n                  {state.currentUrl}\n                </span>\n              </div>\n            )}\n\n            <div className=\"relative aspect-video bg-black/90 flex items-center justify-center min-h-[200px] max-h-[400px]\">\n              {state.screenshot ? (\n                <img\n                  src={state.screenshot}\n                  alt=\"Browser Screenshot\"\n                  className=\"w-full h-full object-contain\"\n                  data-testid=\"img-screenshot\"\n                />\n              ) : (\n                <div className=\"flex flex-col items-center gap-2 text-muted-foreground\">\n                  {state.status === \"connecting\" || state.status === \"active\" ? (\n                    <>\n                      <Loader2 className=\"h-8 w-8 animate-spin\" />\n                      <span className=\"text-sm\">Cargando vista previa...</span>\n                    </>\n                  ) : (\n                    <>\n                      <Monitor className=\"h-8 w-8\" />\n                      <span className=\"text-sm\">Sin vista previa disponible</span>\n                    </>\n                  )}\n                </div>\n              )}\n\n              {state.status === \"active\" && (\n                <div className=\"absolute bottom-2 right-2 flex items-center gap-1 px-2 py-1 bg-black/70 rounded-full\">\n                  <div className=\"h-2 w-2 rounded-full bg-green-500 animate-pulse\" />\n                  <span className=\"text-xs text-white\">En vivo</span>\n                </div>\n              )}\n            </div>\n\n            {state.objective && (\n              <div className=\"px-3 py-2 border-t border-border/30 bg-muted/20\">\n                <p className=\"text-xs text-muted-foreground\">\n                  <span className=\"font-medium\">Objetivo:</span> {state.objective}\n                </p>\n              </div>\n            )}\n\n            {state.actions.length > 0 && (\n              <div className=\"border-t border-border/30\">\n                <button\n                  className=\"w-full flex items-center justify-between px-3 py-2 hover:bg-muted/30 transition-colors\"\n                  onClick={() => setIsTimelineExpanded(!isTimelineExpanded)}\n                  data-testid=\"button-toggle-timeline\"\n                >\n                  <span className=\"text-xs font-medium\">\n                    Actividad ({state.actions.length} acciones)\n                  </span>\n                  {isTimelineExpanded ? (\n                    <ChevronUp className=\"h-3 w-3\" />\n                  ) : (\n                    <ChevronDown className=\"h-3 w-3\" />\n                  )}\n                </button>\n                \n                <AnimatePresence>\n                  {isTimelineExpanded && (\n                    <motion.div\n                      initial={{ height: 0, opacity: 0 }}\n                      animate={{ height: \"auto\", opacity: 1 }}\n                      exit={{ height: 0, opacity: 0 }}\n                      className=\"overflow-hidden\"\n                    >\n                      <div className=\"max-h-[150px] overflow-y-auto px-3 pb-2\">\n                        {state.actions.slice(-10).reverse().map((action, index) => (\n                          <div\n                            key={index}\n                            className=\"flex items-start gap-2 py-1.5 border-b border-border/20 last:border-0\"\n                            data-testid={`action-item-${index}`}\n                          >\n                            <div className=\"flex items-center justify-center h-5 w-5 rounded-full bg-primary/10 text-primary flex-shrink-0\">\n                              {getActionIcon(action.type)}\n                            </div>\n                            <div className=\"flex-1 min-w-0\">\n                              <p className=\"text-xs truncate\">{getActionDescription(action)}</p>\n                              <p className=\"text-[10px] text-muted-foreground\">\n                                {formatTime(action.timestamp)}\n                              </p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </div>\n            )}\n\n            {state.error && (\n              <div className=\"px-3 py-2 bg-red-500/10 border-t border-red-500/20\">\n                <p className=\"text-xs text-red-500\" data-testid=\"text-error\">\n                  Error: {state.error}\n                </p>\n              </div>\n            )}\n          </>\n        )}\n      </motion.div>\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":15456,"size_tokens":null},"server/agent/pipeline/tools/transform-data.ts":{"content":"import { ToolDefinition, ExecutionContext, ToolResult } from \"../types\";\nimport OpenAI from \"openai\";\n\nconst openai = new OpenAI({ \n  baseURL: \"https://api.x.ai/v1\", \n  apiKey: process.env.XAI_API_KEY \n});\n\nexport const transformDataTool: ToolDefinition = {\n  id: \"transform_data\",\n  name: \"Transform Data\",\n  description: \"Transform, filter, or restructure data using natural language instructions or code\",\n  category: \"transform\",\n  capabilities: [\"transform\", \"convert\", \"filter\", \"map\", \"restructure\", \"format\", \"process\"],\n  inputSchema: {\n    data: { type: \"object\", description: \"The data to transform\", required: true },\n    instruction: { type: \"string\", description: \"Natural language instruction for transformation\", required: true },\n    outputFormat: { \n      type: \"string\", \n      description: \"Desired output format\",\n      enum: [\"json\", \"text\", \"csv\", \"markdown\", \"table\"],\n      default: \"json\"\n    }\n  },\n  outputSchema: {\n    result: { type: \"object\", description: \"The transformed data\" },\n    format: { type: \"string\", description: \"The output format used\" }\n  },\n  \n  async execute(context: ExecutionContext, params: Record<string, any>): Promise<ToolResult> {\n    const { data, instruction, outputFormat = \"json\" } = params;\n    \n    if (!data) {\n      return {\n        success: false,\n        error: \"No data provided\"\n      };\n    }\n\n    try {\n      const dataStr = typeof data === \"string\" ? data : JSON.stringify(data, null, 2);\n      \n      const response = await openai.chat.completions.create({\n        model: \"grok-3-fast\",\n        messages: [\n          {\n            role: \"system\",\n            content: `You are a data transformation assistant. Transform the input data according to the instruction.\nOutput format: ${outputFormat}\n\nFor JSON output, respond with valid JSON only.\nFor text output, respond with plain text.\nFor CSV output, respond with comma-separated values.\nFor markdown output, respond with formatted markdown.\nFor table output, respond with a markdown table.\n\nBe precise and only output the transformed data, no explanations.`\n          },\n          {\n            role: \"user\",\n            content: `Input data:\n${dataStr.slice(0, 50000)}\n\nTransformation instruction: ${instruction}\n\nTransform and output as ${outputFormat}.`\n          }\n        ]\n      });\n\n      const result = response.choices[0]?.message?.content || \"\";\n\n      let parsedResult: any = result;\n      if (outputFormat === \"json\") {\n        try {\n          const jsonMatch = result.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                           result.match(/```\\s*([\\s\\S]*?)\\s*```/);\n          const jsonStr = jsonMatch ? jsonMatch[1] : result;\n          parsedResult = JSON.parse(jsonStr.trim());\n        } catch {\n          parsedResult = result;\n        }\n      }\n\n      return {\n        success: true,\n        data: {\n          result: parsedResult,\n          format: outputFormat\n        },\n        metadata: {\n          inputSize: dataStr.length,\n          outputSize: result.length,\n          format: outputFormat\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n};\n","path":null,"size_bytes":3184,"size_tokens":null},"server/parsers/fallbackParser.ts":{"content":"import type { FileParser, ParsedResult, DetectedFileType } from \"./base\";\n\nexport class FallbackParser implements FileParser {\n  name = \"fallback\";\n  supportedMimeTypes = [\"*/*\"];\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    return {\n      text: content.toString(\"utf-8\"),\n      warnings: [`Unknown MIME type ${type.mimeType}, attempting text extraction`],\n    };\n  }\n}\n","path":null,"size_bytes":410,"size_tokens":null},"server/parsers/docxParser.ts":{"content":"import mammoth from \"mammoth\";\nimport JSZip from \"jszip\";\nimport type { FileParser, ParsedResult, DetectedFileType } from \"./base\";\n\nexport class DocxParser implements FileParser {\n  name = \"docx\";\n  supportedMimeTypes = [\n    \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  ];\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    try {\n      const [htmlResult, metadata] = await Promise.all([\n        this.extractStructuredContent(content),\n        this.extractMetadata(content),\n      ]);\n\n      const structuredText = this.htmlToStructuredText(htmlResult.value);\n      const formattedOutput = this.formatOutput(metadata, structuredText);\n\n      return {\n        text: formattedOutput,\n        metadata,\n        warnings: htmlResult.messages\n          .filter((m: { type: string; message: string }) => m.type === \"warning\")\n          .map((m: { type: string; message: string }) => m.message),\n      };\n    } catch (error) {\n      const elapsed = Date.now() - startTime;\n      console.error(`[DocxParser] Failed after ${elapsed}ms:`, error);\n      \n      if (error instanceof Error) {\n        throw new Error(`Failed to parse DOCX: ${error.message}`);\n      }\n      throw new Error(\"Failed to parse DOCX: Unknown error\");\n    }\n  }\n\n  private async extractStructuredContent(content: Buffer): Promise<{ value: string; messages: Array<{ type: string; message: string }> }> {\n    return mammoth.convertToHtml({ buffer: content }, {\n      styleMap: [\n        \"p[style-name='Heading 1'] => h1:fresh\",\n        \"p[style-name='Heading 2'] => h2:fresh\",\n        \"p[style-name='Heading 3'] => h3:fresh\",\n        \"p[style-name='Heading 4'] => h4:fresh\",\n        \"p[style-name='Title'] => h1.title:fresh\",\n        \"p[style-name='Subtitle'] => h2.subtitle:fresh\",\n        \"b => strong\",\n        \"i => em\",\n        \"u => u\",\n      ],\n    });\n  }\n\n  private async extractMetadata(content: Buffer): Promise<Record<string, any>> {\n    try {\n      const zip = await JSZip.loadAsync(content);\n      const coreXml = await zip.file(\"docProps/core.xml\")?.async(\"string\");\n      \n      if (!coreXml) {\n        return {};\n      }\n\n      const metadata: Record<string, any> = {};\n      \n      const titleMatch = coreXml.match(/<dc:title>([^<]*)<\\/dc:title>/);\n      if (titleMatch) metadata.title = titleMatch[1];\n      \n      const creatorMatch = coreXml.match(/<dc:creator>([^<]*)<\\/dc:creator>/);\n      if (creatorMatch) metadata.author = creatorMatch[1];\n      \n      const subjectMatch = coreXml.match(/<dc:subject>([^<]*)<\\/dc:subject>/);\n      if (subjectMatch) metadata.subject = subjectMatch[1];\n      \n      const createdMatch = coreXml.match(/<dcterms:created[^>]*>([^<]*)<\\/dcterms:created>/);\n      if (createdMatch) metadata.creationDate = this.formatDate(createdMatch[1]);\n      \n      const modifiedMatch = coreXml.match(/<dcterms:modified[^>]*>([^<]*)<\\/dcterms:modified>/);\n      if (modifiedMatch) metadata.modificationDate = this.formatDate(modifiedMatch[1]);\n\n      const appXml = await zip.file(\"docProps/app.xml\")?.async(\"string\");\n      if (appXml) {\n        const pagesMatch = appXml.match(/<Pages>(\\d+)<\\/Pages>/);\n        if (pagesMatch) metadata.pages = parseInt(pagesMatch[1], 10);\n        \n        const wordsMatch = appXml.match(/<Words>(\\d+)<\\/Words>/);\n        if (wordsMatch) metadata.wordCount = parseInt(wordsMatch[1], 10);\n      }\n\n      return metadata;\n    } catch (error) {\n      console.warn(\"[DocxParser] Could not extract metadata:\", error);\n      return {};\n    }\n  }\n\n  private formatDate(isoDate: string): string {\n    try {\n      const date = new Date(isoDate);\n      return date.toISOString().split('T')[0];\n    } catch {\n      return isoDate;\n    }\n  }\n\n  private htmlToStructuredText(html: string): string {\n    const lines: string[] = [];\n    \n    let processed = html\n      .replace(/<h1[^>]*class=\"title\"[^>]*>(.*?)<\\/h1>/gi, (_, content) => `# ${this.stripTags(content)}\\n\\n`)\n      .replace(/<h1[^>]*>(.*?)<\\/h1>/gi, (_, content) => `# ${this.stripTags(content)}\\n\\n`)\n      .replace(/<h2[^>]*class=\"subtitle\"[^>]*>(.*?)<\\/h2>/gi, (_, content) => `## ${this.stripTags(content)}\\n\\n`)\n      .replace(/<h2[^>]*>(.*?)<\\/h2>/gi, (_, content) => `## ${this.stripTags(content)}\\n\\n`)\n      .replace(/<h3[^>]*>(.*?)<\\/h3>/gi, (_, content) => `### ${this.stripTags(content)}\\n\\n`)\n      .replace(/<h4[^>]*>(.*?)<\\/h4>/gi, (_, content) => `#### ${this.stripTags(content)}\\n\\n`)\n      .replace(/<h5[^>]*>(.*?)<\\/h5>/gi, (_, content) => `##### ${this.stripTags(content)}\\n\\n`)\n      .replace(/<h6[^>]*>(.*?)<\\/h6>/gi, (_, content) => `###### ${this.stripTags(content)}\\n\\n`);\n\n    processed = this.convertTables(processed);\n    processed = this.convertLists(processed);\n    \n    processed = processed\n      .replace(/<p[^>]*>(.*?)<\\/p>/gi, (_, content) => `${this.stripTags(content)}\\n\\n`)\n      .replace(/<br\\s*\\/?>/gi, '\\n')\n      .replace(/<strong>(.*?)<\\/strong>/gi, '**$1**')\n      .replace(/<b>(.*?)<\\/b>/gi, '**$1**')\n      .replace(/<em>(.*?)<\\/em>/gi, '*$1*')\n      .replace(/<i>(.*?)<\\/i>/gi, '*$1*')\n      .replace(/<u>(.*?)<\\/u>/gi, '_$1_');\n\n    processed = this.stripTags(processed);\n    processed = processed\n      .replace(/\\n{3,}/g, '\\n\\n')\n      .trim();\n\n    return processed;\n  }\n\n  private convertTables(html: string): string {\n    return html.replace(/<table[^>]*>([\\s\\S]*?)<\\/table>/gi, (_, tableContent) => {\n      const rows: string[][] = [];\n      const rowMatches = tableContent.matchAll(/<tr[^>]*>([\\s\\S]*?)<\\/tr>/gi);\n      \n      for (const rowMatch of rowMatches) {\n        const cells: string[] = [];\n        const cellMatches = rowMatch[1].matchAll(/<t[hd][^>]*>([\\s\\S]*?)<\\/t[hd]>/gi);\n        \n        for (const cellMatch of cellMatches) {\n          cells.push(this.stripTags(cellMatch[1]).trim());\n        }\n        \n        if (cells.length > 0) {\n          rows.push(cells);\n        }\n      }\n\n      if (rows.length === 0) return '';\n\n      const maxCols = Math.max(...rows.map(r => r.length));\n      const normalizedRows = rows.map(row => {\n        while (row.length < maxCols) row.push('');\n        return row;\n      });\n\n      let markdown = '\\n\\n';\n      markdown += '| ' + normalizedRows[0].join(' | ') + ' |\\n';\n      markdown += '| ' + normalizedRows[0].map(() => '---').join(' | ') + ' |\\n';\n      \n      for (let i = 1; i < normalizedRows.length; i++) {\n        markdown += '| ' + normalizedRows[i].join(' | ') + ' |\\n';\n      }\n      \n      return markdown + '\\n';\n    });\n  }\n\n  private convertLists(html: string): string {\n    let result = html;\n    \n    result = result.replace(/<ol[^>]*>([\\s\\S]*?)<\\/ol>/gi, (_, listContent) => {\n      let counter = 1;\n      const items = listContent.replace(/<li[^>]*>([\\s\\S]*?)<\\/li>/gi, (_: string, itemContent: string) => {\n        return `${counter++}. ${this.stripTags(itemContent).trim()}\\n`;\n      });\n      return '\\n' + items + '\\n';\n    });\n\n    result = result.replace(/<ul[^>]*>([\\s\\S]*?)<\\/ul>/gi, (_, listContent) => {\n      const items = listContent.replace(/<li[^>]*>([\\s\\S]*?)<\\/li>/gi, (_: string, itemContent: string) => {\n        return `- ${this.stripTags(itemContent).trim()}\\n`;\n      });\n      return '\\n' + items + '\\n';\n    });\n\n    return result;\n  }\n\n  private stripTags(html: string): string {\n    return html\n      .replace(/<[^>]*>/g, '')\n      .replace(/&nbsp;/g, ' ')\n      .replace(/&amp;/g, '&')\n      .replace(/&lt;/g, '<')\n      .replace(/&gt;/g, '>')\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\");\n  }\n\n  private formatOutput(metadata: Record<string, any>, content: string): string {\n    const parts: string[] = [];\n    \n    if (Object.keys(metadata).length > 0) {\n      parts.push('=== Document Info ===');\n      if (metadata.title) parts.push(`Title: ${metadata.title}`);\n      if (metadata.author) parts.push(`Author: ${metadata.author}`);\n      if (metadata.creationDate) parts.push(`Created: ${metadata.creationDate}`);\n      if (metadata.pages) parts.push(`Pages: ${metadata.pages}`);\n      if (metadata.wordCount) parts.push(`Word Count: ${metadata.wordCount}`);\n      parts.push('');\n      parts.push('=== Content ===');\n    }\n    \n    parts.push(content);\n\n    return parts.join('\\n').trim();\n  }\n}\n","path":null,"size_bytes":8230,"size_tokens":null},"server/services/detectorChain.ts":{"content":"import type { DetectedFileType } from \"../parsers/base\";\n\nconst OPENXML_EXTENSIONS = [\"docx\", \"xlsx\", \"pptx\"];\n\nconst FILE_SIGNATURES: { signature: number[]; offset: number; mimeType: string; extension: string }[] = [\n  { signature: [0x25, 0x50, 0x44, 0x46], offset: 0, mimeType: \"application/pdf\", extension: \"pdf\" },\n  { signature: [0xd0, 0xcf, 0x11, 0xe0], offset: 0, mimeType: \"application/msword\", extension: \"doc\" },\n];\n\nconst EXTENSION_TO_MIME: Record<string, string> = {\n  pdf: \"application/pdf\",\n  doc: \"application/msword\",\n  docx: \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  xls: \"application/vnd.ms-excel\",\n  xlsx: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  ppt: \"application/vnd.ms-powerpoint\",\n  pptx: \"application/vnd.openxmlformats-officedocument.presentationml.presentation\",\n  txt: \"text/plain\",\n  md: \"text/markdown\",\n  csv: \"text/csv\",\n  html: \"text/html\",\n  htm: \"text/html\",\n  json: \"application/json\",\n  png: \"image/png\",\n  jpg: \"image/jpeg\",\n  jpeg: \"image/jpeg\",\n  gif: \"image/gif\",\n  bmp: \"image/bmp\",\n  webp: \"image/webp\",\n  tiff: \"image/tiff\",\n  tif: \"image/tiff\",\n};\n\nfunction isZipSignature(content: Buffer): boolean {\n  return content.length >= 4 &&\n    content[0] === 0x50 &&\n    content[1] === 0x4b &&\n    content[2] === 0x03 &&\n    content[3] === 0x04;\n}\n\nfunction detectBySignature(content: Buffer): DetectedFileType | null {\n  for (const sig of FILE_SIGNATURES) {\n    if (content.length >= sig.offset + sig.signature.length) {\n      const matches = sig.signature.every(\n        (byte, i) => content[sig.offset + i] === byte\n      );\n      if (matches) {\n        return { mimeType: sig.mimeType, extension: sig.extension, confidence: 0.9 };\n      }\n    }\n  }\n  return null;\n}\n\nfunction detectByExtension(filename: string): DetectedFileType | null {\n  const ext = filename.split(\".\").pop()?.toLowerCase();\n  if (ext && EXTENSION_TO_MIME[ext]) {\n    return { mimeType: EXTENSION_TO_MIME[ext], extension: ext, confidence: 0.7 };\n  }\n  return null;\n}\n\nexport function detectFileType(\n  content: Buffer,\n  providedMimeType?: string,\n  filename?: string\n): DetectedFileType {\n  if (providedMimeType && providedMimeType !== \"application/octet-stream\") {\n    const ext = filename?.split(\".\").pop()?.toLowerCase() || \"\";\n    return { mimeType: providedMimeType, extension: ext, confidence: 1.0 };\n  }\n\n  const ext = filename?.split(\".\").pop()?.toLowerCase();\n  \n  if (ext && OPENXML_EXTENSIONS.includes(ext) && isZipSignature(content)) {\n    return { mimeType: EXTENSION_TO_MIME[ext], extension: ext, confidence: 0.95 };\n  }\n\n  if (filename) {\n    const byExt = detectByExtension(filename);\n    if (byExt) return byExt;\n  }\n\n  const bySignature = detectBySignature(content);\n  if (bySignature) return bySignature;\n\n  return { mimeType: \"application/octet-stream\", extension: \"\", confidence: 0.1 };\n}\n","path":null,"size_bytes":2887,"size_tokens":null},"server/parsers/base.ts":{"content":"export interface DetectedFileType {\n  mimeType: string;\n  extension: string;\n  confidence: number;\n}\n\nexport interface ParsedResult {\n  text: string;\n  metadata?: Record<string, any>;\n  warnings?: string[];\n}\n\nexport interface FileParser {\n  name: string;\n  supportedMimeTypes: string[];\n  parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult>;\n}\n","path":null,"size_bytes":363,"size_tokens":null},"server/agent/pipeline/executor.ts":{"content":"import crypto from \"crypto\";\nimport { toolRegistry } from \"./registry\";\nimport { storage } from \"../../storage\";\nimport {\n  ExecutionPlan,\n  PlanStep,\n  StepResult,\n  ExecutionContext,\n  ToolResult,\n  Artifact,\n  ProgressUpdate,\n  PipelineConfig,\n  DEFAULT_PIPELINE_CONFIG\n} from \"./types\";\n\nexport type StepCallback = (update: ProgressUpdate) => void;\n\nexport class PipelineExecutor {\n  private config: PipelineConfig;\n  private cancelledRuns: Set<string> = new Set();\n\n  constructor(config: Partial<PipelineConfig> = {}) {\n    this.config = { ...DEFAULT_PIPELINE_CONFIG, ...config };\n  }\n\n  async execute(\n    plan: ExecutionPlan,\n    onProgress?: StepCallback\n  ): Promise<{ results: StepResult[]; artifacts: Artifact[] }> {\n    const results: StepResult[] = [];\n    const artifacts: Map<string, Artifact> = new Map();\n    const variables: Map<string, any> = new Map();\n    const completedSteps: Set<string> = new Set();\n\n    for (let i = 0; i < plan.steps.length; i++) {\n      if (this.cancelledRuns.has(plan.runId)) {\n        break;\n      }\n\n      const step = plan.steps[i];\n      \n      if (step.dependsOn) {\n        const unmetDeps = step.dependsOn.filter(depId => !completedSteps.has(depId));\n        if (unmetDeps.length > 0) {\n          const failedDeps = unmetDeps.filter(depId => \n            results.find(r => r.stepId === depId && r.status === \"failed\")\n          );\n          \n          if (failedDeps.length > 0 && !step.optional) {\n            results.push({\n              stepId: step.id,\n              toolId: step.toolId,\n              status: \"skipped\",\n              input: step.params,\n              retryCount: 0,\n              validated: false,\n              validationErrors: [`Skipped due to failed dependencies: ${failedDeps.join(\", \")}`]\n            });\n            continue;\n          }\n        }\n      }\n\n      if (step.condition) {\n        try {\n          const conditionMet = this.evaluateCondition(step.condition, variables);\n          if (!conditionMet) {\n            results.push({\n              stepId: step.id,\n              toolId: step.toolId,\n              status: \"skipped\",\n              input: step.params,\n              retryCount: 0,\n              validated: false,\n              validationErrors: [\"Condition not met\"]\n            });\n            continue;\n          }\n        } catch (e) {\n          console.warn(`Condition evaluation failed for step ${step.id}:`, e);\n        }\n      }\n\n      const context: ExecutionContext = {\n        runId: plan.runId,\n        planId: plan.id,\n        stepIndex: i,\n        previousResults: results,\n        artifacts,\n        variables,\n        onProgress: (update) => onProgress?.(update),\n        isCancelled: () => this.cancelledRuns.has(plan.runId)\n      };\n\n      const result = await this.executeStep(step, context, onProgress);\n      results.push(result);\n\n      if (result.status === \"completed\") {\n        completedSteps.add(step.id);\n        \n        if (result.output?.data !== undefined) {\n          variables.set(`${step.id}_output`, result.output.data);\n          variables.set(`step_${i}_output`, result.output.data);\n        }\n        \n        if (result.output?.artifacts) {\n          for (const artifact of result.output.artifacts) {\n            artifacts.set(artifact.id, artifact);\n          }\n        }\n      }\n\n      if (result.status === \"failed\" && !step.optional) {\n        const hasRecovery = plan.steps.slice(i + 1).some(s => \n          s.dependsOn?.includes(step.id) === false\n        );\n        if (!hasRecovery) {\n          break;\n        }\n      }\n    }\n\n    return { results, artifacts: Array.from(artifacts.values()) };\n  }\n\n  private async executeStep(\n    step: PlanStep,\n    context: ExecutionContext,\n    onProgress?: StepCallback\n  ): Promise<StepResult> {\n    const startedAt = new Date();\n    let retryCount = 0;\n    const maxRetries = step.retryPolicy?.maxRetries || 2;\n    \n    onProgress?.({\n      runId: context.runId,\n      stepId: step.id,\n      status: \"started\",\n      message: step.description\n    });\n\n    const tool = toolRegistry.get(step.toolId);\n    if (!tool) {\n      return {\n        stepId: step.id,\n        toolId: step.toolId,\n        status: \"failed\",\n        startedAt,\n        completedAt: new Date(),\n        input: step.params,\n        output: { success: false, error: `Tool '${step.toolId}' not found` },\n        retryCount: 0,\n        validated: false,\n        validationErrors: [`Unknown tool: ${step.toolId}`]\n      };\n    }\n\n    const resolvedParams = this.resolveParams(step.params, context);\n    \n    const validation = toolRegistry.validateToolParams(step.toolId, resolvedParams);\n    if (!validation.valid) {\n      return {\n        stepId: step.id,\n        toolId: step.toolId,\n        status: \"failed\",\n        startedAt,\n        completedAt: new Date(),\n        input: resolvedParams,\n        output: { success: false, error: `Invalid parameters: ${validation.errors?.join(\", \")}` },\n        retryCount: 0,\n        validated: false,\n        validationErrors: validation.errors\n      };\n    }\n\n    let lastError: string | undefined;\n    \n    while (retryCount <= maxRetries) {\n      if (context.isCancelled()) {\n        return {\n          stepId: step.id,\n          toolId: step.toolId,\n          status: \"failed\",\n          startedAt,\n          completedAt: new Date(),\n          input: resolvedParams,\n          output: { success: false, error: \"Cancelled by user\" },\n          retryCount,\n          validated: false\n        };\n      }\n\n      try {\n        const timeout = step.timeout || tool.timeout || this.config.defaultTimeout;\n        \n        const result = await Promise.race([\n          tool.execute(context, resolvedParams),\n          new Promise<ToolResult>((_, reject) => \n            setTimeout(() => reject(new Error(\"Step timeout\")), timeout)\n          )\n        ]);\n\n        const completedAt = new Date();\n        \n        onProgress?.({\n          runId: context.runId,\n          stepId: step.id,\n          status: result.success ? \"completed\" : \"failed\",\n          message: result.success ? `Completed: ${step.description}` : result.error,\n          detail: result.metadata\n        });\n\n        return {\n          stepId: step.id,\n          toolId: step.toolId,\n          status: result.success ? \"completed\" : \"failed\",\n          startedAt,\n          completedAt,\n          input: resolvedParams,\n          output: result,\n          retryCount,\n          duration: completedAt.getTime() - startedAt.getTime(),\n          validated: result.success,\n          validationErrors: result.success ? undefined : [result.error || \"Unknown error\"]\n        };\n      } catch (error: any) {\n        lastError = error.message;\n        retryCount++;\n        \n        if (retryCount <= maxRetries) {\n          const delay = (step.retryPolicy?.delayMs || 1000) * \n            Math.pow(step.retryPolicy?.backoffMultiplier || 2, retryCount - 1);\n          await new Promise(resolve => setTimeout(resolve, delay));\n          \n          onProgress?.({\n            runId: context.runId,\n            stepId: step.id,\n            status: \"progress\",\n            message: `Retry ${retryCount}/${maxRetries}: ${error.message}`\n          });\n        }\n      }\n    }\n\n    const completedAt = new Date();\n    \n    onProgress?.({\n      runId: context.runId,\n      stepId: step.id,\n      status: \"failed\",\n      message: `Failed after ${retryCount} retries: ${lastError}`\n    });\n\n    return {\n      stepId: step.id,\n      toolId: step.toolId,\n      status: \"failed\",\n      startedAt,\n      completedAt,\n      input: resolvedParams,\n      output: { success: false, error: lastError },\n      retryCount,\n      duration: completedAt.getTime() - startedAt.getTime(),\n      validated: false,\n      validationErrors: [lastError || \"Max retries exceeded\"]\n    };\n  }\n\n  private resolveParams(\n    params: Record<string, any>,\n    context: ExecutionContext\n  ): Record<string, any> {\n    const resolved: Record<string, any> = {};\n    \n    for (const [key, value] of Object.entries(params)) {\n      if (typeof value === \"string\") {\n        resolved[key] = this.interpolateString(value, context);\n      } else if (Array.isArray(value)) {\n        resolved[key] = value.map(v => \n          typeof v === \"string\" ? this.interpolateString(v, context) : v\n        );\n      } else if (typeof value === \"object\" && value !== null) {\n        resolved[key] = this.resolveParams(value, context);\n      } else {\n        resolved[key] = value;\n      }\n    }\n    \n    return resolved;\n  }\n\n  private interpolateString(str: string, context: ExecutionContext): string {\n    return str.replace(/\\$\\{([^}]+)\\}/g, (_, expr) => {\n      const value = context.variables.get(expr);\n      return value !== undefined ? String(value) : `\\${${expr}}`;\n    });\n  }\n\n  private evaluateCondition(condition: string, variables: Map<string, any>): boolean {\n    const varObj: Record<string, any> = {};\n    variables.forEach((value, key) => {\n      varObj[key] = value;\n    });\n    \n    try {\n      const fn = new Function(...Object.keys(varObj), `return ${condition}`);\n      return Boolean(fn(...Object.values(varObj)));\n    } catch {\n      return true;\n    }\n  }\n\n  cancel(runId: string): void {\n    this.cancelledRuns.add(runId);\n  }\n\n  isRunning(runId: string): boolean {\n    return !this.cancelledRuns.has(runId);\n  }\n}\n\nexport const pipelineExecutor = new PipelineExecutor();\n","path":null,"size_bytes":9393,"size_tokens":null},"server/agent/browser/types.ts":{"content":"export interface SessionConfig {\n  viewport?: { width: number; height: number };\n  userAgent?: string;\n  timeout?: number;\n  allowedDomains?: string[];\n  maxDownloadSize?: number;\n  enableNetworkCapture?: boolean;\n}\n\nexport interface BrowserAction {\n  type: \"navigate\" | \"click\" | \"type\" | \"scroll\" | \"download\" | \"screenshot\" | \"wait\" | \"evaluate\" | \"getState\";\n  params: Record<string, any>;\n  timestamp: Date;\n}\n\nexport interface ActionResult {\n  success: boolean;\n  action: BrowserAction;\n  data?: any;\n  screenshot?: string;\n  error?: string;\n  duration: number;\n}\n\nexport interface Observation {\n  sessionId: string;\n  timestamp: Date;\n  type: \"screenshot\" | \"dom\" | \"text\" | \"network\" | \"error\" | \"state\";\n  data: any;\n}\n\nexport interface NetworkRequest {\n  url: string;\n  method: string;\n  status?: number;\n  mimeType?: string;\n  size?: number;\n  timing?: number;\n}\n\nexport interface PageState {\n  url: string;\n  title: string;\n  visibleText: string;\n  links: { text: string; href: string }[];\n  forms: { action: string; inputs: string[] }[];\n  images: { src: string; alt: string }[];\n  metaTags: Record<string, string>;\n  jsonLd: any[];\n}\n\nexport interface SessionEvent {\n  type: \"started\" | \"action\" | \"observation\" | \"error\" | \"completed\" | \"cancelled\";\n  sessionId: string;\n  timestamp: Date;\n  data: any;\n}\n\nexport type SessionEventCallback = (event: SessionEvent) => void;\n\nexport interface ComputerSession {\n  id: string;\n  status: \"active\" | \"paused\" | \"completed\" | \"error\" | \"cancelled\";\n  startedAt: Date;\n  objective: string;\n  actions: BrowserAction[];\n  observations: Observation[];\n  currentUrl?: string;\n  currentTitle?: string;\n  lastScreenshot?: string;\n}\n\nexport const DEFAULT_SESSION_CONFIG: SessionConfig = {\n  viewport: { width: 1280, height: 720 },\n  timeout: 30000,\n  allowedDomains: [],\n  maxDownloadSize: 100 * 1024 * 1024,\n  enableNetworkCapture: true\n};\n","path":null,"size_bytes":1890,"size_tokens":null},"server/agent/pipeline/registry.ts":{"content":"import { ToolDefinition, ToolCategory, ValidationResult } from \"./types\";\n\nclass ToolRegistry {\n  private tools: Map<string, ToolDefinition> = new Map();\n  private categoryIndex: Map<ToolCategory, Set<string>> = new Map();\n  private capabilityIndex: Map<string, Set<string>> = new Map();\n\n  register(tool: ToolDefinition): void {\n    if (this.tools.has(tool.id)) {\n      console.warn(`Tool ${tool.id} already registered, overwriting...`);\n    }\n    \n    this.tools.set(tool.id, tool);\n    \n    if (!this.categoryIndex.has(tool.category)) {\n      this.categoryIndex.set(tool.category, new Set());\n    }\n    this.categoryIndex.get(tool.category)!.add(tool.id);\n    \n    for (const capability of tool.capabilities) {\n      if (!this.capabilityIndex.has(capability)) {\n        this.capabilityIndex.set(capability, new Set());\n      }\n      this.capabilityIndex.get(capability)!.add(tool.id);\n    }\n  }\n\n  unregister(toolId: string): boolean {\n    const tool = this.tools.get(toolId);\n    if (!tool) return false;\n    \n    this.tools.delete(toolId);\n    this.categoryIndex.get(tool.category)?.delete(toolId);\n    for (const capability of tool.capabilities) {\n      this.capabilityIndex.get(capability)?.delete(toolId);\n    }\n    \n    return true;\n  }\n\n  get(toolId: string): ToolDefinition | undefined {\n    return this.tools.get(toolId);\n  }\n\n  getByCategory(category: ToolCategory): ToolDefinition[] {\n    const toolIds = this.categoryIndex.get(category) || new Set();\n    return Array.from(toolIds).map(id => this.tools.get(id)!).filter(Boolean);\n  }\n\n  getByCapability(capability: string): ToolDefinition[] {\n    const toolIds = this.capabilityIndex.get(capability) || new Set();\n    return Array.from(toolIds).map(id => this.tools.get(id)!).filter(Boolean);\n  }\n\n  findBestMatch(requirements: string[]): ToolDefinition | undefined {\n    let bestMatch: ToolDefinition | undefined;\n    let bestScore = 0;\n\n    for (const tool of Array.from(this.tools.values())) {\n      const score = requirements.filter(req => \n        tool.capabilities.includes(req) || \n        tool.description.toLowerCase().includes(req.toLowerCase())\n      ).length;\n      \n      if (score > bestScore) {\n        bestScore = score;\n        bestMatch = tool;\n      }\n    }\n\n    return bestMatch;\n  }\n\n  getAll(): ToolDefinition[] {\n    return Array.from(this.tools.values());\n  }\n\n  getToolManifest(): { id: string; name: string; description: string; category: ToolCategory; capabilities: string[] }[] {\n    return this.getAll().map(tool => ({\n      id: tool.id,\n      name: tool.name,\n      description: tool.description,\n      category: tool.category,\n      capabilities: tool.capabilities\n    }));\n  }\n\n  validateToolParams(toolId: string, params: Record<string, any>): ValidationResult {\n    const tool = this.tools.get(toolId);\n    if (!tool) {\n      return { valid: false, errors: [`Tool ${toolId} not found`] };\n    }\n\n    if (tool.validate) {\n      return tool.validate(params);\n    }\n\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    for (const [paramName, schema] of Object.entries(tool.inputSchema)) {\n      const value = params[paramName];\n      \n      if (schema.required && (value === undefined || value === null)) {\n        errors.push(`Required parameter '${paramName}' is missing`);\n        continue;\n      }\n\n      if (value !== undefined && value !== null) {\n        const expectedType = schema.type;\n        const actualType = Array.isArray(value) ? \"array\" : typeof value;\n        \n        if (expectedType !== actualType) {\n          errors.push(`Parameter '${paramName}' expected ${expectedType}, got ${actualType}`);\n        }\n\n        if (schema.enum && !schema.enum.includes(value)) {\n          errors.push(`Parameter '${paramName}' must be one of: ${schema.enum.join(\", \")}`);\n        }\n      }\n    }\n\n    return { valid: errors.length === 0, errors, warnings };\n  }\n}\n\nexport const toolRegistry = new ToolRegistry();\n","path":null,"size_bytes":3938,"size_tokens":null},"server/agent/index.ts":{"content":"export { routeMessage, extractUrls, type RouteResult, type RouteDecision } from \"./router\";\nexport { browserWorker, type BrowserSession, type NavigationResult } from \"./browser-worker\";\nexport { extractWithReadability, summarizeForLLM, type ExtractedContent } from \"./extractor\";\nexport { agentOrchestrator, type AgentTask, type StepUpdate, type StepCallback } from \"./orchestrator\";\nexport { checkDomainPolicy, checkRateLimit, sanitizeUrl, isValidObjective, type SecurityCheck } from \"./security\";\nexport { guardrails, type PIIMatch, type AuditLogEntry, type DownloadPolicy, type GuardrailsConfig } from \"./guardrails\";\nexport { runPipeline, cancelPipeline, initializePipeline, getAvailableTools, multiIntentManager, multiIntentPipeline } from \"./pipeline\";\nexport type { PipelineResult, PipelineRunOptions, ProgressUpdate, ExecutionPlan, PlanStep } from \"./pipeline\";\n","path":null,"size_bytes":870,"size_tokens":null},"server/agent/pipeline/tools/analyze-data.ts":{"content":"import { ToolDefinition, ExecutionContext, ToolResult } from \"../types\";\nimport OpenAI from \"openai\";\n\nconst openai = new OpenAI({ \n  baseURL: \"https://api.x.ai/v1\", \n  apiKey: process.env.XAI_API_KEY \n});\n\nexport const analyzeDataTool: ToolDefinition = {\n  id: \"analyze_data\",\n  name: \"Analyze Data\",\n  description: \"Analyze data to extract insights, patterns, statistics, or specific information\",\n  category: \"analysis\",\n  capabilities: [\"analyze\", \"insights\", \"statistics\", \"patterns\", \"summarize\", \"compare\"],\n  inputSchema: {\n    data: { type: \"object\", description: \"The data to analyze\", required: true },\n    analysisType: { \n      type: \"string\", \n      description: \"Type of analysis to perform\",\n      enum: [\"summary\", \"statistics\", \"patterns\", \"comparison\", \"extraction\", \"custom\"],\n      default: \"summary\"\n    },\n    question: { type: \"string\", description: \"Specific question to answer about the data\" },\n    outputFormat: {\n      type: \"string\",\n      description: \"Format for the analysis output\",\n      enum: [\"text\", \"json\", \"markdown\"],\n      default: \"json\"\n    }\n  },\n  outputSchema: {\n    analysis: { type: \"object\", description: \"The analysis results\" },\n    insights: { type: \"array\", description: \"Key insights extracted\" },\n    summary: { type: \"string\", description: \"Text summary of the analysis\" }\n  },\n  \n  async execute(context: ExecutionContext, params: Record<string, any>): Promise<ToolResult> {\n    const { data, analysisType = \"summary\", question, outputFormat = \"json\" } = params;\n    \n    if (!data) {\n      return {\n        success: false,\n        error: \"No data provided for analysis\"\n      };\n    }\n\n    try {\n      const dataStr = typeof data === \"string\" ? data : JSON.stringify(data, null, 2);\n      \n      const analysisInstructions: Record<string, string> = {\n        summary: \"Provide a comprehensive summary of the data, highlighting key points and structure.\",\n        statistics: \"Calculate and present relevant statistics (counts, averages, distributions, etc.).\",\n        patterns: \"Identify patterns, trends, and anomalies in the data.\",\n        comparison: \"Compare different elements or groups within the data.\",\n        extraction: \"Extract specific information and organize it clearly.\",\n        custom: question || \"Analyze the data and provide relevant insights.\"\n      };\n\n      const instruction = analysisInstructions[analysisType];\n\n      const systemPrompt = `You are a data analyst. Analyze the provided data and respond in ${outputFormat} format.\n\n${outputFormat === \"json\" ? `Respond with valid JSON containing:\n{\n  \"summary\": \"brief text summary\",\n  \"insights\": [\"insight1\", \"insight2\", ...],\n  \"details\": { ... relevant structured data ... }\n}` : outputFormat === \"markdown\" ? \"Respond with well-formatted markdown with headers, lists, and emphasis.\" : \"Respond with clear, structured text.\"}`;\n\n      const response = await openai.chat.completions.create({\n        model: \"grok-3-fast\",\n        messages: [\n          {\n            role: \"system\",\n            content: systemPrompt\n          },\n          {\n            role: \"user\",\n            content: `Data to analyze:\n${dataStr.slice(0, 50000)}\n\nAnalysis task: ${instruction}\n${question ? `\\nSpecific question: ${question}` : \"\"}`\n          }\n        ],\n        response_format: outputFormat === \"json\" ? { type: \"json_object\" } : undefined\n      });\n\n      const result = response.choices[0]?.message?.content || \"\";\n\n      let parsedResult: any;\n      let insights: string[] = [];\n      let summary = \"\";\n\n      if (outputFormat === \"json\") {\n        try {\n          parsedResult = JSON.parse(result);\n          insights = parsedResult.insights || [];\n          summary = parsedResult.summary || \"\";\n        } catch {\n          parsedResult = { raw: result };\n          summary = result;\n        }\n      } else {\n        parsedResult = { content: result };\n        summary = result;\n        \n        const bulletPoints = result.match(/[-•*]\\s+(.+)/g) || [];\n        insights = bulletPoints.map(b => b.replace(/^[-•*]\\s+/, \"\").trim()).slice(0, 10);\n      }\n\n      return {\n        success: true,\n        data: {\n          analysis: parsedResult,\n          insights,\n          summary,\n          analysisType,\n          format: outputFormat\n        },\n        metadata: {\n          analysisType,\n          inputSize: dataStr.length,\n          insightsCount: insights.length\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n};\n","path":null,"size_bytes":4541,"size_tokens":null},"server/agent/pipeline/tools/extract-content.ts":{"content":"import { ToolDefinition, ExecutionContext, ToolResult, Artifact } from \"../types\";\nimport { extractWithReadability, summarizeForLLM } from \"../../extractor\";\nimport crypto from \"crypto\";\n\nexport const extractContentTool: ToolDefinition = {\n  id: \"extract_content\",\n  name: \"Extract Content\",\n  description: \"Extract and process content from HTML, extracting main text, links, images, and metadata\",\n  category: \"data\",\n  capabilities: [\"extract\", \"parse\", \"scrape\", \"content\", \"text\", \"readability\"],\n  inputSchema: {\n    html: { type: \"string\", description: \"The HTML content to extract from\", required: true },\n    url: { type: \"string\", description: \"The source URL for context\" },\n    extractLinks: { type: \"boolean\", description: \"Whether to extract links\", default: true },\n    extractImages: { type: \"boolean\", description: \"Whether to extract images\", default: true },\n    summarize: { type: \"boolean\", description: \"Whether to create a summary\", default: false },\n    maxLength: { type: \"number\", description: \"Maximum content length\", default: 50000 }\n  },\n  outputSchema: {\n    title: { type: \"string\", description: \"The page title\" },\n    textContent: { type: \"string\", description: \"The extracted text content\" },\n    links: { type: \"array\", description: \"Extracted links\" },\n    images: { type: \"array\", description: \"Extracted images\" },\n    summary: { type: \"string\", description: \"Content summary if requested\" }\n  },\n  \n  async execute(context: ExecutionContext, params: Record<string, any>): Promise<ToolResult> {\n    const { \n      html, \n      url = \"https://example.com\", \n      extractLinks: shouldExtractLinks = true,\n      extractImages: shouldExtractImages = true,\n      summarize = false,\n      maxLength = 50000\n    } = params;\n    \n    if (!html) {\n      return {\n        success: false,\n        error: \"No HTML content provided\"\n      };\n    }\n\n    try {\n      const extracted = extractWithReadability(html, url);\n      \n      if (!extracted) {\n        return {\n          success: false,\n          error: \"Could not extract readable content from HTML\"\n        };\n      }\n\n      const artifacts: Artifact[] = [];\n      \n      const textContent = extracted.textContent.slice(0, maxLength);\n      \n      artifacts.push({\n        id: crypto.randomUUID(),\n        type: \"text\",\n        name: `extracted_${extracted.title?.slice(0, 30) || \"content\"}.txt`,\n        content: textContent,\n        metadata: {\n          title: extracted.title,\n          byline: extracted.byline,\n          siteName: extracted.siteName,\n          length: extracted.length\n        }\n      });\n\n      const result: any = {\n        title: extracted.title,\n        byline: extracted.byline,\n        siteName: extracted.siteName,\n        textContent,\n        excerpt: extracted.excerpt,\n        length: extracted.length\n      };\n\n      if (shouldExtractLinks) {\n        result.links = extracted.links.slice(0, 100);\n      }\n\n      if (shouldExtractImages) {\n        result.images = extracted.images.slice(0, 50);\n      }\n\n      if (summarize) {\n        result.summary = summarizeForLLM(extracted, 2000);\n      }\n\n      return {\n        success: true,\n        data: result,\n        artifacts,\n        metadata: {\n          title: extracted.title,\n          originalLength: extracted.length,\n          extractedLength: textContent.length\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n};\n","path":null,"size_bytes":3470,"size_tokens":null},"server/parsers/pptxParser.ts":{"content":"import JSZip from \"jszip\";\nimport type { FileParser, ParsedResult, DetectedFileType } from \"./base\";\n\ninterface SlideContent {\n  slideNumber: number;\n  title: string;\n  content: string[];\n  notes: string;\n  hasTable: boolean;\n}\n\nexport class PptxParser implements FileParser {\n  name = \"pptx\";\n  supportedMimeTypes = [\n    \"application/vnd.openxmlformats-officedocument.presentationml.presentation\",\n    \"application/vnd.ms-powerpoint\",\n  ];\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    const startTime = Date.now();\n\n    try {\n      const zip = await JSZip.loadAsync(content);\n      \n      const [slides, metadata] = await Promise.all([\n        this.extractSlides(zip),\n        this.extractMetadata(zip),\n      ]);\n\n      const formattedText = this.formatOutput(metadata, slides);\n\n      return {\n        text: formattedText,\n        metadata: {\n          ...metadata,\n          slideCount: slides.length,\n        },\n      };\n    } catch (error) {\n      const elapsed = Date.now() - startTime;\n      console.error(`[PptxParser] Failed after ${elapsed}ms:`, error);\n      \n      if (error instanceof Error) {\n        throw new Error(`Failed to parse PowerPoint: ${error.message}`);\n      }\n      throw new Error(\"Failed to parse PowerPoint: Unknown error\");\n    }\n  }\n\n  private async extractMetadata(zip: JSZip): Promise<Record<string, any>> {\n    const metadata: Record<string, any> = {};\n\n    try {\n      const coreXml = await zip.file(\"docProps/core.xml\")?.async(\"string\");\n      \n      if (coreXml) {\n        const titleMatch = coreXml.match(/<dc:title>([^<]*)<\\/dc:title>/);\n        if (titleMatch) metadata.title = titleMatch[1];\n        \n        const creatorMatch = coreXml.match(/<dc:creator>([^<]*)<\\/dc:creator>/);\n        if (creatorMatch) metadata.author = creatorMatch[1];\n        \n        const createdMatch = coreXml.match(/<dcterms:created[^>]*>([^<]*)<\\/dcterms:created>/);\n        if (createdMatch) metadata.creationDate = this.formatDate(createdMatch[1]);\n      }\n\n      const appXml = await zip.file(\"docProps/app.xml\")?.async(\"string\");\n      if (appXml) {\n        const slidesMatch = appXml.match(/<Slides>(\\d+)<\\/Slides>/);\n        if (slidesMatch) metadata.totalSlides = parseInt(slidesMatch[1], 10);\n        \n        const companyMatch = appXml.match(/<Company>([^<]*)<\\/Company>/);\n        if (companyMatch) metadata.company = companyMatch[1];\n      }\n    } catch (error) {\n      console.warn(\"[PptxParser] Could not extract metadata:\", error);\n    }\n\n    return metadata;\n  }\n\n  private formatDate(isoDate: string): string {\n    try {\n      const date = new Date(isoDate);\n      return date.toISOString().split('T')[0];\n    } catch {\n      return isoDate;\n    }\n  }\n\n  private async extractSlides(zip: JSZip): Promise<SlideContent[]> {\n    const slides: SlideContent[] = [];\n    const slideFiles: { name: string; num: number }[] = [];\n\n    zip.forEach((path, file) => {\n      const match = path.match(/ppt\\/slides\\/slide(\\d+)\\.xml$/);\n      if (match) {\n        slideFiles.push({ name: path, num: parseInt(match[1], 10) });\n      }\n    });\n\n    slideFiles.sort((a, b) => a.num - b.num);\n\n    for (const slideFile of slideFiles) {\n      try {\n        const slideXml = await zip.file(slideFile.name)?.async(\"string\");\n        if (slideXml) {\n          const slideContent = this.parseSlideXml(slideXml, slideFile.num);\n          \n          const notesPath = `ppt/notesSlides/notesSlide${slideFile.num}.xml`;\n          const notesXml = await zip.file(notesPath)?.async(\"string\");\n          if (notesXml) {\n            slideContent.notes = this.extractNotesFromXml(notesXml);\n          }\n          \n          slides.push(slideContent);\n        }\n      } catch (error) {\n        console.warn(`[PptxParser] Failed to parse slide ${slideFile.num}:`, error);\n      }\n    }\n\n    return slides;\n  }\n\n  private parseSlideXml(xml: string, slideNumber: number): SlideContent {\n    const content: SlideContent = {\n      slideNumber,\n      title: '',\n      content: [],\n      notes: '',\n      hasTable: false,\n    };\n\n    const titleMatch = xml.match(/<p:ph[^>]*type=\"title\"[^>]*>[\\s\\S]*?<a:t>([^<]+)<\\/a:t>/i) ||\n                       xml.match(/<p:ph[^>]*type=\"ctrTitle\"[^>]*>[\\s\\S]*?<a:t>([^<]+)<\\/a:t>/i);\n    \n    if (!titleMatch) {\n      const firstTextMatch = xml.match(/<p:sp>[\\s\\S]*?<a:t>([^<]+)<\\/a:t>/);\n      if (firstTextMatch && firstTextMatch[1].length < 100) {\n        content.title = this.cleanText(firstTextMatch[1]);\n      }\n    } else {\n      content.title = this.cleanText(titleMatch[1]);\n    }\n\n    const textParagraphs = this.extractTextParagraphs(xml);\n    content.content = textParagraphs;\n\n    if (xml.includes('<a:tbl>') || xml.includes('<a:graphicData')) {\n      content.hasTable = true;\n      const tableContent = this.extractTables(xml);\n      if (tableContent) {\n        content.content.push(tableContent);\n      }\n    }\n\n    return content;\n  }\n\n  private extractTextParagraphs(xml: string): string[] {\n    const paragraphs: string[] = [];\n    const processedTexts = new Set<string>();\n    \n    const paragraphMatches = Array.from(xml.matchAll(/<a:p>([\\s\\S]*?)<\\/a:p>/g));\n    \n    for (const match of paragraphMatches) {\n      const paraXml = match[1];\n      \n      const pPrMatch = paraXml.match(/<a:pPr[^>]*>/);\n      let bulletPrefix = '';\n      let indent = 0;\n      \n      if (pPrMatch) {\n        const lvlMatch = pPrMatch[0].match(/lvl=\"(\\d+)\"/);\n        if (lvlMatch) {\n          indent = parseInt(lvlMatch[1], 10);\n        }\n        \n        if (paraXml.includes('<a:buChar') || paraXml.includes('<a:buAutoNum')) {\n          bulletPrefix = '  '.repeat(indent) + '- ';\n        } else if (paraXml.includes('<a:buNone')) {\n          bulletPrefix = '  '.repeat(indent);\n        } else if (indent > 0) {\n          bulletPrefix = '  '.repeat(indent) + '- ';\n        }\n      }\n      \n      const textParts: string[] = [];\n      const textMatches = Array.from(paraXml.matchAll(/<a:t>([^<]*)<\\/a:t>/g));\n      \n      for (const textMatch of textMatches) {\n        textParts.push(textMatch[1]);\n      }\n      \n      const fullText = textParts.join('').trim();\n      \n      if (fullText && !processedTexts.has(fullText)) {\n        processedTexts.add(fullText);\n        paragraphs.push(bulletPrefix + this.cleanText(fullText));\n      }\n    }\n\n    return paragraphs.filter(p => p.trim().length > 0);\n  }\n\n  private extractTables(xml: string): string {\n    const tables: string[] = [];\n    const tableMatches = Array.from(xml.matchAll(/<a:tbl>([\\s\\S]*?)<\\/a:tbl>/g));\n\n    for (const tableMatch of tableMatches) {\n      const tableXml = tableMatch[1];\n      const rows: string[][] = [];\n      \n      const rowMatches = Array.from(tableXml.matchAll(/<a:tr[^>]*>([\\s\\S]*?)<\\/a:tr>/g));\n      \n      for (const rowMatch of rowMatches) {\n        const rowXml = rowMatch[1];\n        const cells: string[] = [];\n        \n        const cellMatches = Array.from(rowXml.matchAll(/<a:tc[^>]*>([\\s\\S]*?)<\\/a:tc>/g));\n        \n        for (const cellMatch of cellMatches) {\n          const cellTexts: string[] = [];\n          const textMatches = Array.from(cellMatch[1].matchAll(/<a:t>([^<]*)<\\/a:t>/g));\n          \n          for (const textMatch of textMatches) {\n            cellTexts.push(textMatch[1]);\n          }\n          \n          cells.push(this.cleanText(cellTexts.join(' ')));\n        }\n        \n        if (cells.length > 0) {\n          rows.push(cells);\n        }\n      }\n\n      if (rows.length > 0) {\n        tables.push(this.formatTableAsMarkdown(rows));\n      }\n    }\n\n    return tables.join('\\n\\n');\n  }\n\n  private formatTableAsMarkdown(rows: string[][]): string {\n    if (rows.length === 0) return '';\n\n    const maxCols = Math.max(...rows.map(r => r.length));\n    const normalizedRows = rows.map(row => {\n      while (row.length < maxCols) row.push('');\n      return row;\n    });\n\n    const lines: string[] = [];\n    lines.push('| ' + normalizedRows[0].join(' | ') + ' |');\n    lines.push('| ' + normalizedRows[0].map(() => '---').join(' | ') + ' |');\n    \n    for (let i = 1; i < normalizedRows.length; i++) {\n      lines.push('| ' + normalizedRows[i].join(' | ') + ' |');\n    }\n\n    return lines.join('\\n');\n  }\n\n  private extractNotesFromXml(xml: string): string {\n    const notes: string[] = [];\n    const textMatches = Array.from(xml.matchAll(/<a:t>([^<]*)<\\/a:t>/g));\n    \n    for (const match of textMatches) {\n      const text = this.cleanText(match[1]);\n      if (text && !text.match(/^\\d+$/) && text.length > 2) {\n        notes.push(text);\n      }\n    }\n\n    const uniqueNotes = Array.from(new Set(notes));\n    return uniqueNotes.join(' ').trim();\n  }\n\n  private cleanText(text: string): string {\n    return text\n      .replace(/\\u0000/g, '')\n      .replace(/[\\u2018\\u2019]/g, \"'\")\n      .replace(/[\\u201C\\u201D]/g, '\"')\n      .replace(/\\u2013/g, '-')\n      .replace(/\\u2014/g, '--')\n      .replace(/\\u2026/g, '...')\n      .replace(/\\u00A0/g, ' ')\n      .replace(/\\s+/g, ' ')\n      .trim();\n  }\n\n  private formatOutput(metadata: Record<string, any>, slides: SlideContent[]): string {\n    const parts: string[] = [];\n    \n    parts.push('=== Presentation Info ===');\n    if (metadata.title) parts.push(`Title: ${metadata.title}`);\n    if (metadata.author) parts.push(`Author: ${metadata.author}`);\n    if (metadata.company) parts.push(`Company: ${metadata.company}`);\n    if (metadata.creationDate) parts.push(`Created: ${metadata.creationDate}`);\n    parts.push(`Slides: ${slides.length}`);\n    parts.push('');\n\n    for (const slide of slides) {\n      const titlePart = slide.title ? `: ${slide.title}` : '';\n      parts.push(`=== Slide ${slide.slideNumber}${titlePart} ===`);\n      \n      if (slide.content.length > 0) {\n        parts.push(slide.content.join('\\n'));\n      }\n      \n      if (slide.notes) {\n        parts.push('');\n        parts.push(`[Speaker Notes: ${slide.notes}]`);\n      }\n      \n      parts.push('');\n    }\n\n    return parts.join('\\n').trim();\n  }\n}\n","path":null,"size_bytes":9972,"size_tokens":null},"server/parsers/imageParser.ts":{"content":"import Tesseract from \"tesseract.js\";\nimport OpenAI from \"openai\";\nimport type { FileParser, ParsedResult, DetectedFileType } from \"./base\";\n\nconst openai = new OpenAI({ \n  baseURL: \"https://api.x.ai/v1\", \n  apiKey: process.env.XAI_API_KEY \n});\n\nexport class ImageParser implements FileParser {\n  name = \"image\";\n  supportedMimeTypes = [\n    \"image/png\",\n    \"image/jpeg\",\n    \"image/jpg\",\n    \"image/gif\",\n    \"image/bmp\",\n    \"image/webp\",\n    \"image/tiff\",\n  ];\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    // Try AI Vision first for better accuracy\n    try {\n      const base64Image = content.toString(\"base64\");\n      const mimeType = type.mimeType || \"image/png\";\n      \n      const response = await openai.chat.completions.create({\n        model: \"grok-2-vision-1212\",\n        messages: [\n          {\n            role: \"user\",\n            content: [\n              {\n                type: \"image_url\",\n                image_url: {\n                  url: `data:${mimeType};base64,${base64Image}`,\n                },\n              },\n              {\n                type: \"text\",\n                text: \"Extrae TODO el texto visible en esta imagen. Si hay tablas, mantenlas formateadas. Si hay fórmulas matemáticas, escríbelas en formato LaTeX. Devuelve SOLO el texto extraído, sin comentarios adicionales.\",\n              },\n            ],\n          },\n        ],\n        max_tokens: 4096,\n      });\n\n      const text = response.choices[0]?.message?.content?.trim() || \"\";\n      \n      if (text && text.length > 0) {\n        return {\n          text,\n          metadata: {\n            method: \"ai-vision\",\n            model: \"grok-2-vision-1212\",\n          },\n        };\n      }\n    } catch (error) {\n      console.error(\"AI Vision OCR failed, falling back to Tesseract:\", error);\n    }\n\n    // Fallback to Tesseract\n    try {\n      const result = await Tesseract.recognize(content, \"spa+eng\", {\n        logger: () => {},\n      });\n      \n      const text = result.data.text.trim();\n      \n      if (!text || text.length === 0) {\n        return {\n          text: \"\",\n          warnings: [\"No se detectó texto en la imagen\"],\n        };\n      }\n\n      return {\n        text,\n        metadata: {\n          method: \"tesseract\",\n          confidence: result.data.confidence,\n        },\n      };\n    } catch (error) {\n      console.error(\"Error parsing image with OCR:\", error);\n      throw new Error(\"Failed to extract text from image\");\n    }\n  }\n}\n","path":null,"size_bytes":2494,"size_tokens":null},"client/src/hooks/use-agent.ts":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\n\nexport interface AgentStep {\n  runId: string;\n  stepId: string;\n  stepType: string;\n  url?: string;\n  status: \"started\" | \"completed\" | \"failed\";\n  detail?: any;\n  screenshot?: string;\n  error?: string;\n}\n\nexport interface AgentState {\n  runId: string | null;\n  status: \"idle\" | \"running\" | \"completed\" | \"failed\" | \"cancelled\";\n  steps: AgentStep[];\n  objective?: string;\n  browserSessionId?: string;\n}\n\nexport function useAgent() {\n  const [state, setState] = useState<AgentState>({\n    runId: null,\n    status: \"idle\",\n    steps: []\n  });\n  \n  const wsRef = useRef<WebSocket | null>(null);\n\n  const subscribe = useCallback((runId: string, objective?: string) => {\n    if (wsRef.current) {\n      wsRef.current.close();\n    }\n\n    setState({\n      runId,\n      status: \"running\",\n      steps: [],\n      objective\n    });\n\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const ws = new WebSocket(`${protocol}//${window.location.host}/ws/agent`);\n    wsRef.current = ws;\n\n    ws.onopen = () => {\n      ws.send(JSON.stringify({ type: \"subscribe\", runId }));\n    };\n\n    ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        if (data.type === \"step_update\") {\n          const step: AgentStep = {\n            runId: data.runId,\n            stepId: data.stepId,\n            stepType: data.stepType,\n            url: data.url,\n            status: data.status,\n            detail: data.detail,\n            screenshot: data.screenshot,\n            error: data.error\n          };\n\n          setState((prev) => {\n            const existingIndex = prev.steps.findIndex(s => s.stepId === step.stepId);\n            const newState = { ...prev };\n            \n            if (step.detail?.browserSessionId && !prev.browserSessionId) {\n              newState.browserSessionId = step.detail.browserSessionId;\n            }\n            \n            if (existingIndex >= 0) {\n              const newSteps = [...prev.steps];\n              newSteps[existingIndex] = step;\n              newState.steps = newSteps;\n            } else {\n              newState.steps = [...prev.steps, step];\n            }\n            return newState;\n          });\n        }\n      } catch (e) {\n        console.error(\"Error parsing agent update:\", e);\n      }\n    };\n\n    ws.onerror = (error) => {\n      console.error(\"Agent WebSocket error:\", error);\n    };\n\n    ws.onclose = () => {\n      wsRef.current = null;\n    };\n  }, []);\n\n  const complete = useCallback(() => {\n    setState((prev) => ({ ...prev, status: \"completed\" }));\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n  }, []);\n\n  const reset = useCallback(() => {\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n    setState({\n      runId: null,\n      status: \"idle\",\n      steps: []\n    });\n  }, []);\n\n  const cancel = useCallback(async () => {\n    if (state.runId) {\n      try {\n        await fetch(`/api/agent/runs/${state.runId}/cancel`, { method: \"POST\" });\n        setState((prev) => ({ ...prev, status: \"cancelled\" }));\n      } catch (e) {\n        console.error(\"Error cancelling agent run:\", e);\n      }\n    }\n  }, [state.runId]);\n\n  useEffect(() => {\n    return () => {\n      if (wsRef.current) {\n        wsRef.current.close();\n      }\n    };\n  }, []);\n\n  return {\n    state,\n    subscribe,\n    complete,\n    reset,\n    cancel\n  };\n}\n","path":null,"size_bytes":3482,"size_tokens":null},"server/agent/pipeline/tools/generate-file.ts":{"content":"import { ToolDefinition, ExecutionContext, ToolResult, Artifact } from \"../types\";\nimport { ObjectStorageService } from \"../../../objectStorage\";\nimport crypto from \"crypto\";\n\nconst objectStorage = new ObjectStorageService();\n\nexport const generateFileTool: ToolDefinition = {\n  id: \"generate_file\",\n  name: \"Generate File\",\n  description: \"Generate a file with specified content and format (text, markdown, JSON, CSV, HTML)\",\n  category: \"file\",\n  capabilities: [\"generate\", \"create\", \"file\", \"document\", \"export\", \"save\"],\n  inputSchema: {\n    content: { type: \"string\", description: \"The content to write to the file\", required: true },\n    filename: { type: \"string\", description: \"The filename to use\", required: true },\n    format: { \n      type: \"string\", \n      description: \"The file format\",\n      enum: [\"text\", \"markdown\", \"json\", \"csv\", \"html\"],\n      default: \"text\"\n    },\n    upload: { type: \"boolean\", description: \"Whether to upload to storage\", default: true }\n  },\n  outputSchema: {\n    filename: { type: \"string\", description: \"The generated filename\" },\n    storagePath: { type: \"string\", description: \"The storage path if uploaded\" },\n    size: { type: \"number\", description: \"The file size in bytes\" }\n  },\n  \n  async execute(context: ExecutionContext, params: Record<string, any>): Promise<ToolResult> {\n    const { content, filename, format = \"text\", upload = true } = params;\n    \n    if (!content) {\n      return {\n        success: false,\n        error: \"No content provided\"\n      };\n    }\n\n    try {\n      const mimeTypes: Record<string, string> = {\n        text: \"text/plain\",\n        markdown: \"text/markdown\",\n        json: \"application/json\",\n        csv: \"text/csv\",\n        html: \"text/html\"\n      };\n\n      const extensions: Record<string, string> = {\n        text: \".txt\",\n        markdown: \".md\",\n        json: \".json\",\n        csv: \".csv\",\n        html: \".html\"\n      };\n\n      const mimeType = mimeTypes[format] || \"text/plain\";\n      const extension = extensions[format] || \".txt\";\n      const finalFilename = filename.includes(\".\") ? filename : `${filename}${extension}`;\n      \n      let processedContent = content;\n      if (format === \"json\" && typeof content === \"object\") {\n        processedContent = JSON.stringify(content, null, 2);\n      }\n\n      const contentBuffer = Buffer.from(processedContent, \"utf-8\");\n      const size = contentBuffer.length;\n\n      const artifacts: Artifact[] = [];\n      let storagePath: string | undefined;\n\n      if (upload) {\n        try {\n          const { uploadURL, storagePath: path } = await objectStorage.getObjectEntityUploadURLWithPath();\n          await fetch(uploadURL, {\n            method: \"PUT\",\n            headers: { \"Content-Type\": mimeType },\n            body: contentBuffer\n          });\n          storagePath = path;\n        } catch (e) {\n          console.error(\"Failed to upload file:\", e);\n        }\n      }\n\n      artifacts.push({\n        id: crypto.randomUUID(),\n        type: format === \"json\" ? \"json\" : format === \"markdown\" ? \"markdown\" : format === \"html\" ? \"html\" : \"text\",\n        name: finalFilename,\n        content: processedContent.slice(0, 100000),\n        storagePath,\n        mimeType,\n        size,\n        metadata: { format }\n      });\n\n      return {\n        success: true,\n        data: {\n          filename: finalFilename,\n          storagePath,\n          size,\n          mimeType\n        },\n        artifacts,\n        metadata: {\n          filename: finalFilename,\n          format,\n          size\n        }\n      };\n    } catch (error: any) {\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n};\n","path":null,"size_bytes":3659,"size_tokens":null},"server/parsers/xlsxParser.ts":{"content":"import ExcelJS from \"exceljs\";\nimport type { FileParser, ParsedResult, DetectedFileType } from \"./base\";\n\nexport class XlsxParser implements FileParser {\n  name = \"xlsx\";\n  supportedMimeTypes = [\n    \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    \"application/vnd.ms-excel\",\n  ];\n\n  private readonly MAX_ROWS_PREVIEW = 100;\n  private readonly MAX_COLS_PREVIEW = 20;\n\n  async parse(content: Buffer, type: DetectedFileType): Promise<ParsedResult> {\n    try {\n      const workbook = new ExcelJS.Workbook();\n      await workbook.xlsx.load(content);\n      \n      const sheetData: Array<{\n        name: string;\n        rowCount: number;\n        columnCount: number;\n        content: string;\n        truncated: boolean;\n      }> = [];\n\n      const metadata = this.extractWorkbookMetadata(workbook);\n      \n      workbook.eachSheet((worksheet) => {\n        const sheetResult = this.parseSheet(worksheet);\n        sheetData.push(sheetResult);\n      });\n\n      const formattedOutput = this.formatOutput(metadata, sheetData);\n\n      return {\n        text: formattedOutput,\n        metadata: {\n          ...metadata,\n          sheets: sheetData.map(s => ({\n            name: s.name,\n            rowCount: s.rowCount,\n            columnCount: s.columnCount,\n            truncated: s.truncated,\n          })),\n        },\n      };\n    } catch (error) {\n      const elapsed = Date.now() - startTime;\n      console.error(`[XlsxParser] Failed after ${elapsed}ms:`, error);\n      \n      if (error instanceof Error) {\n        throw new Error(`Failed to parse Excel: ${error.message}`);\n      }\n      throw new Error(\"Failed to parse Excel: Unknown error\");\n    }\n  }\n\n  private extractWorkbookMetadata(workbook: ExcelJS.Workbook): Record<string, any> {\n    const metadata: Record<string, any> = {\n      sheetCount: 0,\n    };\n\n    let sheetCount = 0;\n    workbook.eachSheet(() => sheetCount++);\n    metadata.sheetCount = sheetCount;\n\n    if (workbook.creator) metadata.author = workbook.creator;\n    if (workbook.created) metadata.creationDate = workbook.created.toISOString().split('T')[0];\n    if (workbook.modified) metadata.modificationDate = workbook.modified.toISOString().split('T')[0];\n    if (workbook.company) metadata.company = workbook.company;\n\n    return metadata;\n  }\n\n  private parseSheet(worksheet: ExcelJS.Worksheet): {\n    name: string;\n    rowCount: number;\n    columnCount: number;\n    content: string;\n    truncated: boolean;\n  } {\n    const sheetName = worksheet.name;\n    const rows: string[][] = [];\n    let maxCols = 0;\n    let totalRows = 0;\n    let truncated = false;\n\n    worksheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {\n      totalRows = rowNumber;\n      \n      if (rows.length >= this.MAX_ROWS_PREVIEW) {\n        truncated = true;\n        return;\n      }\n\n      const values: string[] = [];\n      let colIndex = 0;\n      \n      row.eachCell({ includeEmpty: true }, (cell, colNumber) => {\n        if (colNumber > this.MAX_COLS_PREVIEW) {\n          truncated = true;\n          return;\n        }\n        \n        while (values.length < colNumber - 1) {\n          values.push('');\n        }\n        \n        const cellValue = this.getCellValue(cell);\n        values.push(cellValue);\n        colIndex = colNumber;\n      });\n      \n      maxCols = Math.max(maxCols, values.length);\n      rows.push(values);\n    });\n\n    const normalizedRows = rows.map(row => {\n      while (row.length < maxCols) row.push('');\n      return row;\n    });\n\n    const markdownTable = this.createMarkdownTable(normalizedRows, sheetName, totalRows, truncated);\n\n    return {\n      name: sheetName,\n      rowCount: totalRows,\n      columnCount: maxCols,\n      content: markdownTable,\n      truncated,\n    };\n  }\n\n  private getCellValue(cell: ExcelJS.Cell): string {\n    if (cell.value === null || cell.value === undefined) {\n      return '';\n    }\n\n    if (typeof cell.value === 'object') {\n      if ('result' in cell.value) {\n        return String(cell.value.result ?? '');\n      }\n      if ('text' in cell.value) {\n        return (cell.value as any).text;\n      }\n      if ('richText' in cell.value) {\n        return (cell.value as any).richText.map((rt: any) => rt.text).join('');\n      }\n      if (cell.value instanceof Date) {\n        return cell.value.toISOString().split('T')[0];\n      }\n      return cell.text ?? String(cell.value);\n    }\n\n    if (typeof cell.value === 'number') {\n      if (Number.isInteger(cell.value)) {\n        return String(cell.value);\n      }\n      return cell.value.toFixed(2);\n    }\n\n    return String(cell.value);\n  }\n\n  private createMarkdownTable(\n    rows: string[][],\n    sheetName: string,\n    totalRows: number,\n    truncated: boolean\n  ): string {\n    if (rows.length === 0) {\n      return `*Empty sheet*`;\n    }\n\n    const parts: string[] = [];\n    \n    const columnWidths = this.calculateColumnWidths(rows);\n    \n    const headerRow = rows[0];\n    parts.push('| ' + headerRow.map((cell, i) => this.padCell(cell, columnWidths[i])).join(' | ') + ' |');\n    parts.push('| ' + columnWidths.map(w => '-'.repeat(Math.max(3, w))).join(' | ') + ' |');\n    \n    for (let i = 1; i < rows.length; i++) {\n      const row = rows[i];\n      parts.push('| ' + row.map((cell, j) => this.padCell(cell, columnWidths[j])).join(' | ') + ' |');\n    }\n\n    if (truncated) {\n      parts.push('');\n      parts.push(`*Note: Sheet has ${totalRows} total rows. Showing first ${Math.min(this.MAX_ROWS_PREVIEW, rows.length)} rows.*`);\n    }\n\n    return parts.join('\\n');\n  }\n\n  private calculateColumnWidths(rows: string[][]): number[] {\n    if (rows.length === 0) return [];\n    \n    const widths: number[] = new Array(rows[0].length).fill(3);\n    \n    for (const row of rows) {\n      for (let i = 0; i < row.length; i++) {\n        const escapedCell = this.escapeMarkdown(row[i]);\n        widths[i] = Math.min(30, Math.max(widths[i], escapedCell.length));\n      }\n    }\n    \n    return widths;\n  }\n\n  private padCell(cell: string, width: number): string {\n    const escaped = this.escapeMarkdown(cell);\n    if (escaped.length >= width) {\n      return escaped.substring(0, width);\n    }\n    return escaped + ' '.repeat(width - escaped.length);\n  }\n\n  private escapeMarkdown(text: string): string {\n    return text\n      .replace(/\\|/g, '\\\\|')\n      .replace(/\\n/g, ' ')\n      .replace(/\\r/g, '')\n      .trim();\n  }\n\n  private formatOutput(\n    metadata: Record<string, any>,\n    sheets: Array<{ name: string; rowCount: number; columnCount: number; content: string; truncated: boolean }>\n  ): string {\n    const parts: string[] = [];\n    \n    parts.push('=== Workbook Info ===');\n    if (metadata.author) parts.push(`Author: ${metadata.author}`);\n    if (metadata.company) parts.push(`Company: ${metadata.company}`);\n    if (metadata.creationDate) parts.push(`Created: ${metadata.creationDate}`);\n    parts.push(`Sheets: ${metadata.sheetCount}`);\n    parts.push('');\n\n    for (const sheet of sheets) {\n      parts.push(`## Sheet: ${sheet.name}`);\n      parts.push(`*${sheet.rowCount} rows × ${sheet.columnCount} columns*`);\n      parts.push('');\n      parts.push(sheet.content);\n      parts.push('');\n    }\n\n    return parts.join('\\n').trim();\n  }\n}\n","path":null,"size_bytes":7186,"size_tokens":null},"server/services/webSearch.ts":{"content":"import { JSDOM } from \"jsdom\";\nimport { Readability } from \"@mozilla/readability\";\nimport { HTTP_HEADERS, TIMEOUTS, LIMITS } from \"../lib/constants\";\n\ninterface SearchResult {\n  title: string;\n  url: string;\n  snippet: string;\n  authors?: string;\n  year?: string;\n  citation?: string;\n}\n\ninterface WebSearchResponse {\n  query: string;\n  results: SearchResult[];\n  contents: { url: string; title: string; content: string }[];\n}\n\nconst ACADEMIC_PATTERNS = [\n  /dame.*cita/i,\n  /cita.*(apa|mla|chicago|harvard|ieee|vancouver)/i,\n  /formato\\s*(apa|mla|chicago|harvard|ieee|vancouver)/i,\n  /apa\\s*7/i,\n  /normas?\\s*apa/i,\n  /estilo\\s*(apa|mla)/i,\n  /referencia.*bibliogr[áa]fica/i,\n  /art[ií]culo.*cient[ií]fico/i,\n  /investigaci[óo]n\\s+(sobre|de|del)/i,\n  /estudio.*cient[ií]fico/i,\n  /publicaci[óo]n\\s+acad[ée]mica/i,\n  /paper\\s+(sobre|de|del)/i,\n  /tesis\\s+(sobre|de|del)/i,\n  /revista.*cient[ií]fica/i,\n  /scholar/i,\n  /academic\\s+(article|paper|research)/i,\n  /scientific\\s+(article|paper|study)/i,\n  /peer[\\s-]?review/i,\n  /bibliography/i,\n  /citation\\s+(in|for|style)/i,\n  /busca.*art[ií]culo.*cient[ií]fico/i,\n  /necesito.*cita/i,\n  /quiero.*cita/i,\n];\n\nconst WEB_SEARCH_PATTERNS = [\n  /qu[eé]\\s+es\\s+/i,\n  /qui[eé]n\\s+es\\s+/i,\n  /cu[aá]ndo\\s+/i,\n  /d[oó]nde\\s+/i,\n  /c[oó]mo\\s+\\w+\\s+(funciona|trabaja|opera|works)/i,\n  /noticias\\s+(sobre|de)/i,\n  /[uú]ltimas?\\s+noticias/i,\n  /precio\\s+(de|del|actual)/i,\n  /busca\\s+(en\\s+)?(internet|web|online)?/i,\n  /buscar\\s+/i,\n  /investiga\\s+/i,\n  /informaci[oó]n\\s+(sobre|de|del|acerca)/i,\n  /actualidad\\s+(de|sobre)/i,\n  /\\bhoy\\b/i,\n  /actual(es|mente)?/i,\n  /202[4-9]|203[0-9]/i,\n  /\\b(clima|tiempo|weather)\\s+(en|de|para|in|for)/i,\n  /resultados?\\s+(de|del)/i,\n  /estad[ií]sticas?\\s+(de|del|sobre)/i,\n  /cotizaci[oó]n|stock|accion(es)?/i,\n  /what\\s+is\\s+/i,\n  /who\\s+is\\s+/i,\n  /when\\s+(did|does|is|was|will)/i,\n  /where\\s+(is|are|can|do)/i,\n  /how\\s+(to|does|do|can|is)/i,\n  /latest\\s+(news|update|info)/i,\n  /current\\s+(price|status|situation)/i,\n  /search\\s+(for|about|the)/i,\n  /find\\s+(out|info|about|me)/i,\n  /look\\s+up\\s+/i,\n  /tell\\s+me\\s+about\\s+/i,\n  /news\\s+(about|on|from)/i,\n  /\\btoday\\b/i,\n  /\\brecent(ly)?\\b/i,\n];\n\nfunction getHeaders() {\n  return {\n    \"User-Agent\": HTTP_HEADERS.USER_AGENT,\n    \"Accept\": HTTP_HEADERS.ACCEPT_HTML,\n    \"Accept-Language\": HTTP_HEADERS.ACCEPT_LANGUAGE\n  };\n}\n\nasync function fetchPageContent(url: string): Promise<{ title: string; text: string } | null> {\n  try {\n    const controller = new AbortController();\n    const timeout = setTimeout(() => controller.abort(), TIMEOUTS.PAGE_FETCH);\n    \n    const response = await fetch(url, {\n      signal: controller.signal,\n      headers: getHeaders()\n    });\n    \n    clearTimeout(timeout);\n    \n    if (!response.ok) return null;\n    \n    const contentType = response.headers.get(\"content-type\") || \"\";\n    if (!contentType.includes(\"text/html\")) return null;\n    \n    const html = await response.text();\n    const dom = new JSDOM(html, { url });\n    \n    const reader = new Readability(dom.window.document);\n    const article = reader.parse();\n    \n    if (article?.textContent) {\n      return {\n        title: article.title || \"\",\n        text: article.textContent.replace(/\\s+/g, \" \").trim()\n      };\n    }\n    \n    return null;\n  } catch {\n    return null;\n  }\n}\n\nexport async function searchWeb(query: string, maxResults = LIMITS.MAX_SEARCH_RESULTS): Promise<WebSearchResponse> {\n  const results: SearchResult[] = [];\n  \n  try {\n    const searchUrl = `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`;\n    const response = await fetch(searchUrl, { headers: getHeaders() });\n    \n    if (!response.ok) {\n      throw new Error(`Search failed: ${response.status}`);\n    }\n    \n    const html = await response.text();\n    const dom = new JSDOM(html);\n    const doc = dom.window.document;\n    \n    for (const result of Array.from(doc.querySelectorAll(\".result\")).slice(0, maxResults)) {\n      const titleEl = result.querySelector(\".result__title a\");\n      const snippetEl = result.querySelector(\".result__snippet\");\n      \n      if (titleEl) {\n        const href = titleEl.getAttribute(\"href\") || \"\";\n        let url = href;\n        \n        if (href.includes(\"uddg=\")) {\n          const match = href.match(/uddg=([^&]+)/);\n          if (match) url = decodeURIComponent(match[1]);\n        }\n        \n        if (url && !url.includes(\"duckduckgo.com\")) {\n          results.push({\n            title: titleEl.textContent?.trim() || \"\",\n            url,\n            snippet: snippetEl?.textContent?.trim() || \"\"\n          });\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"Search error:\", error);\n  }\n  \n  const contents: { url: string; title: string; content: string }[] = [];\n  \n  const fetchPromises = results.slice(0, LIMITS.MAX_CONTENT_FETCH).map(async (result) => {\n    const content = await fetchPageContent(result.url);\n    if (content) {\n      return {\n        url: result.url,\n        title: content.title || result.title,\n        content: content.text.slice(0, TIMEOUTS.MAX_CONTENT_LENGTH)\n      };\n    }\n    return null;\n  });\n  \n  const fetchedContents = await Promise.all(fetchPromises);\n  contents.push(...fetchedContents.filter((c): c is NonNullable<typeof c> => c !== null));\n  \n  return { query, results, contents };\n}\n\nexport async function searchScholar(query: string, maxResults = LIMITS.MAX_SEARCH_RESULTS): Promise<SearchResult[]> {\n  const results: SearchResult[] = [];\n  \n  try {\n    const searchUrl = `https://scholar.google.com/scholar?q=${encodeURIComponent(query)}&hl=es`;\n    const response = await fetch(searchUrl, { headers: getHeaders() });\n    \n    if (!response.ok) {\n      console.error(\"Scholar search failed:\", response.status);\n      return results;\n    }\n    \n    const html = await response.text();\n    const dom = new JSDOM(html);\n    const doc = dom.window.document;\n    \n    for (const article of Array.from(doc.querySelectorAll(\".gs_ri\")).slice(0, maxResults)) {\n      const titleEl = article.querySelector(\".gs_rt a\");\n      const snippetEl = article.querySelector(\".gs_rs\");\n      const infoEl = article.querySelector(\".gs_a\");\n      \n      if (titleEl) {\n        const title = titleEl.textContent?.trim() || \"\";\n        const url = titleEl.getAttribute(\"href\") || \"\";\n        const snippet = snippetEl?.textContent?.trim() || \"\";\n        const info = infoEl?.textContent?.trim() || \"\";\n        \n        const authors = info.match(/^([^-]+)/)?.[1]?.trim() || \"\";\n        const year = info.match(/\\b(19|20)\\d{2}\\b/)?.[0] || \"\";\n        \n        if (title && (url || snippet)) {\n          results.push({\n            title,\n            url,\n            snippet,\n            authors,\n            year,\n            citation: `${authors} (${year}). ${title}. Recuperado de ${url}`\n          });\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"Scholar search error:\", error);\n  }\n  \n  return results;\n}\n\nexport function needsAcademicSearch(message: string): boolean {\n  return ACADEMIC_PATTERNS.some(pattern => pattern.test(message));\n}\n\nexport function needsWebSearch(message: string): boolean {\n  return WEB_SEARCH_PATTERNS.some(pattern => pattern.test(message));\n}\n","path":null,"size_bytes":7212,"size_tokens":null},"server/services/chatService.ts":{"content":"import { openai, MODELS } from \"../lib/openai\";\nimport { llmGateway } from \"../lib/llmGateway\";\nimport { geminiChat, geminiStreamChat, GEMINI_MODELS, GeminiChatMessage } from \"../lib/gemini\";\nimport { LIMITS } from \"../lib/constants\";\nimport { storage } from \"../storage\";\nimport { generateEmbedding } from \"../embeddingService\";\nimport { searchWeb, searchScholar, needsWebSearch, needsAcademicSearch } from \"./webSearch\";\nimport { routeMessage, runPipeline, ProgressUpdate, checkDomainPolicy, checkRateLimit, sanitizeUrl, isValidObjective, multiIntentManager, multiIntentPipeline } from \"../agent\";\nimport type { PipelineResponse } from \"../../shared/schemas/multiIntent\";\nimport { checkToolPolicy, logToolCall } from \"./integrationPolicyService\";\n\nexport type LLMProvider = \"xai\" | \"gemini\";\n\nexport const AVAILABLE_MODELS = {\n  xai: {\n    name: \"xAI Grok\",\n    models: [\n      { id: \"grok-3-fast\", name: \"Grok 3 Fast\", description: \"Fastest responses\" },\n      { id: \"grok-2-vision-1212\", name: \"Grok 2 Vision\", description: \"Image understanding\" },\n    ]\n  },\n  gemini: {\n    name: \"Google Gemini\",\n    models: [\n      { id: \"gemini-3-flash-preview\", name: \"Gemini 3 Flash Preview\", description: \"Newest and fastest\", default: true },\n      { id: \"gemini-2.5-flash\", name: \"Gemini 2.5 Flash\", description: \"Fast and efficient\" },\n      { id: \"gemini-2.5-pro\", name: \"Gemini 2.5 Pro\", description: \"Most capable\" },\n    ]\n  }\n} as const;\n\nexport const DEFAULT_PROVIDER = \"gemini\";\nexport const DEFAULT_MODEL = \"gemini-3-flash-preview\";\n\ninterface ChatMessage {\n  role: \"user\" | \"assistant\" | \"system\";\n  content: string;\n}\n\ninterface GptConfig {\n  id: string;\n  systemPrompt: string;\n  temperature: number;\n  topP: number;\n}\n\ninterface DocumentMode {\n  type: \"word\" | \"excel\" | \"ppt\";\n}\n\ninterface FigmaDiagram {\n  nodes: Array<{\n    id: string;\n    type: \"start\" | \"end\" | \"process\" | \"decision\";\n    label: string;\n    x: number;\n    y: number;\n  }>;\n  connections: Array<{\n    from: string;\n    to: string;\n    label?: string;\n  }>;\n  title?: string;\n}\n\ninterface ChatSource {\n  fileName: string;\n  content: string;\n}\n\ninterface ChatResponse {\n  content: string;\n  role: string;\n  sources?: ChatSource[];\n  agentRunId?: string;\n  wasAgentTask?: boolean;\n  pipelineSteps?: number;\n  pipelineSuccess?: boolean;\n  browserSessionId?: string | null;\n  figmaDiagram?: FigmaDiagram;\n  multiIntentResponse?: PipelineResponse;\n}\n\nfunction broadcastAgentUpdate(runId: string, update: any) {\n}\n\nexport async function handleChatRequest(\n  messages: ChatMessage[],\n  options: {\n    useRag?: boolean;\n    conversationId?: string;\n    userId?: string;\n    images?: string[];\n    onAgentProgress?: (update: ProgressUpdate) => void;\n    gptConfig?: GptConfig;\n    documentMode?: DocumentMode;\n    figmaMode?: boolean;\n    provider?: LLMProvider;\n    model?: string;\n  } = {}\n): Promise<ChatResponse> {\n  const { useRag = true, conversationId, userId, images, onAgentProgress, gptConfig, documentMode, figmaMode, provider = DEFAULT_PROVIDER, model = DEFAULT_MODEL } = options;\n  const hasImages = images && images.length > 0;\n  \n  // Fetch user settings for feature flags and preferences\n  let userSettings: Awaited<ReturnType<typeof storage.getUserSettings>> = null;\n  if (userId) {\n    try {\n      userSettings = await storage.getUserSettings(userId);\n    } catch (error) {\n      console.error(\"Error fetching user settings:\", error);\n    }\n  }\n  \n  // Extract feature flags with defaults\n  // These flags control tool availability:\n  // - memoryEnabled: controls RAG/document memory retrieval\n  // - webSearchAuto: controls automatic web search triggering\n  // - codeInterpreterEnabled: controls code execution for charts/visualizations\n  // - connectorSearchAuto: controls automatic connector searches (TODO: implement in orchestrator/agent pipeline)\n  // - canvasEnabled: controls canvas/visualization features\n  // - voiceEnabled: controls voice input/output features\n  const featureFlags = {\n    memoryEnabled: userSettings?.featureFlags?.memoryEnabled ?? true,\n    webSearchAuto: userSettings?.featureFlags?.webSearchAuto ?? false,\n    codeInterpreterEnabled: userSettings?.featureFlags?.codeInterpreterEnabled ?? true,\n    connectorSearchAuto: userSettings?.featureFlags?.connectorSearchAuto ?? false,\n    canvasEnabled: userSettings?.featureFlags?.canvasEnabled ?? true,\n    voiceEnabled: userSettings?.featureFlags?.voiceEnabled ?? true,\n  };\n  \n  // TODO: Tool Policy Enforcement Integration Points\n  // The checkToolPolicy and logToolCall functions from integrationPolicyService.ts\n  // should be called at the following tool invocation points:\n  // \n  // 1. Web Search (lines ~291-324): Before calling searchWeb/searchScholar\n  //    Example: const policyCheck = await checkToolPolicy(userId, \"web_search\", \"search_provider\");\n  //    if (!policyCheck.allowed) { skip search and inform user }\n  //\n  // 2. RAG/Memory Retrieval (lines ~328-346): Before searching similar chunks\n  //    Example: const policyCheck = await checkToolPolicy(userId, \"memory_retrieval\", \"rag_provider\");\n  //\n  // 3. Multi-Intent Pipeline (line ~183): Before executing multiIntentPipeline.execute()\n  //    Example: const policyCheck = await checkToolPolicy(userId, \"multi_intent\", \"agent_pipeline\");\n  //\n  // 4. Agent Pipeline (line ~258): Before calling runPipeline()\n  //    Example: const policyCheck = await checkToolPolicy(userId, \"agent_pipeline\", \"browser_agent\");\n  //\n  // 5. Code Interpreter (detected via wantsChart flag): Before executing Python code\n  //    Example: const policyCheck = await checkToolPolicy(userId, \"code_interpreter\", \"python_executor\");\n  //\n  // After each tool execution, call logToolCall to record the invocation for audit purposes.\n  \n  // Extract response preferences\n  const customInstructions = userSettings?.responsePreferences?.customInstructions || \"\";\n  const responseStyle = userSettings?.responsePreferences?.responseStyle || \"default\";\n  \n  // Extract user profile for context\n  const userProfile = userSettings?.userProfile || null;\n  \n  let validatedGptConfig = gptConfig;\n  if (gptConfig?.id) {\n    try {\n      const gpt = await storage.getGpt(gptConfig.id);\n      if (gpt) {\n        validatedGptConfig = {\n          id: gpt.id,\n          systemPrompt: gpt.systemPrompt,\n          temperature: parseFloat(gpt.temperature || \"0.7\"),\n          topP: parseFloat(gpt.topP || \"1\")\n        };\n        storage.incrementGptUsage(gpt.id).catch(console.error);\n      } else {\n        validatedGptConfig = undefined;\n      }\n    } catch (error) {\n      console.error(\"Error loading GPT config:\", error);\n      validatedGptConfig = undefined;\n    }\n  }\n  \n  const lastUserMessage = messages.filter(m => m.role === \"user\").pop();\n  \n  if (lastUserMessage) {\n    // PRIMERO: Detectar multi-intent ANTES de routeMessage para evitar que el agent pipeline\n    // capture prompts con múltiples tareas y solo procese la última\n    if (!documentMode && !figmaMode && !hasImages) {\n      try {\n        const detection = await multiIntentManager.detectMultiIntent(lastUserMessage.content, {\n          messages: messages.map(m => ({ role: m.role, content: m.content })),\n          userPreferences: {}\n        });\n        \n        if (detection.isMultiIntent && detection.confidence >= 0.7) {\n          \n          const pipelineResponse = await multiIntentPipeline.execute(\n            lastUserMessage.content,\n            {\n              userId: conversationId,\n              conversationId,\n              messages: messages.map(m => ({ role: m.role, content: m.content })),\n              onProgress: onAgentProgress\n            }\n          );\n          \n          if (pipelineResponse.aggregate.completionStatus === \"complete\") {\n            return {\n              content: pipelineResponse.aggregate.summary,\n              role: \"assistant\",\n              wasAgentTask: true,\n              pipelineSteps: pipelineResponse.plan.length,\n              pipelineSuccess: true,\n              multiIntentResponse: pipelineResponse\n            };\n          }\n          \n          // Si el pipeline multi-intent falla, continuar con routeMessage normal\n        }\n      } catch (error) {\n        console.error(\"Multi-intent pipeline error, falling back to routeMessage:\", error);\n      }\n    }\n    \n    // SEGUNDO: Si no es multi-intent o falló, usar routeMessage normal\n    const routeResult = await routeMessage(lastUserMessage.content);\n    \n    if (routeResult.decision === \"agent\" || routeResult.decision === \"hybrid\") {\n      const urls = routeResult.urls || [];\n      \n      for (const url of urls) {\n        try {\n          const sanitizedUrl = sanitizeUrl(url);\n          const securityCheck = await checkDomainPolicy(sanitizedUrl);\n          \n          if (!securityCheck.allowed) {\n            return {\n              content: `No puedo acceder a ${url}: ${securityCheck.reason}`,\n              role: \"assistant\"\n            };\n          }\n          \n          const domain = new URL(sanitizedUrl).hostname;\n          if (!checkRateLimit(domain, securityCheck.rateLimit)) {\n            return {\n              content: `Límite de solicitudes alcanzado para ${domain}. Intenta de nuevo en un minuto.`,\n              role: \"assistant\"\n            };\n          }\n        } catch (e) {\n          console.error(\"URL validation error:\", e);\n        }\n      }\n      \n      if (!isValidObjective(routeResult.objective || lastUserMessage.content)) {\n        return {\n          content: \"No puedo procesar solicitudes que involucren información sensible o actividades no permitidas.\",\n          role: \"assistant\"\n        };\n      }\n      \n      const objective = routeResult.objective || lastUserMessage.content;\n      let lastBrowserSessionId: string | null = null;\n      \n      const pipelineResult = await runPipeline({\n        objective,\n        conversationId,\n        onProgress: (update) => {\n          onAgentProgress?.(update);\n          if (update.detail?.browserSessionId) {\n            lastBrowserSessionId = update.detail.browserSessionId;\n          }\n        }\n      });\n      \n      return {\n        content: pipelineResult.summary || \"Tarea completada.\",\n        role: \"assistant\",\n        sources: pipelineResult.artifacts\n          .filter(a => a.type === \"text\" && a.name)\n          .slice(0, 5)\n          .map(a => ({ fileName: a.name!, content: a.content?.slice(0, 200) || \"\" })),\n        agentRunId: pipelineResult.runId,\n        wasAgentTask: true,\n        pipelineSteps: pipelineResult.steps.length,\n        pipelineSuccess: pipelineResult.success,\n        browserSessionId: lastBrowserSessionId\n      };\n    }\n  }\n\n  let contextInfo = \"\";\n  let sources: ChatSource[] = [];\n  let webSearchInfo = \"\";\n\n  // Web search is gated by the webSearchAuto feature flag\n  // If webSearchAuto is false, skip automatic web search detection\n  if (featureFlags.webSearchAuto && lastUserMessage && needsAcademicSearch(lastUserMessage.content)) {\n    try {\n      const scholarResults = await searchScholar(lastUserMessage.content, 5);\n      \n      if (scholarResults.length > 0) {\n        webSearchInfo = \"\\n\\n**Artículos académicos encontrados en Google Scholar:**\\n\" +\n          scholarResults.map((r, i) => \n            `[${i + 1}] Autores: ${r.authors || \"No disponible\"}\\nAño: ${r.year || \"No disponible\"}\\nTítulo: ${r.title}\\nURL: ${r.url}\\nResumen: ${r.snippet}\\nCita sugerida: ${r.citation}`\n          ).join(\"\\n\\n\");\n      }\n    } catch (error) {\n      console.error(\"Academic search error:\", error);\n    }\n  } else if (featureFlags.webSearchAuto && lastUserMessage && needsWebSearch(lastUserMessage.content)) {\n    try {\n      const searchResults = await searchWeb(lastUserMessage.content, 5);\n      \n      if (searchResults.contents.length > 0) {\n        webSearchInfo = \"\\n\\n**Información de Internet (actualizada):**\\n\" +\n          searchResults.contents.map((content, i) => \n            `[${i + 1}] ${content.title} (${content.url}):\\n${content.content}`\n          ).join(\"\\n\\n\");\n      } else if (searchResults.results.length > 0) {\n        webSearchInfo = \"\\n\\n**Resultados de búsqueda web:**\\n\" +\n          searchResults.results.map((r, i) => \n            `[${i + 1}] ${r.title}: ${r.snippet} (${r.url})`\n          ).join(\"\\n\");\n      }\n    } catch (error) {\n      console.error(\"Web search error:\", error);\n    }\n  }\n\n  // RAG/Memory retrieval is gated by the memoryEnabled feature flag\n  // If memoryEnabled is false, skip document memory retrieval\n  if (useRag && featureFlags.memoryEnabled && lastUserMessage) {\n    try {\n      const queryEmbedding = await generateEmbedding(lastUserMessage.content);\n      const similarChunks = await storage.searchSimilarChunks(queryEmbedding, LIMITS.RAG_SIMILAR_CHUNKS);\n      \n      if (similarChunks.length > 0) {\n        sources = similarChunks.map((chunk: any) => ({\n          fileName: chunk.file_name || \"Documento\",\n          content: chunk.content.slice(0, 200) + \"...\"\n        }));\n        \n        contextInfo = \"\\n\\nContexto de documentos relevantes:\\n\" + \n          similarChunks.map((chunk: any, i: number) => \n            `[${i + 1}] ${chunk.file_name || \"Documento\"}: ${chunk.content}`\n          ).join(\"\\n\\n\");\n      }\n    } catch (error) {\n      console.error(\"RAG search error:\", error);\n    }\n  }\n\n  // Special system prompt for document mode - AI writes clean content only\n  const documentModeInstructions = `\nREGLAS DE ESCRITURA DE DOCUMENTOS:\n1. Escribe SOLO el contenido solicitado, sin explicaciones ni introducciones.\n2. NO incluyas frases como \"Aquí está...\", \"A continuación...\", \"Claro, te escribo...\", etc.\n3. NO hagas preguntas de seguimiento ni pidas confirmación.\n4. NO incluyas comentarios sobre lo que vas a hacer o has hecho.\n5. Escribe el contenido directamente como si estuvieras escribiendo en el documento.\n6. Usa formato apropiado: párrafos para Word, datos estructurados para Excel, puntos clave para PPT.\n7. Si el usuario pide una lista, escribe solo la lista.\n8. Si el usuario pide un párrafo, escribe solo el párrafo.\n9. Si el usuario pide editar algo, escribe solo el texto editado/corregido.\n10. El contenido se insertará directamente en el editor del usuario.\n\nFORMATO DE TEXTO ENRIQUECIDO (se convertirá a estilos nativos de Office):\n- Para texto en **negrita**, usa **doble asterisco**\n- Para texto en *cursiva*, usa *asterisco simple*\n- Para \\`código\\`, usa \\`comillas invertidas\\`\n\nFÓRMULAS MATEMÁTICAS - OBLIGATORIO USAR SINTAXIS LaTeX:\n- Para fórmulas en línea: $x^2 + y^2 = z^2$\n- Para fórmulas en bloque: $$\\\\frac{a}{b}$$\n- Fracciones: $\\\\frac{numerador}{denominador}$\n- Exponentes: $x^2$, $x^{n+1}$\n- Subíndices: $x_1$, $a_{ij}$\n- Raíces: $\\\\sqrt{x}$, $\\\\sqrt[n]{x}$\n- Letras griegas: $\\\\alpha$, $\\\\beta$, $\\\\pi$, $\\\\theta$\n- Derivadas: $\\\\frac{d}{dx}$, $f'(x)$\n- Integrales: $\\\\int_{a}^{b} f(x) dx$\n- Sumas: $\\\\sum_{i=1}^{n} x_i$\n- Límites: $\\\\lim_{x \\\\to 0}$\n\nIMPORTANTE: SIEMPRE usa $ para envolver fórmulas matemáticas:\n- CORRECTO: \"La función $f(x) = x^2$ tiene derivada $f'(x) = 2x$\"\n- INCORRECTO: \"La función f(x) = x²\" (NO uses caracteres Unicode como ², ³, ⁴)\n- INCORRECTO: \"f(x) = 8x⁴ - 6x³\" (NO uses superíndices Unicode)\n- CORRECTO: \"$f(x) = 8x^4 - 6x^3$\" (USA LaTeX con $...$)\n\nEscribe contenido limpio y directo.`;\n\n  const excelChartInstructions = `\nFORMATO OBLIGATORIO PARA EXCEL:\n- SIEMPRE usa formato CSV con valores separados por comas.\n- NUNCA uses markdown, asteriscos (**), guiones (-), ni bloques de código.\n- Cada línea es una fila de la hoja de cálculo.\n- Los valores se separan con comas.\n\nCOMANDOS DE HOJAS:\n- Para crear una NUEVA hoja: [NUEVA_HOJA:Nombre de la Hoja]\n- Puedes crear múltiples hojas en una sola respuesta.\n\nEJEMPLO DE GRÁFICOS DE BARRAS con múltiples hojas:\n[NUEVA_HOJA:Ventas 2020-2025]\nAño,Ventas,Gráfico\n2020,45000,█████████\n2021,62000,████████████\n2022,78000,████████████████\n2023,85000,█████████████████\n2024,92000,██████████████████\n2025,98000,████████████████████\n\n[NUEVA_HOJA:Proyección 2030-2035]\nAño,Proyección,Gráfico\n2030,150000,██████████████████████\n2031,175000,█████████████████████████\n2032,200000,████████████████████████████\n2033,225000,███████████████████████████████\n2034,250000,██████████████████████████████████\n2035,280000,█████████████████████████████████████\n\n[NUEVA_HOJA:Balance de Ventas]\nConcepto,Q1,Q2,Q3,Q4,Total\nIngresos,25000,28000,32000,35000,=B2+C2+D2+E2\nCostos,15000,16000,18000,20000,=B3+C3+D3+E3\nUtilidad Bruta,=B2-B3,=C2-C3,=D2-D3,=E2-E3,=B4+C4+D4+E4\nGastos Operativos,3000,3500,4000,4500,=B5+C5+D5+E5\nUtilidad Neta,=B4-B5,=C4-C5,=D4-D5,=E4-E5,=B6+C6+D6+E6\n\nREGLAS IMPORTANTES:\n1. Usa [NUEVA_HOJA:nombre] para crear cada hoja nueva.\n2. Después del comando de hoja, escribe los datos CSV directamente SIN líneas vacías.\n3. Para gráficos de barras visuales, usa █ repetido proporcionalmente.\n4. Para fórmulas usa el formato =CELDA+CELDA (ej: =B2+C2 o =SUM(B2:E2)).\n5. Las celdas se nombran como en Excel: A1, B2, C3, etc.\n6. NO incluyas explicaciones, solo los comandos y datos.\n`;\n\n  const documentModePrompt = documentMode ? (\n    validatedGptConfig\n      ? `${validatedGptConfig.systemPrompt}\n\nEstás ayudando al usuario a crear un documento ${documentMode.type === 'word' ? 'Word' : documentMode.type === 'excel' ? 'Excel' : 'PowerPoint'}.\n${documentModeInstructions}${documentMode.type === 'excel' ? excelChartInstructions : ''}${contextInfo}`\n      : `Eres un asistente de escritura de documentos. El usuario está editando un documento ${documentMode.type === 'word' ? 'Word' : documentMode.type === 'excel' ? 'Excel' : 'PowerPoint'}.\n${documentModeInstructions}${documentMode.type === 'excel' ? excelChartInstructions : ''}${contextInfo}`\n  ) : null;\n\n  // Check if user explicitly requests document creation\n  const lastUserMsgText = messages.filter(m => m.role === \"user\").pop()?.content?.toLowerCase() || \"\";\n  const wantsDocument = /\\b(crea|crear|genera|generar|haz|hacer|escribe|escribir|redacta|redactar|elabora|elaborar)\\b.*(documento|word|excel|powerpoint|ppt|archivo|docx|xlsx|pptx)/i.test(lastUserMsgText) ||\n                        /\\b(documento|word|excel|powerpoint|ppt)\\b.*(crea|crear|genera|generar|haz|hacer)/i.test(lastUserMsgText);\n\n  // Check if user wants a chart/graph/visualization\n  // Code interpreter is gated by the codeInterpreterEnabled feature flag\n  const wantsChart = /\\b(gr[aá]fic[oa]|chart|plot|visualiz|histograma|diagrama de barras|pie chart|scatter|l[ií]nea|barras)\\b/i.test(lastUserMsgText);\n\n  const codeInterpreterPrompt = (wantsChart && featureFlags.codeInterpreterEnabled) ? `\n⚠️ OBLIGATORIO - CODE INTERPRETER ACTIVO ⚠️\nEl usuario ha solicitado una GRÁFICA o VISUALIZACIÓN. DEBES responder con código Python ejecutable.\n\nREGLAS ESTRICTAS:\n1. Tu respuesta DEBE contener un bloque \\`\\`\\`python con código ejecutable\n2. NO describas la gráfica con texto - GENERA EL CÓDIGO\n3. NO uses caracteres ASCII (█, ─, etc.) para simular gráficas\n4. El código se ejecutará automáticamente y mostrará la gráfica real\n\nCÓDIGO OBLIGATORIO para gráfica de barras:\n\\`\\`\\`python\nimport matplotlib.pyplot as plt\nimport numpy as np\n\n# Datos simulados\nyears = [2020, 2021, 2022, 2023, 2024, 2025]\nvalues = [450, 520, 610, 580, 720, 850]\n\nplt.figure(figsize=(10, 6))\nplt.bar(years, values, color='steelblue', edgecolor='navy')\nplt.xlabel('Año', fontsize=12)\nplt.ylabel('Valor', fontsize=12)\nplt.title('Datos Simulados 2020-2025', fontsize=14, fontweight='bold')\nplt.grid(axis='y', alpha=0.3, linestyle='--')\nplt.tight_layout()\nplt.show()\n\\`\\`\\`\n\nPara gráfica de líneas:\n\\`\\`\\`python\nimport matplotlib.pyplot as plt\nplt.figure(figsize=(10, 6))\nplt.plot(years, values, marker='o', linewidth=2, markersize=8)\nplt.xlabel('Año')\nplt.ylabel('Valor')\nplt.title('Tendencia')\nplt.grid(True, alpha=0.3)\nplt.show()\n\\`\\`\\`\n\nPara gráfica circular (pie):\n\\`\\`\\`python\nimport matplotlib.pyplot as plt\nlabels = ['A', 'B', 'C', 'D']\nsizes = [30, 25, 25, 20]\nplt.figure(figsize=(8, 8))\nplt.pie(sizes, labels=labels, autopct='%1.1f%%', startangle=90)\nplt.title('Distribución')\nplt.show()\n\\`\\`\\`\n\nRESPONDE AHORA CON UN BLOQUE \\`\\`\\`python QUE CREE LA GRÁFICA SOLICITADA.\n` : '';\n\n  const documentCapabilitiesPrompt = wantsDocument ? `\nCAPACIDADES DE GENERACIÓN DE DOCUMENTOS:\nPuedes crear documentos Word, Excel y PowerPoint. Incluye en tu respuesta un bloque especial con el formato:\n\n\\`\\`\\`document\n{\n  \"type\": \"word\" | \"excel\" | \"ppt\",\n  \"title\": \"Título del documento\",\n  \"content\": \"Contenido formateado del documento\"\n}\n\\`\\`\\`\n\nPara Word: usa markdown simple (## para títulos, - para listas).\nPara Excel: usa formato de tabla con | columna1 | columna2 | o CSV.\nPara PPT: usa ## para títulos de diapositivas y - para puntos.\n\nEl usuario podrá descargar el documento generado directamente.` : `\nIMPORTANTE: Cuando el usuario pida un resumen, análisis o información, responde directamente en texto plano en el chat. \nNO generes documentos Word/Excel/PPT a menos que el usuario lo pida EXPLÍCITAMENTE con frases como \"crea un documento\", \"genera un Word\", \"haz un PowerPoint\", etc.\nSi el usuario dice \"dame un resumen\" o \"analiza esto\", responde en texto, NO como documento.`;\n\n  // Build user profile context if available\n  const userProfileContext = userProfile && (userProfile.nickname || userProfile.occupation || userProfile.bio) \n    ? `\\n\\nInformación del usuario:${userProfile.nickname ? `\\n- Nombre/Apodo: ${userProfile.nickname}` : ''}${userProfile.occupation ? `\\n- Ocupación: ${userProfile.occupation}` : ''}${userProfile.bio ? `\\n- Bio: ${userProfile.bio}` : ''}`\n    : '';\n\n  // Build custom instructions section if present\n  const customInstructionsSection = customInstructions \n    ? `\\n\\nInstrucciones personalizadas del usuario:\\n${customInstructions}`\n    : '';\n\n  // Build response style modifier based on user preference\n  const responseStyleModifier = responseStyle !== 'default' \n    ? `\\n\\nEstilo de respuesta preferido: ${\n        responseStyle === 'formal' ? 'formal y profesional' :\n        responseStyle === 'casual' ? 'casual y amigable' :\n        responseStyle === 'concise' ? 'muy conciso y breve' : ''\n      }`\n    : '';\n\n  const defaultSystemContent = `Eres Sira GPT, un asistente de IA conciso y directo. Responde de forma breve y al punto. Evita introducciones largas y despedidas innecesarias. Ve directo a la respuesta sin rodeos.${userProfileContext}${customInstructionsSection}${responseStyleModifier}\n${codeInterpreterPrompt}${documentCapabilitiesPrompt}`;\n\n  // Use document mode prompt when in document editing mode\n  const systemContent = documentModePrompt \n    ? documentModePrompt\n    : (validatedGptConfig \n        ? `${validatedGptConfig.systemPrompt}\\n\\n${defaultSystemContent}${webSearchInfo}${contextInfo}`\n        : `${defaultSystemContent}${webSearchInfo}${contextInfo}`);\n\n  const systemMessage: ChatMessage = {\n    role: \"system\",\n    content: systemContent\n  };\n\n  const temperature = validatedGptConfig?.temperature ?? 0.7;\n  const topP = validatedGptConfig?.topP ?? 1;\n\n  // Handle Figma diagram generation mode\n  if (figmaMode && lastUserMessage) {\n    const figmaSystemPrompt = `Eres un generador de diagramas de flujo. Analiza la solicitud del usuario y genera un diagrama de flujo estructurado.\n\nDEBES responder ÚNICAMENTE con un objeto JSON válido en el siguiente formato:\n{\n  \"title\": \"Título del diagrama\",\n  \"nodes\": [\n    { \"id\": \"node1\", \"type\": \"start\", \"label\": \"Inicio\", \"x\": 100, \"y\": 50 },\n    { \"id\": \"node2\", \"type\": \"process\", \"label\": \"Paso 1\", \"x\": 100, \"y\": 150 },\n    { \"id\": \"node3\", \"type\": \"decision\", \"label\": \"¿Condición?\", \"x\": 100, \"y\": 250 },\n    { \"id\": \"node4\", \"type\": \"process\", \"label\": \"Paso Sí\", \"x\": 250, \"y\": 350 },\n    { \"id\": \"node5\", \"type\": \"process\", \"label\": \"Paso No\", \"x\": -50, \"y\": 350 },\n    { \"id\": \"node6\", \"type\": \"end\", \"label\": \"Fin\", \"x\": 100, \"y\": 450 }\n  ],\n  \"connections\": [\n    { \"from\": \"node1\", \"to\": \"node2\" },\n    { \"from\": \"node2\", \"to\": \"node3\" },\n    { \"from\": \"node3\", \"to\": \"node4\", \"label\": \"Sí\" },\n    { \"from\": \"node3\", \"to\": \"node5\", \"label\": \"No\" },\n    { \"from\": \"node4\", \"to\": \"node6\" },\n    { \"from\": \"node5\", \"to\": \"node6\" }\n  ]\n}\n\nTIPOS DE NODOS:\n- \"start\": Nodo de inicio (óvalo verde)\n- \"end\": Nodo de fin (óvalo rojo)  \n- \"process\": Proceso o acción (rectángulo azul)\n- \"decision\": Decisión/bifurcación (rombo amarillo)\n\nREGLAS:\n1. Cada diagrama DEBE tener exactamente UN nodo \"start\" y al menos UN nodo \"end\"\n2. Posiciona los nodos verticalmente con Y incrementando hacia abajo (separación de ~100px)\n3. Para bifurcaciones, usa X negativo para \"No\" y X positivo para \"Sí\"\n4. Los labels deben ser concisos (máximo 5 palabras)\n5. SOLO responde con el JSON, sin explicaciones ni texto adicional\n\nGenera el diagrama basándote en la solicitud del usuario.`;\n\n    try {\n      const figmaResponse = await llmGateway.chat(\n        [\n          { role: \"system\", content: figmaSystemPrompt },\n          { role: \"user\", content: lastUserMessage.content }\n        ],\n        {\n          model: MODELS.TEXT,\n          temperature: 0.3,\n          topP: 1,\n          userId: conversationId,\n          requestId: `figma_${Date.now()}`,\n        }\n      );\n\n      // Parse the JSON response\n      let figmaDiagram: FigmaDiagram | undefined;\n      try {\n        const jsonMatch = figmaResponse.content.match(/\\{[\\s\\S]*\\}/);\n        if (jsonMatch) {\n          const parsed = JSON.parse(jsonMatch[0]);\n          figmaDiagram = {\n            title: parsed.title || \"Diagrama\",\n            nodes: parsed.nodes || [],\n            connections: parsed.connections || []\n          };\n        }\n      } catch (parseError) {\n        console.error(\"Failed to parse Figma diagram JSON:\", parseError);\n      }\n\n      if (figmaDiagram && figmaDiagram.nodes.length > 0) {\n        return {\n          content: `He creado el diagrama \"${figmaDiagram.title}\". Puedes verlo abajo y editarlo en Figma.`,\n          role: \"assistant\",\n          figmaDiagram\n        };\n      } else {\n        return {\n          content: \"No pude generar el diagrama. Por favor, describe el proceso o flujo que quieres visualizar con más detalle.\",\n          role: \"assistant\"\n        };\n      }\n    } catch (error) {\n      console.error(\"Figma diagram generation error:\", error);\n      return {\n        content: \"Hubo un error al generar el diagrama. Por favor, intenta de nuevo.\",\n        role: \"assistant\"\n      };\n    }\n  }\n\n  let response;\n  \n  if (provider === \"gemini\") {\n    if (hasImages) {\n      return {\n        content: \"Gemini actualmente no soporta análisis de imágenes en esta versión. Por favor, selecciona xAI Grok 2 Vision para analizar imágenes.\",\n        role: \"assistant\"\n      };\n    }\n    \n\n    const geminiMessages: GeminiChatMessage[] = [];\n    \n    if (systemMessage.content) {\n      geminiMessages.push({\n        role: \"user\",\n        parts: [{ text: `[System Instructions]\\n${systemMessage.content}\\n\\n[End System Instructions]` }]\n      });\n      geminiMessages.push({\n        role: \"model\",\n        parts: [{ text: \"Entendido. Seguiré estas instrucciones.\" }]\n      });\n    }\n    \n    for (const msg of messages) {\n      geminiMessages.push({\n        role: msg.role === \"assistant\" ? \"model\" : \"user\",\n        parts: [{ text: msg.content }]\n      });\n    }\n    \n    const geminiModel = (model as typeof GEMINI_MODELS[keyof typeof GEMINI_MODELS]) || GEMINI_MODELS.FLASH;\n    \n    const geminiResponse = await geminiChat(geminiMessages, {\n      model: geminiModel,\n      temperature,\n      topP,\n    });\n    \n    console.log(`[ChatService] Gemini response: model=${geminiResponse.model}`);\n    \n    return { \n      content: geminiResponse.content,\n      role: \"assistant\"\n    };\n  } else if (hasImages) {\n    const imageContents = images!.map((img: string) => ({\n      type: \"image_url\" as const,\n      image_url: { url: img }\n    }));\n    \n    const lastUserIdx = messages.findLastIndex(m => m.role === \"user\");\n    const messagesWithImages = messages.map((msg, idx) => {\n      if (idx === lastUserIdx) {\n        return {\n          role: msg.role,\n          content: [\n            ...imageContents,\n            { type: \"text\" as const, text: msg.content || \"Analiza esta imagen\" }\n          ]\n        };\n      }\n      return msg;\n    });\n    \n    response = await openai.chat.completions.create({\n      model: MODELS.VISION,\n      messages: [systemMessage, ...messagesWithImages] as any,\n      max_tokens: 4096,\n      temperature,\n      top_p: topP,\n    });\n    \n    const content = response.choices[0]?.message?.content || \"No response generated\";\n    \n    return { \n      content,\n      role: \"assistant\"\n    };\n  } else {\n    const gatewayResponse = await llmGateway.chat(\n      [systemMessage, ...messages],\n      {\n        model: model || MODELS.TEXT,\n        temperature,\n        topP,\n        userId: conversationId,\n        requestId: `chat_${Date.now()}`,\n      }\n    );\n    \n    console.log(`[ChatService] LLM Gateway response: ${gatewayResponse.latencyMs}ms, tokens: ${gatewayResponse.usage?.totalTokens || 0}`);\n    \n    return { \n      content: gatewayResponse.content,\n      role: \"assistant\"\n    };\n  }\n}\n","path":null,"size_bytes":29704,"size_tokens":null},"server/lib/openai.ts":{"content":"import OpenAI from \"openai\";\n\nexport const openai = new OpenAI({ \n  baseURL: \"https://api.x.ai/v1\", \n  apiKey: process.env.XAI_API_KEY \n});\n\nexport const MODELS = {\n  TEXT: \"grok-3-fast\",\n  VISION: \"grok-2-vision-1212\"\n} as const;\n\nexport type ModelType = typeof MODELS[keyof typeof MODELS];\n","path":null,"size_bytes":292,"size_tokens":null},"server/lib/constants.ts":{"content":"export const ALLOWED_MIME_TYPES = [\n  \"text/plain\",\n  \"text/markdown\",\n  \"text/csv\",\n  \"text/html\",\n  \"application/json\",\n  \"application/pdf\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  \"application/vnd.ms-excel\",\n  \"application/vnd.openxmlformats-officedocument.presentationml.presentation\",\n  \"application/vnd.ms-powerpoint\",\n  \"image/png\",\n  \"image/jpeg\",\n  \"image/jpg\",\n  \"image/gif\",\n  \"image/bmp\",\n  \"image/webp\",\n  \"image/tiff\",\n] as const;\n\nexport const HTTP_HEADERS = {\n  USER_AGENT: \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n  ACCEPT_HTML: \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n  ACCEPT_LANGUAGE: \"es-ES,es;q=0.9,en;q=0.8\"\n} as const;\n\nexport const TIMEOUTS = {\n  PAGE_FETCH: 8000,\n  SCREENSHOT_INTERVAL: 1500,\n  MAX_CONTENT_LENGTH: 2000\n} as const;\n\nexport const LIMITS = {\n  MAX_SEARCH_RESULTS: 5,\n  MAX_CONTENT_FETCH: 3,\n  EMBEDDING_BATCH_SIZE: 20,\n  MAX_EMBEDDING_INPUT: 8000,\n  RAG_SIMILAR_CHUNKS: 5,\n  MAX_FILE_SIZE_MB: 100,\n  MAX_FILE_SIZE_BYTES: 100 * 1024 * 1024\n} as const;\n\nexport const FILE_UPLOAD_CONFIG = {\n  CHUNK_SIZE_MB: 5,\n  CHUNK_SIZE_BYTES: 5 * 1024 * 1024,\n  MAX_PARALLEL_CHUNKS: 4,\n  UPLOAD_TIMEOUT_MS: 60000\n} as const;\n\nexport const ALLOWED_EXTENSIONS: Record<string, string> = {\n  \"text/plain\": \".txt\",\n  \"text/markdown\": \".md\",\n  \"text/csv\": \".csv\",\n  \"text/html\": \".html\",\n  \"application/json\": \".json\",\n  \"application/pdf\": \".pdf\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\": \".docx\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\": \".xlsx\",\n  \"application/vnd.ms-excel\": \".xls\",\n  \"application/vnd.openxmlformats-officedocument.presentationml.presentation\": \".pptx\",\n  \"application/vnd.ms-powerpoint\": \".ppt\",\n  \"image/png\": \".png\",\n  \"image/jpeg\": \".jpg\",\n  \"image/jpg\": \".jpg\",\n  \"image/gif\": \".gif\",\n  \"image/bmp\": \".bmp\",\n  \"image/webp\": \".webp\",\n  \"image/tiff\": \".tiff\"\n} as const;\n","path":null,"size_bytes":2091,"size_tokens":null},"client/src/components/document-editor.tsx":{"content":"import { useEffect, useCallback, useRef } from 'react';\nimport { useEditor, EditorContent } from '@tiptap/react';\nimport StarterKit from '@tiptap/starter-kit';\nimport Underline from '@tiptap/extension-underline';\nimport TextAlign from '@tiptap/extension-text-align';\nimport { TextStyle } from '@tiptap/extension-text-style';\nimport FontFamily from '@tiptap/extension-font-family';\nimport { Color } from '@tiptap/extension-color';\nimport Highlight from '@tiptap/extension-highlight';\nimport Link from '@tiptap/extension-link';\nimport Image from '@tiptap/extension-image';\nimport { Table } from '@tiptap/extension-table';\nimport { TableRow } from '@tiptap/extension-table-row';\nimport { TableCell } from '@tiptap/extension-table-cell';\nimport { TableHeader } from '@tiptap/extension-table-header';\nimport MathExtension from '@aarkue/tiptap-math-extension';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport { markdownToTipTap } from '@/lib/markdownToHtml';\nimport 'katex/dist/katex.min.css';\nimport {\n  Bold,\n  Italic,\n  Underline as UnderlineIcon,\n  Strikethrough,\n  AlignLeft,\n  AlignCenter,\n  AlignRight,\n  AlignJustify,\n  List,\n  ListOrdered,\n  Undo,\n  Redo,\n  Link as LinkIcon,\n  Image as ImageIcon,\n  Table as TableIcon,\n  X,\n  Download,\n} from 'lucide-react';\n\ninterface DocumentEditorProps {\n  title: string;\n  content: string;\n  onChange: (content: string) => void;\n  onClose: () => void;\n  onDownload: () => void;\n  documentType: 'word' | 'excel' | 'ppt';\n  onTextSelect?: (text: string, applyRewrite: (newText: string) => void) => void;\n  onTextDeselect?: () => void;\n  onInsertContent?: (insertFn: (content: string, replaceMode?: boolean) => void) => void;\n}\n\nconst fontFamilies = [\n  { label: 'Inter', value: 'Inter, sans-serif' },\n  { label: 'Georgia', value: 'Georgia, serif' },\n  { label: 'Arial', value: 'Arial, sans-serif' },\n  { label: 'Times New Roman', value: '\"Times New Roman\", serif' },\n  { label: 'Playfair Display', value: '\"Playfair Display\", serif' },\n];\n\nconst fontSizes = ['12', '14', '16', '18', '20', '24', '28', '32', '36', '48'];\n\nexport function DocumentEditor({\n  title,\n  content,\n  onChange,\n  onClose,\n  onDownload,\n  documentType,\n  onTextSelect,\n  onTextDeselect,\n  onInsertContent,\n}: DocumentEditorProps) {\n  const savedRangeRef = useRef<Range | null>(null);\n\n  const editor = useEditor({\n    extensions: [\n      StarterKit.configure({\n        heading: {\n          levels: [1, 2, 3],\n        },\n      }),\n      Underline,\n      TextAlign.configure({\n        types: ['heading', 'paragraph'],\n      }),\n      TextStyle,\n      FontFamily,\n      Color,\n      Highlight.configure({\n        multicolor: true,\n      }),\n      Link.configure({\n        openOnClick: false,\n      }),\n      Image,\n      Table.configure({\n        resizable: true,\n      }),\n      TableRow,\n      TableCell,\n      TableHeader,\n      MathExtension.configure({\n        evaluation: false,\n        delimiters: 'dollar',\n        katexOptions: {\n          throwOnError: false,\n          displayMode: false,\n        },\n      }),\n    ],\n    content: markdownToTipTap(content),\n    onUpdate: ({ editor }) => {\n      onChange(editor.getHTML());\n    },\n    editorProps: {\n      attributes: {\n        class: 'prose prose-lg max-w-none focus:outline-none min-h-[800px] template-emily',\n      },\n    },\n  });\n\n  const applyRewrite = useCallback((newText: string) => {\n    if (!editor || !savedRangeRef.current) return;\n\n    const selection = window.getSelection();\n    if (selection) {\n      selection.removeAllRanges();\n      selection.addRange(savedRangeRef.current);\n    }\n\n    editor.chain().focus().deleteSelection().insertContent(newText).run();\n    savedRangeRef.current = null;\n  }, [editor]);\n\n  const handleTextSelection = useCallback(() => {\n    if (!editor || !onTextSelect) return;\n    \n    const selection = window.getSelection();\n    if (!selection || selection.isCollapsed || !selection.toString().trim()) {\n      return;\n    }\n\n    const text = selection.toString();\n    if (text.trim().length < 2) return;\n\n    savedRangeRef.current = selection.getRangeAt(0).cloneRange();\n    onTextSelect(text, applyRewrite);\n  }, [editor, onTextSelect, applyRewrite]);\n\n  useEffect(() => {\n    const handleMouseUp = (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (target.closest('.page-container')) {\n        setTimeout(handleTextSelection, 10);\n      }\n    };\n\n    document.addEventListener('mouseup', handleMouseUp);\n    return () => {\n      document.removeEventListener('mouseup', handleMouseUp);\n    };\n  }, [handleTextSelection]);\n\n  // Content insertion with optional replace mode for streaming\n  useEffect(() => {\n    if (editor && onInsertContent) {\n      const insertContent = (text: string, replaceMode = false) => {\n        if (!editor || editor.isDestroyed) {\n          console.warn('[DocumentEditor] Editor not available');\n          return;\n        }\n        \n        if (!text || text.trim() === '') return;\n        \n        // Use AST-based markdown to HTML conversion that preserves math for TipTap\n        const htmlContent = markdownToTipTap(text);\n        \n        if (replaceMode) {\n          // Replace entire content - used for streaming to show progressive content\n          editor.commands.setContent(htmlContent);\n        } else {\n          // Append to end - original behavior\n          editor.chain()\n            .focus('end')\n            .insertContent(htmlContent)\n            .run();\n        }\n      };\n      \n      onInsertContent(insertContent);\n    }\n  }, [editor, onInsertContent]);\n\n  if (!editor) return null;\n\n  return (\n    <div className=\"document-editor-container flex h-full bg-gray-100 dark:bg-gray-900\">\n      {/* Workspace */}\n      <div className=\"workspace flex-1 flex flex-col overflow-hidden\">\n        {/* Top Action Bar */}\n        <div className=\"action-bar flex items-center justify-between px-4 py-2 bg-white dark:bg-gray-800 border-b\">\n          <div className=\"flex items-center gap-2\">\n            <span className=\"font-medium text-sm\">{title}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button variant=\"default\" size=\"sm\" onClick={onDownload} className=\"gap-2\">\n              <Download className=\"h-4 w-4\" />\n              Descargar\n            </Button>\n            <Button variant=\"ghost\" size=\"icon\" onClick={onClose}>\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n\n        {/* Sticky Toolbar */}\n        <div className=\"toolbar sticky top-0 z-50 bg-white dark:bg-gray-800 border-b px-4 py-2\">\n          <div className=\"flex items-center gap-1 flex-wrap\">\n            {/* Undo/Redo */}\n            <div className=\"flex items-center gap-0.5 pr-2 border-r\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8\"\n                onClick={() => editor.chain().focus().undo().run()}\n                disabled={!editor.can().undo()}\n              >\n                <Undo className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8\"\n                onClick={() => editor.chain().focus().redo().run()}\n                disabled={!editor.can().redo()}\n              >\n                <Redo className=\"h-4 w-4\" />\n              </Button>\n            </div>\n\n            {/* Text Style Dropdown */}\n            <div className=\"flex items-center gap-1 px-2 border-r\">\n              <select\n                className=\"text-xs border rounded px-2 py-1.5 bg-transparent min-w-[100px]\"\n                value={\n                  editor.isActive('heading', { level: 1 })\n                    ? 'h1'\n                    : editor.isActive('heading', { level: 2 })\n                    ? 'h2'\n                    : editor.isActive('heading', { level: 3 })\n                    ? 'h3'\n                    : 'p'\n                }\n                onChange={(e) => {\n                  const value = e.target.value;\n                  if (value === 'p') {\n                    editor.chain().focus().setParagraph().run();\n                  } else {\n                    const level = parseInt(value.replace('h', '')) as 1 | 2 | 3;\n                    editor.chain().focus().toggleHeading({ level }).run();\n                  }\n                }}\n              >\n                <option value=\"p\">Normal Text</option>\n                <option value=\"h1\">Heading 1</option>\n                <option value=\"h2\">Heading 2</option>\n                <option value=\"h3\">Heading 3</option>\n              </select>\n\n              <select\n                className=\"text-xs border rounded px-2 py-1.5 bg-transparent min-w-[90px]\"\n                onChange={(e) => {\n                  editor.chain().focus().setFontFamily(e.target.value).run();\n                }}\n              >\n                {fontFamilies.map((font) => (\n                  <option key={font.value} value={font.value}>\n                    {font.label}\n                  </option>\n                ))}\n              </select>\n\n              <select\n                className=\"text-xs border rounded px-2 py-1.5 bg-transparent w-16\"\n                onChange={(e) => {\n                  // Font size would need a custom extension\n                }}\n              >\n                {fontSizes.map((size) => (\n                  <option key={size} value={size}>\n                    {size}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            {/* Text Formatting */}\n            <div className=\"flex items-center gap-0.5 px-2 border-r\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive('bold') && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().toggleBold().run()}\n              >\n                <Bold className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive('italic') && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().toggleItalic().run()}\n              >\n                <Italic className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive('underline') && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().toggleUnderline().run()}\n              >\n                <UnderlineIcon className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive('strike') && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().toggleStrike().run()}\n              >\n                <Strikethrough className=\"h-4 w-4\" />\n              </Button>\n            </div>\n\n            {/* Alignment */}\n            <div className=\"flex items-center gap-0.5 px-2 border-r\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive({ textAlign: 'left' }) && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().setTextAlign('left').run()}\n              >\n                <AlignLeft className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive({ textAlign: 'center' }) && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().setTextAlign('center').run()}\n              >\n                <AlignCenter className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive({ textAlign: 'right' }) && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().setTextAlign('right').run()}\n              >\n                <AlignRight className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive({ textAlign: 'justify' }) && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().setTextAlign('justify').run()}\n              >\n                <AlignJustify className=\"h-4 w-4\" />\n              </Button>\n            </div>\n\n            {/* Lists */}\n            <div className=\"flex items-center gap-0.5 px-2\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive('bulletList') && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().toggleBulletList().run()}\n              >\n                <List className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className={cn('h-8 w-8', editor.isActive('orderedList') && 'bg-gray-200 dark:bg-gray-700')}\n                onClick={() => editor.chain().focus().toggleOrderedList().run()}\n              >\n                <ListOrdered className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Document Canvas Area */}\n        <div className=\"canvas-area\">\n          <div className=\"page-container\">\n            <EditorContent editor={editor} />\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":13819,"size_tokens":null},"client/src/lib/markdownToHtml.ts":{"content":"import { unified } from \"unified\";\nimport remarkParse from \"remark-parse\";\nimport remarkGfm from \"remark-gfm\";\nimport remarkMath from \"remark-math\";\nimport remarkRehype from \"remark-rehype\";\nimport rehypeKatex from \"rehype-katex\";\nimport rehypeStringify from \"rehype-stringify\";\nimport type { Root, Element, Text } from 'hast';\nimport { visit } from 'unist-util-visit';\n\n/**\n * Common LaTeX commands that indicate mathematical content\n */\nconst LATEX_COMMANDS = [\n  'int', 'sum', 'prod', 'lim', 'frac', 'sqrt', 'sin', 'cos', 'tan', 'log', 'ln',\n  'exp', 'infty', 'alpha', 'beta', 'gamma', 'delta', 'theta', 'pi', 'sigma',\n  'partial', 'nabla', 'cdot', 'times', 'div', 'pm', 'mp', 'leq', 'geq', 'neq',\n  'approx', 'equiv', 'subset', 'supset', 'cup', 'cap', 'in', 'notin', 'forall',\n  'exists', 'rightarrow', 'leftarrow', 'Rightarrow', 'Leftarrow', 'vec', 'hat',\n  'bar', 'dot', 'ddot', 'binom', 'matrix', 'begin', 'end', 'left', 'right',\n  'over', 'to', 'mapsto', 'implies', 'iff', 'land', 'lor', 'neg', 'oplus',\n  'otimes', 'mathbb', 'mathcal', 'mathbf', 'mathrm', 'text'\n];\n\n/**\n * Wrap raw LaTeX expressions in $ delimiters so remark-math can parse them.\n * Detects expressions containing LaTeX commands like \\int, \\frac, \\sin, etc.\n */\nfunction wrapRawLatex(text: string): string {\n  const lines = text.split('\\n');\n  const processedLines = lines.map(line => {\n    // Skip lines that are already properly delimited\n    if (line.includes('$') || line.includes('\\\\[') || line.includes('\\\\(')) {\n      return line;\n    }\n    \n    // Check if line contains LaTeX commands\n    const hasLatex = LATEX_COMMANDS.some(cmd => line.includes(`\\\\${cmd}`));\n    if (!hasLatex) {\n      return line;\n    }\n    \n    const trimmed = line.trim();\n    \n    // If line is purely a math expression (starts with \\ and is mostly math), wrap entire line\n    if (trimmed.startsWith('\\\\')) {\n      return `$$${trimmed}$$`;\n    }\n    \n    // Find where math expression starts (first backslash) and extract it\n    // Common pattern: \"text: \\int ... dx\" or \"text: \\frac{...}{...}\"\n    const colonIndex = line.lastIndexOf(':');\n    if (colonIndex !== -1) {\n      const beforeColon = line.substring(0, colonIndex + 1);\n      const afterColon = line.substring(colonIndex + 1).trim();\n      \n      // Check if what follows the colon contains LaTeX\n      const afterHasLatex = LATEX_COMMANDS.some(cmd => afterColon.includes(`\\\\${cmd}`));\n      if (afterHasLatex && afterColon.startsWith('\\\\')) {\n        // Wrap everything after the colon as math\n        return `${beforeColon} $${afterColon}$`;\n      }\n    }\n    \n    // For lines like \"f(x) = expression\" or inline math, try to identify math segments\n    // Match continuous math expressions starting with \\command and including related content\n    let result = line;\n    \n    // Pattern: match from first \\command to end of math-like content\n    // This captures: \\int ... dx, \\frac{}{}, \\sin(x), etc.\n    const mathStartPattern = /\\\\(int|sum|prod|lim|frac|sqrt|sin|cos|tan|log|ln|exp|partial|nabla|vec|hat|bar|binom|left|right)/;\n    const match = result.match(mathStartPattern);\n    \n    if (match && match.index !== undefined) {\n      const startIdx = match.index;\n      // Find where this math expression likely ends\n      // Look for: end of line, or a sentence-ending pattern not part of math\n      let endIdx = result.length;\n      \n      // Extract the potential math portion\n      const mathPortion = result.substring(startIdx);\n      \n      // Wrap the entire math portion\n      result = result.substring(0, startIdx) + `$${mathPortion}$`;\n    }\n    \n    return result;\n  });\n  \n  return processedLines.join('\\n');\n}\n\nfunction normalizeMarkdown(text: string): string {\n  let normalized = text\n    .replace(/\\r\\n/g, \"\\n\")\n    .replace(/\\r/g, \"\\n\")\n    .replace(/\\n{3,}/g, \"\\n\\n\")\n    .trim();\n  \n  // Convert LaTeX bracket delimiters to dollar delimiters\n  normalized = normalized.replace(/\\\\\\[/g, '$$').replace(/\\\\\\]/g, '$$');\n  normalized = normalized.replace(/\\\\\\(/g, '$').replace(/\\\\\\)/g, '$');\n  \n  // Wrap any remaining raw LaTeX expressions\n  normalized = wrapRawLatex(normalized);\n  \n  return normalized;\n}\n\n/**\n * Custom rehype plugin that converts math nodes to TipTap-compatible format.\n * Instead of rendering math with KaTeX, it creates span elements with\n * data-type=\"inlineMath\" that TipTap's MathExtension can parse.\n */\nfunction rehypePreserveMath() {\n  return (tree: Root) => {\n    visit(tree, 'element', (node: Element, index, parent) => {\n      if (!parent || typeof index !== 'number') return;\n      \n      // Handle inline math: <span class=\"math math-inline\">...</span>\n      if (\n        node.tagName === 'span' &&\n        node.properties?.className &&\n        Array.isArray(node.properties.className) &&\n        node.properties.className.includes('math-inline')\n      ) {\n        const latex = extractTextFromNode(node);\n        // Create a TipTap-compatible math span\n        const mathSpan: Element = {\n          type: 'element',\n          tagName: 'span',\n          properties: {\n            'data-type': 'inlineMath',\n            'data-latex': latex,\n            'data-evaluate': 'no',\n            'data-display': 'no'\n          },\n          children: [{ type: 'text', value: `$${latex}$` }]\n        };\n        (parent as Element).children.splice(index, 1, mathSpan);\n        return;\n      }\n      \n      // Handle display math: <div class=\"math math-display\">...</div>\n      if (\n        node.tagName === 'div' &&\n        node.properties?.className &&\n        Array.isArray(node.properties.className) &&\n        node.properties.className.includes('math-display')\n      ) {\n        const latex = extractTextFromNode(node);\n        // Create a TipTap-compatible math span with display mode\n        const mathSpan: Element = {\n          type: 'element',\n          tagName: 'span',\n          properties: {\n            'data-type': 'inlineMath',\n            'data-latex': latex,\n            'data-evaluate': 'no',\n            'data-display': 'yes'\n          },\n          children: [{ type: 'text', value: `$$${latex}$$` }]\n        };\n        // Wrap in a paragraph\n        const paragraph: Element = {\n          type: 'element',\n          tagName: 'p',\n          properties: {},\n          children: [mathSpan]\n        };\n        (parent as Element).children.splice(index, 1, paragraph);\n        return;\n      }\n    });\n  };\n}\n\n/**\n * Extract text content from a HAST node recursively\n */\nfunction extractTextFromNode(node: Element | Text): string {\n  if (node.type === 'text') {\n    return node.value;\n  }\n  if (node.type === 'element' && node.children) {\n    return node.children.map(child => extractTextFromNode(child as Element | Text)).join('');\n  }\n  return '';\n}\n\nexport function markdownToHtml(markdown: string): string {\n  if (!markdown || markdown.trim() === '') {\n    return '<p></p>';\n  }\n\n  const normalized = normalizeMarkdown(markdown);\n  \n  try {\n    const result = unified()\n      .use(remarkParse)\n      .use(remarkGfm)\n      .use(remarkMath)\n      .use(remarkRehype, { allowDangerousHtml: true })\n      .use(rehypeKatex)\n      .use(rehypeStringify, { allowDangerousHtml: true })\n      .processSync(normalized);\n    \n    return String(result) || '<p></p>';\n  } catch (error) {\n    console.error('[markdownToHtml] Parse error:', error);\n    return `<p>${markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;\n  }\n}\n\nexport function markdownToHtmlAsync(markdown: string): Promise<string> {\n  if (!markdown || markdown.trim() === '') {\n    return Promise.resolve('<p></p>');\n  }\n\n  const normalized = normalizeMarkdown(markdown);\n  \n  return unified()\n    .use(remarkParse)\n    .use(remarkGfm)\n    .use(remarkMath)\n    .use(remarkRehype, { allowDangerousHtml: true })\n    .use(rehypeKatex)\n    .use(rehypeStringify, { allowDangerousHtml: true })\n    .process(normalized)\n    .then(result => String(result) || '<p></p>')\n    .catch(error => {\n      console.error('[markdownToHtml] Parse error:', error);\n      return `<p>${markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;\n    });\n}\n\n/**\n * Converts markdown to HTML suitable for TipTap editor.\n * Unlike markdownToHtml, this function preserves $...$ and $$...$$ math delimiters\n * instead of rendering them with KaTeX. This allows TipTap's MathExtension to\n * properly handle the math content and preserve the LaTeX in node.attrs.latex.\n * \n * Use this function when loading content into TipTap editor.\n * Use markdownToHtml for display-only rendering (e.g., chat messages).\n */\nexport function markdownToTipTap(markdown: string): string {\n  if (!markdown || markdown.trim() === '') {\n    return '<p></p>';\n  }\n\n  const normalized = normalizeMarkdown(markdown);\n  \n  try {\n    const result = unified()\n      .use(remarkParse)\n      .use(remarkGfm)\n      .use(remarkMath)\n      .use(remarkRehype, { allowDangerousHtml: true })\n      .use(rehypePreserveMath) // Use our custom plugin instead of rehypeKatex\n      .use(rehypeStringify, { allowDangerousHtml: true })\n      .processSync(normalized);\n    \n    return String(result) || '<p></p>';\n  } catch (error) {\n    console.error('[markdownToTipTap] Parse error:', error);\n    return `<p>${markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;\n  }\n}\n","path":null,"size_bytes":9239,"size_tokens":null},"server/services/markdownToDocx.ts":{"content":"import { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, BorderStyle, AlignmentType, convertInchesToTwip, IRunOptions, Math as DocxMath } from \"docx\";\nimport { unified } from \"unified\";\nimport remarkParse from \"remark-parse\";\nimport remarkGfm from \"remark-gfm\";\nimport remarkMath from \"remark-math\";\nimport { convertLatex2Math, mathJaxReady } from \"@hungknguyen/docx-math-converter\";\nimport type { Root, Content, Text, Strong, Emphasis, InlineCode, Paragraph as MdParagraph, Heading, List, ListItem, Table as MdTable, TableRow as MdTableRow, TableCell as MdTableCell, Blockquote, Code, ThematicBreak, Link } from \"mdast\";\n\ninterface MathNode {\n  type: \"math\" | \"inlineMath\";\n  value: string;\n}\n\nlet mathJaxInitialized = false;\nasync function ensureMathJaxReady(): Promise<void> {\n  if (!mathJaxInitialized) {\n    await mathJaxReady;\n    mathJaxInitialized = true;\n  }\n}\n\nfunction normalizeMarkdown(text: string): string {\n  return text\n    .replace(/\\r\\n/g, \"\\n\")\n    .replace(/\\r/g, \"\\n\")\n    .replace(/\\n{3,}/g, \"\\n\\n\")\n    .trim();\n}\n\nfunction parseMarkdownToAst(markdown: string): Root {\n  let normalizedMd = normalizeMarkdown(markdown);\n  normalizedMd = normalizedMd.replace(/\\\\\\[/g, '$$').replace(/\\\\\\]/g, '$$');\n  normalizedMd = normalizedMd.replace(/\\\\\\(/g, '$').replace(/\\\\\\)/g, '$');\n  \n  const processor = unified()\n    .use(remarkParse)\n    .use(remarkGfm)\n    .use(remarkMath);\n  \n  return processor.parse(normalizedMd) as Root;\n}\n\ninterface TextRunOptions extends Partial<IRunOptions> {\n  text: string;\n}\n\ninterface MathRunMarker {\n  type: \"mathRun\";\n  latex: string;\n}\n\ntype ParagraphChild = TextRunOptions | MathRunMarker;\n\nfunction isMathRunMarker(item: ParagraphChild): item is MathRunMarker {\n  return (item as MathRunMarker).type === \"mathRun\";\n}\n\nfunction extractParagraphChildren(node: Content, inherited: Partial<IRunOptions> = {}): ParagraphChild[] {\n  const children: ParagraphChild[] = [];\n  \n  switch (node.type) {\n    case \"text\":\n      children.push({ text: (node as Text).value, ...inherited });\n      break;\n      \n    case \"strong\":\n      for (const child of (node as Strong).children) {\n        children.push(...extractParagraphChildren(child, { ...inherited, bold: true }));\n      }\n      break;\n      \n    case \"emphasis\":\n      for (const child of (node as Emphasis).children) {\n        children.push(...extractParagraphChildren(child, { ...inherited, italics: true }));\n      }\n      break;\n      \n    case \"inlineCode\":\n      children.push({ \n        text: (node as InlineCode).value, \n        ...inherited,\n        font: \"Consolas\",\n        shading: { fill: \"E8E8E8\", type: \"clear\", color: \"auto\" }\n      });\n      break;\n      \n    case \"inlineMath\":\n      children.push({ type: \"mathRun\", latex: (node as unknown as MathNode).value });\n      break;\n      \n    case \"link\":\n      const linkNode = node as Link;\n      for (const child of linkNode.children) {\n        children.push(...extractParagraphChildren(child, { ...inherited, color: \"0563C1\", underline: { type: \"single\" } }));\n      }\n      break;\n      \n    case \"break\":\n      children.push({ text: \"\", break: 1, ...inherited });\n      break;\n      \n    default:\n      if ('children' in node && Array.isArray((node as any).children)) {\n        for (const child of (node as any).children) {\n          children.push(...extractParagraphChildren(child as Content, inherited));\n        }\n      } else if ('value' in node) {\n        children.push({ text: String((node as any).value), ...inherited });\n      }\n  }\n  \n  return children;\n}\n\nfunction extractTextRuns(node: Content, inherited: Partial<IRunOptions> = {}): TextRunOptions[] {\n  const children = extractParagraphChildren(node, inherited);\n  return children.filter((c): c is TextRunOptions => !isMathRunMarker(c));\n}\n\nfunction createTextRuns(runOptions: TextRunOptions[]): TextRun[] {\n  return runOptions.map(opt => new TextRun(opt as IRunOptions));\n}\n\nasync function createParagraphChildren(children: ParagraphChild[]): Promise<(TextRun | DocxMath)[]> {\n  const result: (TextRun | DocxMath)[] = [];\n  \n  for (const child of children) {\n    if (isMathRunMarker(child)) {\n      try {\n        const mathElement = await convertLatex2Math(child.latex);\n        result.push(mathElement);\n      } catch (error) {\n        console.error('[markdownToDocx] Math conversion error:', error);\n        result.push(new TextRun({ text: child.latex, italics: true }));\n      }\n    } else {\n      result.push(new TextRun(child as IRunOptions));\n    }\n  }\n  \n  return result;\n}\n\nasync function processTableNode(tableNode: MdTable): Promise<Table> {\n  const rows: TableRow[] = [];\n  let maxCols = 0;\n  \n  for (const row of tableNode.children as MdTableRow[]) {\n    maxCols = Math.max(maxCols, row.children.length);\n  }\n  \n  for (let rowIndex = 0; rowIndex < tableNode.children.length; rowIndex++) {\n    const mdRow = tableNode.children[rowIndex] as MdTableRow;\n    const cells: TableCell[] = [];\n    \n    for (let i = 0; i < maxCols; i++) {\n      const cellNode = mdRow.children[i] as MdTableCell | undefined;\n      const paraChildren: ParagraphChild[] = [];\n      \n      if (cellNode) {\n        for (const child of cellNode.children) {\n          paraChildren.push(...extractParagraphChildren(child as Content));\n        }\n      }\n      \n      cells.push(new TableCell({\n        children: [new Paragraph({\n          children: paraChildren.length > 0 ? await createParagraphChildren(paraChildren) : [new TextRun({ text: \"\" })],\n          alignment: AlignmentType.LEFT,\n        })],\n        shading: rowIndex === 0 ? { fill: \"E7E6E6\", type: \"clear\", color: \"auto\" } : undefined,\n        borders: {\n          top: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n          bottom: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n          left: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n          right: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n        },\n      }));\n    }\n    \n    rows.push(new TableRow({ children: cells }));\n  }\n  \n  return new Table({\n    width: { size: 100, type: WidthType.PERCENTAGE },\n    rows,\n  });\n}\n\nasync function processListNode(listNode: List, level: number = 0): Promise<Paragraph[]> {\n  const paragraphs: Paragraph[] = [];\n  const isOrdered = listNode.ordered;\n  \n  for (const item of listNode.children as ListItem[]) {\n    for (const child of item.children) {\n      if (child.type === \"paragraph\") {\n        const paraChildren: ParagraphChild[] = [];\n        for (const inlineChild of (child as MdParagraph).children) {\n          paraChildren.push(...extractParagraphChildren(inlineChild as Content));\n        }\n        \n        const para = new Paragraph({\n          children: await createParagraphChildren(paraChildren),\n          ...(isOrdered \n            ? { numbering: { reference: \"numbered-list\", level } }\n            : { bullet: { level } }\n          ),\n          spacing: { after: 80 },\n        });\n        paragraphs.push(para);\n      } else if (child.type === \"list\") {\n        paragraphs.push(...await processListNode(child as List, level + 1));\n      }\n    }\n  }\n  \n  return paragraphs;\n}\n\nasync function processBlockquote(node: Blockquote): Promise<Paragraph[]> {\n  const paragraphs: Paragraph[] = [];\n  \n  for (const child of node.children) {\n    if (child.type === \"paragraph\") {\n      const paraChildren: ParagraphChild[] = [];\n      for (const inlineChild of (child as MdParagraph).children) {\n        paraChildren.push(...extractParagraphChildren(inlineChild as Content));\n      }\n      \n      paragraphs.push(new Paragraph({\n        children: await createParagraphChildren(paraChildren),\n        indent: { left: convertInchesToTwip(0.5) },\n        border: {\n          left: { style: BorderStyle.SINGLE, size: 24, color: \"CCCCCC\" },\n        },\n        spacing: { after: 100 },\n      }));\n    }\n  }\n  \n  return paragraphs;\n}\n\nasync function astToDocxElements(ast: Root): Promise<(Paragraph | Table)[]> {\n  const elements: (Paragraph | Table)[] = [];\n  \n  for (const node of ast.children) {\n    switch (node.type) {\n      case \"heading\": {\n        const headingNode = node as Heading;\n        const paraChildren: ParagraphChild[] = [];\n        for (const child of headingNode.children) {\n          paraChildren.push(...extractParagraphChildren(child as Content));\n        }\n        \n        const headingLevelMap: Record<number, typeof HeadingLevel[keyof typeof HeadingLevel]> = {\n          1: HeadingLevel.HEADING_1,\n          2: HeadingLevel.HEADING_2,\n          3: HeadingLevel.HEADING_3,\n          4: HeadingLevel.HEADING_4,\n          5: HeadingLevel.HEADING_5,\n          6: HeadingLevel.HEADING_6,\n        };\n        \n        elements.push(new Paragraph({\n          children: await createParagraphChildren(paraChildren),\n          heading: headingLevelMap[headingNode.depth] || HeadingLevel.HEADING_1,\n          spacing: { before: headingNode.depth === 1 ? 400 : 300, after: 200 },\n        }));\n        break;\n      }\n      \n      case \"paragraph\": {\n        const paraNode = node as MdParagraph;\n        const paraChildren: ParagraphChild[] = [];\n        for (const child of paraNode.children) {\n          paraChildren.push(...extractParagraphChildren(child as Content));\n        }\n        \n        if (paraChildren.length > 0) {\n          elements.push(new Paragraph({\n            children: await createParagraphChildren(paraChildren),\n            spacing: { after: 200, line: 276 },\n          }));\n        }\n        break;\n      }\n      \n      case \"math\": {\n        const mathNode = node as unknown as MathNode;\n        try {\n          const mathElement = await convertLatex2Math(mathNode.value);\n          elements.push(new Paragraph({\n            children: [mathElement],\n            spacing: { before: 200, after: 200 },\n            alignment: AlignmentType.CENTER,\n          }));\n        } catch (error) {\n          console.error('[markdownToDocx] Block math conversion error:', error);\n          elements.push(new Paragraph({\n            children: [new TextRun({ text: mathNode.value, italics: true })],\n            spacing: { after: 200 },\n            alignment: AlignmentType.CENTER,\n          }));\n        }\n        break;\n      }\n      \n      case \"list\": {\n        elements.push(...await processListNode(node as List));\n        break;\n      }\n      \n      case \"table\": {\n        elements.push(await processTableNode(node as MdTable));\n        elements.push(new Paragraph({ spacing: { after: 200 } }));\n        break;\n      }\n      \n      case \"blockquote\": {\n        elements.push(...await processBlockquote(node as Blockquote));\n        break;\n      }\n      \n      case \"code\": {\n        const codeNode = node as Code;\n        const codeLines = codeNode.value.split(\"\\n\");\n        \n        for (const line of codeLines) {\n          elements.push(new Paragraph({\n            children: [new TextRun({\n              text: line || \" \",\n              font: \"Consolas\",\n              size: 20,\n            })],\n            shading: { fill: \"F5F5F5\", type: \"clear\", color: \"auto\" },\n            spacing: { after: 0 },\n            indent: { left: convertInchesToTwip(0.25) },\n          }));\n        }\n        elements.push(new Paragraph({ spacing: { after: 200 } }));\n        break;\n      }\n      \n      case \"thematicBreak\": {\n        elements.push(new Paragraph({\n          border: { bottom: { style: BorderStyle.SINGLE, size: 6, color: \"CCCCCC\" } },\n          spacing: { before: 200, after: 200 },\n        }));\n        break;\n      }\n      \n      default:\n        break;\n    }\n  }\n  \n  return elements;\n}\n\nexport async function generateWordFromMarkdown(title: string, content: string): Promise<Buffer> {\n  await ensureMathJaxReady();\n  \n  const ast = parseMarkdownToAst(content);\n  const bodyElements = await astToDocxElements(ast);\n  \n  const titleParagraph = new Paragraph({\n    children: [new TextRun({ text: title, bold: true, size: 48 })],\n    heading: HeadingLevel.TITLE,\n    spacing: { after: 400 },\n    alignment: AlignmentType.CENTER,\n  });\n  \n  const doc = new Document({\n    numbering: {\n      config: [{\n        reference: \"numbered-list\",\n        levels: [\n          {\n            level: 0,\n            format: \"decimal\",\n            text: \"%1.\",\n            alignment: AlignmentType.START,\n            style: { paragraph: { indent: { left: convertInchesToTwip(0.5), hanging: convertInchesToTwip(0.25) } } },\n          },\n          {\n            level: 1,\n            format: \"lowerLetter\",\n            text: \"%2.\",\n            alignment: AlignmentType.START,\n            style: { paragraph: { indent: { left: convertInchesToTwip(1), hanging: convertInchesToTwip(0.25) } } },\n          },\n        ],\n      }],\n    },\n    styles: {\n      paragraphStyles: [\n        {\n          id: \"Normal\",\n          name: \"Normal\",\n          basedOn: \"Normal\",\n          next: \"Normal\",\n          run: { font: \"Calibri\", size: 24 },\n          paragraph: { spacing: { line: 276 } },\n        },\n      ],\n    },\n    sections: [{\n      properties: {\n        page: {\n          margin: {\n            top: convertInchesToTwip(1),\n            right: convertInchesToTwip(1),\n            bottom: convertInchesToTwip(1),\n            left: convertInchesToTwip(1),\n          },\n        },\n      },\n      children: [titleParagraph, ...bodyElements],\n    }],\n  });\n  \n  return await Packer.toBuffer(doc);\n}\n\nexport { normalizeMarkdown, parseMarkdownToAst };\n","path":null,"size_bytes":13428,"size_tokens":null},"client/src/styles/document-editor.css":{"content":"/* Document Editor Styles */\n\n/* Template: Emily Anderson */\n.template-emily {\n  font-family: 'Inter', system-ui, sans-serif;\n  color: #374151;\n  line-height: 1.6;\n}\n\n.template-emily h1 {\n  font-family: 'Georgia', serif;\n  font-size: 3rem;\n  font-weight: 700;\n  font-style: italic;\n  color: #0d9488;\n  margin-bottom: 1.5rem;\n  line-height: 1.2;\n}\n\n.template-emily h2 {\n  font-family: 'Inter', sans-serif;\n  font-size: 1.25rem;\n  font-weight: 700;\n  color: #0d9488;\n  margin-top: 2rem;\n  margin-bottom: 0.75rem;\n  border-bottom: none;\n}\n\n.template-emily h3 {\n  font-family: 'Inter', sans-serif;\n  font-size: 1rem;\n  font-weight: 700;\n  color: #1f2937;\n  margin-top: 1rem;\n  margin-bottom: 0.5rem;\n}\n\n.template-emily p {\n  font-size: 0.875rem;\n  margin-bottom: 0.75rem;\n  color: #4b5563;\n}\n\n.template-emily ul {\n  list-style-type: disc;\n  padding-left: 1.25rem;\n  margin-bottom: 1rem;\n}\n\n.template-emily ol {\n  list-style-type: decimal;\n  padding-left: 1.25rem;\n  margin-bottom: 1rem;\n}\n\n.template-emily li {\n  font-size: 0.875rem;\n  margin-bottom: 0.25rem;\n  color: #4b5563;\n}\n\n.template-emily blockquote {\n  border-left: 3px solid #0d9488;\n  padding-left: 1rem;\n  margin: 1rem 0;\n  font-style: italic;\n  color: #6b7280;\n}\n\n.template-emily strong {\n  font-weight: 700;\n  color: #1f2937;\n}\n\n.template-emily em {\n  font-style: italic;\n}\n\n.template-emily a {\n  color: #0d9488;\n  text-decoration: underline;\n}\n\n.template-emily hr {\n  border: none;\n  border-top: 1px solid #e5e7eb;\n  margin: 1.5rem 0;\n}\n\n.template-emily table {\n  width: 100%;\n  border-collapse: collapse;\n  margin: 1rem 0;\n}\n\n.template-emily th,\n.template-emily td {\n  border: 1px solid #e5e7eb;\n  padding: 0.5rem 0.75rem;\n  text-align: left;\n  font-size: 0.875rem;\n}\n\n.template-emily th {\n  background-color: #f9fafb;\n  font-weight: 600;\n}\n\n/* Page A4 styling */\n.page-container {\n  width: 794px;\n  min-height: 1123px;\n  background: #f7f4ef;\n  border-radius: 8px;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n  padding: 70px 80px;\n  margin: 24px auto;\n}\n\n.page-container .ProseMirror {\n  outline: none;\n  min-height: 100%;\n}\n\n/* Canvas area background */\n.canvas-area {\n  background: linear-gradient(135deg, #e5e5e5 0%, #d4d4d4 100%);\n  overflow-y: auto;\n  flex: 1;\n  padding: 0;\n}\n\n.dark .canvas-area {\n  background: linear-gradient(135deg, #1f2937 0%, #111827 100%);\n}\n\n.dark .page-container {\n  background: #1f2937;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);\n}\n\n.page-container .ProseMirror p.is-editor-empty:first-child::before {\n  color: #9ca3af;\n  content: attr(data-placeholder);\n  float: left;\n  height: 0;\n  pointer-events: none;\n}\n\n/* Selection styling */\n.page-container .ProseMirror ::selection {\n  background: rgba(13, 148, 136, 0.2);\n}\n\n/* Focus styling for editable elements */\n.page-container .ProseMirror:focus-visible {\n  outline: none;\n}\n\n/* Cursor styling */\n.page-container .ProseMirror .ProseMirror-cursor {\n  border-left: 2px solid #0d9488;\n}\n\n/* Two column layout support */\n.template-emily .two-columns {\n  display: grid;\n  grid-template-columns: 1fr 1.5fr;\n  gap: 2rem;\n  margin-top: 1.5rem;\n}\n\n.template-emily .column-left,\n.template-emily .column-right {\n  min-width: 0;\n}\n\n/* Sidebar styling */\n.document-editor-container .sidebar {\n  background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);\n}\n\n.document-editor-container .sidebar h2 {\n  color: #1f2937;\n}\n\n/* Canvas area background */\n.document-editor-container .canvas-area {\n  background: linear-gradient(135deg, #e5e5e5 0%, #d4d4d4 100%);\n}\n\n/* Dark mode adjustments */\n.dark .template-emily {\n  color: #e5e7eb;\n}\n\n.dark .template-emily h1,\n.dark .template-emily h2 {\n  color: #5eead4;\n}\n\n.dark .template-emily h3 {\n  color: #f3f4f6;\n}\n\n.dark .template-emily p,\n.dark .template-emily li {\n  color: #d1d5db;\n}\n\n.dark .template-emily blockquote {\n  border-left-color: #5eead4;\n  color: #9ca3af;\n}\n\n.dark .template-emily strong {\n  color: #f9fafb;\n}\n\n.dark .page-container {\n  background: #1f2937 !important;\n}\n\n.dark .document-editor-container .sidebar {\n  background: linear-gradient(180deg, #1f2937 0%, #111827 100%);\n}\n\n.dark .document-editor-container .canvas-area {\n  background: linear-gradient(135deg, #111827 0%, #0f172a 100%);\n}\n\n/* Toolbar active states */\n.toolbar button.active,\n.toolbar button[data-active=\"true\"] {\n  background-color: #e5e7eb;\n}\n\n.dark .toolbar button.active,\n.dark .toolbar button[data-active=\"true\"] {\n  background-color: #374151;\n}\n\n/* Animation for AI Rewrite panel */\n@keyframes slideInFromBottom {\n  from {\n    opacity: 0;\n    transform: translateY(20px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.ai-rewrite-panel {\n  animation: slideInFromBottom 0.2s ease-out;\n}\n\n/* ========================================\n   SPREADSHEET EDITOR STYLES\n======================================== */\n\n.spreadsheet-editor {\n  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n}\n\n.spreadsheet-table {\n  border-collapse: collapse;\n  table-layout: fixed;\n  font-size: 13px;\n}\n\n/* Corner cell (top-left) */\n.spreadsheet-corner-cell {\n  width: 50px;\n  min-width: 50px;\n  height: 28px;\n  background: #f8f8f8;\n  border: 1px solid #e0e0e0;\n  position: sticky;\n  left: 0;\n  z-index: 20;\n}\n\n.dark .spreadsheet-corner-cell {\n  background: #1a1a1a;\n  border-color: #333;\n}\n\n/* Column headers (A, B, C...) */\n.spreadsheet-col-header {\n  width: 100px;\n  min-width: 100px;\n  height: 28px;\n  background: #f8f8f8;\n  border: 1px solid #e0e0e0;\n  font-weight: 500;\n  font-size: 12px;\n  color: #666;\n  text-align: center;\n  user-select: none;\n}\n\n.dark .spreadsheet-col-header {\n  background: #1a1a1a;\n  border-color: #333;\n  color: #888;\n}\n\n/* Row headers (1, 2, 3...) */\n.spreadsheet-row-header {\n  width: 50px;\n  min-width: 50px;\n  height: 24px;\n  background: #f8f8f8;\n  border: 1px solid #e0e0e0;\n  font-weight: 500;\n  font-size: 12px;\n  color: #666;\n  text-align: center;\n  user-select: none;\n  position: sticky;\n  left: 0;\n  z-index: 10;\n}\n\n.dark .spreadsheet-row-header {\n  background: #1a1a1a;\n  border-color: #333;\n  color: #888;\n}\n\n/* Data cells */\n.spreadsheet-cell {\n  width: 100px;\n  min-width: 100px;\n  height: 24px;\n  border: 1px solid #e0e0e0;\n  padding: 0;\n  background: #fff;\n  cursor: cell;\n  position: relative;\n  overflow: hidden;\n}\n\n.dark .spreadsheet-cell {\n  background: #0a0a0a;\n  border-color: #333;\n}\n\n.spreadsheet-cell:hover {\n  background: #f5f5f5;\n}\n\n.dark .spreadsheet-cell:hover {\n  background: #151515;\n}\n\n/* Selected cell */\n.spreadsheet-cell-selected {\n  outline: 2px solid #000 !important;\n  outline-offset: -1px;\n  z-index: 5;\n}\n\n.dark .spreadsheet-cell-selected {\n  outline-color: #fff !important;\n}\n\n/* Cell content */\n.spreadsheet-cell-content {\n  display: block;\n  padding: 2px 6px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  height: 100%;\n  line-height: 20px;\n}\n\n/* Cell input (editing mode) */\n.spreadsheet-cell-input {\n  width: 100%;\n  height: 100%;\n  border: none;\n  outline: none;\n  padding: 2px 6px;\n  font-size: 13px;\n  font-family: inherit;\n  background: #fff;\n}\n\n.dark .spreadsheet-cell-input {\n  background: #0a0a0a;\n  color: #fff;\n}\n\n/* Spreadsheet scrollbar */\n.spreadsheet-editor ::-webkit-scrollbar {\n  width: 12px;\n  height: 12px;\n}\n\n.spreadsheet-editor ::-webkit-scrollbar-track {\n  background: #f0f0f0;\n}\n\n.dark .spreadsheet-editor ::-webkit-scrollbar-track {\n  background: #1a1a1a;\n}\n\n.spreadsheet-editor ::-webkit-scrollbar-thumb {\n  background: #c0c0c0;\n  border-radius: 6px;\n  border: 3px solid #f0f0f0;\n}\n\n.dark .spreadsheet-editor ::-webkit-scrollbar-thumb {\n  background: #444;\n  border-color: #1a1a1a;\n}\n\n.spreadsheet-editor ::-webkit-scrollbar-thumb:hover {\n  background: #999;\n}\n\n.dark .spreadsheet-editor ::-webkit-scrollbar-thumb:hover {\n  background: #666;\n}\n\n/* Selection highlight for multiple cells */\n.spreadsheet-cell-in-range {\n  background: rgba(0, 0, 0, 0.05);\n}\n\n.dark .spreadsheet-cell-in-range {\n  background: rgba(255, 255, 255, 0.05);\n}\n","path":null,"size_bytes":7943,"size_tokens":null},"client/src/components/gpt-builder.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  Bot, \n  Settings2, \n  MessageSquare, \n  Plus,\n  X,\n  Save,\n  Trash2,\n  Copy,\n  Globe,\n  Lock,\n  Link as LinkIcon\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Gpt } from \"./gpt-explorer\";\n\ninterface GptBuilderProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  editingGpt?: Gpt | null;\n  onSave?: (gpt: Gpt) => void;\n}\n\nexport function GptBuilder({ open, onOpenChange, editingGpt, onSave }: GptBuilderProps) {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"create\");\n  const [saving, setSaving] = useState(false);\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    slug: \"\",\n    description: \"\",\n    systemPrompt: \"\",\n    welcomeMessage: \"\",\n    temperature: 0.7,\n    topP: 1,\n    maxTokens: 4096,\n    visibility: \"private\" as \"private\" | \"public\" | \"unlisted\",\n    conversationStarters: [\"\", \"\", \"\", \"\"],\n    capabilities: {\n      webBrowsing: true,\n      codeInterpreter: true,\n      imageGeneration: false,\n      wordCreation: true,\n      excelCreation: true,\n      pptCreation: true\n    }\n  });\n\n  useEffect(() => {\n    if (editingGpt) {\n      setFormData({\n        name: editingGpt.name,\n        slug: editingGpt.slug,\n        description: editingGpt.description || \"\",\n        systemPrompt: editingGpt.systemPrompt,\n        welcomeMessage: editingGpt.welcomeMessage || \"\",\n        temperature: parseFloat(editingGpt.temperature || \"0.7\"),\n        topP: parseFloat(editingGpt.topP || \"1\"),\n        maxTokens: editingGpt.maxTokens || 4096,\n        visibility: (editingGpt.visibility as \"private\" | \"public\" | \"unlisted\") || \"private\",\n        conversationStarters: Array.isArray(editingGpt.conversationStarters) \n          ? [...editingGpt.conversationStarters, \"\", \"\", \"\", \"\"].slice(0, 4)\n          : [\"\", \"\", \"\", \"\"],\n        capabilities: editingGpt.capabilities || {\n          webBrowsing: true,\n          codeInterpreter: true,\n          imageGeneration: false,\n          wordCreation: true,\n          excelCreation: true,\n          pptCreation: true\n        }\n      });\n    } else {\n      setFormData({\n        name: \"\",\n        slug: \"\",\n        description: \"\",\n        systemPrompt: \"\",\n        welcomeMessage: \"\",\n        temperature: 0.7,\n        topP: 1,\n        maxTokens: 4096,\n        visibility: \"private\",\n        conversationStarters: [\"\", \"\", \"\", \"\"],\n        capabilities: {\n          webBrowsing: true,\n          codeInterpreter: true,\n          imageGeneration: false,\n          wordCreation: true,\n          excelCreation: true,\n          pptCreation: true\n        }\n      });\n    }\n  }, [editingGpt, open]);\n\n  const generateSlug = (name: string, addSuffix = false) => {\n    let slug = name\n      .toLowerCase()\n      .normalize(\"NFD\")\n      .replace(/[\\u0300-\\u036f]/g, \"\")\n      .replace(/[^a-z0-9]+/g, \"-\")\n      .replace(/^-|-$/g, \"\");\n    \n    if (addSuffix) {\n      slug += \"-\" + Date.now().toString(36);\n    }\n    return slug;\n  };\n\n  const handleNameChange = (name: string) => {\n    setFormData(prev => ({\n      ...prev,\n      name,\n      slug: editingGpt ? prev.slug : generateSlug(name)\n    }));\n  };\n\n  const handleSave = async () => {\n    if (!formData.name.trim()) {\n      toast({ title: \"Error\", description: \"El nombre es requerido\", variant: \"destructive\" });\n      return;\n    }\n    if (!formData.systemPrompt.trim()) {\n      toast({ title: \"Error\", description: \"Las instrucciones son requeridas\", variant: \"destructive\" });\n      return;\n    }\n\n    try {\n      setSaving(true);\n      \n      const cleanedStarters = formData.conversationStarters.filter(s => s.trim());\n      \n      const payload = {\n        name: formData.name,\n        slug: formData.slug || generateSlug(formData.name),\n        description: formData.description || null,\n        systemPrompt: formData.systemPrompt,\n        welcomeMessage: formData.welcomeMessage || null,\n        temperature: formData.temperature.toString(),\n        topP: formData.topP.toString(),\n        maxTokens: formData.maxTokens,\n        visibility: formData.visibility,\n        conversationStarters: cleanedStarters.length > 0 ? cleanedStarters : null,\n        capabilities: formData.capabilities,\n        isPublished: formData.visibility === \"public\" ? \"true\" : \"false\"\n      };\n\n      let response;\n      if (editingGpt) {\n        response = await fetch(`/api/gpts/${editingGpt.id}`, {\n          method: \"PATCH\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(payload)\n        });\n      } else {\n        response = await fetch(\"/api/gpts\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(payload)\n        });\n        \n        if (response.status === 409) {\n          payload.slug = generateSlug(formData.name, true);\n          response = await fetch(\"/api/gpts\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify(payload)\n          });\n        }\n      }\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Error al guardar\");\n      }\n\n      const savedGpt = await response.json();\n      toast({ \n        title: editingGpt ? \"GPT actualizado\" : \"GPT creado\",\n        description: `${savedGpt.name} ha sido ${editingGpt ? \"actualizado\" : \"creado\"} exitosamente.`\n      });\n      \n      onSave?.(savedGpt);\n      onOpenChange(false);\n    } catch (error: any) {\n      toast({ \n        title: \"Error\", \n        description: error.message || \"No se pudo guardar el GPT\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleDelete = async () => {\n    if (!editingGpt) return;\n    \n    if (!confirm(\"¿Estás seguro de que deseas eliminar este GPT?\")) return;\n\n    try {\n      const response = await fetch(`/api/gpts/${editingGpt.id}`, {\n        method: \"DELETE\"\n      });\n\n      if (!response.ok) throw new Error(\"Error al eliminar\");\n\n      toast({ title: \"GPT eliminado\", description: \"El GPT ha sido eliminado exitosamente.\" });\n      onOpenChange(false);\n    } catch (error) {\n      toast({ \n        title: \"Error\", \n        description: \"No se pudo eliminar el GPT\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"w-[100vw] max-w-[100vw] h-[100vh] p-0 gap-0 overflow-hidden rounded-none\" data-testid=\"gpt-builder-dialog\">\n        <div className=\"flex h-full overflow-hidden\">\n          <div className=\"flex-1 flex flex-col min-h-0\">\n            <div className=\"flex items-center justify-between px-6 py-4 border-b\">\n              <div className=\"flex items-center gap-4\">\n                <Tabs value={activeTab} onValueChange={setActiveTab}>\n                  <TabsList className=\"bg-muted/50\">\n                    <TabsTrigger value=\"create\" data-testid=\"tab-create\">Crear</TabsTrigger>\n                    <TabsTrigger value=\"configure\" data-testid=\"tab-configure\">Configurar</TabsTrigger>\n                  </TabsList>\n                </Tabs>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {editingGpt && (\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\"\n                    onClick={handleDelete}\n                    className=\"text-destructive hover:text-destructive\"\n                    data-testid=\"button-delete-gpt\"\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                )}\n                <Button \n                  onClick={handleSave}\n                  disabled={saving}\n                  data-testid=\"button-save-gpt\"\n                >\n                  <Save className=\"h-4 w-4 mr-2\" />\n                  {saving ? \"Guardando...\" : \"Guardar\"}\n                </Button>\n              </div>\n            </div>\n\n            <ScrollArea className=\"flex-1\">\n              <div className=\"p-6 space-y-6\">\n                {activeTab === \"create\" && (\n                  <>\n                    <div className=\"flex items-start gap-4\">\n                      <div className=\"w-20 h-20 rounded-xl bg-muted flex items-center justify-center cursor-pointer hover:bg-muted/80 transition-colors\">\n                        <Bot className=\"h-10 w-10 text-muted-foreground\" />\n                      </div>\n                      <div className=\"flex-1 space-y-4\">\n                        <div>\n                          <Label htmlFor=\"name\">Nombre</Label>\n                          <Input\n                            id=\"name\"\n                            placeholder=\"Ej: Asistente de Investigación\"\n                            value={formData.name}\n                            onChange={(e) => handleNameChange(e.target.value)}\n                            className=\"mt-1\"\n                            data-testid=\"input-gpt-name\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"slug\">Identificador (slug)</Label>\n                          <Input\n                            id=\"slug\"\n                            placeholder=\"asistente-investigacion\"\n                            value={formData.slug}\n                            onChange={(e) => setFormData(prev => ({ ...prev, slug: e.target.value }))}\n                            className=\"mt-1\"\n                            disabled={!!editingGpt}\n                            data-testid=\"input-gpt-slug\"\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"description\">Descripción</Label>\n                      <Textarea\n                        id=\"description\"\n                        placeholder=\"Una breve descripción de lo que hace este GPT...\"\n                        value={formData.description}\n                        onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\n                        className=\"mt-1 min-h-[80px]\"\n                        data-testid=\"input-gpt-description\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"systemPrompt\">Instrucciones</Label>\n                      <p className=\"text-sm text-muted-foreground mb-2\">\n                        ¿Qué hace este GPT? ¿Cómo se comporta? ¿Qué debe evitar hacer?\n                      </p>\n                      <Textarea\n                        id=\"systemPrompt\"\n                        placeholder=\"Eres un asistente especializado en investigación académica. Tu rol es ayudar a los usuarios a encontrar fuentes confiables, estructurar sus argumentos y redactar contenido académico de alta calidad...\"\n                        value={formData.systemPrompt}\n                        onChange={(e) => setFormData(prev => ({ ...prev, systemPrompt: e.target.value }))}\n                        className=\"mt-1 min-h-[200px] font-mono text-sm\"\n                        data-testid=\"input-gpt-system-prompt\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label>Iniciadores de conversación</Label>\n                      <p className=\"text-sm text-muted-foreground mb-2\">\n                        Sugerencias que aparecerán al inicio de la conversación.\n                      </p>\n                      <div className=\"space-y-2\">\n                        {formData.conversationStarters.map((starter, index) => (\n                          <Input\n                            key={index}\n                            placeholder={`Iniciador ${index + 1}`}\n                            value={starter}\n                            onChange={(e) => {\n                              const newStarters = [...formData.conversationStarters];\n                              newStarters[index] = e.target.value;\n                              setFormData(prev => ({ ...prev, conversationStarters: newStarters }));\n                            }}\n                            data-testid={`input-starter-${index}`}\n                          />\n                        ))}\n                      </div>\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"welcomeMessage\">Mensaje de bienvenida</Label>\n                      <Textarea\n                        id=\"welcomeMessage\"\n                        placeholder=\"¡Hola! Soy tu asistente de investigación. ¿En qué tema te gustaría profundizar hoy?\"\n                        value={formData.welcomeMessage}\n                        onChange={(e) => setFormData(prev => ({ ...prev, welcomeMessage: e.target.value }))}\n                        className=\"mt-1\"\n                        data-testid=\"input-gpt-welcome\"\n                      />\n                    </div>\n                  </>\n                )}\n\n                {activeTab === \"configure\" && (\n                  <>\n                    <div className=\"space-y-6\">\n                      <div>\n                        <Label>Visibilidad</Label>\n                        <div className=\"flex gap-2 mt-2\">\n                          <Button\n                            variant={formData.visibility === \"private\" ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            onClick={() => setFormData(prev => ({ ...prev, visibility: \"private\" }))}\n                            data-testid=\"button-visibility-private\"\n                          >\n                            <Lock className=\"h-4 w-4 mr-2\" />\n                            Privado\n                          </Button>\n                          <Button\n                            variant={formData.visibility === \"unlisted\" ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            onClick={() => setFormData(prev => ({ ...prev, visibility: \"unlisted\" }))}\n                            data-testid=\"button-visibility-unlisted\"\n                          >\n                            <LinkIcon className=\"h-4 w-4 mr-2\" />\n                            Solo con enlace\n                          </Button>\n                          <Button\n                            variant={formData.visibility === \"public\" ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            onClick={() => setFormData(prev => ({ ...prev, visibility: \"public\" }))}\n                            data-testid=\"button-visibility-public\"\n                          >\n                            <Globe className=\"h-4 w-4 mr-2\" />\n                            Público\n                          </Button>\n                        </div>\n                      </div>\n\n                      <div>\n                        <Label>Temperatura: {formData.temperature.toFixed(1)}</Label>\n                        <p className=\"text-sm text-muted-foreground mb-2\">\n                          Controla la creatividad de las respuestas. Mayor = más creativo, menor = más predecible.\n                        </p>\n                        <Slider\n                          value={[formData.temperature]}\n                          onValueChange={([value]) => setFormData(prev => ({ ...prev, temperature: value }))}\n                          min={0}\n                          max={2}\n                          step={0.1}\n                          className=\"mt-2\"\n                          data-testid=\"slider-temperature\"\n                        />\n                      </div>\n\n                      <div>\n                        <Label>Top P: {formData.topP.toFixed(1)}</Label>\n                        <p className=\"text-sm text-muted-foreground mb-2\">\n                          Controla la diversidad de tokens. Valores más bajos hacen las respuestas más enfocadas.\n                        </p>\n                        <Slider\n                          value={[formData.topP]}\n                          onValueChange={([value]) => setFormData(prev => ({ ...prev, topP: value }))}\n                          min={0}\n                          max={1}\n                          step={0.05}\n                          className=\"mt-2\"\n                          data-testid=\"slider-top-p\"\n                        />\n                      </div>\n\n                      <div>\n                        <Label>Tokens máximos: {formData.maxTokens}</Label>\n                        <p className=\"text-sm text-muted-foreground mb-2\">\n                          Límite de tokens para cada respuesta.\n                        </p>\n                        <Slider\n                          value={[formData.maxTokens]}\n                          onValueChange={([value]) => setFormData(prev => ({ ...prev, maxTokens: value }))}\n                          min={256}\n                          max={8192}\n                          step={256}\n                          className=\"mt-2\"\n                          data-testid=\"slider-max-tokens\"\n                        />\n                      </div>\n\n                      <div className=\"space-y-4\">\n                        <Label>Capacidades</Label>\n                        \n                        <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n                          <div>\n                            <p className=\"font-medium\">Navegación web</p>\n                            <p className=\"text-sm text-muted-foreground\">Permite buscar información en internet.</p>\n                          </div>\n                          <Switch\n                            checked={formData.capabilities.webBrowsing}\n                            onCheckedChange={(checked) => setFormData(prev => ({\n                              ...prev,\n                              capabilities: { ...prev.capabilities, webBrowsing: checked }\n                            }))}\n                            data-testid=\"switch-web-browsing\"\n                          />\n                        </div>\n\n                        <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n                          <div>\n                            <p className=\"font-medium\">Intérprete de código</p>\n                            <p className=\"text-sm text-muted-foreground\">Permite ejecutar código Python.</p>\n                          </div>\n                          <Switch\n                            checked={formData.capabilities.codeInterpreter}\n                            onCheckedChange={(checked) => setFormData(prev => ({\n                              ...prev,\n                              capabilities: { ...prev.capabilities, codeInterpreter: checked }\n                            }))}\n                            data-testid=\"switch-code-interpreter\"\n                          />\n                        </div>\n\n                        <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n                          <div>\n                            <p className=\"font-medium\">Generación de imágenes</p>\n                            <p className=\"text-sm text-muted-foreground\">Permite crear imágenes con DALL-E.</p>\n                          </div>\n                          <Switch\n                            checked={formData.capabilities.imageGeneration}\n                            onCheckedChange={(checked) => setFormData(prev => ({\n                              ...prev,\n                              capabilities: { ...prev.capabilities, imageGeneration: checked }\n                            }))}\n                            data-testid=\"switch-image-generation\"\n                          />\n                        </div>\n\n                        <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n                          <div>\n                            <p className=\"font-medium\">Crear en Word</p>\n                            <p className=\"text-sm text-muted-foreground\">Permite crear documentos de Word.</p>\n                          </div>\n                          <Switch\n                            checked={formData.capabilities.wordCreation}\n                            onCheckedChange={(checked) => setFormData(prev => ({\n                              ...prev,\n                              capabilities: { ...prev.capabilities, wordCreation: checked }\n                            }))}\n                            data-testid=\"switch-word-creation\"\n                          />\n                        </div>\n\n                        <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n                          <div>\n                            <p className=\"font-medium\">Crear en Excel</p>\n                            <p className=\"text-sm text-muted-foreground\">Permite crear hojas de cálculo en Excel.</p>\n                          </div>\n                          <Switch\n                            checked={formData.capabilities.excelCreation}\n                            onCheckedChange={(checked) => setFormData(prev => ({\n                              ...prev,\n                              capabilities: { ...prev.capabilities, excelCreation: checked }\n                            }))}\n                            data-testid=\"switch-excel-creation\"\n                          />\n                        </div>\n\n                        <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n                          <div>\n                            <p className=\"font-medium\">Crear en PowerPoint</p>\n                            <p className=\"text-sm text-muted-foreground\">Permite crear presentaciones de PowerPoint.</p>\n                          </div>\n                          <Switch\n                            checked={formData.capabilities.pptCreation}\n                            onCheckedChange={(checked) => setFormData(prev => ({\n                              ...prev,\n                              capabilities: { ...prev.capabilities, pptCreation: checked }\n                            }))}\n                            data-testid=\"switch-ppt-creation\"\n                          />\n                        </div>\n                      </div>\n                    </div>\n                  </>\n                )}\n              </div>\n            </ScrollArea>\n          </div>\n\n          <div className=\"w-80 border-l bg-muted/30 flex flex-col\">\n            <div className=\"p-4 border-b\">\n              <h3 className=\"font-medium\">Vista previa</h3>\n            </div>\n            <ScrollArea className=\"flex-1\">\n              <div className=\"p-4\">\n                <div className=\"bg-background rounded-lg p-4 space-y-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"w-10 h-10 rounded-lg bg-muted flex items-center justify-center\">\n                      <Bot className=\"h-5 w-5 text-muted-foreground\" />\n                    </div>\n                    <div>\n                      <p className=\"font-medium\">{formData.name || \"Nombre del GPT\"}</p>\n                      <p className=\"text-xs text-muted-foreground\">{formData.description || \"Sin descripción\"}</p>\n                    </div>\n                  </div>\n                  \n                  {formData.welcomeMessage && (\n                    <div className=\"bg-muted rounded-lg p-3 text-sm\">\n                      {formData.welcomeMessage}\n                    </div>\n                  )}\n\n                  {formData.conversationStarters.some(s => s.trim()) && (\n                    <div className=\"space-y-2\">\n                      {formData.conversationStarters.filter(s => s.trim()).map((starter, index) => (\n                        <button\n                          key={index}\n                          className=\"w-full text-left p-2 border rounded-lg text-sm hover:bg-muted/50 transition-colors\"\n                        >\n                          {starter}\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </div>\n            </ScrollArea>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":24907,"size_tokens":null},"server/services/documentGeneration.ts":{"content":"import ExcelJS from \"exceljs\";\nimport PptxGenJS from \"pptxgenjs\";\nimport { JSDOM } from \"jsdom\";\nimport { generateWordFromMarkdown } from \"./markdownToDocx\";\n\nexport interface DocumentContent {\n  title: string;\n  type: \"word\" | \"excel\" | \"ppt\";\n  content: any;\n}\n\nfunction isHtmlContent(content: string): boolean {\n  return /<[a-z][\\s\\S]*>/i.test(content);\n}\n\nfunction htmlToMarkdown(html: string): string {\n  const dom = new JSDOM(html);\n  const document = dom.window.document;\n  \n  const katexElements = document.querySelectorAll('.katex');\n  katexElements.forEach((katex) => {\n    const annotation = katex.querySelector('annotation[encoding=\"application/x-tex\"]');\n    if (annotation && annotation.textContent) {\n      const latex = annotation.textContent;\n      const isBlock = katex.closest('.math-display') || \n                     katex.closest('div.katex') ||\n                     katex.closest('span.katex-display');\n      const replacement = document.createTextNode(isBlock ? `$$${latex}$$` : `$${latex}$`);\n      katex.replaceWith(replacement);\n    }\n  });\n  \n  const mathDisplays = document.querySelectorAll('.math-display, .katex-display');\n  mathDisplays.forEach((el) => {\n    const text = el.textContent || '';\n    if (text.includes('$$')) {\n      const replacement = document.createTextNode('\\n\\n' + text + '\\n\\n');\n      el.replaceWith(replacement);\n    }\n  });\n  \n  function processNode(node: Node): string {\n    if (node.nodeType === 3) {\n      return node.textContent || '';\n    }\n    \n    if (node.nodeType !== 1) return '';\n    \n    const element = node as Element;\n    const tagName = element.tagName.toLowerCase();\n    const children = Array.from(element.childNodes).map(processNode).join('');\n    \n    switch (tagName) {\n      case 'p':\n        return children.trim() + '\\n\\n';\n      case 'br':\n        return '\\n';\n      case 'strong':\n      case 'b':\n        return `**${children}**`;\n      case 'em':\n      case 'i':\n        return `*${children}*`;\n      case 'u':\n        return children;\n      case 'code':\n        return `\\`${children}\\``;\n      case 'h1':\n        return `# ${children}\\n\\n`;\n      case 'h2':\n        return `## ${children}\\n\\n`;\n      case 'h3':\n        return `### ${children}\\n\\n`;\n      case 'h4':\n        return `#### ${children}\\n\\n`;\n      case 'h5':\n        return `##### ${children}\\n\\n`;\n      case 'h6':\n        return `###### ${children}\\n\\n`;\n      case 'ul':\n        return '\\n' + Array.from(element.children)\n          .map(li => `- ${processNode(li).trim()}`)\n          .join('\\n') + '\\n\\n';\n      case 'ol':\n        return '\\n' + Array.from(element.children)\n          .map((li, i) => `${i + 1}. ${processNode(li).trim()}`)\n          .join('\\n') + '\\n\\n';\n      case 'li':\n        return children;\n      case 'blockquote':\n        return children.split('\\n').map(line => `> ${line}`).join('\\n') + '\\n\\n';\n      case 'pre':\n        const codeEl = element.querySelector('code');\n        const lang = codeEl?.className.match(/language-(\\w+)/)?.[1] || '';\n        return `\\`\\`\\`${lang}\\n${codeEl?.textContent || children}\\n\\`\\`\\`\\n\\n`;\n      case 'a':\n        const href = element.getAttribute('href') || '';\n        return `[${children}](${href})`;\n      case 'table':\n        return processTable(element);\n      case 'div':\n      case 'span':\n        return children;\n      default:\n        return children;\n    }\n  }\n  \n  function processTable(table: Element): string {\n    const rows = table.querySelectorAll('tr');\n    if (rows.length === 0) return '';\n    \n    let result = '';\n    rows.forEach((row, rowIndex) => {\n      const cells = row.querySelectorAll('th, td');\n      const cellContents = Array.from(cells).map(cell => processNode(cell).trim());\n      result += '| ' + cellContents.join(' | ') + ' |\\n';\n      \n      if (rowIndex === 0) {\n        result += '| ' + cellContents.map(() => '---').join(' | ') + ' |\\n';\n      }\n    });\n    \n    return result + '\\n';\n  }\n  \n  return processNode(document.body).trim();\n}\n\nexport async function generateWordDocument(title: string, content: string): Promise<Buffer> {\n  let markdownContent = content;\n  \n  if (isHtmlContent(content)) {\n    markdownContent = htmlToMarkdown(content);\n    console.log('[generateWordDocument] Converted HTML to Markdown for export');\n  }\n  \n  return generateWordFromMarkdown(title, markdownContent);\n}\n\nexport async function generateExcelDocument(title: string, data: any[][]): Promise<Buffer> {\n  const workbook = new ExcelJS.Workbook();\n  \n  const safeData = data.length > 0 ? data : [[\"Contenido\"], [\"No hay datos disponibles\"]];\n  \n  const sheetName = title.replace(/[\\\\/:*?\\[\\]]/g, \"\").slice(0, 31) || \"Hoja1\";\n  const worksheet = workbook.addWorksheet(sheetName);\n  \n  worksheet.addRows(safeData);\n  \n  const colWidths = safeData[0]?.map((_, colIndex) => {\n    const maxLength = Math.max(...safeData.map(row => String(row[colIndex] || \"\").length));\n    return Math.min(Math.max(maxLength, 10), 50);\n  }) || [];\n  \n  worksheet.columns = colWidths.map((width, index) => ({\n    key: String.fromCharCode(65 + index),\n    width: width\n  }));\n  \n  return Buffer.from(await workbook.xlsx.writeBuffer());\n}\n\nexport async function generatePptDocument(title: string, slides: { title: string; content: string[] }[]): Promise<Buffer> {\n  const pptx = new PptxGenJS();\n  pptx.title = title;\n  pptx.author = \"Sira GPT\";\n\n  const titleSlide = pptx.addSlide();\n  titleSlide.addText(title, {\n    x: 0.5,\n    y: 2,\n    w: 9,\n    h: 1.5,\n    fontSize: 44,\n    bold: true,\n    color: \"363636\",\n    align: \"center\",\n    fontFace: \"Arial\",\n  });\n\n  for (const slide of slides) {\n    const s = pptx.addSlide();\n    \n    s.addText(slide.title, {\n      x: 0.5,\n      y: 0.3,\n      w: 9,\n      h: 0.8,\n      fontSize: 32,\n      bold: true,\n      color: \"363636\",\n      fontFace: \"Arial\",\n    });\n\n    if (slide.content.length > 0) {\n      const bulletPoints = slide.content.map(text => ({\n        text: text,\n        options: { bullet: true, fontSize: 18, color: \"666666\" },\n      }));\n\n      s.addText(bulletPoints, {\n        x: 0.5,\n        y: 1.3,\n        w: 9,\n        h: 4,\n        fontFace: \"Arial\",\n        valign: \"top\",\n      });\n    }\n  }\n\n  const buffer = await pptx.write({ outputType: \"nodebuffer\" });\n  return buffer as Buffer;\n}\n\nexport function parseExcelFromText(text: string): any[][] {\n  const lines = text.trim().split(\"\\n\");\n  const data: any[][] = [];\n  \n  for (const line of lines) {\n    const trimmedLine = line.trim();\n    if (!trimmedLine) continue;\n    \n    if (trimmedLine.includes(\"|\")) {\n      const cells = trimmedLine.split(\"|\").map(cell => cell.trim()).filter(cell => cell && !cell.match(/^-+$/));\n      if (cells.length > 0) {\n        data.push(cells);\n      }\n    } else if (trimmedLine.includes(\",\")) {\n      const cells = trimmedLine.split(\",\").map(cell => cell.trim());\n      if (cells.length > 1) {\n        data.push(cells);\n      } else {\n        data.push([trimmedLine]);\n      }\n    } else if (trimmedLine.includes(\"\\t\")) {\n      const cells = trimmedLine.split(\"\\t\").map(cell => cell.trim());\n      data.push(cells);\n    } else if (trimmedLine.includes(\";\")) {\n      const cells = trimmedLine.split(\";\").map(cell => cell.trim());\n      data.push(cells);\n    } else {\n      data.push([trimmedLine]);\n    }\n  }\n  \n  if (data.length === 0) {\n    data.push([\"Contenido\"], [text.slice(0, 500)]);\n  }\n  \n  return data;\n}\n\nexport function parseSlidesFromText(text: string): { title: string; content: string[] }[] {\n  const slides: { title: string; content: string[] }[] = [];\n  const sections = text.split(/(?=^##?\\s)/m);\n  \n  for (const section of sections) {\n    const lines = section.trim().split(\"\\n\");\n    if (lines.length === 0) continue;\n    \n    let title = lines[0].replace(/^#+\\s*/, \"\").trim();\n    if (!title) continue;\n    \n    const content: string[] = [];\n    for (let i = 1; i < lines.length; i++) {\n      const line = lines[i].trim();\n      if (line && !line.match(/^-+$/)) {\n        content.push(line.replace(/^[-*•\\d.)\\s]+/, \"\").trim() || line);\n      }\n    }\n    \n    if (content.length > 0 || slides.length === 0) {\n      slides.push({ title, content: content.length > 0 ? content : [\"\"] });\n    }\n  }\n  \n  if (slides.length === 0) {\n    const lines = text.split(\"\\n\").filter(l => l.trim());\n    const maxSlideContent = 6;\n    \n    for (let i = 0; i < lines.length; i += maxSlideContent) {\n      const chunk = lines.slice(i, i + maxSlideContent);\n      slides.push({\n        title: chunk[0]?.replace(/^[-*•\\d.)\\s]+/, \"\").trim() || `Diapositiva ${slides.length + 1}`,\n        content: chunk.slice(1).map(l => l.replace(/^[-*•\\d.)\\s]+/, \"\").trim() || l),\n      });\n    }\n    \n    if (slides.length === 0) {\n      slides.push({ title: \"Presentación\", content: [text.slice(0, 200)] });\n    }\n  }\n  \n  return slides;\n}\n","path":null,"size_bytes":8803,"size_tokens":null},"client/src/components/gpt-explorer.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  Search, \n  Plus, \n  Bot, \n  Sparkles, \n  Code, \n  PenTool, \n  BarChart3, \n  BookOpen,\n  Briefcase,\n  ArrowRight,\n  Link as LinkIcon\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nexport interface Gpt {\n  id: string;\n  name: string;\n  slug: string;\n  description: string | null;\n  avatar: string | null;\n  categoryId: string | null;\n  creatorId: string | null;\n  visibility: string | null;\n  systemPrompt: string;\n  temperature: string | null;\n  topP: string | null;\n  maxTokens: number | null;\n  welcomeMessage: string | null;\n  capabilities: any;\n  conversationStarters: string[] | null;\n  usageCount: number | null;\n  version: number | null;\n  isPublished: string | null;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface GptCategory {\n  id: string;\n  name: string;\n  slug: string;\n  description: string | null;\n  icon: string | null;\n  sortOrder: number | null;\n}\n\ninterface GptExplorerProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSelectGpt: (gpt: Gpt) => void;\n  onCreateGpt: () => void;\n}\n\nconst defaultCategories = [\n  { slug: \"destacados\", name: \"Principales selecciones\", icon: Sparkles },\n  { slug: \"imagen\", name: \"DALL-E\", icon: PenTool },\n  { slug: \"escritura\", name: \"Escritura\", icon: PenTool },\n  { slug: \"productividad\", name: \"Productividad\", icon: Briefcase },\n  { slug: \"investigacion\", name: \"Investigación y análisis\", icon: BookOpen },\n  { slug: \"programacion\", name: \"Programación\", icon: Code },\n];\n\nexport function GptExplorer({ open, onOpenChange, onSelectGpt, onCreateGpt }: GptExplorerProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"destacados\");\n  const [gpts, setGpts] = useState<Gpt[]>([]);\n  const [myGpts, setMyGpts] = useState<Gpt[]>([]);\n  const [categories, setCategories] = useState<GptCategory[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [view, setView] = useState<\"explore\" | \"my-gpts\">(\"explore\");\n\n  useEffect(() => {\n    if (open) {\n      fetchGpts();\n      fetchCategories();\n    }\n  }, [open]);\n\n  const fetchGpts = async () => {\n    try {\n      setLoading(true);\n      const [publicRes, myRes] = await Promise.all([\n        fetch(\"/api/gpts?visibility=public\"),\n        fetch(\"/api/gpts\")\n      ]);\n      const publicData = await publicRes.json();\n      const myData = await myRes.json();\n      setGpts(Array.isArray(publicData) ? publicData : []);\n      setMyGpts(Array.isArray(myData) ? myData : []);\n    } catch (error) {\n      console.error(\"Error fetching GPTs:\", error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchCategories = async () => {\n    try {\n      const res = await fetch(\"/api/gpt-categories\");\n      const data = await res.json();\n      setCategories(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Error fetching categories:\", error);\n    }\n  };\n\n  const filteredGpts = useMemo(() => {\n    let filtered = view === \"my-gpts\" ? myGpts : gpts;\n    \n    if (searchQuery.trim()) {\n      filtered = filtered.filter(gpt => \n        gpt.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        gpt.description?.toLowerCase().includes(searchQuery.toLowerCase())\n      );\n    }\n    \n    return filtered;\n  }, [gpts, myGpts, searchQuery, view]);\n\n  const popularGpts = useMemo(() => {\n    return [...gpts].sort((a, b) => (b.usageCount || 0) - (a.usageCount || 0)).slice(0, 6);\n  }, [gpts]);\n\n  const handleSelectGpt = (gpt: Gpt) => {\n    onSelectGpt(gpt);\n    onOpenChange(false);\n  };\n\n  const handleCreateNew = () => {\n    onCreateGpt();\n    onOpenChange(false);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"w-[95vw] max-w-[95vw] h-[95vh] p-0 gap-0 overflow-hidden\" data-testid=\"gpt-explorer-dialog\">\n        <div className=\"flex flex-col h-full\">\n          <div className=\"flex items-center justify-between px-6 py-4 border-b\">\n            <div className=\"flex items-center gap-4\">\n              <span \n                className={cn(\n                  \"text-sm font-medium cursor-pointer transition-colors\",\n                  view === \"explore\" ? \"text-foreground\" : \"text-muted-foreground hover:text-foreground\"\n                )}\n                onClick={() => setView(\"explore\")}\n                data-testid=\"tab-explore-gpts\"\n              >\n                Explorar GPT\n              </span>\n              <span \n                className={cn(\n                  \"text-sm font-medium cursor-pointer transition-colors\",\n                  view === \"my-gpts\" ? \"text-foreground\" : \"text-muted-foreground hover:text-foreground\"\n                )}\n                onClick={() => setView(\"my-gpts\")}\n                data-testid=\"tab-my-gpts\"\n              >\n                Mis GPT\n              </span>\n            </div>\n            <Button \n              onClick={handleCreateNew}\n              className=\"gap-2 mr-[120px]\"\n              data-testid=\"button-create-gpt\"\n            >\n              <Plus className=\"h-4 w-4\" />\n              Crear\n            </Button>\n          </div>\n\n          <ScrollArea className=\"flex-1\">\n            <div className=\"p-6\">\n              <div className=\"text-center mb-8\">\n                <h1 className=\"text-4xl font-bold mb-4\">GPT</h1>\n                <p className=\"text-muted-foreground max-w-xl mx-auto\">\n                  Descubre y crea versiones personalizadas de ChatGPT que combinen instrucciones, conocimientos adicionales y cualquier combinación de habilidades.\n                </p>\n              </div>\n\n              <div className=\"relative max-w-xl mx-auto mb-8\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Buscar GPT\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10 h-12 rounded-full bg-muted/50\"\n                  data-testid=\"input-search-gpts\"\n                />\n              </div>\n\n              {view === \"explore\" ? (\n                <>\n                  <div className=\"flex items-center gap-2 mb-6 overflow-x-auto pb-2\">\n                    {defaultCategories.map((cat) => (\n                      <Button\n                        key={cat.slug}\n                        variant={activeTab === cat.slug ? \"secondary\" : \"ghost\"}\n                        className=\"whitespace-nowrap\"\n                        onClick={() => setActiveTab(cat.slug)}\n                        data-testid={`tab-category-${cat.slug}`}\n                      >\n                        {cat.name}\n                      </Button>\n                    ))}\n                    <Button variant=\"ghost\" className=\"whitespace-nowrap\" data-testid=\"button-more-categories\">\n                      <ArrowRight className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n\n                  {!searchQuery && (\n                    <div className=\"mb-8\">\n                      <h2 className=\"text-lg font-semibold mb-2\">Popular en tu espacio de trabajo</h2>\n                      <p className=\"text-sm text-muted-foreground mb-4\">Los GPTs más populares en tu espacio de trabajo</p>\n                      \n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                        {loading ? (\n                          Array.from({ length: 6 }).map((_, i) => (\n                            <div key={i} className=\"flex items-start gap-4 p-4 rounded-lg bg-muted/30 animate-pulse\">\n                              <div className=\"w-12 h-12 rounded-lg bg-muted\"></div>\n                              <div className=\"flex-1 space-y-2\">\n                                <div className=\"h-4 bg-muted rounded w-3/4\"></div>\n                                <div className=\"h-3 bg-muted rounded w-full\"></div>\n                              </div>\n                            </div>\n                          ))\n                        ) : popularGpts.length > 0 ? (\n                          popularGpts.map((gpt, index) => (\n                            <GptCard \n                              key={gpt.id}\n                              gpt={gpt}\n                              index={index + 1}\n                              onClick={() => handleSelectGpt(gpt)}\n                            />\n                          ))\n                        ) : (\n                          <div className=\"col-span-2 text-center py-8 text-muted-foreground\">\n                            <Bot className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                            <p>No hay GPTs disponibles todavía.</p>\n                            <Button variant=\"link\" onClick={handleCreateNew} className=\"mt-2\">\n                              Crea tu primer GPT\n                            </Button>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  {searchQuery && (\n                    <div className=\"space-y-4\">\n                      {filteredGpts.length > 0 ? (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          {filteredGpts.map((gpt, index) => (\n                            <GptCard \n                              key={gpt.id}\n                              gpt={gpt}\n                              index={index + 1}\n                              onClick={() => handleSelectGpt(gpt)}\n                            />\n                          ))}\n                        </div>\n                      ) : (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          <Search className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                          <p>No se encontraron GPTs para \"{searchQuery}\"</p>\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </>\n              ) : (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <h2 className=\"text-lg font-semibold\">Mis GPTs</h2>\n                    <Button variant=\"outline\" size=\"sm\" onClick={handleCreateNew}>\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Crear nuevo\n                    </Button>\n                  </div>\n                  \n                  {loading ? (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      {Array.from({ length: 4 }).map((_, i) => (\n                        <div key={i} className=\"flex items-start gap-4 p-4 rounded-lg bg-muted/30 animate-pulse\">\n                          <div className=\"w-12 h-12 rounded-lg bg-muted\"></div>\n                          <div className=\"flex-1 space-y-2\">\n                            <div className=\"h-4 bg-muted rounded w-3/4\"></div>\n                            <div className=\"h-3 bg-muted rounded w-full\"></div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : filteredGpts.length > 0 ? (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      {filteredGpts.map((gpt, index) => (\n                        <GptCard \n                          key={gpt.id}\n                          gpt={gpt}\n                          index={index + 1}\n                          onClick={() => handleSelectGpt(gpt)}\n                          showEdit\n                        />\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-12 text-muted-foreground\">\n                      <Bot className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                      <p className=\"mb-4\">No has creado ningún GPT todavía.</p>\n                      <Button onClick={handleCreateNew}>\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Crear mi primer GPT\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {!searchQuery && view === \"explore\" && (\n                <div className=\"mt-8 text-center\">\n                  <Button variant=\"outline\" className=\"w-full max-w-xs\" data-testid=\"button-view-more\">\n                    Ver más\n                  </Button>\n                </div>\n              )}\n            </div>\n          </ScrollArea>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\ninterface GptCardProps {\n  gpt: Gpt;\n  index?: number;\n  onClick: () => void;\n  showEdit?: boolean;\n}\n\nfunction GptCard({ gpt, index, onClick, showEdit }: GptCardProps) {\n  return (\n    <div \n      className=\"flex items-start gap-4 p-4 rounded-xl hover:bg-muted/50 cursor-pointer transition-colors group\"\n      onClick={onClick}\n      data-testid={`gpt-card-${gpt.id}`}\n    >\n      {index && (\n        <span className=\"text-2xl font-bold text-muted-foreground/50 w-6 flex-shrink-0\">\n          {index}\n        </span>\n      )}\n      <div className=\"w-12 h-12 rounded-lg bg-muted flex items-center justify-center flex-shrink-0\">\n        {gpt.avatar ? (\n          <img src={gpt.avatar} alt={gpt.name} className=\"w-full h-full rounded-lg object-cover\" />\n        ) : (\n          <Bot className=\"h-6 w-6 text-muted-foreground\" />\n        )}\n      </div>\n      <div className=\"flex-1 min-w-0\">\n        <h3 className=\"font-medium truncate\">{gpt.name}</h3>\n        <p className=\"text-sm text-muted-foreground line-clamp-2\">{gpt.description || \"Sin descripción\"}</p>\n        <div className=\"flex items-center gap-2 mt-1 text-xs text-muted-foreground\">\n          <span>Por {gpt.creatorId || \"Usuario\"}</span>\n          {gpt.usageCount && gpt.usageCount > 0 && (\n            <>\n              <span>·</span>\n              <span><LinkIcon className=\"inline h-3 w-3 mr-1\" />{gpt.usageCount}</span>\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14464,"size_tokens":null},"client/src/hooks/use-auth.ts":{"content":"import { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useCallback } from \"react\";\nimport type { User } from \"@shared/schema\";\n\nconst AUTH_STORAGE_KEY = \"siragpt_auth_user\";\n\nfunction getStoredUser(): User | null {\n  try {\n    const stored = localStorage.getItem(AUTH_STORAGE_KEY);\n    if (stored) {\n      return JSON.parse(stored);\n    }\n  } catch (e) {\n    // Ignore parse errors\n  }\n  return null;\n}\n\nfunction setStoredUser(user: User | null): void {\n  try {\n    if (user) {\n      localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(user));\n    } else {\n      localStorage.removeItem(AUTH_STORAGE_KEY);\n    }\n  } catch (e) {\n    // Ignore storage errors\n  }\n}\n\nasync function fetchUser(): Promise<User | null> {\n  const response = await fetch(\"/api/auth/user\", {\n    credentials: \"include\",\n  });\n\n  if (response.status === 401) {\n    // Try localStorage fallback\n    const storedUser = getStoredUser();\n    if (storedUser) {\n      return storedUser;\n    }\n    return null;\n  }\n\n  if (!response.ok) {\n    throw new Error(`${response.status}: ${response.statusText}`);\n  }\n\n  const user = await response.json();\n  setStoredUser(user);\n  return user;\n}\n\nexport function useAuth() {\n  const queryClient = useQueryClient();\n  \n  const { data: user, isLoading, refetch } = useQuery<User | null>({\n    queryKey: [\"/api/auth/user\"],\n    queryFn: fetchUser,\n    retry: false,\n    staleTime: 1000 * 60 * 5, // 5 minutes\n  });\n\n  const login = useCallback(() => {\n    window.location.href = \"/api/login\";\n  }, []);\n\n  const logout = useCallback(async () => {\n    try {\n      await fetch(\"/api/auth/logout\", {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n    } catch (e) {\n      // Ignore errors, still clear local state\n    }\n    setStoredUser(null);\n    queryClient.setQueryData([\"/api/auth/user\"], null);\n    window.location.href = \"/welcome\";\n  }, [queryClient]);\n\n  const refreshAuth = useCallback(() => {\n    refetch();\n  }, [refetch]);\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n    login,\n    logout,\n    refreshAuth,\n  };\n}\n","path":null,"size_bytes":2091,"size_tokens":null},"server/replit_integrations/auth/index.ts":{"content":"export { setupAuth, isAuthenticated, getSession, validateWebSocketSession, type WebSocketUser } from \"./replitAuth\";\nexport { authStorage, type IAuthStorage } from \"./storage\";\nexport { registerAuthRoutes } from \"./routes\";\n","path":null,"size_bytes":224,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Paperclip, Search, BookOpen, Image, Mic, X, ChevronDown, HelpCircle } from \"lucide-react\";\nimport { SiraLogo } from \"@/components/sira-logo\";\n\nexport default function LandingPage() {\n  const [, setLocation] = useLocation();\n  const [inputValue, setInputValue] = useState(\"\");\n  const [showPromo, setShowPromo] = useState(true);\n\n  const handleSubmit = () => {\n    if (inputValue.trim()) {\n      setLocation(\"/login\");\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      <header className=\"flex items-center justify-between px-4 md:px-8 h-16 border-b\">\n        <div className=\"flex items-center gap-2\">\n          <SiraLogo size={32} />\n          <span className=\"font-semibold\">MICHAT</span>\n          <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n        </div>\n\n        <nav className=\"hidden md:flex items-center gap-6 text-sm\">\n          <a href=\"#\" className=\"text-muted-foreground hover:text-foreground transition-colors\">Sobre nosotros</a>\n          <a href=\"#\" className=\"text-muted-foreground hover:text-foreground transition-colors\">Aprender</a>\n          <a href=\"#\" className=\"text-muted-foreground hover:text-foreground transition-colors\">Business</a>\n          <a href=\"#\" className=\"text-muted-foreground hover:text-foreground transition-colors\">Precios</a>\n          <a href=\"#\" className=\"text-primary hover:text-primary/80 transition-colors\">Imágenes</a>\n          <a href=\"#\" className=\"text-muted-foreground hover:text-foreground transition-colors\">Descargar</a>\n        </nav>\n\n        <div className=\"flex items-center gap-3\">\n          <Button \n            variant=\"default\"\n            className=\"rounded-full\"\n            onClick={() => setLocation(\"/login\")}\n            data-testid=\"button-header-login\"\n          >\n            Inicia sesión\n          </Button>\n          <Button \n            variant=\"outline\"\n            className=\"rounded-full hidden sm:flex\"\n            onClick={() => setLocation(\"/signup\")}\n            data-testid=\"button-header-signup\"\n          >\n            Suscríbete gratis\n          </Button>\n          <Button variant=\"ghost\" size=\"icon\" className=\"rounded-full\">\n            <HelpCircle className=\"h-5 w-5\" />\n          </Button>\n        </div>\n      </header>\n\n      <main className=\"flex-1 flex flex-col items-center justify-center px-4 py-8\">\n        <div className=\"w-full max-w-2xl space-y-8\">\n          <h1 className=\"text-3xl md:text-4xl font-semibold text-center\">\n            ¿Con qué puedo ayudarte?\n          </h1>\n\n          <div className=\"space-y-4\">\n            <div className=\"relative\">\n              <Input\n                placeholder=\"Pregunta lo que quieras\"\n                value={inputValue}\n                onChange={(e) => setInputValue(e.target.value)}\n                onKeyDown={(e) => e.key === \"Enter\" && handleSubmit()}\n                className=\"h-14 px-4 pr-12 text-base rounded-2xl border-2\"\n                data-testid=\"input-landing-search\"\n              />\n            </div>\n\n            <div className=\"flex items-center justify-center gap-2 flex-wrap\">\n              <Button \n                variant=\"outline\" \n                className=\"rounded-full gap-2 text-sm\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-attach\"\n              >\n                <Paperclip className=\"h-4 w-4\" />\n                Adjuntar\n              </Button>\n              <Button \n                variant=\"outline\" \n                className=\"rounded-full gap-2 text-sm\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-search\"\n              >\n                <Search className=\"h-4 w-4\" />\n                Buscar\n              </Button>\n              <Button \n                variant=\"outline\" \n                className=\"rounded-full gap-2 text-sm\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-study\"\n              >\n                <BookOpen className=\"h-4 w-4\" />\n                Estudiemos\n              </Button>\n              <Button \n                variant=\"outline\" \n                className=\"rounded-full gap-2 text-sm\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-create-image\"\n              >\n                <Image className=\"h-4 w-4\" />\n                Crear imagen\n              </Button>\n              <Button \n                variant=\"outline\" \n                className=\"rounded-full gap-2 text-sm\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-voice\"\n              >\n                <Mic className=\"h-4 w-4\" />\n                Voz\n              </Button>\n            </div>\n          </div>\n\n          {showPromo && (\n            <div className=\"bg-muted/50 rounded-2xl p-4 md:p-6 relative\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"absolute top-2 right-2 h-8 w-8\"\n                onClick={() => setShowPromo(false)}\n                data-testid=\"button-close-promo\"\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n              \n              <div className=\"flex flex-col md:flex-row gap-4 md:gap-6\">\n                <div className=\"flex-1\">\n                  <h3 className=\"font-semibold mb-2\">Crea tu primera imagen</h3>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    ¿Tienes una idea? Prueba nuestros estilos y filtros seleccionados o imagina algo desde cero.\n                  </p>\n                  <Button \n                    className=\"rounded-full\"\n                    onClick={() => setLocation(\"/login\")}\n                    data-testid=\"button-try-now\"\n                  >\n                    Probar ahora\n                  </Button>\n                </div>\n                \n                <div className=\"flex gap-2 overflow-x-auto pb-2 md:pb-0\">\n                  <div className=\"flex flex-col items-center gap-1 min-w-[70px]\">\n                    <div className=\"w-16 h-16 md:w-20 md:h-20 rounded-xl bg-gradient-to-br from-amber-200 to-amber-400 flex items-center justify-center\">\n                      <span className=\"text-2xl\">🎨</span>\n                    </div>\n                    <span className=\"text-xs text-muted-foreground\">Boceto</span>\n                  </div>\n                  <div className=\"flex flex-col items-center gap-1 min-w-[70px]\">\n                    <div className=\"w-16 h-16 md:w-20 md:h-20 rounded-xl bg-gradient-to-br from-green-200 to-green-400 flex items-center justify-center\">\n                      <span className=\"text-2xl\">🎄</span>\n                    </div>\n                    <span className=\"text-xs text-muted-foreground\">Retrato festivo</span>\n                  </div>\n                  <div className=\"flex flex-col items-center gap-1 min-w-[70px]\">\n                    <div className=\"w-16 h-16 md:w-20 md:h-20 rounded-xl bg-gradient-to-br from-purple-200 to-purple-400 flex items-center justify-center\">\n                      <span className=\"text-2xl\">🎭</span>\n                    </div>\n                    <span className=\"text-xs text-muted-foreground\">Dramático</span>\n                  </div>\n                  <div className=\"flex flex-col items-center gap-1 min-w-[70px]\">\n                    <div className=\"w-16 h-16 md:w-20 md:h-20 rounded-xl bg-gradient-to-br from-pink-200 to-pink-400 flex items-center justify-center\">\n                      <span className=\"text-2xl\">🧸</span>\n                    </div>\n                    <span className=\"text-xs text-muted-foreground\">Peluche</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      </main>\n\n      <footer className=\"py-4 text-center text-sm text-muted-foreground border-t\">\n        Al enviar un mensaje a MICHAT, un chatbot de IA, aceptas nuestros{\" \"}\n        <a href=\"#\" className=\"underline hover:text-foreground\">Términos</a>\n        {\" \"}y reconoces que leíste nuestra{\" \"}\n        <a href=\"#\" className=\"underline hover:text-foreground\">Política de privacidad</a>.\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":8414,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { X, Chrome, Apple, Building2, Phone, Loader2 } from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\n\nexport default function LoginPage() {\n  const [, setLocation] = useLocation();\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  const handleContinue = async () => {\n    if (email && password) {\n      setIsLoading(true);\n      setError(\"\");\n      try {\n        const response = await fetch(\"/api/auth/login\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          credentials: \"include\",\n          body: JSON.stringify({ email, password }),\n        });\n        \n        if (response.ok) {\n          const data = await response.json();\n          if (data.user) {\n            // Store in localStorage for persistence\n            localStorage.setItem(\"siragpt_auth_user\", JSON.stringify(data.user));\n            queryClient.setQueryData([\"/api/auth/user\"], data.user);\n          }\n          window.location.href = \"/\";\n        } else {\n          const data = await response.json();\n          setError(data.message || \"Credenciales inválidas\");\n        }\n      } catch (err) {\n        setError(\"Error al iniciar sesión\");\n      } finally {\n        setIsLoading(false);\n      }\n    } else if (email && !password) {\n      setError(\"Por favor ingresa tu contraseña\");\n    }\n  };\n\n  const handleGoogleLogin = () => {\n    // Redirect to Replit Auth (supports Google login)\n    window.location.href = \"/api/login\";\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <div className=\"w-full max-w-md relative\">\n        <Button \n          variant=\"ghost\" \n          size=\"icon\"\n          className=\"absolute -top-2 -right-2\"\n          onClick={() => setLocation(\"/welcome\")}\n          data-testid=\"button-close-login\"\n        >\n          <X className=\"h-5 w-5\" />\n        </Button>\n\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-3xl font-semibold mb-3\">Inicia sesión o suscríbete</h1>\n          <p className=\"text-muted-foreground\">\n            Obtendrás respuestas más inteligentes, podrás cargar archivos e imágenes, y más.\n          </p>\n        </div>\n\n        <div className=\"space-y-3\">\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-14 justify-center gap-3 text-base font-medium border-2 hover:bg-muted/50 hover:border-primary/30 transition-all duration-200 rounded-xl shadow-sm\"\n            onClick={handleGoogleLogin}\n            data-testid=\"button-login-google\"\n          >\n            <svg className=\"h-6 w-6\" viewBox=\"0 0 24 24\">\n              <path fill=\"#4285F4\" d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"/>\n              <path fill=\"#34A853\" d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"/>\n              <path fill=\"#FBBC05\" d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"/>\n              <path fill=\"#EA4335\" d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"/>\n            </svg>\n            Continuar con Google\n          </Button>\n\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-12 justify-start gap-3 text-base font-normal opacity-50 cursor-not-allowed\"\n            disabled\n            data-testid=\"button-login-apple\"\n          >\n            <Apple className=\"h-5 w-5\" />\n            Continuar con Apple\n          </Button>\n\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-12 justify-start gap-3 text-base font-normal opacity-50 cursor-not-allowed\"\n            disabled\n            data-testid=\"button-login-microsoft\"\n          >\n            <svg className=\"h-5 w-5\" viewBox=\"0 0 23 23\">\n              <path fill=\"#f35325\" d=\"M1 1h10v10H1z\"/>\n              <path fill=\"#81bc06\" d=\"M12 1h10v10H12z\"/>\n              <path fill=\"#05a6f0\" d=\"M1 12h10v10H1z\"/>\n              <path fill=\"#ffba08\" d=\"M12 12h10v10H12z\"/>\n            </svg>\n            Continuar con Microsoft\n          </Button>\n\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-12 justify-start gap-3 text-base font-normal opacity-50 cursor-not-allowed\"\n            disabled\n            data-testid=\"button-login-phone\"\n          >\n            <Phone className=\"h-5 w-5\" />\n            Continuar con el teléfono\n          </Button>\n        </div>\n\n        <div className=\"flex items-center gap-4 my-6\">\n          <div className=\"flex-1 h-px bg-border\" />\n          <span className=\"text-muted-foreground text-sm\">o</span>\n          <div className=\"flex-1 h-px bg-border\" />\n        </div>\n\n        <div className=\"space-y-4\">\n          <Input \n            type=\"email\"\n            placeholder=\"Dirección de correo electrónico\"\n            value={email}\n            onChange={(e) => setEmail(e.target.value)}\n            className=\"h-12 text-base\"\n            data-testid=\"input-login-email\"\n          />\n          <Input \n            type=\"password\"\n            placeholder=\"Contraseña\"\n            value={password}\n            onChange={(e) => setPassword(e.target.value)}\n            className=\"h-12 text-base\"\n            data-testid=\"input-login-password\"\n            onKeyDown={(e) => e.key === 'Enter' && handleContinue()}\n          />\n          {error && (\n            <p className=\"text-sm text-red-500 text-center\" data-testid=\"text-login-error\">{error}</p>\n          )}\n          <Button \n            className=\"w-full h-12 text-base\"\n            onClick={handleContinue}\n            disabled={isLoading}\n            data-testid=\"button-login-continue\"\n          >\n            {isLoading ? <Loader2 className=\"h-5 w-5 animate-spin\" /> : \"Continuar\"}\n          </Button>\n        </div>\n\n        <p className=\"text-center text-sm text-muted-foreground mt-6\">\n          ¿No tienes una cuenta?{\" \"}\n          <button \n            onClick={() => setLocation(\"/signup\")}\n            className=\"text-primary hover:underline\"\n            data-testid=\"link-goto-signup\"\n          >\n            Suscríbete gratis\n          </button>\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6701,"size_tokens":null},"client/src/components/admin-panel.tsx":{"content":"import { useState } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  LayoutDashboard,\n  Users,\n  Bot,\n  CreditCard,\n  FileText,\n  BarChart3,\n  Database,\n  Shield,\n  FileBarChart,\n  Settings,\n  Search,\n  Plus,\n  MoreHorizontal,\n  CheckCircle,\n  XCircle,\n  Clock,\n  TrendingUp,\n  TrendingDown,\n  Activity,\n  HardDrive,\n  Lock,\n  Key,\n  AlertTriangle,\n  Download,\n  RefreshCw\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface AdminPanelProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\ntype AdminSection = \"dashboard\" | \"users\" | \"ai-models\" | \"payments\" | \"invoices\" | \"analytics\" | \"database\" | \"security\" | \"reports\" | \"settings\";\n\nconst navItems: { id: AdminSection; label: string; icon: React.ElementType }[] = [\n  { id: \"dashboard\", label: \"Dashboard\", icon: LayoutDashboard },\n  { id: \"users\", label: \"Users\", icon: Users },\n  { id: \"ai-models\", label: \"AI Models\", icon: Bot },\n  { id: \"payments\", label: \"Payments\", icon: CreditCard },\n  { id: \"invoices\", label: \"Invoices\", icon: FileText },\n  { id: \"analytics\", label: \"Analytics\", icon: BarChart3 },\n  { id: \"database\", label: \"Database\", icon: Database },\n  { id: \"security\", label: \"Security\", icon: Shield },\n  { id: \"reports\", label: \"Reports\", icon: FileBarChart },\n  { id: \"settings\", label: \"Settings\", icon: Settings },\n];\n\nfunction DashboardSection() {\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Dashboard</h2>\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Usuarios</span>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n          <p className=\"text-2xl font-semibold\">1,247</p>\n          <div className=\"flex items-center text-xs text-green-600\">\n            <TrendingUp className=\"h-3 w-3 mr-1\" />\n            +12% este mes\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Consultas/día</span>\n            <Activity className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n          <p className=\"text-2xl font-semibold\">8,432</p>\n          <div className=\"flex items-center text-xs text-green-600\">\n            <TrendingUp className=\"h-3 w-3 mr-1\" />\n            +8% vs ayer\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Ingresos</span>\n            <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n          <p className=\"text-2xl font-semibold\">€24,500</p>\n          <div className=\"flex items-center text-xs text-green-600\">\n            <TrendingUp className=\"h-3 w-3 mr-1\" />\n            +15% este mes\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Uptime</span>\n            <CheckCircle className=\"h-4 w-4 text-green-500\" />\n          </div>\n          <p className=\"text-2xl font-semibold\">99.9%</p>\n          <span className=\"text-xs text-muted-foreground\">Últimos 30 días</span>\n        </div>\n      </div>\n      <div className=\"rounded-lg border p-4\">\n        <h3 className=\"text-sm font-medium mb-4\">Actividad reciente</h3>\n        <div className=\"space-y-3\">\n          {[\n            { action: \"Nuevo usuario registrado\", time: \"Hace 2 min\", type: \"user\" },\n            { action: \"Pago recibido - €99\", time: \"Hace 15 min\", type: \"payment\" },\n            { action: \"Modelo GPT-4 actualizado\", time: \"Hace 1 hora\", type: \"model\" },\n            { action: \"Backup completado\", time: \"Hace 3 horas\", type: \"system\" },\n          ].map((item, i) => (\n            <div key={i} className=\"flex items-center justify-between py-2 text-sm\">\n              <span>{item.action}</span>\n              <span className=\"text-xs text-muted-foreground\">{item.time}</span>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction UsersSection() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const users = [\n    { id: 1, name: \"Carlos García\", email: \"carlos@empresa.com\", plan: \"Enterprise\", status: \"active\", queries: 1247 },\n    { id: 2, name: \"María López\", email: \"maria@startup.io\", plan: \"Pro\", status: \"active\", queries: 892 },\n    { id: 3, name: \"Juan Martínez\", email: \"juan@tech.com\", plan: \"Basic\", status: \"inactive\", queries: 234 },\n    { id: 4, name: \"Ana Rodríguez\", email: \"ana@corp.es\", plan: \"Enterprise\", status: \"active\", queries: 2341 },\n    { id: 5, name: \"Pedro Sánchez\", email: \"pedro@mail.com\", plan: \"Free\", status: \"active\", queries: 45 },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Users</h2>\n        <Button size=\"sm\" data-testid=\"button-add-user\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Añadir\n        </Button>\n      </div>\n      <div className=\"flex items-center gap-2\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input \n            placeholder=\"Buscar usuarios...\" \n            className=\"pl-9 h-9\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            data-testid=\"input-search-users\"\n          />\n        </div>\n      </div>\n      <div className=\"rounded-lg border\">\n        <div className=\"grid grid-cols-5 gap-4 p-3 border-b bg-muted/50 text-xs font-medium text-muted-foreground\">\n          <span>Usuario</span>\n          <span>Plan</span>\n          <span>Estado</span>\n          <span>Consultas</span>\n          <span></span>\n        </div>\n        {users.filter(u => u.name.toLowerCase().includes(searchQuery.toLowerCase()) || u.email.toLowerCase().includes(searchQuery.toLowerCase())).map((user) => (\n          <div key={user.id} className=\"grid grid-cols-5 gap-4 p-3 border-b last:border-0 items-center text-sm\">\n            <div>\n              <p className=\"font-medium\">{user.name}</p>\n              <p className=\"text-xs text-muted-foreground\">{user.email}</p>\n            </div>\n            <Badge variant=\"secondary\" className=\"w-fit\">{user.plan}</Badge>\n            <Badge variant={user.status === \"active\" ? \"default\" : \"outline\"} className=\"w-fit\">\n              {user.status === \"active\" ? \"Activo\" : \"Inactivo\"}\n            </Badge>\n            <span>{user.queries.toLocaleString()}</span>\n            <Button variant=\"ghost\" size=\"sm\" className=\"w-8 h-8 p-0\">\n              <MoreHorizontal className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction AIModelsSection() {\n  const models = [\n    { name: \"GPT-4 Turbo\", provider: \"OpenAI\", status: \"active\", usage: 78, cost: \"€0.03/1K\" },\n    { name: \"GPT-3.5\", provider: \"OpenAI\", status: \"active\", usage: 45, cost: \"€0.002/1K\" },\n    { name: \"Grok-3\", provider: \"xAI\", status: \"active\", usage: 92, cost: \"€0.05/1K\" },\n    { name: \"Claude 3\", provider: \"Anthropic\", status: \"inactive\", usage: 0, cost: \"€0.025/1K\" },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">AI Models</h2>\n        <Button size=\"sm\" data-testid=\"button-add-model\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Añadir modelo\n        </Button>\n      </div>\n      <div className=\"grid gap-4\">\n        {models.map((model, i) => (\n          <div key={i} className=\"rounded-lg border p-4\">\n            <div className=\"flex items-center justify-between mb-3\">\n              <div className=\"flex items-center gap-3\">\n                <Bot className=\"h-5 w-5\" />\n                <div>\n                  <p className=\"font-medium\">{model.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">{model.provider}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <span className=\"text-xs text-muted-foreground\">{model.cost}</span>\n                <Switch checked={model.status === \"active\"} />\n              </div>\n            </div>\n            <div className=\"space-y-1\">\n              <div className=\"flex justify-between text-xs\">\n                <span className=\"text-muted-foreground\">Uso este mes</span>\n                <span>{model.usage}%</span>\n              </div>\n              <Progress value={model.usage} className=\"h-1.5\" />\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction PaymentsSection() {\n  const payments = [\n    { id: \"PAY-001\", user: \"Carlos García\", amount: \"€99.00\", date: \"15 Dic 2024\", status: \"completed\" },\n    { id: \"PAY-002\", user: \"María López\", amount: \"€49.00\", date: \"14 Dic 2024\", status: \"completed\" },\n    { id: \"PAY-003\", user: \"Juan Martínez\", amount: \"€19.00\", date: \"14 Dic 2024\", status: \"pending\" },\n    { id: \"PAY-004\", user: \"Ana Rodríguez\", amount: \"€99.00\", date: \"13 Dic 2024\", status: \"completed\" },\n    { id: \"PAY-005\", user: \"Pedro Sánchez\", amount: \"€19.00\", date: \"12 Dic 2024\", status: \"failed\" },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Payments</h2>\n      <div className=\"grid grid-cols-3 gap-4\">\n        <div className=\"rounded-lg border p-4\">\n          <p className=\"text-xs text-muted-foreground mb-1\">Ingresos del mes</p>\n          <p className=\"text-xl font-semibold\">€12,450</p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <p className=\"text-xs text-muted-foreground mb-1\">Pagos pendientes</p>\n          <p className=\"text-xl font-semibold\">€380</p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <p className=\"text-xs text-muted-foreground mb-1\">Tasa de éxito</p>\n          <p className=\"text-xl font-semibold\">98.2%</p>\n        </div>\n      </div>\n      <div className=\"rounded-lg border\">\n        <div className=\"grid grid-cols-5 gap-4 p-3 border-b bg-muted/50 text-xs font-medium text-muted-foreground\">\n          <span>ID</span>\n          <span>Usuario</span>\n          <span>Cantidad</span>\n          <span>Fecha</span>\n          <span>Estado</span>\n        </div>\n        {payments.map((payment) => (\n          <div key={payment.id} className=\"grid grid-cols-5 gap-4 p-3 border-b last:border-0 items-center text-sm\">\n            <span className=\"font-mono text-xs\">{payment.id}</span>\n            <span>{payment.user}</span>\n            <span className=\"font-medium\">{payment.amount}</span>\n            <span className=\"text-muted-foreground\">{payment.date}</span>\n            <Badge variant={payment.status === \"completed\" ? \"default\" : payment.status === \"pending\" ? \"secondary\" : \"destructive\"}>\n              {payment.status === \"completed\" ? \"Completado\" : payment.status === \"pending\" ? \"Pendiente\" : \"Fallido\"}\n            </Badge>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction InvoicesSection() {\n  const invoices = [\n    { id: \"INV-2024-001\", client: \"Empresa ABC\", amount: \"€2,970\", date: \"01 Dic 2024\", status: \"paid\" },\n    { id: \"INV-2024-002\", client: \"Startup XYZ\", amount: \"€1,470\", date: \"01 Dic 2024\", status: \"paid\" },\n    { id: \"INV-2024-003\", client: \"Corp 123\", amount: \"€990\", date: \"01 Dic 2024\", status: \"pending\" },\n    { id: \"INV-2024-004\", client: \"Tech Solutions\", amount: \"€2,970\", date: \"01 Nov 2024\", status: \"paid\" },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Invoices</h2>\n        <Button size=\"sm\" data-testid=\"button-create-invoice\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Crear factura\n        </Button>\n      </div>\n      <div className=\"rounded-lg border\">\n        <div className=\"grid grid-cols-5 gap-4 p-3 border-b bg-muted/50 text-xs font-medium text-muted-foreground\">\n          <span>Factura</span>\n          <span>Cliente</span>\n          <span>Importe</span>\n          <span>Fecha</span>\n          <span>Estado</span>\n        </div>\n        {invoices.map((invoice) => (\n          <div key={invoice.id} className=\"grid grid-cols-5 gap-4 p-3 border-b last:border-0 items-center text-sm\">\n            <span className=\"font-mono text-xs\">{invoice.id}</span>\n            <span>{invoice.client}</span>\n            <span className=\"font-medium\">{invoice.amount}</span>\n            <span className=\"text-muted-foreground\">{invoice.date}</span>\n            <div className=\"flex items-center gap-2\">\n              <Badge variant={invoice.status === \"paid\" ? \"default\" : \"secondary\"}>\n                {invoice.status === \"paid\" ? \"Pagada\" : \"Pendiente\"}\n              </Badge>\n              <Button variant=\"ghost\" size=\"sm\" className=\"h-6 px-2\">\n                <Download className=\"h-3 w-3\" />\n              </Button>\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction AnalyticsSection() {\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Analytics</h2>\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"rounded-lg border p-4 space-y-4\">\n          <h3 className=\"text-sm font-medium\">Consultas por día</h3>\n          <div className=\"h-32 flex items-end justify-between gap-1\">\n            {[40, 65, 45, 80, 55, 90, 75].map((h, i) => (\n              <div key={i} className=\"flex-1 bg-primary/20 rounded-t\" style={{ height: `${h}%` }} />\n            ))}\n          </div>\n          <div className=\"flex justify-between text-xs text-muted-foreground\">\n            <span>Lun</span>\n            <span>Mar</span>\n            <span>Mié</span>\n            <span>Jue</span>\n            <span>Vie</span>\n            <span>Sáb</span>\n            <span>Dom</span>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-4\">\n          <h3 className=\"text-sm font-medium\">Uso por modelo</h3>\n          <div className=\"space-y-3\">\n            {[\n              { name: \"Grok-3\", value: 45, color: \"bg-blue-500\" },\n              { name: \"GPT-4\", value: 30, color: \"bg-green-500\" },\n              { name: \"GPT-3.5\", value: 20, color: \"bg-yellow-500\" },\n              { name: \"Otros\", value: 5, color: \"bg-gray-400\" },\n            ].map((item) => (\n              <div key={item.name} className=\"space-y-1\">\n                <div className=\"flex justify-between text-xs\">\n                  <span>{item.name}</span>\n                  <span>{item.value}%</span>\n                </div>\n                <div className=\"h-1.5 bg-muted rounded-full overflow-hidden\">\n                  <div className={cn(\"h-full rounded-full\", item.color)} style={{ width: `${item.value}%` }} />\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n      <div className=\"rounded-lg border p-4\">\n        <h3 className=\"text-sm font-medium mb-4\">Métricas clave</h3>\n        <div className=\"grid grid-cols-4 gap-4\">\n          <div>\n            <p className=\"text-2xl font-semibold\">2.3s</p>\n            <p className=\"text-xs text-muted-foreground\">Tiempo respuesta</p>\n          </div>\n          <div>\n            <p className=\"text-2xl font-semibold\">94%</p>\n            <p className=\"text-xs text-muted-foreground\">Satisfacción</p>\n          </div>\n          <div>\n            <p className=\"text-2xl font-semibold\">1.2M</p>\n            <p className=\"text-xs text-muted-foreground\">Tokens/día</p>\n          </div>\n          <div>\n            <p className=\"text-2xl font-semibold\">€0.08</p>\n            <p className=\"text-xs text-muted-foreground\">Costo/consulta</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction DatabaseSection() {\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Database</h2>\n        <Button variant=\"outline\" size=\"sm\" data-testid=\"button-backup-db\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Backup\n        </Button>\n      </div>\n      <div className=\"grid grid-cols-3 gap-4\">\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <HardDrive className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs text-muted-foreground\">Almacenamiento</span>\n          </div>\n          <p className=\"text-xl font-semibold\">24.5 GB</p>\n          <Progress value={49} className=\"h-1.5 mt-2\" />\n          <p className=\"text-xs text-muted-foreground mt-1\">de 50 GB</p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Activity className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs text-muted-foreground\">Conexiones</span>\n          </div>\n          <p className=\"text-xl font-semibold\">47 / 100</p>\n          <Progress value={47} className=\"h-1.5 mt-2\" />\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs text-muted-foreground\">Último backup</span>\n          </div>\n          <p className=\"text-xl font-semibold\">Hoy</p>\n          <p className=\"text-xs text-muted-foreground\">03:00 AM</p>\n        </div>\n      </div>\n      <div className=\"rounded-lg border p-4\">\n        <h3 className=\"text-sm font-medium mb-4\">Tablas principales</h3>\n        <div className=\"space-y-2\">\n          {[\n            { name: \"users\", rows: \"1,247\", size: \"2.3 MB\" },\n            { name: \"chats\", rows: \"45,892\", size: \"12.1 MB\" },\n            { name: \"messages\", rows: \"234,567\", size: \"8.7 MB\" },\n            { name: \"documents\", rows: \"8,234\", size: \"1.2 MB\" },\n          ].map((table) => (\n            <div key={table.name} className=\"flex items-center justify-between py-2 text-sm\">\n              <span className=\"font-mono\">{table.name}</span>\n              <div className=\"flex items-center gap-6 text-muted-foreground\">\n                <span>{table.rows} filas</span>\n                <span>{table.size}</span>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction SecuritySection() {\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Security</h2>\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"flex items-center gap-2 mb-4\">\n            <Shield className=\"h-5 w-5 text-green-500\" />\n            <span className=\"font-medium\">Estado del sistema</span>\n          </div>\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span>SSL/TLS</span>\n              <Badge variant=\"default\">Activo</Badge>\n            </div>\n            <div className=\"flex items-center justify-between text-sm\">\n              <span>Firewall</span>\n              <Badge variant=\"default\">Activo</Badge>\n            </div>\n            <div className=\"flex items-center justify-between text-sm\">\n              <span>2FA</span>\n              <Badge variant=\"default\">Habilitado</Badge>\n            </div>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"flex items-center gap-2 mb-4\">\n            <Key className=\"h-5 w-5\" />\n            <span className=\"font-medium\">API Keys</span>\n          </div>\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"font-mono text-xs\">sk-****-1234</span>\n              <Badge variant=\"secondary\">Producción</Badge>\n            </div>\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"font-mono text-xs\">sk-****-5678</span>\n              <Badge variant=\"outline\">Desarrollo</Badge>\n            </div>\n          </div>\n          <Button variant=\"outline\" size=\"sm\" className=\"w-full mt-3\">\n            <Plus className=\"h-3 w-3 mr-2\" />\n            Nueva API Key\n          </Button>\n        </div>\n      </div>\n      <div className=\"rounded-lg border p-4\">\n        <div className=\"flex items-center gap-2 mb-4\">\n          <AlertTriangle className=\"h-5 w-5 text-yellow-500\" />\n          <span className=\"font-medium\">Actividad reciente</span>\n        </div>\n        <div className=\"space-y-2\">\n          {[\n            { event: \"Login exitoso\", user: \"admin@empresa.com\", ip: \"192.168.1.1\", time: \"Hace 5 min\" },\n            { event: \"API Key creada\", user: \"admin@empresa.com\", ip: \"192.168.1.1\", time: \"Hace 2 horas\" },\n            { event: \"Intento fallido\", user: \"unknown\", ip: \"45.33.32.156\", time: \"Hace 1 día\" },\n          ].map((log, i) => (\n            <div key={i} className=\"flex items-center justify-between py-2 text-sm\">\n              <div>\n                <span>{log.event}</span>\n                <span className=\"text-muted-foreground ml-2\">- {log.user}</span>\n              </div>\n              <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                <span>{log.ip}</span>\n                <span>{log.time}</span>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction ReportsSection() {\n  const reports = [\n    { name: \"Informe mensual - Diciembre 2024\", type: \"Mensual\", date: \"01 Dic 2024\", status: \"ready\" },\n    { name: \"Análisis de uso Q4 2024\", type: \"Trimestral\", date: \"01 Oct 2024\", status: \"ready\" },\n    { name: \"Reporte de facturación\", type: \"Semanal\", date: \"15 Dic 2024\", status: \"generating\" },\n    { name: \"Informe de seguridad\", type: \"Mensual\", date: \"01 Dic 2024\", status: \"ready\" },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Reports</h2>\n        <Button size=\"sm\" data-testid=\"button-generate-report\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Generar reporte\n        </Button>\n      </div>\n      <div className=\"rounded-lg border\">\n        {reports.map((report, i) => (\n          <div key={i} className=\"flex items-center justify-between p-4 border-b last:border-0\">\n            <div>\n              <p className=\"font-medium text-sm\">{report.name}</p>\n              <p className=\"text-xs text-muted-foreground\">{report.type} - {report.date}</p>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              {report.status === \"ready\" ? (\n                <Button variant=\"outline\" size=\"sm\">\n                  <Download className=\"h-3 w-3 mr-2\" />\n                  Descargar\n                </Button>\n              ) : (\n                <Badge variant=\"secondary\">\n                  <RefreshCw className=\"h-3 w-3 mr-1 animate-spin\" />\n                  Generando\n                </Badge>\n              )}\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction SettingsSection() {\n  const [maintenanceMode, setMaintenanceMode] = useState(false);\n  const [emailNotifications, setEmailNotifications] = useState(true);\n  const [autoBackup, setAutoBackup] = useState(true);\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Settings</h2>\n      <div className=\"space-y-4\">\n        <div className=\"rounded-lg border p-4\">\n          <h3 className=\"text-sm font-medium mb-4\">General</h3>\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium\">Modo mantenimiento</p>\n                <p className=\"text-xs text-muted-foreground\">Desactiva el acceso público</p>\n              </div>\n              <Switch checked={maintenanceMode} onCheckedChange={setMaintenanceMode} />\n            </div>\n            <Separator />\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium\">Notificaciones por email</p>\n                <p className=\"text-xs text-muted-foreground\">Alertas del sistema</p>\n              </div>\n              <Switch checked={emailNotifications} onCheckedChange={setEmailNotifications} />\n            </div>\n            <Separator />\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium\">Backup automático</p>\n                <p className=\"text-xs text-muted-foreground\">Diario a las 03:00</p>\n              </div>\n              <Switch checked={autoBackup} onCheckedChange={setAutoBackup} />\n            </div>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <h3 className=\"text-sm font-medium mb-4\">Límites</h3>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span>Consultas por usuario/día</span>\n                <span className=\"font-medium\">100</span>\n              </div>\n              <Input type=\"number\" defaultValue={100} className=\"h-8\" />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span>Tokens máximos por consulta</span>\n                <span className=\"font-medium\">4096</span>\n              </div>\n              <Input type=\"number\" defaultValue={4096} className=\"h-8\" />\n            </div>\n          </div>\n        </div>\n        <Button className=\"w-full\" data-testid=\"button-save-settings\">Guardar configuración</Button>\n      </div>\n    </div>\n  );\n}\n\nexport function AdminPanel({ open, onOpenChange }: AdminPanelProps) {\n  const [activeSection, setActiveSection] = useState<AdminSection>(\"dashboard\");\n\n  const renderSection = () => {\n    switch (activeSection) {\n      case \"dashboard\": return <DashboardSection />;\n      case \"users\": return <UsersSection />;\n      case \"ai-models\": return <AIModelsSection />;\n      case \"payments\": return <PaymentsSection />;\n      case \"invoices\": return <InvoicesSection />;\n      case \"analytics\": return <AnalyticsSection />;\n      case \"database\": return <DatabaseSection />;\n      case \"security\": return <SecuritySection />;\n      case \"reports\": return <ReportsSection />;\n      case \"settings\": return <SettingsSection />;\n      default: return <DashboardSection />;\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-5xl h-[80vh] p-0 gap-0\">\n        <DialogTitle className=\"sr-only\">Admin Panel</DialogTitle>\n        <div className=\"flex h-full\">\n          <div className=\"w-48 border-r bg-muted/30 p-2\">\n            <div className=\"p-2 mb-2\">\n              <h2 className=\"font-semibold text-sm\">Administration</h2>\n            </div>\n            <nav className=\"space-y-0.5\">\n              {navItems.map((item) => (\n                <button\n                  key={item.id}\n                  onClick={() => setActiveSection(item.id)}\n                  className={cn(\n                    \"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md transition-colors\",\n                    activeSection === item.id\n                      ? \"bg-background shadow-sm font-medium\"\n                      : \"text-muted-foreground hover:bg-background/50\"\n                  )}\n                  data-testid={`button-admin-nav-${item.id}`}\n                >\n                  <item.icon className=\"h-4 w-4\" />\n                  {item.label}\n                </button>\n              ))}\n            </nav>\n          </div>\n          <div className=\"flex-1 overflow-hidden\">\n            <ScrollArea className=\"h-full\">\n              <div className=\"p-6\">\n                {renderSection()}\n              </div>\n            </ScrollArea>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":28892,"size_tokens":null},"client/src/pages/admin.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport {\n  ArrowLeft,\n  LayoutDashboard,\n  Users,\n  Bot,\n  CreditCard,\n  FileText,\n  BarChart3,\n  Database,\n  Shield,\n  FileBarChart,\n  Settings,\n  Search,\n  Plus,\n  MoreHorizontal,\n  CheckCircle,\n  TrendingUp,\n  Activity,\n  HardDrive,\n  Clock,\n  Key,\n  AlertTriangle,\n  Download,\n  RefreshCw,\n  Trash2,\n  Edit,\n  Loader2\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { format } from \"date-fns\";\n\ntype AdminSection = \"dashboard\" | \"users\" | \"ai-models\" | \"payments\" | \"invoices\" | \"analytics\" | \"database\" | \"security\" | \"reports\" | \"settings\";\n\nconst navItems: { id: AdminSection; label: string; icon: React.ElementType }[] = [\n  { id: \"dashboard\", label: \"Dashboard\", icon: LayoutDashboard },\n  { id: \"users\", label: \"Users\", icon: Users },\n  { id: \"ai-models\", label: \"AI Models\", icon: Bot },\n  { id: \"payments\", label: \"Payments\", icon: CreditCard },\n  { id: \"invoices\", label: \"Invoices\", icon: FileText },\n  { id: \"analytics\", label: \"Analytics\", icon: BarChart3 },\n  { id: \"database\", label: \"Database\", icon: Database },\n  { id: \"security\", label: \"Security\", icon: Shield },\n  { id: \"reports\", label: \"Reports\", icon: FileBarChart },\n  { id: \"settings\", label: \"Settings\", icon: Settings },\n];\n\nfunction DashboardSection() {\n  const { data: dashboardData, isLoading } = useQuery({\n    queryKey: [\"/api/admin/dashboard\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/dashboard\");\n      return res.json();\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  const metrics = dashboardData?.metrics || { users: 0, queries: 0, revenue: \"0\", uptime: 99.9 };\n  const recentActivity = dashboardData?.recentActivity || [];\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Dashboard</h2>\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Usuarios</span>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n          <p className=\"text-2xl font-semibold\" data-testid=\"text-total-users\">{metrics.users.toLocaleString()}</p>\n          <div className=\"flex items-center text-xs text-green-600\">\n            <TrendingUp className=\"h-3 w-3 mr-1\" />\n            Activos\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Consultas</span>\n            <Activity className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n          <p className=\"text-2xl font-semibold\" data-testid=\"text-total-queries\">{metrics.queries.toLocaleString()}</p>\n          <div className=\"flex items-center text-xs text-green-600\">\n            <TrendingUp className=\"h-3 w-3 mr-1\" />\n            Total\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Ingresos</span>\n            <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n          <p className=\"text-2xl font-semibold\" data-testid=\"text-total-revenue\">€{parseFloat(metrics.revenue).toLocaleString()}</p>\n          <div className=\"flex items-center text-xs text-green-600\">\n            <TrendingUp className=\"h-3 w-3 mr-1\" />\n            Total\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Uptime</span>\n            <CheckCircle className=\"h-4 w-4 text-green-500\" />\n          </div>\n          <p className=\"text-2xl font-semibold\" data-testid=\"text-uptime\">{metrics.uptime}%</p>\n          <span className=\"text-xs text-muted-foreground\">Últimos 30 días</span>\n        </div>\n      </div>\n      <div className=\"rounded-lg border p-4\">\n        <h3 className=\"text-sm font-medium mb-4\">Actividad reciente</h3>\n        <div className=\"space-y-3\">\n          {recentActivity.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground\">No hay actividad reciente</p>\n          ) : (\n            recentActivity.slice(0, 5).map((item: any, i: number) => (\n              <div key={i} className=\"flex items-center justify-between py-2 text-sm\">\n                <span>{item.action} - {item.resource}</span>\n                <span className=\"text-xs text-muted-foreground\">\n                  {item.createdAt ? format(new Date(item.createdAt), \"dd/MM HH:mm\") : \"\"}\n                </span>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction UsersSection() {\n  const queryClient = useQueryClient();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [editingUser, setEditingUser] = useState<any>(null);\n  const [showAddUserModal, setShowAddUserModal] = useState(false);\n  const [newUser, setNewUser] = useState({ email: \"\", password: \"\", plan: \"free\", role: \"user\" });\n\n  const { data: users = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/users\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/users\");\n      return res.json();\n    }\n  });\n\n  const updateUserMutation = useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: any }) => {\n      const res = await fetch(`/api/admin/users/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates)\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      setEditingUser(null);\n    }\n  });\n\n  const deleteUserMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await fetch(`/api/admin/users/${id}`, { method: \"DELETE\" });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n    }\n  });\n\n  const createUserMutation = useMutation({\n    mutationFn: async (userData: { email: string; password: string; plan: string; role: string }) => {\n      const res = await fetch(\"/api/admin/users\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(userData)\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.message || \"Error al crear usuario\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      setShowAddUserModal(false);\n      setNewUser({ email: \"\", password: \"\", plan: \"free\", role: \"user\" });\n    }\n  });\n\n  const filteredUsers = users.filter((u: any) => \n    u.username?.toLowerCase().includes(searchQuery.toLowerCase()) || \n    u.email?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Users ({users.length})</h2>\n        <Dialog open={showAddUserModal} onOpenChange={setShowAddUserModal}>\n          <DialogTrigger asChild>\n            <Button size=\"sm\" className=\"gap-1\" data-testid=\"button-add-user\">\n              <Plus className=\"h-4 w-4\" />\n              Agregar usuario\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Agregar nuevo usuario</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Email</Label>\n                <Input \n                  type=\"email\"\n                  placeholder=\"usuario@ejemplo.com\"\n                  value={newUser.email}\n                  onChange={(e) => setNewUser({ ...newUser, email: e.target.value })}\n                  data-testid=\"input-new-user-email\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Contraseña</Label>\n                <Input \n                  type=\"password\"\n                  placeholder=\"••••••••\"\n                  value={newUser.password}\n                  onChange={(e) => setNewUser({ ...newUser, password: e.target.value })}\n                  data-testid=\"input-new-user-password\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Plan</Label>\n                <Select \n                  value={newUser.plan}\n                  onValueChange={(value) => setNewUser({ ...newUser, plan: value })}\n                >\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"free\">Free</SelectItem>\n                    <SelectItem value=\"go\">Go</SelectItem>\n                    <SelectItem value=\"plus\">Plus</SelectItem>\n                    <SelectItem value=\"pro\">Pro</SelectItem>\n                    <SelectItem value=\"business\">Business</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Rol</Label>\n                <Select \n                  value={newUser.role}\n                  onValueChange={(value) => setNewUser({ ...newUser, role: value })}\n                >\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"user\">Usuario</SelectItem>\n                    <SelectItem value=\"admin\">Admin</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <Button \n                className=\"w-full\" \n                onClick={() => createUserMutation.mutate(newUser)}\n                disabled={!newUser.email || !newUser.password || createUserMutation.isPending}\n                data-testid=\"button-submit-new-user\"\n              >\n                {createUserMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Creando...\n                  </>\n                ) : (\n                  \"Crear usuario\"\n                )}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n      <div className=\"flex items-center gap-2\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input \n            placeholder=\"Buscar usuarios...\" \n            className=\"pl-9 h-9\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            data-testid=\"input-search-users\"\n          />\n        </div>\n      </div>\n      <div className=\"rounded-lg border\">\n        <div className=\"grid grid-cols-6 gap-4 p-3 border-b bg-muted/50 text-xs font-medium text-muted-foreground\">\n          <span>Usuario</span>\n          <span>Plan</span>\n          <span>Rol</span>\n          <span>Estado</span>\n          <span>Consultas</span>\n          <span>Acciones</span>\n        </div>\n        {filteredUsers.length === 0 ? (\n          <div className=\"p-4 text-sm text-muted-foreground text-center\">No hay usuarios</div>\n        ) : (\n          filteredUsers.map((user: any) => (\n            <div key={user.id} className=\"grid grid-cols-6 gap-4 p-3 border-b last:border-0 items-center text-sm\">\n              <div>\n                <p className=\"font-medium\">{user.username}</p>\n                <p className=\"text-xs text-muted-foreground\">{user.email || \"-\"}</p>\n              </div>\n              <Badge variant=\"secondary\" className=\"w-fit\">{user.plan || \"free\"}</Badge>\n              <Badge variant=\"outline\" className=\"w-fit\">{user.role || \"user\"}</Badge>\n              <Badge variant={user.status === \"active\" ? \"default\" : \"outline\"} className=\"w-fit\">\n                {user.status === \"active\" ? \"Activo\" : \"Inactivo\"}\n              </Badge>\n              <span>{(user.queryCount || 0).toLocaleString()}</span>\n              <div className=\"flex gap-1\">\n                <Dialog>\n                  <DialogTrigger asChild>\n                    <Button variant=\"ghost\" size=\"sm\" className=\"h-7 w-7 p-0\" onClick={() => setEditingUser(user)}>\n                      <Edit className=\"h-3 w-3\" />\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Editar usuario</DialogTitle>\n                    </DialogHeader>\n                    <div className=\"space-y-4 py-4\">\n                      <div className=\"space-y-2\">\n                        <Label>Plan</Label>\n                        <Select \n                          defaultValue={user.plan || \"free\"}\n                          onValueChange={(value) => updateUserMutation.mutate({ id: user.id, updates: { plan: value } })}\n                        >\n                          <SelectTrigger>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"free\">Free</SelectItem>\n                            <SelectItem value=\"basic\">Basic</SelectItem>\n                            <SelectItem value=\"pro\">Pro</SelectItem>\n                            <SelectItem value=\"enterprise\">Enterprise</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Estado</Label>\n                        <Select \n                          defaultValue={user.status || \"active\"}\n                          onValueChange={(value) => updateUserMutation.mutate({ id: user.id, updates: { status: value } })}\n                        >\n                          <SelectTrigger>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"active\">Activo</SelectItem>\n                            <SelectItem value=\"inactive\">Inactivo</SelectItem>\n                            <SelectItem value=\"suspended\">Suspendido</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Rol</Label>\n                        <Select \n                          defaultValue={user.role || \"user\"}\n                          onValueChange={(value) => updateUserMutation.mutate({ id: user.id, updates: { role: value } })}\n                        >\n                          <SelectTrigger>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"user\">Usuario</SelectItem>\n                            <SelectItem value=\"admin\">Admin</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                  </DialogContent>\n                </Dialog>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  className=\"h-7 w-7 p-0 text-destructive\" \n                  onClick={() => deleteUserMutation.mutate(user.id)}\n                  data-testid={`button-delete-user-${user.id}`}\n                >\n                  <Trash2 className=\"h-3 w-3\" />\n                </Button>\n              </div>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction AIModelsSection() {\n  const queryClient = useQueryClient();\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newModel, setNewModel] = useState({ name: \"\", provider: \"\", modelId: \"\", costPer1k: \"0.00\", description: \"\" });\n\n  const { data: models = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/models\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/models\");\n      return res.json();\n    }\n  });\n\n  const createModelMutation = useMutation({\n    mutationFn: async (model: any) => {\n      const res = await fetch(\"/api/admin/models\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(model)\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/models\"] });\n      setShowAddModal(false);\n      setNewModel({ name: \"\", provider: \"\", modelId: \"\", costPer1k: \"0.00\", description: \"\" });\n    }\n  });\n\n  const updateModelMutation = useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: any }) => {\n      const res = await fetch(`/api/admin/models/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates)\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/models\"] });\n    }\n  });\n\n  const deleteModelMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await fetch(`/api/admin/models/${id}`, { method: \"DELETE\" });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/models\"] });\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">AI Models ({models.length})</h2>\n        <Dialog open={showAddModal} onOpenChange={setShowAddModal}>\n          <DialogTrigger asChild>\n            <Button size=\"sm\" data-testid=\"button-add-model\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Añadir modelo\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Añadir modelo AI</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Nombre</Label>\n                <Input \n                  placeholder=\"GPT-4 Turbo\" \n                  value={newModel.name}\n                  onChange={(e) => setNewModel({ ...newModel, name: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Proveedor</Label>\n                <Input \n                  placeholder=\"OpenAI\" \n                  value={newModel.provider}\n                  onChange={(e) => setNewModel({ ...newModel, provider: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Model ID</Label>\n                <Input \n                  placeholder=\"gpt-4-turbo\" \n                  value={newModel.modelId}\n                  onChange={(e) => setNewModel({ ...newModel, modelId: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Costo por 1K tokens</Label>\n                <Input \n                  placeholder=\"0.03\" \n                  value={newModel.costPer1k}\n                  onChange={(e) => setNewModel({ ...newModel, costPer1k: e.target.value })}\n                />\n              </div>\n              <Button \n                className=\"w-full\" \n                onClick={() => createModelMutation.mutate(newModel)}\n                disabled={!newModel.name || !newModel.provider || !newModel.modelId}\n              >\n                Crear modelo\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n      <div className=\"grid gap-4\">\n        {models.length === 0 ? (\n          <div className=\"rounded-lg border p-8 text-center text-muted-foreground\">\n            No hay modelos configurados. Añade uno para empezar.\n          </div>\n        ) : (\n          models.map((model: any) => (\n            <div key={model.id} className=\"rounded-lg border p-4\">\n              <div className=\"flex items-center justify-between mb-3\">\n                <div className=\"flex items-center gap-3\">\n                  <Bot className=\"h-5 w-5\" />\n                  <div>\n                    <p className=\"font-medium\">{model.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{model.provider} - {model.modelId}</p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <span className=\"text-xs text-muted-foreground\">€{model.costPer1k}/1K</span>\n                  <Switch \n                    checked={model.status === \"active\"} \n                    onCheckedChange={(checked) => updateModelMutation.mutate({ \n                      id: model.id, \n                      updates: { status: checked ? \"active\" : \"inactive\" } \n                    })}\n                    data-testid={`switch-model-${model.id}`}\n                  />\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\" \n                    className=\"h-7 w-7 p-0 text-destructive\"\n                    onClick={() => deleteModelMutation.mutate(model.id)}\n                  >\n                    <Trash2 className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n              </div>\n              <div className=\"space-y-1\">\n                <div className=\"flex justify-between text-xs\">\n                  <span className=\"text-muted-foreground\">Uso este mes</span>\n                  <span>{model.usagePercent || 0}%</span>\n                </div>\n                <Progress value={model.usagePercent || 0} className=\"h-1.5\" />\n              </div>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction PaymentsSection() {\n  const queryClient = useQueryClient();\n\n  const { data: payments = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/payments\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/payments\");\n      return res.json();\n    }\n  });\n\n  const { data: stats } = useQuery({\n    queryKey: [\"/api/admin/payments/stats\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/payments/stats\");\n      return res.json();\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Payments</h2>\n      <div className=\"grid grid-cols-3 gap-4\">\n        <div className=\"rounded-lg border p-4\">\n          <p className=\"text-xs text-muted-foreground mb-1\">Total ingresos</p>\n          <p className=\"text-xl font-semibold\" data-testid=\"text-total-payments\">€{stats?.total || \"0\"}</p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <p className=\"text-xs text-muted-foreground mb-1\">Este mes</p>\n          <p className=\"text-xl font-semibold\">€{stats?.thisMonth || \"0\"}</p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <p className=\"text-xs text-muted-foreground mb-1\">Transacciones</p>\n          <p className=\"text-xl font-semibold\">{stats?.count || 0}</p>\n        </div>\n      </div>\n      <div className=\"rounded-lg border\">\n        <div className=\"grid grid-cols-5 gap-4 p-3 border-b bg-muted/50 text-xs font-medium text-muted-foreground\">\n          <span>ID</span>\n          <span>Usuario</span>\n          <span>Cantidad</span>\n          <span>Fecha</span>\n          <span>Estado</span>\n        </div>\n        {payments.length === 0 ? (\n          <div className=\"p-4 text-sm text-muted-foreground text-center\">No hay pagos registrados</div>\n        ) : (\n          payments.map((payment: any) => (\n            <div key={payment.id} className=\"grid grid-cols-5 gap-4 p-3 border-b last:border-0 items-center text-sm\">\n              <span className=\"font-mono text-xs\">{payment.id.slice(0, 8)}</span>\n              <span>{payment.userId || \"N/A\"}</span>\n              <span className=\"font-medium\">€{payment.amount}</span>\n              <span className=\"text-muted-foreground\">\n                {payment.createdAt ? format(new Date(payment.createdAt), \"dd MMM yyyy\") : \"-\"}\n              </span>\n              <Badge variant={payment.status === \"completed\" ? \"default\" : payment.status === \"pending\" ? \"secondary\" : \"destructive\"}>\n                {payment.status === \"completed\" ? \"Completado\" : payment.status === \"pending\" ? \"Pendiente\" : \"Fallido\"}\n              </Badge>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction InvoicesSection() {\n  const queryClient = useQueryClient();\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newInvoice, setNewInvoice] = useState({ invoiceNumber: \"\", amount: \"\", userId: \"\" });\n\n  const { data: invoices = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/invoices\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/invoices\");\n      return res.json();\n    }\n  });\n\n  const createInvoiceMutation = useMutation({\n    mutationFn: async (invoice: any) => {\n      const res = await fetch(\"/api/admin/invoices\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(invoice)\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/invoices\"] });\n      setShowAddModal(false);\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Invoices ({invoices.length})</h2>\n        <Dialog open={showAddModal} onOpenChange={setShowAddModal}>\n          <DialogTrigger asChild>\n            <Button size=\"sm\" data-testid=\"button-create-invoice\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Crear factura\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Crear factura</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Número de factura</Label>\n                <Input \n                  placeholder=\"INV-2024-001\" \n                  value={newInvoice.invoiceNumber}\n                  onChange={(e) => setNewInvoice({ ...newInvoice, invoiceNumber: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Importe</Label>\n                <Input \n                  placeholder=\"99.00\" \n                  value={newInvoice.amount}\n                  onChange={(e) => setNewInvoice({ ...newInvoice, amount: e.target.value })}\n                />\n              </div>\n              <Button \n                className=\"w-full\" \n                onClick={() => createInvoiceMutation.mutate(newInvoice)}\n                disabled={!newInvoice.invoiceNumber || !newInvoice.amount}\n              >\n                Crear factura\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n      <div className=\"rounded-lg border\">\n        <div className=\"grid grid-cols-5 gap-4 p-3 border-b bg-muted/50 text-xs font-medium text-muted-foreground\">\n          <span>Factura</span>\n          <span>Cliente</span>\n          <span>Importe</span>\n          <span>Fecha</span>\n          <span>Estado</span>\n        </div>\n        {invoices.length === 0 ? (\n          <div className=\"p-4 text-sm text-muted-foreground text-center\">No hay facturas</div>\n        ) : (\n          invoices.map((invoice: any) => (\n            <div key={invoice.id} className=\"grid grid-cols-5 gap-4 p-3 border-b last:border-0 items-center text-sm\">\n              <span className=\"font-mono text-xs\">{invoice.invoiceNumber}</span>\n              <span>{invoice.userId || \"N/A\"}</span>\n              <span className=\"font-medium\">€{invoice.amount}</span>\n              <span className=\"text-muted-foreground\">\n                {invoice.createdAt ? format(new Date(invoice.createdAt), \"dd MMM yyyy\") : \"-\"}\n              </span>\n              <div className=\"flex items-center gap-2\">\n                <Badge variant={invoice.status === \"paid\" ? \"default\" : \"secondary\"}>\n                  {invoice.status === \"paid\" ? \"Pagada\" : \"Pendiente\"}\n                </Badge>\n                <Button variant=\"ghost\" size=\"sm\" className=\"h-6 px-2\" data-testid={`button-download-invoice-${invoice.id}`}>\n                  <Download className=\"h-3 w-3\" />\n                </Button>\n              </div>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction AnalyticsSection() {\n  const { data: snapshots = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/analytics\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/analytics?days=30\");\n      return res.json();\n    }\n  });\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Analytics</h2>\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"rounded-lg border p-4 space-y-4\">\n          <h3 className=\"text-sm font-medium\">Actividad reciente</h3>\n          <div className=\"h-32 flex items-end justify-between gap-1\">\n            {(snapshots.length > 0 ? snapshots.slice(-7) : [1,2,3,4,5,6,7].map(() => ({ totalQueries: Math.random() * 100 }))).map((s: any, i: number) => (\n              <div key={i} className=\"flex-1 bg-primary/20 rounded-t\" style={{ height: `${Math.max(10, (s.totalQueries || 0) % 100)}%` }} />\n            ))}\n          </div>\n          <p className=\"text-xs text-muted-foreground text-center\">Últimos 7 días</p>\n        </div>\n        <div className=\"rounded-lg border p-4 space-y-4\">\n          <h3 className=\"text-sm font-medium\">Resumen</h3>\n          <div className=\"space-y-3\">\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-sm text-muted-foreground\">Registros de analytics</span>\n              <span className=\"font-medium\">{snapshots.length}</span>\n            </div>\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-sm text-muted-foreground\">Período</span>\n              <span className=\"font-medium\">30 días</span>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div className=\"rounded-lg border p-4\">\n        <h3 className=\"text-sm font-medium mb-4\">Métricas clave</h3>\n        <div className=\"grid grid-cols-4 gap-4\">\n          <div>\n            <p className=\"text-2xl font-semibold\">2.3s</p>\n            <p className=\"text-xs text-muted-foreground\">Tiempo respuesta</p>\n          </div>\n          <div>\n            <p className=\"text-2xl font-semibold\">94%</p>\n            <p className=\"text-xs text-muted-foreground\">Satisfacción</p>\n          </div>\n          <div>\n            <p className=\"text-2xl font-semibold\">{snapshots.reduce((sum: number, s: any) => sum + (s.totalQueries || 0), 0).toLocaleString()}</p>\n            <p className=\"text-xs text-muted-foreground\">Consultas totales</p>\n          </div>\n          <div>\n            <p className=\"text-2xl font-semibold\">€{snapshots.reduce((sum: number, s: any) => sum + parseFloat(s.revenue || \"0\"), 0).toFixed(2)}</p>\n            <p className=\"text-xs text-muted-foreground\">Ingresos período</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction DatabaseSection() {\n  const { data: dbInfo, isLoading, refetch } = useQuery({\n    queryKey: [\"/api/admin/database/info\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/database/info\");\n      return res.json();\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Database</h2>\n        <Button variant=\"outline\" size=\"sm\" onClick={() => refetch()} data-testid=\"button-refresh-db\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Actualizar\n        </Button>\n      </div>\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"flex items-center gap-2 mb-4\">\n            <Database className=\"h-5 w-5 text-muted-foreground\" />\n            <span className=\"font-medium\">Estado</span>\n          </div>\n          <Badge variant={dbInfo?.status === \"healthy\" ? \"default\" : \"destructive\"} className=\"mb-2\">\n            {dbInfo?.status === \"healthy\" ? \"Saludable\" : \"Error\"}\n          </Badge>\n          <p className=\"text-xs text-muted-foreground\">\n            Último backup: {dbInfo?.lastBackup ? format(new Date(dbInfo.lastBackup), \"dd/MM/yyyy HH:mm\") : \"N/A\"}\n          </p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"flex items-center gap-2 mb-4\">\n            <HardDrive className=\"h-5 w-5 text-muted-foreground\" />\n            <span className=\"font-medium\">Tablas</span>\n          </div>\n          <div className=\"space-y-2\">\n            {dbInfo?.tables && Object.entries(dbInfo.tables).map(([name, info]: [string, any]) => (\n              <div key={name} className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">{name}</span>\n                <span>{info.count} registros</span>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction SecuritySection() {\n  const queryClient = useQueryClient();\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newPolicy, setNewPolicy] = useState({ domain: \"\", allowNavigation: \"true\", rateLimit: 10 });\n\n  const { data: policies = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/security/policies\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/security/policies\");\n      return res.json();\n    }\n  });\n\n  const { data: auditLogs = [] } = useQuery({\n    queryKey: [\"/api/admin/security/logs\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/security/logs?limit=20\");\n      return res.json();\n    }\n  });\n\n  const createPolicyMutation = useMutation({\n    mutationFn: async (policy: any) => {\n      const res = await fetch(\"/api/admin/security/policies\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(policy)\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/security/policies\"] });\n      setShowAddModal(false);\n    }\n  });\n\n  const deletePolicyMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await fetch(`/api/admin/security/policies/${id}`, { method: \"DELETE\" });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/security/policies\"] });\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Security</h2>\n      \n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-sm font-medium\">Políticas de dominio</h3>\n          <Dialog open={showAddModal} onOpenChange={setShowAddModal}>\n            <DialogTrigger asChild>\n              <Button size=\"sm\" variant=\"outline\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Añadir política\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Nueva política de dominio</DialogTitle>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label>Dominio</Label>\n                  <Input \n                    placeholder=\"ejemplo.com\" \n                    value={newPolicy.domain}\n                    onChange={(e) => setNewPolicy({ ...newPolicy, domain: e.target.value })}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Límite de peticiones/min</Label>\n                  <Input \n                    type=\"number\"\n                    value={newPolicy.rateLimit}\n                    onChange={(e) => setNewPolicy({ ...newPolicy, rateLimit: parseInt(e.target.value) })}\n                  />\n                </div>\n                <Button \n                  className=\"w-full\" \n                  onClick={() => createPolicyMutation.mutate(newPolicy)}\n                  disabled={!newPolicy.domain}\n                >\n                  Crear política\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n        \n        <div className=\"rounded-lg border\">\n          {policies.length === 0 ? (\n            <div className=\"p-4 text-sm text-muted-foreground text-center\">No hay políticas configuradas</div>\n          ) : (\n            policies.map((policy: any) => (\n              <div key={policy.id} className=\"flex items-center justify-between p-3 border-b last:border-0\">\n                <div>\n                  <p className=\"font-medium\">{policy.domain}</p>\n                  <p className=\"text-xs text-muted-foreground\">Límite: {policy.rateLimit} req/min</p>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Badge variant={policy.allowNavigation === \"true\" ? \"default\" : \"secondary\"}>\n                    {policy.allowNavigation === \"true\" ? \"Permitido\" : \"Bloqueado\"}\n                  </Badge>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\" \n                    className=\"h-7 w-7 p-0 text-destructive\"\n                    onClick={() => deletePolicyMutation.mutate(policy.id)}\n                  >\n                    <Trash2 className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      <div className=\"space-y-4\">\n        <h3 className=\"text-sm font-medium\">Registro de auditoría</h3>\n        <div className=\"rounded-lg border max-h-64 overflow-auto\">\n          {auditLogs.length === 0 ? (\n            <div className=\"p-4 text-sm text-muted-foreground text-center\">No hay registros</div>\n          ) : (\n            auditLogs.map((log: any) => (\n              <div key={log.id} className=\"flex items-center justify-between p-3 border-b last:border-0 text-sm\">\n                <div>\n                  <span className=\"font-medium\">{log.action}</span>\n                  <span className=\"text-muted-foreground\"> - {log.resource}</span>\n                </div>\n                <span className=\"text-xs text-muted-foreground\">\n                  {log.createdAt ? format(new Date(log.createdAt), \"dd/MM HH:mm\") : \"\"}\n                </span>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction ReportsSection() {\n  const queryClient = useQueryClient();\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newReport, setNewReport] = useState({ name: \"\", type: \"usage\" });\n\n  const { data: reports = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/reports\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/reports\");\n      return res.json();\n    }\n  });\n\n  const createReportMutation = useMutation({\n    mutationFn: async (report: any) => {\n      const res = await fetch(\"/api/admin/reports\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(report)\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/reports\"] });\n      setShowAddModal(false);\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-lg font-medium\">Reports ({reports.length})</h2>\n        <Dialog open={showAddModal} onOpenChange={setShowAddModal}>\n          <DialogTrigger asChild>\n            <Button size=\"sm\" data-testid=\"button-create-report\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Generar reporte\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Generar reporte</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Nombre</Label>\n                <Input \n                  placeholder=\"Reporte mensual\" \n                  value={newReport.name}\n                  onChange={(e) => setNewReport({ ...newReport, name: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Tipo</Label>\n                <Select value={newReport.type} onValueChange={(value) => setNewReport({ ...newReport, type: value })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"usage\">Uso</SelectItem>\n                    <SelectItem value=\"revenue\">Ingresos</SelectItem>\n                    <SelectItem value=\"users\">Usuarios</SelectItem>\n                    <SelectItem value=\"performance\">Rendimiento</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <Button \n                className=\"w-full\" \n                onClick={() => createReportMutation.mutate(newReport)}\n                disabled={!newReport.name}\n              >\n                Generar\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n      <div className=\"rounded-lg border\">\n        {reports.length === 0 ? (\n          <div className=\"p-4 text-sm text-muted-foreground text-center\">No hay reportes generados</div>\n        ) : (\n          reports.map((report: any) => (\n            <div key={report.id} className=\"flex items-center justify-between p-3 border-b last:border-0\">\n              <div>\n                <p className=\"font-medium\">{report.name}</p>\n                <p className=\"text-xs text-muted-foreground\">\n                  {report.type} - {report.createdAt ? format(new Date(report.createdAt), \"dd/MM/yyyy\") : \"\"}\n                </p>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Badge variant={report.status === \"completed\" ? \"default\" : \"secondary\"}>\n                  {report.status === \"completed\" ? \"Completado\" : \"Pendiente\"}\n                </Badge>\n                {report.filePath && (\n                  <Button variant=\"ghost\" size=\"sm\" className=\"h-7 px-2\">\n                    <Download className=\"h-3 w-3\" />\n                  </Button>\n                )}\n              </div>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction SettingsSection() {\n  const queryClient = useQueryClient();\n  const [newSetting, setNewSetting] = useState({ key: \"\", value: \"\", description: \"\", category: \"general\" });\n\n  const { data: settings = [], isLoading } = useQuery({\n    queryKey: [\"/api/admin/settings\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/settings\");\n      return res.json();\n    }\n  });\n\n  const upsertSettingMutation = useMutation({\n    mutationFn: async (setting: any) => {\n      const res = await fetch(\"/api/admin/settings\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(setting)\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/settings\"] });\n      setNewSetting({ key: \"\", value: \"\", description: \"\", category: \"general\" });\n    }\n  });\n\n  if (isLoading) {\n    return <div className=\"flex items-center justify-center py-12\"><Loader2 className=\"h-6 w-6 animate-spin\" /></div>;\n  }\n\n  const groupedSettings = settings.reduce((acc: any, s: any) => {\n    const cat = s.category || \"general\";\n    if (!acc[cat]) acc[cat] = [];\n    acc[cat].push(s);\n    return acc;\n  }, {});\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-lg font-medium\">Settings</h2>\n      \n      <div className=\"rounded-lg border p-4 space-y-4\">\n        <h3 className=\"text-sm font-medium\">Añadir configuración</h3>\n        <div className=\"grid grid-cols-4 gap-4\">\n          <Input \n            placeholder=\"Clave\" \n            value={newSetting.key}\n            onChange={(e) => setNewSetting({ ...newSetting, key: e.target.value })}\n          />\n          <Input \n            placeholder=\"Valor\" \n            value={newSetting.value}\n            onChange={(e) => setNewSetting({ ...newSetting, value: e.target.value })}\n          />\n          <Select value={newSetting.category} onValueChange={(value) => setNewSetting({ ...newSetting, category: value })}>\n            <SelectTrigger>\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"general\">General</SelectItem>\n              <SelectItem value=\"ai\">AI</SelectItem>\n              <SelectItem value=\"security\">Seguridad</SelectItem>\n              <SelectItem value=\"billing\">Facturación</SelectItem>\n            </SelectContent>\n          </Select>\n          <Button \n            onClick={() => upsertSettingMutation.mutate(newSetting)}\n            disabled={!newSetting.key}\n          >\n            Guardar\n          </Button>\n        </div>\n      </div>\n\n      {Object.entries(groupedSettings).map(([category, items]: [string, any]) => (\n        <div key={category} className=\"space-y-2\">\n          <h3 className=\"text-sm font-medium capitalize\">{category}</h3>\n          <div className=\"rounded-lg border divide-y\">\n            {items.map((setting: any) => (\n              <div key={setting.id} className=\"flex items-center justify-between p-3\">\n                <div>\n                  <p className=\"font-medium text-sm\">{setting.key}</p>\n                  <p className=\"text-xs text-muted-foreground\">{setting.description || \"Sin descripción\"}</p>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Input \n                    className=\"w-48 h-8 text-sm\"\n                    defaultValue={setting.value}\n                    onBlur={(e) => {\n                      if (e.target.value !== setting.value) {\n                        upsertSettingMutation.mutate({ ...setting, value: e.target.value });\n                      }\n                    }}\n                  />\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      ))}\n\n      {settings.length === 0 && (\n        <div className=\"rounded-lg border p-8 text-center text-muted-foreground\">\n          No hay configuraciones guardadas\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default function AdminPage() {\n  const [, setLocation] = useLocation();\n  const [activeSection, setActiveSection] = useState<AdminSection>(\"dashboard\");\n\n  const renderSection = () => {\n    switch (activeSection) {\n      case \"dashboard\":\n        return <DashboardSection />;\n      case \"users\":\n        return <UsersSection />;\n      case \"ai-models\":\n        return <AIModelsSection />;\n      case \"payments\":\n        return <PaymentsSection />;\n      case \"invoices\":\n        return <InvoicesSection />;\n      case \"analytics\":\n        return <AnalyticsSection />;\n      case \"database\":\n        return <DatabaseSection />;\n      case \"security\":\n        return <SecuritySection />;\n      case \"reports\":\n        return <ReportsSection />;\n      case \"settings\":\n        return <SettingsSection />;\n      default:\n        return <DashboardSection />;\n    }\n  };\n\n  return (\n    <div className=\"flex h-screen bg-background\">\n      <aside className=\"w-56 border-r flex flex-col\">\n        <div className=\"p-4 border-b\">\n          <Button \n            variant=\"ghost\" \n            size=\"sm\" \n            className=\"w-full justify-start gap-2\"\n            onClick={() => setLocation(\"/\")}\n            data-testid=\"button-back-to-app\"\n          >\n            <ArrowLeft className=\"h-4 w-4\" />\n            Volver a la app\n          </Button>\n        </div>\n        <div className=\"p-2\">\n          <h2 className=\"px-3 py-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\n            Administration\n          </h2>\n          <nav className=\"space-y-1\">\n            {navItems.map((item) => (\n              <Button\n                key={item.id}\n                variant={activeSection === item.id ? \"secondary\" : \"ghost\"}\n                size=\"sm\"\n                className=\"w-full justify-start gap-2\"\n                onClick={() => setActiveSection(item.id)}\n                data-testid={`nav-${item.id}`}\n              >\n                <item.icon className=\"h-4 w-4\" />\n                {item.label}\n              </Button>\n            ))}\n          </nav>\n        </div>\n      </aside>\n      <main className=\"flex-1 overflow-auto\">\n        <div className=\"p-6\">\n          {renderSection()}\n        </div>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":51318,"size_tokens":null},"server/replit_integrations/auth/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { authStorage } from \"./storage\";\nimport { storage } from \"../../storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  const isProduction = process.env.NODE_ENV === \"production\" || !!process.env.REPL_SLUG;\n  return session({\n    name: \"siragpt.sid\",\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    rolling: true,\n    proxy: true,\n    cookie: {\n      httpOnly: true,\n      secure: isProduction,\n      sameSite: isProduction ? \"none\" as const : \"lax\" as const,\n      maxAge: sessionTtl,\n      path: \"/\",\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(claims: any) {\n  await authStorage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, (err: any, user: any, info: any) => {\n      if (err) {\n        console.error(\"[Auth] Callback error:\", err);\n        return res.redirect(\"/login?error=auth_failed\");\n      }\n      if (!user) {\n        console.error(\"[Auth] No user returned:\", info);\n        return res.redirect(\"/login?error=no_user\");\n      }\n      req.logIn(user, async (loginErr) => {\n        if (loginErr) {\n          console.error(\"[Auth] Login error:\", loginErr);\n          return res.redirect(\"/login?error=login_failed\");\n        }\n        \n        // Track user login\n        const userId = user.claims?.sub;\n        if (userId) {\n          try {\n            await storage.createAuditLog({\n              userId,\n              action: \"user_login\",\n              resource: \"auth\",\n              details: { \n                email: user.claims?.email,\n                provider: \"google_oauth\"\n              },\n              ipAddress: req.ip || req.socket.remoteAddress || null,\n              userAgent: req.headers[\"user-agent\"] || null\n            });\n          } catch (auditError) {\n            console.error(\"Failed to create audit log:\", auditError);\n          }\n        }\n        \n        // Redirect with success flag so client can set localStorage\n        return res.redirect(\"/?auth=success\");\n      });\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":5965,"size_tokens":null},"client/src/pages/profile.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { ArrowLeft, User, Mail, Phone, Building } from \"lucide-react\";\n\nexport default function ProfilePage() {\n  const [, setLocation] = useLocation();\n  const [name, setName] = useState(\"Admin\");\n  const [email, setEmail] = useState(\"admin@empresa.com\");\n  const [phone, setPhone] = useState(\"+34 600 000 000\");\n  const [company, setCompany] = useState(\"Mi Empresa\");\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"border-b\">\n        <div className=\"max-w-2xl mx-auto px-4 py-4 flex items-center gap-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/\")}\n            data-testid=\"button-back-profile\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"text-xl font-semibold\">Perfil</h1>\n        </div>\n      </div>\n      \n      <div className=\"max-w-2xl mx-auto px-4 py-8\">\n        <div className=\"space-y-8\">\n          <div className=\"flex items-center gap-6\">\n            <Avatar className=\"h-24 w-24\">\n              <AvatarFallback className=\"bg-primary/10 text-primary text-3xl\">A</AvatarFallback>\n            </Avatar>\n            <div className=\"space-y-2\">\n              <Button variant=\"outline\" data-testid=\"button-change-avatar\">\n                Cambiar foto\n              </Button>\n              <p className=\"text-sm text-muted-foreground\">JPG, PNG. Max 2MB</p>\n            </div>\n          </div>\n          \n          <div className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <User className=\"h-4 w-4\" />\n                Nombre completo\n              </Label>\n              <Input \n                id=\"name\" \n                value={name} \n                onChange={(e) => setName(e.target.value)}\n                className=\"max-w-md\"\n                data-testid=\"input-profile-name\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <Mail className=\"h-4 w-4\" />\n                Correo electrónico\n              </Label>\n              <Input \n                id=\"email\" \n                type=\"email\"\n                value={email} \n                onChange={(e) => setEmail(e.target.value)}\n                className=\"max-w-md\"\n                data-testid=\"input-profile-email\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"phone\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <Phone className=\"h-4 w-4\" />\n                Teléfono\n              </Label>\n              <Input \n                id=\"phone\" \n                value={phone} \n                onChange={(e) => setPhone(e.target.value)}\n                className=\"max-w-md\"\n                data-testid=\"input-profile-phone\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"company\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <Building className=\"h-4 w-4\" />\n                Empresa\n              </Label>\n              <Input \n                id=\"company\" \n                value={company} \n                onChange={(e) => setCompany(e.target.value)}\n                className=\"max-w-md\"\n                data-testid=\"input-profile-company\"\n              />\n            </div>\n          </div>\n          \n          <Button className=\"w-full max-w-md\" data-testid=\"button-save-profile\">\n            Guardar cambios\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":4094,"size_tokens":null},"shared/models/auth.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { index, jsonb, pgTable, timestamp, varchar } from \"drizzle-orm/pg-core\";\n\n// Session storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)]\n);\n\n// User storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n","path":null,"size_bytes":1010,"size_tokens":null},"client/src/pages/signup.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { X, Chrome, Apple, Building2, Phone, ArrowLeft, Eye, EyeOff } from \"lucide-react\";\n\nexport default function SignupPage() {\n  const [, setLocation] = useLocation();\n  const [step, setStep] = useState<\"social\" | \"email\">(\"social\");\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n\n  const handleEmailContinue = () => {\n    if (email) {\n      setStep(\"email\");\n    }\n  };\n\n  const handleSignup = () => {\n    if (password && password === confirmPassword) {\n      // Redirect to Replit Auth\n      window.location.href = \"/api/login\";\n    }\n  };\n\n  const handleSocialSignup = () => {\n    // Redirect to Replit Auth (supports Google, Apple, etc.)\n    window.location.href = \"/api/login\";\n  };\n\n  if (step === \"email\") {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <div className=\"w-full max-w-md relative\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            className=\"absolute -top-2 -left-2\"\n            onClick={() => setStep(\"social\")}\n            data-testid=\"button-back-signup\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            className=\"absolute -top-2 -right-2\"\n            onClick={() => setLocation(\"/welcome\")}\n            data-testid=\"button-close-signup-email\"\n          >\n            <X className=\"h-5 w-5\" />\n          </Button>\n\n          <div className=\"text-center mb-8 mt-4\">\n            <h1 className=\"text-3xl font-semibold mb-3\">Crea tu cuenta</h1>\n            <p className=\"text-muted-foreground\">\n              Ingresa tu correo electrónico y crea una contraseña\n            </p>\n          </div>\n\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signup-email\">Correo electrónico</Label>\n              <Input \n                id=\"signup-email\"\n                type=\"email\"\n                placeholder=\"tu@email.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                className=\"h-12 text-base\"\n                data-testid=\"input-signup-email\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signup-password\">Contraseña</Label>\n              <div className=\"relative\">\n                <Input \n                  id=\"signup-password\"\n                  type={showPassword ? \"text\" : \"password\"}\n                  placeholder=\"Mínimo 8 caracteres\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  className=\"h-12 text-base pr-10\"\n                  data-testid=\"input-signup-password\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"absolute right-0 top-0 h-12 w-12\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  data-testid=\"button-toggle-password\"\n                >\n                  {showPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                </Button>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signup-confirm-password\">Confirmar contraseña</Label>\n              <div className=\"relative\">\n                <Input \n                  id=\"signup-confirm-password\"\n                  type={showConfirmPassword ? \"text\" : \"password\"}\n                  placeholder=\"Repite tu contraseña\"\n                  value={confirmPassword}\n                  onChange={(e) => setConfirmPassword(e.target.value)}\n                  className=\"h-12 text-base pr-10\"\n                  data-testid=\"input-signup-confirm-password\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"absolute right-0 top-0 h-12 w-12\"\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                  data-testid=\"button-toggle-confirm-password\"\n                >\n                  {showConfirmPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                </Button>\n              </div>\n              {confirmPassword && password !== confirmPassword && (\n                <p className=\"text-sm text-red-500\">Las contraseñas no coinciden</p>\n              )}\n            </div>\n\n            <Button \n              className=\"w-full h-12 text-base mt-4\"\n              onClick={handleSignup}\n              disabled={!email || !password || password !== confirmPassword || password.length < 8}\n              data-testid=\"button-create-account\"\n            >\n              Crear cuenta\n            </Button>\n          </div>\n\n          <p className=\"text-center text-xs text-muted-foreground mt-6\">\n            Al crear una cuenta, aceptas nuestros{\" \"}\n            <a href=\"#\" className=\"text-primary hover:underline\">Términos de servicio</a>\n            {\" \"}y{\" \"}\n            <a href=\"#\" className=\"text-primary hover:underline\">Política de privacidad</a>\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <div className=\"w-full max-w-md relative\">\n        <Button \n          variant=\"ghost\" \n          size=\"icon\"\n          className=\"absolute -top-2 -right-2\"\n          onClick={() => setLocation(\"/welcome\")}\n          data-testid=\"button-close-signup\"\n        >\n          <X className=\"h-5 w-5\" />\n        </Button>\n\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-3xl font-semibold mb-3\">Crea tu cuenta</h1>\n          <p className=\"text-muted-foreground\">\n            Obtendrás respuestas más inteligentes, podrás cargar archivos e imágenes, y más.\n          </p>\n        </div>\n\n        <div className=\"space-y-3\">\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-14 justify-center gap-3 text-base font-medium border-2 hover:bg-muted/50 hover:border-primary/30 transition-all duration-200 rounded-xl shadow-sm\"\n            onClick={handleSocialSignup}\n            data-testid=\"button-signup-google\"\n          >\n            <svg className=\"h-6 w-6\" viewBox=\"0 0 24 24\">\n              <path fill=\"#4285F4\" d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"/>\n              <path fill=\"#34A853\" d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"/>\n              <path fill=\"#FBBC05\" d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"/>\n              <path fill=\"#EA4335\" d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"/>\n            </svg>\n            Continuar con Google\n          </Button>\n\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-12 justify-start gap-3 text-base font-normal opacity-50 cursor-not-allowed\"\n            disabled\n            data-testid=\"button-signup-apple\"\n          >\n            <Apple className=\"h-5 w-5\" />\n            Continuar con Apple\n          </Button>\n\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-12 justify-start gap-3 text-base font-normal opacity-50 cursor-not-allowed\"\n            disabled\n            data-testid=\"button-signup-microsoft\"\n          >\n            <svg className=\"h-5 w-5\" viewBox=\"0 0 23 23\">\n              <path fill=\"#f35325\" d=\"M1 1h10v10H1z\"/>\n              <path fill=\"#81bc06\" d=\"M12 1h10v10H12z\"/>\n              <path fill=\"#05a6f0\" d=\"M1 12h10v10H1z\"/>\n              <path fill=\"#ffba08\" d=\"M12 12h10v10H12z\"/>\n            </svg>\n            Continuar con Microsoft\n          </Button>\n\n          <Button \n            variant=\"outline\" \n            className=\"w-full h-12 justify-start gap-3 text-base font-normal opacity-50 cursor-not-allowed\"\n            disabled\n            data-testid=\"button-signup-phone\"\n          >\n            <Phone className=\"h-5 w-5\" />\n            Continuar con el teléfono\n          </Button>\n        </div>\n\n        <div className=\"flex items-center gap-4 my-6\">\n          <div className=\"flex-1 h-px bg-border\" />\n          <span className=\"text-muted-foreground text-sm\">o</span>\n          <div className=\"flex-1 h-px bg-border\" />\n        </div>\n\n        <div className=\"space-y-4\">\n          <Input \n            type=\"email\"\n            placeholder=\"Dirección de correo electrónico\"\n            value={email}\n            onChange={(e) => setEmail(e.target.value)}\n            className=\"h-12 text-base\"\n            data-testid=\"input-signup-email-initial\"\n          />\n          <Button \n            className=\"w-full h-12 text-base\"\n            onClick={handleEmailContinue}\n            disabled={!email}\n            data-testid=\"button-signup-continue\"\n          >\n            Continuar\n          </Button>\n        </div>\n\n        <p className=\"text-center text-sm text-muted-foreground mt-6\">\n          ¿Ya tienes una cuenta?{\" \"}\n          <button \n            onClick={() => setLocation(\"/login\")}\n            className=\"text-primary hover:underline\"\n            data-testid=\"link-goto-login\"\n          >\n            Inicia sesión\n          </button>\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10107,"size_tokens":null},"server/replit_integrations/auth/storage.ts":{"content":"import { users, type User } from \"@shared/schema\";\nimport { db } from \"../../db\";\n\nexport type UpsertUser = {\n  id: string;\n  email?: string | null;\n  firstName?: string | null;\n  lastName?: string | null;\n  profileImageUrl?: string | null;\n  role?: string | null;\n};\nimport { eq } from \"drizzle-orm\";\n\n// Interface for auth storage operations\n// (IMPORTANT) These user operations are mandatory for Replit Auth.\nexport interface IAuthStorage {\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n}\n\nclass AuthStorage implements IAuthStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n}\n\nexport const authStorage = new AuthStorage();\n","path":null,"size_bytes":1107,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ArrowLeft, Bell, Moon, Globe, Volume2, Keyboard, Palette } from \"lucide-react\";\n\nexport default function SettingsPage() {\n  const [, setLocation] = useLocation();\n  const [notifications, setNotifications] = useState(true);\n  const [emailNotifications, setEmailNotifications] = useState(true);\n  const [darkMode, setDarkMode] = useState(false);\n  const [soundEffects, setSoundEffects] = useState(true);\n  const [language, setLanguage] = useState(\"es\");\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"border-b\">\n        <div className=\"max-w-2xl mx-auto px-4 py-4 flex items-center gap-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/\")}\n            data-testid=\"button-back-settings\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"text-xl font-semibold\">Configuración</h1>\n        </div>\n      </div>\n      \n      <div className=\"max-w-2xl mx-auto px-4 py-8\">\n        <div className=\"space-y-8\">\n          <div className=\"space-y-4\">\n            <h2 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Notificaciones</h2>\n            <div className=\"rounded-lg border divide-y\">\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Bell className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Notificaciones push</p>\n                    <p className=\"text-sm text-muted-foreground\">Recibir alertas en el navegador</p>\n                  </div>\n                </div>\n                <Switch \n                  checked={notifications} \n                  onCheckedChange={setNotifications}\n                  data-testid=\"switch-notifications\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Bell className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Notificaciones por email</p>\n                    <p className=\"text-sm text-muted-foreground\">Recibir resúmenes y alertas</p>\n                  </div>\n                </div>\n                <Switch \n                  checked={emailNotifications} \n                  onCheckedChange={setEmailNotifications}\n                  data-testid=\"switch-email-notifications\"\n                />\n              </div>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-4\">\n            <h2 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Apariencia</h2>\n            <div className=\"rounded-lg border divide-y\">\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Moon className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Modo oscuro</p>\n                    <p className=\"text-sm text-muted-foreground\">Tema oscuro para la interfaz</p>\n                  </div>\n                </div>\n                <Switch \n                  checked={darkMode} \n                  onCheckedChange={setDarkMode}\n                  data-testid=\"switch-dark-mode\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Volume2 className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Efectos de sonido</p>\n                    <p className=\"text-sm text-muted-foreground\">Sonidos al enviar mensajes</p>\n                  </div>\n                </div>\n                <Switch \n                  checked={soundEffects} \n                  onCheckedChange={setSoundEffects}\n                  data-testid=\"switch-sound-effects\"\n                />\n              </div>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-4\">\n            <h2 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Idioma y región</h2>\n            <div className=\"rounded-lg border p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <Globe className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Idioma</p>\n                    <p className=\"text-sm text-muted-foreground\">Idioma de la interfaz</p>\n                  </div>\n                </div>\n                <Select value={language} onValueChange={setLanguage}>\n                  <SelectTrigger className=\"w-40\" data-testid=\"select-language\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"es\">Español</SelectItem>\n                    <SelectItem value=\"en\">English</SelectItem>\n                    <SelectItem value=\"pt\">Português</SelectItem>\n                    <SelectItem value=\"fr\">Français</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-4\">\n            <h2 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Accesos directos</h2>\n            <div className=\"rounded-lg border p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <Keyboard className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Atajos de teclado</p>\n                    <p className=\"text-sm text-muted-foreground\">Ver y personalizar atajos</p>\n                  </div>\n                </div>\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"button-keyboard-shortcuts\">\n                  Ver atajos\n                </Button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6773,"size_tokens":null},"client/src/components/user-modals.tsx":{"content":"import { useState } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  User, \n  Mail, \n  Phone, \n  Building,\n  CreditCard,\n  Calendar,\n  CheckCircle,\n  Bell,\n  Moon,\n  Globe,\n  Shield,\n  Eye,\n  Download,\n  Trash2,\n  Users,\n  BarChart3,\n  Settings\n} from \"lucide-react\";\n\ninterface ModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport function ProfileModal({ open, onOpenChange }: ModalProps) {\n  const [name, setName] = useState(\"Admin\");\n  const [email, setEmail] = useState(\"admin@empresa.com\");\n  const [phone, setPhone] = useState(\"+34 600 000 000\");\n  const [company, setCompany] = useState(\"Mi Empresa\");\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"text-lg font-medium\">Perfil</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-6 py-4\">\n          <div className=\"flex items-center gap-4\">\n            <Avatar className=\"h-16 w-16\">\n              <AvatarFallback className=\"bg-primary/10 text-primary text-xl\">A</AvatarFallback>\n            </Avatar>\n            <Button variant=\"outline\" size=\"sm\" data-testid=\"button-change-avatar\">\n              Cambiar foto\n            </Button>\n          </div>\n          \n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <User className=\"h-3.5 w-3.5\" />\n                Nombre\n              </Label>\n              <Input \n                id=\"name\" \n                value={name} \n                onChange={(e) => setName(e.target.value)}\n                className=\"h-9\"\n                data-testid=\"input-profile-name\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <Mail className=\"h-3.5 w-3.5\" />\n                Email\n              </Label>\n              <Input \n                id=\"email\" \n                type=\"email\"\n                value={email} \n                onChange={(e) => setEmail(e.target.value)}\n                className=\"h-9\"\n                data-testid=\"input-profile-email\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"phone\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <Phone className=\"h-3.5 w-3.5\" />\n                Teléfono\n              </Label>\n              <Input \n                id=\"phone\" \n                value={phone} \n                onChange={(e) => setPhone(e.target.value)}\n                className=\"h-9\"\n                data-testid=\"input-profile-phone\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"company\" className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                <Building className=\"h-3.5 w-3.5\" />\n                Empresa\n              </Label>\n              <Input \n                id=\"company\" \n                value={company} \n                onChange={(e) => setCompany(e.target.value)}\n                className=\"h-9\"\n                data-testid=\"input-profile-company\"\n              />\n            </div>\n          </div>\n          \n          <Button className=\"w-full\" data-testid=\"button-save-profile\">\n            Guardar cambios\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport function BillingModal({ open, onOpenChange }: ModalProps) {\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"text-lg font-medium\">Facturación</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-6 py-4\">\n          <div className=\"rounded-lg border p-4 space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Plan actual</span>\n              <Badge variant=\"secondary\">ENTERPRISE</Badge>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Precio</span>\n              <span className=\"font-medium\">€99/mes</span>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-muted-foreground\">Próxima factura</span>\n              <span className=\"text-sm\">15 Ene 2025</span>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-3\">\n            <h4 className=\"text-sm font-medium flex items-center gap-2\">\n              <CreditCard className=\"h-4 w-4\" />\n              Método de pago\n            </h4>\n            <div className=\"rounded-lg border p-3 flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"h-8 w-12 rounded bg-muted flex items-center justify-center text-xs font-medium\">\n                  VISA\n                </div>\n                <span className=\"text-sm\">•••• 4242</span>\n              </div>\n              <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-edit-payment\">\n                Editar\n              </Button>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-3\">\n            <h4 className=\"text-sm font-medium flex items-center gap-2\">\n              <Calendar className=\"h-4 w-4\" />\n              Historial\n            </h4>\n            <div className=\"space-y-2\">\n              {[\n                { date: \"15 Dic 2024\", amount: \"€99.00\", status: \"Pagado\" },\n                { date: \"15 Nov 2024\", amount: \"€99.00\", status: \"Pagado\" },\n                { date: \"15 Oct 2024\", amount: \"€99.00\", status: \"Pagado\" },\n              ].map((invoice, i) => (\n                <div key={i} className=\"flex items-center justify-between py-2 text-sm\">\n                  <span className=\"text-muted-foreground\">{invoice.date}</span>\n                  <div className=\"flex items-center gap-3\">\n                    <span>{invoice.amount}</span>\n                    <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport function SettingsModal({ open, onOpenChange }: ModalProps) {\n  const [notifications, setNotifications] = useState(true);\n  const [darkMode, setDarkMode] = useState(false);\n  const [language, setLanguage] = useState(\"es\");\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"text-lg font-medium\">Configuración</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <Bell className=\"h-4 w-4 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm font-medium\">Notificaciones</p>\n                <p className=\"text-xs text-muted-foreground\">Recibir alertas</p>\n              </div>\n            </div>\n            <Switch \n              checked={notifications} \n              onCheckedChange={setNotifications}\n              data-testid=\"switch-notifications\"\n            />\n          </div>\n          \n          <Separator />\n          \n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <Moon className=\"h-4 w-4 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm font-medium\">Modo oscuro</p>\n                <p className=\"text-xs text-muted-foreground\">Tema de la interfaz</p>\n              </div>\n            </div>\n            <Switch \n              checked={darkMode} \n              onCheckedChange={setDarkMode}\n              data-testid=\"switch-dark-mode\"\n            />\n          </div>\n          \n          <Separator />\n          \n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <Globe className=\"h-4 w-4 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm font-medium\">Idioma</p>\n                <p className=\"text-xs text-muted-foreground\">Español</p>\n              </div>\n            </div>\n            <Button variant=\"outline\" size=\"sm\" data-testid=\"button-change-language\">\n              Cambiar\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport function PrivacyModal({ open, onOpenChange }: ModalProps) {\n  const [shareData, setShareData] = useState(false);\n  const [saveHistory, setSaveHistory] = useState(true);\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"text-lg font-medium\">Privacidad</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <Shield className=\"h-4 w-4 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm font-medium\">Compartir datos</p>\n                <p className=\"text-xs text-muted-foreground\">Mejoras del servicio</p>\n              </div>\n            </div>\n            <Switch \n              checked={shareData} \n              onCheckedChange={setShareData}\n              data-testid=\"switch-share-data\"\n            />\n          </div>\n          \n          <Separator />\n          \n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <Eye className=\"h-4 w-4 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm font-medium\">Guardar historial</p>\n                <p className=\"text-xs text-muted-foreground\">Conservar conversaciones</p>\n              </div>\n            </div>\n            <Switch \n              checked={saveHistory} \n              onCheckedChange={setSaveHistory}\n              data-testid=\"switch-save-history\"\n            />\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-3\">\n            <Button variant=\"outline\" className=\"w-full justify-start gap-2\" data-testid=\"button-download-data\">\n              <Download className=\"h-4 w-4\" />\n              Descargar mis datos\n            </Button>\n            <Button variant=\"outline\" className=\"w-full justify-start gap-2 text-red-500 hover:text-red-600 hover:bg-red-50\" data-testid=\"button-delete-account\">\n              <Trash2 className=\"h-4 w-4\" />\n              Eliminar cuenta\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport function AdminPanelModal({ open, onOpenChange }: ModalProps) {\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-lg\">\n        <DialogHeader>\n          <DialogTitle className=\"text-lg font-medium\">Admin Panel</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-6 py-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"rounded-lg border p-4 space-y-1\">\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <Users className=\"h-4 w-4\" />\n                <span className=\"text-xs\">Usuarios</span>\n              </div>\n              <p className=\"text-2xl font-semibold\">24</p>\n            </div>\n            <div className=\"rounded-lg border p-4 space-y-1\">\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <BarChart3 className=\"h-4 w-4\" />\n                <span className=\"text-xs\">Consultas/día</span>\n              </div>\n              <p className=\"text-2xl font-semibold\">1,247</p>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-3\">\n            <h4 className=\"text-sm font-medium\">Acciones rápidas</h4>\n            <div className=\"space-y-2\">\n              <Button variant=\"outline\" className=\"w-full justify-start gap-2\" data-testid=\"button-manage-users\">\n                <Users className=\"h-4 w-4\" />\n                Gestionar usuarios\n              </Button>\n              <Button variant=\"outline\" className=\"w-full justify-start gap-2\" data-testid=\"button-view-analytics\">\n                <BarChart3 className=\"h-4 w-4\" />\n                Ver analíticas\n              </Button>\n              <Button variant=\"outline\" className=\"w-full justify-start gap-2\" data-testid=\"button-system-settings\">\n                <Settings className=\"h-4 w-4\" />\n                Configuración del sistema\n              </Button>\n            </div>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":13814,"size_tokens":null},"client/src/pages/privacy.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ArrowLeft, Shield, Eye, Download, Trash2, Lock, History, FileText } from \"lucide-react\";\n\nexport default function PrivacyPage() {\n  const [, setLocation] = useLocation();\n  const [shareData, setShareData] = useState(false);\n  const [saveHistory, setSaveHistory] = useState(true);\n  const [analyticsTracking, setAnalyticsTracking] = useState(true);\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"border-b\">\n        <div className=\"max-w-2xl mx-auto px-4 py-4 flex items-center gap-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/\")}\n            data-testid=\"button-back-privacy\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"text-xl font-semibold\">Privacidad</h1>\n        </div>\n      </div>\n      \n      <div className=\"max-w-2xl mx-auto px-4 py-8\">\n        <div className=\"space-y-8\">\n          <div className=\"space-y-4\">\n            <h2 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Control de datos</h2>\n            <div className=\"rounded-lg border divide-y\">\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Shield className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Compartir datos de uso</p>\n                    <p className=\"text-sm text-muted-foreground\">Ayuda a mejorar el servicio</p>\n                  </div>\n                </div>\n                <Switch \n                  checked={shareData} \n                  onCheckedChange={setShareData}\n                  data-testid=\"switch-share-data\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Eye className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Seguimiento de análisis</p>\n                    <p className=\"text-sm text-muted-foreground\">Estadísticas anónimas de uso</p>\n                  </div>\n                </div>\n                <Switch \n                  checked={analyticsTracking} \n                  onCheckedChange={setAnalyticsTracking}\n                  data-testid=\"switch-analytics\"\n                />\n              </div>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-4\">\n            <h2 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Historial</h2>\n            <div className=\"rounded-lg border divide-y\">\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <History className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Guardar historial de chat</p>\n                    <p className=\"text-sm text-muted-foreground\">Conservar conversaciones anteriores</p>\n                  </div>\n                </div>\n                <Switch \n                  checked={saveHistory} \n                  onCheckedChange={setSaveHistory}\n                  data-testid=\"switch-save-history\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Trash2 className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Borrar historial</p>\n                    <p className=\"text-sm text-muted-foreground\">Eliminar todas las conversaciones</p>\n                  </div>\n                </div>\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"button-clear-history\">\n                  Borrar todo\n                </Button>\n              </div>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-4\">\n            <h2 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Tus datos</h2>\n            <div className=\"rounded-lg border divide-y\">\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <Download className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Descargar mis datos</p>\n                    <p className=\"text-sm text-muted-foreground\">Exportar toda tu información</p>\n                  </div>\n                </div>\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"button-download-data\">\n                  Descargar\n                </Button>\n              </div>\n              <div className=\"flex items-center justify-between p-4\">\n                <div className=\"flex items-center gap-4\">\n                  <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Política de privacidad</p>\n                    <p className=\"text-sm text-muted-foreground\">Leer términos completos</p>\n                  </div>\n                </div>\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"button-privacy-policy\">\n                  Ver\n                </Button>\n              </div>\n            </div>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"rounded-lg border border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-900 p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-4\">\n                <Trash2 className=\"h-5 w-5 text-red-500\" />\n                <div>\n                  <p className=\"font-medium text-red-600 dark:text-red-400\">Eliminar cuenta</p>\n                  <p className=\"text-sm text-red-500/80\">Esta acción es permanente e irreversible</p>\n                </div>\n              </div>\n              <Button variant=\"destructive\" size=\"sm\" data-testid=\"button-delete-account\">\n                Eliminar\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6611,"size_tokens":null},"client/src/lib/auth-utils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n\n// Redirect to login with a toast notification\nexport function redirectToLogin(toast?: (options: { title: string; description: string; variant: string }) => void) {\n  if (toast) {\n    toast({\n      title: \"Unauthorized\",\n      description: \"You are logged out. Logging in again...\",\n      variant: \"destructive\",\n    });\n  }\n  setTimeout(() => {\n    window.location.href = \"/api/login\";\n  }, 500);\n}\n","path":null,"size_bytes":517,"size_tokens":null},"server/replit_integrations/auth/routes.ts":{"content":"import type { Express } from \"express\";\nimport { authStorage } from \"./storage\";\nimport { isAuthenticated } from \"./replitAuth\";\nimport { storage } from \"../../storage\";\n\n// Admin credentials from environment variables\nconst ADMIN_EMAIL = process.env.ADMIN_EMAIL || \"admin@gmail.com\";\nconst ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || \"123456\";\n\n// Register auth-specific routes\nexport function registerAuthRoutes(app: Express): void {\n  // User login with email/password (for users created by admin)\n  app.post(\"/api/auth/login\", async (req: any, res) => {\n    try {\n      const { email, password } = req.body;\n      \n      if (!email || !password) {\n        return res.status(400).json({ message: \"Email y contraseña son requeridos\" });\n      }\n      \n      // Check if it's the admin (case-insensitive email comparison)\n      if (email.toLowerCase() === ADMIN_EMAIL.toLowerCase() && password === ADMIN_PASSWORD) {\n        const adminId = \"admin-user-id\";\n        await authStorage.upsertUser({\n          id: adminId,\n          email: ADMIN_EMAIL,\n          firstName: \"Admin\",\n          lastName: \"User\",\n          profileImageUrl: null,\n          role: \"admin\",\n        });\n        \n        const adminUser = {\n          claims: {\n            sub: adminId,\n            email: ADMIN_EMAIL,\n            first_name: \"Admin\",\n            last_name: \"User\",\n          },\n          expires_at: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60),\n        };\n        \n        return req.login(adminUser, async (err: any) => {\n          if (err) {\n            return res.status(500).json({ message: \"Error al iniciar sesión\" });\n          }\n          // Force session save before responding\n          req.session.save(async (saveErr: any) => {\n            if (saveErr) {\n              console.error(\"Session save error:\", saveErr);\n              return res.status(500).json({ message: \"Error al guardar sesión\" });\n            }\n            const user = await authStorage.getUser(adminId);\n            res.json({ success: true, user });\n          });\n        });\n      }\n      \n      // Find user in database by email\n      const allUsers = await storage.getAllUsers();\n      const dbUser = allUsers.find(u => u.email?.toLowerCase() === email.toLowerCase());\n      \n      if (!dbUser) {\n        return res.status(401).json({ message: \"Usuario no encontrado\" });\n      }\n      \n      // Verify password\n      if (dbUser.password !== password) {\n        return res.status(401).json({ message: \"Contraseña incorrecta\" });\n      }\n      \n      // Check if user is active\n      if (dbUser.status !== \"active\") {\n        return res.status(401).json({ message: \"Usuario inactivo\" });\n      }\n      \n      // Set up session\n      const sessionUser = {\n        claims: {\n          sub: dbUser.id,\n          email: dbUser.email,\n          first_name: dbUser.firstName || \"\",\n          last_name: dbUser.lastName || \"\",\n        },\n        expires_at: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60),\n      };\n      \n      req.login(sessionUser, async (err: any) => {\n        if (err) {\n          return res.status(500).json({ message: \"Error al iniciar sesión\" });\n        }\n        \n        // Track login\n        try {\n          await storage.createAuditLog({\n            userId: dbUser.id,\n            action: \"user_login\",\n            resource: \"auth\",\n            details: { email: dbUser.email },\n            ipAddress: req.ip || req.socket.remoteAddress || null,\n            userAgent: req.headers[\"user-agent\"] || null\n          });\n        } catch (auditError) {\n          console.error(\"Failed to create audit log:\", auditError);\n        }\n        \n        // Force session save before responding\n        req.session.save((saveErr: any) => {\n          if (saveErr) {\n            console.error(\"Session save error:\", saveErr);\n            return res.status(500).json({ message: \"Error al guardar sesión\" });\n          }\n          res.json({ success: true, user: dbUser });\n        });\n      });\n    } catch (error) {\n      console.error(\"Login error:\", error);\n      res.status(500).json({ message: \"Error al iniciar sesión\" });\n    }\n  });\n\n  // Admin login with email/password\n  app.post(\"/api/auth/admin-login\", async (req: any, res) => {\n    try {\n      const { email, password } = req.body;\n      \n      if (!email || !password) {\n        return res.status(400).json({ message: \"Email and password required\" });\n      }\n      \n      if (email.toLowerCase() !== ADMIN_EMAIL.toLowerCase() || password !== ADMIN_PASSWORD) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n      \n      // Create or get admin user\n      const adminId = \"admin-user-id\";\n      await authStorage.upsertUser({\n        id: adminId,\n        email: ADMIN_EMAIL,\n        firstName: \"Admin\",\n        lastName: \"User\",\n        profileImageUrl: null,\n        role: \"admin\",\n      });\n      \n      // Set up session for admin\n      const adminUser = {\n        claims: {\n          sub: adminId,\n          email: ADMIN_EMAIL,\n          first_name: \"Admin\",\n          last_name: \"User\",\n        },\n        expires_at: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60), // 1 week\n      };\n      \n      req.login(adminUser, async (err: any) => {\n        if (err) {\n          console.error(\"Admin login error:\", err);\n          return res.status(500).json({ message: \"Login failed\" });\n        }\n        \n        // Track admin login\n        try {\n          await storage.createAuditLog({\n            userId: adminId,\n            action: \"admin_login\",\n            resource: \"auth\",\n            details: { email: ADMIN_EMAIL },\n            ipAddress: req.ip || req.socket.remoteAddress || null,\n            userAgent: req.headers[\"user-agent\"] || null\n          });\n        } catch (auditError) {\n          console.error(\"Failed to create audit log:\", auditError);\n        }\n        \n        // Force session save before responding\n        req.session.save((saveErr: any) => {\n          if (saveErr) {\n            console.error(\"Session save error:\", saveErr);\n            return res.status(500).json({ message: \"Error saving session\" });\n          }\n          res.json({ success: true, user: { id: adminId, email: ADMIN_EMAIL, firstName: \"Admin\", lastName: \"User\", role: \"admin\" } });\n        });\n      });\n    } catch (error) {\n      console.error(\"Admin login error:\", error);\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  // Logout via POST (for SPA - clears session without redirect)\n  app.post(\"/api/auth/logout\", async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      if (userId) {\n        await storage.createAuditLog({\n          userId,\n          action: \"user_logout\",\n          resource: \"auth\",\n          details: {},\n          ipAddress: req.ip || req.socket.remoteAddress || null,\n          userAgent: req.headers[\"user-agent\"] || null\n        });\n      }\n      req.logout((err: any) => {\n        if (err) {\n          console.error(\"Logout error:\", err);\n        }\n        res.json({ success: true });\n      });\n    } catch (error) {\n      console.error(\"Logout error:\", error);\n      res.json({ success: true });\n    }\n  });\n\n  // Get current authenticated user\n  app.get(\"/api/auth/user\", async (req: any, res) => {\n    try {\n      // Check if user is authenticated via passport session\n      if (!req.isAuthenticated() || !req.user) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const userId = req.user.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const user = await authStorage.getUser(userId);\n      if (!user) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n      \n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n}\n","path":null,"size_bytes":7974,"size_tokens":null},"client/src/pages/billing.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ArrowLeft, CreditCard, Calendar, CheckCircle, Download } from \"lucide-react\";\n\nexport default function BillingPage() {\n  const [, setLocation] = useLocation();\n\n  const invoices = [\n    { date: \"15 Dic 2024\", amount: \"€99.00\", status: \"Pagado\" },\n    { date: \"15 Nov 2024\", amount: \"€99.00\", status: \"Pagado\" },\n    { date: \"15 Oct 2024\", amount: \"€99.00\", status: \"Pagado\" },\n    { date: \"15 Sep 2024\", amount: \"€99.00\", status: \"Pagado\" },\n    { date: \"15 Ago 2024\", amount: \"€99.00\", status: \"Pagado\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"border-b\">\n        <div className=\"max-w-2xl mx-auto px-4 py-4 flex items-center gap-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/\")}\n            data-testid=\"button-back-billing\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"text-xl font-semibold\">Facturación</h1>\n        </div>\n      </div>\n      \n      <div className=\"max-w-2xl mx-auto px-4 py-8\">\n        <div className=\"space-y-8\">\n          <div className=\"rounded-lg border p-6 space-y-4\">\n            <h2 className=\"font-medium\">Plan actual</h2>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-2xl font-semibold\">Enterprise</p>\n                <p className=\"text-muted-foreground\">€99/mes</p>\n              </div>\n              <Badge variant=\"secondary\" className=\"text-sm\">ACTIVO</Badge>\n            </div>\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n              <Calendar className=\"h-4 w-4\" />\n              <span>Próxima factura: 15 Enero 2025</span>\n            </div>\n            <div className=\"flex gap-3\">\n              <Button variant=\"outline\" data-testid=\"button-change-plan\">Cambiar plan</Button>\n              <Button variant=\"outline\" data-testid=\"button-cancel-subscription\">Cancelar</Button>\n            </div>\n          </div>\n          \n          <div className=\"rounded-lg border p-6 space-y-4\">\n            <h2 className=\"font-medium flex items-center gap-2\">\n              <CreditCard className=\"h-5 w-5\" />\n              Método de pago\n            </h2>\n            <div className=\"flex items-center justify-between p-4 bg-muted/50 rounded-lg\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"h-10 w-16 rounded bg-background border flex items-center justify-center font-semibold text-sm\">\n                  VISA\n                </div>\n                <div>\n                  <p className=\"font-medium\">•••• •••• •••• 4242</p>\n                  <p className=\"text-sm text-muted-foreground\">Expira 12/26</p>\n                </div>\n              </div>\n              <Button variant=\"outline\" size=\"sm\" data-testid=\"button-edit-payment\">\n                Editar\n              </Button>\n            </div>\n            <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-add-payment\">\n              Añadir método de pago\n            </Button>\n          </div>\n          \n          <Separator />\n          \n          <div className=\"space-y-4\">\n            <h2 className=\"font-medium flex items-center gap-2\">\n              <Calendar className=\"h-5 w-5\" />\n              Historial de facturas\n            </h2>\n            <div className=\"rounded-lg border divide-y\">\n              {invoices.map((invoice, i) => (\n                <div key={i} className=\"flex items-center justify-between p-4\">\n                  <div className=\"flex items-center gap-4\">\n                    <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                    <div>\n                      <p className=\"font-medium\">{invoice.amount}</p>\n                      <p className=\"text-sm text-muted-foreground\">{invoice.date}</p>\n                    </div>\n                  </div>\n                  <Button variant=\"ghost\" size=\"sm\" data-testid={`button-download-invoice-${i}`}>\n                    <Download className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":4467,"size_tokens":null},"server/lib/llmGateway.ts":{"content":"import OpenAI from \"openai\";\nimport type { ChatCompletionMessageParam, ChatCompletionChunk } from \"openai/resources/chat/completions\";\nimport { MODELS } from \"./openai\";\n\ninterface CircuitBreakerState {\n  failures: number;\n  lastFailure: number;\n  state: \"closed\" | \"open\" | \"half-open\";\n  halfOpenAt: number;\n  halfOpenAttempts: number;\n}\n\ninterface RateLimitState {\n  tokens: number;\n  lastRefill: number;\n}\n\ninterface LLMRequestOptions {\n  model?: string;\n  temperature?: number;\n  topP?: number;\n  maxTokens?: number;\n  userId?: string;\n  requestId?: string;\n  timeout?: number;\n}\n\ninterface LLMResponse {\n  content: string;\n  usage?: {\n    promptTokens: number;\n    completionTokens: number;\n    totalTokens: number;\n  };\n  requestId: string;\n  latencyMs: number;\n  model: string;\n  cached?: boolean;\n}\n\ninterface StreamChunk {\n  content: string;\n  sequenceId: number;\n  done: boolean;\n  requestId: string;\n}\n\nconst CIRCUIT_BREAKER_CONFIG = {\n  failureThreshold: 5,\n  resetTimeoutMs: 30000,\n  halfOpenRequests: 3,\n};\n\nconst RATE_LIMIT_CONFIG = {\n  tokensPerMinute: 100,\n  refillRateMs: 600,\n  maxBurst: 150,\n};\n\nconst RETRY_CONFIG = {\n  maxRetries: 3,\n  baseDelayMs: 1000,\n  maxDelayMs: 10000,\n  jitterFactor: 0.3,\n};\n\nconst DEFAULT_TIMEOUT_MS = 60000;\nconst MAX_CONTEXT_TOKENS = 8000;\n\nclass LLMGateway {\n  private client: OpenAI;\n  private circuitBreaker: CircuitBreakerState;\n  private rateLimitByUser: Map<string, RateLimitState> = new Map();\n  private requestCache: Map<string, { response: LLMResponse; expiresAt: number }> = new Map();\n  private metrics: {\n    totalRequests: number;\n    successfulRequests: number;\n    failedRequests: number;\n    totalLatencyMs: number;\n    totalTokens: number;\n    rateLimitHits: number;\n    circuitBreakerOpens: number;\n    cacheHits: number;\n  };\n\n  constructor() {\n    this.client = new OpenAI({\n      baseURL: \"https://api.x.ai/v1\",\n      apiKey: process.env.XAI_API_KEY,\n    });\n\n    this.circuitBreaker = {\n      failures: 0,\n      lastFailure: 0,\n      state: \"closed\",\n      halfOpenAt: 0,\n      halfOpenAttempts: 0,\n    };\n\n    this.metrics = {\n      totalRequests: 0,\n      successfulRequests: 0,\n      failedRequests: 0,\n      totalLatencyMs: 0,\n      totalTokens: 0,\n      rateLimitHits: 0,\n      circuitBreakerOpens: 0,\n      cacheHits: 0,\n    };\n\n    setInterval(() => this.cleanupCache(), 60000);\n  }\n\n  private generateRequestId(): string {\n    return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  private getCacheKey(messages: ChatCompletionMessageParam[], options: LLMRequestOptions): string | null {\n    // Don't cache short conversational messages - they should get dynamic responses\n    const lastUserMessage = messages.filter(m => m.role === \"user\").pop();\n    const lastMsgContent = typeof lastUserMessage?.content === \"string\" ? lastUserMessage.content : \"\";\n    if (lastMsgContent.length < 50) {\n      return null; // Skip caching for short messages\n    }\n    \n    const userId = options.userId || \"anonymous\";\n    const msgHash = JSON.stringify(messages);\n    const optsHash = `${userId}:${options.model}:${options.temperature}:${options.topP}`;\n    return `${optsHash}:${Buffer.from(msgHash).toString(\"base64\").slice(0, 64)}`;\n  }\n\n  private cleanupCache(): void {\n    const now = Date.now();\n    const entries = Array.from(this.requestCache.entries());\n    for (const [key, value] of entries) {\n      if (value.expiresAt < now) {\n        this.requestCache.delete(key);\n      }\n    }\n  }\n\n  private checkRateLimit(userId: string): boolean {\n    const now = Date.now();\n    let state = this.rateLimitByUser.get(userId);\n\n    if (!state) {\n      state = { tokens: RATE_LIMIT_CONFIG.tokensPerMinute, lastRefill: now };\n      this.rateLimitByUser.set(userId, state);\n    }\n\n    const elapsed = now - state.lastRefill;\n    const refillAmount = Math.floor(elapsed / RATE_LIMIT_CONFIG.refillRateMs);\n    \n    if (refillAmount > 0) {\n      state.tokens = Math.min(\n        RATE_LIMIT_CONFIG.maxBurst,\n        state.tokens + refillAmount\n      );\n      state.lastRefill = now;\n    }\n\n    if (state.tokens > 0) {\n      state.tokens--;\n      return true;\n    }\n\n    this.metrics.rateLimitHits++;\n    return false;\n  }\n\n  private checkCircuitBreaker(): boolean {\n    const now = Date.now();\n\n    if (this.circuitBreaker.state === \"open\") {\n      if (now >= this.circuitBreaker.halfOpenAt) {\n        this.circuitBreaker.state = \"half-open\";\n        this.circuitBreaker.halfOpenAttempts = 0;\n        this.circuitBreaker.failures = 0;\n        console.log(`[LLMGateway] Circuit breaker transitioning to half-open`);\n      } else {\n        return false;\n      }\n    }\n\n    if (this.circuitBreaker.state === \"half-open\") {\n      if (this.circuitBreaker.halfOpenAttempts >= CIRCUIT_BREAKER_CONFIG.halfOpenRequests) {\n        return false;\n      }\n      this.circuitBreaker.halfOpenAttempts++;\n    }\n\n    return true;\n  }\n\n  private recordSuccess(): void {\n    if (this.circuitBreaker.state === \"half-open\") {\n      if (this.circuitBreaker.halfOpenAttempts >= CIRCUIT_BREAKER_CONFIG.halfOpenRequests) {\n        this.circuitBreaker.state = \"closed\";\n        this.circuitBreaker.halfOpenAttempts = 0;\n        console.log(`[LLMGateway] Circuit breaker closed after successful probes`);\n      }\n    }\n    this.circuitBreaker.failures = 0;\n    this.metrics.successfulRequests++;\n  }\n\n  private recordFailure(): void {\n    this.circuitBreaker.failures++;\n    this.circuitBreaker.lastFailure = Date.now();\n    this.metrics.failedRequests++;\n\n    if (this.circuitBreaker.state === \"half-open\") {\n      this.circuitBreaker.state = \"open\";\n      this.circuitBreaker.halfOpenAt = Date.now() + CIRCUIT_BREAKER_CONFIG.resetTimeoutMs;\n      this.circuitBreaker.halfOpenAttempts = 0;\n      this.metrics.circuitBreakerOpens++;\n      console.error(`[LLMGateway] Circuit breaker re-opened from half-open at ${new Date().toISOString()}`);\n    } else if (this.circuitBreaker.failures >= CIRCUIT_BREAKER_CONFIG.failureThreshold) {\n      this.circuitBreaker.state = \"open\";\n      this.circuitBreaker.halfOpenAt = Date.now() + CIRCUIT_BREAKER_CONFIG.resetTimeoutMs;\n      this.metrics.circuitBreakerOpens++;\n      console.error(`[LLMGateway] Circuit breaker opened at ${new Date().toISOString()}`);\n    }\n  }\n\n  private calculateRetryDelay(attempt: number): number {\n    const baseDelay = RETRY_CONFIG.baseDelayMs * Math.pow(2, attempt);\n    const jitter = baseDelay * RETRY_CONFIG.jitterFactor * Math.random();\n    return Math.min(baseDelay + jitter, RETRY_CONFIG.maxDelayMs);\n  }\n\n  private async sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  truncateContext(messages: ChatCompletionMessageParam[], maxTokens: number = MAX_CONTEXT_TOKENS): ChatCompletionMessageParam[] {\n    let totalEstimatedTokens = messages.reduce((sum, msg) => {\n      const content = typeof msg.content === \"string\" ? msg.content : JSON.stringify(msg.content);\n      return sum + Math.ceil(content.length / 4);\n    }, 0);\n\n    if (totalEstimatedTokens <= maxTokens) {\n      return messages;\n    }\n\n    const systemMessages = messages.filter((m) => m.role === \"system\");\n    const otherMessages = messages.filter((m) => m.role !== \"system\");\n\n    const truncated: ChatCompletionMessageParam[] = [...systemMessages];\n    let remainingTokens = maxTokens - systemMessages.reduce((sum, msg) => {\n      const content = typeof msg.content === \"string\" ? msg.content : JSON.stringify(msg.content);\n      return sum + Math.ceil(content.length / 4);\n    }, 0);\n\n    for (let i = otherMessages.length - 1; i >= 0; i--) {\n      const msg = otherMessages[i];\n      const content = typeof msg.content === \"string\" ? msg.content : JSON.stringify(msg.content);\n      const msgTokens = Math.ceil(content.length / 4);\n      \n      if (msgTokens <= remainingTokens) {\n        truncated.splice(systemMessages.length, 0, msg);\n        remainingTokens -= msgTokens;\n      } else if (remainingTokens > 100) {\n        const truncatedContent = content.slice(0, remainingTokens * 4);\n        truncated.splice(systemMessages.length, 0, {\n          ...msg,\n          content: truncatedContent + \"... [truncated]\",\n        } as ChatCompletionMessageParam);\n        break;\n      }\n    }\n\n    console.log(`[LLMGateway] Truncated context from ${totalEstimatedTokens} to ~${maxTokens - remainingTokens} tokens`);\n    return truncated;\n  }\n\n  async chat(\n    messages: ChatCompletionMessageParam[],\n    options: LLMRequestOptions = {}\n  ): Promise<LLMResponse> {\n    const requestId = options.requestId || this.generateRequestId();\n    const startTime = Date.now();\n    const userId = options.userId || \"anonymous\";\n    const model = options.model || MODELS.TEXT;\n    const timeout = options.timeout || DEFAULT_TIMEOUT_MS;\n\n    this.metrics.totalRequests++;\n\n    const cacheKey = this.getCacheKey(messages, options);\n    if (cacheKey) {\n      const cached = this.requestCache.get(cacheKey);\n      if (cached && cached.expiresAt > Date.now()) {\n        this.metrics.cacheHits++;\n        return { ...cached.response, cached: true, requestId };\n      }\n    }\n\n    if (!this.checkRateLimit(userId)) {\n      throw new Error(`Rate limit exceeded for user ${userId}`);\n    }\n\n    if (!this.checkCircuitBreaker()) {\n      throw new Error(\"Service temporarily unavailable (circuit breaker open)\");\n    }\n\n    const truncatedMessages = this.truncateContext(messages, options.maxTokens ? options.maxTokens * 2 : MAX_CONTEXT_TOKENS);\n\n    let lastError: Error | null = null;\n\n    for (let attempt = 0; attempt <= RETRY_CONFIG.maxRetries; attempt++) {\n      try {\n        const controller = new AbortController();\n        const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n        const response = await this.client.chat.completions.create(\n          {\n            model,\n            messages: truncatedMessages,\n            temperature: options.temperature ?? 0.7,\n            top_p: options.topP ?? 1,\n            max_tokens: options.maxTokens,\n          },\n          { signal: controller.signal }\n        );\n\n        clearTimeout(timeoutId);\n\n        const latencyMs = Date.now() - startTime;\n        const content = response.choices[0]?.message?.content || \"\";\n        const usage = response.usage;\n\n        if (usage) {\n          this.metrics.totalTokens += usage.total_tokens;\n        }\n\n        this.recordSuccess();\n        this.metrics.totalLatencyMs += latencyMs;\n\n        const result: LLMResponse = {\n          content,\n          usage: usage\n            ? {\n                promptTokens: usage.prompt_tokens,\n                completionTokens: usage.completion_tokens,\n                totalTokens: usage.total_tokens,\n              }\n            : undefined,\n          requestId,\n          latencyMs,\n          model,\n        };\n\n        if (cacheKey) {\n          this.requestCache.set(cacheKey, {\n            response: result,\n            expiresAt: Date.now() + 300000,\n          });\n        }\n\n        console.log(`[LLMGateway] ${requestId} completed in ${latencyMs}ms, tokens: ${usage?.total_tokens || 0}`);\n        return result;\n      } catch (error: any) {\n        lastError = error;\n\n        if (error.name === \"AbortError\") {\n          console.error(`[LLMGateway] ${requestId} timeout after ${timeout}ms`);\n          this.recordFailure();\n          throw new Error(`Request timeout after ${timeout}ms`);\n        }\n\n        const isRetryable =\n          error.status === 429 ||\n          error.status === 500 ||\n          error.status === 502 ||\n          error.status === 503 ||\n          error.code === \"ECONNRESET\" ||\n          error.code === \"ETIMEDOUT\";\n\n        if (!isRetryable || attempt >= RETRY_CONFIG.maxRetries) {\n          this.recordFailure();\n          console.error(`[LLMGateway] ${requestId} failed after ${attempt + 1} attempts:`, error.message);\n          throw error;\n        }\n\n        const delay = this.calculateRetryDelay(attempt);\n        console.warn(`[LLMGateway] ${requestId} attempt ${attempt + 1} failed, retrying in ${delay}ms`);\n        await this.sleep(delay);\n      }\n    }\n\n    this.recordFailure();\n    throw lastError || new Error(\"Unknown error\");\n  }\n\n  async *streamChat(\n    messages: ChatCompletionMessageParam[],\n    options: LLMRequestOptions = {}\n  ): AsyncGenerator<StreamChunk, void, unknown> {\n    const requestId = options.requestId || this.generateRequestId();\n    const userId = options.userId || \"anonymous\";\n    const model = options.model || MODELS.TEXT;\n    let sequenceId = 0;\n\n    this.metrics.totalRequests++;\n\n    if (!this.checkRateLimit(userId)) {\n      throw new Error(`Rate limit exceeded for user ${userId}`);\n    }\n\n    if (!this.checkCircuitBreaker()) {\n      throw new Error(\"Service temporarily unavailable (circuit breaker open)\");\n    }\n\n    const truncatedMessages = this.truncateContext(messages, options.maxTokens ? options.maxTokens * 2 : MAX_CONTEXT_TOKENS);\n\n    try {\n      const stream = await this.client.chat.completions.create({\n        model,\n        messages: truncatedMessages,\n        temperature: options.temperature ?? 0.7,\n        top_p: options.topP ?? 1,\n        max_tokens: options.maxTokens,\n        stream: true,\n      });\n\n      let buffer = \"\";\n      const flushThreshold = 50;\n\n      for await (const chunk of stream) {\n        const content = chunk.choices[0]?.delta?.content || \"\";\n        buffer += content;\n\n        if (buffer.length >= flushThreshold || content.includes(\"\\n\") || content.includes(\".\")) {\n          yield {\n            content: buffer,\n            sequenceId: sequenceId++,\n            done: false,\n            requestId,\n          };\n          buffer = \"\";\n        }\n      }\n\n      if (buffer) {\n        yield {\n          content: buffer,\n          sequenceId: sequenceId++,\n          done: false,\n          requestId,\n        };\n      }\n\n      yield {\n        content: \"\",\n        sequenceId: sequenceId++,\n        done: true,\n        requestId,\n      };\n\n      this.recordSuccess();\n    } catch (error: any) {\n      this.recordFailure();\n      console.error(`[LLMGateway] Stream ${requestId} failed:`, error.message);\n      throw error;\n    }\n  }\n\n  getMetrics() {\n    return {\n      ...this.metrics,\n      averageLatencyMs:\n        this.metrics.successfulRequests > 0\n          ? Math.round(this.metrics.totalLatencyMs / this.metrics.successfulRequests)\n          : 0,\n      successRate:\n        this.metrics.totalRequests > 0\n          ? Math.round((this.metrics.successfulRequests / this.metrics.totalRequests) * 100)\n          : 100,\n      circuitBreakerStatus: this.circuitBreaker.state,\n      cacheSize: this.requestCache.size,\n      rateLimitedUsers: this.rateLimitByUser.size,\n    };\n  }\n\n  resetMetrics(): void {\n    this.metrics = {\n      totalRequests: 0,\n      successfulRequests: 0,\n      failedRequests: 0,\n      totalLatencyMs: 0,\n      totalTokens: 0,\n      rateLimitHits: 0,\n      circuitBreakerOpens: 0,\n      cacheHits: 0,\n    };\n  }\n}\n\nexport const llmGateway = new LLMGateway();\nexport type { LLMRequestOptions, LLMResponse, StreamChunk };\n","path":null,"size_bytes":15057,"size_tokens":null},"client/src/components/spreadsheet-editor.tsx":{"content":"import { useState, useCallback, useRef, useEffect, useMemo } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport {\n  X,\n  Download,\n  Plus,\n  Trash2,\n  Bold,\n  Italic,\n  AlignLeft,\n  AlignCenter,\n  AlignRight,\n  BarChart3,\n  LineChart,\n  PieChart,\n} from 'lucide-react';\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart as RechartsLineChart, Line, PieChart as RechartsPieChart, Pie, Cell } from 'recharts';\n\ninterface SpreadsheetEditorProps {\n  title: string;\n  content: string;\n  onChange: (content: string) => void;\n  onClose: () => void;\n  onDownload: () => void;\n  onInsertContent?: (insertFn: (content: string) => void) => void;\n}\n\ninterface CellData {\n  value: string;\n  formula?: string;\n  bold?: boolean;\n  italic?: boolean;\n  align?: 'left' | 'center' | 'right';\n}\n\ninterface ChartConfig {\n  type: 'bar' | 'line' | 'pie';\n  visible: boolean;\n  title?: string;\n}\n\ninterface SpreadsheetData {\n  cells: { [key: string]: CellData };\n  rowCount: number;\n  colCount: number;\n}\n\ninterface SheetData {\n  id: string;\n  name: string;\n  data: SpreadsheetData;\n  chartConfig?: ChartConfig;\n}\n\ninterface WorkbookData {\n  sheets: SheetData[];\n  activeSheetId: string;\n}\n\nconst getColumnLabel = (index: number): string => {\n  let label = '';\n  let num = index;\n  while (num >= 0) {\n    label = String.fromCharCode(65 + (num % 26)) + label;\n    num = Math.floor(num / 26) - 1;\n  }\n  return label;\n};\n\nconst getCellKey = (row: number, col: number): string => `${row}-${col}`;\n\nconst parseCellRef = (ref: string): { row: number; col: number } | null => {\n  const match = ref.match(/^([A-Z]+)(\\d+)$/i);\n  if (!match) return null;\n  const colStr = match[1].toUpperCase();\n  const rowNum = parseInt(match[2], 10) - 1;\n  let colNum = 0;\n  for (let i = 0; i < colStr.length; i++) {\n    colNum = colNum * 26 + (colStr.charCodeAt(i) - 64);\n  }\n  colNum -= 1;\n  return { row: rowNum, col: colNum };\n};\n\nconst parseRange = (range: string): Array<{ row: number; col: number }> => {\n  const [start, end] = range.split(':');\n  const startCell = parseCellRef(start);\n  const endCell = end ? parseCellRef(end) : startCell;\n  if (!startCell || !endCell) return [];\n  const cells: Array<{ row: number; col: number }> = [];\n  for (let r = Math.min(startCell.row, endCell.row); r <= Math.max(startCell.row, endCell.row); r++) {\n    for (let c = Math.min(startCell.col, endCell.col); c <= Math.max(startCell.col, endCell.col); c++) {\n      cells.push({ row: r, col: c });\n    }\n  }\n  return cells;\n};\n\nconst evaluateFormula = (formula: string, cells: { [key: string]: CellData }): string => {\n  if (!formula.startsWith('=')) return formula;\n  const expr = formula.substring(1).toUpperCase().trim();\n  \n  const getCellValue = (ref: string): number => {\n    const parsed = parseCellRef(ref);\n    if (!parsed) return 0;\n    const cell = cells[getCellKey(parsed.row, parsed.col)];\n    if (!cell) return 0;\n    const val = parseFloat(cell.value.replace(/[^\\d.-]/g, ''));\n    return isNaN(val) ? 0 : val;\n  };\n  \n  const getRangeValues = (rangeStr: string): number[] => {\n    const rangeCells = parseRange(rangeStr);\n    return rangeCells.map(c => {\n      const cell = cells[getCellKey(c.row, c.col)];\n      if (!cell) return 0;\n      const val = parseFloat(cell.value.replace(/[^\\d.-]/g, ''));\n      return isNaN(val) ? 0 : val;\n    });\n  };\n  \n  const sumMatch = expr.match(/^SUM\\(([^)]+)\\)$/);\n  if (sumMatch) {\n    const values = getRangeValues(sumMatch[1]);\n    return values.reduce((a, b) => a + b, 0).toString();\n  }\n  \n  const avgMatch = expr.match(/^AVERAGE\\(([^)]+)\\)$/);\n  if (avgMatch) {\n    const values = getRangeValues(avgMatch[1]);\n    if (values.length === 0) return '0';\n    const sum = values.reduce((a, b) => a + b, 0);\n    return (sum / values.length).toFixed(2);\n  }\n  \n  const countMatch = expr.match(/^COUNT\\(([^)]+)\\)$/);\n  if (countMatch) {\n    const rangeCells = parseRange(countMatch[1]);\n    let count = 0;\n    rangeCells.forEach(c => {\n      const cell = cells[getCellKey(c.row, c.col)];\n      if (cell && cell.value.trim() !== '') count++;\n    });\n    return count.toString();\n  }\n  \n  const minMatch = expr.match(/^MIN\\(([^)]+)\\)$/);\n  if (minMatch) {\n    const values = getRangeValues(minMatch[1]).filter(v => !isNaN(v));\n    if (values.length === 0) return '0';\n    return Math.min(...values).toString();\n  }\n  \n  const maxMatch = expr.match(/^MAX\\(([^)]+)\\)$/);\n  if (maxMatch) {\n    const values = getRangeValues(maxMatch[1]).filter(v => !isNaN(v));\n    if (values.length === 0) return '0';\n    return Math.max(...values).toString();\n  }\n  \n  const cellRefMatch = expr.match(/^([A-Z]+\\d+)$/);\n  if (cellRefMatch) {\n    return getCellValue(cellRefMatch[1]).toString();\n  }\n  \n  return '#ERROR';\n};\n\nconst createEmptySheet = (id: string, name: string): SheetData => ({\n  id,\n  name,\n  data: { cells: {}, rowCount: 20, colCount: 10 }\n});\n\nconst parseSheetData = (content: string): SpreadsheetData => {\n  if (content.includes('<table') && content.includes('</table>')) {\n    const cells: { [key: string]: CellData } = {};\n    let maxRow = 0;\n    let maxCol = 0;\n    \n    const parser = new DOMParser();\n    const doc = parser.parseFromString(content, 'text/html');\n    const rows = doc.querySelectorAll('tbody tr');\n    \n    rows.forEach((row, rowIndex) => {\n      const tds = row.querySelectorAll('td');\n      tds.forEach((td, colIndex) => {\n        const value = td.textContent?.trim() || '';\n        if (value) {\n          const style = td.getAttribute('style') || '';\n          cells[getCellKey(rowIndex, colIndex)] = {\n            value,\n            bold: style.includes('font-weight: bold'),\n            italic: style.includes('font-style: italic'),\n            align: style.includes('text-align: right') ? 'right' : \n                   style.includes('text-align: center') ? 'center' : 'left'\n          };\n        }\n        maxCol = Math.max(maxCol, colIndex);\n      });\n      maxRow = Math.max(maxRow, rowIndex);\n    });\n\n    return {\n      cells,\n      rowCount: Math.max(maxRow + 1, 20),\n      colCount: Math.max(maxCol + 1, 10),\n    };\n  }\n\n  const lines = content.split('\\n').filter(line => line.trim());\n  const cells: { [key: string]: CellData } = {};\n  let maxCol = 0;\n\n  lines.forEach((line, rowIndex) => {\n    const values = line.split(/[,\\t]/).map(v => v.trim());\n    values.forEach((value, colIndex) => {\n      if (value) {\n        cells[getCellKey(rowIndex, colIndex)] = { value };\n        maxCol = Math.max(maxCol, colIndex);\n      }\n    });\n  });\n\n  return {\n    cells,\n    rowCount: Math.max(lines.length, 20),\n    colCount: Math.max(maxCol + 1, 10),\n  };\n};\n\nconst parseContent = (content: string): WorkbookData => {\n  try {\n    const parsed = JSON.parse(content);\n    if (parsed.sheets && Array.isArray(parsed.sheets)) {\n      return parsed as WorkbookData;\n    }\n    if (parsed.cells && typeof parsed.rowCount === 'number') {\n      return {\n        sheets: [{ id: 'sheet1', name: 'Hoja 1', data: parsed }],\n        activeSheetId: 'sheet1'\n      };\n    }\n  } catch {}\n\n  const sheetData = parseSheetData(content);\n  return {\n    sheets: [{ id: 'sheet1', name: 'Hoja 1', data: sheetData }],\n    activeSheetId: 'sheet1'\n  };\n};\n\nexport function SpreadsheetEditor({\n  title,\n  content,\n  onChange,\n  onClose,\n  onDownload,\n  onInsertContent,\n}: SpreadsheetEditorProps) {\n  const [workbook, setWorkbook] = useState<WorkbookData>(() => parseContent(content));\n  const [selectedCell, setSelectedCell] = useState<string | null>(null);\n  const [editingCell, setEditingCell] = useState<string | null>(null);\n  const [selectionRange, setSelectionRange] = useState<{start: string; end: string} | null>(null);\n  const [showChart, setShowChart] = useState(false);\n  const [chartType, setChartType] = useState<'bar' | 'line' | 'pie'>('bar');\n  const inputRef = useRef<HTMLInputElement>(null);\n  const formulaInputRef = useRef<HTMLInputElement>(null);\n  const initialContentRef = useRef(content);\n  const insertFnRegisteredRef = useRef(false);\n  \n  const CHART_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];\n\n  // Get active sheet data\n  const activeSheet = workbook.sheets.find(s => s.id === workbook.activeSheetId) || workbook.sheets[0];\n  const data = activeSheet?.data || { cells: {}, rowCount: 20, colCount: 10 };\n\n  // Extract chart data from spreadsheet\n  const chartData = useMemo(() => {\n    const result: Array<{ name: string; value: number; [key: string]: string | number }> = [];\n    const headers: string[] = [];\n    \n    // Get headers from first row\n    for (let c = 0; c < data.colCount; c++) {\n      const cell = data.cells[getCellKey(0, c)];\n      if (cell?.value) {\n        headers[c] = cell.value;\n      }\n    }\n    \n    // Get data rows\n    for (let r = 1; r < data.rowCount; r++) {\n      const labelCell = data.cells[getCellKey(r, 0)];\n      if (!labelCell?.value) continue;\n      \n      const row: { name: string; value: number; [key: string]: string | number } = {\n        name: labelCell.value,\n        value: 0\n      };\n      \n      let hasNumericData = false;\n      for (let c = 1; c < data.colCount; c++) {\n        const cell = data.cells[getCellKey(r, c)];\n        if (cell?.value) {\n          const numVal = parseFloat(cell.value.replace(/[^\\d.-]/g, ''));\n          if (!isNaN(numVal)) {\n            const key = headers[c] || `col${c}`;\n            row[key] = numVal;\n            if (c === 1) row.value = numVal;\n            hasNumericData = true;\n          }\n        }\n      }\n      \n      if (hasNumericData) {\n        result.push(row);\n      }\n    }\n    \n    return { data: result, headers: headers.filter((h, i) => i > 0 && h) };\n  }, [data.cells, data.rowCount, data.colCount]);\n\n  // Update active sheet data helper\n  const setData = useCallback((updater: (prev: SpreadsheetData) => SpreadsheetData) => {\n    setWorkbook(prev => ({\n      ...prev,\n      sheets: prev.sheets.map(sheet => \n        sheet.id === prev.activeSheetId \n          ? { ...sheet, data: updater(sheet.data) }\n          : sheet\n      )\n    }));\n  }, []);\n\n  // Sheet management functions\n  const addSheet = useCallback(() => {\n    const newId = `sheet${Date.now()}`;\n    const sheetNum = workbook.sheets.length + 1;\n    setWorkbook(prev => ({\n      ...prev,\n      sheets: [...prev.sheets, createEmptySheet(newId, `Hoja ${sheetNum}`)],\n      activeSheetId: newId\n    }));\n  }, [workbook.sheets.length]);\n\n  const switchSheet = useCallback((sheetId: string) => {\n    setWorkbook(prev => {\n      const newWorkbook = { ...prev, activeSheetId: sheetId };\n      const targetSheet = newWorkbook.sheets.find(s => s.id === sheetId);\n      if (targetSheet?.chartConfig?.visible) {\n        setShowChart(true);\n        setChartType(targetSheet.chartConfig.type);\n      } else {\n        setShowChart(false);\n      }\n      return newWorkbook;\n    });\n    setSelectedCell(null);\n    setEditingCell(null);\n  }, []);\n\n  const renameSheet = useCallback((sheetId: string, newName: string) => {\n    setWorkbook(prev => ({\n      ...prev,\n      sheets: prev.sheets.map(s => s.id === sheetId ? { ...s, name: newName } : s)\n    }));\n  }, []);\n\n  const deleteSheet = useCallback((sheetId: string) => {\n    if (workbook.sheets.length <= 1) return;\n    setWorkbook(prev => {\n      const newSheets = prev.sheets.filter(s => s.id !== sheetId);\n      const newActiveId = prev.activeSheetId === sheetId ? newSheets[0].id : prev.activeSheetId;\n      return { sheets: newSheets, activeSheetId: newActiveId };\n    });\n  }, [workbook.sheets.length]);\n\n  useEffect(() => {\n    if (content !== initialContentRef.current && content) {\n      const newWorkbook = parseContent(content);\n      setWorkbook(newWorkbook);\n      initialContentRef.current = content;\n    }\n  }, [content]);\n\n  const dataToHtml = useCallback((spreadsheetData: SpreadsheetData): string => {\n    let html = '<table border=\"1\" style=\"border-collapse: collapse; width: 100%;\">';\n    html += '<thead><tr>';\n    for (let c = 0; c < spreadsheetData.colCount; c++) {\n      html += `<th style=\"padding: 8px; background: #f0f0f0; font-weight: bold;\">${getColumnLabel(c)}</th>`;\n    }\n    html += '</tr></thead><tbody>';\n    for (let r = 0; r < spreadsheetData.rowCount; r++) {\n      html += '<tr>';\n      for (let c = 0; c < spreadsheetData.colCount; c++) {\n        const cell = spreadsheetData.cells[getCellKey(r, c)] || { value: '' };\n        const style = [\n          'padding: 6px',\n          cell.bold ? 'font-weight: bold' : '',\n          cell.italic ? 'font-style: italic' : '',\n          cell.align ? `text-align: ${cell.align}` : ''\n        ].filter(Boolean).join('; ');\n        html += `<td style=\"${style}\">${cell.value}</td>`;\n      }\n      html += '</tr>';\n    }\n    html += '</tbody></table>';\n    return html;\n  }, []);\n\n  // Serialize workbook to JSON for storage\n  useEffect(() => {\n    const workbookJson = JSON.stringify(workbook);\n    onChange(workbookJson);\n  }, [workbook, onChange]);\n\n  useEffect(() => {\n    if (editingCell && inputRef.current) {\n      inputRef.current.focus();\n      inputRef.current.select();\n    }\n  }, [editingCell]);\n\n  const insertContentFn = useCallback((text: string) => {\n    // Clean markdown from text\n    const cleanMarkdown = (str: string) => str\n      .replace(/^\\*\\*[^*]+\\*\\*\\s*/gm, '')\n      .replace(/^-\\s+\\*\\*([^*]+)\\*\\*:\\s*/gm, '$1,')\n      .replace(/^\\s*-\\s+/gm, '')\n      .replace(/\\[GRAFICO:[^\\]]+\\]/g, '')\n      .trim();\n    \n    // Parse GRAFICO command from content\n    const parseGraficoCommand = (content: string): ChartConfig | null => {\n      const graficoMatch = content.match(/\\[GRAFICO:(barras|lineas|pastel)\\]/i);\n      if (!graficoMatch) return null;\n      const tipoMap: { [k: string]: 'bar' | 'line' | 'pie' } = {\n        'barras': 'bar',\n        'lineas': 'line',\n        'pastel': 'pie'\n      };\n      return {\n        type: tipoMap[graficoMatch[1].toLowerCase()] || 'bar',\n        visible: true\n      };\n    };\n    \n    // Parse lines and insert into a sheet, handling formulas\n    const insertLines = (lines: string[], sheetData: SpreadsheetData): SpreadsheetData => {\n      const newCells = { ...sheetData.cells };\n      let maxColInserted = 0;\n      \n      let startRow = 0;\n      for (let r = 0; r < sheetData.rowCount; r++) {\n        let rowHasData = false;\n        for (let c = 0; c < sheetData.colCount; c++) {\n          if (sheetData.cells[getCellKey(r, c)]?.value) {\n            rowHasData = true;\n            break;\n          }\n        }\n        if (!rowHasData) {\n          startRow = r;\n          break;\n        }\n        startRow = r + 1;\n      }\n      \n      lines.forEach((line, rowOffset) => {\n        const values = line.split(/[,\\t]/).map(v => v.trim());\n        values.forEach((value, colOffset) => {\n          if (value) {\n            const key = getCellKey(startRow + rowOffset, colOffset);\n            if (value.startsWith('=')) {\n              newCells[key] = { value: value, formula: value };\n            } else {\n              newCells[key] = { value };\n            }\n            maxColInserted = Math.max(maxColInserted, colOffset);\n          }\n        });\n      });\n      \n      // Evaluate formulas after all cells are inserted\n      Object.keys(newCells).forEach(key => {\n        const cell = newCells[key];\n        if (cell.formula && cell.formula.startsWith('=')) {\n          cell.value = evaluateFormula(cell.formula, newCells);\n        }\n      });\n      \n      return {\n        ...sheetData,\n        cells: newCells,\n        rowCount: Math.max(sheetData.rowCount, startRow + lines.length + 1),\n        colCount: Math.max(sheetData.colCount, maxColInserted + 1)\n      };\n    };\n    \n    // Check for chart command in text\n    const chartConfig = parseGraficoCommand(text);\n    \n    // Check if there are sheet commands\n    const hasSheetCommands = /\\[(NUEVA_HOJA|HOJA):/.test(text);\n    \n    // If no sheet commands, insert into active sheet\n    if (!hasSheetCommands) {\n      const cleanText = cleanMarkdown(text);\n      const lines = cleanText.split('\\n').filter(line => line.trim());\n      if (lines.length === 0 && !chartConfig) return;\n      \n      if (lines.length > 0) {\n        setData(prev => insertLines(lines, prev));\n      }\n      \n      // Apply chart config to active sheet\n      if (chartConfig) {\n        setWorkbook(prev => ({\n          ...prev,\n          sheets: prev.sheets.map(s => \n            s.id === prev.activeSheetId \n              ? { ...s, chartConfig } \n              : s\n          )\n        }));\n        setShowChart(true);\n        setChartType(chartConfig.type);\n      }\n      return;\n    }\n    \n    // Parse sheet commands and their content using regex.exec\n    const sheetCommandPattern = /\\[(NUEVA_HOJA|HOJA):([^\\]]+)\\]/g;\n    const commands: { type: string; name: string; startIndex: number; endIndex: number }[] = [];\n    let match;\n    \n    while ((match = sheetCommandPattern.exec(text)) !== null) {\n      commands.push({\n        type: match[1],\n        name: match[2].trim(),\n        startIndex: match.index,\n        endIndex: match.index + match[0].length\n      });\n    }\n    \n    // Pre-calculate chart configs for each command section\n    const commandChartConfigs: (ChartConfig | null)[] = commands.map((cmd, idx) => {\n      const contentStart = cmd.endIndex;\n      const contentEnd = idx < commands.length - 1 ? commands[idx + 1].startIndex : text.length;\n      const content = text.substring(contentStart, contentEnd);\n      return parseGraficoCommand(content);\n    });\n    \n    // Find the last chart config for showing after update\n    let finalChartConfig: ChartConfig | null = null;\n    for (let i = commandChartConfigs.length - 1; i >= 0; i--) {\n      if (commandChartConfigs[i]) {\n        finalChartConfig = commandChartConfigs[i];\n        break;\n      }\n    }\n    \n    // Process multiple sheets\n    setWorkbook(prev => {\n      const newSheets: SheetData[] = prev.sheets.map(s => ({ ...s, data: { ...s.data, cells: { ...s.data.cells } } }));\n      let newWorkbook: WorkbookData = { ...prev, sheets: newSheets };\n      let lastSheetId = prev.activeSheetId;\n      \n      commands.forEach((cmd, idx) => {\n        const contentStart = cmd.endIndex;\n        const contentEnd = idx < commands.length - 1 ? commands[idx + 1].startIndex : text.length;\n        const content = text.substring(contentStart, contentEnd);\n        const sectionChartConfig = commandChartConfigs[idx];\n        \n        const cleanedText = cleanMarkdown(content);\n        const lines = cleanedText.split('\\n').filter(line => line.trim());\n        \n        if (cmd.type === 'NUEVA_HOJA') {\n          const newId = `sheet${Date.now()}_${idx}`;\n          const newSheet = createEmptySheet(newId, cmd.name);\n          \n          if (lines.length > 0) {\n            newSheet.data = insertLines(lines, newSheet.data);\n          }\n          \n          if (sectionChartConfig) {\n            newSheet.chartConfig = sectionChartConfig;\n          }\n          \n          newWorkbook.sheets.push(newSheet);\n          lastSheetId = newId;\n        } else if (cmd.type === 'HOJA') {\n          const targetSheet = newWorkbook.sheets.find(s => s.name.toLowerCase() === cmd.name.toLowerCase());\n          if (targetSheet) {\n            const sheetIndex = newWorkbook.sheets.findIndex(s => s.id === targetSheet.id);\n            if (sheetIndex >= 0) {\n              if (lines.length > 0) {\n                newWorkbook.sheets[sheetIndex].data = insertLines(lines, newWorkbook.sheets[sheetIndex].data);\n              }\n              if (sectionChartConfig) {\n                newWorkbook.sheets[sheetIndex].chartConfig = sectionChartConfig;\n              }\n            }\n            lastSheetId = targetSheet.id;\n          }\n        }\n      });\n      \n      newWorkbook.activeSheetId = lastSheetId;\n      return newWorkbook;\n    });\n    \n    // Show chart if any sheet had chart config\n    if (finalChartConfig) {\n      setShowChart(true);\n      setChartType(finalChartConfig.type);\n    }\n  }, [setData]);\n\n  useEffect(() => {\n    if (onInsertContent && !insertFnRegisteredRef.current) {\n      onInsertContent(insertContentFn);\n      insertFnRegisteredRef.current = true;\n    }\n  }, [onInsertContent, insertContentFn]);\n\n  const updateCell = useCallback((key: string, updates: Partial<CellData>) => {\n    setData(prev => ({\n      ...prev,\n      cells: {\n        ...prev.cells,\n        [key]: { ...prev.cells[key], value: '', ...updates },\n      },\n    }));\n  }, []);\n\n  const handleCellClick = useCallback((key: string) => {\n    setSelectedCell(key);\n    setSelectionRange(null);\n  }, []);\n\n  const handleCellDoubleClick = useCallback((key: string) => {\n    setEditingCell(key);\n    setSelectedCell(key);\n  }, []);\n\n  const handleCellChange = useCallback((key: string, value: string) => {\n    if (value.startsWith('=')) {\n      const computedValue = evaluateFormula(value, data.cells);\n      updateCell(key, { value: computedValue, formula: value });\n    } else {\n      updateCell(key, { value, formula: undefined });\n    }\n  }, [updateCell, data.cells]);\n\n  const handleCellBlur = useCallback(() => {\n    setEditingCell(null);\n  }, []);\n\n  const handleKeyDown = useCallback((e: React.KeyboardEvent, key: string) => {\n    const [row, col] = key.split('-').map(Number);\n    \n    if (e.key === 'Enter') {\n      e.preventDefault();\n      setEditingCell(null);\n      const nextKey = getCellKey(row + 1, col);\n      setSelectedCell(nextKey);\n    } else if (e.key === 'Tab') {\n      e.preventDefault();\n      setEditingCell(null);\n      const nextKey = getCellKey(row, col + 1);\n      setSelectedCell(nextKey);\n    } else if (e.key === 'Escape') {\n      setEditingCell(null);\n    }\n  }, []);\n\n  const handleNavigationKeyDown = useCallback((e: React.KeyboardEvent) => {\n    if (!selectedCell || editingCell) return;\n    \n    const [row, col] = selectedCell.split('-').map(Number);\n    let newRow = row;\n    let newCol = col;\n\n    switch (e.key) {\n      case 'ArrowUp':\n        newRow = Math.max(0, row - 1);\n        break;\n      case 'ArrowDown':\n        newRow = Math.min(data.rowCount - 1, row + 1);\n        break;\n      case 'ArrowLeft':\n        newCol = Math.max(0, col - 1);\n        break;\n      case 'ArrowRight':\n        newCol = Math.min(data.colCount - 1, col + 1);\n        break;\n      case 'Enter':\n        setEditingCell(selectedCell);\n        e.preventDefault();\n        return;\n      default:\n        if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {\n          setEditingCell(selectedCell);\n          updateCell(selectedCell, { value: e.key });\n        }\n        return;\n    }\n\n    e.preventDefault();\n    setSelectedCell(getCellKey(newRow, newCol));\n  }, [selectedCell, editingCell, data.rowCount, data.colCount, updateCell]);\n\n  const addRow = useCallback(() => {\n    setData(prev => ({ ...prev, rowCount: prev.rowCount + 1 }));\n  }, []);\n\n  const addColumn = useCallback(() => {\n    setData(prev => ({ ...prev, colCount: prev.colCount + 1 }));\n  }, []);\n\n  const deleteRow = useCallback(() => {\n    if (!selectedCell) return;\n    const [row] = selectedCell.split('-').map(Number);\n    setData(prev => {\n      const newCells: { [key: string]: CellData } = {};\n      Object.entries(prev.cells).forEach(([key, cell]) => {\n        const [r, c] = key.split('-').map(Number);\n        if (r < row) {\n          newCells[key] = cell;\n        } else if (r > row) {\n          newCells[getCellKey(r - 1, c)] = cell;\n        }\n      });\n      return { ...prev, cells: newCells, rowCount: Math.max(1, prev.rowCount - 1) };\n    });\n    setSelectedCell(null);\n  }, [selectedCell]);\n\n  const deleteColumn = useCallback(() => {\n    if (!selectedCell) return;\n    const [, col] = selectedCell.split('-').map(Number);\n    setData(prev => {\n      const newCells: { [key: string]: CellData } = {};\n      Object.entries(prev.cells).forEach(([key, cell]) => {\n        const [r, c] = key.split('-').map(Number);\n        if (c < col) {\n          newCells[key] = cell;\n        } else if (c > col) {\n          newCells[getCellKey(r, c - 1)] = cell;\n        }\n      });\n      return { ...prev, cells: newCells, colCount: Math.max(1, prev.colCount - 1) };\n    });\n    setSelectedCell(null);\n  }, [selectedCell]);\n\n  const toggleBold = useCallback(() => {\n    if (!selectedCell) return;\n    const cell = data.cells[selectedCell] || { value: '' };\n    updateCell(selectedCell, { ...cell, bold: !cell.bold });\n  }, [selectedCell, data.cells, updateCell]);\n\n  const toggleItalic = useCallback(() => {\n    if (!selectedCell) return;\n    const cell = data.cells[selectedCell] || { value: '' };\n    updateCell(selectedCell, { ...cell, italic: !cell.italic });\n  }, [selectedCell, data.cells, updateCell]);\n\n  const setAlignment = useCallback((align: 'left' | 'center' | 'right') => {\n    if (!selectedCell) return;\n    const cell = data.cells[selectedCell] || { value: '' };\n    updateCell(selectedCell, { ...cell, align });\n  }, [selectedCell, data.cells, updateCell]);\n\n  const updateChartConfig = useCallback((type: 'bar' | 'line' | 'pie', visible: boolean) => {\n    setWorkbook(prev => ({\n      ...prev,\n      sheets: prev.sheets.map(s => \n        s.id === prev.activeSheetId \n          ? { ...s, chartConfig: { type, visible, title: s.chartConfig?.title } } \n          : s\n      )\n    }));\n    setChartType(type);\n    setShowChart(visible);\n  }, []);\n\n  const hideChart = useCallback(() => {\n    setWorkbook(prev => ({\n      ...prev,\n      sheets: prev.sheets.map(s => \n        s.id === prev.activeSheetId && s.chartConfig\n          ? { ...s, chartConfig: { ...s.chartConfig, visible: false } } \n          : s\n      )\n    }));\n    setShowChart(false);\n  }, []);\n\n  // Recalculate formulas when cells change\n  const recalculateFormulas = useCallback(() => {\n    setData(prev => {\n      const newCells = { ...prev.cells };\n      let changed = false;\n      Object.keys(newCells).forEach(key => {\n        const cell = newCells[key];\n        if (cell.formula && cell.formula.startsWith('=')) {\n          const newValue = evaluateFormula(cell.formula, newCells);\n          if (newValue !== cell.value) {\n            newCells[key] = { ...cell, value: newValue };\n            changed = true;\n          }\n        }\n      });\n      return changed ? { ...prev, cells: newCells } : prev;\n    });\n  }, [setData]);\n\n  // Recalculate formulas when data changes\n  useEffect(() => {\n    const hasFormulas = Object.values(data.cells).some(cell => cell.formula);\n    if (hasFormulas) {\n      recalculateFormulas();\n    }\n  }, [data.cells, recalculateFormulas]);\n\n  // Auto-show chart on initial load if chartConfig.visible is true\n  useEffect(() => {\n    if (activeSheet?.chartConfig?.visible) {\n      setShowChart(true);\n      setChartType(activeSheet.chartConfig.type);\n    }\n  }, []);\n\n  const selectedCellData = selectedCell ? data.cells[selectedCell] : null;\n  const selectedCellLabel = selectedCell \n    ? `${getColumnLabel(parseInt(selectedCell.split('-')[1]))}${parseInt(selectedCell.split('-')[0]) + 1}`\n    : '';\n\n  return (\n    <div \n      className=\"spreadsheet-editor flex flex-col h-full bg-white dark:bg-black\"\n      onKeyDown={handleNavigationKeyDown}\n      tabIndex={0}\n    >\n      {/* Top Action Bar */}\n      <div className=\"flex items-center justify-between px-4 py-2 border-b border-gray-200 dark:border-gray-800\">\n        <div className=\"flex items-center gap-3\">\n          <span className=\"font-medium text-sm\">{title}</span>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button variant=\"default\" size=\"sm\" onClick={onDownload} className=\"gap-2\">\n            <Download className=\"h-4 w-4\" />\n            Descargar\n          </Button>\n          <Button variant=\"ghost\" size=\"icon\" onClick={onClose}>\n            <X className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      {/* Toolbar */}\n      <div className=\"flex items-center gap-1 px-4 py-2 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-950\">\n        {/* Cell Reference */}\n        <div className=\"w-16 px-2 py-1 text-xs font-mono bg-white dark:bg-black border rounded text-center\">\n          {selectedCellLabel}\n        </div>\n        \n        {/* Formula Bar */}\n        <input\n          ref={formulaInputRef}\n          type=\"text\"\n          className=\"flex-1 max-w-md px-3 py-1 text-sm border rounded bg-white dark:bg-black focus:outline-none focus:ring-1 focus:ring-black dark:focus:ring-white\"\n          placeholder=\"Ingresa un valor o fórmula\"\n          value={selectedCellData?.formula || selectedCellData?.value || ''}\n          onChange={(e) => selectedCell && handleCellChange(selectedCell, e.target.value)}\n        />\n\n        <div className=\"h-6 w-px bg-gray-300 dark:bg-gray-700 mx-2\" />\n\n        {/* Formatting */}\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className={cn('h-8 w-8', selectedCellData?.bold && 'bg-gray-200 dark:bg-gray-800')}\n          onClick={toggleBold}\n        >\n          <Bold className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className={cn('h-8 w-8', selectedCellData?.italic && 'bg-gray-200 dark:bg-gray-800')}\n          onClick={toggleItalic}\n        >\n          <Italic className=\"h-4 w-4\" />\n        </Button>\n\n        <div className=\"h-6 w-px bg-gray-300 dark:bg-gray-700 mx-2\" />\n\n        {/* Alignment */}\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className={cn('h-8 w-8', selectedCellData?.align === 'left' && 'bg-gray-200 dark:bg-gray-800')}\n          onClick={() => setAlignment('left')}\n        >\n          <AlignLeft className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className={cn('h-8 w-8', selectedCellData?.align === 'center' && 'bg-gray-200 dark:bg-gray-800')}\n          onClick={() => setAlignment('center')}\n        >\n          <AlignCenter className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className={cn('h-8 w-8', selectedCellData?.align === 'right' && 'bg-gray-200 dark:bg-gray-800')}\n          onClick={() => setAlignment('right')}\n        >\n          <AlignRight className=\"h-4 w-4\" />\n        </Button>\n\n        <div className=\"h-6 w-px bg-gray-300 dark:bg-gray-700 mx-2\" />\n\n        {/* Row/Column Actions */}\n        <Button variant=\"ghost\" size=\"sm\" onClick={addRow} className=\"gap-1 text-xs\">\n          <Plus className=\"h-3 w-3\" /> Fila\n        </Button>\n        <Button variant=\"ghost\" size=\"sm\" onClick={addColumn} className=\"gap-1 text-xs\">\n          <Plus className=\"h-3 w-3\" /> Columna\n        </Button>\n        <Button variant=\"ghost\" size=\"sm\" onClick={deleteRow} disabled={!selectedCell} className=\"gap-1 text-xs text-red-600\">\n          <Trash2 className=\"h-3 w-3\" /> Fila\n        </Button>\n        <Button variant=\"ghost\" size=\"sm\" onClick={deleteColumn} disabled={!selectedCell} className=\"gap-1 text-xs text-red-600\">\n          <Trash2 className=\"h-3 w-3\" /> Col\n        </Button>\n\n        <div className=\"h-6 w-px bg-gray-300 dark:bg-gray-700 mx-2\" />\n\n        {/* Chart Controls */}\n        <Button\n          variant={showChart && chartType === 'bar' ? 'default' : 'ghost'}\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => updateChartConfig('bar', true)}\n          title=\"Gráfico de barras\"\n          data-testid=\"btn-bar-chart\"\n        >\n          <BarChart3 className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant={showChart && chartType === 'line' ? 'default' : 'ghost'}\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => updateChartConfig('line', true)}\n          title=\"Gráfico de líneas\"\n          data-testid=\"btn-line-chart\"\n        >\n          <LineChart className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant={showChart && chartType === 'pie' ? 'default' : 'ghost'}\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => updateChartConfig('pie', true)}\n          title=\"Gráfico circular\"\n          data-testid=\"btn-pie-chart\"\n        >\n          <PieChart className=\"h-4 w-4\" />\n        </Button>\n        {showChart && (\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"text-xs text-gray-500\"\n            onClick={hideChart}\n          >\n            Ocultar\n          </Button>\n        )}\n      </div>\n\n      {/* Chart Panel */}\n      {showChart && chartData.data.length > 0 && (\n        <div className=\"border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-black p-4\" style={{ height: '280px' }}>\n          <div className=\"flex items-center justify-between mb-2\">\n            <h3 className=\"text-sm font-medium\">Gráfico: {activeSheet?.name}</h3>\n            <span className=\"text-xs text-gray-500\">{chartData.data.length} registros</span>\n          </div>\n          <ResponsiveContainer width=\"100%\" height=\"90%\">\n            {chartType === 'bar' ? (\n              <BarChart data={chartData.data}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n                <XAxis dataKey=\"name\" tick={{ fontSize: 11 }} />\n                <YAxis tick={{ fontSize: 11 }} />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: 'white', \n                    border: '1px solid #e5e7eb',\n                    borderRadius: '6px',\n                    fontSize: '12px'\n                  }} \n                />\n                {chartData.headers.length > 0 ? (\n                  chartData.headers.map((header, i) => (\n                    <Bar key={header} dataKey={header} fill={CHART_COLORS[i % CHART_COLORS.length]} radius={[4, 4, 0, 0]} />\n                  ))\n                ) : (\n                  <Bar dataKey=\"value\" fill=\"#3b82f6\" radius={[4, 4, 0, 0]} />\n                )}\n              </BarChart>\n            ) : chartType === 'line' ? (\n              <RechartsLineChart data={chartData.data}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n                <XAxis dataKey=\"name\" tick={{ fontSize: 11 }} />\n                <YAxis tick={{ fontSize: 11 }} />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: 'white', \n                    border: '1px solid #e5e7eb',\n                    borderRadius: '6px',\n                    fontSize: '12px'\n                  }} \n                />\n                {chartData.headers.length > 0 ? (\n                  chartData.headers.map((header, i) => (\n                    <Line key={header} type=\"monotone\" dataKey={header} stroke={CHART_COLORS[i % CHART_COLORS.length]} strokeWidth={2} dot={{ fill: CHART_COLORS[i % CHART_COLORS.length] }} />\n                  ))\n                ) : (\n                  <Line type=\"monotone\" dataKey=\"value\" stroke=\"#3b82f6\" strokeWidth={2} dot={{ fill: '#3b82f6' }} />\n                )}\n              </RechartsLineChart>\n            ) : (\n              <RechartsPieChart>\n                <Pie\n                  data={chartData.data}\n                  dataKey=\"value\"\n                  nameKey=\"name\"\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  outerRadius={80}\n                  label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                  labelLine={{ stroke: '#9ca3af' }}\n                >\n                  {chartData.data.map((_, index) => (\n                    <Cell key={`cell-${index}`} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                  ))}\n                </Pie>\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: 'white', \n                    border: '1px solid #e5e7eb',\n                    borderRadius: '6px',\n                    fontSize: '12px'\n                  }} \n                />\n              </RechartsPieChart>\n            )}\n          </ResponsiveContainer>\n        </div>\n      )}\n\n      {showChart && chartData.data.length === 0 && (\n        <div className=\"border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 p-6 text-center\">\n          <BarChart3 className=\"h-12 w-12 mx-auto text-gray-300 mb-2\" />\n          <p className=\"text-sm text-gray-500\">Agrega datos numéricos para ver el gráfico</p>\n          <p className=\"text-xs text-gray-400 mt-1\">Primera columna: etiquetas, siguientes columnas: valores</p>\n        </div>\n      )}\n\n      {/* Spreadsheet Grid */}\n      <div className=\"flex-1 overflow-auto\">\n        <table className=\"spreadsheet-table border-collapse w-full\">\n          <thead className=\"sticky top-0 z-10\">\n            <tr>\n              {/* Corner cell */}\n              <th className=\"spreadsheet-corner-cell\" />\n              {/* Column headers */}\n              {Array.from({ length: data.colCount }, (_, i) => (\n                <th key={i} className=\"spreadsheet-col-header\">\n                  {getColumnLabel(i)}\n                </th>\n              ))}\n            </tr>\n          </thead>\n          <tbody>\n            {Array.from({ length: data.rowCount }, (_, rowIndex) => (\n              <tr key={rowIndex}>\n                {/* Row header */}\n                <td className=\"spreadsheet-row-header\">\n                  {rowIndex + 1}\n                </td>\n                {/* Data cells */}\n                {Array.from({ length: data.colCount }, (_, colIndex) => {\n                  const key = getCellKey(rowIndex, colIndex);\n                  const cell = data.cells[key] || { value: '' };\n                  const isSelected = selectedCell === key;\n                  const isEditing = editingCell === key;\n\n                  return (\n                    <td\n                      key={colIndex}\n                      className={cn(\n                        'spreadsheet-cell',\n                        isSelected && 'spreadsheet-cell-selected',\n                        cell.bold && 'font-bold',\n                        cell.italic && 'italic'\n                      )}\n                      style={{ textAlign: cell.align || 'left' }}\n                      onClick={() => handleCellClick(key)}\n                      onDoubleClick={() => handleCellDoubleClick(key)}\n                    >\n                      {isEditing ? (\n                        <input\n                          ref={inputRef}\n                          type=\"text\"\n                          className=\"spreadsheet-cell-input\"\n                          value={cell.value}\n                          onChange={(e) => handleCellChange(key, e.target.value)}\n                          onBlur={handleCellBlur}\n                          onKeyDown={(e) => handleKeyDown(e, key)}\n                        />\n                      ) : (\n                        <span className=\"spreadsheet-cell-content\">{cell.value}</span>\n                      )}\n                    </td>\n                  );\n                })}\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n\n      {/* Sheet Tabs */}\n      <div className=\"flex items-center border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-950\">\n        <div className=\"flex items-center gap-1 px-2 py-1 overflow-x-auto flex-1\">\n          {workbook.sheets.map(sheet => (\n            <button\n              key={sheet.id}\n              onClick={() => switchSheet(sheet.id)}\n              className={cn(\n                'px-3 py-1.5 text-xs rounded-t border-x border-t transition-colors whitespace-nowrap',\n                sheet.id === workbook.activeSheetId\n                  ? 'bg-white dark:bg-black border-gray-300 dark:border-gray-700 font-medium'\n                  : 'bg-gray-100 dark:bg-gray-900 border-transparent hover:bg-gray-200 dark:hover:bg-gray-800'\n              )}\n            >\n              {sheet.name}\n              {workbook.sheets.length > 1 && (\n                <span\n                  onClick={(e) => { e.stopPropagation(); deleteSheet(sheet.id); }}\n                  className=\"ml-2 text-gray-400 hover:text-red-500 cursor-pointer\"\n                >\n                  ×\n                </span>\n              )}\n            </button>\n          ))}\n          <button\n            onClick={addSheet}\n            className=\"px-2 py-1 text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300\"\n            title=\"Agregar hoja\"\n          >\n            <Plus className=\"h-4 w-4\" />\n          </button>\n        </div>\n        <div className=\"px-4 py-1 text-xs text-gray-500 border-l border-gray-200 dark:border-gray-800\">\n          {data.rowCount} × {data.colCount}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":40633,"size_tokens":null},"server/etl/connectors/index.ts":{"content":"import { fetchWorldBankData } from './worldBank';\nimport { fetchFredData } from './fred';\nimport { fetchIMFData } from './imf';\nimport { NormalizedRecord, RawDataRecord, DataSourceType, COUNTRY_CODES } from '../types';\n\nexport interface FetchResult {\n  raw: RawDataRecord[];\n  normalized: NormalizedRecord[];\n  errors: string[];\n}\n\nexport async function fetchDataForIndicator(\n  countryCode: string,\n  indicatorId: string,\n  startDate: string,\n  endDate: string,\n  preferredSources: DataSourceType[]\n): Promise<FetchResult> {\n  const raw: RawDataRecord[] = [];\n  const normalized: NormalizedRecord[] = [];\n  const errors: string[] = [];\n\n  for (const source of preferredSources) {\n    try {\n      let result: { raw: RawDataRecord; normalized: NormalizedRecord[] } | null = null;\n\n      switch (source) {\n        case 'world_bank':\n          result = await fetchWorldBankData(countryCode, indicatorId, startDate, endDate);\n          break;\n        case 'fred':\n          if (countryCode === 'USA') {\n            result = await fetchFredData(indicatorId, startDate, endDate);\n          }\n          break;\n        case 'imf':\n          result = await fetchIMFData(countryCode, indicatorId, startDate, endDate);\n          break;\n        default:\n          break;\n      }\n\n      if (result && result.normalized.length > 0) {\n        raw.push(result.raw);\n        normalized.push(...result.normalized);\n        break;\n      }\n    } catch (error) {\n      const errorMsg = `Error fetching from ${source}: ${error instanceof Error ? error.message : 'Unknown error'}`;\n      console.error(`[Connectors] ${errorMsg}`);\n      errors.push(errorMsg);\n    }\n  }\n\n  if (normalized.length === 0 && errors.length === 0) {\n    errors.push(`No data found for ${countryCode}/${indicatorId} from any source`);\n  }\n\n  return { raw, normalized, errors };\n}\n\nexport function getCountryCode(countryName: string): string | null {\n  return COUNTRY_CODES[countryName] || null;\n}\n\nexport function getAllCountryCodes(): Record<string, string> {\n  return COUNTRY_CODES;\n}\n","path":null,"size_bytes":2040,"size_tokens":null},"server/etl/connectors/imf.ts":{"content":"import { NormalizedRecord, SourceMetadata, RawDataRecord, DataSourceType } from '../types';\n\nconst IMF_API = 'https://www.imf.org/external/datamapper/api/v1';\n\nconst INDICATOR_MAPPING: Record<string, string> = {\n  'GDP': 'NGDPD',\n  'GDP_GROWTH': 'NGDP_RPCH',\n  'INFLATION': 'PCPIPCH',\n  'UNEMPLOYMENT': 'LUR',\n  'POPULATION': 'LP',\n  'EXPORTS': 'TXG_RPCH',\n  'IMPORTS': 'TMG_RPCH'\n};\n\nconst UNIT_MAPPING: Record<string, string> = {\n  'NGDPD': 'billions USD',\n  'NGDP_RPCH': 'percent change',\n  'PCPIPCH': 'percent change',\n  'LUR': 'percent',\n  'LP': 'millions',\n  'TXG_RPCH': 'percent change',\n  'TMG_RPCH': 'percent change'\n};\n\nexport async function fetchIMFData(\n  countryCode: string,\n  indicatorId: string,\n  startYear: string,\n  endYear: string\n): Promise<{ raw: RawDataRecord; normalized: NormalizedRecord[] } | null> {\n  const imfIndicator = INDICATOR_MAPPING[indicatorId];\n  if (!imfIndicator) {\n    return null;\n  }\n\n  const url = `${IMF_API}/${imfIndicator}/${countryCode}`;\n  \n  try {\n    const response = await fetch(url);\n    if (!response.ok) {\n      return null;\n    }\n\n    const data = await response.json();\n    const timestamp = new Date().toISOString();\n    const sourceId = `IMF_${countryCode}_${indicatorId}_${timestamp.split('T')[0]}`;\n\n    const metadata: SourceMetadata = {\n      sourceId,\n      provider: 'imf' as DataSourceType,\n      url,\n      method: 'API',\n      timestamp,\n      indicator: indicatorId,\n      country: countryCode,\n      unit: UNIT_MAPPING[imfIndicator] || 'unknown',\n      frequency: 'A',\n      notes: `IMF DataMapper API - Indicator ${imfIndicator}`\n    };\n\n    const rawRecord: RawDataRecord = {\n      sourceId,\n      rawData: data,\n      metadata\n    };\n\n    const normalized: NormalizedRecord[] = [];\n    const startYearNum = parseInt(startYear.split('-')[0]);\n    const endYearNum = parseInt(endYear.split('-')[0]);\n\n    if (data.values && data.values[imfIndicator] && data.values[imfIndicator][countryCode]) {\n      const countryData = data.values[imfIndicator][countryCode];\n      for (const [year, value] of Object.entries(countryData)) {\n        const yearNum = parseInt(year);\n        if (yearNum >= startYearNum && yearNum <= endYearNum && value !== null) {\n          normalized.push({\n            date: `${year}-01`,\n            country: countryCode,\n            countryCode,\n            indicator: indicatorId,\n            indicatorCode: imfIndicator,\n            value: value as number,\n            unit: UNIT_MAPPING[imfIndicator] || 'unknown',\n            frequency: 'A',\n            sourceId\n          });\n        }\n      }\n    }\n\n    return { raw: rawRecord, normalized };\n  } catch (error) {\n    return null;\n  }\n}\n\nexport function getAvailableIndicators(): string[] {\n  return Object.keys(INDICATOR_MAPPING);\n}\n","path":null,"size_bytes":2780,"size_tokens":null},"server/etl/excelBuilder.ts":{"content":"import ExcelJS from 'exceljs';\n// @ts-ignore - xlsx-chart doesn't have type definitions\nimport XLSXChart from 'xlsx-chart';\nimport JSZip from 'jszip';\nimport { \n  WorkbookSheets, \n  NormalizedRecord, \n  SourceMetadata, \n  AuditTest,\n  RawDataRecord\n} from './types';\n\nexport async function buildExcelWorkbook(sheets: WorkbookSheets): Promise<Buffer> {\n  return generateDataWorkbook(sheets);\n}\n\nexport async function buildExcelWorkbookBundle(sheets: WorkbookSheets): Promise<Buffer> {\n  const [dataBuffer, chartBuffer] = await Promise.all([\n    generateDataWorkbook(sheets),\n    generateChartWorkbook(sheets.clean, sheets.dashboard)\n  ]);\n  \n  const zip = new JSZip();\n  zip.file('ETL_Datos_Completos.xlsx', dataBuffer);\n  zip.file('ETL_Grafico_Dashboard.xlsx', chartBuffer);\n  zip.file('LEEME.txt', `ETL Data Bundle\n=================\nEste archivo ZIP contiene dos archivos Excel:\n\n1. ETL_Datos_Completos.xlsx\n   - Workbook completo con 7 hojas de datos\n   - Incluye: README, SOURCES, RAW, CLEAN, MODEL, DASHBOARD, AUDIT\n   - Todos los datos con formato profesional y filtros\n\n2. ETL_Grafico_Dashboard.xlsx\n   - Gráfico nativo de Excel con resumen por país\n   - Abre en Excel para ver el gráfico de columnas\n\nGenerado por Sira GPT ETL Agent\n${new Date().toISOString()}\n`);\n  \n  const zipBuffer = await zip.generateAsync({ type: 'nodebuffer', compression: 'DEFLATE' });\n  return Buffer.from(zipBuffer);\n}\n\nasync function generateChartWorkbook(clean: NormalizedRecord[], dashboard: WorkbookSheets['dashboard']): Promise<Buffer> {\n  const xlsxChart = new XLSXChart();\n  \n  const byCountry = new Map<string, { records: number; valueSum: number; valueCount: number }>();\n  for (const r of clean) {\n    if (!byCountry.has(r.countryCode)) {\n      byCountry.set(r.countryCode, { records: 0, valueSum: 0, valueCount: 0 });\n    }\n    const entry = byCountry.get(r.countryCode)!;\n    entry.records++;\n    if (r.value !== null) {\n      entry.valueSum += r.value;\n      entry.valueCount++;\n    }\n  }\n\n  const titles = Array.from(byCountry.keys()).slice(0, 10);\n  const chartData: Record<string, Record<string, number>> = {};\n  \n  for (const country of titles) {\n    const entry = byCountry.get(country)!;\n    const avgValue = entry.valueCount > 0 ? entry.valueSum / entry.valueCount : 0;\n    chartData[country] = {\n      'Total Records': entry.records,\n      'Avg Value (M)': Math.round(avgValue / 1000000)\n    };\n  }\n\n  if (titles.length === 0) {\n    chartData['No Data'] = { 'Total Records': 0, 'Avg Value (M)': 0 };\n    titles.push('No Data');\n  }\n\n  const opts = {\n    chart: 'column' as const,\n    titles,\n    fields: ['Total Records', 'Avg Value (M)'],\n    data: chartData,\n    chartTitle: 'Economic Data Summary by Country'\n  };\n\n  return new Promise((resolve, reject) => {\n    xlsxChart.generate(opts, (err: Error | null, data: Buffer) => {\n      if (err) reject(err);\n      else resolve(data);\n    });\n  });\n}\n\nasync function generateDataWorkbook(sheets: WorkbookSheets): Promise<Buffer> {\n  const workbook = new ExcelJS.Workbook();\n  workbook.creator = 'Sira GPT ETL Agent';\n  workbook.created = new Date();\n\n  buildReadmeSheet(workbook, sheets.readme);\n  buildSourcesSheet(workbook, sheets.sources);\n  buildRawSheet(workbook, sheets.raw);\n  buildCleanSheet(workbook, sheets.clean);\n  buildModelSheet(workbook, sheets.model, sheets.clean);\n  buildDashboardSheet(workbook, sheets.dashboard, sheets.clean);\n  buildAuditSheet(workbook, sheets.audit);\n\n  const buffer = await workbook.xlsx.writeBuffer();\n  return Buffer.from(buffer);\n}\n\nfunction buildReadmeSheet(workbook: ExcelJS.Workbook, readme: WorkbookSheets['readme']): void {\n  const sheet = workbook.addWorksheet('00_README');\n  sheet.getColumn(1).width = 20;\n  sheet.getColumn(2).width = 80;\n\n  const titleRow = sheet.addRow(['', readme.title]);\n  titleRow.font = { bold: true, size: 18 };\n  titleRow.height = 30;\n\n  sheet.addRow([]);\n  sheet.addRow(['Description:', readme.description]);\n  sheet.addRow(['Generated At:', readme.generatedAt]);\n  sheet.addRow([]);\n  sheet.addRow(['SPECIFICATION']);\n  sheet.addRow(['Countries:', readme.spec.countries.join(', ')]);\n  sheet.addRow(['Date Range:', `${readme.spec.dateRange.start} to ${readme.spec.dateRange.end}`]);\n  sheet.addRow(['Indicators:', readme.spec.indicators.map(i => i.name).join(', ')]);\n  sheet.addRow([]);\n  sheet.addRow(['METHODOLOGY']);\n  for (const line of readme.methodology.split('\\n')) {\n    sheet.addRow(['', line]);\n  }\n  sheet.addRow([]);\n  sheet.addRow(['SHEETS']);\n  sheet.addRow(['00_README', 'This documentation sheet']);\n  sheet.addRow(['01_SOURCES', 'Data source traceability with URLs, timestamps, and metadata']);\n  sheet.addRow(['02_RAW', 'Raw downloaded data preserved as-is']);\n  sheet.addRow(['03_CLEAN', 'Normalized and deduplicated data']);\n  sheet.addRow(['04_MODEL', 'Calculated metrics with formulas']);\n  sheet.addRow(['05_DASHBOARD', 'Summary tables and chart-ready data']);\n  sheet.addRow(['06_AUDIT', 'Quality control test results']);\n  sheet.addRow([]);\n  sheet.addRow(['Contact:', readme.contacts]);\n}\n\nfunction buildSourcesSheet(workbook: ExcelJS.Workbook, sources: SourceMetadata[]): void {\n  const sheet = workbook.addWorksheet('01_SOURCES');\n  const headers = ['Source_ID', 'Provider', 'URL', 'Method', 'Timestamp', 'Indicator', 'Country', 'Unit', 'Frequency', 'Notes'];\n  const headerRow = sheet.addRow(headers);\n  headerRow.font = { bold: true };\n  headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };\n  headerRow.eachCell(cell => { cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; });\n\n  for (const source of sources) {\n    sheet.addRow([source.sourceId, source.provider, source.url, source.method, source.timestamp, source.indicator, source.country, source.unit, source.frequency, source.notes]);\n  }\n  \n  sheet.getColumn(1).width = 30;\n  sheet.getColumn(2).width = 15;\n  sheet.getColumn(3).width = 60;\n  sheet.getColumn(4).width = 10;\n  sheet.getColumn(5).width = 25;\n  sheet.getColumn(6).width = 15;\n  sheet.getColumn(7).width = 10;\n  sheet.getColumn(8).width = 15;\n  sheet.getColumn(9).width = 10;\n  sheet.getColumn(10).width = 40;\n  \n  if (sources.length > 0) {\n    sheet.autoFilter = { from: 'A1', to: `J${sources.length + 1}` };\n  }\n}\n\nfunction buildRawSheet(workbook: ExcelJS.Workbook, raw: RawDataRecord[]): void {\n  const sheet = workbook.addWorksheet('02_RAW');\n  const headers = ['Source_ID', 'Provider', 'Indicator', 'Country', 'Timestamp', 'Record_Count', 'Raw_JSON_Sample'];\n  const headerRow = sheet.addRow(headers);\n  headerRow.font = { bold: true };\n  headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF70AD47' } };\n  headerRow.eachCell(cell => { cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; });\n\n  for (const record of raw) {\n    const rawSample = JSON.stringify(record.rawData).substring(0, 500) + '...';\n    const recordCount = Array.isArray(record.rawData) && record.rawData.length >= 2 && Array.isArray(record.rawData[1]) ? record.rawData[1].length : 'N/A';\n    sheet.addRow([record.sourceId, record.metadata.provider, record.metadata.indicator, record.metadata.country, record.metadata.timestamp, recordCount, rawSample]);\n  }\n  \n  sheet.getColumn(1).width = 35;\n  sheet.getColumn(2).width = 15;\n  sheet.getColumn(3).width = 15;\n  sheet.getColumn(4).width = 10;\n  sheet.getColumn(5).width = 25;\n  sheet.getColumn(6).width = 15;\n  sheet.getColumn(7).width = 80;\n}\n\nfunction buildCleanSheet(workbook: ExcelJS.Workbook, clean: NormalizedRecord[]): void {\n  const sheet = workbook.addWorksheet('03_CLEAN');\n  const headers = ['Date', 'Country', 'Country_Code', 'Indicator', 'Indicator_Code', 'Value', 'Unit', 'Frequency', 'Source_ID'];\n  const headerRow = sheet.addRow(headers);\n  headerRow.font = { bold: true };\n  headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFC000' } };\n\n  for (const record of clean) {\n    sheet.addRow([record.date, record.country, record.countryCode, record.indicator, record.indicatorCode, record.value, record.unit, record.frequency, record.sourceId]);\n  }\n  \n  sheet.getColumn(1).width = 12;\n  sheet.getColumn(2).width = 20;\n  sheet.getColumn(3).width = 12;\n  sheet.getColumn(4).width = 15;\n  sheet.getColumn(5).width = 20;\n  sheet.getColumn(6).width = 18;\n  sheet.getColumn(6).numFmt = '#,##0.00';\n  sheet.getColumn(7).width = 15;\n  sheet.getColumn(8).width = 10;\n  sheet.getColumn(9).width = 35;\n  \n  if (clean.length > 0) {\n    sheet.autoFilter = { from: 'A1', to: `I${clean.length + 1}` };\n  }\n}\n\nfunction buildModelSheet(workbook: ExcelJS.Workbook, model: WorkbookSheets['model'], clean: NormalizedRecord[]): void {\n  const sheet = workbook.addWorksheet('04_MODEL');\n  \n  sheet.addRow(['METRIC DEFINITIONS']);\n  const defHeaders = ['Metric_ID', 'Name', 'Formula', 'Description'];\n  const defHeaderRow = sheet.addRow(defHeaders);\n  defHeaderRow.font = { bold: true };\n  defHeaderRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF9C27B0' } };\n  defHeaderRow.eachCell(cell => { cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; });\n\n  for (const metric of model.metrics) {\n    sheet.addRow([metric.id, metric.name, metric.formula, metric.description]);\n  }\n\n  sheet.addRow([]);\n  sheet.addRow([]);\n  sheet.addRow(['SUMMARY BY COUNTRY AND INDICATOR']);\n  \n  const summaryHeaders = ['Country', 'Indicator', 'Latest_Year', 'Latest_Value', 'Avg_5Y', 'YoY_Change', 'Min', 'Max'];\n  const summaryHeaderRow = sheet.addRow(summaryHeaders);\n  summaryHeaderRow.font = { bold: true };\n  summaryHeaderRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2196F3' } };\n  summaryHeaderRow.eachCell(cell => { cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; });\n\n  const grouped = new Map<string, NormalizedRecord[]>();\n  for (const record of clean) {\n    const key = `${record.countryCode}_${record.indicator}`;\n    if (!grouped.has(key)) grouped.set(key, []);\n    grouped.get(key)!.push(record);\n  }\n\n  let dataRowStart = sheet.rowCount + 1;\n  let rowIndex = 0;\n  \n  for (const [, records] of Array.from(grouped.entries())) {\n    const sorted = records.filter(r => r.value !== null).sort((a, b) => b.date.localeCompare(a.date));\n    if (sorted.length === 0) continue;\n\n    const latest = sorted[0];\n    const values = sorted.map(r => r.value as number);\n    const last5 = values.slice(0, Math.min(5, values.length));\n    const prev = sorted.length > 1 ? sorted[1].value : null;\n\n    const currentRow = dataRowStart + rowIndex;\n    const row = sheet.addRow([\n      latest.countryCode,\n      latest.indicator,\n      latest.date.substring(0, 4),\n      latest.value,\n      null,\n      null,\n      Math.min(...values),\n      Math.max(...values)\n    ]);\n\n    const avgCell = row.getCell(5);\n    avgCell.value = { formula: `AVERAGE(D${currentRow})`, result: last5.reduce((a, b) => a + b, 0) / last5.length };\n    \n    if (prev !== null && latest.value !== null) {\n      const yoyCell = row.getCell(6);\n      yoyCell.value = { formula: `(D${currentRow}-${prev})/${prev}*100`, result: ((latest.value - prev) / prev) * 100 };\n      yoyCell.numFmt = '0.00\"%\"';\n    }\n\n    rowIndex++;\n  }\n\n  sheet.getColumn(1).width = 12;\n  sheet.getColumn(2).width = 15;\n  sheet.getColumn(3).width = 12;\n  sheet.getColumn(4).width = 18;\n  sheet.getColumn(4).numFmt = '#,##0.00';\n  sheet.getColumn(5).width = 18;\n  sheet.getColumn(5).numFmt = '#,##0.00';\n  sheet.getColumn(6).width = 12;\n  sheet.getColumn(7).width = 18;\n  sheet.getColumn(7).numFmt = '#,##0.00';\n  sheet.getColumn(8).width = 18;\n  sheet.getColumn(8).numFmt = '#,##0.00';\n}\n\nfunction buildDashboardSheet(workbook: ExcelJS.Workbook, dashboard: WorkbookSheets['dashboard'], clean: NormalizedRecord[]): void {\n  const sheet = workbook.addWorksheet('05_DASHBOARD');\n  \n  sheet.addRow(['DATA DASHBOARD']);\n  sheet.addRow(['Chart-ready data - Select data and Insert > Column Chart in Excel']);\n  sheet.addRow([]);\n\n  sheet.addRow(['COUNTRY SUMMARY']);\n  const countryHeaders = ['Country', 'Total_Records', 'Indicators_Available', 'Date_Range'];\n  const countryHeaderRow = sheet.addRow(countryHeaders);\n  countryHeaderRow.font = { bold: true };\n  countryHeaderRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00BCD4' } };\n  countryHeaderRow.eachCell(cell => { cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; });\n\n  const byCountry = new Map<string, NormalizedRecord[]>();\n  for (const r of clean) {\n    if (!byCountry.has(r.countryCode)) byCountry.set(r.countryCode, []);\n    byCountry.get(r.countryCode)!.push(r);\n  }\n\n  for (const [country, records] of Array.from(byCountry.entries())) {\n    const indicators = new Set(records.map(r => r.indicator)).size;\n    const dates = records.map(r => r.date).sort();\n    sheet.addRow([country, records.length, indicators, dates.length > 0 ? `${dates[0]} to ${dates[dates.length - 1]}` : 'N/A']);\n  }\n\n  sheet.addRow([]);\n  sheet.addRow([]);\n\n  sheet.addRow(['INDICATOR SUMMARY']);\n  const indHeaders = ['Indicator', 'Countries_With_Data', 'Total_Records', 'Avg_Value', 'Latest_Year'];\n  const indHeaderRow = sheet.addRow(indHeaders);\n  indHeaderRow.font = { bold: true };\n  indHeaderRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF5722' } };\n  indHeaderRow.eachCell(cell => { cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; });\n\n  const byIndicator = new Map<string, NormalizedRecord[]>();\n  for (const r of clean) {\n    if (!byIndicator.has(r.indicator)) byIndicator.set(r.indicator, []);\n    byIndicator.get(r.indicator)!.push(r);\n  }\n\n  for (const [indicator, records] of Array.from(byIndicator.entries())) {\n    const countries = new Set(records.map(r => r.countryCode)).size;\n    const values = records.filter(r => r.value !== null).map(r => r.value as number);\n    const avg = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;\n    const latestYear = records.map(r => r.date).sort().pop()?.substring(0, 4) || 'N/A';\n    sheet.addRow([indicator, countries, records.length, avg, latestYear]);\n  }\n\n  sheet.getColumn(1).width = 20;\n  sheet.getColumn(2).width = 20;\n  sheet.getColumn(3).width = 15;\n  sheet.getColumn(4).width = 35;\n  sheet.getColumn(5).width = 15;\n}\n\nfunction buildAuditSheet(workbook: ExcelJS.Workbook, audit: WorkbookSheets['audit']): void {\n  const sheet = workbook.addWorksheet('06_AUDIT');\n  \n  sheet.addRow(['AUDIT RESULTS']);\n  sheet.addRow(['Generated:', audit.timestamp]);\n  sheet.addRow(['Overall Result:', audit.overallResult]);\n  sheet.addRow([]);\n\n  const summaryRow = sheet.addRow(['Summary:', `${audit.passed} PASS, ${audit.failed} FAIL, ${audit.warnings} WARN out of ${audit.totalTests} tests`]);\n  if (audit.overallResult === 'FAIL') {\n    summaryRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } };\n    summaryRow.getCell(2).font = { bold: true, color: { argb: 'FFFFFFFF' } };\n  } else {\n    summaryRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00FF00' } };\n    summaryRow.getCell(2).font = { bold: true };\n  }\n\n  sheet.addRow([]);\n  sheet.addRow(['TEST DETAILS']);\n  \n  const headers = ['Test_Name', 'Category', 'Result', 'Details', 'Value', 'Threshold'];\n  const headerRow = sheet.addRow(headers);\n  headerRow.font = { bold: true };\n  headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF607D8B' } };\n  headerRow.eachCell(cell => { cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; });\n\n  for (const test of audit.tests) {\n    const row = sheet.addRow([test.name, test.category, test.result, test.details, test.value ?? 'N/A', test.threshold ?? 'N/A']);\n    const resultCell = row.getCell(3);\n    if (test.result === 'PASS') {\n      resultCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00FF00' } };\n    } else if (test.result === 'FAIL') {\n      resultCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } };\n      resultCell.font = { color: { argb: 'FFFFFFFF' } };\n    } else {\n      resultCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };\n    }\n  }\n\n  sheet.getColumn(1).width = 25;\n  sheet.getColumn(2).width = 15;\n  sheet.getColumn(3).width = 10;\n  sheet.getColumn(4).width = 50;\n  sheet.getColumn(5).width = 15;\n  sheet.getColumn(6).width = 15;\n}\n","path":null,"size_bytes":16271,"size_tokens":null},"server/etl/connectors/worldBank.ts":{"content":"import { NormalizedRecord, SourceMetadata, RawDataRecord, DataSourceType } from '../types';\n\nconst WORLD_BANK_API = 'https://api.worldbank.org/v2';\n\nconst INDICATOR_MAPPING: Record<string, string> = {\n  'GDP': 'NY.GDP.MKTP.CD',\n  'GDP_GROWTH': 'NY.GDP.MKTP.KD.ZG',\n  'INFLATION': 'FP.CPI.TOTL.ZG',\n  'UNEMPLOYMENT': 'SL.UEM.TOTL.ZS',\n  'POPULATION': 'SP.POP.TOTL',\n  'EXPORTS': 'NE.EXP.GNFS.CD',\n  'IMPORTS': 'NE.IMP.GNFS.CD',\n  'FDI': 'BX.KLT.DINV.CD.WD'\n};\n\nconst UNIT_MAPPING: Record<string, string> = {\n  'NY.GDP.MKTP.CD': 'current USD',\n  'NY.GDP.MKTP.KD.ZG': 'percent',\n  'FP.CPI.TOTL.ZG': 'percent',\n  'SL.UEM.TOTL.ZS': 'percent',\n  'SP.POP.TOTL': 'persons',\n  'NE.EXP.GNFS.CD': 'current USD',\n  'NE.IMP.GNFS.CD': 'current USD',\n  'BX.KLT.DINV.CD.WD': 'current USD'\n};\n\nexport async function fetchWorldBankData(\n  countryCode: string,\n  indicatorId: string,\n  startYear: string,\n  endYear: string\n): Promise<{ raw: RawDataRecord; normalized: NormalizedRecord[] }> {\n  const wbIndicator = INDICATOR_MAPPING[indicatorId];\n  if (!wbIndicator) {\n    throw new Error(`Unknown indicator: ${indicatorId}`);\n  }\n\n  const startYearNum = parseInt(startYear.split('-')[0]);\n  const endYearNum = parseInt(endYear.split('-')[0]);\n  \n  const url = `${WORLD_BANK_API}/country/${countryCode}/indicator/${wbIndicator}?format=json&date=${startYearNum}:${endYearNum}&per_page=1000`;\n  \n  const response = await fetch(url);\n  if (!response.ok) {\n    throw new Error(`World Bank API error: ${response.status}`);\n  }\n\n  const data = await response.json();\n  const timestamp = new Date().toISOString();\n  const sourceId = `WB_${countryCode}_${indicatorId}_${timestamp.split('T')[0]}`;\n\n  const metadata: SourceMetadata = {\n    sourceId,\n    provider: 'world_bank' as DataSourceType,\n    url,\n    method: 'API',\n    timestamp,\n    indicator: indicatorId,\n    country: countryCode,\n    unit: UNIT_MAPPING[wbIndicator] || 'unknown',\n    frequency: 'A',\n    notes: `World Bank V2 API - Indicator ${wbIndicator}`\n  };\n\n  const rawRecord: RawDataRecord = {\n    sourceId,\n    rawData: data,\n    metadata\n  };\n\n  const normalized: NormalizedRecord[] = [];\n  \n  if (Array.isArray(data) && data.length >= 2 && Array.isArray(data[1])) {\n    for (const item of data[1]) {\n      if (item.value !== null && item.value !== undefined) {\n        normalized.push({\n          date: `${item.date}-01`,\n          country: item.country?.value || countryCode,\n          countryCode: item.countryiso3code || countryCode,\n          indicator: indicatorId,\n          indicatorCode: wbIndicator,\n          value: parseFloat(item.value),\n          unit: UNIT_MAPPING[wbIndicator] || 'unknown',\n          frequency: 'A',\n          sourceId\n        });\n      }\n    }\n  }\n\n  return { raw: rawRecord, normalized };\n}\n\nexport function getAvailableIndicators(): string[] {\n  return Object.keys(INDICATOR_MAPPING);\n}\n\nexport function mapIndicatorToWorldBank(indicatorId: string): string | null {\n  return INDICATOR_MAPPING[indicatorId] || null;\n}\n","path":null,"size_bytes":2996,"size_tokens":null},"server/etl/types.ts":{"content":"export interface ETLSpec {\n  countries: string[];\n  indicators: IndicatorSpec[];\n  dateRange: {\n    start: string;\n    end: string;\n  };\n}\n\nexport interface IndicatorSpec {\n  id: string;\n  name: string;\n  category: string;\n  preferredSources: DataSourceType[];\n  unit?: string;\n  frequency: 'monthly' | 'quarterly' | 'annual';\n}\n\nexport type DataSourceType = 'world_bank' | 'imf' | 'fred' | 'oecd' | 'un' | 'eurostat' | 'bis' | 'ecb';\n\nexport interface NormalizedRecord {\n  date: string;\n  country: string;\n  countryCode: string;\n  indicator: string;\n  indicatorCode: string;\n  value: number | null;\n  unit: string;\n  frequency: 'M' | 'Q' | 'A';\n  sourceId: string;\n}\n\nexport interface SourceMetadata {\n  sourceId: string;\n  provider: DataSourceType;\n  url: string;\n  method: 'API' | 'CSV' | 'XLSX' | 'SCRAPE';\n  timestamp: string;\n  indicator: string;\n  country: string;\n  unit: string;\n  frequency: string;\n  notes: string;\n  rawFile?: string;\n}\n\nexport interface RawDataRecord {\n  sourceId: string;\n  rawData: any;\n  metadata: SourceMetadata;\n}\n\nexport interface AuditTest {\n  name: string;\n  description: string;\n  category: 'coverage' | 'duplicates' | 'units' | 'reconciliation' | 'extremes' | 'completeness';\n  result: 'PASS' | 'FAIL' | 'WARN';\n  details: string;\n  value?: number;\n  threshold?: number;\n}\n\nexport interface AuditResults {\n  timestamp: string;\n  totalTests: number;\n  passed: number;\n  failed: number;\n  warnings: number;\n  tests: AuditTest[];\n  overallResult: 'PASS' | 'FAIL';\n}\n\nexport interface WorkbookSheets {\n  readme: ReadmeSheet;\n  sources: SourceMetadata[];\n  raw: RawDataRecord[];\n  clean: NormalizedRecord[];\n  model: ModelMetrics;\n  dashboard: DashboardConfig;\n  audit: AuditResults;\n}\n\nexport interface ReadmeSheet {\n  title: string;\n  description: string;\n  generatedAt: string;\n  spec: ETLSpec;\n  methodology: string;\n  contacts: string;\n}\n\nexport interface ModelMetrics {\n  metrics: MetricDefinition[];\n  data: MetricValue[];\n}\n\nexport interface MetricDefinition {\n  id: string;\n  name: string;\n  formula: string;\n  description: string;\n}\n\nexport interface MetricValue {\n  date: string;\n  country: string;\n  metricId: string;\n  value: number | null;\n  formulaRef?: string;\n}\n\nexport interface DashboardConfig {\n  charts: ChartConfig[];\n  filters: FilterConfig[];\n  tables: TableConfig[];\n}\n\nexport interface ChartConfig {\n  id: string;\n  type: 'bar' | 'line' | 'area' | 'pie';\n  title: string;\n  dataRange: string;\n  xAxis: string;\n  yAxis: string;\n  series: string[];\n}\n\nexport interface FilterConfig {\n  id: string;\n  field: string;\n  label: string;\n  type: 'dropdown' | 'slicer';\n}\n\nexport interface TableConfig {\n  id: string;\n  title: string;\n  columns: string[];\n  dataRange: string;\n}\n\nexport const COUNTRY_CODES: Record<string, string> = {\n  'Argentina': 'ARG',\n  'Bolivia': 'BOL',\n  'Brazil': 'BRA',\n  'Chile': 'CHL',\n  'Colombia': 'COL',\n  'Costa Rica': 'CRI',\n  'Cuba': 'CUB',\n  'Dominican Republic': 'DOM',\n  'Ecuador': 'ECU',\n  'El Salvador': 'SLV',\n  'Guatemala': 'GTM',\n  'Haiti': 'HTI',\n  'Honduras': 'HND',\n  'Mexico': 'MEX',\n  'Nicaragua': 'NIC',\n  'Panama': 'PAN',\n  'Paraguay': 'PRY',\n  'Peru': 'PER',\n  'Puerto Rico': 'PRI',\n  'Uruguay': 'URY',\n  'Venezuela': 'VEN',\n  'United States': 'USA',\n  'Canada': 'CAN',\n  'United Kingdom': 'GBR',\n  'Germany': 'DEU',\n  'France': 'FRA',\n  'Italy': 'ITA',\n  'Spain': 'ESP',\n  'Japan': 'JPN',\n  'China': 'CHN',\n  'India': 'IND',\n  'Australia': 'AUS',\n  'South Korea': 'KOR',\n  'Russia': 'RUS',\n  'South Africa': 'ZAF',\n};\n\nexport const DEFAULT_INDICATORS: IndicatorSpec[] = [\n  {\n    id: 'GDP',\n    name: 'Gross Domestic Product',\n    category: 'Economy',\n    preferredSources: ['world_bank', 'imf'],\n    unit: 'current USD',\n    frequency: 'annual'\n  },\n  {\n    id: 'GDP_GROWTH',\n    name: 'GDP Growth Rate',\n    category: 'Economy',\n    preferredSources: ['world_bank', 'imf'],\n    unit: 'percent',\n    frequency: 'annual'\n  },\n  {\n    id: 'INFLATION',\n    name: 'Inflation Rate (CPI)',\n    category: 'Economy',\n    preferredSources: ['imf', 'world_bank'],\n    unit: 'percent',\n    frequency: 'annual'\n  },\n  {\n    id: 'UNEMPLOYMENT',\n    name: 'Unemployment Rate',\n    category: 'Labor',\n    preferredSources: ['world_bank', 'oecd'],\n    unit: 'percent',\n    frequency: 'annual'\n  },\n  {\n    id: 'POPULATION',\n    name: 'Total Population',\n    category: 'Demographics',\n    preferredSources: ['world_bank', 'un'],\n    unit: 'persons',\n    frequency: 'annual'\n  },\n  {\n    id: 'EXPORTS',\n    name: 'Exports of Goods and Services',\n    category: 'Trade',\n    preferredSources: ['world_bank', 'imf'],\n    unit: 'current USD',\n    frequency: 'annual'\n  },\n  {\n    id: 'IMPORTS',\n    name: 'Imports of Goods and Services',\n    category: 'Trade',\n    preferredSources: ['world_bank', 'imf'],\n    unit: 'current USD',\n    frequency: 'annual'\n  },\n  {\n    id: 'FDI',\n    name: 'Foreign Direct Investment',\n    category: 'Investment',\n    preferredSources: ['world_bank', 'oecd'],\n    unit: 'current USD',\n    frequency: 'annual'\n  }\n];\n\nexport function getLastCompleteMonth(): string {\n  const now = new Date();\n  now.setMonth(now.getMonth() - 1);\n  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\n}\n\nexport function createDefaultSpec(countries: string[]): ETLSpec {\n  return {\n    countries,\n    indicators: DEFAULT_INDICATORS,\n    dateRange: {\n      start: '2000-01',\n      end: getLastCompleteMonth()\n    }\n  };\n}\n","path":null,"size_bytes":5440,"size_tokens":null},"server/etl/connectors/fred.ts":{"content":"import { NormalizedRecord, SourceMetadata, RawDataRecord, DataSourceType } from '../types';\n\nconst FRED_API = 'https://api.stlouisfed.org/fred';\n\nconst INDICATOR_MAPPING: Record<string, string> = {\n  'GDP': 'GDP',\n  'GDP_GROWTH': 'A191RL1Q225SBEA',\n  'INFLATION': 'CPIAUCSL',\n  'UNEMPLOYMENT': 'UNRATE',\n  'POPULATION': 'POPTHM',\n  'EXPORTS': 'EXPGS',\n  'IMPORTS': 'IMPGS',\n  'FDI': 'ROWFDIQ027S'\n};\n\nconst UNIT_MAPPING: Record<string, string> = {\n  'GDP': 'billions USD',\n  'A191RL1Q225SBEA': 'percent',\n  'CPIAUCSL': 'index 1982-84=100',\n  'UNRATE': 'percent',\n  'POPTHM': 'thousands',\n  'EXPGS': 'billions USD',\n  'IMPGS': 'billions USD',\n  'ROWFDIQ027S': 'millions USD'\n};\n\nconst FREQUENCY_MAPPING: Record<string, 'M' | 'Q' | 'A'> = {\n  'GDP': 'Q',\n  'A191RL1Q225SBEA': 'Q',\n  'CPIAUCSL': 'M',\n  'UNRATE': 'M',\n  'POPTHM': 'M',\n  'EXPGS': 'Q',\n  'IMPGS': 'Q',\n  'ROWFDIQ027S': 'Q'\n};\n\nexport async function fetchFredData(\n  indicatorId: string,\n  startDate: string,\n  endDate: string,\n  apiKey?: string\n): Promise<{ raw: RawDataRecord; normalized: NormalizedRecord[] } | null> {\n  const fredSeriesId = INDICATOR_MAPPING[indicatorId];\n  if (!fredSeriesId) {\n    console.log(`[FRED] Unknown indicator: ${indicatorId}`);\n    return null;\n  }\n\n  const key = apiKey || process.env.FRED_API_KEY;\n  if (!key) {\n    console.log('[FRED] No API key available, skipping FRED data source');\n    return null;\n  }\n\n  const url = `${FRED_API}/series/observations?series_id=${fredSeriesId}&api_key=${key}&file_type=json&observation_start=${startDate}&observation_end=${endDate}`;\n  \n  try {\n    const response = await fetch(url);\n    if (!response.ok) {\n      console.error(`[FRED] API error: ${response.status}`);\n      return null;\n    }\n\n    const data = await response.json();\n    const timestamp = new Date().toISOString();\n    const sourceId = `FRED_USA_${indicatorId}_${timestamp.split('T')[0]}`;\n\n    const metadata: SourceMetadata = {\n      sourceId,\n      provider: 'fred' as DataSourceType,\n      url: url.replace(key, '[REDACTED]'),\n      method: 'API',\n      timestamp,\n      indicator: indicatorId,\n      country: 'USA',\n      unit: UNIT_MAPPING[fredSeriesId] || 'unknown',\n      frequency: FREQUENCY_MAPPING[fredSeriesId] || 'A',\n      notes: `FRED API - Series ${fredSeriesId}`\n    };\n\n    const rawRecord: RawDataRecord = {\n      sourceId,\n      rawData: data,\n      metadata\n    };\n\n    const normalized: NormalizedRecord[] = [];\n    \n    if (data.observations && Array.isArray(data.observations)) {\n      for (const obs of data.observations) {\n        if (obs.value !== '.' && obs.value !== null && obs.value !== undefined) {\n          const value = parseFloat(obs.value);\n          if (!isNaN(value)) {\n            normalized.push({\n              date: obs.date,\n              country: 'United States',\n              countryCode: 'USA',\n              indicator: indicatorId,\n              indicatorCode: fredSeriesId,\n              value,\n              unit: UNIT_MAPPING[fredSeriesId] || 'unknown',\n              frequency: FREQUENCY_MAPPING[fredSeriesId] || 'A',\n              sourceId\n            });\n          }\n        }\n      }\n    }\n\n    console.log(`[FRED] Fetched ${normalized.length} records for ${indicatorId}`);\n    \n    return { raw: rawRecord, normalized };\n  } catch (error) {\n    console.error('[FRED] Fetch error:', error);\n    return null;\n  }\n}\n\nexport function getAvailableIndicators(): string[] {\n  return Object.keys(INDICATOR_MAPPING);\n}\n","path":null,"size_bytes":3469,"size_tokens":null},"server/etl/pipeline.ts":{"content":"import { \n  ETLSpec, \n  NormalizedRecord, \n  RawDataRecord, \n  SourceMetadata,\n  AuditResults,\n  AuditTest,\n  WorkbookSheets,\n  ReadmeSheet,\n  ModelMetrics,\n  DashboardConfig,\n  COUNTRY_CODES\n} from './types';\nimport { fetchDataForIndicator } from './connectors';\n\nexport interface ETLPipelineResult {\n  success: boolean;\n  workbook: WorkbookSheets | null;\n  errors: string[];\n  summary: {\n    totalRecords: number;\n    countriesFetched: number;\n    indicatorsFetched: number;\n    sourcesUsed: number;\n  };\n}\n\nexport async function runETLPipeline(spec: ETLSpec): Promise<ETLPipelineResult> {\n  const allRaw: RawDataRecord[] = [];\n  const allNormalized: NormalizedRecord[] = [];\n  const allSources: SourceMetadata[] = [];\n  const errors: string[] = [];\n\n  const countriesProcessed = new Set<string>();\n  const indicatorsProcessed = new Set<string>();\n\n  for (const country of spec.countries) {\n    const countryCode = COUNTRY_CODES[country];\n    if (!countryCode) {\n      errors.push(`Unknown country: ${country}`);\n      continue;\n    }\n\n    for (const indicator of spec.indicators) {\n      try {\n        const result = await fetchDataForIndicator(\n          countryCode,\n          indicator.id,\n          spec.dateRange.start,\n          spec.dateRange.end,\n          indicator.preferredSources\n        );\n\n        if (result.normalized.length > 0) {\n          allRaw.push(...result.raw);\n          allNormalized.push(...result.normalized);\n          result.raw.forEach(r => allSources.push(r.metadata));\n          countriesProcessed.add(country);\n          indicatorsProcessed.add(indicator.id);\n        }\n\n        if (result.errors.length > 0) {\n          errors.push(...result.errors);\n        }\n\n        await new Promise(resolve => setTimeout(resolve, 100));\n      } catch (error) {\n        const errorMsg = `Pipeline error for ${country}/${indicator.id}: ${error instanceof Error ? error.message : 'Unknown'}`;\n        console.error(`[ETL] ${errorMsg}`);\n        errors.push(errorMsg);\n      }\n    }\n  }\n\n  console.log(`[ETL] Fetched ${allNormalized.length} total records`);\n\n  const cleanData = deduplicateAndClean(allNormalized);\n\n  const modelMetrics = calculateModelMetrics(cleanData, spec);\n\n  const dashboardConfig = createDashboardConfig(cleanData, spec);\n\n  const auditResults = runAuditTests(spec, allRaw, cleanData, allNormalized);\n  console.log(`[ETL] Audit complete: ${auditResults.overallResult}`);\n\n  const readme = createReadme(spec, auditResults);\n\n  const workbook: WorkbookSheets = {\n    readme,\n    sources: allSources,\n    raw: allRaw,\n    clean: cleanData,\n    model: modelMetrics,\n    dashboard: dashboardConfig,\n    audit: auditResults\n  };\n\n  const success = auditResults.overallResult === 'PASS';\n\n  return {\n    success,\n    workbook,\n    errors,\n    summary: {\n      totalRecords: cleanData.length,\n      countriesFetched: countriesProcessed.size,\n      indicatorsFetched: indicatorsProcessed.size,\n      sourcesUsed: allSources.length\n    }\n  };\n}\n\nfunction deduplicateAndClean(records: NormalizedRecord[]): NormalizedRecord[] {\n  const seen = new Map<string, NormalizedRecord>();\n  \n  for (const record of records) {\n    const key = `${record.date}_${record.countryCode}_${record.indicator}`;\n    const existing = seen.get(key);\n    \n    if (!existing || (record.value !== null && existing.value === null)) {\n      seen.set(key, record);\n    }\n  }\n  \n  return Array.from(seen.values()).sort((a, b) => {\n    if (a.countryCode !== b.countryCode) return a.countryCode.localeCompare(b.countryCode);\n    if (a.indicator !== b.indicator) return a.indicator.localeCompare(b.indicator);\n    return a.date.localeCompare(b.date);\n  });\n}\n\nfunction calculateModelMetrics(data: NormalizedRecord[], spec: ETLSpec): ModelMetrics {\n  const metrics: ModelMetrics = {\n    metrics: [\n      { id: 'YOY_GROWTH', name: 'Year-over-Year Growth', formula: '=(CurrentYear-PreviousYear)/PreviousYear*100', description: 'Percentage change from previous year' },\n      { id: 'AVG_5Y', name: '5-Year Rolling Average', formula: '=AVERAGE(OFFSET(cell,-4,0,5,1))', description: 'Rolling average of last 5 years' },\n      { id: 'DEVIATION', name: 'Deviation from Mean', formula: '=(Value-AVERAGE(Range))/STDEV(Range)', description: 'Standard deviations from mean' },\n      { id: 'RANK', name: 'Country Rank', formula: '=RANK(Value,Range,0)', description: 'Rank among countries for given year' }\n    ],\n    data: []\n  };\n\n  const byCountryIndicator = new Map<string, NormalizedRecord[]>();\n  for (const record of data) {\n    const key = `${record.countryCode}_${record.indicator}`;\n    if (!byCountryIndicator.has(key)) {\n      byCountryIndicator.set(key, []);\n    }\n    byCountryIndicator.get(key)!.push(record);\n  }\n\n  for (const entry of Array.from(byCountryIndicator.entries())) {\n    const [key, records] = entry;\n    records.sort((a: NormalizedRecord, b: NormalizedRecord) => a.date.localeCompare(b.date));\n    \n    for (let i = 1; i < records.length; i++) {\n      const current = records[i];\n      const previous = records[i - 1];\n      \n      if (current.value !== null && previous.value !== null && previous.value !== 0) {\n        const yoyGrowth = ((current.value - previous.value) / previous.value) * 100;\n        metrics.data.push({\n          date: current.date,\n          country: current.countryCode,\n          metricId: 'YOY_GROWTH',\n          value: Math.round(yoyGrowth * 100) / 100,\n          formulaRef: `=(${current.value}-${previous.value})/${previous.value}*100`\n        });\n      }\n    }\n  }\n\n  return metrics;\n}\n\nfunction createDashboardConfig(data: NormalizedRecord[], spec: ETLSpec): DashboardConfig {\n  const countries = Array.from(new Set(data.map(r => r.countryCode)));\n  const indicators = Array.from(new Set(data.map(r => r.indicator)));\n\n  return {\n    charts: indicators.map((ind, i) => ({\n      id: `chart_${i}`,\n      type: 'line' as const,\n      title: ind,\n      dataRange: `CLEAN!A:G`,\n      xAxis: 'Date',\n      yAxis: 'Value',\n      series: countries\n    })),\n    filters: [\n      { id: 'filter_country', field: 'Country', label: 'Filter by Country', type: 'dropdown' },\n      { id: 'filter_indicator', field: 'Indicator', label: 'Filter by Indicator', type: 'dropdown' }\n    ],\n    tables: [\n      { id: 'summary_table', title: 'Data Summary', columns: ['Country', 'Indicator', 'Latest Value', 'YoY Change'], dataRange: 'MODEL!A:D' }\n    ]\n  };\n}\n\nfunction runAuditTests(\n  spec: ETLSpec,\n  raw: RawDataRecord[],\n  clean: NormalizedRecord[],\n  normalized: NormalizedRecord[]\n): AuditResults {\n  const tests: AuditTest[] = [];\n\n  const expectedCountries = spec.countries.length;\n  const actualCountries = new Set(clean.map(r => r.countryCode)).size;\n  const coverageRatio = actualCountries / expectedCountries;\n  tests.push({\n    name: 'Country Coverage',\n    description: 'Percentage of requested countries with data',\n    category: 'coverage',\n    result: coverageRatio >= 0.8 ? 'PASS' : coverageRatio >= 0.5 ? 'WARN' : 'FAIL',\n    details: `${actualCountries}/${expectedCountries} countries (${Math.round(coverageRatio * 100)}%)`,\n    value: coverageRatio * 100,\n    threshold: 80\n  });\n\n  const expectedIndicators = spec.indicators.length;\n  const actualIndicators = new Set(clean.map(r => r.indicator)).size;\n  const indicatorCoverage = actualIndicators / expectedIndicators;\n  tests.push({\n    name: 'Indicator Coverage',\n    description: 'Percentage of requested indicators with data',\n    category: 'coverage',\n    result: indicatorCoverage >= 0.8 ? 'PASS' : indicatorCoverage >= 0.5 ? 'WARN' : 'FAIL',\n    details: `${actualIndicators}/${expectedIndicators} indicators (${Math.round(indicatorCoverage * 100)}%)`,\n    value: indicatorCoverage * 100,\n    threshold: 80\n  });\n\n  const duplicateCheck = new Set<string>();\n  let duplicates = 0;\n  for (const record of clean) {\n    const key = `${record.date}_${record.countryCode}_${record.indicator}`;\n    if (duplicateCheck.has(key)) {\n      duplicates++;\n    }\n    duplicateCheck.add(key);\n  }\n  tests.push({\n    name: 'No Duplicates',\n    description: 'No duplicate records in clean data',\n    category: 'duplicates',\n    result: duplicates === 0 ? 'PASS' : 'FAIL',\n    details: duplicates === 0 ? 'No duplicates found' : `${duplicates} duplicates found`,\n    value: duplicates,\n    threshold: 0\n  });\n\n  const unitCheck = new Map<string, Set<string>>();\n  for (const record of clean) {\n    if (!unitCheck.has(record.indicator)) {\n      unitCheck.set(record.indicator, new Set());\n    }\n    unitCheck.get(record.indicator)!.add(record.unit);\n  }\n  const inconsistentUnits = Array.from(unitCheck.entries()).filter(([, units]) => units.size > 1);\n  tests.push({\n    name: 'Unit Consistency',\n    description: 'Each indicator uses consistent units',\n    category: 'units',\n    result: inconsistentUnits.length === 0 ? 'PASS' : 'WARN',\n    details: inconsistentUnits.length === 0 \n      ? 'All units consistent' \n      : `Inconsistent units for: ${inconsistentUnits.map(([ind]) => ind).join(', ')}`,\n    value: inconsistentUnits.length,\n    threshold: 0\n  });\n\n  const rawCount = normalized.length;\n  const cleanCount = clean.length;\n  const reconciled = cleanCount <= rawCount && cleanCount >= rawCount * 0.5;\n  tests.push({\n    name: 'RAW Reconciliation',\n    description: 'Clean data reconciles with raw data',\n    category: 'reconciliation',\n    result: reconciled ? 'PASS' : 'WARN',\n    details: `Raw: ${rawCount}, Clean: ${cleanCount} (${Math.round(cleanCount/rawCount*100)}%)`,\n    value: cleanCount,\n    threshold: rawCount * 0.5\n  });\n\n  const values = clean.filter(r => r.value !== null).map(r => r.value as number);\n  if (values.length > 0) {\n    const mean = values.reduce((a, b) => a + b, 0) / values.length;\n    const stdDev = Math.sqrt(values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length);\n    const extremes = values.filter(v => Math.abs(v - mean) > 3 * stdDev).length;\n    tests.push({\n      name: 'Extreme Values',\n      description: 'Check for statistical outliers (>3 std dev)',\n      category: 'extremes',\n      result: extremes < values.length * 0.05 ? 'PASS' : 'WARN',\n      details: `${extremes} extreme values out of ${values.length} (${Math.round(extremes/values.length*100)}%)`,\n      value: extremes,\n      threshold: values.length * 0.05\n    });\n  }\n\n  const now = new Date();\n  const lastCompleteMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n  const lastMonthStr = `${lastCompleteMonth.getFullYear()}-${String(lastCompleteMonth.getMonth() + 1).padStart(2, '0')}`;\n  const hasRecentData = clean.some(r => r.date >= lastMonthStr || r.date.startsWith(lastMonthStr.substring(0, 4)));\n  tests.push({\n    name: 'Data Freshness',\n    description: 'Data includes recent observations',\n    category: 'completeness',\n    result: hasRecentData ? 'PASS' : 'WARN',\n    details: hasRecentData ? `Data available up to ${lastMonthStr} or later` : 'No recent data found',\n    value: hasRecentData ? 1 : 0,\n    threshold: 1\n  });\n\n  const passed = tests.filter(t => t.result === 'PASS').length;\n  const failed = tests.filter(t => t.result === 'FAIL').length;\n  const warnings = tests.filter(t => t.result === 'WARN').length;\n\n  return {\n    timestamp: new Date().toISOString(),\n    totalTests: tests.length,\n    passed,\n    failed,\n    warnings,\n    tests,\n    overallResult: failed === 0 ? 'PASS' : 'FAIL'\n  };\n}\n\nfunction createReadme(spec: ETLSpec, audit: AuditResults): ReadmeSheet {\n  return {\n    title: 'ETL Data Workbook',\n    description: `Automated data extraction from official multilateral sources for ${spec.countries.length} countries and ${spec.indicators.length} indicators.`,\n    generatedAt: new Date().toISOString(),\n    spec,\n    methodology: `Data extracted via APIs from World Bank, IMF, FRED, and other official sources. \nAll data normalized to standard schema (Date, Country, Indicator, Value, Unit, Frequency, Source_ID).\nQuality checks performed: ${audit.totalTests} tests with ${audit.passed} passed, ${audit.failed} failed, ${audit.warnings} warnings.`,\n    contacts: 'Generated by Sira GPT ETL Agent'\n  };\n}\n","path":null,"size_bytes":12080,"size_tokens":null},"server/etl/index.ts":{"content":"export * from './types';\nexport * from './pipeline';\nexport * from './excelBuilder';\n\nimport { ETLSpec, createDefaultSpec, DEFAULT_INDICATORS, COUNTRY_CODES } from './types';\nimport { runETLPipeline, ETLPipelineResult } from './pipeline';\nimport { buildExcelWorkbookBundle } from './excelBuilder';\n\nexport interface ETLAgentRequest {\n  countries: string[];\n  indicators?: string[];\n  startDate?: string;\n  endDate?: string;\n}\n\nexport interface ETLAgentResponse {\n  success: boolean;\n  message: string;\n  workbookBuffer?: Buffer;\n  filename?: string;\n  summary?: {\n    totalRecords: number;\n    countriesFetched: number;\n    indicatorsFetched: number;\n    sourcesUsed: number;\n    auditResult: 'PASS' | 'FAIL';\n  };\n  errors?: string[];\n}\n\nexport async function runETLAgent(request: ETLAgentRequest): Promise<ETLAgentResponse> {\n  if (!request.countries || request.countries.length === 0) {\n    return {\n      success: false,\n      message: 'No countries specified',\n      errors: ['At least one country is required']\n    };\n  }\n\n  const validCountries = request.countries.filter(c => COUNTRY_CODES[c]);\n  if (validCountries.length === 0) {\n    return {\n      success: false,\n      message: 'No valid countries found',\n      errors: [`Invalid countries: ${request.countries.join(', ')}. Valid countries: ${Object.keys(COUNTRY_CODES).join(', ')}`]\n    };\n  }\n\n  let spec: ETLSpec;\n  \n  if (request.indicators && request.indicators.length > 0) {\n    const validIndicators = DEFAULT_INDICATORS.filter(ind => \n      request.indicators!.includes(ind.id) || request.indicators!.includes(ind.name)\n    );\n    \n    spec = {\n      countries: validCountries,\n      indicators: validIndicators.length > 0 ? validIndicators : DEFAULT_INDICATORS,\n      dateRange: {\n        start: request.startDate || '2000-01',\n        end: request.endDate || getLastCompleteMonth()\n      }\n    };\n  } else {\n    spec = createDefaultSpec(validCountries);\n    if (request.startDate) spec.dateRange.start = request.startDate;\n    if (request.endDate) spec.dateRange.end = request.endDate;\n  }\n\n  try {\n    const result: ETLPipelineResult = await runETLPipeline(spec);\n\n    if (!result.workbook) {\n      return {\n        success: false,\n        message: 'ETL pipeline failed to generate workbook',\n        errors: result.errors\n      };\n    }\n\n    const workbookBuffer = await buildExcelWorkbookBundle(result.workbook);\n    const timestamp = new Date().toISOString().split('T')[0];\n    const filename = `ETL_Data_${validCountries.join('_')}_${timestamp}.zip`;\n\n    return {\n      success: result.success,\n      message: result.success \n        ? `ETL completed successfully. Generated workbook with ${result.summary.totalRecords} records from ${result.summary.sourcesUsed} sources.`\n        : `ETL completed with audit failures. ${result.errors.length} errors encountered.`,\n      workbookBuffer,\n      filename,\n      summary: {\n        totalRecords: result.summary.totalRecords,\n        countriesFetched: result.summary.countriesFetched,\n        indicatorsFetched: result.summary.indicatorsFetched,\n        sourcesUsed: result.summary.sourcesUsed,\n        auditResult: result.workbook.audit.overallResult\n      },\n      errors: result.errors.length > 0 ? result.errors : undefined\n    };\n  } catch (error) {\n    console.error('[ETL Agent] Pipeline error:', error);\n    return {\n      success: false,\n      message: 'ETL pipeline encountered an error',\n      errors: [error instanceof Error ? error.message : 'Unknown error']\n    };\n  }\n}\n\nfunction getLastCompleteMonth(): string {\n  const now = new Date();\n  now.setMonth(now.getMonth() - 1);\n  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\n}\n\nexport function getAvailableCountries(): string[] {\n  return Object.keys(COUNTRY_CODES);\n}\n\nexport function getAvailableIndicators(): Array<{ id: string; name: string; category: string }> {\n  return DEFAULT_INDICATORS.map(ind => ({\n    id: ind.id,\n    name: ind.name,\n    category: ind.category\n  }));\n}\n","path":null,"size_bytes":4000,"size_tokens":null},"client/src/components/etl-dialog.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Loader2, Download, Database, CheckCircle2, AlertCircle } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ETLDialogProps {\n  open: boolean;\n  onClose: () => void;\n  onComplete?: (summary: string) => void;\n}\n\ninterface Indicator {\n  id: string;\n  name: string;\n  category: string;\n}\n\ninterface ETLConfig {\n  countries: string[];\n  indicators: Indicator[];\n}\n\ntype ETLStatus = \"idle\" | \"loading\" | \"running\" | \"success\" | \"error\";\n\nexport function ETLDialog({ open, onClose, onComplete }: ETLDialogProps) {\n  const [config, setConfig] = useState<ETLConfig | null>(null);\n  const [selectedCountries, setSelectedCountries] = useState<string[]>([]);\n  const [selectedIndicators, setSelectedIndicators] = useState<string[]>([]);\n  const [status, setStatus] = useState<ETLStatus>(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n  const [etlSummary, setEtlSummary] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (open) {\n      setError(null);\n      setEtlSummary(null);\n      setStatus(\"idle\");\n      setSelectedCountries([]);\n      setSelectedIndicators([]);\n      if (!config) {\n        fetchConfig();\n      }\n    }\n  }, [open]);\n\n  const fetchConfig = async () => {\n    setStatus(\"loading\");\n    try {\n      const res = await fetch(\"/api/etl/config\");\n      const data = await res.json();\n      setConfig(data);\n      setStatus(\"idle\");\n    } catch (err: any) {\n      setError(err.message);\n      setStatus(\"error\");\n    }\n  };\n\n  const toggleCountry = (country: string) => {\n    setSelectedCountries(prev =>\n      prev.includes(country)\n        ? prev.filter(c => c !== country)\n        : [...prev, country]\n    );\n  };\n\n  const toggleIndicator = (id: string) => {\n    setSelectedIndicators(prev =>\n      prev.includes(id)\n        ? prev.filter(i => i !== id)\n        : [...prev, id]\n    );\n  };\n\n  const selectAllCountries = () => {\n    if (config) {\n      setSelectedCountries(config.countries);\n    }\n  };\n\n  const selectAllIndicators = () => {\n    if (config) {\n      setSelectedIndicators(config.indicators.map(i => i.id));\n    }\n  };\n\n  const runETL = async () => {\n    if (selectedCountries.length === 0) {\n      setError(\"Please select at least one country\");\n      return;\n    }\n\n    setStatus(\"running\");\n    setError(null);\n\n    try {\n      const res = await fetch(\"/api/etl/run\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          countries: selectedCountries,\n          indicators: selectedIndicators.length > 0 ? selectedIndicators : undefined\n        })\n      });\n\n      if (!res.ok) {\n        const errData = await res.json();\n        throw new Error(errData.error || \"ETL failed\");\n      }\n\n      const blob = await res.blob();\n      const filename = res.headers.get(\"Content-Disposition\")?.split(\"filename=\")[1]?.replace(/\"/g, \"\") || \"ETL_Data.xlsx\";\n      \n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      const summary = `Downloaded economic data for ${selectedCountries.length} countries (${selectedCountries.slice(0, 3).join(\", \")}${selectedCountries.length > 3 ? \"...\" : \"\"}) with ${selectedIndicators.length || \"all\"} indicators. File: ${filename}`;\n      setEtlSummary(summary);\n      \n      if (onComplete) {\n        onComplete(summary);\n      }\n      \n      setStatus(\"success\");\n      setTimeout(() => {\n        onClose();\n      }, 1500);\n    } catch (err: any) {\n      setError(err.message);\n      setStatus(\"error\");\n    }\n  };\n\n  const groupedIndicators = config?.indicators.reduce((acc, ind) => {\n    if (!acc[ind.category]) acc[ind.category] = [];\n    acc[ind.category].push(ind);\n    return acc;\n  }, {} as Record<string, Indicator[]>) || {};\n\n  return (\n    <Dialog open={open} onOpenChange={() => onClose()}>\n      <DialogContent className=\"max-w-3xl max-h-[85vh] flex flex-col\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Database className=\"h-5 w-5\" />\n            ETL Agent - Download Economic Data\n          </DialogTitle>\n        </DialogHeader>\n\n        {status === \"loading\" ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n          </div>\n        ) : status === \"success\" ? (\n          <div className=\"flex flex-col items-center justify-center py-12 gap-4\">\n            <CheckCircle2 className=\"h-16 w-16 text-green-500\" />\n            <p className=\"text-lg font-medium\">Download started!</p>\n          </div>\n        ) : (\n          <div className=\"flex-1 overflow-hidden flex flex-col gap-4\">\n            {error && (\n              <div className=\"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-3 rounded-lg flex items-center gap-2\">\n                <AlertCircle className=\"h-4 w-4 flex-shrink-0\" />\n                <span className=\"text-sm\">{error}</span>\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-2 gap-4 flex-1 overflow-hidden\">\n              <div className=\"flex flex-col\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <h3 className=\"font-medium text-sm\">Countries</h3>\n                  <Button variant=\"ghost\" size=\"sm\" onClick={selectAllCountries} data-testid=\"btn-select-all-countries\">\n                    Select All\n                  </Button>\n                </div>\n                <ScrollArea className=\"flex-1 border rounded-lg p-2\">\n                  <div className=\"grid grid-cols-2 gap-1\">\n                    {config?.countries.map(country => (\n                      <label\n                        key={country}\n                        className={cn(\n                          \"flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-muted text-sm\",\n                          selectedCountries.includes(country) && \"bg-primary/10\"\n                        )}\n                        data-testid={`country-${country.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                      >\n                        <Checkbox\n                          checked={selectedCountries.includes(country)}\n                          onCheckedChange={() => toggleCountry(country)}\n                        />\n                        <span>{country}</span>\n                      </label>\n                    ))}\n                  </div>\n                </ScrollArea>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {selectedCountries.length} selected\n                </p>\n              </div>\n\n              <div className=\"flex flex-col\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <h3 className=\"font-medium text-sm\">Indicators</h3>\n                  <Button variant=\"ghost\" size=\"sm\" onClick={selectAllIndicators} data-testid=\"btn-select-all-indicators\">\n                    Select All\n                  </Button>\n                </div>\n                <ScrollArea className=\"flex-1 border rounded-lg p-2\">\n                  {Object.entries(groupedIndicators).map(([category, indicators]) => (\n                    <div key={category} className=\"mb-3\">\n                      <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-1\">\n                        {category}\n                      </p>\n                      {indicators.map(ind => (\n                        <label\n                          key={ind.id}\n                          className={cn(\n                            \"flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-muted text-sm\",\n                            selectedIndicators.includes(ind.id) && \"bg-primary/10\"\n                          )}\n                          data-testid={`indicator-${ind.id.toLowerCase()}`}\n                        >\n                          <Checkbox\n                            checked={selectedIndicators.includes(ind.id)}\n                            onCheckedChange={() => toggleIndicator(ind.id)}\n                          />\n                          <span>{ind.name}</span>\n                        </label>\n                      ))}\n                    </div>\n                  ))}\n                </ScrollArea>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {selectedIndicators.length} selected (empty = all)\n                </p>\n              </div>\n            </div>\n          </div>\n        )}\n\n        <DialogFooter className=\"mt-4\">\n          <Button variant=\"outline\" onClick={onClose} disabled={status === \"running\"} data-testid=\"btn-cancel-etl\">\n            Cancel\n          </Button>\n          <Button\n            onClick={runETL}\n            disabled={status === \"running\" || selectedCountries.length === 0}\n            data-testid=\"btn-run-etl\"\n          >\n            {status === \"running\" ? (\n              <>\n                <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                Fetching data...\n              </>\n            ) : (\n              <>\n                <Download className=\"h-4 w-4 mr-2\" />\n                Download Excel\n              </>\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":9756,"size_tokens":null},"server/etl/createTemplate.ts":{"content":"import XLSXChart from 'xlsx-chart';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst xlsxChart = new XLSXChart();\n\nconst templatePath = path.join(__dirname, 'templates', 'etl_template_chart.xlsx');\n\n// Create a simple template with a bar chart\nconst opts = {\n  file: templatePath,\n  chart: 'column',\n  titles: ['Country A', 'Country B', 'Country C'],\n  fields: ['GDP', 'Population', 'Inflation'],\n  data: {\n    'Country A': { 'GDP': 1000, 'Population': 50, 'Inflation': 2.5 },\n    'Country B': { 'GDP': 2000, 'Population': 100, 'Inflation': 3.0 },\n    'Country C': { 'GDP': 1500, 'Population': 75, 'Inflation': 1.8 }\n  },\n  chartTitle: 'Economic Indicators by Country'\n};\n\nxlsxChart.writeFile(opts, (err: Error | null) => {\n  if (err) {\n    console.error('Error creating template:', err);\n    process.exit(1);\n  }\n});\n","path":null,"size_bytes":934,"size_tokens":null},"server/etl/xlsx-chart.d.ts":{"content":"declare module 'xlsx-chart' {\n  interface ChartOptions {\n    file?: string;\n    chart: 'column' | 'bar' | 'line' | 'area' | 'radar' | 'scatter' | 'pie';\n    titles: string[];\n    fields: string[];\n    data: Record<string, Record<string, number>>;\n    chartTitle?: string;\n  }\n\n  class XLSXChart {\n    generate(opts: ChartOptions, callback: (err: Error | null, data: Buffer) => void): void;\n    writeFile(opts: ChartOptions, callback: (err: Error | null) => void): void;\n  }\n\n  export = XLSXChart;\n}\n","path":null,"size_bytes":499,"size_tokens":null},"client/src/components/figma-block.tsx":{"content":"import { useState, useRef, useEffect, useMemo, useCallback } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Maximize2, Minimize2, Plus, Minus, ExternalLink, Copy, Check, RotateCcw } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface FigmaNode {\n  id: string;\n  type: \"start\" | \"end\" | \"process\" | \"decision\";\n  label: string;\n  x: number;\n  y: number;\n}\n\ninterface FigmaConnection {\n  from: string;\n  to: string;\n  label?: string;\n}\n\ninterface FigmaDiagram {\n  nodes: FigmaNode[];\n  connections: FigmaConnection[];\n  title?: string;\n}\n\ninterface FigmaBlockProps {\n  diagram: FigmaDiagram;\n  fileUrl?: string;\n}\n\nconst FONT_FAMILY = \"Inter, system-ui, sans-serif\";\nconst FONT_SIZE = 13;\nconst MIN_NODE_WIDTH = 100;\nconst MAX_NODE_WIDTH = 200;\nconst NODE_HEIGHT = 50;\nconst HORIZONTAL_PADDING = 24;\nconst MAX_LABEL_LENGTH = 20;\n\nfunction truncateLabel(label: string, maxLength: number = MAX_LABEL_LENGTH): { text: string; isTruncated: boolean } {\n  if (label.length <= maxLength) return { text: label, isTruncated: false };\n  return { text: label.slice(0, maxLength - 1) + \"…\", isTruncated: true };\n}\n\nfunction estimateTextWidth(text: string, fontSize: number = FONT_SIZE): number {\n  const avgCharWidth = fontSize * 0.55;\n  return text.length * avgCharWidth;\n}\n\nfunction getNodeDimensions(label: string): { width: number; height: number } {\n  const { text } = truncateLabel(label);\n  const textWidth = estimateTextWidth(text);\n  const width = Math.min(MAX_NODE_WIDTH, Math.max(MIN_NODE_WIDTH, textWidth + HORIZONTAL_PADDING));\n  return { width, height: NODE_HEIGHT };\n}\n\nexport function FigmaBlock({ diagram, fileUrl }: FigmaBlockProps) {\n  const [zoom, setZoom] = useState(1);\n  const [isMaximized, setIsMaximized] = useState(false);\n  const [copied, setCopied] = useState(false);\n  const [fontsLoaded, setFontsLoaded] = useState(false);\n  const { toast } = useToast();\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    document.fonts.ready.then(() => setFontsLoaded(true));\n  }, []);\n\n  const nodeDimensions = useMemo(() => {\n    const dims: Record<string, { width: number; height: number }> = {};\n    diagram.nodes.forEach(node => {\n      dims[node.id] = getNodeDimensions(node.label);\n    });\n    return dims;\n  }, [diagram.nodes]);\n\n  const contentBounds = useMemo(() => {\n    const padding = 60;\n    \n    if (diagram.nodes.length === 0) {\n      return { minX: 0, minY: 0, maxX: 400, maxY: 200, width: 400, height: 200 };\n    }\n    \n    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\n    \n    diagram.nodes.forEach(node => {\n      const dims = nodeDimensions[node.id] || { width: MIN_NODE_WIDTH, height: NODE_HEIGHT };\n      minX = Math.min(minX, node.x);\n      minY = Math.min(minY, node.y);\n      maxX = Math.max(maxX, node.x + dims.width);\n      maxY = Math.max(maxY, node.y + dims.height);\n    });\n    \n    return {\n      minX: minX - padding,\n      minY: minY - padding,\n      maxX: maxX + padding,\n      maxY: maxY + padding,\n      width: maxX - minX + padding * 2,\n      height: maxY - minY + padding * 2\n    };\n  }, [diagram.nodes, nodeDimensions]);\n\n  const handleZoomIn = () => setZoom(prev => Math.min(prev + 0.25, 2));\n  const handleZoomOut = () => setZoom(prev => Math.max(prev - 0.25, 0.5));\n  const handleResetZoom = useCallback(() => setZoom(1), []);\n\n  const handleEditInFigma = () => {\n    if (fileUrl) {\n      window.open(fileUrl, '_blank');\n    } else {\n      // Open Figma new file page\n      window.open('https://www.figma.com/files/recents-and-sharing/recently-viewed', '_blank');\n      toast({\n        title: \"Abre Figma\",\n        description: \"Crea un nuevo archivo de diseño y recrea el diagrama mostrado aquí.\",\n      });\n    }\n  };\n\n  const handleCopyDiagram = () => {\n    const diagramText = diagram.nodes.map(n => `${n.type}: ${n.label}`).join('\\n');\n    navigator.clipboard.writeText(diagramText);\n    setCopied(true);\n    toast({\n      title: \"Diagrama copiado\",\n      description: \"Los pasos del diagrama han sido copiados al portapapeles.\",\n    });\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  const getNodePath = (node: FigmaNode) => {\n    const dims = nodeDimensions[node.id] || { width: MIN_NODE_WIDTH, height: NODE_HEIGHT };\n    const { width, height } = dims;\n    \n    switch (node.type) {\n      case \"start\":\n      case \"end\":\n        const r = height / 2;\n        return `M ${node.x + r} ${node.y} \n                L ${node.x + width - r} ${node.y}\n                A ${r} ${r} 0 0 1 ${node.x + width - r} ${node.y + height}\n                L ${node.x + r} ${node.y + height}\n                A ${r} ${r} 0 0 1 ${node.x + r} ${node.y} Z`;\n      case \"decision\":\n        const cx = node.x + width / 2;\n        const cy = node.y + height / 2;\n        return `M ${cx} ${node.y - 5} L ${node.x + width + 10} ${cy} L ${cx} ${node.y + height + 5} L ${node.x - 10} ${cy} Z`;\n      case \"process\":\n      default:\n        return `M ${node.x} ${node.y} L ${node.x + width} ${node.y} L ${node.x + width} ${node.y + height} L ${node.x} ${node.y + height} Z`;\n    }\n  };\n\n  const getNodeCenter = (node: FigmaNode) => {\n    const dims = nodeDimensions[node.id] || { width: MIN_NODE_WIDTH, height: NODE_HEIGHT };\n    return {\n      x: node.x + dims.width / 2,\n      y: node.y + dims.height / 2\n    };\n  };\n\n  const renderConnection = (conn: FigmaConnection, index: number) => {\n    const fromNode = diagram.nodes.find(n => n.id === conn.from);\n    const toNode = diagram.nodes.find(n => n.id === conn.to);\n    \n    if (!fromNode || !toNode) return null;\n    \n    const from = getNodeCenter(fromNode);\n    const to = getNodeCenter(toNode);\n    \n    const midX = (from.x + to.x) / 2;\n    const midY = (from.y + to.y) / 2;\n    \n    return (\n      <g key={`conn-${index}`}>\n        <defs>\n          <marker\n            id={`arrowhead-${index}`}\n            markerWidth=\"10\"\n            markerHeight=\"7\"\n            refX=\"9\"\n            refY=\"3.5\"\n            orient=\"auto\"\n          >\n            <polygon points=\"0 0, 10 3.5, 0 7\" fill=\"#666\" />\n          </marker>\n        </defs>\n        <line\n          x1={from.x}\n          y1={from.y}\n          x2={to.x}\n          y2={to.y}\n          stroke=\"#666\"\n          strokeWidth=\"2\"\n          markerEnd={`url(#arrowhead-${index})`}\n        />\n        {conn.label && (\n          <text\n            x={midX}\n            y={midY - 5}\n            textAnchor=\"middle\"\n            dominantBaseline=\"middle\"\n            fontSize=\"12\"\n            fontFamily={FONT_FAMILY}\n            fill=\"#F24E1E\"\n            fontWeight=\"500\"\n          >\n            {conn.label}\n          </text>\n        )}\n      </g>\n    );\n  };\n\n  const renderNode = (node: FigmaNode) => {\n    const center = getNodeCenter(node);\n    const isTerminal = node.type === \"start\" || node.type === \"end\";\n    const { text: displayText, isTruncated } = truncateLabel(node.label);\n    \n    return (\n      <g key={node.id}>\n        {isTruncated && <title>{node.label}</title>}\n        <path\n          d={getNodePath(node)}\n          fill={isTerminal ? \"#f5f5f5\" : \"white\"}\n          stroke={node.type === \"decision\" ? \"#F24E1E\" : \"#333\"}\n          strokeWidth=\"2\"\n        />\n        <text\n          x={center.x}\n          y={center.y}\n          textAnchor=\"middle\"\n          dominantBaseline=\"middle\"\n          fontSize={FONT_SIZE}\n          fontFamily={FONT_FAMILY}\n          fill=\"#333\"\n          fontWeight={isTerminal ? \"600\" : \"400\"}\n        >\n          {displayText}\n        </text>\n      </g>\n    );\n  };\n\n  return (\n    <div className={`relative rounded-xl border bg-card overflow-hidden ${isMaximized ? 'fixed inset-4 z-50' : ''}`}>\n      <div className=\"flex items-center justify-between px-4 py-2 border-b bg-muted/30\">\n        <div className=\"flex items-center gap-2\">\n          <svg width=\"16\" height=\"24\" viewBox=\"0 0 38 57\" fill=\"none\">\n            <path d=\"M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z\" fill=\"#1ABCFE\"/>\n            <path d=\"M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z\" fill=\"#0ACF83\"/>\n            <path d=\"M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z\" fill=\"#FF7262\"/>\n            <path d=\"M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z\" fill=\"#F24E1E\"/>\n            <path d=\"M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z\" fill=\"#A259FF\"/>\n          </svg>\n          <span className=\"text-sm font-medium\">Figma</span>\n        </div>\n        <button\n          onClick={() => setIsMaximized(!isMaximized)}\n          className=\"p-1 rounded hover:bg-accent\"\n        >\n          {isMaximized ? <Minimize2 className=\"h-4 w-4\" /> : <Maximize2 className=\"h-4 w-4\" />}\n        </button>\n      </div>\n\n      <div \n        ref={containerRef}\n        className=\"relative bg-[#f5f5f5] overflow-auto\"\n        style={{ \n          backgroundImage: 'radial-gradient(circle, #ddd 1px, transparent 1px)',\n          backgroundSize: '20px 20px',\n          minHeight: isMaximized ? 'calc(100% - 100px)' : '350px'\n        }}\n      >\n        <svg \n          width=\"100%\"\n          height=\"100%\"\n          viewBox={`${contentBounds.minX} ${contentBounds.minY} ${contentBounds.width} ${contentBounds.height}`}\n          preserveAspectRatio=\"xMidYMid meet\"\n          style={{\n            minWidth: Math.max(contentBounds.width * zoom, 400),\n            minHeight: Math.max(contentBounds.height * zoom, 300),\n            display: 'block'\n          }}\n        >\n          {diagram.connections.map((conn, i) => renderConnection(conn, i))}\n          {diagram.nodes.map(node => renderNode(node))}\n        </svg>\n      </div>\n\n      <div className=\"flex items-center justify-between px-4 py-2 border-t bg-muted/30\">\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"gap-2\"\n            onClick={handleEditInFigma}\n            data-testid=\"button-edit-figma\"\n          >\n            <svg width=\"12\" height=\"18\" viewBox=\"0 0 38 57\" fill=\"none\">\n              <path d=\"M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z\" fill=\"#1ABCFE\"/>\n              <path d=\"M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z\" fill=\"#0ACF83\"/>\n              <path d=\"M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z\" fill=\"#FF7262\"/>\n              <path d=\"M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z\" fill=\"#F24E1E\"/>\n              <path d=\"M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z\" fill=\"#A259FF\"/>\n            </svg>\n            Edit in Figma\n            <ExternalLink className=\"h-3 w-3\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"gap-2\"\n            onClick={handleCopyDiagram}\n            data-testid=\"button-copy-diagram\"\n          >\n            {copied ? <Check className=\"h-4 w-4\" /> : <Copy className=\"h-4 w-4\" />}\n            {copied ? \"Copiado\" : \"Copiar\"}\n          </Button>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" onClick={handleZoomOut} data-testid=\"button-zoom-out\">\n            <Minus className=\"h-4 w-4\" />\n          </Button>\n          <span className=\"text-xs text-muted-foreground min-w-[3rem] text-center\">{Math.round(zoom * 100)}%</span>\n          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" onClick={handleZoomIn} data-testid=\"button-zoom-in\">\n            <Plus className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" onClick={handleResetZoom} data-testid=\"button-reset-zoom\" title=\"Reset zoom\">\n            <RotateCcw className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport function parseFigmaDiagram(text: string): FigmaDiagram | null {\n  try {\n    const match = text.match(/```figma\\s*([\\s\\S]*?)```/);\n    if (match) {\n      return JSON.parse(match[1]);\n    }\n    return null;\n  } catch {\n    return null;\n  }\n}\n\nexport function generateFlowchartFromDescription(description: string): FigmaDiagram {\n  const steps = description.split(/[,;]|\\sy\\s/).map(s => s.trim()).filter(s => s.length > 0);\n  \n  const nodes: FigmaNode[] = [\n    { id: \"start\", type: \"start\", label: \"Inicio\", x: 50, y: 175 }\n  ];\n  \n  const connections: FigmaConnection[] = [];\n  let lastId = \"start\";\n  let xPos = 200;\n  \n  steps.forEach((step, index) => {\n    const id = `step-${index}`;\n    const isDecision = step.toLowerCase().includes(\"decisión\") || step.toLowerCase().includes(\"decision\") || step.includes(\"?\");\n    \n    nodes.push({\n      id,\n      type: isDecision ? \"decision\" : \"process\",\n      label: step.length > 15 ? step.substring(0, 15) + \"...\" : step,\n      x: xPos,\n      y: 175\n    });\n    \n    connections.push({ from: lastId, to: id });\n    lastId = id;\n    xPos += 150;\n  });\n  \n  nodes.push({ id: \"end\", type: \"end\", label: \"Fin\", x: xPos, y: 175 });\n  connections.push({ from: lastId, to: \"end\" });\n  \n  return { nodes, connections };\n}\n","path":null,"size_bytes":13392,"size_tokens":null},"server/services/figmaService.ts":{"content":"\nexport interface FigmaFile {\n  key: string;\n  name: string;\n  thumbnailUrl?: string;\n  lastModified: string;\n}\n\nexport interface FigmaNode {\n  id: string;\n  name: string;\n  type: string;\n  children?: FigmaNode[];\n  absoluteBoundingBox?: {\n    x: number;\n    y: number;\n    width: number;\n    height: number;\n  };\n  fills?: any[];\n  strokes?: any[];\n  effects?: any[];\n  style?: any;\n  characters?: string;\n}\n\nexport interface FigmaDesignToken {\n  name: string;\n  type: \"color\" | \"typography\" | \"spacing\" | \"effect\";\n  value: any;\n  description?: string;\n}\n\nexport interface FigmaCodeContext {\n  html: string;\n  css: string;\n  react: string;\n  tokens: FigmaDesignToken[];\n}\n\nconst FIGMA_API_BASE = \"https://api.figma.com/v1\";\n\nclass FigmaService {\n  private accessToken: string | null = null;\n\n  setAccessToken(token: string) {\n    this.accessToken = token;\n  }\n\n  getAccessToken(): string | null {\n    return this.accessToken;\n  }\n\n  private async request<T>(endpoint: string): Promise<T> {\n    if (!this.accessToken) {\n      throw new Error(\"Figma access token not configured\");\n    }\n\n    const response = await fetch(`${FIGMA_API_BASE}${endpoint}`, {\n      headers: {\n        \"X-Figma-Token\": this.accessToken,\n      },\n    });\n\n    if (!response.ok) {\n      const error = await response.text();\n      throw new Error(`Figma API error: ${response.status} - ${error}`);\n    }\n\n    return response.json() as Promise<T>;\n  }\n\n  async getFile(fileKey: string): Promise<any> {\n    return this.request(`/files/${fileKey}`);\n  }\n\n  async getFileNodes(fileKey: string, nodeIds: string[]): Promise<any> {\n    const ids = nodeIds.join(\",\");\n    return this.request(`/files/${fileKey}/nodes?ids=${encodeURIComponent(ids)}`);\n  }\n\n  async getImages(fileKey: string, nodeIds: string[], format: \"png\" | \"svg\" | \"jpg\" = \"png\", scale: number = 2): Promise<Record<string, string>> {\n    const ids = nodeIds.join(\",\");\n    const result = await this.request<{ images: Record<string, string> }>(\n      `/images/${fileKey}?ids=${encodeURIComponent(ids)}&format=${format}&scale=${scale}`\n    );\n    return result.images;\n  }\n\n  async getTeamProjects(teamId: string): Promise<any> {\n    return this.request(`/teams/${teamId}/projects`);\n  }\n\n  async getProjectFiles(projectId: string): Promise<FigmaFile[]> {\n    const result = await this.request<{ files: any[] }>(`/projects/${projectId}/files`);\n    return result.files.map((f: any) => ({\n      key: f.key,\n      name: f.name,\n      thumbnailUrl: f.thumbnail_url,\n      lastModified: f.last_modified,\n    }));\n  }\n\n  async getLocalVariables(fileKey: string): Promise<any> {\n    return this.request(`/files/${fileKey}/variables/local`);\n  }\n\n  async getStyles(fileKey: string): Promise<any> {\n    return this.request(`/files/${fileKey}/styles`);\n  }\n\n  extractDesignTokens(fileData: any): FigmaDesignToken[] {\n    const tokens: FigmaDesignToken[] = [];\n    \n    const extractColors = (node: any, path: string = \"\") => {\n      if (node.fills && Array.isArray(node.fills)) {\n        node.fills.forEach((fill: any, index: number) => {\n          if (fill.type === \"SOLID\" && fill.color) {\n            const { r, g, b, a = 1 } = fill.color;\n            tokens.push({\n              name: `${path}${node.name}-fill-${index}`,\n              type: \"color\",\n              value: {\n                r: Math.round(r * 255),\n                g: Math.round(g * 255),\n                b: Math.round(b * 255),\n                a,\n                hex: `#${Math.round(r * 255).toString(16).padStart(2, \"0\")}${Math.round(g * 255).toString(16).padStart(2, \"0\")}${Math.round(b * 255).toString(16).padStart(2, \"0\")}`,\n              },\n            });\n          }\n        });\n      }\n\n      if (node.style) {\n        const style = node.style;\n        if (style.fontFamily) {\n          tokens.push({\n            name: `${path}${node.name}-typography`,\n            type: \"typography\",\n            value: {\n              fontFamily: style.fontFamily,\n              fontSize: style.fontSize,\n              fontWeight: style.fontWeight,\n              lineHeight: style.lineHeightPx,\n              letterSpacing: style.letterSpacing,\n            },\n          });\n        }\n      }\n\n      if (node.children) {\n        node.children.forEach((child: any) => {\n          extractColors(child, `${path}${node.name}/`);\n        });\n      }\n    };\n\n    if (fileData.document) {\n      extractColors(fileData.document);\n    }\n\n    return tokens;\n  }\n\n  generateReactCode(node: any, depth: number = 0): string {\n    const indent = \"  \".repeat(depth);\n    const nodeType = node.type;\n    const name = node.name?.replace(/[^a-zA-Z0-9]/g, \"\") || \"Component\";\n\n    let code = \"\";\n    let styles: string[] = [];\n\n    if (node.absoluteBoundingBox) {\n      const { width, height } = node.absoluteBoundingBox;\n      styles.push(`width: ${Math.round(width)}px`);\n      styles.push(`height: ${Math.round(height)}px`);\n    }\n\n    if (node.fills && node.fills[0]?.type === \"SOLID\") {\n      const { r, g, b, a = 1 } = node.fills[0].color;\n      const hex = `#${Math.round(r * 255).toString(16).padStart(2, \"0\")}${Math.round(g * 255).toString(16).padStart(2, \"0\")}${Math.round(b * 255).toString(16).padStart(2, \"0\")}`;\n      styles.push(`backgroundColor: '${hex}'`);\n    }\n\n    if (node.cornerRadius) {\n      styles.push(`borderRadius: ${node.cornerRadius}px`);\n    }\n\n    const styleString = styles.length > 0 ? ` style={{ ${styles.join(\", \")} }}` : \"\";\n\n    switch (nodeType) {\n      case \"TEXT\":\n        code = `${indent}<p${styleString}>${node.characters || \"\"}</p>`;\n        break;\n      case \"FRAME\":\n      case \"GROUP\":\n      case \"COMPONENT\":\n      case \"INSTANCE\":\n        const children = node.children?.map((child: any) => this.generateReactCode(child, depth + 1)).join(\"\\n\") || \"\";\n        code = `${indent}<div${styleString}>\\n${children}\\n${indent}</div>`;\n        break;\n      case \"RECTANGLE\":\n        code = `${indent}<div${styleString} />`;\n        break;\n      case \"ELLIPSE\":\n        styles.push(\"borderRadius: '50%'\");\n        code = `${indent}<div style={{ ${styles.join(\", \")} }} />`;\n        break;\n      case \"VECTOR\":\n      case \"LINE\":\n        code = `${indent}{/* Vector: ${node.name} */}`;\n        break;\n      default:\n        if (node.children) {\n          const children = node.children.map((child: any) => this.generateReactCode(child, depth + 1)).join(\"\\n\");\n          code = `${indent}<div${styleString}>\\n${children}\\n${indent}</div>`;\n        } else {\n          code = `${indent}<div${styleString} />`;\n        }\n    }\n\n    return code;\n  }\n\n  async getDesignContext(fileKey: string, nodeId?: string): Promise<FigmaCodeContext> {\n    const fileData = await this.getFile(fileKey);\n    const tokens = this.extractDesignTokens(fileData);\n\n    let targetNode = fileData.document;\n    if (nodeId) {\n      const nodesData = await this.getFileNodes(fileKey, [nodeId]);\n      if (nodesData.nodes && nodesData.nodes[nodeId]) {\n        targetNode = nodesData.nodes[nodeId].document;\n      }\n    }\n\n    const reactCode = `\nimport React from 'react';\n\nexport function ${targetNode.name?.replace(/[^a-zA-Z0-9]/g, \"\") || \"FigmaComponent\"}() {\n  return (\n${this.generateReactCode(targetNode, 2)}\n  );\n}\n`.trim();\n\n    const cssVars = tokens\n      .filter(t => t.type === \"color\")\n      .map(t => `  --${t.name.replace(/[^a-zA-Z0-9-]/g, \"-\")}: ${t.value.hex};`)\n      .join(\"\\n\");\n\n    const css = `:root {\\n${cssVars}\\n}`;\n\n    return {\n      html: this.generateReactCode(targetNode).replace(/className/g, \"class\"),\n      css,\n      react: reactCode,\n      tokens,\n    };\n  }\n\n  parseFileUrl(url: string): { fileKey: string; nodeId?: string } | null {\n    const fileMatch = url.match(/figma\\.com\\/(?:file|design)\\/([a-zA-Z0-9]+)/);\n    if (!fileMatch) return null;\n\n    const fileKey = fileMatch[1];\n    const nodeMatch = url.match(/node-id=([^&]+)/);\n    const nodeId = nodeMatch ? decodeURIComponent(nodeMatch[1]) : undefined;\n\n    return { fileKey, nodeId };\n  }\n}\n\nexport const figmaService = new FigmaService();\n","path":null,"size_bytes":8013,"size_tokens":null},"client/src/components/figma-connector.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Check } from \"lucide-react\";\n\ninterface FigmaConnectorProps {\n  onConnectionChange?: (connected: boolean) => void;\n}\n\nexport function FigmaConnector({ onConnectionChange }: FigmaConnectorProps) {\n  const [isConnected, setIsConnected] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const { toast } = useToast();\n\n  useEffect(() => {\n    checkConnectionStatus();\n    handleOAuthCallback();\n  }, []);\n\n  const handleOAuthCallback = () => {\n    const urlParams = new URLSearchParams(window.location.search);\n    \n    if (urlParams.get('figma_connected') === 'true') {\n      setIsConnected(true);\n      onConnectionChange?.(true);\n      toast({\n        title: \"Conectado\",\n        description: \"Figma conectado exitosamente\",\n      });\n      window.history.replaceState({}, '', window.location.pathname);\n    }\n    \n    const error = urlParams.get('figma_error');\n    if (error) {\n      toast({\n        title: \"Error de conexión\",\n        description: getErrorMessage(error),\n        variant: \"destructive\",\n      });\n      window.history.replaceState({}, '', window.location.pathname);\n    }\n  };\n\n  const getErrorMessage = (error: string) => {\n    switch (error) {\n      case 'no_code': return 'Autorización cancelada';\n      case 'not_configured': return 'OAuth de Figma no configurado';\n      case 'token_exchange_failed': return 'Error al obtener token de acceso';\n      default: return 'Error de conexión con Figma';\n    }\n  };\n\n  const checkConnectionStatus = async () => {\n    try {\n      const response = await fetch(\"/api/figma/status\");\n      const data = await response.json();\n      setIsConnected(data.connected);\n      onConnectionChange?.(data.connected);\n    } catch (error) {\n      console.error(\"Error checking Figma status:\", error);\n    }\n  };\n\n  const handleConnect = () => {\n    setIsLoading(true);\n    window.location.href = \"/api/auth/figma\";\n  };\n\n  const handleDisconnect = async () => {\n    setIsLoading(true);\n    try {\n      await fetch(\"/api/figma/disconnect\", { method: \"POST\" });\n      setIsConnected(false);\n      onConnectionChange?.(false);\n      toast({\n        title: \"Desconectado\",\n        description: \"Sesión de Figma cerrada\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo desconectar\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"flex items-center justify-between p-4 bg-card border rounded-xl\" data-testid=\"figma-connector\">\n      <div className=\"flex items-center gap-4\">\n        <div className=\"w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center\">\n          <svg width=\"32\" height=\"32\" viewBox=\"0 0 38 57\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n            <path d=\"M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z\" fill=\"#1ABCFE\"/>\n            <path d=\"M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z\" fill=\"#0ACF83\"/>\n            <path d=\"M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z\" fill=\"#FF7262\"/>\n            <path d=\"M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z\" fill=\"#F24E1E\"/>\n            <path d=\"M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z\" fill=\"#A259FF\"/>\n          </svg>\n        </div>\n        <div>\n          <h3 className=\"font-semibold text-foreground\">Figma</h3>\n          <p className=\"text-sm text-muted-foreground\">\n            {isConnected ? \"Conectado\" : \"Crea diagramas, slides y assets\"}\n          </p>\n        </div>\n      </div>\n\n      <Button\n        variant={isConnected ? \"outline\" : \"default\"}\n        onClick={isConnected ? handleDisconnect : handleConnect}\n        disabled={isLoading}\n        className={isConnected ? \"gap-2\" : \"bg-black text-white hover:bg-gray-800 rounded-full px-6\"}\n        data-testid={isConnected ? \"button-disconnect-figma\" : \"button-connect-figma\"}\n      >\n        {isLoading ? (\n          <Loader2 className=\"h-4 w-4 animate-spin\" />\n        ) : isConnected ? (\n          <>\n            <Check className=\"h-4 w-4 text-green-500\" />\n            Desconectar\n          </>\n        ) : (\n          \"Conectar\"\n        )}\n      </Button>\n    </div>\n  );\n}\n","path":null,"size_bytes":4531,"size_tokens":null},"client/src/components/sira-logo.tsx":{"content":"import siraLogoSrc from \"@/assets/sira-logo.png\";\n\ninterface SiraLogoProps {\n  size?: number;\n  className?: string;\n}\n\nexport function SiraLogo({ size = 32, className = \"\" }: SiraLogoProps) {\n  return (\n    <img \n      src={siraLogoSrc} \n      alt=\"Sira Logo\" \n      width={size} \n      height={size}\n      className={`${className} mix-blend-multiply dark:mix-blend-screen dark:invert`}\n      style={{ objectFit: \"contain\" }}\n    />\n  );\n}\n","path":null,"size_bytes":440,"size_tokens":null},"client/src/components/share-chat-dialog.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Copy, Check, Link, X, UserPlus, Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport shareIconSrc from \"@/assets/share-icon.png\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface Participant {\n  email: string;\n  role: \"owner\" | \"editor\" | \"viewer\";\n}\n\ninterface ShareChatDialogProps {\n  chatId: string;\n  chatTitle: string;\n  children?: React.ReactNode;\n}\n\nexport function ShareChatDialog({ chatId, chatTitle, children }: ShareChatDialogProps) {\n  const [open, setOpen] = useState(false);\n  const [email, setEmail] = useState(\"\");\n  const [selectedRole, setSelectedRole] = useState<\"editor\" | \"viewer\">(\"viewer\");\n  const [participants, setParticipants] = useState<Participant[]>([]);\n  const [copied, setCopied] = useState(false);\n  const [sending, setSending] = useState(false);\n  const { toast } = useToast();\n\n  const shareLink = `${window.location.origin}/chat/${chatId}`;\n\n  useEffect(() => {\n    if (open && chatId) {\n      loadExistingShares();\n    }\n  }, [open, chatId]);\n\n  const loadExistingShares = async () => {\n    try {\n      const response = await fetch(`/api/chats/${chatId}/shares`, { credentials: 'include' });\n      if (response.ok) {\n        const shares = await response.json();\n        setParticipants(shares.map((s: any) => ({ email: s.email, role: s.role })));\n      }\n    } catch (error) {\n      console.error(\"Failed to load shares:\", error);\n    }\n  };\n\n  const handleSendInvitations = async () => {\n    if (participants.length === 0) return;\n    \n    setSending(true);\n    try {\n      const response = await apiRequest(\"POST\", `/api/chats/${chatId}/shares`, {\n        participants\n      });\n      \n      if (response.ok) {\n        toast({\n          title: \"Invitaciones enviadas\",\n          description: `Se enviaron notificaciones a ${participants.length} participante(s)`,\n        });\n        setOpen(false);\n      } else {\n        const error = await response.json();\n        toast({\n          title: \"Error\",\n          description: error.error || \"No se pudieron enviar las invitaciones\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"No se pudieron enviar las invitaciones\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const handleAddParticipant = () => {\n    if (!email || !email.includes(\"@\")) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa un correo válido\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (participants.find(p => p.email === email)) {\n      toast({\n        title: \"Error\",\n        description: \"Este participante ya fue agregado\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setParticipants([...participants, { email, role: selectedRole }]);\n    setEmail(\"\");\n    toast({\n      title: \"Participante agregado\",\n      description: `${email} fue agregado como ${getRoleLabel(selectedRole)}`,\n    });\n  };\n\n  const handleRemoveParticipant = (emailToRemove: string) => {\n    setParticipants(participants.filter(p => p.email !== emailToRemove));\n  };\n\n  const handleChangeRole = (email: string, newRole: \"owner\" | \"editor\" | \"viewer\") => {\n    setParticipants(participants.map(p => \n      p.email === email ? { ...p, role: newRole } : p\n    ));\n  };\n\n  const handleCopyLink = () => {\n    navigator.clipboard.writeText(shareLink);\n    setCopied(true);\n    toast({\n      title: \"Link copiado\",\n      description: \"El enlace para unirse ha sido copiado al portapapeles\",\n    });\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  const getRoleLabel = (role: string) => {\n    switch (role) {\n      case \"owner\": return \"Dueño\";\n      case \"editor\": return \"Editor\";\n      case \"viewer\": return \"Visualizador\";\n      default: return role;\n    }\n  };\n\n  const getInitials = (email: string) => {\n    return email.split(\"@\")[0].substring(0, 2).toUpperCase();\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogTrigger asChild>\n        {children || (\n          <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-share-chat\">\n            <img \n              src={shareIconSrc} \n              alt=\"Share\" \n              className=\"h-5 w-5 mix-blend-multiply dark:mix-blend-screen dark:invert\"\n            />\n          </Button>\n        )}\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <UserPlus className=\"h-5 w-5\" />\n            Compartir \"{chatTitle || 'Chat'}\"\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-4 py-4\">\n          <div className=\"flex items-center gap-2\">\n            <Input\n              placeholder=\"Ingresa el correo electrónico\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              onKeyDown={(e) => e.key === \"Enter\" && handleAddParticipant()}\n              className=\"flex-1\"\n              data-testid=\"input-participant-email\"\n            />\n            <Select value={selectedRole} onValueChange={(v) => setSelectedRole(v as \"editor\" | \"viewer\")}>\n              <SelectTrigger className=\"w-[130px]\" data-testid=\"select-participant-role\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"editor\">Editor</SelectItem>\n                <SelectItem value=\"viewer\">Visualizador</SelectItem>\n              </SelectContent>\n            </Select>\n            <Button onClick={handleAddParticipant} size=\"icon\" data-testid=\"button-add-participant\">\n              <UserPlus className=\"h-4 w-4\" />\n            </Button>\n          </div>\n\n          {participants.length > 0 && (\n            <div className=\"space-y-2 max-h-48 overflow-y-auto\">\n              <p className=\"text-sm font-medium text-muted-foreground\">Participantes:</p>\n              {participants.map((participant) => (\n                <div \n                  key={participant.email} \n                  className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\"\n                  data-testid={`participant-${participant.email}`}\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <Avatar className=\"h-8 w-8\">\n                      <AvatarFallback className=\"text-xs bg-primary/20\">\n                        {getInitials(participant.email)}\n                      </AvatarFallback>\n                    </Avatar>\n                    <span className=\"text-sm truncate max-w-[150px]\">{participant.email}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Select \n                      value={participant.role} \n                      onValueChange={(v) => handleChangeRole(participant.email, v as \"owner\" | \"editor\" | \"viewer\")}\n                    >\n                      <SelectTrigger className=\"w-[110px] h-8 text-xs\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"owner\">Dueño</SelectItem>\n                        <SelectItem value=\"editor\">Editor</SelectItem>\n                        <SelectItem value=\"viewer\">Visualizador</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8 text-muted-foreground hover:text-destructive\"\n                      onClick={() => handleRemoveParticipant(participant.email)}\n                      data-testid={`button-remove-${participant.email}`}\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n\n          <div className=\"border-t pt-4\">\n            <p className=\"text-sm font-medium mb-2 flex items-center gap-2\">\n              <Link className=\"h-4 w-4\" />\n              Enlace para unirse\n            </p>\n            <div className=\"flex items-center gap-2\">\n              <Input \n                value={shareLink} \n                readOnly \n                className=\"flex-1 text-sm bg-muted\"\n                data-testid=\"input-share-link\"\n              />\n              <Button \n                variant=\"outline\" \n                size=\"icon\"\n                onClick={handleCopyLink}\n                data-testid=\"button-copy-link\"\n              >\n                {copied ? <Check className=\"h-4 w-4 text-green-500\" /> : <Copy className=\"h-4 w-4\" />}\n              </Button>\n            </div>\n          </div>\n\n          <Button \n            className=\"w-full\" \n            onClick={handleSendInvitations}\n            disabled={participants.length === 0 || sending}\n            data-testid=\"button-send-invitations\"\n          >\n            {sending ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Enviando...\n              </>\n            ) : (\n              \"Enviar invitaciones\"\n            )}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport function ShareIcon({ size = 20, className = \"\" }: { size?: number; className?: string }) {\n  return (\n    <img \n      src={shareIconSrc} \n      alt=\"Share\" \n      width={size}\n      height={size}\n      className={`${className} mix-blend-multiply dark:mix-blend-screen dark:invert`}\n      style={{ objectFit: \"contain\" }}\n    />\n  );\n}\n","path":null,"size_bytes":10083,"size_tokens":null},"server/webhookHandlers.ts":{"content":"import { getStripeSync } from './stripeClient';\n\nexport class WebhookHandlers {\n  static async processWebhook(payload: Buffer, signature: string): Promise<void> {\n    if (!Buffer.isBuffer(payload)) {\n      throw new Error(\n        'STRIPE WEBHOOK ERROR: Payload must be a Buffer. ' +\n        'Received type: ' + typeof payload + '. ' +\n        'This usually means express.json() parsed the body before reaching this handler. ' +\n        'FIX: Ensure webhook route is registered BEFORE app.use(express.json()).'\n      );\n    }\n\n    const sync = await getStripeSync();\n    await sync.processWebhook(payload, signature);\n  }\n}\n","path":null,"size_bytes":624,"size_tokens":null},"client/src/components/upgrade-plan-dialog.tsx":{"content":"import { useState } from \"react\";\nimport { Dialog, DialogContent, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { X, Sparkles, MessageSquare, Image, Brain, Clock, Target, Zap, Users, Shield, FileText, Video, Code, Star, Infinity, CheckCircle2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface UpgradePlanDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\ntype PlanTab = \"personal\" | \"empresa\";\n\nexport function UpgradePlanDialog({ open, onOpenChange }: UpgradePlanDialogProps) {\n  const [activeTab, setActiveTab] = useState<PlanTab>(\"personal\");\n\n  const personalPlans = [\n    {\n      name: \"Gratis\",\n      price: 0,\n      description: \"Mira lo que la IA puede hacer\",\n      buttonText: \"Tu plan actual\",\n      buttonVariant: \"outline\" as const,\n      isCurrentPlan: true,\n      features: [\n        { icon: Sparkles, text: \"Obtén explicaciones sencillas\" },\n        { icon: MessageSquare, text: \"Mantén chats breves para preguntas frecuentes\" },\n        { icon: Image, text: \"Prueba la generación de imágenes\" },\n        { icon: Brain, text: \"Guardar memoria y contexto limitados\" },\n      ]\n    },\n    {\n      name: \"Go\",\n      price: 5,\n      badge: \"NUEVO\",\n      description: \"Logra más con una IA más avanzada\",\n      buttonText: \"Mejorar el plan a Go\",\n      buttonVariant: \"default\" as const,\n      highlight: true,\n      buttonColor: \"bg-purple-600 hover:bg-purple-700\",\n      features: [\n        { icon: Target, text: \"Explora a fondo preguntas más complejas\" },\n        { icon: Clock, text: \"Chatea más tiempo y carga más contenido\" },\n        { icon: Image, text: \"Crea imágenes realistas para tus proyectos\" },\n        { icon: Brain, text: \"Almacena más contexto y obtén respuestas más inteligentes\" },\n        { icon: Zap, text: \"Obtén ayuda con la planificación y las tareas\" },\n        { icon: Star, text: \"Explora proyectos, tareas y GPT personalizados\" },\n      ],\n      footerNote: \"Solo disponible en algunas regiones. Se aplican límites\"\n    },\n    {\n      name: \"Plus\",\n      price: 20,\n      description: \"Descubre toda la experiencia\",\n      buttonText: \"Obtener Plus\",\n      buttonVariant: \"default\" as const,\n      features: [\n        { icon: Sparkles, text: \"Resuelve problemas complejos\" },\n        { icon: MessageSquare, text: \"Ten largas charlas en varias sesiones\" },\n        { icon: Image, text: \"Cree más imágenes, más rápido\" },\n        { icon: Brain, text: \"Recuerda objetivos y conversaciones pasadas\" },\n        { icon: Target, text: \"Planifica viajes y tareas con el modo Agente\" },\n        { icon: FileText, text: \"Organiza proyectos y GPT personalizados\" },\n        { icon: Video, text: \"Produce y comparte videos en Sora\" },\n        { icon: Code, text: \"Escribe código y crea aplicaciones con Codex\" },\n      ],\n      footerNote: \"Se aplican límites\"\n    },\n    {\n      name: \"Pro\",\n      price: 200,\n      description: \"Maximiza tu productividad\",\n      buttonText: \"Obtener Pro\",\n      buttonVariant: \"default\" as const,\n      features: [\n        { icon: Star, text: \"Domina tareas y temas avanzados\" },\n        { icon: Infinity, text: \"Trabaja en proyectos grandes con mensajes ilimitados\" },\n        { icon: Image, text: \"Crea imágenes de alta calidad a cualquier escala\" },\n        { icon: Brain, text: \"Mantén todo el contexto con la memoria máxima\" },\n        { icon: Zap, text: \"Ejecuta investigaciones y planifica tareas con agentes\" },\n        { icon: Target, text: \"Adapta tus proyectos y automatiza flujos de trabajo\" },\n        { icon: Video, text: \"Supera tus límites con la creación de videos en Sora\" },\n        { icon: Code, text: \"Implementa código más rápido con Codex\" },\n        { icon: Star, text: \"Obtén acceso anticipado a características experimentales\" },\n      ],\n      footerNote: \"Ilimitado, sujeto a medidas de protección contra abusos. Obtener más información\"\n    },\n  ];\n\n  const empresaPlans = [\n    {\n      name: \"Gratis\",\n      price: 0,\n      description: \"Mira lo que la IA puede hacer\",\n      buttonText: \"Tu plan actual\",\n      buttonVariant: \"outline\" as const,\n      isCurrentPlan: true,\n      features: [\n        { icon: Sparkles, text: \"Obtén explicaciones sencillas\" },\n        { icon: MessageSquare, text: \"Mantén chats breves para preguntas frecuentes\" },\n        { icon: Image, text: \"Prueba la generación de imágenes\" },\n        { icon: Brain, text: \"Guardar memoria y contexto limitados\" },\n      ]\n    },\n    {\n      name: \"Business\",\n      price: 25,\n      badge: \"RECOMENDADO\",\n      description: \"Mejora la productividad con la IA para equipos\",\n      buttonText: \"Obtener Business\",\n      buttonVariant: \"default\" as const,\n      highlight: true,\n      features: [\n        { icon: CheckCircle2, text: \"Realiza un análisis profesional\" },\n        { icon: Infinity, text: \"Obtén mensajes ilimitados con GPT-5\" },\n        { icon: Image, text: \"Produce imágenes, videos, presentaciones y más\" },\n        { icon: Shield, text: \"Protege tu espacio con SSO, MFA y más\" },\n        { icon: Shield, text: \"Protege la privacidad; los datos nunca se usan para fines de entrenamiento\" },\n        { icon: Users, text: \"Comparte proyectos y GPT personalizados\" },\n        { icon: FileText, text: \"Se integra con SharePoint y otras herramientas\" },\n        { icon: Target, text: \"Simplifica la facturación y administración de usuarios\" },\n        { icon: MessageSquare, text: \"Captura notas de reuniones con transcripción\" },\n      ]\n    },\n  ];\n\n  const plans = activeTab === \"personal\" ? personalPlans : empresaPlans;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-6xl w-[95vw] max-h-[90vh] overflow-y-auto p-0\">\n        <DialogTitle className=\"sr-only\">Mejora tu plan</DialogTitle>\n        <div className=\"sticky top-0 bg-background z-10 p-6 pb-4 border-b\">\n          <div className=\"flex justify-between items-start\">\n            <div></div>\n            <h2 className=\"text-2xl font-semibold text-center\">Mejora tu plan</h2>\n            <Button \n              variant=\"ghost\" \n              size=\"icon\" \n              onClick={() => onOpenChange(false)}\n              className=\"h-8 w-8\"\n              data-testid=\"button-close-upgrade\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n          \n          <div className=\"flex justify-center mt-4\">\n            <div className=\"inline-flex bg-muted rounded-full p-1\">\n              <button\n                className={cn(\n                  \"px-4 py-1.5 text-sm font-medium rounded-full transition-colors\",\n                  activeTab === \"personal\" ? \"bg-background shadow-sm\" : \"text-muted-foreground hover:text-foreground\"\n                )}\n                onClick={() => setActiveTab(\"personal\")}\n                data-testid=\"tab-personal\"\n              >\n                Personal\n              </button>\n              <button\n                className={cn(\n                  \"px-4 py-1.5 text-sm font-medium rounded-full transition-colors\",\n                  activeTab === \"empresa\" ? \"bg-background shadow-sm\" : \"text-muted-foreground hover:text-foreground\"\n                )}\n                onClick={() => setActiveTab(\"empresa\")}\n                data-testid=\"tab-empresa\"\n              >\n                Empresa\n              </button>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"p-6\">\n          <div className={cn(\n            \"grid gap-4\",\n            activeTab === \"personal\" ? \"grid-cols-1 md:grid-cols-2 lg:grid-cols-4\" : \"grid-cols-1 md:grid-cols-2\"\n          )}>\n            {plans.map((plan) => (\n              <div\n                key={plan.name}\n                className={cn(\n                  \"rounded-xl border p-6 flex flex-col\",\n                  plan.highlight && \"border-primary/50 shadow-lg\"\n                )}\n                data-testid={`plan-card-${plan.name.toLowerCase()}`}\n              >\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <h3 className=\"text-xl font-semibold\">{plan.name}</h3>\n                  {plan.badge && (\n                    <Badge variant=\"secondary\" className={cn(\n                      \"text-xs\",\n                      plan.badge === \"NUEVO\" && \"bg-green-100 text-green-700\",\n                      plan.badge === \"RECOMENDADO\" && \"bg-primary/10 text-primary\"\n                    )}>\n                      {plan.badge}\n                    </Badge>\n                  )}\n                </div>\n                \n                <div className=\"flex items-baseline gap-0.5 mb-2\">\n                  <span className=\"text-sm\">$</span>\n                  <span className=\"text-4xl font-bold\">{plan.price}</span>\n                  <span className=\"text-sm text-muted-foreground\">USD / mes</span>\n                </div>\n                \n                <p className=\"text-sm text-muted-foreground mb-4\">{plan.description}</p>\n                \n                <Button\n                  variant={plan.buttonVariant}\n                  className={cn(\n                    \"w-full mb-6\",\n                    (plan as any).buttonColor ? (plan as any).buttonColor : plan.highlight && \"bg-primary hover:bg-primary/90\"\n                  )}\n                  disabled={plan.isCurrentPlan}\n                  data-testid={`button-${plan.name.toLowerCase()}`}\n                >\n                  {plan.buttonText}\n                </Button>\n                \n                <div className=\"space-y-3 flex-1\">\n                  {plan.features.map((feature, idx) => (\n                    <div key={idx} className=\"flex items-start gap-2 text-sm\">\n                      <feature.icon className=\"h-4 w-4 mt-0.5 text-muted-foreground flex-shrink-0\" />\n                      <span>{feature.text}</span>\n                    </div>\n                  ))}\n                </div>\n\n                {(plan as any).footerNote && (\n                  <p className=\"text-xs text-muted-foreground mt-4 pt-4 border-t\">\n                    {((plan as any).footerNote as string).includes(\"Obtener más información\") ? (\n                      <>\n                        {((plan as any).footerNote as string).replace(\"Obtener más información\", \"\")}\n                        <button className=\"underline hover:text-foreground\">Obtener más información</button>\n                      </>\n                    ) : ((plan as any).footerNote as string).includes(\"Se aplican límites\") ? (\n                      <>\n                        {((plan as any).footerNote as string).replace(\"Se aplican límites\", \"\")}\n                        <button className=\"underline hover:text-foreground\">Se aplican límites</button>\n                      </>\n                    ) : (\n                      (plan as any).footerNote\n                    )}\n                  </p>\n                )}\n              </div>\n            ))}\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":11089,"size_tokens":null},"client/src/components/settings-dialog.tsx":{"content":"import { useState } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  Settings, \n  Bell, \n  Palette, \n  AppWindow, \n  Calendar, \n  Database, \n  Shield, \n  User,\n  X,\n  Play,\n  ChevronRight,\n  Plus,\n  Github,\n  Globe,\n  Linkedin,\n  Info,\n  Mail,\n  Box,\n  Loader2,\n  Check,\n  Volume2,\n  Link,\n  Unlink,\n  Clock,\n  AlertCircle,\n  CheckCircle2,\n  XCircle,\n  ExternalLink,\n  RefreshCw\n} from \"lucide-react\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { cn } from \"@/lib/utils\";\nimport { useLanguage } from \"@/hooks/use-language\";\nimport { useSettingsContext } from \"@/contexts/SettingsContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { \n  Sparkles, \n  CheckSquare, \n  Users, \n  Package,\n  MessageSquare,\n  Zap,\n  Star,\n  Share2,\n  Heart,\n  Gift,\n  TrendingUp,\n  FileText\n} from \"lucide-react\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\n\ntype SettingsSection = \"general\" | \"notifications\" | \"personalization\" | \"apps\" | \"schedules\" | \"data\" | \"security\" | \"account\";\n\ninterface SettingsDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nconst menuItems: { id: SettingsSection; label: string; icon: React.ReactNode }[] = [\n  { id: \"general\", label: \"General\", icon: <Settings className=\"h-4 w-4\" /> },\n  { id: \"notifications\", label: \"Notificaciones\", icon: <Bell className=\"h-4 w-4\" /> },\n  { id: \"personalization\", label: \"Personalización\", icon: <Palette className=\"h-4 w-4\" /> },\n  { id: \"apps\", label: \"Aplicaciones\", icon: <AppWindow className=\"h-4 w-4\" /> },\n  { id: \"schedules\", label: \"Programaciones\", icon: <Calendar className=\"h-4 w-4\" /> },\n  { id: \"data\", label: \"Controles de datos\", icon: <Database className=\"h-4 w-4\" /> },\n  { id: \"security\", label: \"Seguridad\", icon: <Shield className=\"h-4 w-4\" /> },\n  { id: \"account\", label: \"Cuenta\", icon: <User className=\"h-4 w-4\" /> },\n];\n\nconst voices = [\n  { id: \"cove\", name: \"Cove\", description: \"Voz cálida y amigable\" },\n  { id: \"ember\", name: \"Ember\", description: \"Voz enérgica y dinámica\" },\n  { id: \"juniper\", name: \"Juniper\", description: \"Voz clara y profesional\" },\n  { id: \"breeze\", name: \"Breeze\", description: \"Voz suave y relajante\" },\n];\n\ninterface NotificationEventType {\n  id: string;\n  name: string;\n  description: string;\n  category: string;\n  icon?: string;\n}\n\ninterface NotificationPreference {\n  id: string;\n  eventTypeId: string;\n  channels: string;\n  enabled: boolean;\n}\n\nconst categoryLabels: Record<string, string> = {\n  ai_updates: \"Actualizaciones de IA\",\n  tasks: \"Tareas\",\n  social: \"Social\",\n  product: \"Producto\",\n};\n\nconst categoryIcons: Record<string, React.ReactNode> = {\n  ai_updates: <Sparkles className=\"h-4 w-4\" />,\n  tasks: <CheckSquare className=\"h-4 w-4\" />,\n  social: <Users className=\"h-4 w-4\" />,\n  product: <Package className=\"h-4 w-4\" />,\n};\n\nconst eventTypeIcons: Record<string, React.ReactNode> = {\n  ai_response: <MessageSquare className=\"h-4 w-4\" />,\n  ai_suggestion: <Zap className=\"h-4 w-4\" />,\n  task_completed: <CheckSquare className=\"h-4 w-4\" />,\n  task_assigned: <FileText className=\"h-4 w-4\" />,\n  task_reminder: <Bell className=\"h-4 w-4\" />,\n  mention: <Star className=\"h-4 w-4\" />,\n  share: <Share2 className=\"h-4 w-4\" />,\n  follow: <Heart className=\"h-4 w-4\" />,\n  new_feature: <Gift className=\"h-4 w-4\" />,\n  tips: <TrendingUp className=\"h-4 w-4\" />,\n};\n\nfunction NotificationsSection() {\n  const { user } = useAuth();\n  const userId = user?.id;\n  const queryClient = useQueryClient();\n\n  const { data: eventTypes, isLoading: isLoadingEventTypes } = useQuery<NotificationEventType[]>({\n    queryKey: ['/api/notification-event-types'],\n    queryFn: async () => {\n      const res = await fetch('/api/notification-event-types');\n      if (!res.ok) throw new Error('Failed to fetch event types');\n      return res.json();\n    },\n  });\n\n  const { data: preferences, isLoading: isLoadingPreferences } = useQuery<NotificationPreference[]>({\n    queryKey: ['/api/users', userId, 'notification-preferences'],\n    queryFn: async () => {\n      const res = await fetch(`/api/users/${userId}/notification-preferences`);\n      if (!res.ok) throw new Error('Failed to fetch preferences');\n      return res.json();\n    },\n    enabled: !!userId,\n  });\n\n  const updatePreference = useMutation({\n    mutationFn: async (data: { eventTypeId: string; channels?: string; enabled?: boolean }) => {\n      const res = await fetch(`/api/users/${userId}/notification-preferences`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) throw new Error('Failed to update preference');\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'notification-preferences'] });\n    },\n  });\n\n  const getPreferenceForEventType = (eventTypeId: string): NotificationPreference | undefined => {\n    return preferences?.find(p => p.eventTypeId === eventTypeId);\n  };\n\n  const groupedEventTypes = eventTypes?.reduce((acc, eventType) => {\n    const category = eventType.category || 'other';\n    if (!acc[category]) {\n      acc[category] = [];\n    }\n    acc[category].push(eventType);\n    return acc;\n  }, {} as Record<string, NotificationEventType[]>) || {};\n\n  const categoryOrder = ['ai_updates', 'tasks', 'social', 'product'];\n\n  if (isLoadingEventTypes || isLoadingPreferences) {\n    return (\n      <div className=\"space-y-6\">\n        <div>\n          <h2 className=\"text-xl font-semibold\" data-testid=\"text-notifications-title\">Preferencias de Notificaciones</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\" data-testid=\"text-notifications-description\">\n            Configura cómo y cuándo recibir notificaciones\n          </p>\n        </div>\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" data-testid=\"spinner-loading\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h2 className=\"text-xl font-semibold\" data-testid=\"text-notifications-title\">Preferencias de Notificaciones</h2>\n        <p className=\"text-sm text-muted-foreground mt-1\" data-testid=\"text-notifications-description\">\n          Configura cómo y cuándo recibir notificaciones\n        </p>\n      </div>\n\n      {categoryOrder.map((category) => {\n        const categoryEventTypes = groupedEventTypes[category];\n        if (!categoryEventTypes || categoryEventTypes.length === 0) return null;\n\n        return (\n          <div key={category} className=\"space-y-3\" data-testid={`section-category-${category}`}>\n            <div className=\"flex items-center gap-2\">\n              {categoryIcons[category]}\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\" data-testid={`text-category-${category}`}>\n                {categoryLabels[category] || category}\n              </h3>\n            </div>\n            \n            <div className=\"space-y-2\">\n              {categoryEventTypes.map((eventType) => {\n                const preference = getPreferenceForEventType(eventType.id);\n                const channels = preference?.channels || 'none';\n                const enabled = preference?.enabled ?? true;\n\n                return (\n                  <div \n                    key={eventType.id} \n                    className=\"flex items-center justify-between py-3 border-b border-border last:border-b-0\"\n                    data-testid={`row-notification-${eventType.id}`}\n                  >\n                    <div className=\"flex items-start gap-3 flex-1 min-w-0\">\n                      <div className=\"mt-0.5 text-muted-foreground\">\n                        {eventTypeIcons[eventType.id] || <Bell className=\"h-4 w-4\" />}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <span className=\"text-sm font-medium block\" data-testid={`text-event-name-${eventType.id}`}>\n                          {eventType.name}\n                        </span>\n                        <span className=\"text-xs text-muted-foreground\" data-testid={`text-event-description-${eventType.id}`}>\n                          {eventType.description}\n                        </span>\n                      </div>\n                    </div>\n                    \n                    <div className=\"flex items-center gap-3 shrink-0\">\n                      <Select \n                        value={channels}\n                        onValueChange={(value) => updatePreference.mutate({ \n                          eventTypeId: eventType.id, \n                          channels: value \n                        })}\n                        disabled={!enabled}\n                      >\n                        <SelectTrigger \n                          className=\"w-36\" \n                          data-testid={`select-channel-${eventType.id}`}\n                        >\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"none\">Ninguna</SelectItem>\n                          <SelectItem value=\"push\">Push</SelectItem>\n                          <SelectItem value=\"email\">Email</SelectItem>\n                          <SelectItem value=\"push_email\">Push y Email</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      \n                      <Switch \n                        checked={enabled}\n                        onCheckedChange={(checked) => updatePreference.mutate({ \n                          eventTypeId: eventType.id, \n                          enabled: checked \n                        })}\n                        data-testid={`switch-enabled-${eventType.id}`}\n                      />\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        );\n      })}\n\n      <Separator />\n\n      <div className=\"flex items-center justify-between\">\n        <a \n          href=\"/settings?tab=tasks\" \n          className=\"text-sm text-primary hover:underline flex items-center gap-1\"\n          data-testid=\"link-manage-tasks\"\n        >\n          <CheckSquare className=\"h-4 w-4\" />\n          Administrar tareas\n          <ChevronRight className=\"h-4 w-4\" />\n        </a>\n      </div>\n    </div>\n  );\n}\n\ninterface IntegrationProvider {\n  id: string;\n  name: string;\n  description: string | null;\n  iconUrl: string | null;\n  authType: string;\n  category: string | null;\n  isActive: string;\n}\n\ninterface IntegrationAccount {\n  id: string;\n  userId: string;\n  providerId: string;\n  displayName: string | null;\n  email: string | null;\n  status: string | null;\n}\n\ninterface IntegrationPolicy {\n  id: string;\n  userId: string;\n  enabledApps: string[];\n  autoConfirmPolicy: string | null;\n  sandboxMode: string | null;\n  maxParallelCalls: number | null;\n}\n\ninterface ToolCallLog {\n  id: string;\n  toolId: string;\n  providerId: string;\n  status: string;\n  errorMessage: string | null;\n  latencyMs: number | null;\n  createdAt: string;\n}\n\ninterface IntegrationsData {\n  accounts: IntegrationAccount[];\n  policy: IntegrationPolicy | null;\n  providers: IntegrationProvider[];\n}\n\nconst providerIcons: Record<string, React.ReactNode> = {\n  github: <Github className=\"h-5 w-5\" />,\n  figma: <Box className=\"h-5 w-5\" />,\n  slack: <MessageSquare className=\"h-5 w-5\" />,\n  notion: <FileText className=\"h-5 w-5\" />,\n  google_drive: <Globe className=\"h-5 w-5\" />,\n  canva: <Palette className=\"h-5 w-5\" />,\n};\n\nconst categoryLabelsApps: Record<string, string> = {\n  development: \"Desarrollo\",\n  design: \"Diseño\",\n  communication: \"Comunicación\",\n  productivity: \"Productividad\",\n  general: \"General\",\n};\n\ninterface SharedLink {\n  id: string;\n  resourceType: string;\n  resourceId: string;\n  token: string;\n  scope: string;\n  permissions: string;\n  expiresAt: string | null;\n  lastAccessedAt: string | null;\n  accessCount: number;\n  isRevoked: string;\n  createdAt: string;\n}\n\ninterface ArchivedChat {\n  id: string;\n  title: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface ConsentLogEntry {\n  id: string;\n  consentType: string;\n  value: string;\n  consentVersion: string;\n  createdAt: string;\n}\n\ninterface PrivacySettings {\n  trainingOptIn: boolean;\n  remoteBrowserDataAccess: boolean;\n}\n\nfunction AppsSection() {\n  const { user } = useAuth();\n  const userId = user?.id;\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const [showAdvanced, setShowAdvanced] = useState(false);\n\n  const { data: integrationsData, isLoading: isLoadingIntegrations, refetch } = useQuery<IntegrationsData>({\n    queryKey: ['/api/users', userId, 'integrations'],\n    queryFn: async () => {\n      const res = await fetch(`/api/users/${userId}/integrations`);\n      if (!res.ok) throw new Error('Failed to fetch integrations');\n      return res.json();\n    },\n    enabled: !!userId,\n  });\n\n  const { data: logsData, isLoading: isLoadingLogs } = useQuery<ToolCallLog[]>({\n    queryKey: ['/api/users', userId, 'integrations', 'logs'],\n    queryFn: async () => {\n      const res = await fetch(`/api/users/${userId}/integrations/logs?limit=10`);\n      if (!res.ok) throw new Error('Failed to fetch logs');\n      return res.json();\n    },\n    enabled: !!userId,\n  });\n\n  const updatePolicy = useMutation({\n    mutationFn: async (data: Partial<IntegrationPolicy>) => {\n      const res = await fetch(`/api/users/${userId}/integrations/policy`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) throw new Error('Failed to update policy');\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'integrations'] });\n      toast({ title: \"Configuración actualizada\", description: \"Los cambios han sido guardados.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"No se pudo actualizar la configuración.\", variant: \"destructive\" });\n    },\n  });\n\n  const connectProvider = useMutation({\n    mutationFn: async (providerId: string) => {\n      const res = await fetch(`/api/users/${userId}/integrations/${providerId}/connect`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!res.ok) throw new Error('Failed to connect');\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'integrations'] });\n      toast({ title: \"Conexión iniciada\", description: data.message || \"El proceso de conexión ha sido iniciado.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"No se pudo iniciar la conexión.\", variant: \"destructive\" });\n    },\n  });\n\n  const disconnectProvider = useMutation({\n    mutationFn: async (providerId: string) => {\n      const res = await fetch(`/api/users/${userId}/integrations/${providerId}/disconnect`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!res.ok) throw new Error('Failed to disconnect');\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'integrations'] });\n      toast({ title: \"Desconectado\", description: \"La integración ha sido desconectada.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"No se pudo desconectar la integración.\", variant: \"destructive\" });\n    },\n  });\n\n  const providers = integrationsData?.providers || [];\n  const accounts = integrationsData?.accounts || [];\n  const policy = integrationsData?.policy;\n  const logs = logsData || [];\n\n  const isProviderConnected = (providerId: string) => {\n    return accounts.some(a => a.providerId === providerId && a.status === 'active');\n  };\n\n  const isProviderEnabled = (providerId: string) => {\n    return policy?.enabledApps?.includes(providerId) ?? false;\n  };\n\n  const toggleProviderEnabled = (providerId: string, enabled: boolean) => {\n    const currentEnabled = policy?.enabledApps || [];\n    const newEnabled = enabled \n      ? [...currentEnabled, providerId]\n      : currentEnabled.filter(id => id !== providerId);\n    updatePolicy.mutate({ enabledApps: newEnabled });\n  };\n\n  const groupedProviders = providers.reduce((acc, provider) => {\n    const category = provider.category || 'general';\n    if (!acc[category]) acc[category] = [];\n    acc[category].push(provider);\n    return acc;\n  }, {} as Record<string, IntegrationProvider[]>);\n\n  if (isLoadingIntegrations) {\n    return (\n      <div className=\"space-y-6\">\n        <div>\n          <h2 className=\"text-xl font-semibold\" data-testid=\"text-apps-title\">Aplicaciones e Integraciones</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\" data-testid=\"text-apps-description\">\n            Conecta y administra las aplicaciones que MICHAT puede usar\n          </p>\n        </div>\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" data-testid=\"spinner-loading-apps\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-xl font-semibold\" data-testid=\"text-apps-title\">Aplicaciones e Integraciones</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\" data-testid=\"text-apps-description\">\n            Conecta y administra las aplicaciones que MICHAT puede usar\n          </p>\n        </div>\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          onClick={() => refetch()}\n          disabled={isLoadingIntegrations}\n          data-testid=\"button-refresh-integrations\"\n        >\n          <RefreshCw className={cn(\"h-4 w-4\", isLoadingIntegrations && \"animate-spin\")} />\n        </Button>\n      </div>\n\n      {Object.entries(groupedProviders).map(([category, categoryProviders]) => (\n        <div key={category} className=\"space-y-3\" data-testid={`section-category-${category}`}>\n          <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\" data-testid={`text-category-${category}`}>\n            {categoryLabelsApps[category] || category}\n          </h3>\n          \n          <div className=\"space-y-2\">\n            {categoryProviders.map((provider) => {\n              const connected = isProviderConnected(provider.id);\n              const enabled = isProviderEnabled(provider.id);\n              const account = accounts.find(a => a.providerId === provider.id);\n              \n              return (\n                <div \n                  key={provider.id}\n                  className=\"flex items-center justify-between p-4 rounded-lg border bg-card\"\n                  data-testid={`card-provider-${provider.id}`}\n                >\n                  <div className=\"flex items-center gap-4\">\n                    <div className={cn(\n                      \"w-10 h-10 rounded-lg flex items-center justify-center\",\n                      connected ? \"bg-primary/10 text-primary\" : \"bg-muted text-muted-foreground\"\n                    )}>\n                      {providerIcons[provider.id] || <AppWindow className=\"h-5 w-5\" />}\n                    </div>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"text-sm font-medium\" data-testid={`text-provider-name-${provider.id}`}>\n                          {provider.name}\n                        </span>\n                        {connected && (\n                          <span className=\"inline-flex items-center gap-1 text-xs text-green-600 bg-green-100 dark:bg-green-900/30 dark:text-green-400 px-2 py-0.5 rounded-full\">\n                            <CheckCircle2 className=\"h-3 w-3\" />\n                            Conectado\n                          </span>\n                        )}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground\" data-testid={`text-provider-desc-${provider.id}`}>\n                        {provider.description || 'Sin descripción'}\n                      </p>\n                      {connected && account?.email && (\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          {account.displayName || account.email}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-3\">\n                    {connected && (\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"text-xs text-muted-foreground\">Habilitado</span>\n                        <Switch\n                          checked={enabled}\n                          onCheckedChange={(checked) => toggleProviderEnabled(provider.id, checked)}\n                          data-testid={`switch-enable-${provider.id}`}\n                        />\n                      </div>\n                    )}\n                    \n                    {connected ? (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => disconnectProvider.mutate(provider.id)}\n                        disabled={disconnectProvider.isPending}\n                        className=\"text-red-500 border-red-300 hover:bg-red-50 hover:text-red-600 dark:hover:bg-red-950\"\n                        data-testid={`button-disconnect-${provider.id}`}\n                      >\n                        {disconnectProvider.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        ) : (\n                          <>\n                            <Unlink className=\"h-4 w-4 mr-1\" />\n                            Desconectar\n                          </>\n                        )}\n                      </Button>\n                    ) : (\n                      <Button\n                        variant=\"default\"\n                        size=\"sm\"\n                        onClick={() => connectProvider.mutate(provider.id)}\n                        disabled={connectProvider.isPending}\n                        data-testid={`button-connect-${provider.id}`}\n                      >\n                        {connectProvider.isPending ? (\n                          <Loader2 className=\"h-4 w-4 animate-spin\" />\n                        ) : (\n                          <>\n                            <Link className=\"h-4 w-4 mr-1\" />\n                            Conectar\n                          </>\n                        )}\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      ))}\n\n      {providers.length === 0 && (\n        <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-providers\">\n          <AppWindow className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n          <p className=\"text-sm\">No hay proveedores de integración disponibles</p>\n        </div>\n      )}\n\n      <Separator />\n\n      <div className=\"space-y-3\">\n        <button\n          onClick={() => setShowAdvanced(!showAdvanced)}\n          className=\"w-full flex items-center justify-between py-3 hover:bg-muted/50 transition-colors rounded-lg px-2\"\n          data-testid=\"button-advanced-config\"\n        >\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center\">\n              <Settings className=\"h-5 w-5 text-muted-foreground\" />\n            </div>\n            <span className=\"text-sm font-medium\">Configuración avanzada</span>\n          </div>\n          <ChevronRight className={cn(\"h-5 w-5 text-muted-foreground transition-transform\", showAdvanced && \"rotate-90\")} />\n        </button>\n        \n        {showAdvanced && (\n          <div className=\"space-y-4 pl-4 border-l-2 border-muted ml-5\">\n            <div className=\"flex items-center justify-between py-2\">\n              <div>\n                <span className=\"text-sm block\">Política de confirmación automática</span>\n                <span className=\"text-xs text-muted-foreground\">\n                  Cuándo confirmar automáticamente las acciones de las herramientas\n                </span>\n              </div>\n              <Select\n                value={policy?.autoConfirmPolicy || 'ask'}\n                onValueChange={(value) => updatePolicy.mutate({ autoConfirmPolicy: value })}\n              >\n                <SelectTrigger className=\"w-36\" data-testid=\"select-auto-confirm\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"always\">Siempre</SelectItem>\n                  <SelectItem value=\"ask\">Preguntar</SelectItem>\n                  <SelectItem value=\"never\">Nunca</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex items-center justify-between py-2\">\n              <div>\n                <span className=\"text-sm block\">Modo sandbox</span>\n                <span className=\"text-xs text-muted-foreground\">\n                  Ejecutar acciones en modo de prueba cuando esté disponible\n                </span>\n              </div>\n              <Switch\n                checked={policy?.sandboxMode === 'true'}\n                onCheckedChange={(checked) => updatePolicy.mutate({ sandboxMode: checked ? 'true' : 'false' })}\n                data-testid=\"switch-sandbox-mode\"\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between py-2\">\n              <div>\n                <span className=\"text-sm block\">Llamadas paralelas máximas</span>\n                <span className=\"text-xs text-muted-foreground\">\n                  Número máximo de herramientas ejecutadas simultáneamente\n                </span>\n              </div>\n              <Input\n                type=\"number\"\n                min={1}\n                max={10}\n                value={policy?.maxParallelCalls || 3}\n                onChange={(e) => updatePolicy.mutate({ maxParallelCalls: parseInt(e.target.value) || 3 })}\n                className=\"w-20 text-center\"\n                data-testid=\"input-max-parallel\"\n              />\n            </div>\n          </div>\n        )}\n      </div>\n\n      <Separator />\n\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">\n            Registro de llamadas recientes\n          </h3>\n          {isLoadingLogs && <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground\" />}\n        </div>\n\n        {logs.length > 0 ? (\n          <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n            {logs.map((log) => (\n              <div \n                key={log.id}\n                className=\"flex items-center justify-between p-3 rounded-lg bg-muted/30 text-sm\"\n                data-testid={`log-entry-${log.id}`}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <div className={cn(\n                    \"w-6 h-6 rounded-full flex items-center justify-center\",\n                    log.status === 'success' ? \"bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400\" :\n                    log.status === 'error' ? \"bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400\" :\n                    \"bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400\"\n                  )}>\n                    {log.status === 'success' ? <CheckCircle2 className=\"h-3 w-3\" /> :\n                     log.status === 'error' ? <XCircle className=\"h-3 w-3\" /> :\n                     <Clock className=\"h-3 w-3\" />}\n                  </div>\n                  <div>\n                    <span className=\"font-medium\">{log.toolId}</span>\n                    <span className=\"text-xs text-muted-foreground ml-2\">\n                      {log.providerId}\n                    </span>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\n                  {log.latencyMs && <span>{log.latencyMs}ms</span>}\n                  <span>{new Date(log.createdAt).toLocaleTimeString()}</span>\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-center py-4 text-muted-foreground\" data-testid=\"text-no-logs\">\n            <Clock className=\"h-6 w-6 mx-auto mb-2 opacity-50\" />\n            <p className=\"text-sm\">No hay registros de llamadas recientes</p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction DataControlsSection() {\n  const { user } = useAuth();\n  const userId = user?.id;\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const [showArchivedDialog, setShowArchivedDialog] = useState(false);\n  const [showSharedLinksDialog, setShowSharedLinksDialog] = useState(false);\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n  const [showArchiveConfirm, setShowArchiveConfirm] = useState(false);\n\n  const { data: privacyData, isLoading: isLoadingPrivacy } = useQuery<{\n    privacySettings: PrivacySettings;\n    consentHistory: ConsentLogEntry[];\n  }>({\n    queryKey: ['/api/users', userId, 'privacy'],\n    queryFn: async () => {\n      const res = await fetch(`/api/users/${userId}/privacy`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch privacy settings');\n      return res.json();\n    },\n    enabled: !!userId,\n  });\n\n  const { data: sharedLinks = [], isLoading: isLoadingLinks } = useQuery<SharedLink[]>({\n    queryKey: ['/api/users', userId, 'shared-links'],\n    queryFn: async () => {\n      const res = await fetch(`/api/users/${userId}/shared-links`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch shared links');\n      return res.json();\n    },\n    enabled: !!userId,\n  });\n\n  const { data: archivedChats = [], isLoading: isLoadingArchived } = useQuery<ArchivedChat[]>({\n    queryKey: ['/api/users', userId, 'chats', 'archived'],\n    queryFn: async () => {\n      const res = await fetch(`/api/users/${userId}/chats/archived`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch archived chats');\n      return res.json();\n    },\n    enabled: !!userId,\n  });\n\n  const updatePrivacy = useMutation({\n    mutationFn: async (data: Partial<PrivacySettings>) => {\n      const res = await fetch(`/api/users/${userId}/privacy`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) throw new Error('Failed to update');\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'privacy'] });\n      toast({ title: \"Preferencias actualizadas\", description: \"Tus preferencias de privacidad han sido guardadas.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"No se pudo actualizar la configuración.\", variant: \"destructive\" });\n    },\n  });\n\n  const revokeLink = useMutation({\n    mutationFn: async (linkId: string) => {\n      const res = await fetch(`/api/users/${userId}/shared-links/${linkId}`, { method: 'DELETE', credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to revoke');\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'shared-links'] });\n      toast({ title: \"Enlace revocado\", description: \"El enlace compartido ha sido revocado.\" });\n    },\n  });\n\n  const unarchiveChat = useMutation({\n    mutationFn: async (chatId: string) => {\n      const res = await fetch(`/api/users/${userId}/chats/${chatId}/restore`, { method: 'POST', credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to unarchive');\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'chats', 'archived'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/chats'] });\n      toast({ title: \"Chat restaurado\", description: \"El chat ha sido restaurado.\" });\n    },\n  });\n\n  const archiveAll = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(`/api/users/${userId}/chats/archive-all`, { method: 'POST', credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to archive all');\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/chats'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/users', userId, 'chats', 'archived'] });\n      toast({ title: \"Chats archivados\", description: `Se archivaron ${data.count} chats.` });\n      setShowArchiveConfirm(false);\n    },\n  });\n\n  const deleteAll = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(`/api/users/${userId}/chats/delete-all`, { method: 'POST', credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to delete all');\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/chats'] });\n      toast({ title: \"Chats eliminados\", description: `Se eliminaron ${data.count} chats.` });\n      setShowDeleteConfirm(false);\n    },\n  });\n\n  const privacySettings = privacyData?.privacySettings || { trainingOptIn: false, remoteBrowserDataAccess: false };\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-xl font-semibold\" data-testid=\"text-data-controls-title\">Controles de datos</h2>\n      \n      <div className=\"space-y-1\">\n        <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Privacidad</h3>\n        <div className=\"space-y-3 pt-2\">\n          <div className=\"flex items-center justify-between py-3 px-2 rounded-lg hover:bg-muted/50\">\n            <div className=\"flex-1 pr-4\">\n              <span className=\"text-sm block\">Mejora el modelo para todos</span>\n              <span className=\"text-xs text-muted-foreground\">\n                Permite que tu contenido (prompts, respuestas, adjuntos) se use para mejorar los modelos de IA.\n              </span>\n            </div>\n            <Switch \n              checked={privacySettings.trainingOptIn}\n              onCheckedChange={(checked) => updatePrivacy.mutate({ trainingOptIn: checked })}\n              disabled={updatePrivacy.isPending || isLoadingPrivacy}\n              data-testid=\"switch-training-opt-in\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between py-3 px-2 rounded-lg hover:bg-muted/50\">\n            <div className=\"flex-1 pr-4\">\n              <span className=\"text-sm block\">Datos del navegador remoto</span>\n              <span className=\"text-xs text-muted-foreground\">\n                Permite que MICHAT acceda a datos de sesiones de navegación remota (cookies, DOM, capturas).\n              </span>\n            </div>\n            <Switch \n              checked={privacySettings.remoteBrowserDataAccess}\n              onCheckedChange={(checked) => updatePrivacy.mutate({ remoteBrowserDataAccess: checked })}\n              disabled={updatePrivacy.isPending || isLoadingPrivacy}\n              data-testid=\"switch-remote-browser\"\n            />\n          </div>\n        </div>\n      </div>\n\n      <Separator />\n\n      <div className=\"space-y-1\">\n        <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Enlaces compartidos</h3>\n        <div className=\"flex items-center justify-between py-3 px-2\">\n          <div>\n            <span className=\"text-sm block\">Administrar enlaces</span>\n            <span className=\"text-xs text-muted-foreground\">\n              {sharedLinks.filter(l => l.isRevoked === 'false').length} enlaces activos\n            </span>\n          </div>\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            onClick={() => setShowSharedLinksDialog(true)}\n            data-testid=\"button-manage-links\"\n          >\n            Administrar\n          </Button>\n        </div>\n      </div>\n\n      <Separator />\n\n      <div className=\"space-y-1\">\n        <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Gestión de chats</h3>\n        <div className=\"space-y-3 pt-2\">\n          <div className=\"flex items-center justify-between py-3 px-2\">\n            <div>\n              <span className=\"text-sm block\">Chats archivados</span>\n              <span className=\"text-xs text-muted-foreground\">\n                {archivedChats.length} chats archivados\n              </span>\n            </div>\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              onClick={() => setShowArchivedDialog(true)}\n              data-testid=\"button-manage-archived\"\n            >\n              Administrar\n            </Button>\n          </div>\n\n          <div className=\"flex items-center justify-between py-3 px-2\">\n            <span className=\"text-sm\">Archivar todos los chats</span>\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              onClick={() => setShowArchiveConfirm(true)}\n              disabled={archiveAll.isPending}\n              data-testid=\"button-archive-all\"\n            >\n              {archiveAll.isPending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : \"Archivar todo\"}\n            </Button>\n          </div>\n\n          <div className=\"flex items-center justify-between py-3 px-2\">\n            <span className=\"text-sm\">Eliminar todos los chats</span>\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              className=\"text-red-500 border-red-300 hover:bg-red-50 hover:text-red-600 dark:hover:bg-red-950\"\n              onClick={() => setShowDeleteConfirm(true)}\n              disabled={deleteAll.isPending}\n              data-testid=\"button-delete-all\"\n            >\n              {deleteAll.isPending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : \"Eliminar todo\"}\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      <Dialog open={showArchivedDialog} onOpenChange={setShowArchivedDialog}>\n        <DialogContent className=\"max-w-md max-h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle>Chats archivados</DialogTitle>\n          </DialogHeader>\n          <ScrollArea className=\"h-[400px] pr-4\">\n            {isLoadingArchived ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin\" />\n              </div>\n            ) : archivedChats.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground text-center py-8\">No tienes chats archivados.</p>\n            ) : (\n              <div className=\"space-y-2\">\n                {archivedChats.map((chat) => (\n                  <div key={chat.id} className=\"flex items-center justify-between p-3 border rounded-lg\" data-testid={`archived-chat-${chat.id}`}>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium truncate\">{chat.title}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {new Date(chat.createdAt).toLocaleDateString()}\n                      </p>\n                    </div>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\"\n                      onClick={() => unarchiveChat.mutate(chat.id)}\n                      disabled={unarchiveChat.isPending}\n                      data-testid={`button-unarchive-${chat.id}`}\n                    >\n                      Restaurar\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </ScrollArea>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showSharedLinksDialog} onOpenChange={setShowSharedLinksDialog}>\n        <DialogContent className=\"max-w-lg max-h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle>Enlaces compartidos</DialogTitle>\n          </DialogHeader>\n          <ScrollArea className=\"h-[400px] pr-4\">\n            {isLoadingLinks ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin\" />\n              </div>\n            ) : sharedLinks.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground text-center py-8\">No tienes enlaces compartidos.</p>\n            ) : (\n              <div className=\"space-y-2\">\n                {sharedLinks.map((link) => (\n                  <div key={link.id} className={cn(\"p-3 border rounded-lg\", link.isRevoked === 'true' && \"opacity-50\")} data-testid={`shared-link-${link.id}`}>\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2\">\n                          <Share2 className=\"h-4 w-4 text-muted-foreground\" />\n                          <span className=\"text-sm font-medium capitalize\">{link.resourceType}</span>\n                          <span className={cn(\n                            \"text-xs px-2 py-0.5 rounded-full\",\n                            link.scope === 'public' ? \"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300\" :\n                            link.scope === 'organization' ? \"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300\" :\n                            \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\"\n                          )}>\n                            {link.scope === 'public' ? 'Público' : link.scope === 'organization' ? 'Organización' : 'Solo con enlace'}\n                          </span>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          Creado: {new Date(link.createdAt).toLocaleDateString()} · {link.accessCount} accesos\n                        </p>\n                      </div>\n                      {link.isRevoked === 'false' && (\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          className=\"text-red-500 hover:text-red-600\"\n                          onClick={() => revokeLink.mutate(link.id)}\n                          disabled={revokeLink.isPending}\n                          data-testid={`button-revoke-${link.id}`}\n                        >\n                          Revocar\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </ScrollArea>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={showArchiveConfirm} onOpenChange={setShowArchiveConfirm}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>¿Archivar todos los chats?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Todos tus chats serán archivados. Podrás restaurarlos desde \"Chats archivados\".\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction onClick={() => archiveAll.mutate()}>\n              Archivar todo\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>¿Eliminar todos los chats?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Esta acción eliminará todos tus chats. Tendrás un período de recuperación antes de que se eliminen permanentemente.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={() => deleteAll.mutate()}\n              className=\"bg-red-500 hover:bg-red-600\"\n            >\n              Eliminar todo\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n\nexport function SettingsDialog({ open, onOpenChange }: SettingsDialogProps) {\n  const [activeSection, setActiveSection] = useState<SettingsSection>(\"general\");\n  const [playingVoice, setPlayingVoice] = useState<string | null>(null);\n  const [showLogoutAllConfirm, setShowLogoutAllConfirm] = useState(false);\n  \n  const { settings, updateSetting } = useSettingsContext();\n  const { language: currentLanguage, setLanguage: setAppLanguage, supportedLanguages } = useLanguage();\n  const { toast } = useToast();\n  const { logout } = useAuth();\n\n  const handleLanguageChange = (value: string) => {\n    if (value !== \"auto\") {\n      setAppLanguage(value as any);\n    }\n  };\n\n  const playVoicePreview = (voiceId: string) => {\n    setPlayingVoice(voiceId);\n    const utterance = new SpeechSynthesisUtterance(\"Hola, soy tu asistente virtual. ¿En qué puedo ayudarte hoy?\");\n    utterance.lang = \"es-ES\";\n    utterance.rate = 1;\n    utterance.pitch = voiceId === \"ember\" ? 1.2 : voiceId === \"breeze\" ? 0.9 : 1;\n    utterance.onend = () => setPlayingVoice(null);\n    utterance.onerror = () => setPlayingVoice(null);\n    window.speechSynthesis.cancel();\n    window.speechSynthesis.speak(utterance);\n  };\n\n  const handleLogout = () => {\n    logout();\n    onOpenChange(false);\n    toast({ title: \"Sesión cerrada\", description: \"Has cerrado sesión correctamente.\" });\n  };\n\n  const handleLogoutAll = () => {\n    logout();\n    onOpenChange(false);\n    toast({ title: \"Todas las sesiones cerradas\", description: \"Se han cerrado todas las sesiones activas.\" });\n    setShowLogoutAllConfirm(false);\n  };\n\n  const renderSectionContent = () => {\n    switch (activeSection) {\n      case \"general\":\n        return (\n          <div className=\"space-y-6\">\n            <h2 className=\"text-xl font-semibold\">General</h2>\n            \n            {/* Display Section */}\n            <div className=\"space-y-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Pantalla</h3>\n              <div className=\"space-y-3 pt-2\">\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Tema</span>\n                    <span className=\"text-xs text-muted-foreground\">Selecciona el aspecto visual de la aplicación</span>\n                  </div>\n                  <Select \n                    value={settings.appearance} \n                    onValueChange={(value) => updateSetting(\"appearance\", value as any)}\n                  >\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-appearance\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"system\">Sistema</SelectItem>\n                      <SelectItem value=\"light\">Claro</SelectItem>\n                      <SelectItem value=\"dark\">Oscuro</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Color de acento</span>\n                    <span className=\"text-xs text-muted-foreground\">Color principal de la interfaz</span>\n                  </div>\n                  <Select \n                    value={settings.accentColor} \n                    onValueChange={(value) => updateSetting(\"accentColor\", value as any)}\n                  >\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-accent-color\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"default\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-3 h-3 rounded-full bg-foreground\" />\n                          Predeterminada\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"blue\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                          Azul\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"green\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-3 h-3 rounded-full bg-green-500\" />\n                          Verde\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"purple\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-3 h-3 rounded-full bg-purple-500\" />\n                          Morado\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"orange\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-3 h-3 rounded-full bg-orange-500\" />\n                          Naranja\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"pink\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-3 h-3 rounded-full bg-pink-500\" />\n                          Rosa\n                        </div>\n                      </SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Tamaño de fuente</span>\n                    <span className=\"text-xs text-muted-foreground\">Ajusta el tamaño del texto</span>\n                  </div>\n                  <Select \n                    value={settings.fontSize} \n                    onValueChange={(value) => updateSetting(\"fontSize\", value as any)}\n                  >\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-font-size\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"small\">Pequeño</SelectItem>\n                      <SelectItem value=\"medium\">Mediano</SelectItem>\n                      <SelectItem value=\"large\">Grande</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Densidad</span>\n                    <span className=\"text-xs text-muted-foreground\">Espaciado entre elementos</span>\n                  </div>\n                  <Select \n                    value={settings.density} \n                    onValueChange={(value) => updateSetting(\"density\", value as any)}\n                  >\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-density\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"compact\">Compacto</SelectItem>\n                      <SelectItem value=\"comfortable\">Cómodo</SelectItem>\n                      <SelectItem value=\"spacious\">Espacioso</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Language & Region Section */}\n            <div className=\"space-y-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Idioma y región</h3>\n              <div className=\"space-y-3 pt-2\">\n                <div className=\"flex items-center justify-between py-2\">\n                  <span className=\"text-sm\">Idioma de la interfaz</span>\n                  <Select value={currentLanguage} onValueChange={handleLanguageChange}>\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-language\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {supportedLanguages.map(lang => (\n                        <SelectItem key={lang.code} value={lang.code}>{lang.name}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Idioma hablado</span>\n                    <span className=\"text-xs text-muted-foreground\">Para reconocimiento de voz</span>\n                  </div>\n                  <Select \n                    value={settings.spokenLanguage} \n                    onValueChange={(value) => updateSetting(\"spokenLanguage\", value)}\n                  >\n                    <SelectTrigger className=\"w-40 shrink-0\" data-testid=\"select-spoken-language\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"auto\">Automático</SelectItem>\n                      <SelectItem value=\"es\">Español</SelectItem>\n                      <SelectItem value=\"en\">English</SelectItem>\n                      <SelectItem value=\"fr\">Français</SelectItem>\n                      <SelectItem value=\"de\">Deutsch</SelectItem>\n                      <SelectItem value=\"pt\">Português</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <span className=\"text-sm\">Formato de fecha</span>\n                  <Select \n                    value={settings.dateFormat} \n                    onValueChange={(value) => updateSetting(\"dateFormat\", value as any)}\n                  >\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-date-format\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"dd/mm/yyyy\">DD/MM/AAAA</SelectItem>\n                      <SelectItem value=\"mm/dd/yyyy\">MM/DD/AAAA</SelectItem>\n                      <SelectItem value=\"yyyy-mm-dd\">AAAA-MM-DD</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <span className=\"text-sm\">Formato de hora</span>\n                  <Select \n                    value={settings.timeFormat} \n                    onValueChange={(value) => updateSetting(\"timeFormat\", value as any)}\n                  >\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-time-format\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"24h\">24 horas</SelectItem>\n                      <SelectItem value=\"12h\">12 horas (AM/PM)</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Voice & Audio Section */}\n            <div className=\"space-y-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Voz y audio</h3>\n              <div className=\"space-y-3 pt-2\">\n                <div className=\"flex items-center justify-between py-2\">\n                  <span className=\"text-sm\">Voz del asistente</span>\n                  <div className=\"flex items-center gap-2\">\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      className=\"gap-1\"\n                      onClick={() => playVoicePreview(settings.voice)}\n                      disabled={playingVoice !== null}\n                      data-testid=\"button-play-voice\"\n                    >\n                      {playingVoice === settings.voice ? (\n                        <Volume2 className=\"h-3 w-3 animate-pulse\" />\n                      ) : (\n                        <Play className=\"h-3 w-3\" />\n                      )}\n                    </Button>\n                    <Select \n                      value={settings.voice} \n                      onValueChange={(value) => updateSetting(\"voice\", value)}\n                    >\n                      <SelectTrigger className=\"w-28\" data-testid=\"select-voice\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {voices.map((voice) => (\n                          <SelectItem key={voice.id} value={voice.id}>\n                            {voice.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Reproducir respuestas automáticamente</span>\n                    <span className=\"text-xs text-muted-foreground\">Lee las respuestas en voz alta</span>\n                  </div>\n                  <Switch \n                    checked={settings.autoPlayResponses} \n                    onCheckedChange={(checked) => updateSetting(\"autoPlayResponses\", checked)}\n                    data-testid=\"switch-auto-play\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Modo de voz independiente</span>\n                    <span className=\"text-xs text-muted-foreground\">Pantalla completa sin elementos visuales</span>\n                  </div>\n                  <Switch \n                    checked={settings.independentVoiceMode} \n                    onCheckedChange={(checked) => updateSetting(\"independentVoiceMode\", checked)}\n                    data-testid=\"switch-voice-mode\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* AI Models Section */}\n            <div className=\"space-y-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Modelos de IA</h3>\n              <div className=\"space-y-3 pt-2\">\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Modelo predeterminado</span>\n                    <span className=\"text-xs text-muted-foreground\">Modelo para nuevas conversaciones</span>\n                  </div>\n                  <Select \n                    value={settings.defaultModel} \n                    onValueChange={(value) => updateSetting(\"defaultModel\", value)}\n                  >\n                    <SelectTrigger className=\"w-48\" data-testid=\"select-default-model\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"gemini-2.5-flash\">Gemini 2.5 Flash</SelectItem>\n                      <SelectItem value=\"gemini-2.5-pro\">Gemini 2.5 Pro</SelectItem>\n                      <SelectItem value=\"grok-3-fast\">Grok 3 Fast</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Mostrar modelos adicionales</span>\n                    <span className=\"text-xs text-muted-foreground\">Ver todos los modelos disponibles</span>\n                  </div>\n                  <Switch \n                    checked={settings.showAdditionalModels} \n                    onCheckedChange={(checked) => updateSetting(\"showAdditionalModels\", checked)}\n                    data-testid=\"switch-additional-models\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Transmitir respuestas</span>\n                    <span className=\"text-xs text-muted-foreground\">Ver las respuestas mientras se generan</span>\n                  </div>\n                  <Switch \n                    checked={settings.streamResponses} \n                    onCheckedChange={(checked) => updateSetting(\"streamResponses\", checked)}\n                    data-testid=\"switch-stream\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Accessibility Section */}\n            <div className=\"space-y-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Accesibilidad</h3>\n              <div className=\"space-y-3 pt-2\">\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Atajos de teclado</span>\n                    <span className=\"text-xs text-muted-foreground\">Habilitar navegación con teclado</span>\n                  </div>\n                  <Switch \n                    checked={settings.keyboardShortcuts} \n                    onCheckedChange={(checked) => updateSetting(\"keyboardShortcuts\", checked)}\n                    data-testid=\"switch-keyboard\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Reducir movimiento</span>\n                    <span className=\"text-xs text-muted-foreground\">Minimizar animaciones</span>\n                  </div>\n                  <Switch \n                    checked={settings.reducedMotion} \n                    onCheckedChange={(checked) => updateSetting(\"reducedMotion\", checked)}\n                    data-testid=\"switch-motion\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between py-2\">\n                  <div>\n                    <span className=\"text-sm block\">Alto contraste</span>\n                    <span className=\"text-xs text-muted-foreground\">Mejorar visibilidad de elementos</span>\n                  </div>\n                  <Switch \n                    checked={settings.highContrast} \n                    onCheckedChange={(checked) => updateSetting(\"highContrast\", checked)}\n                    data-testid=\"switch-contrast\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n        );\n\n      case \"notifications\":\n        return <NotificationsSection />;\n\n      case \"personalization\":\n        return (\n          <div className=\"space-y-6\">\n            <h2 className=\"text-xl font-semibold\">Personalización</h2>\n            \n            <div className=\"space-y-2\">\n              <div className=\"flex items-start justify-between\">\n                <div>\n                  <span className=\"text-sm font-medium\">Estilo y tonos de base</span>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Configura el estilo y el tono que MICHAT utiliza al responder.\n                  </p>\n                </div>\n                <Select \n                  value={settings.styleAndTone} \n                  onValueChange={(value) => updateSetting(\"styleAndTone\", value as any)}\n                >\n                  <SelectTrigger className=\"w-40\" data-testid=\"select-style-tone\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"default\">Predeterminada</SelectItem>\n                    <SelectItem value=\"formal\">Formal</SelectItem>\n                    <SelectItem value=\"casual\">Casual</SelectItem>\n                    <SelectItem value=\"concise\">Conciso</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <span className=\"text-sm font-medium\">Instrucciones personalizadas</span>\n              <Textarea \n                placeholder=\"Preferencias adicionales de comportamiento, estilo y tono\"\n                value={settings.customInstructions}\n                onChange={(e) => updateSetting(\"customInstructions\", e.target.value)}\n                className=\"min-h-[80px]\"\n                data-testid=\"textarea-custom-instructions\"\n              />\n            </div>\n\n            <Separator />\n\n            <h3 className=\"text-lg font-medium\">Acerca de ti</h3>\n\n            <div className=\"space-y-2\">\n              <span className=\"text-sm font-medium\">Apodo</span>\n              <Input \n                placeholder=\"¿Cómo debería llamarte MICHAT?\"\n                value={settings.nickname}\n                onChange={(e) => updateSetting(\"nickname\", e.target.value)}\n                data-testid=\"input-nickname\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <span className=\"text-sm font-medium\">Ocupación</span>\n              <Input \n                placeholder=\"Estudiante de ingeniería, diseñador, etc.\"\n                value={settings.occupation}\n                onChange={(e) => updateSetting(\"occupation\", e.target.value)}\n                data-testid=\"input-occupation\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <span className=\"text-sm font-medium\">Más acerca de ti</span>\n              <Textarea \n                placeholder=\"Intereses, valores o preferencias para tener en cuenta\"\n                value={settings.aboutYou}\n                onChange={(e) => updateSetting(\"aboutYou\", e.target.value)}\n                className=\"min-h-[80px]\"\n                data-testid=\"textarea-about-you\"\n              />\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Permite que MICHAT guarde y use memorias al responder.</span>\n                </div>\n                <Switch \n                  checked={settings.allowMemories} \n                  onCheckedChange={(checked) => updateSetting(\"allowMemories\", checked)}\n                  data-testid=\"switch-memories\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Consultar el historial de grabaciones</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Permite que MICHAT consulte transcripciones y notas de grabaciones anteriores.\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.allowRecordings} \n                  onCheckedChange={(checked) => updateSetting(\"allowRecordings\", checked)}\n                  data-testid=\"switch-recordings\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Búsqueda en la web</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Dejar que MICHAT busque automáticamente las respuestas en la web.\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.webSearch} \n                  onCheckedChange={(checked) => updateSetting(\"webSearch\", checked)}\n                  data-testid=\"switch-web-search\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Código</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Dejar que MICHAT ejecute el código con el Intérprete de código.\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.codeInterpreter} \n                  onCheckedChange={(checked) => updateSetting(\"codeInterpreter\", checked)}\n                  data-testid=\"switch-code\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Lienzo</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Colaborar con MICHAT en texto y código.\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.canvas} \n                  onCheckedChange={(checked) => updateSetting(\"canvas\", checked)}\n                  data-testid=\"switch-canvas\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">MICHAT Voice</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Habilitar el modo de voz en MICHAT\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.voiceMode} \n                  onCheckedChange={(checked) => updateSetting(\"voiceMode\", checked)}\n                  data-testid=\"switch-voice\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Modo de voz avanzado</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Ten conversaciones más naturales en el modo de voz.\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.advancedVoice} \n                  onCheckedChange={(checked) => updateSetting(\"advancedVoice\", checked)}\n                  data-testid=\"switch-advanced-voice\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Búsqueda del conector</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Dejar que MICHAT busque automáticamente las respuestas en las fuentes conectadas.\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.connectorSearch} \n                  onCheckedChange={(checked) => updateSetting(\"connectorSearch\", checked)}\n                  data-testid=\"switch-connector-search\"\n                />\n              </div>\n            </div>\n          </div>\n        );\n\n      case \"apps\":\n        return <AppsSection />;\n\n      case \"schedules\":\n        return (\n          <div className=\"space-y-6\">\n            <h2 className=\"text-xl font-semibold\">Programaciones</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              MICHAT puede programarse para ejecutarse nuevamente después de completar una tarea. \n              Selecciona <span className=\"inline-flex items-center\"><Calendar className=\"h-3 w-3 mx-1\" /></span> Programar en el menú de <span className=\"font-medium\">⋯</span> en una conversación para configurar ejecuciones futuras.\n            </p>\n            <Button variant=\"outline\" data-testid=\"button-manage-schedules\">\n              Administrar\n            </Button>\n          </div>\n        );\n\n      case \"data\":\n        return <DataControlsSection />;\n\n      case \"security\":\n        return (\n          <div className=\"space-y-6\">\n            <h2 className=\"text-xl font-semibold\">Seguridad</h2>\n            \n            <div className=\"space-y-4\">\n              <h3 className=\"text-base font-medium\">Autenticación multifactor (MFA)</h3>\n              \n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Aplicación de autenticación</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Usa códigos únicos desde una aplicación de autenticación.\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.authApp}\n                  onCheckedChange={(checked) => updateSetting(\"authApp\", checked)}\n                  data-testid=\"switch-auth-app\" \n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Notificaciones push</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Aprueba los inicios de sesión con una notificación push enviada a tu dispositivo de confianza\n                  </span>\n                </div>\n                <Switch \n                  checked={settings.pushNotifications}\n                  onCheckedChange={(checked) => updateSetting(\"pushNotifications\", checked)}\n                  data-testid=\"switch-push-notif\" \n                />\n              </div>\n\n              <button \n                className=\"w-full flex items-center justify-between py-3 hover:bg-muted/50 transition-colors rounded-lg px-2\"\n                data-testid=\"security-trusted-devices\"\n              >\n                <span className=\"text-sm\">Dispositivos de confianza</span>\n                <span className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                  1 <ChevronRight className=\"h-4 w-4\" />\n                </span>\n              </button>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between py-2\">\n                <span className=\"text-sm\">Cerrar la sesión en este dispositivo</span>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={handleLogout}\n                  data-testid=\"button-logout\"\n                >\n                  Cerrar sesión\n                </Button>\n              </div>\n\n              <div className=\"flex items-start justify-between py-2\">\n                <div className=\"flex-1 pr-4\">\n                  <span className=\"text-sm block\">Cerrar sesión en todos los dispositivos</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Cierra todas las sesiones activas en todos los dispositivos.\n                  </span>\n                </div>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  className=\"text-red-500 border-red-300 hover:bg-red-50 hover:text-red-600 dark:hover:bg-red-950 whitespace-nowrap\"\n                  onClick={() => setShowLogoutAllConfirm(true)}\n                  data-testid=\"button-logout-all\"\n                >\n                  Cerrar todas las sesiones\n                </Button>\n              </div>\n\n              <Separator />\n\n              <div className=\"pt-2\">\n                <h3 className=\"text-base font-medium\">Inicio de sesión seguro con MICHAT</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Inicia sesión en sitios web y aplicaciones en toda la red con la seguridad confiable de MICHAT.\n                </p>\n              </div>\n            </div>\n          </div>\n        );\n\n      case \"account\":\n        return (\n          <div className=\"space-y-6\">\n            <h2 className=\"text-xl font-semibold\">Perfil de constructor de GPT</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              Personaliza tu perfil de constructor para conectarte con usuarios de los GPT.\n            </p>\n            \n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-12 h-12 rounded-lg bg-muted flex items-center justify-center\">\n                  <Box className=\"h-6 w-6 text-muted-foreground\" />\n                </div>\n                <div>\n                  <span className=\"text-sm font-medium block\">\n                    {settings.nickname || \"PlaceholderGPT\"}\n                  </span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    Por {settings.nickname || \"Usuario\"}\n                  </span>\n                </div>\n              </div>\n              <span className=\"text-sm text-muted-foreground\">Vista previa</span>\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"font-medium\">Nombre</span>\n                <Switch \n                  checked={settings.showName}\n                  onCheckedChange={(checked) => updateSetting(\"showName\", checked)}\n                  data-testid=\"switch-show-name\" \n                />\n              </div>\n              <div className=\"flex items-center justify-between py-2\">\n                <span className=\"text-sm\">{settings.nickname || \"Usuario\"}</span>\n                <Info className=\"h-4 w-4 text-muted-foreground\" />\n              </div>\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <span className=\"font-medium\">Enlaces</span>\n              \n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex items-center gap-3\">\n                  <Globe className=\"h-5 w-5 text-muted-foreground\" />\n                </div>\n                <Select \n                  value={settings.websiteDomain || \"none\"}\n                  onValueChange={(value) => updateSetting(\"websiteDomain\", value === \"none\" ? \"\" : value)}\n                >\n                  <SelectTrigger className=\"w-48\" data-testid=\"select-domain\">\n                    <SelectValue placeholder=\"Seleccionar un dominio\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"none\">Ninguno</SelectItem>\n                    <SelectItem value=\"custom\">Dominio personalizado</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex items-center gap-3\">\n                  <Linkedin className=\"h-5 w-5 text-muted-foreground\" />\n                  <span className=\"text-sm\">LinkedIn</span>\n                </div>\n                {settings.linkedInUrl ? (\n                  <div className=\"flex items-center gap-2\">\n                    <Check className=\"h-4 w-4 text-green-500\" />\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\"\n                      onClick={() => updateSetting(\"linkedInUrl\", \"\")}\n                    >\n                      Eliminar\n                    </Button>\n                  </div>\n                ) : (\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\" \n                    onClick={() => {\n                      const url = prompt(\"Ingresa tu URL de LinkedIn:\");\n                      if (url) updateSetting(\"linkedInUrl\", url);\n                    }}\n                    data-testid=\"button-add-linkedin\"\n                  >\n                    Agregar\n                  </Button>\n                )}\n              </div>\n\n              <div className=\"flex items-center justify-between py-2\">\n                <div className=\"flex items-center gap-3\">\n                  <Github className=\"h-5 w-5 text-muted-foreground\" />\n                  <span className=\"text-sm\">GitHub</span>\n                </div>\n                {settings.githubUrl ? (\n                  <div className=\"flex items-center gap-2\">\n                    <Check className=\"h-4 w-4 text-green-500\" />\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\"\n                      onClick={() => updateSetting(\"githubUrl\", \"\")}\n                    >\n                      Eliminar\n                    </Button>\n                  </div>\n                ) : (\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\" \n                    onClick={() => {\n                      const url = prompt(\"Ingresa tu URL de GitHub:\");\n                      if (url) updateSetting(\"githubUrl\", url);\n                    }}\n                    data-testid=\"button-add-github\"\n                  >\n                    Agregar\n                  </Button>\n                )}\n              </div>\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <span className=\"font-medium\">Correo electrónico</span>\n              \n              <div className=\"flex items-center gap-3 py-2\">\n                <Mail className=\"h-5 w-5 text-muted-foreground\" />\n                <span className=\"text-sm\">usuario@ejemplo.com</span>\n              </div>\n\n              <div className=\"flex items-center gap-3 py-2\">\n                <Checkbox \n                  id=\"email-comments\" \n                  checked={settings.receiveEmailComments}\n                  onCheckedChange={(checked) => updateSetting(\"receiveEmailComments\", !!checked)}\n                  data-testid=\"checkbox-email-comments\" \n                />\n                <label htmlFor=\"email-comments\" className=\"text-sm\">\n                  Recibir correos electrónicos con comentarios\n                </label>\n              </div>\n            </div>\n          </div>\n        );\n\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <>\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"max-w-2xl p-0 gap-0 overflow-hidden\">\n          <div className=\"flex h-[500px]\">\n            <div className=\"w-48 border-r bg-muted/30 p-2\">\n              <div className=\"flex items-center justify-between p-2 mb-2\">\n                <Button \n                  variant=\"ghost\" \n                  size=\"icon\" \n                  className=\"h-8 w-8\"\n                  onClick={() => onOpenChange(false)}\n                  data-testid=\"button-close-settings\"\n                >\n                  <X className=\"h-4 w-4\" />\n                </Button>\n              </div>\n              <nav className=\"space-y-1\">\n                {menuItems.map((item) => (\n                  <button\n                    key={item.id}\n                    onClick={() => setActiveSection(item.id)}\n                    className={cn(\n                      \"w-full flex items-center gap-3 px-3 py-2 text-sm rounded-md transition-colors\",\n                      activeSection === item.id \n                        ? \"bg-background font-medium\" \n                        : \"hover:bg-background/50 text-muted-foreground\"\n                    )}\n                    data-testid={`settings-menu-${item.id}`}\n                  >\n                    {item.icon}\n                    {item.label}\n                  </button>\n                ))}\n              </nav>\n            </div>\n            \n            <div className=\"flex-1 p-6 overflow-y-auto\">\n              {renderSectionContent()}\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={showLogoutAllConfirm} onOpenChange={setShowLogoutAllConfirm}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>¿Cerrar todas las sesiones?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Se cerrarán todas las sesiones activas en todos los dispositivos, incluida tu sesión actual.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={handleLogoutAll}\n              className=\"bg-red-500 hover:bg-red-600\"\n            >\n              Cerrar todas las sesiones\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </>\n  );\n}\n","path":null,"size_bytes":86473,"size_tokens":null},"client/src/lib/i18n.ts":{"content":"type TranslationKeys = {\n  welcome: string;\n  placeholder: string;\n  send: string;\n  newChat: string;\n  upgrade: string;\n  upgradeFull: string;\n  thinking: string;\n  copy: string;\n  copied: string;\n  share: string;\n  settings: string;\n  logout: string;\n  login: string;\n  disclaimer: string;\n  today: string;\n  yesterday: string;\n  previous7Days: string;\n  previous30Days: string;\n  older: string;\n  deleteChat: string;\n  confirmDelete: string;\n  cancel: string;\n  confirm: string;\n  search: string;\n  noResults: string;\n  loading: string;\n  error: string;\n  retry: string;\n  plans: {\n    free: string;\n    go: string;\n    plus: string;\n    pro: string;\n    business: string;\n    enterprise: string;\n  };\n  planDescriptions: {\n    free: string;\n    go: string;\n    plus: string;\n    pro: string;\n  };\n};\n\nconst translations: Record<string, TranslationKeys> = {\n  es: {\n    welcome: \"¿En qué puedo ayudarte hoy?\",\n    placeholder: \"Escribe tu mensaje\",\n    send: \"Enviar\",\n    newChat: \"Nuevo chat\",\n    upgrade: \"Mejorar\",\n    upgradeFull: \"Mejorar el plan a Go\",\n    thinking: \"Pensando\",\n    copy: \"Copiar\",\n    copied: \"Copiado\",\n    share: \"Compartir\",\n    settings: \"Configuración\",\n    logout: \"Cerrar sesión\",\n    login: \"Iniciar sesión\",\n    disclaimer: \"MICHAT puede cometer errores. Verifica la información importante.\",\n    today: \"Hoy\",\n    yesterday: \"Ayer\",\n    previous7Days: \"Últimos 7 días\",\n    previous30Days: \"Últimos 30 días\",\n    older: \"Más antiguo\",\n    deleteChat: \"Eliminar chat\",\n    confirmDelete: \"¿Estás seguro de que quieres eliminar este chat?\",\n    cancel: \"Cancelar\",\n    confirm: \"Confirmar\",\n    search: \"Buscar\",\n    noResults: \"Sin resultados\",\n    loading: \"Cargando...\",\n    error: \"Error\",\n    retry: \"Reintentar\",\n    plans: {\n      free: \"Gratis\",\n      go: \"Go\",\n      plus: \"Plus\",\n      pro: \"Pro\",\n      business: \"Business\",\n      enterprise: \"Enterprise\",\n    },\n    planDescriptions: {\n      free: \"Mira lo que la IA puede hacer\",\n      go: \"Logra más con una IA más avanzada\",\n      plus: \"Descubre toda la experiencia\",\n      pro: \"Maximiza tu productividad\",\n    },\n  },\n  en: {\n    welcome: \"How can I help you today?\",\n    placeholder: \"Type your message\",\n    send: \"Send\",\n    newChat: \"New chat\",\n    upgrade: \"Upgrade\",\n    upgradeFull: \"Upgrade to Go\",\n    thinking: \"Thinking\",\n    copy: \"Copy\",\n    copied: \"Copied\",\n    share: \"Share\",\n    settings: \"Settings\",\n    logout: \"Log out\",\n    login: \"Log in\",\n    disclaimer: \"MICHAT can make mistakes. Check important info.\",\n    today: \"Today\",\n    yesterday: \"Yesterday\",\n    previous7Days: \"Previous 7 days\",\n    previous30Days: \"Previous 30 days\",\n    older: \"Older\",\n    deleteChat: \"Delete chat\",\n    confirmDelete: \"Are you sure you want to delete this chat?\",\n    cancel: \"Cancel\",\n    confirm: \"Confirm\",\n    search: \"Search\",\n    noResults: \"No results\",\n    loading: \"Loading...\",\n    error: \"Error\",\n    retry: \"Retry\",\n    plans: {\n      free: \"Free\",\n      go: \"Go\",\n      plus: \"Plus\",\n      pro: \"Pro\",\n      business: \"Business\",\n      enterprise: \"Enterprise\",\n    },\n    planDescriptions: {\n      free: \"See what AI can do\",\n      go: \"Achieve more with advanced AI\",\n      plus: \"Discover the full experience\",\n      pro: \"Maximize your productivity\",\n    },\n  },\n  pt: {\n    welcome: \"Como posso ajudá-lo hoje?\",\n    placeholder: \"Digite sua mensagem\",\n    send: \"Enviar\",\n    newChat: \"Novo chat\",\n    upgrade: \"Melhorar\",\n    upgradeFull: \"Melhorar para Go\",\n    thinking: \"Pensando\",\n    copy: \"Copiar\",\n    copied: \"Copiado\",\n    share: \"Compartilhar\",\n    settings: \"Configurações\",\n    logout: \"Sair\",\n    login: \"Entrar\",\n    disclaimer: \"MICHAT pode cometer erros. Verifique informações importantes.\",\n    today: \"Hoje\",\n    yesterday: \"Ontem\",\n    previous7Days: \"Últimos 7 dias\",\n    previous30Days: \"Últimos 30 dias\",\n    older: \"Mais antigo\",\n    deleteChat: \"Excluir chat\",\n    confirmDelete: \"Tem certeza de que deseja excluir este chat?\",\n    cancel: \"Cancelar\",\n    confirm: \"Confirmar\",\n    search: \"Buscar\",\n    noResults: \"Sem resultados\",\n    loading: \"Carregando...\",\n    error: \"Erro\",\n    retry: \"Tentar novamente\",\n    plans: {\n      free: \"Grátis\",\n      go: \"Go\",\n      plus: \"Plus\",\n      pro: \"Pro\",\n      business: \"Business\",\n      enterprise: \"Enterprise\",\n    },\n    planDescriptions: {\n      free: \"Veja o que a IA pode fazer\",\n      go: \"Alcance mais com IA avançada\",\n      plus: \"Descubra a experiência completa\",\n      pro: \"Maximize sua produtividade\",\n    },\n  },\n  fr: {\n    welcome: \"Comment puis-je vous aider aujourd'hui?\",\n    placeholder: \"Écrivez votre message\",\n    send: \"Envoyer\",\n    newChat: \"Nouveau chat\",\n    upgrade: \"Améliorer\",\n    upgradeFull: \"Passer à Go\",\n    thinking: \"Réflexion\",\n    copy: \"Copier\",\n    copied: \"Copié\",\n    share: \"Partager\",\n    settings: \"Paramètres\",\n    logout: \"Déconnexion\",\n    login: \"Connexion\",\n    disclaimer: \"MICHAT peut faire des erreurs. Vérifiez les informations importantes.\",\n    today: \"Aujourd'hui\",\n    yesterday: \"Hier\",\n    previous7Days: \"7 derniers jours\",\n    previous30Days: \"30 derniers jours\",\n    older: \"Plus ancien\",\n    deleteChat: \"Supprimer le chat\",\n    confirmDelete: \"Êtes-vous sûr de vouloir supprimer ce chat?\",\n    cancel: \"Annuler\",\n    confirm: \"Confirmer\",\n    search: \"Rechercher\",\n    noResults: \"Aucun résultat\",\n    loading: \"Chargement...\",\n    error: \"Erreur\",\n    retry: \"Réessayer\",\n    plans: {\n      free: \"Gratuit\",\n      go: \"Go\",\n      plus: \"Plus\",\n      pro: \"Pro\",\n      business: \"Business\",\n      enterprise: \"Enterprise\",\n    },\n    planDescriptions: {\n      free: \"Découvrez ce que l'IA peut faire\",\n      go: \"Accomplissez plus avec une IA avancée\",\n      plus: \"Découvrez l'expérience complète\",\n      pro: \"Maximisez votre productivité\",\n    },\n  },\n  de: {\n    welcome: \"Wie kann ich Ihnen heute helfen?\",\n    placeholder: \"Schreiben Sie Ihre Nachricht\",\n    send: \"Senden\",\n    newChat: \"Neuer Chat\",\n    upgrade: \"Upgrade\",\n    upgradeFull: \"Auf Go upgraden\",\n    thinking: \"Denken\",\n    copy: \"Kopieren\",\n    copied: \"Kopiert\",\n    share: \"Teilen\",\n    settings: \"Einstellungen\",\n    logout: \"Abmelden\",\n    login: \"Anmelden\",\n    disclaimer: \"MICHAT kann Fehler machen. Überprüfen Sie wichtige Informationen.\",\n    today: \"Heute\",\n    yesterday: \"Gestern\",\n    previous7Days: \"Letzte 7 Tage\",\n    previous30Days: \"Letzte 30 Tage\",\n    older: \"Älter\",\n    deleteChat: \"Chat löschen\",\n    confirmDelete: \"Sind Sie sicher, dass Sie diesen Chat löschen möchten?\",\n    cancel: \"Abbrechen\",\n    confirm: \"Bestätigen\",\n    search: \"Suchen\",\n    noResults: \"Keine Ergebnisse\",\n    loading: \"Laden...\",\n    error: \"Fehler\",\n    retry: \"Erneut versuchen\",\n    plans: {\n      free: \"Kostenlos\",\n      go: \"Go\",\n      plus: \"Plus\",\n      pro: \"Pro\",\n      business: \"Business\",\n      enterprise: \"Enterprise\",\n    },\n    planDescriptions: {\n      free: \"Sehen Sie, was KI kann\",\n      go: \"Erreichen Sie mehr mit fortschrittlicher KI\",\n      plus: \"Entdecken Sie das volle Erlebnis\",\n      pro: \"Maximieren Sie Ihre Produktivität\",\n    },\n  },\n};\n\nconst SUPPORTED_LANGUAGES = [\"es\", \"en\", \"pt\", \"fr\", \"de\"] as const;\ntype SupportedLanguage = typeof SUPPORTED_LANGUAGES[number];\n\nconst COUNTRY_TO_LANGUAGE: Record<string, SupportedLanguage> = {\n  ES: \"es\", MX: \"es\", AR: \"es\", CO: \"es\", CL: \"es\", PE: \"es\", VE: \"es\",\n  EC: \"es\", GT: \"es\", CU: \"es\", BO: \"es\", DO: \"es\", HN: \"es\", PY: \"es\",\n  SV: \"es\", NI: \"es\", CR: \"es\", PA: \"es\", UY: \"es\", PR: \"es\", GQ: \"es\",\n  US: \"en\", GB: \"en\", CA: \"en\", AU: \"en\", NZ: \"en\", IE: \"en\", ZA: \"en\",\n  IN: \"en\", PH: \"en\", SG: \"en\", MY: \"en\", NG: \"en\", KE: \"en\", GH: \"en\",\n  BR: \"pt\", PT: \"pt\", AO: \"pt\", MZ: \"pt\",\n  FR: \"fr\", BE: \"fr\", CH: \"fr\", LU: \"fr\", MC: \"fr\", SN: \"fr\", CI: \"fr\",\n  DE: \"de\", AT: \"de\", LI: \"de\",\n};\n\nfunction detectLanguageFromNavigator(): SupportedLanguage {\n  if (typeof navigator === \"undefined\") return \"es\";\n  \n  const browserLang = navigator.language || (navigator as any).userLanguage;\n  if (!browserLang) return \"es\";\n  \n  const langCode = browserLang.split(\"-\")[0].toLowerCase();\n  \n  if (SUPPORTED_LANGUAGES.includes(langCode as SupportedLanguage)) {\n    return langCode as SupportedLanguage;\n  }\n  \n  const countryCode = browserLang.split(\"-\")[1]?.toUpperCase();\n  if (countryCode && COUNTRY_TO_LANGUAGE[countryCode]) {\n    return COUNTRY_TO_LANGUAGE[countryCode];\n  }\n  \n  return \"es\";\n}\n\nfunction getStoredLanguage(): SupportedLanguage | null {\n  if (typeof localStorage === \"undefined\") return null;\n  const stored = localStorage.getItem(\"app_language\");\n  if (stored && SUPPORTED_LANGUAGES.includes(stored as SupportedLanguage)) {\n    return stored as SupportedLanguage;\n  }\n  return null;\n}\n\nfunction setStoredLanguage(lang: SupportedLanguage): void {\n  if (typeof localStorage !== \"undefined\") {\n    localStorage.setItem(\"app_language\", lang);\n  }\n}\n\nexport function getLanguage(): SupportedLanguage {\n  const stored = getStoredLanguage();\n  if (stored) return stored;\n  \n  const detected = detectLanguageFromNavigator();\n  setStoredLanguage(detected);\n  return detected;\n}\n\nexport function setLanguage(lang: SupportedLanguage): void {\n  setStoredLanguage(lang);\n  window.dispatchEvent(new CustomEvent(\"languageChange\", { detail: lang }));\n}\n\nexport function t(key: string): string {\n  const lang = getLanguage();\n  const keys = key.split(\".\");\n  let value: any = translations[lang] || translations.es;\n  \n  for (const k of keys) {\n    value = value?.[k];\n    if (value === undefined) break;\n  }\n  \n  if (typeof value === \"string\") return value;\n  \n  value = translations.es;\n  for (const k of keys) {\n    value = value?.[k];\n    if (value === undefined) break;\n  }\n  \n  return typeof value === \"string\" ? value : key;\n}\n\nexport function getLanguageName(code: SupportedLanguage): string {\n  const names: Record<SupportedLanguage, string> = {\n    es: \"Español\",\n    en: \"English\",\n    pt: \"Português\",\n    fr: \"Français\",\n    de: \"Deutsch\",\n  };\n  return names[code] || code;\n}\n\nexport function getSupportedLanguages(): { code: SupportedLanguage; name: string }[] {\n  return SUPPORTED_LANGUAGES.map(code => ({\n    code,\n    name: getLanguageName(code),\n  }));\n}\n\nexport type { SupportedLanguage, TranslationKeys };\nexport { SUPPORTED_LANGUAGES };\n","path":null,"size_bytes":10344,"size_tokens":null},"client/src/pages/workspace-settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { cn } from \"@/lib/utils\";\nimport { \n  ArrowLeft, \n  Settings, \n  Users, \n  Key, \n  CreditCard, \n  Bot, \n  AppWindow, \n  UsersRound, \n  BarChart3, \n  ShieldCheck,\n  Copy,\n  Upload,\n  AlertTriangle,\n  Info,\n  Search,\n  Plus,\n  MoreHorizontal,\n  ChevronDown,\n  ChevronLeft,\n  ChevronRight,\n  Filter\n} from \"lucide-react\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { SiraLogo } from \"@/components/sira-logo\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\n\ntype WorkspaceSection = \"general\" | \"members\" | \"permissions\" | \"billing\" | \"gpt\" | \"apps\" | \"groups\" | \"analytics\" | \"identity\";\n\nconst menuItems: { id: WorkspaceSection; label: string; icon: React.ReactNode }[] = [\n  { id: \"general\", label: \"General\", icon: <Settings className=\"h-4 w-4\" /> },\n  { id: \"members\", label: \"Miembros\", icon: <Users className=\"h-4 w-4\" /> },\n  { id: \"permissions\", label: \"Permisos y roles\", icon: <Key className=\"h-4 w-4\" /> },\n  { id: \"billing\", label: \"Facturación\", icon: <CreditCard className=\"h-4 w-4\" /> },\n  { id: \"gpt\", label: \"GPT\", icon: <Bot className=\"h-4 w-4\" /> },\n  { id: \"apps\", label: \"Aplicaciones\", icon: <AppWindow className=\"h-4 w-4\" /> },\n  { id: \"groups\", label: \"Grupos\", icon: <UsersRound className=\"h-4 w-4\" /> },\n  { id: \"analytics\", label: \"Análisis de usuario\", icon: <BarChart3 className=\"h-4 w-4\" /> },\n  { id: \"identity\", label: \"Identidad y acceso\", icon: <ShieldCheck className=\"h-4 w-4\" /> },\n];\n\nexport default function WorkspaceSettingsPage() {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const [activeSection, setActiveSection] = useState<WorkspaceSection>(\"general\");\n  const [workspaceName, setWorkspaceName] = useState(\"Espacio de trabajo de Usuario\");\n  \n  const orgId = \"org-jafx80c2QSREjgK800cnLCwe\";\n  const workspaceId = \"09c512b0-ee54-4546-9016-b5f13fa0477a\";\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchString);\n    const section = params.get(\"section\") as WorkspaceSection | null;\n    if (section && menuItems.some(item => item.id === section)) {\n      setActiveSection(section);\n    }\n  }, [searchString]);\n\n  const copyToClipboard = (text: string) => {\n    navigator.clipboard.writeText(text);\n  };\n\n  const renderContent = () => {\n    switch (activeSection) {\n      case \"general\":\n        return (\n          <div className=\"space-y-8\">\n            <div>\n              <h1 className=\"text-2xl font-semibold\">General</h1>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Personaliza el aspecto, el nombre, las instrucciones y más de tu espacio de trabajo.\n              </p>\n            </div>\n\n            <div className=\"space-y-6\">\n              <h2 className=\"text-lg font-medium\">Aspecto</h2>\n              \n              <div className=\"space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm\">Nombre de espacio de trabajo</span>\n                  <Input \n                    value={workspaceName}\n                    onChange={(e) => setWorkspaceName(e.target.value)}\n                    className=\"w-72\"\n                    data-testid=\"input-workspace-name\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-1\">\n                    <span className=\"text-sm\">Logotipo</span>\n                    <Info className=\"h-3 w-3 text-muted-foreground\" />\n                  </div>\n                  <div className=\"border-2 border-dashed rounded-lg p-8 flex flex-col items-center justify-center text-center\">\n                    <Upload className=\"h-8 w-8 text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">Suelta el archivo aquí para cargarlo.</p>\n                    <button className=\"text-sm text-primary hover:underline mt-1\" data-testid=\"button-browse-files\">\n                      Explorar archivos\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-6\">\n              <h2 className=\"text-lg font-medium\">Detalles del espacio de trabajo</h2>\n              \n              <div className=\"space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm\">ID de la organización</span>\n                  <div className=\"flex items-center gap-2\">\n                    <code className=\"text-sm bg-muted px-3 py-1.5 rounded font-mono\">{orgId}</code>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => copyToClipboard(orgId)}\n                      data-testid=\"button-copy-org-id\"\n                    >\n                      <Copy className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm\">ID del espacio de trabajo</span>\n                  <div className=\"flex items-center gap-2\">\n                    <code className=\"text-sm bg-muted px-3 py-1.5 rounded font-mono\">{workspaceId}</code>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => copyToClipboard(workspaceId)}\n                      data-testid=\"button-copy-workspace-id\"\n                    >\n                      <Copy className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        );\n\n      case \"members\":\n        return (\n          <div className=\"space-y-6\">\n            <div>\n              <h1 className=\"text-2xl font-semibold\">Miembros</h1>\n              <p className=\"text-sm text-muted-foreground\">Empresa · 1 miembro</p>\n            </div>\n\n            <Tabs defaultValue=\"users\" className=\"w-full\">\n              <TabsList className=\"bg-transparent border-b rounded-none w-full justify-start h-auto p-0 gap-6\">\n                <TabsTrigger \n                  value=\"users\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-0 pb-2\"\n                  data-testid=\"tab-users\"\n                >\n                  Usuarios\n                </TabsTrigger>\n                <TabsTrigger \n                  value=\"pending-invites\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-0 pb-2\"\n                  data-testid=\"tab-pending-invites\"\n                >\n                  Invitaciones pendientes\n                </TabsTrigger>\n                <TabsTrigger \n                  value=\"pending-requests\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-0 pb-2\"\n                  data-testid=\"tab-pending-requests\"\n                >\n                  Solicitudes pendientes\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"users\" className=\"mt-6 space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input \n                      placeholder=\"Filtrar por nombre\" \n                      className=\"pl-9 w-64\"\n                      data-testid=\"input-filter-members\"\n                    />\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Button variant=\"outline\" className=\"gap-2\" data-testid=\"button-invite-member\">\n                      <Plus className=\"h-4 w-4\" />\n                      Invitar a un miembro\n                    </Button>\n                    <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-members-more\">\n                      <MoreHorizontal className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n\n                <div className=\"border rounded-lg\">\n                  <div className=\"grid grid-cols-3 gap-4 px-4 py-3 border-b bg-muted/30 text-sm font-medium text-muted-foreground\">\n                    <span>Nombre</span>\n                    <span>Tipo de cuenta</span>\n                    <span>Fecha agregada</span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-4 px-4 py-3 items-center\">\n                    <div className=\"flex items-center gap-3\">\n                      <Avatar className=\"h-9 w-9\">\n                        <AvatarFallback className=\"bg-blue-100 text-blue-700 text-sm\">JC</AvatarFallback>\n                      </Avatar>\n                      <div>\n                        <span className=\"text-sm font-medium block\">Jorge Carrera (Tú)</span>\n                        <span className=\"text-xs text-muted-foreground\">carrerajorge874@gmail.com</span>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <span className=\"text-sm\">Propietario</span>\n                      <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                    </div>\n                    <span className=\"text-sm\">28 ago 2025</span>\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"pending-invites\" className=\"mt-6\">\n                <p className=\"text-sm text-muted-foreground\">No hay invitaciones pendientes.</p>\n              </TabsContent>\n\n              <TabsContent value=\"pending-requests\" className=\"mt-6\">\n                <p className=\"text-sm text-muted-foreground\">No hay solicitudes pendientes.</p>\n              </TabsContent>\n            </Tabs>\n          </div>\n        );\n\n      case \"permissions\":\n        return (\n          <div className=\"space-y-6\">\n            <div>\n              <h1 className=\"text-2xl font-semibold\">Permisos y roles</h1>\n              <p className=\"text-sm text-muted-foreground\">\n                Configura los permisos básicos para tu espacio de trabajo y personaliza el acceso con roles personalizados.\n              </p>\n            </div>\n\n            <Tabs defaultValue=\"workspace\" className=\"w-full\">\n              <TabsList className=\"bg-transparent border-b rounded-none w-full justify-start h-auto p-0\">\n                <TabsTrigger \n                  value=\"workspace\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-0 pb-2\"\n                >\n                  Espacio de trabajo\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"workspace\" className=\"mt-6 space-y-6\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input \n                    placeholder=\"Buscar 13 permisos\" \n                    className=\"pl-9 w-64\"\n                    data-testid=\"input-search-permissions\"\n                  />\n                </div>\n\n                <div className=\"space-y-8\">\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-medium\">Compartir</h3>\n                      <Badge variant=\"secondary\" className=\"text-xs\">Enterprise</Badge>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm\">Permitir que los miembros compartan un chat, canvas o un proyecto con...</span>\n                      <Select defaultValue=\"members\">\n                        <SelectTrigger className=\"w-64\" data-testid=\"select-share-permission\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"members\">Solo miembros del espacio de trabajo</SelectItem>\n                          <SelectItem value=\"anyone\">Cualquier persona</SelectItem>\n                          <SelectItem value=\"none\">Nadie</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-medium\">Memoria</h3>\n                      <Badge variant=\"secondary\" className=\"text-xs\">Enterprise</Badge>\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Permitir a los miembros usar la memoria</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Administra si los miembros pueden activar la memoria. Esto permite que MICHAT se vuelva más útil recordando detalles y preferencias a través de los chats.{\" \"}\n                          <button className=\"text-primary hover:underline\">Obtener más información</button>\n                        </span>\n                      </div>\n                      <Switch defaultChecked data-testid=\"switch-memory\" />\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Política de retención del chat</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Comunícate con el administrador de la cuenta para modificar esta configuración.\n                        </span>\n                      </div>\n                      <span className=\"text-sm\">Infinito</span>\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-medium\">Canvas</h3>\n                      <Badge variant=\"secondary\" className=\"text-xs\">Enterprise</Badge>\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Ejecución del código del lienzo</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Permitir que los miembros ejecuten fragmentos de código dentro de Canvas.\n                        </span>\n                      </div>\n                      <Switch defaultChecked data-testid=\"switch-canvas-code\" />\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Acceso a red del código en Canvas</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Permitir que los miembros ejecuten código con acceso a red dentro de Canvas.\n                        </span>\n                      </div>\n                      <Switch defaultChecked data-testid=\"switch-canvas-network\" />\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"space-y-4\">\n                    <h3 className=\"font-medium\">MICHAT Record</h3>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Administra si los usuarios pueden usar MICHAT para grabar, transcribir y resumir audio de formato largo. Las grabaciones solo se usarán para fines de transcripción y no las almacenará.{\" \"}\n                      <button className=\"text-primary hover:underline\">Obtener más información</button>\n                    </p>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <span className=\"text-sm\">Permitir que los miembros usen MICHAT Record</span>\n                      <Switch defaultChecked data-testid=\"switch-record\" />\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Permitir que MICHAT consulte notas y transcripciones anteriores.</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Permitir que los miembros consulten notas y transcripciones anteriores en MICHAT Record.\n                        </span>\n                      </div>\n                      <Switch defaultChecked data-testid=\"switch-record-notes\" />\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Permite que los miembros compartan su pantalla o video mientras usan el modo de voz.</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Permite que los miembros compartan su pantalla o video mientras usan el modo de voz.\n                        </span>\n                      </div>\n                      <Switch defaultChecked data-testid=\"switch-screen-share\" />\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-medium\">Código en macOS</h3>\n                      <Badge variant=\"secondary\" className=\"text-xs\">Enterprise</Badge>\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Permitir la edición de código en macOS</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Controla si los usuarios de este espacio de trabajo pueden permitir que MICHAT edite archivos de código al usar la aplicación de escritorio para macOS. Esto permite que MICHAT lea y edite el contenido de aplicaciones específicas en su escritorio para dar mejores respuestas.{\" \"}\n                          <button className=\"text-primary hover:underline\">Obtener más información</button>\n                        </span>\n                      </div>\n                      <Switch data-testid=\"switch-macos-code\" />\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Permitir que los miembros vinculen Apple Intelligence</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Administra si los miembros pueden vincularse con Apple Intelligence.\n                        </span>\n                      </div>\n                      <Switch defaultChecked data-testid=\"switch-apple-intelligence\" />\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"space-y-4\">\n                    <div>\n                      <h3 className=\"font-medium\">Modelos</h3>\n                      <p className=\"text-xs text-muted-foreground\">Administra el acceso de los miembros a los modelos</p>\n                    </div>\n                    <div className=\"flex items-center justify-between py-2\">\n                      <div className=\"flex-1 pr-4\">\n                        <span className=\"text-sm block\">Habilitar modelos adicionales</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Permite que los miembros usen modelos adicionales.\n                        </span>\n                      </div>\n                      <Switch defaultChecked data-testid=\"switch-additional-models\" />\n                    </div>\n                  </div>\n                </div>\n              </TabsContent>\n            </Tabs>\n          </div>\n        );\n\n      case \"billing\":\n        return (\n          <div className=\"space-y-6\">\n            <div>\n              <h1 className=\"text-2xl font-semibold\">Facturación</h1>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Ciclo actual: Nov 28 - Dec 28\n              </p>\n            </div>\n\n            <Tabs defaultValue=\"plan\" className=\"w-full\">\n              <TabsList className=\"bg-transparent border-b rounded-none w-full justify-start h-auto p-0\">\n                <TabsTrigger \n                  value=\"plan\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2\"\n                  data-testid=\"tab-billing-plan\"\n                >\n                  Plan\n                </TabsTrigger>\n                <TabsTrigger \n                  value=\"invoices\" \n                  className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2\"\n                  data-testid=\"tab-billing-invoices\"\n                >\n                  Facturas\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"plan\" className=\"mt-6 space-y-6\">\n                <div className=\"border rounded-lg p-6 space-y-4\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"space-y-1\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"font-semibold text-lg\">Plan Business</span>\n                        <Badge className=\"bg-green-100 text-green-700 hover:bg-green-100\">Mensualmente</Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">Se desactiva el 28 de diciembre de 2025</p>\n                    </div>\n                    <Select>\n                      <SelectTrigger className=\"w-auto gap-2\" data-testid=\"select-manage-plan\">\n                        <SelectValue placeholder=\"Administrar plan\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"change\">Cambiar plan</SelectItem>\n                        <SelectItem value=\"cancel\">Cancelar plan</SelectItem>\n                        <SelectItem value=\"reactivate\">Reactivar plan</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  \n                  <div className=\"pt-2\">\n                    <div className=\"flex items-baseline\">\n                      <span className=\"text-4xl font-bold\">$30</span>\n                      <span className=\"text-muted-foreground ml-1\">/participante</span>\n                    </div>\n                  </div>\n                  \n                  <p className=\"text-sm text-muted-foreground\">1/2 participantes en uso</p>\n                </div>\n\n                <div className=\"border rounded-lg p-6 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <h3 className=\"font-semibold\">Uso de créditos</h3>\n                      <p className=\"text-sm text-muted-foreground\">Próximo ciclo en 9 días</p>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" data-testid=\"button-credits-menu\">\n                        <MoreHorizontal className=\"h-4 w-4\" />\n                      </Button>\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" data-testid=\"button-credits-prev\">\n                        <ChevronLeft className=\"h-4 w-4\" />\n                      </Button>\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" data-testid=\"button-credits-next\">\n                        <ChevronRight className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                  \n                  <p className=\"text-sm\">\n                    <span className=\"font-semibold\">0</span>\n                    <span className=\"text-muted-foreground\"> / 0 créditos usados (100%)</span>\n                  </p>\n                </div>\n\n                <div className=\"border rounded-lg p-6\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-1\">\n                      <h3 className=\"font-semibold\">Agregar más créditos</h3>\n                      <p className=\"text-sm text-muted-foreground max-w-md\">\n                        Permite que tu equipo siga teniendo acceso incluso después de alcanzar los límites de su plan. Los créditos son válidos durante 12 meses.\n                      </p>\n                    </div>\n                    <Button variant=\"outline\" data-testid=\"button-add-credits\">\n                      Agregar créditos\n                    </Button>\n                  </div>\n                </div>\n\n                <Separator />\n\n                <div className=\"border rounded-lg p-6\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-1\">\n                      <h3 className=\"font-semibold\">Alertas de uso de créditos</h3>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Enviar alertas a los propietarios cuando estén por agotarse los créditos\n                      </p>\n                    </div>\n                    <Button variant=\"outline\" data-testid=\"button-manage-alerts\">\n                      Administrar\n                    </Button>\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"invoices\" className=\"mt-6\">\n                <div className=\"border rounded-lg p-6\">\n                  <p className=\"text-sm text-muted-foreground text-center py-8\">\n                    No hay facturas disponibles\n                  </p>\n                </div>\n              </TabsContent>\n            </Tabs>\n          </div>\n        );\n\n      case \"gpt\":\n        const gptItems = [\n          { id: 1, name: \"1.3 Discusiones de tesis. 2\", constructor: \"Jorge Carrera\", actions: \"—\", access: \"Enlace\", chats: 508, created: \"Jan 21\", updated: \"Dec 18\", icon: \"T20\" },\n          { id: 2, name: \"REALIDAD PROBLEMATICA LOCAL\", constructor: \"Jorge Carrera\", actions: \"—\", access: \"Enlace\", chats: 400, created: \"Jan 21\", updated: \"Dec 18\", icon: \"T20\" },\n          { id: 3, name: \"ANTECENTE DE TESIS\", constructor: \"Jorge Carrera\", actions: \"—\", access: \"Enlace\", chats: 5779, created: \"Jan 21\", updated: \"Dec 17\", icon: \"T20\" },\n          { id: 4, name: \"REALIDAD PROBLEMATICA GLOBAL\", constructor: \"Jorge Carrera\", actions: \"—\", access: \"Enlace\", chats: 669, created: \"Jan 21\", updated: \"Dec 17\", icon: \"T20\" },\n          { id: 5, name: \"BASES TEORICAS\", constructor: \"Jorge Carrera\", actions: \"—\", access: \"Enlace\", chats: 821, created: \"Jan 21\", updated: \"Dec 17\", icon: \"T20\" },\n          { id: 6, name: \"TSP CAPÍTULO III. - Problema actual.\", constructor: \"Jorge Carrera\", actions: \"—\", access: \"Enlace\", chats: 73, created: \"Feb 5\", updated: \"Dec 17\", icon: \"doc\" },\n          { id: 7, name: \"1.6. - Justificación\", constructor: \"Sin asignar\", actions: \"—\", access: \"Público\", chats: 845, created: \"Feb 20\", updated: \"Dec 17\", icon: \"doc\" },\n        ];\n        return (\n          <div className=\"space-y-8\">\n            <h1 className=\"text-2xl font-semibold\">GPT</h1>\n\n            <div className=\"space-y-4\">\n              <h2 className=\"font-medium\">Terceros</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Administra si los miembros pueden usar GPT creados fuera de tu espacio de trabajo.\n              </p>\n              <Select defaultValue=\"allow\">\n                <SelectTrigger className=\"w-40\" data-testid=\"select-third-party\">\n                  <SelectValue placeholder=\"Permitir todo\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"allow\">Permitir todo</SelectItem>\n                  <SelectItem value=\"restrict\">Restringir</SelectItem>\n                  <SelectItem value=\"block\">Bloquear</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-4\">\n              <h2 className=\"font-medium\">GPT</h2>\n              \n              <Tabs defaultValue=\"workspace\" className=\"w-full\">\n                <div className=\"flex items-center justify-between\">\n                  <TabsList className=\"bg-transparent border-b rounded-none h-auto p-0\">\n                    <TabsTrigger \n                      value=\"workspace\" \n                      className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2\"\n                      data-testid=\"tab-gpt-workspace\"\n                    >\n                      Espacio de trabajo\n                    </TabsTrigger>\n                    <TabsTrigger \n                      value=\"unassigned\" \n                      className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2\"\n                      data-testid=\"tab-gpt-unassigned\"\n                    >\n                      Sin asignar\n                    </TabsTrigger>\n                  </TabsList>\n                  <div className=\"flex items-center gap-2\">\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" data-testid=\"button-gpt-filter\">\n                      <Filter className=\"h-4 w-4\" />\n                    </Button>\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" data-testid=\"button-gpt-search\">\n                      <Search className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n\n                <TabsContent value=\"workspace\" className=\"mt-4\">\n                  <div className=\"border rounded-lg overflow-hidden\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted/50\">\n                        <tr className=\"text-left text-muted-foreground\">\n                          <th className=\"px-4 py-3 font-medium\">Nombre</th>\n                          <th className=\"px-4 py-3 font-medium\">Constructor</th>\n                          <th className=\"px-4 py-3 font-medium\">Acciones personalizadas</th>\n                          <th className=\"px-4 py-3 font-medium\">Quién tiene acceso</th>\n                          <th className=\"px-4 py-3 font-medium\">Chats</th>\n                          <th className=\"px-4 py-3 font-medium\">Creado</th>\n                          <th className=\"px-4 py-3 font-medium\">Actualiz.</th>\n                          <th className=\"px-4 py-3\"></th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {gptItems.map((item) => (\n                          <tr key={item.id} className=\"border-t hover:bg-muted/30\">\n                            <td className=\"px-4 py-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className={cn(\n                                  \"w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold\",\n                                  item.icon === \"T20\" ? \"bg-red-100 text-red-600\" : \"bg-gray-100 text-gray-600\"\n                                )}>\n                                  {item.icon === \"T20\" ? \"T20\" : \"📄\"}\n                                </div>\n                                <span className=\"font-medium text-primary hover:underline cursor-pointer\">{item.name}</span>\n                              </div>\n                            </td>\n                            <td className=\"px-4 py-3 text-muted-foreground\">{item.constructor}</td>\n                            <td className=\"px-4 py-3 text-muted-foreground\">{item.actions}</td>\n                            <td className=\"px-4 py-3 text-muted-foreground\">{item.access}</td>\n                            <td className=\"px-4 py-3 text-muted-foreground\">{item.chats}</td>\n                            <td className=\"px-4 py-3 text-muted-foreground\">{item.created}</td>\n                            <td className=\"px-4 py-3 text-muted-foreground\">{item.updated}</td>\n                            <td className=\"px-4 py-3\">\n                              <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                                <MoreHorizontal className=\"h-4 w-4\" />\n                              </Button>\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n\n                  <div className=\"flex items-center justify-center gap-4 mt-4\">\n                    <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-gpt-prev\">Anterior</Button>\n                    <span className=\"text-sm text-muted-foreground\">Página 1</span>\n                    <Button variant=\"ghost\" size=\"sm\" className=\"font-medium\" data-testid=\"button-gpt-next\">Siguiente</Button>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"unassigned\" className=\"mt-4\">\n                  <div className=\"border rounded-lg p-6\">\n                    <p className=\"text-sm text-muted-foreground text-center py-4\">\n                      No hay GPTs sin asignar\n                    </p>\n                  </div>\n                </TabsContent>\n              </Tabs>\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <h2 className=\"font-medium\">Compartir</h2>\n                <Badge variant=\"secondary\" className=\"text-xs\">Enterprise</Badge>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-sm text-muted-foreground\">Los GPT se pueden compartir con...</span>\n                <Select defaultValue=\"anyone\">\n                  <SelectTrigger className=\"w-48\" data-testid=\"select-gpt-share\">\n                    <SelectValue placeholder=\"Cualquier persona\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"anyone\">Cualquier persona</SelectItem>\n                    <SelectItem value=\"workspace\">Solo espacio de trabajo</SelectItem>\n                    <SelectItem value=\"restricted\">Restringido</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <h2 className=\"font-medium\">Acciones de GPT</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Las acciones de GPT permiten que los GPT utilicen API de terceros para tareas como recuperar o modificar datos. Las acciones de GPT son definidas por los constructores de los GPT, por lo que puedes limitar los dominios que se pueden usar para los GPT creados en tu espacio de trabajo.\n              </p>\n              <div className=\"flex items-center gap-2\">\n                <input \n                  type=\"checkbox\" \n                  id=\"allow-domains\" \n                  defaultChecked \n                  className=\"h-4 w-4 rounded border-gray-300\"\n                  data-testid=\"checkbox-allow-domains\"\n                />\n                <label htmlFor=\"allow-domains\" className=\"text-sm\">\n                  Permitir todos los dominios para acciones de GPT\n                </label>\n                <Info className=\"h-3 w-3 text-muted-foreground\" />\n              </div>\n            </div>\n          </div>\n        );\n\n      case \"apps\":\n        const appItems = [\n          { id: 1, name: \"Adobe Acrobat\", description: \"Trusted PDF editing tools\", icon: \"Ac\", bgColor: \"bg-red-600\" },\n          { id: 2, name: \"Adobe Express\", description: \"Design flyers and invites\", icon: \"Ae\", bgColor: \"bg-gradient-to-br from-purple-500 to-pink-500\" },\n          { id: 3, name: \"Adobe Photoshop\", description: \"Edit, stylize, refine images\", icon: \"Ps\", bgColor: \"bg-blue-600\" },\n          { id: 4, name: \"Agentforce Sales\", description: \"Sales insights to close deals\", icon: \"⚡\", bgColor: \"bg-blue-500\" },\n          { id: 5, name: \"Aha!\", description: \"Connect to sync Aha! product roadmaps and features for use in ChatGPT.\", icon: \"!\", bgColor: \"bg-blue-600\" },\n          { id: 6, name: \"Airtable\", description: \"Add structured data to ChatGPT\", icon: \"📊\", bgColor: \"bg-blue-400\" },\n          { id: 7, name: \"Alpaca\", description: \"Market data: stocks & crypto\", icon: \"🦙\", bgColor: \"bg-yellow-400\" },\n          { id: 8, name: \"Apple Music\", description: \"Build playlists and find music\", icon: \"♪\", bgColor: \"bg-pink-500\" },\n          { id: 9, name: \"Asana\", description: \"Convierte las tareas de Asana en actualizaciones y planes claros\", icon: \"◉\", bgColor: \"bg-orange-500\" },\n          { id: 10, name: \"Atlassian Rovo\", description: \"Manage Jira and Confluence fast\", icon: \"A\", bgColor: \"bg-blue-600\" },\n          { id: 11, name: \"Azure Boards\", description: \"Connect to sync Azure DevOps work items and repos for use in ChatGPT.\", icon: \"Az\", bgColor: \"bg-blue-500\" },\n          { id: 12, name: \"Basecamp\", description: \"Connect to sync Basecamp projects and to-dos for use in ChatGPT.\", icon: \"⛺\", bgColor: \"bg-green-600\" },\n          { id: 13, name: \"BioRender\", description: \"Science visuals on demand\", icon: \"🧬\", bgColor: \"bg-teal-500\" },\n          { id: 14, name: \"Booking.com\", description: \"Search stays worldwide\", icon: \"B\", bgColor: \"bg-blue-700\" },\n          { id: 15, name: \"Box\", description: \"Busca y consulta tus documentos\", icon: \"📦\", bgColor: \"bg-blue-500\" },\n          { id: 16, name: \"Calendario de Outlook\", description: \"Consulta eventos y disponibilidad.\", icon: \"📅\", bgColor: \"bg-blue-600\" },\n          { id: 17, name: \"Canva\", description: \"Search, create, edit designs\", icon: \"C\", bgColor: \"bg-cyan-500\" },\n          { id: 18, name: \"Clay\", description: \"Find and engage prospects\", icon: \"🏺\", bgColor: \"bg-orange-400\" },\n          { id: 19, name: \"ClickUp\", description: \"Connect to sync ClickUp tasks and docs for use in ChatGPT.\", icon: \"✓\", bgColor: \"bg-purple-600\" },\n          { id: 20, name: \"Cloudinary\", description: \"Manage, modify, and host your images & videos\", icon: \"☁\", bgColor: \"bg-blue-500\" },\n          { id: 21, name: \"Conductor\", description: \"Track brand sentiment in AI\", icon: \"C\", bgColor: \"bg-indigo-600\" },\n          { id: 22, name: \"Contactos de Google\", description: \"Consulta detalles de contacto guardados.\", icon: \"👤\", bgColor: \"bg-blue-500\" },\n          { id: 23, name: \"Correo electrónico de Outlook\", description: \"Busca y consulta tus correos electrónicos de Outlook.\", icon: \"✉\", bgColor: \"bg-blue-600\" },\n          { id: 24, name: \"Coupler.io\", description: \"Unified business data access\", icon: \"⚡\", bgColor: \"bg-purple-500\" },\n          { id: 25, name: \"Coursera\", description: \"Skill-building course videos\", icon: \"C\", bgColor: \"bg-blue-600\" },\n          { id: 26, name: \"Coveo\", description: \"Search your enterprise content\", icon: \"C\", bgColor: \"bg-orange-500\" },\n          { id: 27, name: \"Daloopa\", description: \"Financial KPIs with links\", icon: \"D\", bgColor: \"bg-blue-700\" },\n          { id: 28, name: \"Dropbox\", description: \"Encuentra y accede a tus archivos almacenados.\", icon: \"📁\", bgColor: \"bg-blue-500\" },\n          { id: 29, name: \"Egnyte\", description: \"Explore and analyze your content\", icon: \"E\", bgColor: \"bg-green-600\" },\n          { id: 30, name: \"Figma\", description: \"Make diagrams, slides, assets\", icon: \"F\", bgColor: \"bg-purple-600\" },\n          { id: 31, name: \"Fireflies\", description: \"Search meeting transcripts\", icon: \"🔥\", bgColor: \"bg-purple-500\" },\n          { id: 32, name: \"GitHub\", description: \"Accede a repositorios, problemas y solicitudes de extracción.\", icon: \"🐙\", bgColor: \"bg-gray-800\" },\n          { id: 33, name: \"GitLab Issues\", description: \"Connect to sync GitLab Issues and merge requests for use in ChatGPT.\", icon: \"🦊\", bgColor: \"bg-orange-600\" },\n          { id: 34, name: \"Gmail\", description: \"Busca y consulta correos electrónicos en tu bandeja de entrada.\", icon: \"✉\", bgColor: \"bg-red-500\" },\n          { id: 35, name: \"Google Drive\", description: \"Upload Google Drive files in messages sent to ChatGPT.\", icon: \"📁\", bgColor: \"bg-yellow-500\", badge: \"CARGAS DE ARCHIVOS\" },\n          { id: 36, name: \"Google Calendar\", description: \"Consulta eventos y disponibilidad.\", icon: \"📅\", bgColor: \"bg-blue-500\" },\n          { id: 37, name: \"Google Drive\", description: \"Busca y consulta archivos de tu Drive.\", icon: \"📁\", bgColor: \"bg-green-500\", hasSync: true },\n          { id: 38, name: \"Help Scout\", description: \"Connect to sync Help Scout mailboxes and conversations for use in ChatGPT.\", icon: \"H\", bgColor: \"bg-blue-500\" },\n          { id: 39, name: \"Hex\", description: \"Ask questions, run analyses\", icon: \"⬡\", bgColor: \"bg-purple-600\" },\n          { id: 40, name: \"HighLevel\", description: \"Interact with your CRM business data\", icon: \"H\", bgColor: \"bg-blue-600\" },\n          { id: 41, name: \"HubSpot\", description: \"Analiza datos de CRM y destaca insights\", icon: \"H\", bgColor: \"bg-orange-500\" },\n          { id: 42, name: \"Hugging Face\", description: \"Inspect models, datasets, Spaces, and research\", icon: \"🤗\", bgColor: \"bg-yellow-400\" },\n          { id: 43, name: \"Intercom\", description: \"Look up past user chats and tickets.\", icon: \"💬\", bgColor: \"bg-blue-500\" },\n          { id: 44, name: \"Jam\", description: \"Screen record with context\", icon: \"🍇\", bgColor: \"bg-purple-600\" },\n          { id: 45, name: \"Jotform\", description: \"Build forms, analyze responses\", icon: \"J\", bgColor: \"bg-orange-500\" },\n          { id: 46, name: \"Klaviyo\", description: \"Marketing performance insights\", icon: \"K\", bgColor: \"bg-green-600\" },\n          { id: 47, name: \"LSEG\", description: \"LSEG financial data access\", icon: \"L\", bgColor: \"bg-blue-700\" },\n          { id: 48, name: \"Linear\", description: \"Busca y consulta incidencias y proyectos.\", icon: \"◇\", bgColor: \"bg-indigo-600\" },\n          { id: 49, name: \"Lovable\", description: \"Build apps and websites\", icon: \"♥\", bgColor: \"bg-pink-500\" },\n          { id: 50, name: \"Microsoft OneDrive (personal)\", description: \"Upload personal OneDrive files in messages sent to ChatGPT.\", icon: \"☁\", bgColor: \"bg-blue-500\", badge: \"CARGAS DE ARCHIVOS\" },\n          { id: 51, name: \"Microsoft OneDrive (work/school)\", description: \"Upload SharePoint and OneDrive for Business files in messages sent to ChatGPT.\", icon: \"☁\", bgColor: \"bg-blue-600\", badge: \"CARGAS DE ARCHIVOS\" },\n          { id: 52, name: \"Monday.com\", description: \"Manage work in monday.com\", icon: \"M\", bgColor: \"bg-red-500\" },\n          { id: 53, name: \"Netlify\", description: \"Build and deploy on Netlify\", icon: \"N\", bgColor: \"bg-teal-500\" },\n          { id: 54, name: \"Notion\", description: \"Busca y consulta tus páginas de Notion.\", icon: \"N\", bgColor: \"bg-gray-800\" },\n          { id: 55, name: \"OpenTable\", description: \"Find restaurant reservations\", icon: \"🍽\", bgColor: \"bg-red-600\" },\n          { id: 56, name: \"Pipedrive\", description: \"Connect to sync Pipedrive deals and contacts for use in ChatGPT.\", icon: \"P\", bgColor: \"bg-green-500\" },\n          { id: 57, name: \"PitchBook\", description: \"Faster workflows with market intelligence\", icon: \"P\", bgColor: \"bg-blue-700\" },\n          { id: 58, name: \"Replit\", description: \"Build web apps with AI\", icon: \"R\", bgColor: \"bg-orange-500\" },\n          { id: 59, name: \"Semrush\", description: \"Site metrics and traffic data\", icon: \"S\", bgColor: \"bg-orange-600\" },\n          { id: 60, name: \"SharePoint\", description: \"Busca y extrae datos de sitios compartidos y OneDrive.\", icon: \"S\", bgColor: \"bg-teal-600\" },\n          { id: 61, name: \"Slack\", description: \"Consulta chats y mensajes.\", icon: \"S\", bgColor: \"bg-purple-600\" },\n          { id: 62, name: \"Spaceship\", description: \"Search domain availability\", icon: \"🚀\", bgColor: \"bg-indigo-600\" },\n          { id: 63, name: \"Stripe\", description: \"Payments and business tools\", icon: \"S\", bgColor: \"bg-purple-500\" },\n          { id: 64, name: \"Teams\", description: \"Consulta chats y mensajes.\", icon: \"T\", bgColor: \"bg-purple-700\" },\n          { id: 65, name: \"Teamwork.com\", description: \"Connect to sync Teamwork projects and tasks for use in ChatGPT.\", icon: \"T\", bgColor: \"bg-purple-500\" },\n          { id: 66, name: \"Tripadvisor\", description: \"Book top-rated hotels\", icon: \"🦉\", bgColor: \"bg-green-500\" },\n          { id: 67, name: \"Vercel\", description: \"Search docs and deploy apps\", icon: \"▲\", bgColor: \"bg-gray-800\" },\n          { id: 68, name: \"Zoho\", description: \"Connect to sync Zoho CRM records and activities for use in ChatGPT.\", icon: \"Z\", bgColor: \"bg-red-600\" },\n          { id: 69, name: \"Zoho Desk\", description: \"Connect to sync Zoho Desk tickets and customer conversations for use in ChatGPT.\", icon: \"Z\", bgColor: \"bg-green-600\" },\n          { id: 70, name: \"Zoom\", description: \"Smart meeting insights from Zoom\", icon: \"Z\", bgColor: \"bg-blue-500\" },\n        ];\n        return (\n          <div className=\"space-y-6\">\n            <div>\n              <h1 className=\"text-2xl font-semibold\">Aplicaciones</h1>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Administra a qué aplicaciones pueden conectarse los usuarios de este espacio de trabajo.{\" \"}\n                <button className=\"text-primary hover:underline\">Obtener más información</button>\n              </p>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex-1 relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input \n                  placeholder=\"Buscar\" \n                  className=\"pl-9\"\n                  data-testid=\"input-apps-search\"\n                />\n              </div>\n              <Popover>\n                <PopoverTrigger asChild>\n                  <Button variant=\"outline\" className=\"gap-2\" data-testid=\"button-apps-filters\">\n                    <Filter className=\"h-4 w-4\" />\n                    Filtros\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-72 p-0\" align=\"end\">\n                  <div className=\"p-4 space-y-4\">\n                    <Collapsible defaultOpen>\n                      <CollapsibleTrigger className=\"flex items-center justify-between w-full\">\n                        <span className=\"font-medium\">Categorías</span>\n                        <ChevronDown className=\"h-4 w-4 transition-transform duration-200 [&[data-state=open]]:rotate-180\" />\n                      </CollapsibleTrigger>\n                      <CollapsibleContent className=\"pt-3 space-y-2\">\n                        {[\"Diseño\", \"Empresa\", \"Herramientas del desarrollador\", \"Productividad\", \"Colaboración\", \"Finanzas\"].map((cat) => (\n                          <label key={cat} className=\"flex items-center gap-3 cursor-pointer\">\n                            <input type=\"checkbox\" className=\"h-4 w-4 rounded border-gray-300\" />\n                            <span className=\"text-sm\">{cat}</span>\n                          </label>\n                        ))}\n                      </CollapsibleContent>\n                    </Collapsible>\n\n                    <Collapsible defaultOpen>\n                      <CollapsibleTrigger className=\"flex items-center justify-between w-full\">\n                        <span className=\"font-medium\">Funcionalidades</span>\n                        <ChevronDown className=\"h-4 w-4 transition-transform duration-200 [&[data-state=open]]:rotate-180\" />\n                      </CollapsibleTrigger>\n                      <CollapsibleContent className=\"pt-3 space-y-2\">\n                        {[\"Búsqueda de archivos\", \"Cargas de archivos\", \"Sincronización\", \"Capacidad de escritura\", \"Interactiva\"].map((func) => (\n                          <label key={func} className=\"flex items-center gap-3 cursor-pointer\">\n                            <input type=\"checkbox\" className=\"h-4 w-4 rounded border-gray-300\" />\n                            <span className=\"text-sm\">{func}</span>\n                          </label>\n                        ))}\n                      </CollapsibleContent>\n                    </Collapsible>\n\n                    <div className=\"pt-2 border-t\">\n                      <button className=\"text-sm text-muted-foreground hover:text-foreground w-full text-right\">\n                        Borrar todo\n                      </button>\n                    </div>\n                  </div>\n                </PopoverContent>\n              </Popover>\n              <Button className=\"gap-2\" data-testid=\"button-apps-create\">\n                <Plus className=\"h-4 w-4\" />\n                Crear\n              </Button>\n            </div>\n\n            <Tabs defaultValue=\"enabled\" className=\"w-full\">\n              <div className=\"flex items-center justify-between\">\n                <TabsList className=\"bg-transparent border-b rounded-none h-auto p-0\">\n                  <TabsTrigger \n                    value=\"enabled\" \n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2\"\n                    data-testid=\"tab-apps-enabled\"\n                  >\n                    Enabled (70)\n                  </TabsTrigger>\n                  <TabsTrigger \n                    value=\"directory\" \n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2\"\n                    data-testid=\"tab-apps-directory\"\n                  >\n                    Directorio\n                  </TabsTrigger>\n                  <TabsTrigger \n                    value=\"drafts\" \n                    className=\"rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent px-4 py-2\"\n                    data-testid=\"tab-apps-drafts\"\n                  >\n                    Drafts (0)\n                  </TabsTrigger>\n                </TabsList>\n                <button className=\"text-sm text-muted-foreground hover:text-foreground flex items-center gap-1\" data-testid=\"button-explore-directory\">\n                  Explorar directorio\n                  <span className=\"text-xs\">↗</span>\n                </button>\n              </div>\n\n              <TabsContent value=\"enabled\" className=\"mt-4\">\n                <div className=\"border rounded-lg overflow-hidden\">\n                  <div className=\"flex items-center px-4 py-3 bg-muted/50 border-b\">\n                    <input type=\"checkbox\" className=\"h-4 w-4 rounded border-gray-300 mr-4\" data-testid=\"checkbox-apps-all\" />\n                    <button className=\"flex items-center gap-1 text-sm font-medium text-muted-foreground hover:text-foreground\">\n                      Nombre\n                      <ChevronDown className=\"h-3 w-3 rotate-180\" />\n                    </button>\n                  </div>\n                  <div className=\"divide-y\">\n                    {appItems.map((app: any) => (\n                      <div key={app.id} className=\"flex items-center px-4 py-3 hover:bg-muted/30\">\n                        <input type=\"checkbox\" className=\"h-4 w-4 rounded border-gray-300 mr-4\" data-testid={`checkbox-app-${app.id}`} />\n                        <div className={cn(\"w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm font-bold mr-4\", app.bgColor)}>\n                          {app.icon}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2\">\n                            <p className=\"font-medium\">{app.name}</p>\n                            {app.badge && (\n                              <Badge variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\">{app.badge}</Badge>\n                            )}\n                          </div>\n                          <p className=\"text-sm text-muted-foreground truncate\">{app.description}</p>\n                          {app.hasSync && (\n                            <button className=\"text-xs text-primary hover:underline mt-1\">Habilitar sincronización</button>\n                          )}\n                        </div>\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 flex-shrink-0\">\n                          <MoreHorizontal className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"directory\" className=\"mt-4\">\n                <div className=\"border rounded-lg p-6\">\n                  <p className=\"text-sm text-muted-foreground text-center py-4\">\n                    Explora el directorio de aplicaciones disponibles\n                  </p>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"drafts\" className=\"mt-4\">\n                <div className=\"border rounded-lg p-6\">\n                  <p className=\"text-sm text-muted-foreground text-center py-4\">\n                    No hay borradores de aplicaciones\n                  </p>\n                </div>\n              </TabsContent>\n            </Tabs>\n          </div>\n        );\n\n      case \"groups\":\n        return (\n          <div className=\"space-y-6\">\n            <h1 className=\"text-2xl font-semibold\">Grupos</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Administra los grupos de tu espacio de trabajo.\n            </p>\n          </div>\n        );\n\n      case \"analytics\":\n        return (\n          <div className=\"space-y-6\">\n            <h1 className=\"text-2xl font-semibold\">Análisis de usuario</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Visualiza estadísticas y análisis de uso.\n            </p>\n          </div>\n        );\n\n      case \"identity\":\n        return (\n          <div className=\"space-y-6\">\n            <h1 className=\"text-2xl font-semibold\">Identidad y acceso</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Configura la identidad y el acceso de tu espacio de trabajo.\n            </p>\n          </div>\n        );\n\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"flex justify-end px-6 py-3\">\n        <div className=\"inline-flex items-center gap-3 bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-lg px-4 py-2\">\n          <AlertTriangle className=\"h-4 w-4 text-amber-600 flex-shrink-0\" />\n          <div className=\"text-sm\">\n            <span className=\"font-medium\">Este espacio de trabajo se desactivará.</span>\n            <span className=\"text-muted-foreground ml-1\">\n              Tendrás acceso al espacio de trabajo hasta que finalice el ciclo de facturación el 28 de diciembre de 2025.\n            </span>\n          </div>\n          <Button variant=\"outline\" size=\"sm\" className=\"ml-2 flex-shrink-0\" data-testid=\"button-reactivate\">\n            Reactivar\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"flex\">\n        <div className=\"w-64 border-r min-h-[calc(100vh-49px)] p-4\">\n          <button \n            onClick={() => setLocation(\"/\")}\n            className=\"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground mb-6\"\n            data-testid=\"button-back-to-chat\"\n          >\n            <ArrowLeft className=\"h-4 w-4\" />\n            Volver al chat\n          </button>\n\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"w-10 h-10 rounded-lg bg-primary flex items-center justify-center\">\n              <SiraLogo size={24} />\n            </div>\n            <span className=\"text-sm font-medium truncate\">Espacio de trabajo de Jor...</span>\n          </div>\n\n          <nav className=\"space-y-1\">\n            {menuItems.map((item) => (\n              <button\n                key={item.id}\n                onClick={() => setActiveSection(item.id)}\n                className={cn(\n                  \"w-full flex items-center gap-3 px-3 py-2 text-sm rounded-md transition-colors\",\n                  activeSection === item.id \n                    ? \"bg-muted font-medium\" \n                    : \"hover:bg-muted/50 text-muted-foreground\"\n                )}\n                data-testid={`workspace-menu-${item.id}`}\n              >\n                {item.icon}\n                {item.label}\n              </button>\n            ))}\n          </nav>\n        </div>\n\n        <div className=\"flex-1 p-8 max-w-3xl\">\n          {renderContent()}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":58887,"size_tokens":null},"server/services/emailService.ts":{"content":"import { Resend } from 'resend';\n\nlet connectionSettings: any;\n\nasync function getCredentials() {\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  if (!connectionSettings || (!connectionSettings.settings.api_key)) {\n    throw new Error('Resend not connected');\n  }\n  return {apiKey: connectionSettings.settings.api_key, fromEmail: connectionSettings.settings.from_email};\n}\n\nasync function getResendClient() {\n  const { apiKey, fromEmail } = await getCredentials();\n  return {\n    client: new Resend(apiKey),\n    fromEmail\n  };\n}\n\ninterface ShareNotificationParams {\n  toEmail: string;\n  chatTitle: string;\n  chatId: string;\n  role: string;\n  inviterEmail: string;\n}\n\nexport async function sendShareNotificationEmail(params: ShareNotificationParams): Promise<void> {\n  const { toEmail, chatTitle, chatId, role, inviterEmail } = params;\n  \n  const roleLabels: Record<string, string> = {\n    owner: \"propietario\",\n    editor: \"editor\",\n    viewer: \"visualizador\"\n  };\n  \n  const roleLabel = roleLabels[role] || role;\n  const baseUrl = process.env.REPLIT_DEV_DOMAIN \n    ? `https://${process.env.REPLIT_DEV_DOMAIN}` \n    : 'https://siragpt.app';\n  const shareUrl = `${baseUrl}/chat/${chatId}`;\n  \n  const subject = `${inviterEmail} te ha compartido una conversación en Sira GPT`;\n  \n  const htmlBody = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }\n    .button { display: inline-block; background: #667eea; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-top: 20px; }\n    .info { background: white; padding: 15px; border-radius: 8px; margin: 15px 0; }\n    .footer { text-align: center; color: #666; font-size: 12px; margin-top: 20px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>🤖 Sira GPT</h1>\n      <p>Tienes una nueva invitación</p>\n    </div>\n    <div class=\"content\">\n      <p>¡Hola!</p>\n      <p><strong>${inviterEmail}</strong> te ha invitado a participar en una conversación.</p>\n      \n      <div class=\"info\">\n        <p>📝 <strong>Conversación:</strong> \"${chatTitle}\"</p>\n        <p>👤 <strong>Tu rol:</strong> ${roleLabel}</p>\n      </div>\n      \n      <p>Haz clic en el siguiente botón para acceder:</p>\n      <a href=\"${shareUrl}\" class=\"button\">Ver conversación</a>\n      \n      <div class=\"footer\">\n        <p>Sira GPT - Tu asistente de IA</p>\n      </div>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\n  const textBody = `\n¡Hola!\n\n${inviterEmail} te ha invitado a participar en una conversación en Sira GPT.\n\n📝 Conversación: \"${chatTitle}\"\n👤 Tu rol: ${roleLabel}\n🔗 Enlace: ${shareUrl}\n\nHaz clic en el enlace para acceder a la conversación.\n\n---\nSira GPT - Tu asistente de IA\n`;\n\n  try {\n    const { client, fromEmail } = await getResendClient();\n    \n    const result = await client.emails.send({\n      from: fromEmail || 'Sira GPT <noreply@resend.dev>',\n      to: toEmail,\n      subject: subject,\n      html: htmlBody,\n      text: textBody,\n    });\n    \n    console.log(`📧 Email sent successfully to ${toEmail}:`, result);\n  } catch (error) {\n    console.error(`❌ Failed to send email to ${toEmail}:`, error);\n    throw error;\n  }\n}\n","path":null,"size_bytes":4203,"size_tokens":null},"server/seed-products.ts":{"content":"import { getUncachableStripeClient } from './stripeClient';\n\nasync function createProducts() {\n  const stripe = await getUncachableStripeClient();\n\n  console.log('Creating Sira GPT subscription plans...');\n\n  // Plan Go - $5/month\n  const goProduct = await stripe.products.create({\n    name: 'Go',\n    description: 'Logra más con una IA más avanzada',\n    metadata: {\n      plan_type: 'go',\n      features: 'Explora preguntas complejas, más tiempo de chat, imágenes realistas, más contexto'\n    }\n  });\n\n  const goPrice = await stripe.prices.create({\n    product: goProduct.id,\n    unit_amount: 500, // $5.00\n    currency: 'usd',\n    recurring: { interval: 'month' },\n    metadata: { plan_type: 'go' }\n  });\n\n  console.log(`Created Go plan: ${goProduct.id} with price ${goPrice.id}`);\n\n  // Plan Plus - $20/month\n  const plusProduct = await stripe.products.create({\n    name: 'Plus',\n    description: 'Descubre toda la experiencia',\n    metadata: {\n      plan_type: 'plus',\n      features: 'Resuelve problemas complejos, charlas largas, más imágenes, modo Agente, videos Sora'\n    }\n  });\n\n  const plusPrice = await stripe.prices.create({\n    product: plusProduct.id,\n    unit_amount: 2000, // $20.00\n    currency: 'usd',\n    recurring: { interval: 'month' },\n    metadata: { plan_type: 'plus' }\n  });\n\n  console.log(`Created Plus plan: ${plusProduct.id} with price ${plusPrice.id}`);\n\n  // Plan Pro - $200/month\n  const proProduct = await stripe.products.create({\n    name: 'Pro',\n    description: 'Maximiza tu productividad',\n    metadata: {\n      plan_type: 'pro',\n      features: 'Mensajes ilimitados, imágenes de alta calidad, memoria máxima, agentes, videos Sora, Codex'\n    }\n  });\n\n  const proPrice = await stripe.prices.create({\n    product: proProduct.id,\n    unit_amount: 20000, // $200.00\n    currency: 'usd',\n    recurring: { interval: 'month' },\n    metadata: { plan_type: 'pro' }\n  });\n\n  console.log(`Created Pro plan: ${proProduct.id} with price ${proPrice.id}`);\n\n  console.log('\\nAll products created successfully!');\n  console.log('\\nPrice IDs for checkout:');\n  console.log(`Go: ${goPrice.id}`);\n  console.log(`Plus: ${plusPrice.id}`);\n  console.log(`Pro: ${proPrice.id}`);\n}\n\ncreateProducts().catch(console.error);\n","path":null,"size_bytes":2246,"size_tokens":null},"server/stripeService.ts":{"content":"import { getUncachableStripeClient } from './stripeClient';\nimport { db } from './db';\nimport { sql } from 'drizzle-orm';\n\nexport class StripeService {\n  async createCustomer(email: string, userId: string) {\n    const stripe = await getUncachableStripeClient();\n    return await stripe.customers.create({\n      email,\n      metadata: { userId },\n    });\n  }\n\n  async createCheckoutSession(customerId: string, priceId: string, successUrl: string, cancelUrl: string) {\n    const stripe = await getUncachableStripeClient();\n    return await stripe.checkout.sessions.create({\n      customer: customerId,\n      payment_method_types: ['card'],\n      line_items: [{ price: priceId, quantity: 1 }],\n      mode: 'subscription',\n      success_url: successUrl,\n      cancel_url: cancelUrl,\n    });\n  }\n\n  async createCustomerPortalSession(customerId: string, returnUrl: string) {\n    const stripe = await getUncachableStripeClient();\n    return await stripe.billingPortal.sessions.create({\n      customer: customerId,\n      return_url: returnUrl,\n    });\n  }\n\n  async getProduct(productId: string) {\n    const result = await db.execute(\n      sql`SELECT * FROM stripe.products WHERE id = ${productId}`\n    );\n    return result.rows[0] || null;\n  }\n\n  async listProducts(active = true, limit = 20, offset = 0) {\n    const result = await db.execute(\n      sql`SELECT * FROM stripe.products WHERE active = ${active} LIMIT ${limit} OFFSET ${offset}`\n    );\n    return result.rows;\n  }\n\n  async listProductsWithPrices(active = true, limit = 20, offset = 0) {\n    const result = await db.execute(\n      sql`\n        WITH paginated_products AS (\n          SELECT id, name, description, metadata, active\n          FROM stripe.products\n          WHERE active = ${active}\n          ORDER BY id\n          LIMIT ${limit} OFFSET ${offset}\n        )\n        SELECT \n          p.id as product_id,\n          p.name as product_name,\n          p.description as product_description,\n          p.active as product_active,\n          p.metadata as product_metadata,\n          pr.id as price_id,\n          pr.unit_amount,\n          pr.currency,\n          pr.recurring,\n          pr.active as price_active,\n          pr.metadata as price_metadata\n        FROM paginated_products p\n        LEFT JOIN stripe.prices pr ON pr.product = p.id AND pr.active = true\n        ORDER BY p.id, pr.unit_amount\n      `\n    );\n    return result.rows;\n  }\n\n  async getPrice(priceId: string) {\n    const result = await db.execute(\n      sql`SELECT * FROM stripe.prices WHERE id = ${priceId}`\n    );\n    return result.rows[0] || null;\n  }\n\n  async listPrices(active = true, limit = 20, offset = 0) {\n    const result = await db.execute(\n      sql`SELECT * FROM stripe.prices WHERE active = ${active} LIMIT ${limit} OFFSET ${offset}`\n    );\n    return result.rows;\n  }\n\n  async getSubscription(subscriptionId: string) {\n    const result = await db.execute(\n      sql`SELECT * FROM stripe.subscriptions WHERE id = ${subscriptionId}`\n    );\n    return result.rows[0] || null;\n  }\n}\n\nexport const stripeService = new StripeService();\n","path":null,"size_bytes":3076,"size_tokens":null},"server/stripeClient.ts":{"content":"import Stripe from 'stripe';\n\nlet connectionSettings: any;\n\nasync function getCredentials() {\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY\n    ? 'repl ' + process.env.REPL_IDENTITY\n    : process.env.WEB_REPL_RENEWAL\n      ? 'depl ' + process.env.WEB_REPL_RENEWAL\n      : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  const connectorName = 'stripe';\n  const isProduction = process.env.REPLIT_DEPLOYMENT === '1';\n  const targetEnvironment = isProduction ? 'production' : 'development';\n\n  const url = new URL(`https://${hostname}/api/v2/connection`);\n  url.searchParams.set('include_secrets', 'true');\n  url.searchParams.set('connector_names', connectorName);\n  url.searchParams.set('environment', targetEnvironment);\n\n  const response = await fetch(url.toString(), {\n    headers: {\n      'Accept': 'application/json',\n      'X_REPLIT_TOKEN': xReplitToken\n    }\n  });\n\n  const data = await response.json();\n  \n  connectionSettings = data.items?.[0];\n\n  if (!connectionSettings || (!connectionSettings.settings.publishable || !connectionSettings.settings.secret)) {\n    throw new Error(`Stripe ${targetEnvironment} connection not found`);\n  }\n\n  return {\n    publishableKey: connectionSettings.settings.publishable,\n    secretKey: connectionSettings.settings.secret,\n  };\n}\n\nexport async function getUncachableStripeClient() {\n  const { secretKey } = await getCredentials();\n\n  return new Stripe(secretKey, {\n    apiVersion: '2025-11-17.clover',\n  });\n}\n\nexport async function getStripePublishableKey() {\n  const { publishableKey } = await getCredentials();\n  return publishableKey;\n}\n\nexport async function getStripeSecretKey() {\n  const { secretKey } = await getCredentials();\n  return secretKey;\n}\n\nlet stripeSync: any = null;\n\nexport async function getStripeSync() {\n  if (!stripeSync) {\n    const { StripeSync } = await import('stripe-replit-sync');\n    const secretKey = await getStripeSecretKey();\n\n    stripeSync = new StripeSync({\n      poolConfig: {\n        connectionString: process.env.DATABASE_URL!,\n        max: 2,\n      },\n      stripeSecretKey: secretKey,\n    });\n  }\n  return stripeSync;\n}\n","path":null,"size_bytes":2221,"size_tokens":null},"server/lib/gemini.ts":{"content":"import { GoogleGenAI } from \"@google/genai\";\n\nconst ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || \"\" });\n\nexport const GEMINI_MODELS = {\n  FLASH_PREVIEW: \"gemini-3-flash-preview\",\n  FLASH: \"gemini-2.5-flash\",\n  PRO: \"gemini-2.5-pro\",\n} as const;\n\nexport type GeminiModelType = typeof GEMINI_MODELS[keyof typeof GEMINI_MODELS];\n\nexport interface GeminiChatMessage {\n  role: \"user\" | \"model\";\n  parts: { text: string }[];\n}\n\nexport interface GeminiChatOptions {\n  model?: GeminiModelType;\n  systemInstruction?: string;\n  temperature?: number;\n  topP?: number;\n  maxOutputTokens?: number;\n}\n\nexport interface GeminiResponse {\n  content: string;\n  model: string;\n}\n\nexport async function geminiChat(\n  messages: GeminiChatMessage[],\n  options: GeminiChatOptions = {}\n): Promise<GeminiResponse> {\n  const model = options.model || GEMINI_MODELS.FLASH_PREVIEW;\n  \n  const contents = messages.map(msg => ({\n    role: msg.role,\n    parts: msg.parts\n  }));\n\n  try {\n    const result = await ai.models.generateContent({\n      model,\n      contents,\n      config: {\n        systemInstruction: options.systemInstruction,\n        temperature: options.temperature,\n        topP: options.topP,\n        maxOutputTokens: options.maxOutputTokens,\n      },\n    });\n\n    const text = result.text ?? \"\";\n\n    return {\n      content: text,\n      model,\n    };\n  } catch (error: any) {\n    console.error(\"[Gemini] Error generating content:\", error.message);\n    throw new Error(`Gemini API error: ${error.message}`);\n  }\n}\n\nexport async function* geminiStreamChat(\n  messages: GeminiChatMessage[],\n  options: GeminiChatOptions = {}\n): AsyncGenerator<{ content: string; done: boolean }, void, unknown> {\n  const model = options.model || GEMINI_MODELS.FLASH_PREVIEW;\n  \n  const contents = messages.map(msg => ({\n    role: msg.role,\n    parts: msg.parts\n  }));\n\n  try {\n    const response = await ai.models.generateContentStream({\n      model,\n      contents,\n      config: {\n        systemInstruction: options.systemInstruction,\n        temperature: options.temperature,\n        topP: options.topP,\n        maxOutputTokens: options.maxOutputTokens,\n      },\n    });\n\n    for await (const chunk of response) {\n      const text = chunk.text ?? \"\";\n      if (text) {\n        yield { content: text, done: false };\n      }\n    }\n\n    yield { content: \"\", done: true };\n  } catch (error: any) {\n    console.error(\"[Gemini] Stream error:\", error.message);\n    throw new Error(`Gemini API error: ${error.message}`);\n  }\n}\n\nexport { ai as geminiClient };\n","path":null,"size_bytes":2535,"size_tokens":null},"client/src/components/user-library.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Image, Video, FileText, Download, X, FolderOpen } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface MediaItem {\n  id: string;\n  title: string;\n  type: \"image\" | \"video\" | \"document\";\n  url: string;\n  thumbnailUrl?: string;\n  createdAt: string;\n}\n\ninterface UserLibraryProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\ntype FilterType = \"all\" | \"image\" | \"video\" | \"document\";\n\nfunction MediaItemSkeleton() {\n  return (\n    <div className=\"flex flex-col gap-2\">\n      <Skeleton className=\"aspect-square w-full rounded-lg\" />\n      <Skeleton className=\"h-4 w-3/4\" />\n    </div>\n  );\n}\n\nfunction EmptyState({ filter }: { filter: FilterType }) {\n  const messages: Record<FilterType, string> = {\n    all: \"No tienes archivos en tu biblioteca\",\n    image: \"No tienes imágenes guardadas\",\n    video: \"No tienes videos guardados\",\n    document: \"No tienes documentos guardados\",\n  };\n\n  return (\n    <div\n      className=\"flex flex-col items-center justify-center py-16 text-center\"\n      data-testid=\"empty-state\"\n    >\n      <FolderOpen className=\"h-16 w-16 text-muted-foreground/50 mb-4\" />\n      <p className=\"text-lg font-medium text-muted-foreground\">\n        {messages[filter]}\n      </p>\n      <p className=\"text-sm text-muted-foreground/70 mt-1\">\n        Los archivos que subas aparecerán aquí\n      </p>\n    </div>\n  );\n}\n\nfunction MediaThumbnail({\n  item,\n  onClick,\n}: {\n  item: MediaItem;\n  onClick: () => void;\n}) {\n  const handleDownload = async (e: React.MouseEvent) => {\n    e.stopPropagation();\n    try {\n      const response = await fetch(item.url);\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = item.title;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    } catch (error) {\n      console.error(\"Download failed:\", error);\n    }\n  };\n\n  return (\n    <div\n      className=\"group relative flex flex-col gap-2 cursor-pointer\"\n      onClick={onClick}\n      data-testid={`media-item-${item.id}`}\n    >\n      <div className=\"relative aspect-square w-full overflow-hidden rounded-lg bg-muted border border-border/50 transition-all duration-200 group-hover:border-primary/30 group-hover:shadow-md\">\n        {item.type === \"image\" ? (\n          <img\n            src={item.thumbnailUrl || item.url}\n            alt={item.title}\n            className=\"h-full w-full object-cover transition-transform duration-200 group-hover:scale-105\"\n          />\n        ) : item.type === \"video\" ? (\n          <div className=\"flex h-full w-full items-center justify-center bg-gradient-to-br from-purple-500/10 to-blue-500/10\">\n            <Video className=\"h-12 w-12 text-muted-foreground/70\" />\n          </div>\n        ) : (\n          <div className=\"flex h-full w-full items-center justify-center bg-gradient-to-br from-orange-500/10 to-red-500/10\">\n            <FileText className=\"h-12 w-12 text-muted-foreground/70\" />\n          </div>\n        )}\n        <div className=\"absolute inset-0 flex items-center justify-center bg-black/0 opacity-0 transition-all duration-200 group-hover:bg-black/40 group-hover:opacity-100\">\n          <Button\n            variant=\"secondary\"\n            size=\"icon\"\n            className=\"h-10 w-10 rounded-full bg-white/90 hover:bg-white shadow-lg\"\n            onClick={handleDownload}\n            data-testid={`download-button-${item.id}`}\n          >\n            <Download className=\"h-5 w-5 text-gray-700\" />\n          </Button>\n        </div>\n      </div>\n      <p className=\"truncate text-sm font-medium text-foreground/90 px-1\">\n        {item.title}\n      </p>\n    </div>\n  );\n}\n\nfunction LightboxView({\n  item,\n  onClose,\n}: {\n  item: MediaItem;\n  onClose: () => void;\n}) {\n  const handleDownload = async () => {\n    try {\n      const response = await fetch(item.url);\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = item.title;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    } catch (error) {\n      console.error(\"Download failed:\", error);\n    }\n  };\n\n  return (\n    <div\n      className=\"fixed inset-0 z-[100] flex items-center justify-center bg-black/90\"\n      onClick={onClose}\n      data-testid=\"lightbox-overlay\"\n    >\n      <Button\n        variant=\"ghost\"\n        size=\"icon\"\n        className=\"absolute right-4 top-4 h-10 w-10 rounded-full bg-white/10 text-white hover:bg-white/20\"\n        onClick={onClose}\n        data-testid=\"lightbox-close\"\n      >\n        <X className=\"h-6 w-6\" />\n      </Button>\n      <Button\n        variant=\"ghost\"\n        size=\"icon\"\n        className=\"absolute right-16 top-4 h-10 w-10 rounded-full bg-white/10 text-white hover:bg-white/20\"\n        onClick={(e) => {\n          e.stopPropagation();\n          handleDownload();\n        }}\n        data-testid=\"lightbox-download\"\n      >\n        <Download className=\"h-5 w-5\" />\n      </Button>\n      <div\n        className=\"max-h-[90vh] max-w-[90vw]\"\n        onClick={(e) => e.stopPropagation()}\n      >\n        {item.type === \"image\" ? (\n          <img\n            src={item.url}\n            alt={item.title}\n            className=\"max-h-[90vh] max-w-[90vw] object-contain rounded-lg\"\n          />\n        ) : item.type === \"video\" ? (\n          <video\n            src={item.url}\n            controls\n            autoPlay\n            className=\"max-h-[90vh] max-w-[90vw] rounded-lg\"\n          />\n        ) : (\n          <div className=\"flex flex-col items-center justify-center gap-4 rounded-lg bg-white/10 p-12\">\n            <FileText className=\"h-24 w-24 text-white/70\" />\n            <p className=\"text-lg font-medium text-white\">{item.title}</p>\n            <Button\n              onClick={(e) => {\n                e.stopPropagation();\n                handleDownload();\n              }}\n              data-testid=\"lightbox-download-document\"\n            >\n              <Download className=\"h-4 w-4 mr-2\" />\n              Descargar documento\n            </Button>\n          </div>\n        )}\n      </div>\n      <p className=\"absolute bottom-4 left-1/2 -translate-x-1/2 text-sm text-white/70\">\n        {item.title}\n      </p>\n    </div>\n  );\n}\n\nexport function UserLibrary({ open, onOpenChange }: UserLibraryProps) {\n  const [activeTab, setActiveTab] = useState<FilterType>(\"all\");\n  const [lightboxItem, setLightboxItem] = useState<MediaItem | null>(null);\n\n  const queryParam = activeTab === \"all\" ? \"\" : `?type=${activeTab}`;\n\n  const { data: items = [], isLoading } = useQuery<MediaItem[]>({\n    queryKey: [\"/api/library\", activeTab],\n    queryFn: async () => {\n      const response = await fetch(`/api/library${queryParam}`, {\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        if (response.status === 404) {\n          return [];\n        }\n        throw new Error(\"Failed to fetch library\");\n      }\n      const data = await response.json();\n      // Map API response fields to MediaItem interface\n      return data.map((item: any) => ({\n        id: item.id,\n        title: item.title,\n        type: item.mediaType as \"image\" | \"video\" | \"document\",\n        url: item.storagePath,\n        thumbnailUrl: item.thumbnailPath,\n        createdAt: item.createdAt,\n      }));\n    },\n    enabled: open,\n  });\n\n  const handleTabChange = (value: string) => {\n    setActiveTab(value as FilterType);\n  };\n\n  return (\n    <>\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent\n          className=\"max-w-none w-screen h-screen max-h-screen p-0 rounded-none border-0 gap-0\"\n          data-testid=\"user-library-dialog\"\n        >\n          <DialogHeader className=\"flex flex-row items-center justify-between px-6 py-4 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n            <DialogTitle className=\"text-xl font-semibold\" data-testid=\"library-title\">\n              Tu Biblioteca de Medios\n            </DialogTitle>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => onOpenChange(false)}\n              className=\"h-9 w-9 rounded-full\"\n              data-testid=\"library-close-button\"\n            >\n              <X className=\"h-5 w-5\" />\n            </Button>\n          </DialogHeader>\n\n          <Tabs\n            value={activeTab}\n            onValueChange={handleTabChange}\n            className=\"flex flex-col h-[calc(100vh-73px)]\"\n          >\n            <div className=\"px-6 pt-4 pb-2 border-b bg-background\">\n              <TabsList className=\"h-10\" data-testid=\"library-tabs\">\n                <TabsTrigger\n                  value=\"all\"\n                  className=\"px-4\"\n                  data-testid=\"tab-all\"\n                >\n                  Todo\n                </TabsTrigger>\n                <TabsTrigger\n                  value=\"image\"\n                  className=\"px-4 gap-2\"\n                  data-testid=\"tab-images\"\n                >\n                  <Image className=\"h-4 w-4\" />\n                  Imágenes\n                </TabsTrigger>\n                <TabsTrigger\n                  value=\"video\"\n                  className=\"px-4 gap-2\"\n                  data-testid=\"tab-videos\"\n                >\n                  <Video className=\"h-4 w-4\" />\n                  Videos\n                </TabsTrigger>\n                <TabsTrigger\n                  value=\"document\"\n                  className=\"px-4 gap-2\"\n                  data-testid=\"tab-documents\"\n                >\n                  <FileText className=\"h-4 w-4\" />\n                  Documentos\n                </TabsTrigger>\n              </TabsList>\n            </div>\n\n            <ScrollArea className=\"flex-1 px-6 py-4\">\n              <TabsContent value={activeTab} className=\"mt-0 h-full\">\n                {isLoading ? (\n                  <div\n                    className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4\"\n                    data-testid=\"loading-skeleton\"\n                  >\n                    {Array.from({ length: 12 }).map((_, i) => (\n                      <MediaItemSkeleton key={i} />\n                    ))}\n                  </div>\n                ) : items.length === 0 ? (\n                  <EmptyState filter={activeTab} />\n                ) : (\n                  <div\n                    className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4\"\n                    data-testid=\"media-grid\"\n                  >\n                    {items.map((item) => (\n                      <MediaThumbnail\n                        key={item.id}\n                        item={item}\n                        onClick={() => setLightboxItem(item)}\n                      />\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n            </ScrollArea>\n          </Tabs>\n        </DialogContent>\n      </Dialog>\n\n      {lightboxItem && (\n        <LightboxView\n          item={lightboxItem}\n          onClose={() => setLightboxItem(null)}\n        />\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":11742,"size_tokens":null},"server/services/imageGeneration.ts":{"content":"import { GoogleGenAI } from \"@google/genai\";\n\nconst ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || \"\" });\n\nconst IMAGE_MODEL = \"gemini-2.0-flash-exp-image-generation\";\nconst IMAGE_MODEL_ALT = \"models/gemini-2.5-flash-preview-04-17\";\n\nexport interface ImageGenerationResult {\n  imageBase64: string;\n  mimeType: string;\n  prompt: string;\n}\n\nexport async function generateImage(prompt: string): Promise<ImageGenerationResult> {\n  try {\n    const response = await ai.models.generateContent({\n      model: IMAGE_MODEL,\n      contents: [\n        {\n          role: \"user\",\n          parts: [{ text: prompt }]\n        }\n      ],\n      config: {\n        responseModalities: [\"image\", \"text\"],\n      }\n    });\n\n    const parts = response.candidates?.[0]?.content?.parts;\n    \n    if (!parts || parts.length === 0) {\n      throw new Error(\"No image generated\");\n    }\n\n    for (const part of parts) {\n      if (part.inlineData) {\n        return {\n          imageBase64: part.inlineData.data || \"\",\n          mimeType: part.inlineData.mimeType || \"image/png\",\n          prompt\n        };\n      }\n    }\n\n    throw new Error(\"No image data in response\");\n  } catch (error: any) {\n    console.error(\"[ImageGeneration] Error:\", error.message);\n    throw new Error(`Image generation failed: ${error.message}`);\n  }\n}\n\nexport function detectImageRequest(message: string): boolean {\n  const lowerMessage = message.toLowerCase();\n  \n  // Negative indicators: structured content that should NOT trigger image generation\n  const structuredContentKeywords = [\n    'tabla', 'table', 'tablas', 'tables',\n    'lista', 'list', 'listas', 'lists',\n    'documento', 'document', 'documentos', 'documents',\n    'texto', 'text', 'textos',\n    'organigrama', 'organigram', 'org chart',\n    'esquema', 'schema', 'outline',\n    'resumen', 'summary', 'resúmenes',\n    'código', 'code', 'script',\n    'excel', 'word', 'powerpoint', 'ppt',\n    'csv', 'json', 'xml', 'html',\n    'fórmula', 'formula', 'ecuación', 'equation',\n    'diagrama de flujo', 'flowchart', 'flow chart',\n    'markdown', 'md',\n    'párrafo', 'paragraph',\n    'artículo', 'article',\n    'informe', 'report',\n    'análisis', 'analysis',\n    'datos', 'data',\n    'filas', 'rows', 'columnas', 'columns',\n    'celdas', 'cells',\n    '10x10', '5x5', '3x3', // Table dimensions\n  ];\n  \n  // Check for structured content keywords first (negative indicators)\n  const hasStructuredContent = structuredContentKeywords.some(keyword => \n    lowerMessage.includes(keyword)\n  );\n  \n  if (hasStructuredContent) {\n    // Only generate image if there's explicit image-specific noun\n    const explicitImageNouns = [\n      /\\bimagen\\b/i, /\\bimágenes\\b/i,\n      /\\bfoto\\b/i, /\\bfotos\\b/i, /\\bfotografía\\b/i,\n      /\\bimage\\b/i, /\\bimages\\b/i,\n      /\\bpicture\\b/i, /\\bpictures\\b/i,\n      /\\bphoto\\b/i, /\\bphotos\\b/i,\n      /\\bilustración\\b/i, /\\billustration\\b/i,\n      /\\bdibujo\\b/i, /\\bdrawing\\b/i,\n    ];\n    return explicitImageNouns.some(pattern => pattern.test(message));\n  }\n  \n  // Positive indicators: image-specific patterns\n  const imagePatterns = [\n    /\\b(genera|crea|dibuja|haz|hazme|dame|quiero|necesito|podr[ií]as)\\b.{0,20}\\b(imagen|foto|ilustraci[oó]n|dibujo|arte|retrato|paisaje)\\b/i,\n    /\\b(generate|create|make|draw|give me|i want|i need|can you)\\b.{0,20}\\b(image|picture|photo|illustration|drawing|art|portrait|landscape)\\b/i,\n    /\\b(imagen|picture|photo)\\s+(de|of|with)\\b/i,\n    /\\buna?\\s+imagen\\s+de\\b/i,\n    /\\ban?\\s+image\\s+of\\b/i,\n    /\\bdibuja(me)?\\s+/i,\n    /\\bdraw\\s+(me\\s+)?a\\b/i,\n  ];\n\n  return imagePatterns.some(pattern => pattern.test(message));\n}\n\nexport function extractImagePrompt(message: string): string {\n  let prompt = message\n    .replace(/^(genera|crea|dibuja|haz|hazme|dame|quiero|necesito|podrías|generate|create|make|draw|give me|i want|i need|can you)\\s*/i, \"\")\n    .replace(/\\b(una?\\s+)?(imagen|image|picture|photo|ilustración|illustration|dibujo|drawing)\\s*(de|of|with)?\\s*/gi, \"\")\n    .trim();\n  \n  if (prompt.length < 5) {\n    prompt = message;\n  }\n  \n  return prompt;\n}\n","path":null,"size_bytes":4062,"size_tokens":null},"client/src/hooks/use-language.ts":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { getLanguage, setLanguage as setStoredLanguage, t, getSupportedLanguages, type SupportedLanguage } from \"@/lib/i18n\";\n\nexport function useLanguage() {\n  const [language, setLanguageState] = useState<SupportedLanguage>(getLanguage);\n  const [, forceUpdate] = useState({});\n\n  useEffect(() => {\n    const handleLanguageChange = (event: CustomEvent<SupportedLanguage>) => {\n      setLanguageState(event.detail);\n      forceUpdate({});\n    };\n\n    window.addEventListener(\"languageChange\", handleLanguageChange as EventListener);\n    return () => {\n      window.removeEventListener(\"languageChange\", handleLanguageChange as EventListener);\n    };\n  }, []);\n\n  const setLanguage = useCallback((lang: SupportedLanguage) => {\n    setStoredLanguage(lang);\n    setLanguageState(lang);\n  }, []);\n\n  const translate = useCallback((key: string): string => {\n    return t(key);\n  }, [language]);\n\n  return {\n    language,\n    setLanguage,\n    t: translate,\n    supportedLanguages: getSupportedLanguages(),\n  };\n}\n","path":null,"size_bytes":1066,"size_tokens":null},"server/agent/pipeline/multiIntentPipeline.ts":{"content":"import {\n  TaskPlan,\n  ExecutionResult,\n  PipelineError,\n  PipelineResponse,\n  AggregateSummary,\n  TaskStatus,\n  MAX_PARALLEL_TASKS,\n  DEFAULT_TASK_TIMEOUT\n} from \"../../../shared/schemas/multiIntent\";\nimport { multiIntentManager } from \"./multiIntentManager\";\nimport { runPipeline, getAvailableTools } from \"./index\";\nimport type { ProgressUpdate, PipelineResult } from \"./types\";\nimport { geminiChat, GEMINI_MODELS } from \"../../lib/gemini\";\n\ninterface PipelineContext {\n  userId?: string;\n  conversationId?: string;\n  messages: Array<{ role: string; content: string }>;\n  onProgress?: (update: ProgressUpdate) => void;\n}\n\ninterface DecomposedTask {\n  plan: TaskPlan;\n  prompt: string;\n  context: string[];\n}\n\nexport class MultiIntentPipeline {\n  private readonly planningPrompt = `You are a task planner. Analyze the user's message and decompose it into individual tasks.\nReturn a JSON array of tasks with this structure:\n[{\n  \"id\": \"task_1\",\n  \"title\": \"Brief task title\",\n  \"intentType\": \"search|analyze|generate|transform|summarize|extract|navigate|chat\",\n  \"description\": \"Detailed description of what to do\",\n  \"dependencies\": [\"task_id if this depends on another task\"],\n  \"executionMode\": \"sequential|parallel\"\n}]\n\nRules:\n- Each task should be atomic and focused\n- Identify dependencies between tasks\n- Mark tasks as parallel if they can run independently\n- Use sequential for tasks that need previous results\n\nUser message: `;\n\n  async execute(\n    message: string,\n    context: PipelineContext\n  ): Promise<PipelineResponse> {\n    const startTime = Date.now();\n    const errors: PipelineError[] = [];\n    const results: ExecutionResult[] = [];\n    \n    try {\n      context.onProgress?.({\n        runId: context.conversationId || \"default\",\n        stepId: \"planning\",\n        status: \"started\",\n        message: \"Analyzing multi-intent request...\"\n      });\n      \n      const plan = await this.plan(message, context);\n      \n      if (plan.length === 0) {\n        return this.createFailedResponse(\"No tasks could be identified\", startTime);\n      }\n      \n      context.onProgress?.({\n        runId: context.conversationId || \"default\",\n        stepId: \"planning\",\n        status: \"completed\",\n        message: `Identified ${plan.length} tasks`\n      });\n      \n      const decomposed = await this.decompose(plan, message, context);\n      \n      context.onProgress?.({\n        runId: context.conversationId || \"default\",\n        stepId: \"execution\",\n        status: \"started\",\n        message: \"Executing tasks...\"\n      });\n      \n      const executionResults = await this.executeAll(decomposed, context, errors);\n      results.push(...executionResults);\n      \n      const aggregate = this.aggregate(plan, results, errors, startTime);\n      \n      context.onProgress?.({\n        runId: context.conversationId || \"default\",\n        stepId: \"aggregation\",\n        status: \"completed\",\n        message: aggregate.summary\n      });\n      \n      return {\n        plan,\n        results,\n        errors,\n        aggregate\n      };\n      \n    } catch (error) {\n      const errorMsg = error instanceof Error ? error.message : \"Unknown error\";\n      errors.push({\n        taskId: \"pipeline\",\n        code: \"PIPELINE_ERROR\",\n        message: errorMsg,\n        recoverable: false,\n        timestamp: Date.now()\n      });\n      \n      return this.createFailedResponse(errorMsg, startTime, errors);\n    }\n  }\n  \n  private async plan(message: string, context: PipelineContext): Promise<TaskPlan[]> {\n    const detection = await multiIntentManager.detectMultiIntent(message, {\n      messages: context.messages as any,\n      userPreferences: {}\n    });\n    \n    if (detection.suggestedPlan && detection.suggestedPlan.length > 0) {\n      return detection.suggestedPlan;\n    }\n    \n    const planningResponse = await geminiChat(\n      [\n        { role: \"user\", parts: [{ text: this.planningPrompt + message }] }\n      ],\n      { model: GEMINI_MODELS.FLASH_PREVIEW }\n    );\n    \n    try {\n      const jsonMatch = planningResponse.content.match(/\\[[\\s\\S]*\\]/);\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[0]);\n        return parsed.map((task: any, index: number) => ({\n          id: task.id || `task_${index + 1}`,\n          title: task.title || `Task ${index + 1}`,\n          intentType: task.intentType || \"chat\",\n          description: task.description || task.title,\n          requiredContext: task.dependencies || [],\n          executionMode: task.executionMode || \"sequential\",\n          dependencies: task.dependencies || [],\n          priority: parsed.length - index\n        }));\n      }\n    } catch (e) {\n      console.error(\"Failed to parse planning response:\", e);\n    }\n    \n    return [{\n      id: \"task_1\",\n      title: \"Process request\",\n      intentType: \"chat\",\n      description: message,\n      requiredContext: [],\n      executionMode: \"sequential\",\n      dependencies: [],\n      priority: 1\n    }];\n  }\n  \n  private async decompose(\n    plan: TaskPlan[],\n    originalMessage: string,\n    context: PipelineContext\n  ): Promise<DecomposedTask[]> {\n    return plan.map(task => ({\n      plan: task,\n      prompt: this.buildTaskPrompt(task, originalMessage),\n      context: task.requiredContext\n    }));\n  }\n  \n  private buildTaskPrompt(task: TaskPlan, originalMessage: string): string {\n    return task.description;\n  }\n  \n  private getTaskSystemInstruction(task: TaskPlan): string {\n    return `Eres un asistente que responde a UNA sola solicitud.\nTu única tarea es: \"${task.title}\"\nNO respondas a ninguna otra solicitud. NO menciones otras tareas.\nResponde de forma completa y directa solo a esta tarea.`;\n  }\n  \n  private async executeAll(\n    tasks: DecomposedTask[],\n    context: PipelineContext,\n    errors: PipelineError[]\n  ): Promise<ExecutionResult[]> {\n    const results: ExecutionResult[] = [];\n    const completedTasks = new Map<string, ExecutionResult>();\n    \n    const sequentialTasks = tasks.filter(t => \n      t.plan.executionMode === \"sequential\" || t.plan.dependencies.length > 0\n    );\n    const parallelTasks = tasks.filter(t => \n      t.plan.executionMode === \"parallel\" && t.plan.dependencies.length === 0\n    );\n    \n    if (parallelTasks.length > 0) {\n      const parallelResults = await this.executeParallel(\n        parallelTasks, \n        context, \n        completedTasks, \n        errors\n      );\n      results.push(...parallelResults);\n      parallelResults.forEach(r => completedTasks.set(r.taskId, r));\n    }\n    \n    for (const task of sequentialTasks) {\n      const canExecute = task.plan.dependencies.every(dep => {\n        const depResult = completedTasks.get(dep);\n        return depResult && depResult.status === \"completed\";\n      });\n      \n      if (!canExecute && task.plan.dependencies.length > 0) {\n        const result: ExecutionResult = {\n          taskId: task.plan.id,\n          status: \"skipped\",\n          error: \"Dependencies not met\",\n          artifacts: [],\n          retryCount: 0\n        };\n        results.push(result);\n        completedTasks.set(task.plan.id, result);\n        continue;\n      }\n      \n      const result = await this.executeSingleTask(task, context, completedTasks, errors);\n      results.push(result);\n      completedTasks.set(result.taskId, result);\n    }\n    \n    return results;\n  }\n  \n  private async executeParallel(\n    tasks: DecomposedTask[],\n    context: PipelineContext,\n    completedTasks: Map<string, ExecutionResult>,\n    errors: PipelineError[]\n  ): Promise<ExecutionResult[]> {\n    const chunks: DecomposedTask[][] = [];\n    for (let i = 0; i < tasks.length; i += MAX_PARALLEL_TASKS) {\n      chunks.push(tasks.slice(i, i + MAX_PARALLEL_TASKS));\n    }\n    \n    const allResults: ExecutionResult[] = [];\n    \n    for (const chunk of chunks) {\n      const promises = chunk.map(task => \n        this.executeSingleTask(task, context, completedTasks, errors)\n      );\n      \n      const results = await Promise.allSettled(promises);\n      \n      for (let i = 0; i < results.length; i++) {\n        const result = results[i];\n        if (result.status === \"fulfilled\") {\n          allResults.push(result.value);\n        } else {\n          const errorResult: ExecutionResult = {\n            taskId: chunk[i].plan.id,\n            status: \"failed\",\n            error: result.reason?.message || \"Execution failed\",\n            artifacts: [],\n            retryCount: 0\n          };\n          allResults.push(errorResult);\n          errors.push({\n            taskId: chunk[i].plan.id,\n            code: \"EXECUTION_ERROR\",\n            message: result.reason?.message || \"Unknown error\",\n            recoverable: true,\n            timestamp: Date.now()\n          });\n        }\n      }\n    }\n    \n    return allResults;\n  }\n  \n  private async executeSingleTask(\n    task: DecomposedTask,\n    context: PipelineContext,\n    completedTasks: Map<string, ExecutionResult>,\n    errors: PipelineError[]\n  ): Promise<ExecutionResult> {\n    const startTime = Date.now();\n    const maxRetries = task.plan.retryPolicy?.maxRetries ?? 2;\n    let retryCount = 0;\n    \n    context.onProgress?.({\n      runId: context.conversationId || \"default\",\n      stepId: task.plan.id,\n      status: \"started\",\n      message: `Executing: ${task.plan.title}`\n    });\n    \n    while (retryCount <= maxRetries) {\n      try {\n        let contextFromDeps = \"\";\n        for (const depId of task.plan.dependencies) {\n          const depResult = completedTasks.get(depId);\n          if (depResult?.output) {\n            contextFromDeps += `\\n\\nResult from ${depId}: ${JSON.stringify(depResult.output)}`;\n          }\n        }\n        \n        const fullPrompt = task.prompt + contextFromDeps;\n        const systemInstruction = this.getTaskSystemInstruction(task.plan);\n        \n        const response = await geminiChat(\n          [{ role: \"user\", parts: [{ text: fullPrompt }] }],\n          { model: GEMINI_MODELS.FLASH_PREVIEW, systemInstruction }\n        );\n        \n        context.onProgress?.({\n          runId: context.conversationId || \"default\",\n          stepId: task.plan.id,\n          status: \"completed\",\n          message: `Completed: ${task.plan.title}`\n        });\n        \n        return {\n          taskId: task.plan.id,\n          status: \"completed\",\n          output: response.content,\n          artifacts: [],\n          duration: Date.now() - startTime,\n          retryCount\n        };\n        \n      } catch (error) {\n        retryCount++;\n        \n        if (retryCount > maxRetries) {\n          const errorMsg = error instanceof Error ? error.message : \"Unknown error\";\n          errors.push({\n            taskId: task.plan.id,\n            code: \"TASK_FAILED\",\n            message: errorMsg,\n            recoverable: false,\n            timestamp: Date.now()\n          });\n          \n          context.onProgress?.({\n            runId: context.conversationId || \"default\",\n            stepId: task.plan.id,\n            status: \"failed\",\n            message: `Failed: ${task.plan.title}`\n          });\n          \n          return {\n            taskId: task.plan.id,\n            status: \"failed\",\n            error: errorMsg,\n            artifacts: [],\n            duration: Date.now() - startTime,\n            retryCount: retryCount - 1\n          };\n        }\n        \n        const delay = task.plan.retryPolicy?.delayMs ?? 1000;\n        await new Promise(resolve => setTimeout(resolve, delay * retryCount));\n      }\n    }\n    \n    return {\n      taskId: task.plan.id,\n      status: \"failed\",\n      error: \"Max retries exceeded\",\n      artifacts: [],\n      duration: Date.now() - startTime,\n      retryCount: maxRetries\n    };\n  }\n  \n  private aggregate(\n    plan: TaskPlan[],\n    results: ExecutionResult[],\n    errors: PipelineError[],\n    startTime: number\n  ): AggregateSummary {\n    const completedTasks = results.filter(r => r.status === \"completed\").length;\n    const failedTasks = results.filter(r => r.status === \"failed\").length;\n    const skippedTasks = results.filter(r => r.status === \"skipped\").length;\n    const totalTasks = plan.length;\n    \n    const resultTaskIds = new Set(results.map(r => r.taskId));\n    const missingTasks = plan\n      .filter(p => !resultTaskIds.has(p.id))\n      .map(p => p.id);\n    \n    let completionStatus: \"complete\" | \"partial\" | \"failed\";\n    if (completedTasks === totalTasks) {\n      completionStatus = \"complete\";\n    } else if (completedTasks > 0) {\n      completionStatus = \"partial\";\n    } else {\n      completionStatus = \"failed\";\n    }\n    \n    const summary = this.generateSummary(results, completionStatus);\n    \n    return {\n      completionStatus,\n      summary,\n      totalTasks,\n      completedTasks,\n      failedTasks,\n      skippedTasks,\n      missingTasks,\n      duration: Date.now() - startTime\n    };\n  }\n  \n  private generateSummary(\n    results: ExecutionResult[],\n    status: \"complete\" | \"partial\" | \"failed\"\n  ): string {\n    const completedResults = results\n      .filter(r => r.status === \"completed\" && r.output);\n    \n    if (completedResults.length === 0) {\n      return \"No tasks were completed successfully.\";\n    }\n    \n    if (completedResults.length === 1) {\n      return String(completedResults[0].output);\n    }\n    \n    return completedResults\n      .map(r => String(r.output))\n      .join(\"\\n\\n---\\n\\n\");\n  }\n  \n  private createFailedResponse(\n    message: string,\n    startTime: number,\n    errors: PipelineError[] = []\n  ): PipelineResponse {\n    return {\n      plan: [],\n      results: [],\n      errors: errors.length > 0 ? errors : [{\n        taskId: \"pipeline\",\n        code: \"INIT_FAILED\",\n        message,\n        recoverable: false,\n        timestamp: Date.now()\n      }],\n      aggregate: {\n        completionStatus: \"failed\",\n        summary: message,\n        totalTasks: 0,\n        completedTasks: 0,\n        failedTasks: 1,\n        skippedTasks: 0,\n        missingTasks: [],\n        duration: Date.now() - startTime\n      }\n    };\n  }\n}\n\nexport const multiIntentPipeline = new MultiIntentPipeline();\n","path":null,"size_bytes":13994,"size_tokens":null},"shared/schemas/multiIntent.ts":{"content":"import { z } from \"zod\";\n\nexport const IntentTypeSchema = z.enum([\n  \"search\",\n  \"analyze\",\n  \"generate\",\n  \"transform\",\n  \"summarize\",\n  \"extract\",\n  \"navigate\",\n  \"chat\"\n]);\n\nexport type IntentType = z.infer<typeof IntentTypeSchema>;\n\nexport const ExecutionModeSchema = z.enum([\n  \"sequential\",\n  \"parallel\",\n  \"conditional\"\n]);\n\nexport type ExecutionMode = z.infer<typeof ExecutionModeSchema>;\n\nexport const TaskPlanSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  intentType: IntentTypeSchema,\n  description: z.string(),\n  requiredContext: z.array(z.string()).default([]),\n  executionMode: ExecutionModeSchema.default(\"sequential\"),\n  dependencies: z.array(z.string()).default([]),\n  preferredTool: z.string().optional(),\n  retryPolicy: z.object({\n    maxRetries: z.number().default(2),\n    delayMs: z.number().default(1000)\n  }).optional(),\n  priority: z.number().default(0)\n});\n\nexport type TaskPlan = z.infer<typeof TaskPlanSchema>;\n\nexport const TaskStatusSchema = z.enum([\n  \"pending\",\n  \"running\",\n  \"completed\",\n  \"failed\",\n  \"skipped\"\n]);\n\nexport type TaskStatus = z.infer<typeof TaskStatusSchema>;\n\nexport const ExecutionResultSchema = z.object({\n  taskId: z.string(),\n  status: TaskStatusSchema,\n  output: z.any().optional(),\n  artifacts: z.array(z.object({\n    id: z.string(),\n    type: z.string(),\n    name: z.string(),\n    storagePath: z.string().optional(),\n    mimeType: z.string().optional()\n  })).default([]),\n  error: z.string().optional(),\n  duration: z.number().optional(),\n  retryCount: z.number().default(0)\n});\n\nexport type ExecutionResult = z.infer<typeof ExecutionResultSchema>;\n\nexport const PipelineErrorSchema = z.object({\n  taskId: z.string(),\n  code: z.string(),\n  message: z.string(),\n  recoverable: z.boolean().default(false),\n  timestamp: z.number()\n});\n\nexport type PipelineError = z.infer<typeof PipelineErrorSchema>;\n\nexport const CompletionStatusSchema = z.enum([\n  \"complete\",\n  \"partial\",\n  \"failed\"\n]);\n\nexport type CompletionStatus = z.infer<typeof CompletionStatusSchema>;\n\nexport const AggregateSummarySchema = z.object({\n  completionStatus: CompletionStatusSchema,\n  summary: z.string(),\n  totalTasks: z.number(),\n  completedTasks: z.number(),\n  failedTasks: z.number(),\n  skippedTasks: z.number(),\n  missingTasks: z.array(z.string()).default([]),\n  duration: z.number()\n});\n\nexport type AggregateSummary = z.infer<typeof AggregateSummarySchema>;\n\nexport const PipelineResponseSchema = z.object({\n  plan: z.array(TaskPlanSchema),\n  results: z.array(ExecutionResultSchema),\n  errors: z.array(PipelineErrorSchema).default([]),\n  aggregate: AggregateSummarySchema\n});\n\nexport type PipelineResponse = z.infer<typeof PipelineResponseSchema>;\n\nexport const MultiIntentDetectionSchema = z.object({\n  isMultiIntent: z.boolean(),\n  confidence: z.number().min(0).max(1),\n  detectedIntents: z.array(z.object({\n    type: IntentTypeSchema,\n    description: z.string(),\n    keywords: z.array(z.string())\n  })),\n  suggestedPlan: z.array(TaskPlanSchema).optional()\n});\n\nexport type MultiIntentDetection = z.infer<typeof MultiIntentDetectionSchema>;\n\nexport const MULTI_INTENT_THRESHOLD = 0.7;\nexport const MAX_PARALLEL_TASKS = 3;\nexport const DEFAULT_TASK_TIMEOUT = 60000;\n","path":null,"size_bytes":3217,"size_tokens":null},"server/agent/pipeline/multiIntentManager.ts":{"content":"import { \n  MultiIntentDetection, \n  MultiIntentDetectionSchema,\n  TaskPlan,\n  IntentType,\n  MULTI_INTENT_THRESHOLD \n} from \"../../../shared/schemas/multiIntent\";\n\ninterface ConversationContext {\n  messages: Array<{ role: string; content: string }>;\n  userPreferences?: Record<string, any>;\n  recentTasks?: string[];\n}\n\nconst INTENT_PATTERNS: Record<IntentType, RegExp[]> = {\n  search: [\n    /\\b(busca|buscar|encuentra|encontrar|search|find|look for|lookup)\\b/i,\n    /\\b(qué es|what is|cuál es|which is|dime sobre|tell me about)\\b/i\n  ],\n  analyze: [\n    /\\b(analiza|analyze|examina|examine|evalúa|evaluate|compara|compare)\\b/i,\n    /\\b(analizar|análisis|analysis)\\b/i\n  ],\n  generate: [\n    /\\b(genera|generate|crea|create|escribe|write|redacta|draft|haz|make)\\b/i,\n    /\\b(diseña|design|construye|build)\\b/i\n  ],\n  transform: [\n    /\\b(convierte|convert|transforma|transform|cambia|change|modifica|modify)\\b/i,\n    /\\b(traduce|translate|reformatea|reformat)\\b/i\n  ],\n  summarize: [\n    /\\b(resume|summarize|resumen|summary|sintetiza|synthesize)\\b/i,\n    /\\b(breve|brief|conciso|concise|puntos clave|key points)\\b/i\n  ],\n  extract: [\n    /\\b(extrae|extract|obtén|get|saca|pull out|identifica|identify)\\b/i,\n    /\\b(lista|list|enumera|enumerate)\\b/i\n  ],\n  navigate: [\n    /\\b(navega|navigate|ve a|go to|abre|open|visita|visit)\\b/i,\n    /\\b(descarga|download|captura|capture|screenshot)\\b/i\n  ],\n  chat: [\n    /\\b(hola|hello|hi|hey|gracias|thanks|oye|listen)\\b/i\n  ]\n};\n\nconst SEPARATOR_PATTERNS = [\n  /\\b(y también|and also|además|also|luego|then|después|after that)\\b/i,\n  /\\b(primero|first|segundo|second|tercero|third)\\b/i,\n  /\\d+\\s*[.)]\\s*/,\n  /[;]\\s*/,\n  /\\n+/\n];\n\nconst TASK_SPLIT_REGEX = /(?:^|\\s)(?:primero|luego|después|segundo|tercero|cuarto|finalmente|por último|y también|además|then|first|second|third|finally|also)\\s+/gi;\n\nexport class MultiIntentManager {\n  async detectMultiIntent(\n    message: string,\n    context?: ConversationContext\n  ): Promise<MultiIntentDetection> {\n    const taskSegments = this.splitIntoTasks(message);\n    const detectedIntents = this.analyzeIntents(message);\n    const hasSeparators = this.detectSeparators(message);\n    \n    const taskCount = Math.max(taskSegments.length, detectedIntents.length);\n    const intentCount = detectedIntents.length;\n    \n    let confidence = 0;\n    \n    if (taskCount > 1) {\n      confidence = 0.5 + (Math.min(taskCount, 4) * 0.15);\n    }\n    \n    if (hasSeparators && taskCount > 1) {\n      confidence += 0.25;\n    }\n    \n    if (message.length > 100 && taskCount > 1) {\n      confidence += 0.1;\n    }\n    \n    if (context?.messages && context.messages.length > 0) {\n      const recentContext = this.analyzeRecentContext(context);\n      if (recentContext.suggestsComplexTask) {\n        confidence += 0.1;\n      }\n    }\n    \n    confidence = Math.min(confidence, 1);\n    \n    const isMultiIntent = confidence >= MULTI_INTENT_THRESHOLD && taskCount > 1;\n    \n    let suggestedPlan: TaskPlan[] | undefined;\n    if (isMultiIntent) {\n      if (taskSegments.length >= detectedIntents.length) {\n        suggestedPlan = this.generateSuggestedPlanFromSegments(message, taskSegments);\n      } else {\n        suggestedPlan = this.generateSuggestedPlan(message, detectedIntents);\n      }\n    }\n    \n    return MultiIntentDetectionSchema.parse({\n      isMultiIntent,\n      confidence,\n      detectedIntents,\n      suggestedPlan\n    });\n  }\n  \n  private splitIntoTasks(message: string): string[] {\n    const segments = message.split(TASK_SPLIT_REGEX)\n      .map(s => s.trim())\n      .filter(s => s.length > 5);\n    \n    if (segments.length <= 1) {\n      const commaAndYSegments = message.split(/(?:,\\s*|\\s+y\\s+)(?=(?:un(?:a|o)?\\s+)?(?:crea|genera|haz|escribe|busca|analiza|resume|resumen|convierte|extrae|navega|abre|diseña|construye|imagen|tabla|lista|make|create|write|search|analyze|summarize|summary|transform|extract|navigate|open|design|build|image|table|list)\\b)/i)\n        .map(s => s.trim())\n        .filter(s => s.length > 5);\n      \n      if (commaAndYSegments.length > 1) {\n        return commaAndYSegments;\n      }\n    }\n    \n    return segments.length > 0 ? segments : [message];\n  }\n  \n  private analyzeIntents(message: string): Array<{\n    type: IntentType;\n    description: string;\n    keywords: string[];\n  }> {\n    const detected: Array<{\n      type: IntentType;\n      description: string;\n      keywords: string[];\n    }> = [];\n    \n    for (const [intentType, patterns] of Object.entries(INTENT_PATTERNS)) {\n      const keywords: string[] = [];\n      \n      for (const pattern of patterns) {\n        const matches = message.match(pattern);\n        if (matches) {\n          keywords.push(matches[0]);\n        }\n      }\n      \n      if (keywords.length > 0) {\n        detected.push({\n          type: intentType as IntentType,\n          description: this.getIntentDescription(intentType as IntentType, message),\n          keywords\n        });\n      }\n    }\n    \n    return detected;\n  }\n  \n  private detectSeparators(message: string): boolean {\n    for (const pattern of SEPARATOR_PATTERNS) {\n      if (pattern.test(message)) {\n        return true;\n      }\n    }\n    return false;\n  }\n  \n  private analyzeRecentContext(context: ConversationContext): {\n    suggestsComplexTask: boolean;\n  } {\n    const recentMessages = context.messages.slice(-3);\n    const complexIndicators = [\n      /\\b(proyecto|project|tarea compleja|complex task)\\b/i,\n      /\\b(varios pasos|multiple steps|proceso|process)\\b/i\n    ];\n    \n    for (const msg of recentMessages) {\n      for (const indicator of complexIndicators) {\n        if (indicator.test(msg.content)) {\n          return { suggestsComplexTask: true };\n        }\n      }\n    }\n    \n    return { suggestsComplexTask: false };\n  }\n  \n  private getIntentDescription(type: IntentType, message: string): string {\n    const descriptions: Record<IntentType, string> = {\n      search: \"Search for information\",\n      analyze: \"Analyze data or content\",\n      generate: \"Generate new content\",\n      transform: \"Transform or convert content\",\n      summarize: \"Summarize information\",\n      extract: \"Extract specific data\",\n      navigate: \"Navigate to web resources\",\n      chat: \"General conversation\"\n    };\n    return descriptions[type] || \"Unknown intent\";\n  }\n  \n  private generateSuggestedPlanFromSegments(\n    originalMessage: string,\n    segments: string[]\n  ): TaskPlan[] {\n    const plan: TaskPlan[] = [];\n    \n    segments.forEach((segment, index) => {\n      const intentType = this.detectIntentTypeForSegment(segment);\n      const title = this.extractTaskTitle(segment);\n      \n      plan.push({\n        id: `task_${index + 1}`,\n        title,\n        intentType,\n        description: segment,\n        requiredContext: [],\n        executionMode: \"sequential\",\n        dependencies: [],\n        priority: segments.length - index\n      });\n    });\n    \n    return plan;\n  }\n  \n  private detectIntentTypeForSegment(segment: string): IntentType {\n    for (const [intentType, patterns] of Object.entries(INTENT_PATTERNS)) {\n      for (const pattern of patterns) {\n        if (pattern.test(segment)) {\n          return intentType as IntentType;\n        }\n      }\n    }\n    return \"generate\";\n  }\n  \n  private extractTaskTitle(segment: string): string {\n    const cleanedSegment = segment\n      .replace(/^(primero|luego|después|segundo|tercero|cuarto|finalmente|por último|y también|además|then|first|second|third|finally|also)\\s*/i, '')\n      .trim();\n    \n    const words = cleanedSegment.split(/\\s+/).slice(0, 8);\n    return words.join(' ') + (cleanedSegment.split(/\\s+/).length > 8 ? '...' : '');\n  }\n  \n  private generateSuggestedPlan(\n    message: string,\n    intents: Array<{ type: IntentType; description: string; keywords: string[] }>\n  ): TaskPlan[] {\n    const plan: TaskPlan[] = [];\n    \n    intents.forEach((intent, index) => {\n      const hasDependent = index > 0 && this.intentsDependOnPrevious(intents[index - 1].type, intent.type);\n      \n      const relevantText = this.extractRelevantTextForIntent(message, intent.keywords);\n      \n      plan.push({\n        id: `task_${index + 1}`,\n        title: this.extractTaskTitle(relevantText),\n        intentType: intent.type,\n        description: relevantText,\n        requiredContext: hasDependent ? [`task_${index}`] : [],\n        executionMode: hasDependent ? \"sequential\" : \"parallel\",\n        dependencies: hasDependent ? [`task_${index}`] : [],\n        priority: intents.length - index\n      });\n    });\n    \n    return plan;\n  }\n  \n  private extractRelevantTextForIntent(message: string, keywords: string[]): string {\n    if (keywords.length === 0) return message;\n    \n    const keywordPattern = new RegExp(`(${keywords.map(k => k.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')).join('|')})`, 'i');\n    const match = message.match(keywordPattern);\n    \n    if (!match || match.index === undefined) return message;\n    \n    const startIndex = match.index;\n    const afterKeyword = message.slice(startIndex);\n    \n    const endMatch = afterKeyword.match(/[.,;]\\s*(?=(?:crea|genera|haz|escribe|busca|analiza|resume|convierte|extrae|navega|abre|diseña|construye|investiga|make|create|write|search|analyze|summarize|transform|extract|navigate|open|design|build|investigate|y\\s+(?:un|una|el|la))\\b)/i);\n    \n    if (endMatch && endMatch.index !== undefined) {\n      return afterKeyword.slice(0, endMatch.index).trim();\n    }\n    \n    const sentenceEnd = afterKeyword.match(/[.!?]\\s+(?=[A-ZÁÉÍÓÚÑ])/);\n    if (sentenceEnd && sentenceEnd.index !== undefined) {\n      return afterKeyword.slice(0, sentenceEnd.index + 1).trim();\n    }\n    \n    return afterKeyword.trim();\n  }\n  \n  private intentsDependOnPrevious(prev: IntentType, current: IntentType): boolean {\n    const dependencyMap: Record<IntentType, IntentType[]> = {\n      summarize: [\"search\", \"extract\", \"navigate\"],\n      analyze: [\"search\", \"extract\", \"navigate\"],\n      transform: [\"search\", \"extract\", \"generate\"],\n      generate: [\"search\", \"analyze\"],\n      extract: [\"search\", \"navigate\"],\n      search: [],\n      navigate: [],\n      chat: []\n    };\n    \n    return dependencyMap[current]?.includes(prev) ?? false;\n  }\n}\n\nexport const multiIntentManager = new MultiIntentManager();\n","path":null,"size_bytes":10245,"size_tokens":null},"client/src/lib/fileTypeTheme.ts":{"content":"export type FileCategory = \n  | \"pdf\" \n  | \"word\" \n  | \"excel\" \n  | \"ppt\" \n  | \"image\" \n  | \"text\" \n  | \"code\" \n  | \"archive\" \n  | \"unknown\";\n\nexport interface FileTypeTheme {\n  category: FileCategory;\n  bgColor: string;\n  textColor: string;\n  darkTextColor: string;\n  gradientFrom: string;\n  gradientTo: string;\n  icon: string;\n  label: string;\n}\n\nconst fileThemes: Record<FileCategory, FileTypeTheme> = {\n  pdf: {\n    category: \"pdf\",\n    bgColor: \"bg-red-600\",\n    textColor: \"text-red-600\",\n    darkTextColor: \"text-red-400\",\n    gradientFrom: \"from-red-500\",\n    gradientTo: \"to-red-700\",\n    icon: \"PDF\",\n    label: \"PDF Document\",\n  },\n  word: {\n    category: \"word\",\n    bgColor: \"bg-blue-600\",\n    textColor: \"text-blue-600\",\n    darkTextColor: \"text-blue-400\",\n    gradientFrom: \"from-blue-500\",\n    gradientTo: \"to-blue-700\",\n    icon: \"W\",\n    label: \"Word Document\",\n  },\n  excel: {\n    category: \"excel\",\n    bgColor: \"bg-green-600\",\n    textColor: \"text-green-600\",\n    darkTextColor: \"text-green-400\",\n    gradientFrom: \"from-green-500\",\n    gradientTo: \"to-green-700\",\n    icon: \"E\",\n    label: \"Excel Spreadsheet\",\n  },\n  ppt: {\n    category: \"ppt\",\n    bgColor: \"bg-orange-500\",\n    textColor: \"text-orange-500\",\n    darkTextColor: \"text-orange-400\",\n    gradientFrom: \"from-orange-400\",\n    gradientTo: \"to-orange-600\",\n    icon: \"P\",\n    label: \"PowerPoint\",\n  },\n  image: {\n    category: \"image\",\n    bgColor: \"bg-purple-500\",\n    textColor: \"text-purple-500\",\n    darkTextColor: \"text-purple-400\",\n    gradientFrom: \"from-purple-500\",\n    gradientTo: \"to-purple-700\",\n    icon: \"IMG\",\n    label: \"Image\",\n  },\n  text: {\n    category: \"text\",\n    bgColor: \"bg-slate-500\",\n    textColor: \"text-slate-500\",\n    darkTextColor: \"text-slate-400\",\n    gradientFrom: \"from-slate-500\",\n    gradientTo: \"to-slate-700\",\n    icon: \"TXT\",\n    label: \"Text File\",\n  },\n  code: {\n    category: \"code\",\n    bgColor: \"bg-indigo-500\",\n    textColor: \"text-indigo-500\",\n    darkTextColor: \"text-indigo-400\",\n    gradientFrom: \"from-indigo-500\",\n    gradientTo: \"to-indigo-700\",\n    icon: \"</>\",\n    label: \"Code File\",\n  },\n  archive: {\n    category: \"archive\",\n    bgColor: \"bg-amber-500\",\n    textColor: \"text-amber-500\",\n    darkTextColor: \"text-amber-400\",\n    gradientFrom: \"from-amber-500\",\n    gradientTo: \"to-amber-700\",\n    icon: \"ZIP\",\n    label: \"Archive\",\n  },\n  unknown: {\n    category: \"unknown\",\n    bgColor: \"bg-gray-500\",\n    textColor: \"text-gray-500\",\n    darkTextColor: \"text-gray-400\",\n    gradientFrom: \"from-gray-500\",\n    gradientTo: \"to-gray-700\",\n    icon: \"?\",\n    label: \"File\",\n  },\n};\n\nconst extensionMap: Record<string, FileCategory> = {\n  // PDF\n  pdf: \"pdf\",\n  // Word\n  doc: \"word\",\n  docx: \"word\",\n  docm: \"word\",\n  odt: \"word\",\n  rtf: \"word\",\n  // Excel\n  xls: \"excel\",\n  xlsx: \"excel\",\n  xlsm: \"excel\",\n  xlsb: \"excel\",\n  ods: \"excel\",\n  csv: \"excel\",\n  // PowerPoint\n  ppt: \"ppt\",\n  pptx: \"ppt\",\n  pptm: \"ppt\",\n  odp: \"ppt\",\n  // Images\n  jpg: \"image\",\n  jpeg: \"image\",\n  png: \"image\",\n  gif: \"image\",\n  bmp: \"image\",\n  webp: \"image\",\n  svg: \"image\",\n  ico: \"image\",\n  tiff: \"image\",\n  tif: \"image\",\n  heic: \"image\",\n  heif: \"image\",\n  // Text\n  txt: \"text\",\n  md: \"text\",\n  markdown: \"text\",\n  // Code\n  js: \"code\",\n  ts: \"code\",\n  jsx: \"code\",\n  tsx: \"code\",\n  py: \"code\",\n  java: \"code\",\n  c: \"code\",\n  cpp: \"code\",\n  h: \"code\",\n  hpp: \"code\",\n  cs: \"code\",\n  go: \"code\",\n  rs: \"code\",\n  rb: \"code\",\n  php: \"code\",\n  html: \"code\",\n  css: \"code\",\n  scss: \"code\",\n  less: \"code\",\n  json: \"code\",\n  xml: \"code\",\n  yaml: \"code\",\n  yml: \"code\",\n  sql: \"code\",\n  sh: \"code\",\n  bash: \"code\",\n  // Archives\n  zip: \"archive\",\n  rar: \"archive\",\n  \"7z\": \"archive\",\n  tar: \"archive\",\n  gz: \"archive\",\n  bz2: \"archive\",\n};\n\nconst mimeTypeMap: Record<string, FileCategory> = {\n  // PDF\n  \"application/pdf\": \"pdf\",\n  // Word\n  \"application/msword\": \"word\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\": \"word\",\n  \"application/vnd.oasis.opendocument.text\": \"word\",\n  \"application/rtf\": \"word\",\n  // Excel\n  \"application/vnd.ms-excel\": \"excel\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\": \"excel\",\n  \"application/vnd.oasis.opendocument.spreadsheet\": \"excel\",\n  \"text/csv\": \"excel\",\n  // PowerPoint\n  \"application/vnd.ms-powerpoint\": \"ppt\",\n  \"application/vnd.openxmlformats-officedocument.presentationml.presentation\": \"ppt\",\n  \"application/vnd.oasis.opendocument.presentation\": \"ppt\",\n  // Images\n  \"image/jpeg\": \"image\",\n  \"image/png\": \"image\",\n  \"image/gif\": \"image\",\n  \"image/webp\": \"image\",\n  \"image/svg+xml\": \"image\",\n  \"image/bmp\": \"image\",\n  \"image/tiff\": \"image\",\n  \"image/x-icon\": \"image\",\n  // Text\n  \"text/plain\": \"text\",\n  \"text/markdown\": \"text\",\n  // Code\n  \"application/javascript\": \"code\",\n  \"application/typescript\": \"code\",\n  \"text/javascript\": \"code\",\n  \"text/html\": \"code\",\n  \"text/css\": \"code\",\n  \"application/json\": \"code\",\n  \"application/xml\": \"code\",\n  \"text/xml\": \"code\",\n  // Archives\n  \"application/zip\": \"archive\",\n  \"application/x-rar-compressed\": \"archive\",\n  \"application/x-7z-compressed\": \"archive\",\n  \"application/x-tar\": \"archive\",\n  \"application/gzip\": \"archive\",\n};\n\nexport function getFileCategory(fileName?: string, mimeType?: string): FileCategory {\n  // First try to get category from extension (more reliable)\n  if (fileName) {\n    const ext = fileName.split(\".\").pop()?.toLowerCase();\n    if (ext && extensionMap[ext]) {\n      return extensionMap[ext];\n    }\n  }\n  \n  // Fallback to MIME type\n  if (mimeType) {\n    const lowerMime = mimeType.toLowerCase();\n    if (mimeTypeMap[lowerMime]) {\n      return mimeTypeMap[lowerMime];\n    }\n    \n    // Generic MIME type handling\n    if (lowerMime.includes(\"pdf\")) return \"pdf\";\n    if (lowerMime.includes(\"word\") || lowerMime.includes(\"document\")) return \"word\";\n    if (lowerMime.includes(\"excel\") || lowerMime.includes(\"spreadsheet\")) return \"excel\";\n    if (lowerMime.includes(\"powerpoint\") || lowerMime.includes(\"presentation\")) return \"ppt\";\n    if (lowerMime.startsWith(\"image/\")) return \"image\";\n    if (lowerMime.startsWith(\"text/\")) return \"text\";\n  }\n  \n  return \"unknown\";\n}\n\nexport function getFileTheme(fileName?: string, mimeType?: string): FileTypeTheme {\n  const category = getFileCategory(fileName, mimeType);\n  return fileThemes[category];\n}\n\nexport function getFileThemeByCategory(category: FileCategory): FileTypeTheme {\n  return fileThemes[category];\n}\n\nexport { fileThemes };\n","path":null,"size_bytes":6471,"size_tokens":null},"client/src/components/code-execution-block.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  ChevronDown, \n  ChevronRight, \n  Copy, \n  Check, \n  AlertCircle,\n  CheckCircle2,\n  Loader2,\n  Terminal,\n  Code2,\n  Download,\n  Maximize2,\n  X\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Prism as SyntaxHighlighter } from \"react-syntax-highlighter\";\nimport { oneDark } from \"react-syntax-highlighter/dist/esm/styles/prism\";\n\ninterface CodeArtifact {\n  id: string;\n  type: string;\n  name: string;\n  data: string;\n  mimeType: string;\n}\n\ninterface CodeRun {\n  id: string;\n  code: string;\n  language: string;\n  status: string;\n  stdout: string | null;\n  stderr: string | null;\n  executionTimeMs: number | null;\n}\n\ninterface CodeExecutionBlockProps {\n  code: string;\n  language?: string;\n  conversationId?: string;\n  autoRun?: boolean;\n  onExecuted?: (run: CodeRun, artifacts: CodeArtifact[]) => void;\n}\n\nfunction generateCodeDescription(code: string): string {\n  const lines = code.toLowerCase();\n  \n  if (lines.includes('plt.bar') || lines.includes('bar(')) {\n    return 'Generando gráfica de barras';\n  }\n  if (lines.includes('plt.plot') || lines.includes('.plot(')) {\n    return 'Generando gráfica de líneas';\n  }\n  if (lines.includes('plt.pie') || lines.includes('pie(')) {\n    return 'Generando gráfica circular';\n  }\n  if (lines.includes('plt.scatter') || lines.includes('scatter(')) {\n    return 'Generando gráfica de dispersión';\n  }\n  if (lines.includes('plt.hist') || lines.includes('histogram')) {\n    return 'Generando histograma';\n  }\n  if (lines.includes('matplotlib') || lines.includes('plt.')) {\n    return 'Generando visualización';\n  }\n  if (lines.includes('pandas') || lines.includes('read_csv') || lines.includes('dataframe')) {\n    return 'Procesando datos';\n  }\n  if (lines.includes('requests') || lines.includes('urllib') || lines.includes('fetch')) {\n    return 'Realizando petición HTTP';\n  }\n  if (lines.includes('open(') && (lines.includes('write') || lines.includes('read'))) {\n    return 'Procesando archivo';\n  }\n  if (lines.includes('def ') || lines.includes('class ')) {\n    return 'Definiendo función/clase';\n  }\n  if (lines.includes('print(')) {\n    return 'Ejecutando código Python';\n  }\n  \n  return 'Código Python ejecutable';\n}\n\nexport function CodeExecutionBlock({\n  code,\n  language = \"python\",\n  conversationId,\n  autoRun = true,\n  onExecuted,\n}: CodeExecutionBlockProps) {\n  const [isExpanded, setIsExpanded] = useState(false);\n  const [copied, setCopied] = useState(false);\n  const [copiedImage, setCopiedImage] = useState(false);\n  const [isRunning, setIsRunning] = useState(false);\n  const [run, setRun] = useState<CodeRun | null>(null);\n  const [artifacts, setArtifacts] = useState<CodeArtifact[]>([]);\n  const [hasAutoRun, setHasAutoRun] = useState(false);\n  const [fullscreenImage, setFullscreenImage] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const description = generateCodeDescription(code);\n\n  const handleDownloadImage = (dataUrl: string, filename: string) => {\n    const link = document.createElement('a');\n    link.href = dataUrl;\n    link.download = filename || 'grafica.png';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    toast({ title: \"Imagen descargada\" });\n  };\n\n  const handleCopyImage = async (dataUrl: string) => {\n    try {\n      // Convert base64 to blob\n      const base64Data = dataUrl.split(',')[1];\n      const byteCharacters = atob(base64Data);\n      const byteNumbers = new Array(byteCharacters.length);\n      for (let i = 0; i < byteCharacters.length; i++) {\n        byteNumbers[i] = byteCharacters.charCodeAt(i);\n      }\n      const byteArray = new Uint8Array(byteNumbers);\n      const blob = new Blob([byteArray], { type: 'image/png' });\n      \n      await navigator.clipboard.write([\n        new ClipboardItem({ 'image/png': blob })\n      ]);\n      setCopiedImage(true);\n      toast({ title: \"Imagen copiada al portapapeles\" });\n      setTimeout(() => setCopiedImage(false), 2000);\n    } catch (error) {\n      // Fallback: download the image instead\n      console.error(\"Copy failed, using fallback:\", error);\n      handleDownloadImage(dataUrl, 'grafica.png');\n      toast({ title: \"Imagen descargada (el navegador no soporta copiar imágenes)\" });\n    }\n  };\n\n  // Auto-execute code on mount\n  useEffect(() => {\n    if (autoRun && !hasAutoRun && !isRunning && !run) {\n      setHasAutoRun(true);\n      executeCode();\n    }\n  }, [autoRun, hasAutoRun, isRunning, run]);\n\n  const executeCode = async () => {\n    if (isRunning) return;\n    \n    setIsRunning(true);\n    setRun(null);\n    setArtifacts([]);\n\n    try {\n      const response = await fetch(\"/api/code-interpreter/run\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ code, conversationId, language }),\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Error ejecutando código\");\n      }\n\n      const result = await response.json();\n      setRun(result.run);\n      setArtifacts(result.artifacts || []);\n      \n      if (onExecuted) {\n        onExecuted(result.run, result.artifacts || []);\n      }\n    } catch (error) {\n      console.error(\"Code execution error:\", error);\n      setRun({\n        id: \"error\",\n        code,\n        language,\n        status: \"error\",\n        stdout: null,\n        stderr: \"No se pudo ejecutar el código. El servidor no está disponible.\",\n        executionTimeMs: null,\n      });\n    } finally {\n      setIsRunning(false);\n    }\n  };\n\n  const handleCopyCode = async (e: React.MouseEvent) => {\n    e.stopPropagation();\n    await navigator.clipboard.writeText(code);\n    setCopied(true);\n    toast({\n      title: \"Código copiado\",\n      description: \"El código ha sido copiado al portapapeles.\",\n    });\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n\n  const getStatusBadge = () => {\n    if (isRunning) {\n      return (\n        <span className=\"flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 text-xs\">\n          <Loader2 className=\"w-3 h-3 animate-spin\" />\n          Ejecutando...\n        </span>\n      );\n    }\n    if (run?.status === \"success\") {\n      return (\n        <span className=\"flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 text-xs\">\n          <CheckCircle2 className=\"w-3 h-3\" />\n          Completado\n          {run.executionTimeMs && (\n            <span className=\"text-green-500/70\">\n              ({(run.executionTimeMs / 1000).toFixed(1)}s)\n            </span>\n          )}\n        </span>\n      );\n    }\n    if (run?.status === \"error\") {\n      return (\n        <span className=\"flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 text-xs\">\n          <AlertCircle className=\"w-3 h-3\" />\n          Error\n        </span>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div \n      className=\"my-4 rounded-xl border border-border/50 overflow-hidden bg-gradient-to-b from-[#1a1a1a] to-[#141414] shadow-lg\"\n      data-testid=\"code-execution-block\"\n    >\n      <button\n        onClick={() => setIsExpanded(!isExpanded)}\n        className=\"w-full flex items-center justify-between px-4 py-3 bg-[#1e1e1e] hover:bg-[#252525] transition-colors cursor-pointer border-b border-border/30\"\n        aria-expanded={isExpanded}\n        data-testid=\"toggle-code\"\n      >\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500/20 to-teal-500/20 border border-emerald-500/30\">\n            <Terminal className=\"w-4 h-4 text-emerald-400\" />\n          </div>\n          <div className=\"flex flex-col items-start\">\n            <span className=\"text-sm font-medium text-gray-200\">\n              {description}\n            </span>\n            <span className=\"text-xs text-gray-500 flex items-center gap-1\">\n              <Code2 className=\"w-3 h-3\" />\n              {language} • {code.split('\\n').length} líneas\n            </span>\n          </div>\n        </div>\n        \n        <div className=\"flex items-center gap-2\">\n          {getStatusBadge()}\n          \n          <div className=\"flex items-center gap-1 ml-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-8 w-8 p-0 text-gray-400 hover:text-white hover:bg-white/10\"\n              onClick={handleCopyCode}\n              data-testid=\"copy-code\"\n            >\n              {copied ? (\n                <Check className=\"w-4 h-4 text-green-400\" />\n              ) : (\n                <Copy className=\"w-4 h-4\" />\n              )}\n            </Button>\n          </div>\n          \n          <div className=\"w-6 h-6 flex items-center justify-center text-gray-500\">\n            {isExpanded ? (\n              <ChevronDown className=\"w-4 h-4\" />\n            ) : (\n              <ChevronRight className=\"w-4 h-4\" />\n            )}\n          </div>\n        </div>\n      </button>\n\n      {isExpanded && (\n        <div className=\"max-h-[400px] overflow-auto border-b border-border/30\">\n          <SyntaxHighlighter\n            language={language}\n            style={oneDark}\n            customStyle={{\n              margin: 0,\n              padding: \"1rem\",\n              fontSize: \"0.8125rem\",\n              background: \"transparent\",\n              lineHeight: 1.6,\n            }}\n            showLineNumbers\n            lineNumberStyle={{\n              minWidth: \"2.5em\",\n              paddingRight: \"1em\",\n              color: \"#4a4a4a\",\n              userSelect: \"none\",\n            }}\n          >\n            {code}\n          </SyntaxHighlighter>\n        </div>\n      )}\n\n      {run && run.stdout && (\n        <div className=\"border-t border-border/30\">\n          <div className=\"px-4 py-2 bg-[#1a1a1a] flex items-center gap-2\">\n            <Terminal className=\"w-3.5 h-3.5 text-gray-500\" />\n            <span className=\"text-xs text-gray-500 uppercase tracking-wide font-medium\">\n              Salida de consola\n            </span>\n          </div>\n          <pre className=\"px-4 py-3 text-sm text-gray-300 font-mono whitespace-pre-wrap overflow-auto max-h-[200px] bg-black/20\">\n            {run.stdout}\n          </pre>\n        </div>\n      )}\n      \n      {run && run.stderr && (\n        <div className=\"border-t border-red-500/20\">\n          <div className=\"px-4 py-2 bg-red-950/30 flex items-center gap-2\">\n            <AlertCircle className=\"w-3.5 h-3.5 text-red-400\" />\n            <span className=\"text-xs text-red-400 uppercase tracking-wide font-medium\">\n              Error\n            </span>\n          </div>\n          <pre className=\"px-4 py-3 text-sm text-red-400 font-mono whitespace-pre-wrap overflow-auto max-h-[200px] bg-red-950/10\">\n            {run.stderr}\n          </pre>\n        </div>\n      )}\n\n      {artifacts.length > 0 && (\n        <div className=\"border-t border-border/30 bg-white dark:bg-gray-900\">\n          {artifacts.map((artifact) => {\n            const imageDataUrl = `data:${artifact.mimeType};base64,${artifact.data}`;\n            return (\n              <div key={artifact.id} data-testid={`artifact-${artifact.id}`}>\n                {artifact.type === \"image\" && artifact.mimeType?.startsWith(\"image/\") && (\n                  <div className=\"p-4 flex justify-center\">\n                    <div className=\"relative group\">\n                      <img\n                        src={imageDataUrl}\n                        alt={artifact.name}\n                        className=\"max-w-full h-auto rounded-lg shadow-md cursor-pointer\"\n                        style={{ maxHeight: \"500px\" }}\n                        onClick={() => setFullscreenImage(imageDataUrl)}\n                      />\n                      <div className=\"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                        <Button\n                          variant=\"secondary\"\n                          size=\"icon\"\n                          className=\"h-8 w-8 bg-black/60 hover:bg-black/80 text-white border-0\"\n                          onClick={(e) => { e.stopPropagation(); handleDownloadImage(imageDataUrl, artifact.name || 'grafica.png'); }}\n                          data-testid=\"download-image\"\n                        >\n                          <Download className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"secondary\"\n                          size=\"icon\"\n                          className=\"h-8 w-8 bg-black/60 hover:bg-black/80 text-white border-0\"\n                          onClick={(e) => { e.stopPropagation(); setFullscreenImage(imageDataUrl); }}\n                          data-testid=\"fullscreen-image\"\n                        >\n                          <Maximize2 className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"secondary\"\n                          size=\"icon\"\n                          className=\"h-8 w-8 bg-black/60 hover:bg-black/80 text-white border-0\"\n                          onClick={(e) => { e.stopPropagation(); handleCopyImage(imageDataUrl); }}\n                          data-testid=\"copy-image\"\n                        >\n                          {copiedImage ? <Check className=\"h-4 w-4 text-green-400\" /> : <Copy className=\"h-4 w-4\" />}\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                )}\n                {artifact.type === \"file\" && (\n                  <div className=\"p-4\">\n                    <div className=\"flex items-center gap-2 p-3 bg-gray-100 rounded-lg\">\n                      <Code2 className=\"w-4 h-4 text-gray-600\" />\n                      <span className=\"text-sm text-gray-700\">{artifact.name}</span>\n                    </div>\n                  </div>\n                )}\n              </div>\n            );\n          })}\n        </div>\n      )}\n\n      {fullscreenImage && (\n        <div \n          className=\"fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4\"\n          onClick={() => setFullscreenImage(null)}\n        >\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"absolute top-4 right-4 h-10 w-10 text-white hover:bg-white/20\"\n            onClick={() => setFullscreenImage(null)}\n          >\n            <X className=\"h-6 w-6\" />\n          </Button>\n          <img\n            src={fullscreenImage}\n            alt=\"Imagen en pantalla completa\"\n            className=\"max-w-full max-h-full object-contain rounded-lg\"\n            onClick={(e) => e.stopPropagation()}\n          />\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14790,"size_tokens":null},"server/services/codeInterpreterService.ts":{"content":"import { spawn } from \"child_process\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport * as os from \"os\";\nimport { db } from \"../db\";\nimport {\n  codeInterpreterRuns,\n  codeInterpreterArtifacts,\n  InsertCodeInterpreterRun,\n  InsertCodeInterpreterArtifact,\n  CodeInterpreterRun,\n  CodeInterpreterArtifact,\n} from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nconst EXECUTION_TIMEOUT_MS = 30000;\nconst MAX_OUTPUT_SIZE = 100000;\n\ninterface ExecutionResult {\n  success: boolean;\n  stdout: string;\n  stderr: string;\n  executionTimeMs: number;\n  artifacts: Array<{\n    type: string;\n    name: string;\n    data: string;\n    mimeType: string;\n  }>;\n}\n\nconst PYTHON_SETUP = `\nimport sys\nimport os\nimport matplotlib\nmatplotlib.use('Agg')\nimport matplotlib.pyplot as plt\nimport io\nimport base64\nimport json\n\n_ARTIFACTS = []\n_OUTPUT_DIR = os.environ.get('OUTPUT_DIR', '/tmp')\n\ndef _capture_figure(fig=None, name='figure'):\n    if fig is None:\n        fig = plt.gcf()\n    buf = io.BytesIO()\n    fig.savefig(buf, format='png', dpi=150, bbox_inches='tight')\n    buf.seek(0)\n    data = base64.b64encode(buf.read()).decode('utf-8')\n    _ARTIFACTS.append({\n        'type': 'image',\n        'name': name + '.png',\n        'data': data,\n        'mimeType': 'image/png'\n    })\n    plt.close(fig)\n\n_original_show = plt.show\ndef _patched_show(*args, **kwargs):\n    _capture_figure(name=f'figure_{len(_ARTIFACTS)}')\nplt.show = _patched_show\n\ndef save_artifact(data, name, mime_type='application/octet-stream'):\n    if isinstance(data, bytes):\n        encoded = base64.b64encode(data).decode('utf-8')\n    else:\n        encoded = base64.b64encode(data.encode('utf-8')).decode('utf-8')\n    _ARTIFACTS.append({\n        'type': 'file',\n        'name': name,\n        'data': encoded,\n        'mimeType': mime_type\n    })\n\n`;\n\nconst PYTHON_TEARDOWN = `\nimport json\nprint(\"\\\\n__ARTIFACTS_JSON__:\" + json.dumps(_ARTIFACTS))\n`;\n\nexport async function executeCode(\n  code: string,\n  options: {\n    conversationId?: string;\n    userId?: string;\n    language?: string;\n  } = {}\n): Promise<{ run: CodeInterpreterRun; artifacts: CodeInterpreterArtifact[] }> {\n  const language = options.language || \"python\";\n\n  const runRecord = await db\n    .insert(codeInterpreterRuns)\n    .values({\n      conversationId: options.conversationId || null,\n      userId: options.userId || null,\n      code,\n      language,\n      status: \"running\",\n    } as InsertCodeInterpreterRun)\n    .returning();\n\n  const run = runRecord[0];\n  const result = await runPythonCode(code);\n\n  const updatedRun = await db\n    .update(codeInterpreterRuns)\n    .set({\n      status: result.success ? \"success\" : \"error\",\n      stdout: result.stdout.slice(0, MAX_OUTPUT_SIZE),\n      stderr: result.stderr.slice(0, MAX_OUTPUT_SIZE),\n      executionTimeMs: result.executionTimeMs,\n    })\n    .where(eq(codeInterpreterRuns.id, run.id))\n    .returning();\n\n  const artifacts: CodeInterpreterArtifact[] = [];\n  for (const artifact of result.artifacts) {\n    const inserted = await db\n      .insert(codeInterpreterArtifacts)\n      .values({\n        runId: run.id,\n        type: artifact.type,\n        name: artifact.name,\n        data: artifact.data,\n        mimeType: artifact.mimeType,\n      } as InsertCodeInterpreterArtifact)\n      .returning();\n    artifacts.push(inserted[0]);\n  }\n\n  return { run: updatedRun[0], artifacts };\n}\n\nasync function runPythonCode(code: string): Promise<ExecutionResult> {\n  const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), \"code-interpreter-\"));\n  const scriptPath = path.join(tmpDir, \"script.py\");\n\n  const fullCode = PYTHON_SETUP + code + PYTHON_TEARDOWN;\n  fs.writeFileSync(scriptPath, fullCode, \"utf-8\");\n\n  const startTime = Date.now();\n\n  return new Promise((resolve) => {\n    let stdout = \"\";\n    let stderr = \"\";\n    let timedOut = false;\n\n    const proc = spawn(\"python3\", [scriptPath], {\n      cwd: tmpDir,\n      env: {\n        ...process.env,\n        OUTPUT_DIR: tmpDir,\n        MPLBACKEND: \"Agg\",\n      },\n      timeout: EXECUTION_TIMEOUT_MS,\n    });\n\n    const timeoutHandle = setTimeout(() => {\n      timedOut = true;\n      proc.kill(\"SIGKILL\");\n    }, EXECUTION_TIMEOUT_MS);\n\n    proc.stdout.on(\"data\", (data) => {\n      stdout += data.toString();\n    });\n\n    proc.stderr.on(\"data\", (data) => {\n      stderr += data.toString();\n    });\n\n    proc.on(\"close\", (code) => {\n      clearTimeout(timeoutHandle);\n      const executionTimeMs = Date.now() - startTime;\n\n      try {\n        fs.rmSync(tmpDir, { recursive: true, force: true });\n      } catch {}\n\n      if (timedOut) {\n        resolve({\n          success: false,\n          stdout,\n          stderr: stderr + \"\\nExecution timed out after 30 seconds\",\n          executionTimeMs,\n          artifacts: [],\n        });\n        return;\n      }\n\n      let artifacts: ExecutionResult[\"artifacts\"] = [];\n      const artifactMatch = stdout.match(/__ARTIFACTS_JSON__:(.+)$/m);\n      if (artifactMatch) {\n        try {\n          artifacts = JSON.parse(artifactMatch[1]);\n          stdout = stdout.replace(/__ARTIFACTS_JSON__:.+$/m, \"\").trim();\n        } catch {}\n      }\n\n      resolve({\n        success: code === 0,\n        stdout,\n        stderr,\n        executionTimeMs,\n        artifacts,\n      });\n    });\n\n    proc.on(\"error\", (err) => {\n      clearTimeout(timeoutHandle);\n      const executionTimeMs = Date.now() - startTime;\n\n      try {\n        fs.rmSync(tmpDir, { recursive: true, force: true });\n      } catch {}\n\n      resolve({\n        success: false,\n        stdout,\n        stderr: stderr + \"\\n\" + err.message,\n        executionTimeMs,\n        artifacts: [],\n      });\n    });\n  });\n}\n\nexport async function getRun(runId: string): Promise<CodeInterpreterRun | null> {\n  const runs = await db\n    .select()\n    .from(codeInterpreterRuns)\n    .where(eq(codeInterpreterRuns.id, runId));\n  return runs[0] || null;\n}\n\nexport async function getRunArtifacts(runId: string): Promise<CodeInterpreterArtifact[]> {\n  return db\n    .select()\n    .from(codeInterpreterArtifacts)\n    .where(eq(codeInterpreterArtifacts.runId, runId));\n}\n\nexport async function getRunsByConversation(conversationId: string): Promise<CodeInterpreterRun[]> {\n  return db\n    .select()\n    .from(codeInterpreterRuns)\n    .where(eq(codeInterpreterRuns.conversationId, conversationId));\n}\n","path":null,"size_bytes":6300,"size_tokens":null},"main.py":{"content":"def main():\n    print(\"Hello from repl-nix-workspace!\")\n\n\nif __name__ == \"__main__\":\n    main()\n","path":null,"size_bytes":96,"size_tokens":null},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"matplotlib>=3.10.8\",\n    \"numpy>=2.3.5\",\n]\n","path":null,"size_bytes":190,"size_tokens":null},"server/lib/fileProcessingQueue.ts":{"content":"export interface FileJob {\n  fileId: string;\n  storagePath: string;\n  mimeType: string;\n  fileName: string;\n  status: 'pending' | 'processing' | 'completed' | 'failed';\n  progress: number;\n  retries: number;\n  error?: string;\n  startedAt?: Date;\n  completedAt?: Date;\n}\n\nexport type FileStatusUpdate = {\n  type: 'file_status';\n  fileId: string;\n  status: FileJob['status'];\n  progress: number;\n  error?: string;\n};\n\nexport class FileProcessingQueue {\n  private jobs: Map<string, FileJob> = new Map();\n  private queue: string[] = [];\n  private processing: boolean = false;\n  private onStatusChange?: (update: FileStatusUpdate) => void;\n  private processCallback?: (job: FileJob) => Promise<void>;\n  private maxRetries: number = 3;\n\n  enqueue(job: Omit<FileJob, 'status' | 'retries' | 'progress'>): FileJob {\n    const newJob: FileJob = {\n      ...job,\n      status: 'pending',\n      progress: 0,\n      retries: 0,\n    };\n    \n    this.jobs.set(job.fileId, newJob);\n    this.queue.push(job.fileId);\n    this.notifyStatusChange(newJob);\n    \n    if (!this.processing) {\n      this.processNext();\n    }\n    \n    return newJob;\n  }\n\n  setStatusChangeHandler(handler: (update: FileStatusUpdate) => void): void {\n    this.onStatusChange = handler;\n  }\n\n  setProcessCallback(callback: (job: FileJob) => Promise<void>): void {\n    this.processCallback = callback;\n  }\n\n  getJob(fileId: string): FileJob | undefined {\n    return this.jobs.get(fileId);\n  }\n\n  getAllJobs(): FileJob[] {\n    return Array.from(this.jobs.values());\n  }\n\n  getPendingJobs(): FileJob[] {\n    return Array.from(this.jobs.values()).filter(j => j.status === 'pending');\n  }\n\n  getProcessingJobs(): FileJob[] {\n    return Array.from(this.jobs.values()).filter(j => j.status === 'processing');\n  }\n\n  updateProgress(fileId: string, progress: number): void {\n    const job = this.jobs.get(fileId);\n    if (job && job.status === 'processing') {\n      job.progress = Math.min(100, Math.max(0, progress));\n      this.notifyStatusChange(job);\n    }\n  }\n\n  markCompleted(fileId: string): void {\n    const job = this.jobs.get(fileId);\n    if (job) {\n      job.status = 'completed';\n      job.progress = 100;\n      job.completedAt = new Date();\n      this.notifyStatusChange(job);\n    }\n  }\n\n  markFailed(fileId: string, error: string): void {\n    const job = this.jobs.get(fileId);\n    if (job) {\n      job.retries++;\n      if (job.retries < this.maxRetries) {\n        job.status = 'pending';\n        job.error = error;\n        this.queue.push(fileId);\n        this.notifyStatusChange(job);\n        if (!this.processing) {\n          this.processNext();\n        }\n      } else {\n        job.status = 'failed';\n        job.error = error;\n        job.completedAt = new Date();\n        this.notifyStatusChange(job);\n      }\n    }\n  }\n\n  removeJob(fileId: string): boolean {\n    this.queue = this.queue.filter(id => id !== fileId);\n    return this.jobs.delete(fileId);\n  }\n\n  private async processNext(): Promise<void> {\n    if (this.processing || this.queue.length === 0) {\n      return;\n    }\n\n    const fileId = this.queue.shift();\n    if (!fileId) {\n      return;\n    }\n\n    const job = this.jobs.get(fileId);\n    if (!job || job.status !== 'pending') {\n      this.processNext();\n      return;\n    }\n\n    this.processing = true;\n    job.status = 'processing';\n    job.startedAt = new Date();\n    this.notifyStatusChange(job);\n\n    try {\n      if (this.processCallback) {\n        await this.processCallback(job);\n      }\n      this.markCompleted(fileId);\n    } catch (error: any) {\n      console.error(`[FileQueue] Error processing job ${fileId}:`, error);\n      this.markFailed(fileId, error.message || 'Unknown error');\n    } finally {\n      this.processing = false;\n      this.processNext();\n    }\n  }\n\n  private notifyStatusChange(job: FileJob): void {\n    if (this.onStatusChange) {\n      this.onStatusChange({\n        type: 'file_status',\n        fileId: job.fileId,\n        status: job.status,\n        progress: job.progress,\n        error: job.error,\n      });\n    }\n  }\n}\n\nexport const fileProcessingQueue = new FileProcessingQueue();\n","path":null,"size_bytes":4097,"size_tokens":null},"client/src/components/FileUploadProgress.tsx":{"content":"import { useState } from \"react\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  CheckCircle2,\n  Loader2,\n  AlertCircle,\n  FileCheck,\n  Upload,\n  Cog,\n  X,\n  RefreshCw,\n} from \"lucide-react\";\n\nexport interface FileUploadProgressProps {\n  fileName: string;\n  phase: 'validating' | 'uploading' | 'processing' | 'completed' | 'error';\n  uploadProgress: number;\n  processingProgress: number;\n  error?: string;\n  onCancel?: () => void;\n  onRetry?: () => void;\n}\n\nconst phaseConfig = {\n  validating: {\n    icon: FileCheck,\n    label: 'Validando archivo...',\n    color: 'text-blue-500',\n    bgColor: 'bg-blue-500',\n  },\n  uploading: {\n    icon: Upload,\n    label: 'Subiendo archivo...',\n    color: 'text-primary',\n    bgColor: 'bg-primary',\n  },\n  processing: {\n    icon: Cog,\n    label: 'Procesando archivo...',\n    color: 'text-amber-500',\n    bgColor: 'bg-amber-500',\n  },\n  completed: {\n    icon: CheckCircle2,\n    label: '¡Completado!',\n    color: 'text-green-500',\n    bgColor: 'bg-green-500',\n  },\n  error: {\n    icon: AlertCircle,\n    label: 'Error',\n    color: 'text-destructive',\n    bgColor: 'bg-destructive',\n  },\n};\n\nexport function FileUploadProgress({\n  fileName,\n  phase,\n  uploadProgress,\n  processingProgress,\n  error,\n  onCancel,\n  onRetry,\n}: FileUploadProgressProps) {\n  const config = phaseConfig[phase];\n  const Icon = config.icon;\n  \n  const getProgress = () => {\n    switch (phase) {\n      case 'validating':\n        return 0;\n      case 'uploading':\n        return uploadProgress;\n      case 'processing':\n        return processingProgress;\n      case 'completed':\n        return 100;\n      case 'error':\n        return 0;\n      default:\n        return 0;\n    }\n  };\n\n  const isLoading = phase === 'validating' || phase === 'uploading' || phase === 'processing';\n\n  return (\n    <div\n      className={cn(\n        \"flex flex-col gap-3 p-4 rounded-lg border transition-all duration-300\",\n        phase === 'error' ? \"border-destructive/50 bg-destructive/5\" : \"border-border bg-muted/30\"\n      )}\n      data-testid={`upload-progress-${fileName}`}\n    >\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n          <div\n            className={cn(\n              \"flex items-center justify-center w-10 h-10 rounded-full shrink-0\",\n              phase === 'error' ? \"bg-destructive/10\" : \"bg-primary/10\"\n            )}\n          >\n            {isLoading ? (\n              <Loader2 className={cn(\"h-5 w-5 animate-spin\", config.color)} />\n            ) : (\n              <Icon className={cn(\"h-5 w-5\", config.color)} />\n            )}\n          </div>\n          \n          <div className=\"min-w-0 flex-1\">\n            <p\n              className=\"text-sm font-medium truncate\"\n              title={fileName}\n              data-testid=\"text-upload-filename\"\n            >\n              {fileName}\n            </p>\n            <p\n              className={cn(\"text-xs\", config.color)}\n              data-testid=\"text-upload-phase\"\n            >\n              {phase === 'error' && error ? error : config.label}\n            </p>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 shrink-0\">\n          {phase === 'error' && onRetry && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onRetry}\n              className=\"h-8 px-2\"\n              data-testid=\"button-retry-upload\"\n            >\n              <RefreshCw className=\"h-4 w-4 mr-1\" />\n              Reintentar\n            </Button>\n          )}\n          \n          {isLoading && onCancel && (\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={onCancel}\n              className=\"h-8 w-8\"\n              data-testid=\"button-cancel-upload\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {phase !== 'error' && phase !== 'completed' && (\n        <div className=\"space-y-1\">\n          <Progress\n            value={getProgress()}\n            className=\"h-2\"\n            data-testid=\"progress-upload\"\n          />\n          {(phase === 'uploading' || phase === 'processing') && (\n            <p className=\"text-xs text-muted-foreground text-right\">\n              {getProgress()}%\n            </p>\n          )}\n        </div>\n      )}\n\n      {phase === 'completed' && (\n        <div className=\"flex items-center gap-2 text-xs text-green-600\">\n          <CheckCircle2 className=\"h-3.5 w-3.5\" />\n          Archivo subido correctamente\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4707,"size_tokens":null},"client/src/workers/fileValidationWorker.ts":{"content":"interface ValidationMessage {\n  type: 'validate';\n  file: {\n    name: string;\n    size: number;\n    type: string;\n  };\n  config: {\n    allowedMimeTypes: string[];\n    allowedExtensions: Record<string, string>;\n    maxFileSize: number;\n  };\n}\n\ninterface ValidationResult {\n  type: 'validation_result';\n  valid: boolean;\n  errors: string[];\n  file: {\n    name: string;\n    size: number;\n    type: string;\n    extension: string;\n  };\n}\n\nfunction getExtension(fileName: string): string {\n  const lastDot = fileName.lastIndexOf('.');\n  if (lastDot === -1) return '';\n  return fileName.slice(lastDot).toLowerCase();\n}\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes === 0) return '0 Bytes';\n  const k = 1024;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\nself.onmessage = (e: MessageEvent<ValidationMessage>) => {\n  const { file, config } = e.data;\n  const errors: string[] = [];\n  const extension = getExtension(file.name);\n  \n  if (!config.allowedMimeTypes.includes(file.type)) {\n    const allowedTypes = config.allowedMimeTypes\n      .map((t: string) => t.split('/')[1])\n      .filter((t: string, i: number, arr: string[]) => arr.indexOf(t) === i)\n      .slice(0, 5)\n      .join(', ');\n    errors.push(`Tipo de archivo no permitido. Tipos aceptados: ${allowedTypes}...`);\n  }\n  \n  const allowedExtensions = Object.values(config.allowedExtensions);\n  if (extension && !allowedExtensions.includes(extension)) {\n    errors.push(`Extensión de archivo no válida: ${extension}`);\n  }\n  \n  if (file.size > config.maxFileSize) {\n    const maxSizeMB = config.maxFileSize / (1024 * 1024);\n    errors.push(`El archivo excede el tamaño máximo de ${maxSizeMB}MB. Tamaño actual: ${formatFileSize(file.size)}`);\n  }\n  \n  if (file.size === 0) {\n    errors.push('El archivo está vacío');\n  }\n  \n  const result: ValidationResult = {\n    type: 'validation_result',\n    valid: errors.length === 0,\n    errors,\n    file: {\n      name: file.name,\n      size: file.size,\n      type: file.type,\n      extension,\n    },\n  };\n  \n  self.postMessage(result);\n};\n\nexport {};\n","path":null,"size_bytes":2196,"size_tokens":null},"client/src/lib/fileUploader.ts":{"content":"export interface ValidationResult {\n  type: 'validation_result';\n  valid: boolean;\n  errors: string[];\n  file: {\n    name: string;\n    size: number;\n    type: string;\n    extension: string;\n  };\n}\n\nexport interface UploadProgress {\n  fileId: string;\n  phase: 'validating' | 'uploading' | 'processing' | 'completed' | 'error';\n  uploadProgress: number;\n  processingProgress: number;\n  error?: string;\n}\n\ninterface FileConfig {\n  allowedMimeTypes: string[];\n  allowedExtensions: Record<string, string>;\n  maxFileSize: number;\n  chunkSize: number;\n  maxParallelChunks: number;\n}\n\ninterface MultipartSession {\n  uploadId: string;\n  storagePath: string;\n}\n\nexport class ChunkedFileUploader {\n  private worker: Worker | null = null;\n  private ws: WebSocket | null = null;\n  private config: FileConfig | null = null;\n  private wsReconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n  private wsListeners: Map<string, (status: any) => void> = new Map();\n  private abortController: AbortController | null = null;\n\n  constructor() {\n    this.initWorker();\n  }\n\n  private initWorker(): void {\n    try {\n      this.worker = new Worker(\n        new URL('../workers/fileValidationWorker.ts', import.meta.url),\n        { type: 'module' }\n      );\n    } catch (error) {\n      console.error('Failed to initialize validation worker:', error);\n    }\n  }\n\n  private async fetchConfig(): Promise<FileConfig> {\n    if (this.config) return this.config;\n    \n    const response = await fetch('/api/files/config');\n    if (!response.ok) {\n      throw new Error('Failed to fetch file upload configuration');\n    }\n    \n    this.config = await response.json();\n    return this.config!;\n  }\n\n  async validateFile(file: File): Promise<ValidationResult> {\n    const config = await this.fetchConfig();\n    \n    if (!this.worker) {\n      const errors: string[] = [];\n      const extension = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();\n      \n      if (!config.allowedMimeTypes.includes(file.type)) {\n        errors.push('Tipo de archivo no permitido');\n      }\n      if (file.size > config.maxFileSize) {\n        errors.push(`El archivo excede el tamaño máximo de ${config.maxFileSize / (1024 * 1024)}MB`);\n      }\n      \n      return {\n        type: 'validation_result',\n        valid: errors.length === 0,\n        errors,\n        file: { name: file.name, size: file.size, type: file.type, extension },\n      };\n    }\n\n    return new Promise((resolve) => {\n      const handleMessage = (e: MessageEvent<ValidationResult>) => {\n        this.worker?.removeEventListener('message', handleMessage);\n        resolve(e.data);\n      };\n      \n      this.worker.addEventListener('message', handleMessage);\n      this.worker.postMessage({\n        type: 'validate',\n        file: {\n          name: file.name,\n          size: file.size,\n          type: file.type,\n        },\n        config: {\n          allowedMimeTypes: config.allowedMimeTypes,\n          allowedExtensions: config.allowedExtensions,\n          maxFileSize: config.maxFileSize,\n        },\n      });\n    });\n  }\n\n  async uploadFile(\n    file: File,\n    onProgress: (progress: UploadProgress) => void\n  ): Promise<{ fileId: string; storagePath: string }> {\n    this.abortController = new AbortController();\n    const fileId = `file_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`;\n    \n    try {\n      onProgress({\n        fileId,\n        phase: 'validating',\n        uploadProgress: 0,\n        processingProgress: 0,\n      });\n\n      const validation = await this.validateFile(file);\n      if (!validation.valid) {\n        throw new Error(validation.errors.join('. '));\n      }\n\n      onProgress({\n        fileId,\n        phase: 'uploading',\n        uploadProgress: 0,\n        processingProgress: 0,\n      });\n\n      const config = await this.fetchConfig();\n      const useChunked = file.size > config.chunkSize;\n\n      let storagePath: string;\n      let actualFileId = fileId;\n\n      if (useChunked) {\n        const result = await this.uploadChunked(file, config, (percent) => {\n          onProgress({\n            fileId: actualFileId,\n            phase: 'uploading',\n            uploadProgress: percent,\n            processingProgress: 0,\n          });\n        });\n        storagePath = result.storagePath;\n        if (result.fileId) {\n          actualFileId = result.fileId;\n        }\n      } else {\n        storagePath = await this.uploadSingle(file, (percent) => {\n          onProgress({\n            fileId: actualFileId,\n            phase: 'uploading',\n            uploadProgress: percent,\n            processingProgress: 0,\n          });\n        });\n      }\n\n      onProgress({\n        fileId: actualFileId,\n        phase: 'processing',\n        uploadProgress: 100,\n        processingProgress: 0,\n      });\n\n      return { fileId: actualFileId, storagePath };\n    } catch (error: any) {\n      onProgress({\n        fileId,\n        phase: 'error',\n        uploadProgress: 0,\n        processingProgress: 0,\n        error: error.message || 'Error al subir el archivo',\n      });\n      throw error;\n    }\n  }\n\n  private async uploadSingle(\n    file: File,\n    onProgress: (percent: number) => void\n  ): Promise<string> {\n    const response = await fetch('/api/objects/upload', { method: 'POST' });\n    if (!response.ok) {\n      throw new Error('Failed to get upload URL');\n    }\n    \n    const { uploadURL, storagePath } = await response.json();\n\n    await this.uploadWithProgress(uploadURL, file, onProgress);\n    \n    return storagePath;\n  }\n\n  private async uploadChunked(\n    file: File,\n    config: FileConfig,\n    onProgress: (percent: number) => void\n  ): Promise<string> {\n    const totalChunks = Math.ceil(file.size / config.chunkSize);\n    \n    const createResponse = await fetch('/api/objects/multipart/create', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        fileName: file.name,\n        mimeType: file.type,\n        fileSize: file.size,\n        totalChunks,\n      }),\n    });\n\n    if (!createResponse.ok) {\n      const error = await createResponse.json();\n      throw new Error(error.error || 'Failed to create multipart upload');\n    }\n\n    const session: MultipartSession = await createResponse.json();\n    const uploadedParts: { partNumber: number; etag?: string }[] = [];\n    let completedChunks = 0;\n\n    const uploadChunk = async (partNumber: number): Promise<void> => {\n      const start = (partNumber - 1) * config.chunkSize;\n      const end = Math.min(start + config.chunkSize, file.size);\n      const chunk = file.slice(start, end);\n\n      const signResponse = await fetch('/api/objects/multipart/sign-part', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          uploadId: session.uploadId,\n          partNumber,\n        }),\n      });\n\n      if (!signResponse.ok) {\n        throw new Error(`Failed to sign part ${partNumber}`);\n      }\n\n      const { signedUrl } = await signResponse.json();\n      \n      await this.uploadWithProgress(signedUrl, chunk, () => {});\n      \n      uploadedParts.push({ partNumber });\n      completedChunks++;\n      onProgress(Math.round((completedChunks / totalChunks) * 100));\n    };\n\n    const chunkNumbers = Array.from({ length: totalChunks }, (_, i) => i + 1);\n    \n    for (let i = 0; i < chunkNumbers.length; i += config.maxParallelChunks) {\n      const batch = chunkNumbers.slice(i, i + config.maxParallelChunks);\n      await Promise.all(batch.map(uploadChunk));\n    }\n\n    const completeResponse = await fetch('/api/objects/multipart/complete', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        uploadId: session.uploadId,\n        parts: uploadedParts.sort((a, b) => a.partNumber - b.partNumber),\n      }),\n    });\n\n    if (!completeResponse.ok) {\n      throw new Error('Failed to complete multipart upload');\n    }\n\n    const result = await completeResponse.json();\n    return { storagePath: result.storagePath, fileId: result.fileId };\n  }\n\n  private uploadWithProgress(\n    url: string,\n    data: Blob,\n    onProgress: (percent: number) => void\n  ): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest();\n      \n      xhr.upload.addEventListener('progress', (e) => {\n        if (e.lengthComputable) {\n          const percent = Math.round((e.loaded / e.total) * 100);\n          onProgress(percent);\n        }\n      });\n\n      xhr.addEventListener('load', () => {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          resolve();\n        } else {\n          reject(new Error(`Upload failed with status ${xhr.status}`));\n        }\n      });\n\n      xhr.addEventListener('error', () => {\n        reject(new Error('Network error during upload'));\n      });\n\n      xhr.addEventListener('abort', () => {\n        reject(new Error('Upload cancelled'));\n      });\n\n      xhr.open('PUT', url);\n      xhr.send(data);\n\n      if (this.abortController) {\n        this.abortController.signal.addEventListener('abort', () => {\n          xhr.abort();\n        });\n      }\n    });\n  }\n\n  subscribeToProcessingStatus(\n    fileId: string,\n    onStatus: (status: any) => void\n  ): () => void {\n    this.wsListeners.set(fileId, onStatus);\n    this.ensureWebSocketConnection();\n\n    if (this.ws?.readyState === WebSocket.OPEN) {\n      this.ws.send(JSON.stringify({ type: 'subscribe', fileId }));\n    }\n\n    return () => {\n      this.wsListeners.delete(fileId);\n      if (this.ws?.readyState === WebSocket.OPEN) {\n        this.ws.send(JSON.stringify({ type: 'unsubscribe', fileId }));\n      }\n    };\n  }\n\n  private ensureWebSocketConnection(): void {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) return;\n    \n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n    const wsUrl = `${protocol}//${window.location.host}/ws/file-status`;\n    \n    this.ws = new WebSocket(wsUrl);\n\n    this.ws.onopen = () => {\n      this.wsReconnectAttempts = 0;\n      this.wsListeners.forEach((_, fileId) => {\n        this.ws?.send(JSON.stringify({ type: 'subscribe', fileId }));\n      });\n    };\n\n    this.ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        if (data.type === 'file_status' && data.fileId) {\n          const listener = this.wsListeners.get(data.fileId);\n          if (listener) {\n            listener(data);\n          }\n        }\n      } catch (error) {\n        console.error('Failed to parse WebSocket message:', error);\n      }\n    };\n\n    this.ws.onclose = () => {\n      if (this.wsListeners.size > 0 && this.wsReconnectAttempts < this.maxReconnectAttempts) {\n        this.wsReconnectAttempts++;\n        setTimeout(() => this.ensureWebSocketConnection(), 1000 * this.wsReconnectAttempts);\n      }\n    };\n\n    this.ws.onerror = (error) => {\n      console.error('WebSocket error:', error);\n    };\n  }\n\n  cancel(): void {\n    this.abortController?.abort();\n  }\n\n  destroy(): void {\n    this.worker?.terminate();\n    this.worker = null;\n    this.ws?.close();\n    this.ws = null;\n    this.wsListeners.clear();\n    this.abortController?.abort();\n  }\n}\n\nlet uploaderInstance: ChunkedFileUploader | null = null;\n\nexport function getFileUploader(): ChunkedFileUploader {\n  if (!uploaderInstance) {\n    uploaderInstance = new ChunkedFileUploader();\n  }\n  return uploaderInstance;\n}\n","path":null,"size_bytes":11405,"size_tokens":null},"client/src/components/math-renderer.tsx":{"content":"import React, { memo, useState, useEffect, useRef, useMemo } from \"react\";\nimport DOMPurify from \"dompurify\";\nimport { cn } from \"@/lib/utils\";\nimport { convertToLatex, sanitizeMathInput } from \"@/lib/mathParser\";\nimport { Loader2, AlertCircle } from \"lucide-react\";\n\nconst EVENT_HANDLER_PATTERN = /^on[a-z]/i;\n\nfunction sanitizeMathHtml(html: string): string {\n  return DOMPurify.sanitize(html, {\n    USE_PROFILES: { mathMl: true, svg: true, html: true },\n    ADD_TAGS: ['semantics', 'annotation', 'annotation-xml'],\n    ADD_ATTR: ['encoding', 'aria-hidden', 'aria-label', 'role', 'focusable', 'tabindex',\n               'space', 'size', 'minsize', 'maxsize', 'stretchy', 'variant', 'texclass',\n               'fence', 'separator', 'accent', 'largeop', 'movablelimits', 'symmetric',\n               'lspace', 'rspace', 'form', 'mathvariant', 'mathsize', 'mathcolor',\n               'mathbackground', 'displaystyle', 'scriptlevel', 'scriptsizemultiplier',\n               'infixlinebreakstyle', 'linethickness', 'notation', 'open', 'close',\n               'separators', 'columnalign', 'rowalign', 'columnspacing', 'rowspacing'],\n    CUSTOM_ELEMENT_HANDLING: {\n      tagNameCheck: (tagName: string) => /^mjx-/i.test(tagName) || /^katex-/i.test(tagName),\n      attributeNameCheck: (attrName: string) => !EVENT_HANDLER_PATTERN.test(attrName),\n      allowCustomizedBuiltInElements: true,\n    },\n    FORBID_TAGS: ['script', 'iframe', 'object', 'embed', 'form', 'input', 'button', 'textarea'],\n    FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover', 'onfocus', 'onblur', \n                  'onmousedown', 'onmouseup', 'onkeydown', 'onkeyup', 'onkeypress',\n                  'onsubmit', 'onreset', 'onchange', 'oninput', 'ondblclick', 'oncontextmenu'],\n  });\n}\n\ndeclare global {\n  interface Window {\n    katex?: {\n      render: (latex: string, element: HTMLElement, options?: any) => void;\n      renderToString: (latex: string, options?: any) => string;\n    };\n    MathJax?: {\n      typesetPromise?: (elements?: HTMLElement[]) => Promise<void>;\n      tex2chtml?: (latex: string, options?: any) => HTMLElement;\n      startup?: {\n        promise: Promise<void>;\n        defaultReady: () => void;\n      };\n    };\n  }\n}\n\nexport interface MathRendererProps {\n  content: string;\n  block?: boolean;\n  className?: string;\n  fallbackToMathJax?: boolean;\n  showError?: boolean;\n}\n\ntype RenderStatus = \"idle\" | \"loading\" | \"success\" | \"loading-mathjax\" | \"mathjax-ready\" | \"fallback\" | \"error\";\n\ninterface RenderState {\n  status: RenderStatus;\n  html: string;\n  error?: string;\n  latex?: string;\n  displayMode?: boolean;\n  version?: number;\n}\n\nconst MATHJAX_CDN = \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js\";\n\nlet mathJaxLoading: Promise<void> | null = null;\n\nasync function loadMathJax(): Promise<void> {\n  if (window.MathJax?.typesetPromise) {\n    return Promise.resolve();\n  }\n\n  if (mathJaxLoading) {\n    return mathJaxLoading;\n  }\n\n  mathJaxLoading = new Promise((resolve, reject) => {\n    (window as any).MathJax = {\n      tex: {\n        inlineMath: [[\"$\", \"$\"]],\n        displayMath: [[\"$$\", \"$$\"]],\n      },\n      startup: {\n        ready: () => {\n          (window as any).MathJax.startup.defaultReady();\n          resolve();\n        },\n      },\n    };\n\n    const script = document.createElement(\"script\");\n    script.src = MATHJAX_CDN;\n    script.async = true;\n    script.onerror = () => reject(new Error(\"Failed to load MathJax\"));\n    document.head.appendChild(script);\n  });\n\n  return mathJaxLoading;\n}\n\nfunction renderWithKatex(latex: string, displayMode: boolean): { html: string; success: boolean; error?: string } {\n  try {\n    if (!window.katex) {\n      return { html: \"\", success: false, error: \"KaTeX not loaded\" };\n    }\n    \n    const sanitized = sanitizeMathInput(latex);\n    const html = window.katex.renderToString(sanitized, {\n      displayMode,\n      throwOnError: true,\n      trust: false,\n      strict: \"warn\",\n      maxSize: 500,\n      maxExpand: 100,\n    });\n    \n    return { html, success: true };\n  } catch (error: any) {\n    return { \n      html: \"\", \n      success: false, \n      error: error.message || \"KaTeX render error\" \n    };\n  }\n}\n\nexport const MathRenderer = memo(function MathRenderer({\n  content,\n  block = false,\n  className,\n  fallbackToMathJax = true,\n  showError = true,\n}: MathRendererProps) {\n  const [state, setState] = useState<RenderState>({ status: \"idle\", html: \"\", version: 0 });\n  const containerRef = useRef<HTMLSpanElement>(null);\n  const versionRef = useRef(0);\n\n  useEffect(() => {\n    versionRef.current += 1;\n    const currentVersion = versionRef.current;\n    \n    if (!content) {\n      setState({ status: \"success\", html: \"\", version: currentVersion });\n      return;\n    }\n\n    setState({ status: \"loading\", html: \"\", version: currentVersion });\n\n    const { latex, isBlock } = convertToLatex(content);\n    const displayMode = block || isBlock;\n    const katexResult = renderWithKatex(latex, displayMode);\n    \n    if (katexResult.success) {\n      if (versionRef.current === currentVersion) {\n        setState({ status: \"success\", html: katexResult.html, version: currentVersion });\n      }\n      return;\n    }\n    if (!fallbackToMathJax) {\n      if (versionRef.current === currentVersion) {\n        setState({ \n          status: \"error\", \n          html: \"\", \n          error: katexResult.error,\n          version: currentVersion \n        });\n      }\n      return;\n    }\n    if (versionRef.current === currentVersion) {\n      setState({ \n        status: \"loading-mathjax\", \n        html: \"\", \n        latex, \n        displayMode,\n        version: currentVersion \n      });\n    }\n  }, [content, block, fallbackToMathJax]);\n\n  useEffect(() => {\n    if (state.status !== \"mathjax-ready\" || !containerRef.current || !state.latex) {\n      return;\n    }\n\n    const currentVersion = state.version;\n\n    const runMathJax = async () => {\n      try {\n        await loadMathJax();\n        if (versionRef.current !== currentVersion || !containerRef.current) return;\n        \n        const mathContent = state.displayMode \n          ? `$$${state.latex}$$` \n          : `$${state.latex}$`;\n        containerRef.current.innerHTML = mathContent;\n        \n        if (window.MathJax?.typesetPromise) {\n          await window.MathJax.typesetPromise([containerRef.current]);\n          if (versionRef.current === currentVersion && containerRef.current) {\n            setState(prev => {\n              if (prev.version !== currentVersion) return prev;\n              return { \n                ...prev, \n                status: \"fallback\", \n                html: containerRef.current?.innerHTML || \"\" \n              };\n            });\n          }\n        }\n      } catch (error: any) {\n        if (versionRef.current === currentVersion) {\n          setState(prev => {\n            if (prev.version !== currentVersion) return prev;\n            return { \n              status: \"error\", \n              html: \"\", \n              error: error.message || \"MathJax render failed\",\n              version: currentVersion \n            };\n          });\n        }\n      }\n    };\n\n    runMathJax();\n  }, [state.status, state.latex, state.displayMode, state.version]);\n\n  useEffect(() => {\n    if (state.status === \"loading-mathjax\") {\n      const timer = requestAnimationFrame(() => {\n        if (versionRef.current === state.version && containerRef.current) {\n          setState(prev => {\n            if (prev.version !== state.version) return prev;\n            return { ...prev, status: \"mathjax-ready\" };\n          });\n        }\n      });\n      return () => cancelAnimationFrame(timer);\n    }\n  }, [state.status, state.version]);\n\n  if (state.status === \"loading\") {\n    return (\n      <span className={cn(\"inline-flex items-center gap-1 text-muted-foreground\", className)}>\n        <Loader2 className=\"h-3 w-3 animate-spin\" />\n        <span className=\"text-xs\">Rendering...</span>\n      </span>\n    );\n  }\n\n  if (state.status === \"error\" && showError) {\n    return (\n      <span className={cn(\"inline-flex items-center gap-1 text-destructive text-sm\", className)}>\n        <AlertCircle className=\"h-3 w-3\" />\n        <code className=\"bg-destructive/10 px-1 rounded text-xs\">{content}</code>\n      </span>\n    );\n  }\n\n  if (state.status === \"loading-mathjax\" || state.status === \"mathjax-ready\") {\n    return (\n      <span\n        ref={containerRef}\n        className={cn(\n          \"inline-flex items-center gap-1\",\n          block ? \"block my-4\" : \"inline\",\n          className\n        )}\n        data-testid=\"math-loading-mathjax\"\n      >\n        <Loader2 className=\"h-3 w-3 animate-spin text-muted-foreground\" />\n        <span className=\"text-xs text-muted-foreground\">Loading MathJax...</span>\n      </span>\n    );\n  }\n\n  const sanitizedHtml = useMemo(() => sanitizeMathHtml(state.html), [state.html]);\n\n  if (state.status === \"fallback\") {\n    return (\n      <span\n        ref={containerRef}\n        className={cn(\n          block ? \"block my-4 overflow-x-auto\" : \"inline\",\n          className\n        )}\n        dangerouslySetInnerHTML={{ __html: sanitizedHtml }}\n        data-testid=\"math-mathjax\"\n      />\n    );\n  }\n\n  return (\n    <span\n      ref={containerRef}\n      className={cn(\n        block ? \"katex-display block my-4 overflow-x-auto\" : \"inline\",\n        className\n      )}\n      dangerouslySetInnerHTML={{ __html: sanitizedHtml }}\n      data-testid=\"math-katex\"\n    />\n  );\n});\n\nexport interface MathBlockProps {\n  children: string;\n  className?: string;\n}\n\nexport const InlineMath = memo(function InlineMath({ children, className }: MathBlockProps) {\n  return <MathRenderer content={children} block={false} className={className} />;\n});\n\nexport const BlockMath = memo(function BlockMath({ children, className }: MathBlockProps) {\n  return <MathRenderer content={children} block={true} className={className} />;\n});\n\nexport default MathRenderer;\n","path":null,"size_bytes":9901,"size_tokens":null},"client/src/components/markdown-renderer.tsx":{"content":"import React, { memo, useMemo, useState, useCallback } from \"react\";\nimport ReactMarkdown from \"react-markdown\";\nimport remarkGfm from \"remark-gfm\";\nimport remarkMath from \"remark-math\";\nimport rehypeKatex from \"rehype-katex\";\nimport rehypeHighlight from \"rehype-highlight\";\nimport rehypeSanitize, { defaultSchema } from \"rehype-sanitize\";\nimport { cn } from \"@/lib/utils\";\nimport { Check, Copy, Loader2 } from \"lucide-react\";\nimport { preprocessMathInMarkdown } from \"@/lib/mathParser\";\nimport { CodeBlockShell } from \"./code-block-shell\";\nimport { isLanguageRunnable } from \"@/lib/sandboxApi\";\nimport { useSandboxExecution } from \"@/hooks/useSandboxExecution\";\n\nconst sanitizeSchema = {\n  ...defaultSchema,\n  tagNames: [\n    ...(defaultSchema.tagNames || []),\n    \"math\",\n    \"mrow\",\n    \"mi\",\n    \"mo\",\n    \"mn\",\n    \"msup\",\n    \"msub\",\n    \"mfrac\",\n    \"mroot\",\n    \"msqrt\",\n    \"mtext\",\n    \"mspace\",\n    \"mtable\",\n    \"mtr\",\n    \"mtd\",\n    \"annotation\",\n    \"semantics\",\n    \"svg\",\n    \"path\",\n    \"circle\",\n    \"rect\",\n    \"line\",\n    \"polygon\",\n    \"polyline\",\n    \"g\",\n    \"defs\",\n    \"use\",\n    \"symbol\",\n  ],\n  attributes: {\n    ...defaultSchema.attributes,\n    \"*\": [...(defaultSchema.attributes?.[\"*\"] || []), \"className\", \"class\", \"style\"],\n    math: [\"xmlns\", \"display\"],\n    svg: [\"xmlns\", \"viewBox\", \"width\", \"height\", \"fill\", \"stroke\"],\n    path: [\"d\", \"fill\", \"stroke\", \"strokeWidth\", \"strokeLinecap\", \"strokeLinejoin\"],\n    code: [\"className\", \"class\"],\n    span: [\"className\", \"class\", \"style\", \"aria-hidden\"],\n    div: [\"className\", \"class\", \"style\"],\n    img: [\"src\", \"alt\", \"title\", \"loading\", \"width\", \"height\"],\n    a: [\"href\", \"title\", \"target\", \"rel\"],\n    table: [\"className\", \"class\"],\n    th: [\"className\", \"class\", \"scope\", \"colSpan\", \"rowSpan\"],\n    td: [\"className\", \"class\", \"colSpan\", \"rowSpan\"],\n  },\n  protocols: {\n    ...defaultSchema.protocols,\n    src: [\"http\", \"https\", \"data\"],\n    href: [\"http\", \"https\", \"mailto\", \"#\"],\n  },\n};\n\n\ninterface LazyImageProps {\n  src?: string;\n  alt?: string;\n  title?: string;\n  className?: string;\n  maxHeight?: string;\n}\n\nconst LazyImage = memo(function LazyImage({ \n  src, \n  alt, \n  title, \n  className,\n  maxHeight = \"400px\" \n}: LazyImageProps) {\n  const [loaded, setLoaded] = useState(false);\n  const [error, setError] = useState(false);\n\n  const handleLoad = useCallback(() => setLoaded(true), []);\n  const handleError = useCallback(() => setError(true), []);\n\n  if (!src) return null;\n  if (error) {\n    return (\n      <div className=\"flex items-center justify-center bg-muted rounded-lg p-4 my-3 text-muted-foreground text-sm\">\n        Error loading image\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"relative my-3\">\n      {!loaded && (\n        <div className=\"absolute inset-0 flex items-center justify-center bg-muted rounded-lg\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        </div>\n      )}\n      <img\n        src={src}\n        alt={alt || \"Image\"}\n        title={title}\n        loading=\"lazy\"\n        onLoad={handleLoad}\n        onError={handleError}\n        className={cn(\n          \"max-w-full h-auto rounded-lg transition-opacity duration-300\",\n          loaded ? \"opacity-100\" : \"opacity-0\",\n          className\n        )}\n        style={{ maxHeight }}\n        data-testid=\"img-markdown\"\n      />\n    </div>\n  );\n});\n\ninterface CodeBlockProps {\n  inline?: boolean;\n  className?: string;\n  children?: React.ReactNode;\n}\n\nconst CodeBlock = memo(function CodeBlock({ inline, className, children }: CodeBlockProps) {\n  const [copied, setCopied] = useState(false);\n  const match = /language-(\\w+)/.exec(className || \"\");\n  const language = match?.[1] || \"\";\n  const codeContent = String(children).replace(/\\n$/, \"\");\n\n  const handleCopy = useCallback(async () => {\n    try {\n      await navigator.clipboard.writeText(codeContent);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      console.error(\"Failed to copy:\", err);\n    }\n  }, [codeContent]);\n\n  if (inline) {\n    return (\n      <code className=\"px-1.5 py-0.5 rounded bg-muted text-sm font-mono\">\n        {children}\n      </code>\n    );\n  }\n\n  return (\n    <div className=\"relative group my-4\">\n      {language && (\n        <div className=\"absolute top-0 left-0 px-3 py-1 text-xs font-mono text-muted-foreground bg-muted/50 rounded-tl-lg rounded-br-lg\">\n          {language}\n        </div>\n      )}\n      <button\n        onClick={handleCopy}\n        className=\"absolute top-2 right-2 p-1.5 rounded-md bg-muted/80 hover:bg-muted opacity-0 group-hover:opacity-100 transition-opacity\"\n        aria-label={copied ? \"Copied\" : \"Copy code\"}\n        data-testid=\"button-copy-code\"\n      >\n        {copied ? (\n          <Check className=\"h-4 w-4 text-green-500\" />\n        ) : (\n          <Copy className=\"h-4 w-4 text-muted-foreground\" />\n        )}\n      </button>\n      <pre className={cn(\"rounded-lg overflow-x-auto p-4 pt-8 bg-muted/30\", className)}>\n        <code className={cn(\"text-sm font-mono\", className)}>{children}</code>\n      </pre>\n    </div>\n  );\n});\n\ninterface TableComponents {\n  table: React.ComponentType<{ children?: React.ReactNode }>;\n  thead: React.ComponentType<{ children?: React.ReactNode }>;\n  tbody: React.ComponentType<{ children?: React.ReactNode }>;\n  tr: React.ComponentType<{ children?: React.ReactNode }>;\n  th: React.ComponentType<{ children?: React.ReactNode }>;\n  td: React.ComponentType<{ children?: React.ReactNode }>;\n}\n\nconst tableComponents: TableComponents = {\n  table: ({ children }) => (\n    <div className=\"overflow-x-auto my-4\">\n      <table className=\"min-w-full border-collapse border border-border rounded-lg\" data-testid=\"table-markdown\">\n        {children}\n      </table>\n    </div>\n  ),\n  thead: ({ children }) => <thead className=\"bg-muted/50\">{children}</thead>,\n  tbody: ({ children }) => <tbody className=\"divide-y divide-border\">{children}</tbody>,\n  tr: ({ children }) => <tr className=\"hover:bg-muted/30 transition-colors\">{children}</tr>,\n  th: ({ children }) => (\n    <th className=\"px-4 py-2 text-left text-sm font-semibold border border-border\">{children}</th>\n  ),\n  td: ({ children }) => (\n    <td className=\"px-4 py-2 text-sm border border-border\">{children}</td>\n  ),\n};\n\ninterface InteractiveCodeBlockProps {\n  inline?: boolean;\n  className?: string;\n  children?: React.ReactNode;\n  runnable?: boolean;\n  editable?: boolean;\n  onEdit?: (code: string) => void;\n}\n\nconst InteractiveCodeBlock = memo(function InteractiveCodeBlock({\n  inline,\n  className,\n  children,\n  runnable = true,\n  editable = false,\n  onEdit,\n}: InteractiveCodeBlockProps) {\n  const match = /language-(\\w+)/.exec(className || \"\");\n  const language = match?.[1] || \"text\";\n  const codeContent = String(children).replace(/\\n$/, \"\");\n\n  const { execute, isRunning, result, errorLines, reset } = useSandboxExecution();\n\n  const isRunnable = runnable && isLanguageRunnable(language);\n\n  const handleRun = useCallback(async () => {\n    await execute(codeContent, language);\n  }, [execute, codeContent, language]);\n\n  const handleEdit = useCallback(() => {\n    onEdit?.(codeContent);\n  }, [onEdit, codeContent]);\n\n  if (inline) {\n    return (\n      <code className=\"px-1.5 py-0.5 rounded bg-muted text-sm font-mono\">\n        {children}\n      </code>\n    );\n  }\n\n  return (\n    <div className=\"my-4 space-y-2\">\n      <CodeBlockShell\n        code={codeContent}\n        language={language}\n        showLineNumbers={true}\n        maxHeight=\"400px\"\n        errorLines={errorLines}\n        runnable={isRunnable}\n        editable={editable}\n        onRun={isRunnable ? handleRun : undefined}\n        onEdit={editable ? handleEdit : undefined}\n      />\n      {isRunning && (\n        <div className=\"flex items-center gap-2 text-sm text-muted-foreground px-3 py-2 bg-muted/30 rounded-md\">\n          <Loader2 className=\"h-4 w-4 animate-spin\" />\n          <span>Running...</span>\n        </div>\n      )}\n      {result && !isRunning && (\n        <div className=\"rounded-md border border-zinc-800 bg-zinc-950 overflow-hidden\">\n          <div className=\"px-3 py-1.5 bg-zinc-900 border-b border-zinc-800 flex items-center justify-between\">\n            <span className=\"text-xs text-zinc-400 font-mono\">\n              Output {result.usedFallback && \"(local fallback)\"}\n            </span>\n            <button\n              onClick={reset}\n              className=\"text-xs text-zinc-500 hover:text-zinc-300 transition-colors\"\n              data-testid=\"button-clear-output\"\n            >\n              Clear\n            </button>\n          </div>\n          <div className=\"p-3 font-mono text-sm overflow-x-auto\">\n            {result.run.stdout && (\n              <pre className=\"text-green-400 whitespace-pre-wrap\">{result.run.stdout}</pre>\n            )}\n            {result.run.stderr && (\n              <pre className=\"text-red-400 whitespace-pre-wrap\">{result.run.stderr}</pre>\n            )}\n            {!result.run.stdout && !result.run.stderr && (\n              <span className=\"text-zinc-500 italic\">No output</span>\n            )}\n          </div>\n          {result.run.code !== 0 && (\n            <div className=\"px-3 py-1.5 bg-red-500/10 border-t border-zinc-800 text-xs text-red-400\">\n              Exit code: {result.run.code}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n});\n\nexport interface MarkdownRendererProps {\n  content: string;\n  className?: string;\n  imageMaxHeight?: string;\n  enableMath?: boolean;\n  enableCodeHighlight?: boolean;\n  enableGfm?: boolean;\n  sanitize?: boolean;\n  enableInteractiveCode?: boolean;\n  interactiveCodeEditable?: boolean;\n  onCodeEdit?: (code: string) => void;\n  customComponents?: Record<string, React.ComponentType<any>>;\n}\n\nexport const MarkdownRenderer = memo(function MarkdownRenderer({\n  content,\n  className,\n  imageMaxHeight = \"400px\",\n  enableMath = true,\n  enableCodeHighlight = true,\n  enableGfm = true,\n  sanitize = true,\n  enableInteractiveCode = false,\n  interactiveCodeEditable = false,\n  onCodeEdit,\n  customComponents = {},\n}: MarkdownRendererProps) {\n  const processedContent = useMemo(() => {\n    if (!content) return \"\";\n    return enableMath ? preprocessMathInMarkdown(content) : content;\n  }, [content, enableMath]);\n\n  const remarkPlugins = useMemo(() => {\n    const plugins: any[] = [];\n    if (enableGfm) plugins.push(remarkGfm);\n    if (enableMath) plugins.push(remarkMath);\n    return plugins;\n  }, [enableGfm, enableMath]);\n\n  const rehypePlugins = useMemo(() => {\n    const plugins: any[] = [];\n    if (enableMath) plugins.push(rehypeKatex);\n    if (enableCodeHighlight) plugins.push(rehypeHighlight);\n    if (sanitize) plugins.push([rehypeSanitize, sanitizeSchema]);\n    return plugins;\n  }, [enableMath, enableCodeHighlight, sanitize]);\n\n  const CodeComponent = useMemo(() => {\n    if (enableInteractiveCode) {\n      return (props: any) => (\n        <InteractiveCodeBlock\n          {...props}\n          editable={interactiveCodeEditable}\n          onEdit={onCodeEdit}\n        />\n      );\n    }\n    return CodeBlock;\n  }, [enableInteractiveCode, interactiveCodeEditable, onCodeEdit]);\n\n  const components = useMemo(() => ({\n    code: CodeComponent,\n    img: (props: any) => <LazyImage {...props} maxHeight={imageMaxHeight} />,\n    p: ({ children }: { children?: React.ReactNode }) => <p className=\"mb-3 leading-relaxed\">{children}</p>,\n    a: ({ href, children }: { href?: string; children?: React.ReactNode }) => (\n      <a\n        href={href}\n        target=\"_blank\"\n        rel=\"noopener noreferrer\"\n        className=\"text-primary hover:underline\"\n        data-testid=\"link-markdown\"\n      >\n        {children}\n      </a>\n    ),\n    ul: ({ children }: { children?: React.ReactNode }) => (\n      <ul className=\"list-disc list-inside mb-3 space-y-1\">{children}</ul>\n    ),\n    ol: ({ children }: { children?: React.ReactNode }) => (\n      <ol className=\"list-decimal list-inside mb-3 space-y-1\">{children}</ol>\n    ),\n    li: ({ children }: { children?: React.ReactNode }) => <li className=\"ml-2\">{children}</li>,\n    h1: ({ children }: { children?: React.ReactNode }) => (\n      <h1 className=\"text-xl font-bold mb-3 mt-4\">{children}</h1>\n    ),\n    h2: ({ children }: { children?: React.ReactNode }) => (\n      <h2 className=\"text-lg font-bold mb-2 mt-3\">{children}</h2>\n    ),\n    h3: ({ children }: { children?: React.ReactNode }) => (\n      <h3 className=\"text-base font-semibold mb-2 mt-2\">{children}</h3>\n    ),\n    h4: ({ children }: { children?: React.ReactNode }) => (\n      <h4 className=\"text-sm font-semibold mb-2 mt-2\">{children}</h4>\n    ),\n    blockquote: ({ children }: { children?: React.ReactNode }) => (\n      <blockquote className=\"border-l-4 border-muted-foreground/30 pl-4 italic my-3 text-muted-foreground\">\n        {children}\n      </blockquote>\n    ),\n    hr: () => <hr className=\"my-4 border-border\" />,\n    ...tableComponents,\n    ...customComponents,\n  }), [imageMaxHeight, customComponents, CodeComponent]);\n\n  if (!processedContent) {\n    return null;\n  }\n\n  return (\n    <div className={cn(\"prose prose-sm dark:prose-invert max-w-none\", className)} data-testid=\"markdown-renderer\">\n      <ReactMarkdown\n        remarkPlugins={remarkPlugins}\n        rehypePlugins={rehypePlugins}\n        components={components}\n      >\n        {processedContent}\n      </ReactMarkdown>\n    </div>\n  );\n});\n\nexport default MarkdownRenderer;\n","path":null,"size_bytes":13414,"size_tokens":null},"client/src/lib/mathParser.ts":{"content":"import AsciiMathParser from \"asciimath2tex\";\n\nconst asciiMathParser = new AsciiMathParser();\n\nexport type MathInputType = \"latex-inline\" | \"latex-block\" | \"asciimath\" | \"plain\";\n\nexport interface MathDetectionResult {\n  type: MathInputType;\n  content: string;\n  original: string;\n}\n\nexport interface ParsedMathContent {\n  segments: Array<{\n    type: \"text\" | \"math\";\n    content: string;\n    mathType?: \"inline\" | \"block\";\n    original?: string;\n  }>;\n}\n\nconst UNSAFE_PATTERNS = [\n  /\\\\input\\{/gi,\n  /\\\\include\\{/gi,\n  /\\\\write\\d*\\{/gi,\n  /\\\\read\\d*/gi,\n  /\\\\openin/gi,\n  /\\\\openout/gi,\n  /\\\\immediate/gi,\n  /\\\\catcode/gi,\n  /\\\\def\\\\/gi,\n  /\\\\newcommand/gi,\n  /\\\\renewcommand/gi,\n  /\\\\let\\\\/gi,\n  /\\\\csname/gi,\n  /\\\\endcsname/gi,\n  /\\\\expandafter/gi,\n  /\\\\makeatletter/gi,\n  /\\\\makeatother/gi,\n];\n\nexport function sanitizeMathInput(input: string): string {\n  if (!input) return input;\n  let sanitized = input;\n  for (const pattern of UNSAFE_PATTERNS) {\n    sanitized = sanitized.replace(pattern, \"\");\n  }\n  sanitized = sanitized.replace(/<[^>]*>/g, \"\");\n  sanitized = sanitized.replace(/javascript:/gi, \"\");\n  sanitized = sanitized.replace(/data:/gi, \"\");\n  return sanitized.trim();\n}\n\nexport function detectMathType(input: string): MathDetectionResult {\n  if (!input) {\n    return { type: \"plain\", content: input, original: input };\n  }\n\n  const trimmed = input.trim();\n  if (trimmed.startsWith(\"$$\") && trimmed.endsWith(\"$$\") && trimmed.length > 4) {\n    const content = sanitizeMathInput(trimmed.slice(2, -2).trim());\n    return { type: \"latex-block\", content, original: input };\n  }\n  if (trimmed.startsWith(\"\\\\[\") && trimmed.endsWith(\"\\\\]\")) {\n    const content = sanitizeMathInput(trimmed.slice(2, -2).trim());\n    return { type: \"latex-block\", content, original: input };\n  }\n  if (trimmed.startsWith(\"$\") && trimmed.endsWith(\"$\") && trimmed.length > 2 && !trimmed.startsWith(\"$$\")) {\n    const content = sanitizeMathInput(trimmed.slice(1, -1).trim());\n    return { type: \"latex-inline\", content, original: input };\n  }\n  if (trimmed.startsWith(\"\\\\(\") && trimmed.endsWith(\"\\\\)\")) {\n    const content = sanitizeMathInput(trimmed.slice(2, -2).trim());\n    return { type: \"latex-inline\", content, original: input };\n  }\n  if (trimmed.startsWith(\"`\") && trimmed.endsWith(\"`\") && trimmed.length > 2 && !trimmed.startsWith(\"``\")) {\n    const content = trimmed.slice(1, -1).trim();\n    return { type: \"asciimath\", content, original: input };\n  }\n  if (trimmed.startsWith(\"am`\") && trimmed.endsWith(\"`\")) {\n    const content = trimmed.slice(3, -1).trim();\n    return { type: \"asciimath\", content, original: input };\n  }\n\n  return { type: \"plain\", content: input, original: input };\n}\n\nexport function asciiMathToLatex(asciiMath: string): string {\n  if (!asciiMath) return \"\";\n  try {\n    const latex = asciiMathParser.parse(asciiMath);\n    return sanitizeMathInput(latex);\n  } catch (error) {\n    console.warn(\"[asciiMathToLatex] Parse error:\", error);\n    return asciiMath;\n  }\n}\n\nexport function convertToLatex(input: string): { latex: string; isBlock: boolean } {\n  const detected = detectMathType(input);\n  \n  switch (detected.type) {\n    case \"latex-block\":\n      return { latex: detected.content, isBlock: true };\n    case \"latex-inline\":\n      return { latex: detected.content, isBlock: false };\n    case \"asciimath\":\n      return { latex: asciiMathToLatex(detected.content), isBlock: false };\n    case \"plain\":\n    default:\n      return { latex: input, isBlock: false };\n  }\n}\n\nexport function parseMathContent(text: string): ParsedMathContent {\n  if (!text) {\n    return { segments: [] };\n  }\n\n  const segments: ParsedMathContent[\"segments\"] = [];\n  const mathPatterns = [\n    { regex: /\\$\\$([^$]+)\\$\\$/g, type: \"block\" as const },\n    { regex: /\\\\\\[([^\\]]+)\\\\\\]/g, type: \"block\" as const },\n    { regex: /\\$([^$\\n]+)\\$/g, type: \"inline\" as const },\n    { regex: /\\\\\\(([^)]+)\\\\\\)/g, type: \"inline\" as const },\n    { regex: /am`([^`]+)`/g, type: \"inline\" as const, isAsciiMath: true },\n  ];\n  \n  interface Match {\n    start: number;\n    end: number;\n    content: string;\n    mathType: \"inline\" | \"block\";\n    original: string;\n    isAsciiMath?: boolean;\n  }\n  \n  const allMatches: Match[] = [];\n  \n  for (const pattern of mathPatterns) {\n    let match;\n    const regex = new RegExp(pattern.regex.source, pattern.regex.flags);\n    while ((match = regex.exec(text)) !== null) {\n      allMatches.push({\n        start: match.index,\n        end: match.index + match[0].length,\n        content: match[1],\n        mathType: pattern.type,\n        original: match[0],\n        isAsciiMath: (pattern as any).isAsciiMath,\n      });\n    }\n  }\n  allMatches.sort((a, b) => a.start - b.start);\n  const filteredMatches: Match[] = [];\n  let lastEnd = 0;\n  for (const match of allMatches) {\n    if (match.start >= lastEnd) {\n      filteredMatches.push(match);\n      lastEnd = match.end;\n    }\n  }\n  let currentPos = 0;\n  for (const match of filteredMatches) {\n    if (match.start > currentPos) {\n      segments.push({\n        type: \"text\",\n        content: text.slice(currentPos, match.start),\n      });\n    }\n    const latex = match.isAsciiMath \n      ? asciiMathToLatex(match.content)\n      : sanitizeMathInput(match.content);\n    \n    segments.push({\n      type: \"math\",\n      content: latex,\n      mathType: match.mathType,\n      original: match.original,\n    });\n    \n    currentPos = match.end;\n  }\n  if (currentPos < text.length) {\n    segments.push({\n      type: \"text\",\n      content: text.slice(currentPos),\n    });\n  }\n\n  return { segments };\n}\n\nexport function preprocessMathInMarkdown(markdown: string): string {\n  if (!markdown) return markdown;\n  let processed = markdown\n    .replace(/\\\\\\[/g, \"$$\")\n    .replace(/\\\\\\]/g, \"$$\")\n    .replace(/\\\\\\(/g, \"$\")\n    .replace(/\\\\\\)/g, \"$\");\n  processed = processed.replace(/am`([^`]+)`/g, (_, asciiMath) => {\n    const latex = asciiMathToLatex(asciiMath);\n    return `$${latex}$`;\n  });\n\n  return processed;\n}\n","path":null,"size_bytes":5955,"size_tokens":null},"client/src/components/document-renderer.tsx":{"content":"import React, { memo, useMemo, useState, useEffect, useRef, lazy, Suspense, useCallback } from \"react\";\nimport DOMPurify from \"dompurify\";\nimport { cn } from \"@/lib/utils\";\nimport { parseDocument, detectFormat, type DocumentFormat } from \"@/lib/rstParser\";\nimport { Loader2 } from \"lucide-react\";\n\nconst MarkdownRenderer = lazy(() => import(\"./markdown-renderer\"));\n\nconst CHUNK_SIZE = 50;\nconst CHUNK_HEIGHT_ESTIMATE = 100;\n\nexport interface DocumentRendererProps {\n  content: string;\n  format?: DocumentFormat;\n  filename?: string;\n  className?: string;\n  lazyThreshold?: number;\n  enableVirtualization?: boolean;\n}\n\ninterface ContentChunk {\n  id: number;\n  content: string;\n  startLine: number;\n  endLine: number;\n}\n\nfunction splitIntoChunks(content: string, chunkSize: number): ContentChunk[] {\n  const lines = content.split('\\n');\n  const chunks: ContentChunk[] = [];\n  \n  for (let i = 0; i < lines.length; i += chunkSize) {\n    const chunkLines = lines.slice(i, i + chunkSize);\n    chunks.push({\n      id: Math.floor(i / chunkSize),\n      content: chunkLines.join('\\n'),\n      startLine: i,\n      endLine: Math.min(i + chunkSize, lines.length),\n    });\n  }\n  \n  return chunks;\n}\n\nconst RstContent = memo(function RstContent({ html, className }: { html: string; className?: string }) {\n  const sanitizedHtml = useMemo(() => DOMPurify.sanitize(html, {\n    ALLOWED_TAGS: ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', \n                   'pre', 'code', 'strong', 'em', 'a', 'br', 'span', 'div', 'table', 'thead',\n                   'tbody', 'tr', 'th', 'td', 'img', 'hr', 'dl', 'dt', 'dd', 'sub', 'sup'],\n    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'target', 'rel'],\n    ALLOW_DATA_ATTR: false,\n  }), [html]);\n  \n  return (\n    <div \n      className={cn(\"rst-content\", className)}\n      dangerouslySetInnerHTML={{ __html: sanitizedHtml }}\n      data-testid=\"rst-content\"\n    />\n  );\n});\n\ninterface LazyChunkProps {\n  chunk: ContentChunk;\n  format: \"markdown\" | \"rst\";\n  isVisible: boolean;\n  estimatedHeight: number;\n  className?: string;\n}\n\nconst LazyChunk = memo(function LazyChunk({ \n  chunk, \n  format, \n  isVisible, \n  estimatedHeight,\n  className \n}: LazyChunkProps) {\n  if (!isVisible) {\n    return (\n      <div \n        style={{ height: estimatedHeight, minHeight: 50 }}\n        className=\"flex items-center justify-center text-muted-foreground\"\n        data-testid={`chunk-placeholder-${chunk.id}`}\n      >\n        <Loader2 className=\"h-4 w-4 animate-spin\" />\n      </div>\n    );\n  }\n\n  if (format === \"rst\") {\n    const parsed = parseDocument(chunk.content, \"rst\");\n    return <RstContent html={parsed.html} className={className} />;\n  }\n\n  return (\n    <Suspense fallback={\n      <div className=\"flex items-center gap-2 p-4 text-muted-foreground\">\n        <Loader2 className=\"h-4 w-4 animate-spin\" />\n        <span className=\"text-sm\">Loading content...</span>\n      </div>\n    }>\n      <MarkdownRenderer content={chunk.content} className={className} />\n    </Suspense>\n  );\n});\n\nexport const DocumentRenderer = memo(function DocumentRenderer({\n  content,\n  format = \"auto\",\n  filename,\n  className,\n  lazyThreshold = 500,\n  enableVirtualization = true,\n}: DocumentRendererProps) {\n  const [visibleChunks, setVisibleChunks] = useState<Set<number>>(new Set([0, 1, 2]));\n  const containerRef = useRef<HTMLDivElement>(null);\n  const chunkRefs = useRef<Map<number, HTMLDivElement>>(new Map());\n  const observerRef = useRef<IntersectionObserver | null>(null);\n\n  const detectedFormat = useMemo(() => {\n    return format === \"auto\" ? detectFormat(content, filename) : format;\n  }, [content, format, filename]);\n\n  const lineCount = useMemo(() => content.split('\\n').length, [content]);\n  const shouldVirtualize = enableVirtualization && lineCount > lazyThreshold;\n  const chunks = useMemo(() => {\n    if (!shouldVirtualize) return null;\n    return splitIntoChunks(content, CHUNK_SIZE);\n  }, [content, shouldVirtualize]);\n\n  const registerChunkRef = useCallback((id: number, el: HTMLDivElement | null) => {\n    if (el) {\n      chunkRefs.current.set(id, el);\n      observerRef.current?.observe(el);\n    } else {\n      const existing = chunkRefs.current.get(id);\n      if (existing) {\n        observerRef.current?.unobserve(existing);\n        chunkRefs.current.delete(id);\n      }\n    }\n  }, []);\n\n  useEffect(() => {\n    if (!shouldVirtualize) return;\n\n    observerRef.current = new IntersectionObserver(\n      (entries) => {\n        setVisibleChunks(prev => {\n          const next = new Set(prev);\n          entries.forEach(entry => {\n            const id = parseInt(entry.target.getAttribute('data-chunk-id') || '0');\n            if (entry.isIntersecting) {\n              next.add(id);\n              next.add(id - 1);\n              next.add(id + 1);\n            }\n          });\n          return next;\n        });\n      },\n      {\n        root: null,\n        rootMargin: '200px 0px',\n        threshold: 0,\n      }\n    );\n\n    return () => {\n      observerRef.current?.disconnect();\n    };\n  }, [shouldVirtualize]);\n\n  if (!shouldVirtualize) {\n    if (detectedFormat === \"rst\") {\n      const parsed = parseDocument(content, \"rst\", filename);\n      return (\n        <div className={cn(\"document-renderer\", className)} data-testid=\"document-renderer\">\n          <RstContent html={parsed.html} />\n        </div>\n      );\n    }\n\n    return (\n      <div className={cn(\"document-renderer\", className)} data-testid=\"document-renderer\">\n        <Suspense fallback={\n          <div className=\"flex items-center gap-2 p-4 text-muted-foreground\">\n            <Loader2 className=\"h-4 w-4 animate-spin\" />\n            <span className=\"text-sm\">Loading markdown renderer...</span>\n          </div>\n        }>\n          <MarkdownRenderer content={content} />\n        </Suspense>\n      </div>\n    );\n  }\n\n  return (\n    <div \n      ref={containerRef}\n      className={cn(\"document-renderer\", className)} \n      data-testid=\"document-renderer\"\n    >\n      {chunks?.map((chunk) => (\n        <div\n          key={chunk.id}\n          ref={(el) => registerChunkRef(chunk.id, el)}\n          data-chunk-id={chunk.id}\n          data-testid={`chunk-${chunk.id}`}\n        >\n          <LazyChunk\n            chunk={chunk}\n            format={detectedFormat}\n            isVisible={visibleChunks.has(chunk.id)}\n            estimatedHeight={CHUNK_HEIGHT_ESTIMATE * Math.min(chunk.endLine - chunk.startLine, CHUNK_SIZE)}\n          />\n        </div>\n      ))}\n    </div>\n  );\n});\n\nexport default DocumentRenderer;\n","path":null,"size_bytes":6536,"size_tokens":null},"client/src/lib/rstParser.ts":{"content":"export type DocumentFormat = \"markdown\" | \"rst\" | \"auto\";\n\nexport interface ParsedDocument {\n  format: \"markdown\" | \"rst\";\n  html: string;\n  toc?: TableOfContentsItem[];\n}\n\nexport interface TableOfContentsItem {\n  level: number;\n  title: string;\n  id: string;\n}\n\nexport function detectFormat(content: string, filename?: string): \"markdown\" | \"rst\" {\n  if (filename) {\n    const ext = filename.toLowerCase().split('.').pop();\n    if (ext === 'rst' || ext === 'rest') return \"rst\";\n    if (ext === 'md' || ext === 'markdown' || ext === 'mdx') return \"markdown\";\n  }\n  const rstPatterns = [\n    /^[=\\-~`'\"^_*+#]+\\s*$/m,\n    /^\\.\\.\\s+\\w+::/m,\n    /^:\\w+:/m,\n    /^\\s*\\.\\.\\s+_\\w+:/m,\n    /^```.+```$/m,\n  ];\n\n  const markdownPatterns = [\n    /^#{1,6}\\s+/m,\n    /^\\*{3,}$|^-{3,}$|^_{3,}$/m,\n    /\\[.+\\]\\(.+\\)/,\n    /^>\\s+/m,\n    /^```\\w*$/m,\n  ];\n\n  let rstScore = 0;\n  let mdScore = 0;\n\n  for (const pattern of rstPatterns) {\n    if (pattern.test(content)) rstScore++;\n  }\n\n  for (const pattern of markdownPatterns) {\n    if (pattern.test(content)) mdScore++;\n  }\n\n  return rstScore > mdScore ? \"rst\" : \"markdown\";\n}\n\nfunction escapeHtml(text: string): string {\n  return text\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nfunction generateId(text: string): string {\n  return text\n    .toLowerCase()\n    .replace(/[^\\w\\s-]/g, '')\n    .replace(/\\s+/g, '-')\n    .slice(0, 50);\n}\n\nexport function parseRst(content: string): ParsedDocument {\n  if (!content) {\n    return { format: \"rst\", html: \"\" };\n  }\n\n  const lines = content.split('\\n');\n  const htmlParts: string[] = [];\n  const toc: TableOfContentsItem[] = [];\n  let i = 0;\n  let inCodeBlock = false;\n  let codeBlockContent: string[] = [];\n  let codeBlockLang = '';\n  let inBlockquote = false;\n  let blockquoteContent: string[] = [];\n  let inList = false;\n  let listItems: string[] = [];\n  let listType: 'ul' | 'ol' = 'ul';\n\n  const flushCodeBlock = () => {\n    if (codeBlockContent.length > 0) {\n      const code = escapeHtml(codeBlockContent.join('\\n'));\n      const langClass = codeBlockLang ? ` class=\"language-${codeBlockLang}\"` : '';\n      htmlParts.push(`<pre><code${langClass}>${code}</code></pre>`);\n      codeBlockContent = [];\n      codeBlockLang = '';\n    }\n    inCodeBlock = false;\n  };\n\n  const flushBlockquote = () => {\n    if (blockquoteContent.length > 0) {\n      htmlParts.push(`<blockquote>${blockquoteContent.join('<br>')}</blockquote>`);\n      blockquoteContent = [];\n    }\n    inBlockquote = false;\n  };\n\n  const flushList = () => {\n    if (listItems.length > 0) {\n      const items = listItems.map(item => `<li>${item}</li>`).join('');\n      htmlParts.push(`<${listType}>${items}</${listType}>`);\n      listItems = [];\n    }\n    inList = false;\n  };\n\n  while (i < lines.length) {\n    const line = lines[i];\n    const nextLine = lines[i + 1] || '';\n    if (inCodeBlock) {\n      if (line.match(/^\\s{0,2}\\S/) && !line.startsWith('   ')) {\n        flushCodeBlock();\n        continue;\n      }\n      codeBlockContent.push(line.replace(/^   /, ''));\n      i++;\n      continue;\n    }\n    const codeBlockMatch = line.match(/^\\.\\.\\s+code-block::\\s*(\\w+)?/i) || \n                           line.match(/^\\.\\.\\s+code::\\s*(\\w+)?/i) ||\n                           line.match(/^::\\s*$/);\n    if (codeBlockMatch) {\n      flushBlockquote();\n      flushList();\n      codeBlockLang = codeBlockMatch[1] || '';\n      inCodeBlock = true;\n      i++;\n      while (i < lines.length && lines[i].trim() === '') i++;\n      continue;\n    }\n    if (line.trim() === '' && nextLine.match(/^\\s{3,}/)) {\n      flushBlockquote();\n      flushList();\n      inCodeBlock = true;\n      i++;\n      continue;\n    }\n    const titleUnderlineMatch = nextLine.match(/^([=\\-~`'\"^_*+#])\\1{2,}\\s*$/);\n    if (titleUnderlineMatch && line.trim().length > 0 && !line.startsWith(' ')) {\n      flushBlockquote();\n      flushList();\n      const char = titleUnderlineMatch[1];\n      const levelMap: Record<string, number> = { '=': 1, '-': 2, '~': 3, '^': 4, '\"': 5, \"'\": 6 };\n      const level = levelMap[char] || 2;\n      const title = line.trim();\n      const id = generateId(title);\n      toc.push({ level, title, id });\n      htmlParts.push(`<h${level} id=\"${id}\">${escapeHtml(title)}</h${level}>`);\n      i += 2;\n      continue;\n    }\n    const noteMatch = line.match(/^\\.\\.\\s+(note|warning|tip|important|caution|danger|attention|error|hint)::\\s*(.*)$/i);\n    if (noteMatch) {\n      flushBlockquote();\n      flushList();\n      const type = noteMatch[1].toLowerCase();\n      const title = noteMatch[2] || type.charAt(0).toUpperCase() + type.slice(1);\n      let noteContent: string[] = [];\n      i++;\n      while (i < lines.length && (lines[i].startsWith('   ') || lines[i].trim() === '')) {\n        if (lines[i].trim()) noteContent.push(lines[i].replace(/^\\s{3}/, ''));\n        i++;\n      }\n      htmlParts.push(`<div class=\"admonition ${type}\"><p class=\"admonition-title\">${escapeHtml(title)}</p><p>${escapeHtml(noteContent.join(' '))}</p></div>`);\n      continue;\n    }\n    const imageMatch = line.match(/^\\.\\.\\s+image::\\s*(.+)$/);\n    if (imageMatch) {\n      flushBlockquote();\n      flushList();\n      const src = imageMatch[1].trim();\n      let alt = '';\n      i++;\n      while (i < lines.length && lines[i].startsWith('   :')) {\n        const attrMatch = lines[i].match(/^\\s+:(\\w+):\\s*(.*)$/);\n        if (attrMatch && attrMatch[1] === 'alt') {\n          alt = attrMatch[2];\n        }\n        i++;\n      }\n      htmlParts.push(`<img src=\"${escapeHtml(src)}\" alt=\"${escapeHtml(alt)}\" loading=\"lazy\" />`);\n      continue;\n    }\n    const linkTargetMatch = line.match(/^\\.\\.\\s+_([^:]+):\\s*(.+)$/);\n    if (linkTargetMatch) {\n      i++;\n      continue;\n    }\n    const bulletMatch = line.match(/^(\\*|-|\\+)\\s+(.+)$/);\n    if (bulletMatch) {\n      flushBlockquote();\n      if (!inList || listType !== 'ul') {\n        flushList();\n        inList = true;\n        listType = 'ul';\n      }\n      listItems.push(escapeHtml(bulletMatch[2]));\n      i++;\n      continue;\n    }\n    const numberedMatch = line.match(/^(\\d+)\\.\\s+(.+)$/);\n    if (numberedMatch) {\n      flushBlockquote();\n      if (!inList || listType !== 'ol') {\n        flushList();\n        inList = true;\n        listType = 'ol';\n      }\n      listItems.push(escapeHtml(numberedMatch[2]));\n      i++;\n      continue;\n    }\n    if (line.trim() === '') {\n      flushBlockquote();\n      flushList();\n      i++;\n      continue;\n    }\n    let processed = escapeHtml(line);\n    processed = processed.replace(/``([^`]+)``/g, (_, content) => `<code>${content}</code>`);\n    processed = processed.replace(/`([^`]+)`_/g, (_, content) => `<a href=\"#\">${content}</a>`);\n    processed = processed.replace(/\\*\\*([^*]+)\\*\\*/g, (_, content) => `<strong>${content}</strong>`);\n    processed = processed.replace(/\\*([^*]+)\\*/g, (_, content) => `<em>${content}</em>`);\n    processed = processed.replace(/:(\\w+):`([^`]+)`/g, (_, role, content) => `<span class=\"role-${role}\">${content}</span>`);\n\n    if (inList) {\n      listItems[listItems.length - 1] += ' ' + processed;\n    } else {\n      htmlParts.push(`<p>${processed}</p>`);\n    }\n    i++;\n  }\n\n  flushCodeBlock();\n  flushBlockquote();\n  flushList();\n\n  return {\n    format: \"rst\",\n    html: htmlParts.join('\\n'),\n    toc: toc.length > 0 ? toc : undefined,\n  };\n}\n\nexport function parseDocument(\n  content: string, \n  format: DocumentFormat = \"auto\",\n  filename?: string\n): ParsedDocument {\n  const detectedFormat = format === \"auto\" ? detectFormat(content, filename) : format;\n  \n  if (detectedFormat === \"rst\") {\n    return parseRst(content);\n  }\n  return {\n    format: \"markdown\",\n    html: content,\n  };\n}\n","path":null,"size_bytes":7717,"size_tokens":null},"client/src/components/document/index.ts":{"content":"export { DocumentPreview, type DocumentPreviewProps, type DocumentType } from \"./DocumentPreview\";\nexport { default as DocumentPreviewDefault } from \"./DocumentPreview\";\n","path":null,"size_bytes":170,"size_tokens":null},"client/src/graphics/canvas/canvas-engine.tsx":{"content":"import { useRef, useEffect, useCallback, forwardRef, useImperativeHandle } from 'react';\nimport type { Canvas2DConfig } from '@shared/schemas/graphics';\nimport { setupHiDPICanvas, clearCanvas, exportCanvasAsPNG, exportCanvasAsJPEG, downloadCanvas } from './canvas-utils';\n\nexport interface CanvasEngineRef {\n  getCanvas: () => HTMLCanvasElement | null;\n  getContext: () => CanvasRenderingContext2D | null;\n  exportPNG: () => Promise<Blob>;\n  exportJPEG: (quality?: number) => Promise<Blob>;\n  download: (filename: string, format?: 'png' | 'jpeg') => void;\n  clear: (color?: string) => void;\n}\n\ninterface CanvasEngineProps {\n  config: Canvas2DConfig;\n  className?: string;\n  onFrame?: (ctx: CanvasRenderingContext2D, deltaTime: number) => void;\n  onReady?: (ctx: CanvasRenderingContext2D) => void;\n}\n\nexport const CanvasEngine = forwardRef<CanvasEngineRef, CanvasEngineProps>(\n  function CanvasEngine({ config, className, onFrame, onReady }, ref) {\n    const canvasRef = useRef<HTMLCanvasElement>(null);\n    const contextRef = useRef<CanvasRenderingContext2D | null>(null);\n    const animationFrameRef = useRef<number>(0);\n    const lastTimeRef = useRef<number>(0);\n    const isRunningRef = useRef<boolean>(false);\n\n    const getNumericDimension = useCallback((value: number | string | undefined, fallback: number): number => {\n      if (value === undefined) return fallback;\n      if (typeof value === 'number') return value;\n      const parsed = parseFloat(value);\n      return isNaN(parsed) ? fallback : parsed;\n    }, []);\n\n    const width = getNumericDimension(config.width, 800);\n    const height = getNumericDimension(config.height, 600);\n\n    useImperativeHandle(ref, () => ({\n      getCanvas: () => canvasRef.current,\n      getContext: () => contextRef.current,\n      exportPNG: () => {\n        if (!canvasRef.current) return Promise.reject(new Error('Canvas not available'));\n        return exportCanvasAsPNG(canvasRef.current);\n      },\n      exportJPEG: (quality?: number) => {\n        if (!canvasRef.current) return Promise.reject(new Error('Canvas not available'));\n        return exportCanvasAsJPEG(canvasRef.current, quality);\n      },\n      download: (filename: string, format?: 'png' | 'jpeg') => {\n        if (!canvasRef.current) return;\n        downloadCanvas(canvasRef.current, filename, format);\n      },\n      clear: (color?: string) => {\n        if (!contextRef.current) return;\n        clearCanvas(contextRef.current, color);\n      },\n    }), []);\n\n    const animationLoop = useCallback((timestamp: number) => {\n      if (!isRunningRef.current || !contextRef.current) return;\n\n      const deltaTime = lastTimeRef.current ? (timestamp - lastTimeRef.current) / 1000 : 0;\n      lastTimeRef.current = timestamp;\n\n      if (config.targetFPS) {\n        const targetFrameTime = 1000 / config.targetFPS;\n        if (deltaTime * 1000 < targetFrameTime * 0.9) {\n          animationFrameRef.current = requestAnimationFrame(animationLoop);\n          return;\n        }\n      }\n\n      if (onFrame) {\n        onFrame(contextRef.current, deltaTime);\n      }\n\n      animationFrameRef.current = requestAnimationFrame(animationLoop);\n    }, [config.targetFPS, onFrame]);\n\n    useEffect(() => {\n      const canvas = canvasRef.current;\n      if (!canvas) return;\n\n      const ctx = canvas.getContext('2d');\n      if (!ctx) return;\n\n      contextRef.current = ctx;\n      setupHiDPICanvas(canvas, ctx, width, height);\n\n      if (config.background) {\n        clearCanvas(ctx, config.background);\n      }\n\n      if (onReady) {\n        onReady(ctx);\n      }\n\n      if (config.animationLoop && onFrame) {\n        isRunningRef.current = true;\n        lastTimeRef.current = 0;\n        animationFrameRef.current = requestAnimationFrame(animationLoop);\n      }\n\n      return () => {\n        isRunningRef.current = false;\n        if (animationFrameRef.current) {\n          cancelAnimationFrame(animationFrameRef.current);\n        }\n      };\n    }, [width, height, config.background, config.animationLoop, onFrame, onReady, animationLoop]);\n\n    useEffect(() => {\n      if (!config.responsive) return;\n\n      const canvas = canvasRef.current;\n      if (!canvas) return;\n\n      const resizeObserver = new ResizeObserver((entries) => {\n        for (const entry of entries) {\n          const { width: newWidth, height: newHeight } = entry.contentRect;\n          const ctx = contextRef.current;\n          if (ctx && newWidth > 0 && newHeight > 0) {\n            setupHiDPICanvas(canvas, ctx, newWidth, newHeight);\n            if (config.background) {\n              clearCanvas(ctx, config.background);\n            }\n          }\n        }\n      });\n\n      const parent = canvas.parentElement;\n      if (parent) {\n        resizeObserver.observe(parent);\n      }\n\n      return () => {\n        resizeObserver.disconnect();\n      };\n    }, [config.responsive, config.background]);\n\n    return (\n      <canvas\n        ref={canvasRef}\n        className={className}\n        data-testid={`canvas-engine-${config.id}`}\n        style={{\n          display: 'block',\n          width: config.responsive ? '100%' : width,\n          height: config.responsive ? '100%' : height,\n        }}\n      />\n    );\n  }\n);\n\nexport default CanvasEngine;\n","path":null,"size_bytes":5212,"size_tokens":null},"shared/schemas/visualization.ts":{"content":"import { z } from \"zod\";\n\n// Base data point types\nexport interface DataPoint {\n  label: string;\n  value: number;\n  [key: string]: any;\n}\n\nexport interface TimeSeriesPoint {\n  timestamp: string | Date;\n  value: number;\n  series?: string;\n}\n\nexport interface GeoPoint {\n  lat: number;\n  lng: number;\n  value: number;\n  label?: string;\n}\n\n// Chart configuration types\nexport type ChartType = 'bar' | 'line' | 'area' | 'pie' | 'donut' | 'scatter' | 'heatmap' | 'map';\n\nexport interface ChartConfig {\n  type: ChartType;\n  title?: string;\n  subtitle?: string;\n  width?: number | string;\n  height?: number | string;\n  responsive?: boolean;\n  \n  data: DataPoint[] | TimeSeriesPoint[] | GeoPoint[];\n  xAxisKey?: string;\n  yAxisKey?: string;\n  seriesKey?: string;\n  \n  colors?: string[];\n  showLegend?: boolean;\n  showGrid?: boolean;\n  showTooltip?: boolean;\n  \n  enableZoom?: boolean;\n  enablePan?: boolean;\n  enableExport?: boolean;\n  \n  mapCenter?: [number, number];\n  mapZoom?: number;\n}\n\n// Table configuration types\nexport type ColumnType = 'text' | 'number' | 'date' | 'boolean' | 'select' | 'currency';\nexport type FilterOperator = 'equals' | 'contains' | 'startsWith' | 'endsWith' | 'gt' | 'lt' | 'gte' | 'lte' | 'between' | 'in';\n\nexport interface ColumnDef {\n  id: string;\n  header: string;\n  accessorKey: string;\n  type: ColumnType;\n  sortable?: boolean;\n  filterable?: boolean;\n  filterOptions?: string[];\n  width?: number | string;\n  align?: 'left' | 'center' | 'right';\n  format?: string;\n}\n\nexport interface SortConfig {\n  id: string;\n  desc: boolean;\n}\n\nexport interface FilterConfig {\n  id: string;\n  value: any;\n}\n\nexport interface TableConfig {\n  columns: ColumnDef[];\n  data: Record<string, any>[];\n  \n  pageSize?: number;\n  serverSide?: boolean;\n  totalRows?: number;\n  \n  enableSorting?: boolean;\n  enableFiltering?: boolean;\n  enableGlobalSearch?: boolean;\n  enableRowSelection?: boolean;\n  enableVirtualization?: boolean;\n  \n  onPageChange?: (page: number) => void;\n  onSortChange?: (sortBy: SortConfig[]) => void;\n  onFilterChange?: (filters: FilterConfig[]) => void;\n  onSearchChange?: (search: string) => void;\n}\n\n// Unified visualization config\nexport interface VisualizationConfig {\n  id: string;\n  type: 'chart' | 'table';\n  chart?: ChartConfig;\n  table?: TableConfig;\n}\n\n// Zod Schemas for runtime validation\n\nexport const DataPointSchema = z.object({\n  label: z.string(),\n  value: z.number(),\n}).passthrough();\n\nexport const TimeSeriesPointSchema = z.object({\n  timestamp: z.union([z.string(), z.date()]),\n  value: z.number(),\n  series: z.string().optional(),\n});\n\nexport const GeoPointSchema = z.object({\n  lat: z.number(),\n  lng: z.number(),\n  value: z.number(),\n  label: z.string().optional(),\n});\n\nexport const ChartTypeSchema = z.enum(['bar', 'line', 'area', 'pie', 'donut', 'scatter', 'heatmap', 'map']);\n\nexport const ChartConfigSchema = z.object({\n  type: ChartTypeSchema,\n  title: z.string().optional(),\n  subtitle: z.string().optional(),\n  width: z.union([z.number(), z.string()]).optional(),\n  height: z.union([z.number(), z.string()]).optional(),\n  responsive: z.boolean().optional(),\n  \n  data: z.union([\n    z.array(DataPointSchema),\n    z.array(TimeSeriesPointSchema),\n    z.array(GeoPointSchema),\n  ]),\n  xAxisKey: z.string().optional(),\n  yAxisKey: z.string().optional(),\n  seriesKey: z.string().optional(),\n  \n  colors: z.array(z.string()).optional(),\n  showLegend: z.boolean().optional(),\n  showGrid: z.boolean().optional(),\n  showTooltip: z.boolean().optional(),\n  \n  enableZoom: z.boolean().optional(),\n  enablePan: z.boolean().optional(),\n  enableExport: z.boolean().optional(),\n  \n  mapCenter: z.tuple([z.number(), z.number()]).optional(),\n  mapZoom: z.number().optional(),\n});\n\nexport const ColumnTypeSchema = z.enum(['text', 'number', 'date', 'boolean', 'select', 'currency']);\nexport const FilterOperatorSchema = z.enum(['equals', 'contains', 'startsWith', 'endsWith', 'gt', 'lt', 'gte', 'lte', 'between', 'in']);\n\nexport const ColumnDefSchema = z.object({\n  id: z.string(),\n  header: z.string(),\n  accessorKey: z.string(),\n  type: ColumnTypeSchema,\n  sortable: z.boolean().optional(),\n  filterable: z.boolean().optional(),\n  filterOptions: z.array(z.string()).optional(),\n  width: z.union([z.number(), z.string()]).optional(),\n  align: z.enum(['left', 'center', 'right']).optional(),\n  format: z.string().optional(),\n});\n\nexport const SortConfigSchema = z.object({\n  id: z.string(),\n  desc: z.boolean(),\n});\n\nexport const FilterConfigSchema = z.object({\n  id: z.string(),\n  value: z.any(),\n});\n\nexport const TableConfigSchema = z.object({\n  columns: z.array(ColumnDefSchema),\n  data: z.array(z.record(z.any())),\n  \n  pageSize: z.number().optional(),\n  serverSide: z.boolean().optional(),\n  totalRows: z.number().optional(),\n  \n  enableSorting: z.boolean().optional(),\n  enableFiltering: z.boolean().optional(),\n  enableGlobalSearch: z.boolean().optional(),\n  enableRowSelection: z.boolean().optional(),\n  enableVirtualization: z.boolean().optional(),\n});\n\nexport const VisualizationTypeSchema = z.enum(['chart', 'table']);\n\nexport const VisualizationConfigSchema = z.object({\n  id: z.string(),\n  type: VisualizationTypeSchema,\n  chart: ChartConfigSchema.optional(),\n  table: TableConfigSchema.optional(),\n});\n\n// Inferred types from Zod schemas\nexport type DataPointZod = z.infer<typeof DataPointSchema>;\nexport type TimeSeriesPointZod = z.infer<typeof TimeSeriesPointSchema>;\nexport type GeoPointZod = z.infer<typeof GeoPointSchema>;\nexport type ChartConfigZod = z.infer<typeof ChartConfigSchema>;\nexport type ColumnDefZod = z.infer<typeof ColumnDefSchema>;\nexport type TableConfigZod = z.infer<typeof TableConfigSchema>;\nexport type VisualizationConfigZod = z.infer<typeof VisualizationConfigSchema>;\n","path":null,"size_bytes":5754,"size_tokens":null},"client/src/workers/prismWorker.ts":{"content":"import Prism from 'prismjs';\nimport 'prismjs/components/prism-core';\n\nconst loadedLanguages = new Set<string>(['javascript', 'css', 'markup', 'clike']);\nconst loadingPromises = new Map<string, Promise<void>>();\n\nconst languageAliases: Record<string, string> = {\n  'js': 'javascript',\n  'ts': 'typescript',\n  'py': 'python',\n  'rb': 'ruby',\n  'yml': 'yaml',\n  'sh': 'bash',\n  'shell': 'bash',\n  'zsh': 'bash',\n  'dockerfile': 'docker',\n  'md': 'markdown',\n  'htm': 'html',\n  'jsonc': 'json',\n  'tsx': 'tsx',\n  'jsx': 'jsx',\n  'c++': 'cpp',\n  'c#': 'csharp',\n  'cs': 'csharp',\n  'golang': 'go',\n  'rs': 'rust',\n  'kt': 'kotlin',\n  'tf': 'hcl',\n  'terraform': 'hcl',\n  'plaintext': 'text',\n  'txt': 'text',\n};\n\nconst languageDependencies: Record<string, string[]> = {\n  'typescript': ['javascript'],\n  'jsx': ['javascript'],\n  'tsx': ['javascript', 'jsx', 'typescript'],\n  'cpp': ['c'],\n  'csharp': ['clike'],\n  'java': ['clike'],\n  'kotlin': ['clike'],\n  'scala': ['java'],\n  'swift': ['clike'],\n  'objectivec': ['c'],\n  'php': ['markup', 'clike'],\n  'aspnet': ['markup', 'csharp'],\n  'scss': ['css'],\n  'sass': ['css'],\n  'less': ['css'],\n  'stylus': ['css'],\n  'pug': ['markup', 'javascript'],\n  'markdown': ['markup'],\n  'django': ['markup', 'python'],\n  'erb': ['markup', 'ruby'],\n  'handlebars': ['markup'],\n  'twig': ['markup'],\n  'velocity': ['markup'],\n};\n\nfunction resolveLanguage(lang: string): string {\n  const normalized = lang.toLowerCase().trim();\n  return languageAliases[normalized] || normalized;\n}\n\nfunction escapeHtml(text: string): string {\n  const htmlEscapes: Record<string, string> = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n  };\n  return text.replace(/[&<>\"']/g, (char) => htmlEscapes[char] || char);\n}\n\nasync function loadLanguageDependencies(lang: string): Promise<void> {\n  const deps = languageDependencies[lang];\n  if (deps) {\n    for (const dep of deps) {\n      await loadLanguageInWorker(dep);\n    }\n  }\n}\n\nasync function loadLanguageInWorker(lang: string): Promise<boolean> {\n  const resolved = resolveLanguage(lang);\n  \n  if (resolved === 'text' || resolved === 'plaintext') {\n    return true;\n  }\n  \n  if (loadedLanguages.has(resolved)) {\n    return true;\n  }\n  \n  if (loadingPromises.has(resolved)) {\n    await loadingPromises.get(resolved);\n    return loadedLanguages.has(resolved);\n  }\n  \n  const loadPromise = (async () => {\n    try {\n      await loadLanguageDependencies(resolved);\n      \n      const langModule = await import(`prismjs/components/prism-${resolved}.js`);\n      \n      if (langModule) {\n        loadedLanguages.add(resolved);\n      }\n    } catch (error) {\n      console.warn(`[PrismWorker] Failed to load language: ${resolved}`, error);\n    } finally {\n      loadingPromises.delete(resolved);\n    }\n  })();\n  \n  loadingPromises.set(resolved, loadPromise);\n  await loadPromise;\n  \n  return loadedLanguages.has(resolved);\n}\n\nfunction highlightCodeSync(code: string, language: string): string {\n  const resolved = resolveLanguage(language);\n  \n  if (resolved === 'text' || resolved === 'plaintext' || !code) {\n    return escapeHtml(code);\n  }\n  \n  const grammar = Prism.languages[resolved];\n  \n  if (!grammar) {\n    return escapeHtml(code);\n  }\n  \n  try {\n    return Prism.highlight(code, grammar, resolved);\n  } catch (error) {\n    console.warn(`[PrismWorker] Error highlighting: ${resolved}`, error);\n    return escapeHtml(code);\n  }\n}\n\nexport interface PrismWorkerRequest {\n  id: string;\n  code: string;\n  language: string;\n}\n\nexport interface PrismWorkerResponse {\n  id: string;\n  html: string;\n  language: string;\n  success: boolean;\n  error?: string;\n}\n\nself.onmessage = async (event: MessageEvent<PrismWorkerRequest>) => {\n  const { id, code, language } = event.data;\n  \n  try {\n    const resolved = resolveLanguage(language);\n    \n    await loadLanguageInWorker(resolved);\n    \n    const html = highlightCodeSync(code, resolved);\n    \n    const response: PrismWorkerResponse = {\n      id,\n      html,\n      language: resolved,\n      success: true,\n    };\n    \n    self.postMessage(response);\n  } catch (error) {\n    const response: PrismWorkerResponse = {\n      id,\n      html: escapeHtml(code),\n      language: resolveLanguage(language),\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error occurred',\n    };\n    \n    self.postMessage(response);\n  }\n};\n\nexport {};\n","path":null,"size_bytes":4411,"size_tokens":null},"client/src/graphics/index.ts":{"content":"export { VisualizationSurface, type VisualizationSurfaceProps } from './visualization-surface';\n\nexport { SVGRenderer, type SVGRendererProps } from './svg';\nexport { sanitizeSVG, exportSVGAsString, exportSVGAsPNG, downloadBlob, downloadSVG, downloadPNG } from './svg';\n\nexport { CanvasEngine, type CanvasEngineRef } from './canvas';\nexport { exportCanvasAsPNG, exportCanvasAsJPEG, downloadCanvas, clearCanvas, setupHiDPICanvas, getDevicePixelRatio, createOffscreenCanvas } from './canvas';\n\nexport { ThreeEngine } from './three';\nexport { ThreeEngineImpl, type ThreeEngineRef } from './three';\n\nexport type {\n  RenderMode,\n  GraphicsCapabilities,\n  GraphicsSurfaceConfig,\n  SVGConfig,\n  Canvas2DConfig,\n  WebGLConfig,\n  GraphicsConfig,\n} from '@shared/schemas/graphics';\n\nexport {\n  detectCapabilities,\n  resolveRenderMode,\n  RenderModeSchema,\n  GraphicsCapabilitiesSchema,\n  GraphicsSurfaceConfigSchema,\n  SVGConfigSchema,\n  Canvas2DConfigSchema,\n  WebGLConfigSchema,\n  GraphicsConfigSchema,\n} from '@shared/schemas/graphics';\n","path":null,"size_bytes":1028,"size_tokens":null},"shared/schemas/graphics.ts":{"content":"import { z } from \"zod\";\n\n// Rendering modes\nexport type RenderMode = 'svg' | 'canvas2d' | 'webgl' | 'auto';\n\n// Capability detection\nexport interface GraphicsCapabilities {\n  webgl: boolean;\n  webgl2: boolean;\n  offscreenCanvas: boolean;\n  svg: boolean;\n}\n\nexport function detectCapabilities(): GraphicsCapabilities {\n  const capabilities: GraphicsCapabilities = {\n    webgl: false,\n    webgl2: false,\n    offscreenCanvas: false,\n    svg: false,\n  };\n\n  if (typeof window === 'undefined' || typeof document === 'undefined') {\n    return capabilities;\n  }\n\n  // Check SVG support\n  capabilities.svg = !!document.createElementNS && \n    !!document.createElementNS('http://www.w3.org/2000/svg', 'svg').createSVGRect;\n\n  // Check OffscreenCanvas support\n  capabilities.offscreenCanvas = typeof OffscreenCanvas !== 'undefined';\n\n  // Check WebGL support\n  try {\n    const canvas = document.createElement('canvas');\n    capabilities.webgl = !!(\n      canvas.getContext('webgl') || \n      canvas.getContext('experimental-webgl')\n    );\n    capabilities.webgl2 = !!canvas.getContext('webgl2');\n  } catch (e) {\n    capabilities.webgl = false;\n    capabilities.webgl2 = false;\n  }\n\n  return capabilities;\n}\n\n// Base configuration\nexport interface GraphicsSurfaceConfig {\n  id: string;\n  mode: RenderMode;\n  width?: number | string;\n  height?: number | string;\n  responsive?: boolean;\n  background?: string;\n  exportable?: boolean;\n}\n\n// SVG-specific config\nexport interface SVGConfig extends GraphicsSurfaceConfig {\n  mode: 'svg';\n  content?: string;\n  viewBox?: string;\n  preserveAspectRatio?: string;\n  enableZoom?: boolean;\n  enablePan?: boolean;\n}\n\n// Canvas 2D config\nexport interface Canvas2DConfig extends GraphicsSurfaceConfig {\n  mode: 'canvas2d';\n  enablePhysics?: boolean;\n  physicsEngine?: 'matter' | 'custom';\n  animationLoop?: boolean;\n  targetFPS?: number;\n}\n\n// WebGL/Three.js config\nexport interface WebGLConfig extends GraphicsSurfaceConfig {\n  mode: 'webgl';\n  modelUrl?: string;\n  modelFormat?: 'gltf' | 'glb' | 'obj';\n  enableOrbitControls?: boolean;\n  lighting?: 'ambient' | 'directional' | 'point' | 'custom';\n  enableLOD?: boolean;\n  fallbackMode?: 'canvas2d' | 'svg' | 'none';\n}\n\n// Union type\nexport type GraphicsConfig = SVGConfig | Canvas2DConfig | WebGLConfig;\n\n// Fallback resolver\nexport function resolveRenderMode(\n  requested: RenderMode,\n  capabilities: GraphicsCapabilities,\n  fallbackOrder: RenderMode[] = ['canvas2d', 'svg']\n): RenderMode {\n  if (requested === 'auto') {\n    if (capabilities.webgl) return 'webgl';\n    if (capabilities.svg) return 'svg';\n    return 'canvas2d';\n  }\n\n  if (requested === 'webgl' && capabilities.webgl) return 'webgl';\n  if (requested === 'svg' && capabilities.svg) return 'svg';\n  if (requested === 'canvas2d') return 'canvas2d';\n\n  for (const fallback of fallbackOrder) {\n    if (fallback === 'webgl' && capabilities.webgl) return 'webgl';\n    if (fallback === 'svg' && capabilities.svg) return 'svg';\n    if (fallback === 'canvas2d') return 'canvas2d';\n  }\n\n  return 'canvas2d';\n}\n\n// Zod Schemas\n\nexport const RenderModeSchema = z.enum(['svg', 'canvas2d', 'webgl', 'auto']);\n\nexport const GraphicsCapabilitiesSchema = z.object({\n  webgl: z.boolean(),\n  webgl2: z.boolean(),\n  offscreenCanvas: z.boolean(),\n  svg: z.boolean(),\n});\n\nexport const GraphicsSurfaceConfigSchema = z.object({\n  id: z.string(),\n  mode: RenderModeSchema,\n  width: z.union([z.number(), z.string()]).optional(),\n  height: z.union([z.number(), z.string()]).optional(),\n  responsive: z.boolean().optional(),\n  background: z.string().optional(),\n  exportable: z.boolean().optional(),\n});\n\nexport const SVGConfigSchema = GraphicsSurfaceConfigSchema.extend({\n  mode: z.literal('svg'),\n  content: z.string().optional(),\n  viewBox: z.string().optional(),\n  preserveAspectRatio: z.string().optional(),\n  enableZoom: z.boolean().optional(),\n  enablePan: z.boolean().optional(),\n});\n\nexport const Canvas2DConfigSchema = GraphicsSurfaceConfigSchema.extend({\n  mode: z.literal('canvas2d'),\n  enablePhysics: z.boolean().optional(),\n  physicsEngine: z.enum(['matter', 'custom']).optional(),\n  animationLoop: z.boolean().optional(),\n  targetFPS: z.number().optional(),\n});\n\nexport const WebGLConfigSchema = GraphicsSurfaceConfigSchema.extend({\n  mode: z.literal('webgl'),\n  modelUrl: z.string().optional(),\n  modelFormat: z.enum(['gltf', 'glb', 'obj']).optional(),\n  enableOrbitControls: z.boolean().optional(),\n  lighting: z.enum(['ambient', 'directional', 'point', 'custom']).optional(),\n  enableLOD: z.boolean().optional(),\n  fallbackMode: z.enum(['canvas2d', 'svg', 'none']).optional(),\n});\n\nexport const GraphicsConfigSchema = z.discriminatedUnion('mode', [\n  SVGConfigSchema,\n  Canvas2DConfigSchema,\n  WebGLConfigSchema,\n]);\n\n// Inferred types from Zod schemas\nexport type RenderModeZod = z.infer<typeof RenderModeSchema>;\nexport type GraphicsCapabilitiesZod = z.infer<typeof GraphicsCapabilitiesSchema>;\nexport type GraphicsSurfaceConfigZod = z.infer<typeof GraphicsSurfaceConfigSchema>;\nexport type SVGConfigZod = z.infer<typeof SVGConfigSchema>;\nexport type Canvas2DConfigZod = z.infer<typeof Canvas2DConfigSchema>;\nexport type WebGLConfigZod = z.infer<typeof WebGLConfigSchema>;\nexport type GraphicsConfigZod = z.infer<typeof GraphicsConfigSchema>;\n","path":null,"size_bytes":5279,"size_tokens":null},"client/src/components/document/DocumentPreview.tsx":{"content":"import React, { useState, useEffect, useRef, useCallback, memo } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport {\n  ZoomIn,\n  ZoomOut,\n  RotateCw,\n  Download,\n  ChevronLeft,\n  ChevronRight,\n  AlertCircle,\n  FileText,\n  FileSpreadsheet,\n  Presentation,\n  Loader2,\n} from \"lucide-react\";\n\nexport type DocumentType = \"pdf\" | \"docx\" | \"xlsx\" | \"pptx\";\n\nexport interface DocumentPreviewProps {\n  url: string;\n  type: DocumentType;\n  title?: string;\n  className?: string;\n}\n\ninterface PDFViewerState {\n  loading: boolean;\n  error: string | null;\n  numPages: number;\n  currentPage: number;\n  scale: number;\n}\n\nconst PDFJS_CDN_URL = \"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs\";\nconst PDFJS_WORKER_URL = \"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs\";\n\nconst ZOOM_LEVELS = [0.5, 0.75, 1, 1.25, 1.5, 2, 2.5, 3];\nconst DEFAULT_ZOOM = 1;\n\nconst LoadingSkeleton = memo(function LoadingSkeleton() {\n  return (\n    <div className=\"flex flex-col gap-4 p-4\" data-testid=\"document-preview-skeleton\">\n      <Skeleton className=\"h-8 w-48\" />\n      <Skeleton className=\"h-[600px] w-full\" />\n    </div>\n  );\n});\n\nconst ErrorDisplay = memo(function ErrorDisplay({ \n  error, \n  onRetry \n}: { \n  error: string; \n  onRetry?: () => void;\n}) {\n  return (\n    <Alert variant=\"destructive\" data-testid=\"document-preview-error\">\n      <AlertCircle className=\"h-4 w-4\" />\n      <AlertTitle>Failed to load document</AlertTitle>\n      <AlertDescription className=\"flex flex-col gap-2\">\n        <span>{error}</span>\n        {onRetry && (\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            onClick={onRetry}\n            data-testid=\"button-retry-load\"\n            className=\"w-fit\"\n          >\n            <RotateCw className=\"h-4 w-4 mr-2\" />\n            Retry\n          </Button>\n        )}\n      </AlertDescription>\n    </Alert>\n  );\n});\n\nconst getDocumentIcon = (type: DocumentType) => {\n  switch (type) {\n    case \"pdf\":\n      return <FileText className=\"h-12 w-12 text-red-500\" />;\n    case \"docx\":\n      return <FileText className=\"h-12 w-12 text-blue-500\" />;\n    case \"xlsx\":\n      return <FileSpreadsheet className=\"h-12 w-12 text-green-500\" />;\n    case \"pptx\":\n      return <Presentation className=\"h-12 w-12 text-orange-500\" />;\n  }\n};\n\nconst getDocumentLabel = (type: DocumentType) => {\n  switch (type) {\n    case \"pdf\":\n      return \"PDF Document\";\n    case \"docx\":\n      return \"Word Document\";\n    case \"xlsx\":\n      return \"Excel Spreadsheet\";\n    case \"pptx\":\n      return \"PowerPoint Presentation\";\n  }\n};\n\nconst OfficeDocumentPreview = memo(function OfficeDocumentPreview({\n  url,\n  type,\n  title,\n}: Omit<DocumentPreviewProps, \"className\">) {\n  return (\n    <Card data-testid=\"document-preview-office\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          {getDocumentIcon(type)}\n          <span>{title || getDocumentLabel(type)}</span>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"flex flex-col items-center gap-4 py-8\">\n          <p className=\"text-muted-foreground text-center\">\n            Preview is not available for {getDocumentLabel(type)} files.\n            <br />\n            Download the file to view its contents.\n          </p>\n          <Button asChild data-testid=\"button-download-document\">\n            <a href={url} download target=\"_blank\" rel=\"noopener noreferrer\">\n              <Download className=\"h-4 w-4 mr-2\" />\n              Download {title || getDocumentLabel(type)}\n            </a>\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n});\n\nconst PDFViewer = memo(function PDFViewer({\n  url,\n  title,\n}: Omit<DocumentPreviewProps, \"type\" | \"className\">) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const pdfDocRef = useRef<any>(null);\n  const pdfjsLibRef = useRef<any>(null);\n\n  const [state, setState] = useState<PDFViewerState>({\n    loading: true,\n    error: null,\n    numPages: 0,\n    currentPage: 1,\n    scale: DEFAULT_ZOOM,\n  });\n\n  const loadPdfJs = useCallback(async () => {\n    if (pdfjsLibRef.current) return pdfjsLibRef.current;\n\n    try {\n      const pdfjsLib = await import(/* @vite-ignore */ PDFJS_CDN_URL);\n      pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_URL;\n      pdfjsLibRef.current = pdfjsLib;\n      return pdfjsLib;\n    } catch (err) {\n      throw new Error(\"Failed to load PDF.js library\");\n    }\n  }, []);\n\n  const loadDocument = useCallback(async () => {\n    setState(prev => ({ ...prev, loading: true, error: null }));\n\n    try {\n      const pdfjsLib = await loadPdfJs();\n      const loadingTask = pdfjsLib.getDocument(url);\n      const pdf = await loadingTask.promise;\n      pdfDocRef.current = pdf;\n\n      setState(prev => ({\n        ...prev,\n        loading: false,\n        numPages: pdf.numPages,\n        currentPage: 1,\n      }));\n    } catch (err) {\n      setState(prev => ({\n        ...prev,\n        loading: false,\n        error: err instanceof Error ? err.message : \"Failed to load PDF document\",\n      }));\n    }\n  }, [url, loadPdfJs]);\n\n  const renderPage = useCallback(async (pageNum: number, scale: number) => {\n    if (!pdfDocRef.current || !canvasRef.current) return;\n\n    try {\n      const page = await pdfDocRef.current.getPage(pageNum);\n      const viewport = page.getViewport({ scale });\n      const canvas = canvasRef.current;\n      const context = canvas.getContext(\"2d\");\n\n      if (!context) return;\n\n      canvas.height = viewport.height;\n      canvas.width = viewport.width;\n\n      await page.render({\n        canvasContext: context,\n        viewport,\n      }).promise;\n    } catch (err) {\n      console.error(\"Failed to render page:\", err);\n    }\n  }, []);\n\n  useEffect(() => {\n    loadDocument();\n    return () => {\n      if (pdfDocRef.current) {\n        pdfDocRef.current.destroy();\n        pdfDocRef.current = null;\n      }\n    };\n  }, [loadDocument]);\n\n  useEffect(() => {\n    if (!state.loading && !state.error && state.numPages > 0) {\n      renderPage(state.currentPage, state.scale);\n    }\n  }, [state.currentPage, state.scale, state.loading, state.error, state.numPages, renderPage]);\n\n  const goToPage = useCallback((page: number) => {\n    if (page >= 1 && page <= state.numPages) {\n      setState(prev => ({ ...prev, currentPage: page }));\n    }\n  }, [state.numPages]);\n\n  const zoomIn = useCallback(() => {\n    const currentIndex = ZOOM_LEVELS.findIndex(z => z >= state.scale);\n    const nextIndex = Math.min(currentIndex + 1, ZOOM_LEVELS.length - 1);\n    setState(prev => ({ ...prev, scale: ZOOM_LEVELS[nextIndex] }));\n  }, [state.scale]);\n\n  const zoomOut = useCallback(() => {\n    const currentIndex = ZOOM_LEVELS.findIndex(z => z >= state.scale);\n    const prevIndex = Math.max(currentIndex - 1, 0);\n    setState(prev => ({ ...prev, scale: ZOOM_LEVELS[prevIndex] }));\n  }, [state.scale]);\n\n  const resetZoom = useCallback(() => {\n    setState(prev => ({ ...prev, scale: DEFAULT_ZOOM }));\n  }, []);\n\n  if (state.loading) {\n    return <LoadingSkeleton />;\n  }\n\n  if (state.error) {\n    return <ErrorDisplay error={state.error} onRetry={loadDocument} />;\n  }\n\n  return (\n    <div className=\"flex flex-col gap-4\" data-testid=\"document-preview-pdf\">\n      {title && (\n        <h3 className=\"text-lg font-semibold\" data-testid=\"text-document-title\">\n          {title}\n        </h3>\n      )}\n\n      <div className=\"flex flex-wrap items-center justify-between gap-2 p-2 bg-muted rounded-lg\">\n        <div className=\"flex items-center gap-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => goToPage(state.currentPage - 1)}\n            disabled={state.currentPage <= 1}\n            data-testid=\"button-prev-page\"\n            aria-label=\"Previous page\"\n          >\n            <ChevronLeft className=\"h-4 w-4\" />\n          </Button>\n          <span className=\"text-sm px-2\" data-testid=\"text-page-info\">\n            Page {state.currentPage} of {state.numPages}\n          </span>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => goToPage(state.currentPage + 1)}\n            disabled={state.currentPage >= state.numPages}\n            data-testid=\"button-next-page\"\n            aria-label=\"Next page\"\n          >\n            <ChevronRight className=\"h-4 w-4\" />\n          </Button>\n        </div>\n\n        <div className=\"flex items-center gap-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={zoomOut}\n            disabled={state.scale <= ZOOM_LEVELS[0]}\n            data-testid=\"button-zoom-out\"\n            aria-label=\"Zoom out\"\n          >\n            <ZoomOut className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={resetZoom}\n            data-testid=\"button-zoom-reset\"\n            aria-label=\"Reset zoom\"\n          >\n            {Math.round(state.scale * 100)}%\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={zoomIn}\n            disabled={state.scale >= ZOOM_LEVELS[ZOOM_LEVELS.length - 1]}\n            data-testid=\"button-zoom-in\"\n            aria-label=\"Zoom in\"\n          >\n            <ZoomIn className=\"h-4 w-4\" />\n          </Button>\n        </div>\n\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          asChild\n          data-testid=\"button-download-pdf\"\n        >\n          <a href={url} download target=\"_blank\" rel=\"noopener noreferrer\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Download\n          </a>\n        </Button>\n      </div>\n\n      <div\n        ref={containerRef}\n        className=\"overflow-auto border rounded-lg bg-muted/50 max-h-[800px]\"\n        data-testid=\"pdf-canvas-container\"\n      >\n        <div className=\"flex justify-center p-4\">\n          <canvas\n            ref={canvasRef}\n            className=\"shadow-lg bg-white\"\n            data-testid=\"pdf-canvas\"\n          />\n        </div>\n      </div>\n    </div>\n  );\n});\n\nexport const DocumentPreview = memo(function DocumentPreview({\n  url,\n  type,\n  title,\n  className,\n}: DocumentPreviewProps) {\n  if (!url) {\n    return (\n      <ErrorDisplay error=\"No document URL provided\" />\n    );\n  }\n\n  return (\n    <div className={cn(\"w-full\", className)} data-testid=\"document-preview\">\n      {type === \"pdf\" ? (\n        <PDFViewer url={url} title={title} />\n      ) : (\n        <OfficeDocumentPreview url={url} type={type} title={title} />\n      )}\n    </div>\n  );\n});\n\nexport default DocumentPreview;\n","path":null,"size_bytes":10896,"size_tokens":null},"client/src/components/code-annotation-tooltip.tsx":{"content":"import { useState, useCallback } from \"react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { cn } from \"@/lib/utils\";\nimport { Pencil, Trash2, Check, X, Info, AlertTriangle, AlertCircle, Lightbulb } from \"lucide-react\";\nimport type { CodeAnnotation } from \"@/hooks/useCodeAnnotations\";\n\nexport interface CodeAnnotationTooltipProps {\n  annotation: CodeAnnotation;\n  onEdit?: (id: string, content: string) => void;\n  onDelete?: (id: string) => void;\n  trigger: React.ReactNode;\n  side?: 'top' | 'right' | 'bottom' | 'left';\n}\n\nconst typeStyles = {\n  info: {\n    bg: \"bg-blue-500/10\",\n    border: \"border-blue-500/30\",\n    text: \"text-blue-400\",\n    icon: Info,\n    label: \"Info\",\n  },\n  warning: {\n    bg: \"bg-amber-500/10\",\n    border: \"border-amber-500/30\",\n    text: \"text-amber-400\",\n    icon: AlertTriangle,\n    label: \"Warning\",\n  },\n  error: {\n    bg: \"bg-red-500/10\",\n    border: \"border-red-500/30\",\n    text: \"text-red-400\",\n    icon: AlertCircle,\n    label: \"Error\",\n  },\n  explanation: {\n    bg: \"bg-emerald-500/10\",\n    border: \"border-emerald-500/30\",\n    text: \"text-emerald-400\",\n    icon: Lightbulb,\n    label: \"Explanation\",\n  },\n};\n\nexport function CodeAnnotationTooltip({\n  annotation,\n  onEdit,\n  onDelete,\n  trigger,\n  side = 'right',\n}: CodeAnnotationTooltipProps) {\n  const [isEditing, setIsEditing] = useState(false);\n  const [editContent, setEditContent] = useState(annotation.content);\n  const [open, setOpen] = useState(false);\n\n  const style = typeStyles[annotation.type];\n  const Icon = style.icon;\n\n  const handleStartEdit = useCallback(() => {\n    setEditContent(annotation.content);\n    setIsEditing(true);\n  }, [annotation.content]);\n\n  const handleCancelEdit = useCallback(() => {\n    setEditContent(annotation.content);\n    setIsEditing(false);\n  }, [annotation.content]);\n\n  const handleSaveEdit = useCallback(() => {\n    if (onEdit && editContent.trim()) {\n      onEdit(annotation.id, editContent.trim());\n    }\n    setIsEditing(false);\n  }, [onEdit, annotation.id, editContent]);\n\n  const handleDelete = useCallback(() => {\n    if (onDelete) {\n      onDelete(annotation.id);\n    }\n    setOpen(false);\n  }, [onDelete, annotation.id]);\n\n  return (\n    <Popover open={open} onOpenChange={setOpen}>\n      <PopoverTrigger asChild data-testid={`annotation-trigger-${annotation.id}`}>\n        {trigger}\n      </PopoverTrigger>\n      <PopoverContent\n        side={side}\n        className={cn(\n          \"w-80 p-0 border\",\n          style.border,\n          \"bg-zinc-900\"\n        )}\n        data-testid={`annotation-tooltip-${annotation.id}`}\n      >\n        <div className={cn(\"px-3 py-2 border-b flex items-center gap-2\", style.border, style.bg)}>\n          <Icon className={cn(\"w-4 h-4\", style.text)} />\n          <span className={cn(\"text-xs font-medium\", style.text)}>\n            {style.label}\n          </span>\n          <span className=\"text-xs text-zinc-500 ml-auto\">\n            Line {annotation.line}\n          </span>\n        </div>\n\n        <div className=\"p-3\">\n          {isEditing ? (\n            <div className=\"space-y-2\">\n              <Textarea\n                value={editContent}\n                onChange={(e) => setEditContent(e.target.value)}\n                className=\"min-h-[80px] text-sm bg-zinc-800 border-zinc-700 resize-none\"\n                placeholder=\"Enter annotation...\"\n                autoFocus\n                data-testid={`annotation-edit-textarea-${annotation.id}`}\n              />\n              <div className=\"flex justify-end gap-1\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleCancelEdit}\n                  className=\"h-7 px-2 text-zinc-400 hover:text-white\"\n                  data-testid={`annotation-cancel-edit-${annotation.id}`}\n                >\n                  <X className=\"w-3.5 h-3.5 mr-1\" />\n                  Cancel\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleSaveEdit}\n                  className={cn(\"h-7 px-2\", style.text, \"hover:bg-zinc-800\")}\n                  data-testid={`annotation-save-edit-${annotation.id}`}\n                >\n                  <Check className=\"w-3.5 h-3.5 mr-1\" />\n                  Save\n                </Button>\n              </div>\n            </div>\n          ) : (\n            <>\n              <p\n                className=\"text-sm text-zinc-300 whitespace-pre-wrap\"\n                data-testid={`annotation-content-${annotation.id}`}\n              >\n                {annotation.content}\n              </p>\n              <div className=\"flex justify-end gap-1 mt-3 pt-2 border-t border-zinc-800\">\n                {onEdit && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleStartEdit}\n                    className=\"h-7 px-2 text-zinc-400 hover:text-white hover:bg-zinc-800\"\n                    data-testid={`annotation-edit-button-${annotation.id}`}\n                  >\n                    <Pencil className=\"w-3.5 h-3.5 mr-1\" />\n                    Edit\n                  </Button>\n                )}\n                {onDelete && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleDelete}\n                    className=\"h-7 px-2 text-red-400 hover:text-red-300 hover:bg-red-500/10\"\n                    data-testid={`annotation-delete-button-${annotation.id}`}\n                  >\n                    <Trash2 className=\"w-3.5 h-3.5 mr-1\" />\n                    Delete\n                  </Button>\n                )}\n              </div>\n            </>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\nexport default CodeAnnotationTooltip;\n","path":null,"size_bytes":5966,"size_tokens":null},"client/src/components/charts/recharts-chart.tsx":{"content":"import { useRef, useState, useCallback, useMemo } from 'react';\nimport {\n  ResponsiveContainer,\n  BarChart,\n  Bar,\n  LineChart,\n  Line,\n  AreaChart,\n  Area,\n  PieChart,\n  Pie,\n  Cell,\n  ScatterChart,\n  Scatter,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ReferenceArea,\n  TooltipProps,\n} from 'recharts';\nimport { Download, Image, FileCode, ZoomIn, ZoomOut, RotateCcw } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport type { ChartConfig, DataPoint } from '@shared/schemas/visualization';\n\nexport interface RechartsChartProps {\n  config: ChartConfig;\n  className?: string;\n  onDataClick?: (data: any) => void;\n}\n\nexport function getDefaultColors(): string[] {\n  return [\n    '#3b82f6', // blue-500\n    '#10b981', // emerald-500\n    '#f59e0b', // amber-500\n    '#ef4444', // red-500\n    '#8b5cf6', // violet-500\n    '#ec4899', // pink-500\n    '#06b6d4', // cyan-500\n    '#84cc16', // lime-500\n    '#f97316', // orange-500\n    '#6366f1', // indigo-500\n  ];\n}\n\nexport async function exportChartAsPNG(elementRef: React.RefObject<HTMLDivElement | null>): Promise<void> {\n  if (!elementRef.current) return;\n\n  const svgElement = elementRef.current.querySelector('svg');\n  if (!svgElement) return;\n\n  const svgData = new XMLSerializer().serializeToString(svgElement);\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n  if (!ctx) return;\n\n  const img = new window.Image();\n  const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });\n  const url = URL.createObjectURL(svgBlob);\n\n  return new Promise((resolve, reject) => {\n    img.onload = () => {\n      canvas.width = img.width * 2;\n      canvas.height = img.height * 2;\n      ctx.scale(2, 2);\n      ctx.fillStyle = '#ffffff';\n      ctx.fillRect(0, 0, canvas.width, canvas.height);\n      ctx.drawImage(img, 0, 0);\n      URL.revokeObjectURL(url);\n\n      canvas.toBlob((blob) => {\n        if (blob) {\n          const link = document.createElement('a');\n          link.download = `chart-${Date.now()}.png`;\n          link.href = URL.createObjectURL(blob);\n          link.click();\n          URL.revokeObjectURL(link.href);\n        }\n        resolve();\n      }, 'image/png');\n    };\n    img.onerror = reject;\n    img.src = url;\n  });\n}\n\nexport function exportChartAsSVG(elementRef: React.RefObject<HTMLDivElement | null>): void {\n  if (!elementRef.current) return;\n\n  const svgElement = elementRef.current.querySelector('svg');\n  if (!svgElement) return;\n\n  const svgClone = svgElement.cloneNode(true) as SVGElement;\n  svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n  \n  const svgData = new XMLSerializer().serializeToString(svgClone);\n  const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });\n  const url = URL.createObjectURL(blob);\n  \n  const link = document.createElement('a');\n  link.download = `chart-${Date.now()}.svg`;\n  link.href = url;\n  link.click();\n  URL.revokeObjectURL(url);\n}\n\ninterface CustomTooltipProps extends TooltipProps<number, string> {\n  colors?: string[];\n}\n\nfunction CustomTooltip({ active, payload, label, colors = [] }: CustomTooltipProps) {\n  if (!active || !payload || !payload.length) return null;\n\n  return (\n    <div className=\"bg-popover border border-border rounded-lg shadow-lg p-3 min-w-[120px]\" data-testid=\"chart-tooltip\">\n      {label && <p className=\"text-sm font-medium text-foreground mb-2\">{label}</p>}\n      <div className=\"space-y-1\">\n        {payload.map((entry, index) => (\n          <div key={index} className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <div\n                className=\"w-3 h-3 rounded-full\"\n                style={{ backgroundColor: entry.color || colors[index] || getDefaultColors()[index] }}\n              />\n              <span className=\"text-xs text-muted-foreground\">{entry.name || entry.dataKey}</span>\n            </div>\n            <span className=\"text-sm font-medium text-foreground\">\n              {typeof entry.value === 'number' ? entry.value.toLocaleString() : entry.value}\n            </span>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\ninterface ZoomState {\n  refAreaLeft: string | number | null;\n  refAreaRight: string | number | null;\n  left: string | number | 'dataMin';\n  right: string | number | 'dataMax';\n  top: string | number | 'dataMax+10%';\n  bottom: string | number | 'dataMin-10%';\n}\n\nconst initialZoomState: ZoomState = {\n  refAreaLeft: null,\n  refAreaRight: null,\n  left: 'dataMin',\n  right: 'dataMax',\n  top: 'dataMax+10%',\n  bottom: 'dataMin-10%',\n};\n\nexport function RechartsChart({ config, className, onDataClick }: RechartsChartProps) {\n  const chartRef = useRef<HTMLDivElement>(null);\n  const [zoomState, setZoomState] = useState<ZoomState>(initialZoomState);\n  const [isZooming, setIsZooming] = useState(false);\n\n  const {\n    type,\n    title,\n    subtitle,\n    data,\n    xAxisKey = 'label',\n    yAxisKey = 'value',\n    colors = getDefaultColors(),\n    showLegend = true,\n    showGrid = true,\n    showTooltip = true,\n    enableZoom = false,\n    enableExport = true,\n    height = 400,\n  } = config;\n\n  const chartData = useMemo(() => {\n    return data.map((item: any, index: number) => ({\n      ...item,\n      name: item.label || item.name || `Item ${index + 1}`,\n    }));\n  }, [data]);\n\n  const uniqueKeys = useMemo(() => {\n    if (!chartData.length) return [yAxisKey];\n    const firstItem = chartData[0];\n    const keys = Object.keys(firstItem).filter(\n      (key) => typeof firstItem[key] === 'number' && key !== 'lat' && key !== 'lng'\n    );\n    return keys.length ? keys : [yAxisKey];\n  }, [chartData, yAxisKey]);\n\n  const handleMouseDown = useCallback((e: any) => {\n    if (!enableZoom || !e) return;\n    setZoomState((prev) => ({ ...prev, refAreaLeft: e.activeLabel }));\n    setIsZooming(true);\n  }, [enableZoom]);\n\n  const handleMouseMove = useCallback((e: any) => {\n    if (!isZooming || !e) return;\n    setZoomState((prev) => ({ ...prev, refAreaRight: e.activeLabel }));\n  }, [isZooming]);\n\n  const handleMouseUp = useCallback(() => {\n    if (!isZooming) return;\n    setIsZooming(false);\n\n    const { refAreaLeft, refAreaRight } = zoomState;\n    if (refAreaLeft === refAreaRight || refAreaRight === null) {\n      setZoomState((prev) => ({ ...prev, refAreaLeft: null, refAreaRight: null }));\n      return;\n    }\n\n    let left = refAreaLeft;\n    let right = refAreaRight;\n    if (typeof left === 'string' && typeof right === 'string' && left > right) {\n      [left, right] = [right, left];\n    }\n\n    setZoomState({\n      refAreaLeft: null,\n      refAreaRight: null,\n      left: left as string,\n      right: right as string,\n      top: 'dataMax+10%',\n      bottom: 'dataMin-10%',\n    });\n  }, [isZooming, zoomState]);\n\n  const handleZoomReset = useCallback(() => {\n    setZoomState(initialZoomState);\n  }, []);\n\n  const handleDataClick = useCallback((data: any) => {\n    if (onDataClick && data?.payload) {\n      onDataClick(data.payload);\n    }\n  }, [onDataClick]);\n\n  const handleExportPNG = useCallback(async () => {\n    await exportChartAsPNG(chartRef);\n  }, []);\n\n  const handleExportSVG = useCallback(() => {\n    exportChartAsSVG(chartRef);\n  }, []);\n\n  const commonCartesianProps = {\n    data: chartData,\n    margin: { top: 20, right: 30, left: 20, bottom: 20 },\n    onMouseDown: enableZoom ? handleMouseDown : undefined,\n    onMouseMove: enableZoom ? handleMouseMove : undefined,\n    onMouseUp: enableZoom ? handleMouseUp : undefined,\n  };\n\n  const renderCartesianChart = () => {\n    const xDomain = enableZoom ? [zoomState.left, zoomState.right] as [string, string] : undefined;\n    const yDomain = enableZoom ? [zoomState.bottom, zoomState.top] as [string, string] : undefined;\n\n    switch (type) {\n      case 'bar':\n        return (\n          <BarChart {...commonCartesianProps}>\n            {showGrid && <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />}\n            <XAxis dataKey={xAxisKey} className=\"text-xs\" domain={xDomain} allowDataOverflow={enableZoom} />\n            <YAxis className=\"text-xs\" domain={yDomain} allowDataOverflow={enableZoom} />\n            {showTooltip && <Tooltip content={<CustomTooltip colors={colors} />} />}\n            {showLegend && <Legend />}\n            {uniqueKeys.map((key, index) => (\n              <Bar\n                key={key}\n                dataKey={key}\n                fill={colors[index % colors.length]}\n                radius={[4, 4, 0, 0]}\n                onClick={handleDataClick}\n                cursor={onDataClick ? 'pointer' : 'default'}\n              />\n            ))}\n            {enableZoom && zoomState.refAreaLeft && zoomState.refAreaRight && (\n              <ReferenceArea\n                x1={zoomState.refAreaLeft}\n                x2={zoomState.refAreaRight}\n                strokeOpacity={0.3}\n                fill=\"hsl(var(--primary))\"\n                fillOpacity={0.1}\n              />\n            )}\n          </BarChart>\n        );\n\n      case 'line':\n        return (\n          <LineChart {...commonCartesianProps}>\n            {showGrid && <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />}\n            <XAxis dataKey={xAxisKey} className=\"text-xs\" domain={xDomain} allowDataOverflow={enableZoom} />\n            <YAxis className=\"text-xs\" domain={yDomain} allowDataOverflow={enableZoom} />\n            {showTooltip && <Tooltip content={<CustomTooltip colors={colors} />} />}\n            {showLegend && <Legend />}\n            {uniqueKeys.map((key, index) => (\n              <Line\n                key={key}\n                type=\"monotone\"\n                dataKey={key}\n                stroke={colors[index % colors.length]}\n                strokeWidth={2}\n                dot={{ r: 4, fill: colors[index % colors.length] }}\n                activeDot={{ r: 6, onClick: handleDataClick }}\n              />\n            ))}\n            {enableZoom && zoomState.refAreaLeft && zoomState.refAreaRight && (\n              <ReferenceArea\n                x1={zoomState.refAreaLeft}\n                x2={zoomState.refAreaRight}\n                strokeOpacity={0.3}\n                fill=\"hsl(var(--primary))\"\n                fillOpacity={0.1}\n              />\n            )}\n          </LineChart>\n        );\n\n      case 'area':\n        return (\n          <AreaChart {...commonCartesianProps}>\n            <defs>\n              {uniqueKeys.map((key, index) => (\n                <linearGradient key={key} id={`gradient-${key}`} x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                  <stop offset=\"5%\" stopColor={colors[index % colors.length]} stopOpacity={0.8} />\n                  <stop offset=\"95%\" stopColor={colors[index % colors.length]} stopOpacity={0.1} />\n                </linearGradient>\n              ))}\n            </defs>\n            {showGrid && <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />}\n            <XAxis dataKey={xAxisKey} className=\"text-xs\" domain={xDomain} allowDataOverflow={enableZoom} />\n            <YAxis className=\"text-xs\" domain={yDomain} allowDataOverflow={enableZoom} />\n            {showTooltip && <Tooltip content={<CustomTooltip colors={colors} />} />}\n            {showLegend && <Legend />}\n            {uniqueKeys.map((key, index) => (\n              <Area\n                key={key}\n                type=\"monotone\"\n                dataKey={key}\n                stroke={colors[index % colors.length]}\n                strokeWidth={2}\n                fill={`url(#gradient-${key})`}\n                onClick={handleDataClick}\n              />\n            ))}\n            {enableZoom && zoomState.refAreaLeft && zoomState.refAreaRight && (\n              <ReferenceArea\n                x1={zoomState.refAreaLeft}\n                x2={zoomState.refAreaRight}\n                strokeOpacity={0.3}\n                fill=\"hsl(var(--primary))\"\n                fillOpacity={0.1}\n              />\n            )}\n          </AreaChart>\n        );\n\n      case 'scatter':\n        return (\n          <ScatterChart {...commonCartesianProps}>\n            {showGrid && <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />}\n            <XAxis type=\"number\" dataKey={xAxisKey} className=\"text-xs\" name={xAxisKey} domain={xDomain} allowDataOverflow={enableZoom} />\n            <YAxis type=\"number\" dataKey={yAxisKey} className=\"text-xs\" name={yAxisKey} domain={yDomain} allowDataOverflow={enableZoom} />\n            {showTooltip && <Tooltip content={<CustomTooltip colors={colors} />} cursor={{ strokeDasharray: '3 3' }} />}\n            {showLegend && <Legend />}\n            <Scatter\n              name=\"Data\"\n              data={chartData}\n              fill={colors[0]}\n              onClick={handleDataClick}\n              cursor={onDataClick ? 'pointer' : 'default'}\n            />\n            {enableZoom && zoomState.refAreaLeft && zoomState.refAreaRight && (\n              <ReferenceArea\n                x1={zoomState.refAreaLeft}\n                x2={zoomState.refAreaRight}\n                strokeOpacity={0.3}\n                fill=\"hsl(var(--primary))\"\n                fillOpacity={0.1}\n              />\n            )}\n          </ScatterChart>\n        );\n\n      default:\n        return null;\n    }\n  };\n\n  const renderPieChart = () => {\n    const isDonut = type === 'donut';\n    const innerRadius = isDonut ? '60%' : 0;\n    const outerRadius = '80%';\n\n    return (\n      <PieChart>\n        <Pie\n          data={chartData}\n          dataKey={yAxisKey}\n          nameKey={xAxisKey}\n          cx=\"50%\"\n          cy=\"50%\"\n          innerRadius={innerRadius}\n          outerRadius={outerRadius}\n          paddingAngle={2}\n          onClick={handleDataClick}\n          cursor={onDataClick ? 'pointer' : 'default'}\n          label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}\n          labelLine={{ stroke: 'hsl(var(--muted-foreground))' }}\n        >\n          {chartData.map((_, index) => (\n            <Cell key={`cell-${index}`} fill={colors[index % colors.length]} />\n          ))}\n        </Pie>\n        {showTooltip && <Tooltip content={<CustomTooltip colors={colors} />} />}\n        {showLegend && <Legend />}\n      </PieChart>\n    );\n  };\n\n  const renderChart = () => {\n    if (type === 'pie' || type === 'donut') {\n      return renderPieChart();\n    }\n    return renderCartesianChart();\n  };\n\n  const chartHeight = typeof height === 'number' ? height : parseInt(height as string, 10) || 400;\n\n  return (\n    <div className={cn('w-full', className)} data-testid=\"recharts-chart\">\n      {(title || subtitle || enableExport || enableZoom) && (\n        <div className=\"flex items-start justify-between mb-4\">\n          <div>\n            {title && <h3 className=\"text-lg font-semibold text-foreground\" data-testid=\"chart-title\">{title}</h3>}\n            {subtitle && <p className=\"text-sm text-muted-foreground\" data-testid=\"chart-subtitle\">{subtitle}</p>}\n          </div>\n          <div className=\"flex items-center gap-1\">\n            {enableZoom && (zoomState.left !== 'dataMin' || zoomState.right !== 'dataMax') && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleZoomReset}\n                className=\"h-8 w-8 p-0\"\n                data-testid=\"button-zoom-reset\"\n              >\n                <RotateCcw className=\"h-4 w-4\" />\n              </Button>\n            )}\n            {enableExport && (\n              <>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleExportPNG}\n                  className=\"h-8 w-8 p-0\"\n                  data-testid=\"button-export-png\"\n                >\n                  <Image className=\"h-4 w-4\" />\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleExportSVG}\n                  className=\"h-8 w-8 p-0\"\n                  data-testid=\"button-export-svg\"\n                >\n                  <FileCode className=\"h-4 w-4\" />\n                </Button>\n              </>\n            )}\n          </div>\n        </div>\n      )}\n      \n      <div ref={chartRef} className=\"w-full\" style={{ height: chartHeight }} data-testid=\"chart-container\">\n        <ResponsiveContainer width=\"100%\" height=\"100%\">\n          {renderChart() as React.ReactElement}\n        </ResponsiveContainer>\n      </div>\n      \n      {enableZoom && type !== 'pie' && type !== 'donut' && (\n        <p className=\"text-xs text-muted-foreground mt-2 text-center\" data-testid=\"zoom-hint\">\n          Click and drag to zoom. Click reset to restore original view.\n        </p>\n      )}\n    </div>\n  );\n}\n\nexport type { ChartConfig, DataPoint };\n","path":null,"size_bytes":16735,"size_tokens":null},"server/services/pistonService.ts":{"content":"import * as codeInterpreter from \"./codeInterpreterService\";\n\nconst PISTON_API_URL = \"https://emkc.org/api/v2/piston\";\nconst EXECUTION_TIMEOUT_MS = 30000;\nconst MEMORY_LIMIT_BYTES = 128 * 1024 * 1024;\nconst MAX_RETRIES = 1;\n\nexport interface PistonExecuteRequest {\n  language: string;\n  version: string;\n  files: Array<{ name?: string; content: string }>;\n  stdin?: string;\n  args?: string[];\n  compile_timeout?: number;\n  run_timeout?: number;\n  compile_memory_limit?: number;\n  run_memory_limit?: number;\n}\n\nexport interface PistonRunResult {\n  stdout: string;\n  stderr: string;\n  code: number;\n  signal: string | null;\n  output: string;\n}\n\nexport interface PistonExecuteResponse {\n  language: string;\n  version: string;\n  run: PistonRunResult;\n  compile?: PistonRunResult;\n}\n\nexport interface PistonRuntime {\n  language: string;\n  version: string;\n  aliases: string[];\n  runtime?: string;\n}\n\nexport interface ErrorLine {\n  line: number;\n  column?: number;\n  message?: string;\n}\n\nexport interface ExecuteResult {\n  run: PistonRunResult;\n  compile?: PistonRunResult;\n  errorLines: ErrorLine[];\n  language: string;\n  version: string;\n  usedFallback?: boolean;\n  artifacts?: Array<{\n    type: string;\n    name: string;\n    data: string;\n    mimeType: string;\n  }>;\n}\n\ninterface LanguageConfig {\n  language: string;\n  version: string;\n  filename?: string;\n}\n\nexport const LANGUAGE_MAP: Record<string, LanguageConfig> = {\n  javascript: { language: \"javascript\", version: \"*\", filename: \"main.js\" },\n  js: { language: \"javascript\", version: \"*\", filename: \"main.js\" },\n  typescript: { language: \"typescript\", version: \"*\", filename: \"main.ts\" },\n  ts: { language: \"typescript\", version: \"*\", filename: \"main.ts\" },\n  python: { language: \"python\", version: \"3\", filename: \"main.py\" },\n  py: { language: \"python\", version: \"3\", filename: \"main.py\" },\n  python3: { language: \"python\", version: \"3\", filename: \"main.py\" },\n  go: { language: \"go\", version: \"*\", filename: \"main.go\" },\n  golang: { language: \"go\", version: \"*\", filename: \"main.go\" },\n  rust: { language: \"rust\", version: \"*\", filename: \"main.rs\" },\n  rs: { language: \"rust\", version: \"*\", filename: \"main.rs\" },\n  c: { language: \"c\", version: \"*\", filename: \"main.c\" },\n  cpp: { language: \"c++\", version: \"*\", filename: \"main.cpp\" },\n  \"c++\": { language: \"c++\", version: \"*\", filename: \"main.cpp\" },\n  java: { language: \"java\", version: \"*\", filename: \"Main.java\" },\n  ruby: { language: \"ruby\", version: \"*\", filename: \"main.rb\" },\n  rb: { language: \"ruby\", version: \"*\", filename: \"main.rb\" },\n  php: { language: \"php\", version: \"*\", filename: \"main.php\" },\n  swift: { language: \"swift\", version: \"*\", filename: \"main.swift\" },\n  kotlin: { language: \"kotlin\", version: \"*\", filename: \"Main.kt\" },\n  kt: { language: \"kotlin\", version: \"*\", filename: \"Main.kt\" },\n  scala: { language: \"scala\", version: \"*\", filename: \"Main.scala\" },\n  csharp: { language: \"csharp\", version: \"*\", filename: \"Main.cs\" },\n  cs: { language: \"csharp\", version: \"*\", filename: \"Main.cs\" },\n  \"c#\": { language: \"csharp\", version: \"*\", filename: \"Main.cs\" },\n  bash: { language: \"bash\", version: \"*\", filename: \"main.sh\" },\n  sh: { language: \"bash\", version: \"*\", filename: \"main.sh\" },\n  perl: { language: \"perl\", version: \"*\", filename: \"main.pl\" },\n  lua: { language: \"lua\", version: \"*\", filename: \"main.lua\" },\n  r: { language: \"r\", version: \"*\", filename: \"main.r\" },\n  haskell: { language: \"haskell\", version: \"*\", filename: \"main.hs\" },\n  hs: { language: \"haskell\", version: \"*\", filename: \"main.hs\" },\n  elixir: { language: \"elixir\", version: \"*\", filename: \"main.exs\" },\n  ex: { language: \"elixir\", version: \"*\", filename: \"main.exs\" },\n  clojure: { language: \"clojure\", version: \"*\", filename: \"main.clj\" },\n  clj: { language: \"clojure\", version: \"*\", filename: \"main.clj\" },\n  fsharp: { language: \"fsharp\", version: \"*\", filename: \"Main.fs\" },\n  \"f#\": { language: \"fsharp\", version: \"*\", filename: \"Main.fs\" },\n  ocaml: { language: \"ocaml\", version: \"*\", filename: \"main.ml\" },\n  ml: { language: \"ocaml\", version: \"*\", filename: \"main.ml\" },\n  dart: { language: \"dart\", version: \"*\", filename: \"main.dart\" },\n  julia: { language: \"julia\", version: \"*\", filename: \"main.jl\" },\n  jl: { language: \"julia\", version: \"*\", filename: \"main.jl\" },\n  nim: { language: \"nim\", version: \"*\", filename: \"main.nim\" },\n  zig: { language: \"zig\", version: \"*\", filename: \"main.zig\" },\n  crystal: { language: \"crystal\", version: \"*\", filename: \"main.cr\" },\n  d: { language: \"d\", version: \"*\", filename: \"main.d\" },\n  erlang: { language: \"erlang\", version: \"*\", filename: \"main.erl\" },\n  fortran: { language: \"fortran\", version: \"*\", filename: \"main.f90\" },\n  pascal: { language: \"pascal\", version: \"*\", filename: \"main.pas\" },\n  prolog: { language: \"prolog\", version: \"*\", filename: \"main.pl\" },\n  racket: { language: \"racket\", version: \"*\", filename: \"main.rkt\" },\n  scheme: { language: \"scheme\", version: \"*\", filename: \"main.scm\" },\n  sql: { language: \"sqlite3\", version: \"*\", filename: \"main.sql\" },\n  sqlite: { language: \"sqlite3\", version: \"*\", filename: \"main.sql\" },\n  cobol: { language: \"cobol\", version: \"*\", filename: \"main.cob\" },\n  awk: { language: \"awk\", version: \"*\", filename: \"main.awk\" },\n  brainfuck: { language: \"brainfuck\", version: \"*\", filename: \"main.bf\" },\n  bf: { language: \"brainfuck\", version: \"*\", filename: \"main.bf\" },\n  lisp: { language: \"lisp\", version: \"*\", filename: \"main.lisp\" },\n  commonlisp: { language: \"lisp\", version: \"*\", filename: \"main.lisp\" },\n  powershell: { language: \"powershell\", version: \"*\", filename: \"main.ps1\" },\n  ps1: { language: \"powershell\", version: \"*\", filename: \"main.ps1\" },\n};\n\nlet cachedRuntimes: PistonRuntime[] | null = null;\nlet runtimesCacheTime: number = 0;\nconst CACHE_TTL_MS = 5 * 60 * 1000;\n\nasync function fetchWithRetry(\n  url: string,\n  options: RequestInit,\n  retries: number = MAX_RETRIES\n): Promise<Response> {\n  let lastError: Error | null = null;\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), EXECUTION_TIMEOUT_MS);\n\n      const response = await fetch(url, {\n        ...options,\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n\n      if (response.status === 429) {\n        console.warn(`[Piston] Rate limited on attempt ${attempt + 1}`);\n        if (attempt < retries) {\n          await new Promise((resolve) => setTimeout(resolve, 1000 * (attempt + 1)));\n          continue;\n        }\n      }\n\n      return response;\n    } catch (error: any) {\n      lastError = error;\n      console.error(`[Piston] Request failed on attempt ${attempt + 1}:`, error.message);\n\n      if (error.name === \"AbortError\") {\n        throw new Error(\"Request timeout exceeded\");\n      }\n\n      if (attempt < retries) {\n        await new Promise((resolve) => setTimeout(resolve, 500 * (attempt + 1)));\n      }\n    }\n  }\n\n  throw lastError || new Error(\"All retry attempts failed\");\n}\n\nexport async function getSupportedRuntimes(): Promise<PistonRuntime[]> {\n  const now = Date.now();\n  if (cachedRuntimes && now - runtimesCacheTime < CACHE_TTL_MS) {\n    return cachedRuntimes;\n  }\n\n  try {\n    const response = await fetchWithRetry(`${PISTON_API_URL}/runtimes`, {\n      method: \"GET\",\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n\n    if (!response.ok) {\n      throw new Error(`Failed to fetch runtimes: ${response.status} ${response.statusText}`);\n    }\n\n    const runtimes: PistonRuntime[] = await response.json();\n    cachedRuntimes = runtimes;\n    runtimesCacheTime = now;\n\n    return runtimes;\n  } catch (error) {\n    console.error(\"[Piston] Failed to fetch runtimes:\", error);\n    if (cachedRuntimes) {\n      return cachedRuntimes;\n    }\n    throw error;\n  }\n}\n\nexport function parseErrorLines(stderr: string, language: string): ErrorLine[] {\n  const errorLines: ErrorLine[] = [];\n  const normalizedLang = LANGUAGE_MAP[language.toLowerCase()]?.language || language.toLowerCase();\n\n  const lines = stderr.split(\"\\n\");\n\n  for (const line of lines) {\n    let match: RegExpMatchArray | null = null;\n\n    switch (normalizedLang) {\n      case \"python\":\n        match = line.match(/File\\s+\"[^\"]*\",\\s+line\\s+(\\d+)(?:,\\s+in\\s+\\w+)?/i);\n        if (match) {\n          errorLines.push({ line: parseInt(match[1], 10) });\n        }\n        match = line.match(/^\\s*File\\s+\"<[^>]+>\",\\s+line\\s+(\\d+)/);\n        if (match) {\n          errorLines.push({ line: parseInt(match[1], 10) });\n        }\n        break;\n\n      case \"javascript\":\n      case \"typescript\":\n        match = line.match(/at\\s+.*\\(.*:(\\d+):(\\d+)\\)/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        match = line.match(/^\\s*.*:(\\d+):(\\d+)/);\n        if (match && !errorLines.some((e) => e.line === parseInt(match![1], 10))) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        match = line.match(/at\\s+.*:(\\d+):(\\d+)/);\n        if (match && !errorLines.some((e) => e.line === parseInt(match![1], 10))) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        break;\n\n      case \"go\":\n        match = line.match(/\\.\\/\\w+\\.go:(\\d+):(\\d+):/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        match = line.match(/\\w+\\.go:(\\d+):(\\d+)/);\n        if (match && !errorLines.some((e) => e.line === parseInt(match![1], 10))) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        break;\n\n      case \"rust\":\n        match = line.match(/--> [\\w.]+:(\\d+):(\\d+)/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        match = line.match(/(\\d+)\\s*\\|/);\n        if (match && parseInt(match[1], 10) > 0) {\n          const lineNum = parseInt(match[1], 10);\n          if (!errorLines.some((e) => e.line === lineNum)) {\n            errorLines.push({ line: lineNum });\n          }\n        }\n        break;\n\n      case \"c\":\n      case \"c++\":\n        match = line.match(/\\w+\\.(c|cpp|h|hpp):(\\d+):(\\d+):\\s*(error|warning)/i);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[2], 10),\n            column: parseInt(match[3], 10),\n            message: match[4],\n          });\n        }\n        match = line.match(/:(\\d+):(\\d+):\\s*(error|warning|note)/i);\n        if (match && !errorLines.some((e) => e.line === parseInt(match![1], 10))) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n            message: match[3],\n          });\n        }\n        break;\n\n      case \"java\":\n        match = line.match(/at\\s+[\\w.$]+\\([\\w.]+:(\\d+)\\)/);\n        if (match) {\n          errorLines.push({ line: parseInt(match[1], 10) });\n        }\n        match = line.match(/\\.java:(\\d+):\\s*(error|warning)/i);\n        if (match && !errorLines.some((e) => e.line === parseInt(match![1], 10))) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            message: match[2],\n          });\n        }\n        break;\n\n      case \"kotlin\":\n        match = line.match(/\\.kt:(\\d+):(\\d+):/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        break;\n\n      case \"ruby\":\n        match = line.match(/\\.rb:(\\d+):/);\n        if (match) {\n          errorLines.push({ line: parseInt(match[1], 10) });\n        }\n        break;\n\n      case \"php\":\n        match = line.match(/on line (\\d+)/i);\n        if (match) {\n          errorLines.push({ line: parseInt(match[1], 10) });\n        }\n        break;\n\n      case \"csharp\":\n        match = line.match(/\\.cs\\((\\d+),(\\d+)\\)/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        break;\n\n      case \"scala\":\n        match = line.match(/\\.scala:(\\d+):(\\d+):/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        break;\n\n      case \"swift\":\n        match = line.match(/\\.swift:(\\d+):(\\d+):/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        break;\n\n      case \"haskell\":\n        match = line.match(/\\.hs:(\\d+):(\\d+):/);\n        if (match) {\n          errorLines.push({\n            line: parseInt(match[1], 10),\n            column: parseInt(match[2], 10),\n          });\n        }\n        break;\n\n      default:\n        match = line.match(/:(\\d+):(\\d+)/);\n        if (match) {\n          const lineNum = parseInt(match[1], 10);\n          if (lineNum > 0 && !errorLines.some((e) => e.line === lineNum)) {\n            errorLines.push({\n              line: lineNum,\n              column: parseInt(match[2], 10),\n            });\n          }\n        }\n        match = line.match(/line\\s+(\\d+)/i);\n        if (match) {\n          const lineNum = parseInt(match[1], 10);\n          if (!errorLines.some((e) => e.line === lineNum)) {\n            errorLines.push({ line: lineNum });\n          }\n        }\n        break;\n    }\n  }\n\n  const uniqueLines = errorLines.filter(\n    (error, index, self) =>\n      index === self.findIndex((e) => e.line === error.line && e.column === error.column)\n  );\n\n  return uniqueLines.sort((a, b) => a.line - b.line);\n}\n\nexport async function executeCode(\n  languageInput: string,\n  code: string,\n  stdin?: string,\n  args?: string[]\n): Promise<ExecuteResult> {\n  const langConfig = LANGUAGE_MAP[languageInput.toLowerCase()];\n\n  if (!langConfig) {\n    throw new Error(`Unsupported language: ${languageInput}. Available: ${Object.keys(LANGUAGE_MAP).join(\", \")}`);\n  }\n\n  const { language, version, filename } = langConfig;\n  const isPython = language === \"python\";\n\n  try {\n    const requestBody: PistonExecuteRequest = {\n      language,\n      version,\n      files: [{ name: filename, content: code }],\n      stdin: stdin || \"\",\n      args: args || [],\n      compile_timeout: EXECUTION_TIMEOUT_MS,\n      run_timeout: EXECUTION_TIMEOUT_MS,\n      compile_memory_limit: MEMORY_LIMIT_BYTES,\n      run_memory_limit: MEMORY_LIMIT_BYTES,\n    };\n\n    console.log(`[Piston] Executing ${language} (${version}) code...`);\n\n    const response = await fetchWithRetry(`${PISTON_API_URL}/execute`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(requestBody),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Piston API error: ${response.status} - ${errorText}`);\n    }\n\n    const result: PistonExecuteResponse = await response.json();\n\n    const stderr = result.run?.stderr || result.compile?.stderr || \"\";\n    const errorLines = parseErrorLines(stderr, language);\n\n    return {\n      run: result.run,\n      compile: result.compile,\n      errorLines,\n      language: result.language,\n      version: result.version,\n      artifacts: [],\n    };\n  } catch (error: any) {\n    console.error(`[Piston] Execution failed for ${language}:`, error.message);\n\n    if (isPython) {\n      console.log(\"[Piston] Falling back to local Python interpreter...\");\n      try {\n        const localResult = await codeInterpreter.executeCode(code, {\n          language: \"python\",\n        });\n\n        const stderr = localResult.run.stderr || \"\";\n        const errorLines = parseErrorLines(stderr, \"python\");\n\n        return {\n          run: {\n            stdout: localResult.run.stdout || \"\",\n            stderr: localResult.run.stderr || \"\",\n            code: localResult.run.status === \"success\" ? 0 : 1,\n            signal: null,\n            output: (localResult.run.stdout || \"\") + (localResult.run.stderr || \"\"),\n          },\n          errorLines,\n          language: \"python\",\n          version: \"3.x (local)\",\n          usedFallback: true,\n          artifacts: localResult.artifacts.map((a) => ({\n            type: a.type,\n            name: a.name,\n            data: a.data,\n            mimeType: a.mimeType,\n          })),\n        };\n      } catch (fallbackError: any) {\n        console.error(\"[Piston] Local fallback also failed:\", fallbackError.message);\n        throw new Error(`Both Piston and local execution failed: ${error.message}`);\n      }\n    }\n\n    throw error;\n  }\n}\n\nexport async function getLanguageInfo(languageInput: string): Promise<{\n  supported: boolean;\n  pistonLanguage?: string;\n  version?: string;\n  filename?: string;\n}> {\n  const langConfig = LANGUAGE_MAP[languageInput.toLowerCase()];\n\n  if (!langConfig) {\n    return { supported: false };\n  }\n\n  try {\n    const runtimes = await getSupportedRuntimes();\n    const runtime = runtimes.find(\n      (r) =>\n        r.language === langConfig.language ||\n        r.aliases.includes(langConfig.language)\n    );\n\n    if (runtime) {\n      return {\n        supported: true,\n        pistonLanguage: runtime.language,\n        version: runtime.version,\n        filename: langConfig.filename,\n      };\n    }\n\n    return {\n      supported: true,\n      pistonLanguage: langConfig.language,\n      version: langConfig.version,\n      filename: langConfig.filename,\n    };\n  } catch {\n    return {\n      supported: true,\n      pistonLanguage: langConfig.language,\n      version: langConfig.version,\n      filename: langConfig.filename,\n    };\n  }\n}\n\nexport function getSupportedLanguages(): string[] {\n  return [...new Set(Object.values(LANGUAGE_MAP).map((c) => c.language))];\n}\n\nexport function getLanguageAliases(): Record<string, string[]> {\n  const aliases: Record<string, string[]> = {};\n\n  for (const [alias, config] of Object.entries(LANGUAGE_MAP)) {\n    if (!aliases[config.language]) {\n      aliases[config.language] = [];\n    }\n    if (alias !== config.language) {\n      aliases[config.language].push(alias);\n    }\n  }\n\n  return aliases;\n}\n","path":null,"size_bytes":18419,"size_tokens":null},"client/src/graphics/visualization-surface.tsx":{"content":"import { useMemo } from 'react';\nimport { \n  GraphicsConfig, \n  detectCapabilities, \n  resolveRenderMode,\n  SVGConfig,\n  Canvas2DConfig,\n  WebGLConfig,\n} from '@shared/schemas/graphics';\nimport { SVGRenderer } from './svg';\nimport { CanvasEngine } from './canvas';\nimport { ThreeEngine } from './three';\n\ninterface VisualizationSurfaceProps {\n  config: GraphicsConfig;\n  className?: string;\n  onReady?: (context: any) => void;\n  onExport?: (data: Blob | string) => void;\n}\n\nexport function VisualizationSurface({ config, className, onReady, onExport }: VisualizationSurfaceProps) {\n  const capabilities = useMemo(() => detectCapabilities(), []);\n  \n  const actualMode = useMemo(() => {\n    if (config.mode === 'auto') {\n      return resolveRenderMode('auto', capabilities);\n    }\n    return resolveRenderMode(config.mode, capabilities);\n  }, [config.mode, capabilities]);\n  \n  switch (actualMode) {\n    case 'svg':\n      return (\n        <SVGRenderer \n          config={config as SVGConfig} \n          className={className}\n          onReady={onReady}\n          onExport={onExport as ((svgString: string) => void) | undefined}\n        />\n      );\n    case 'canvas2d':\n      return (\n        <CanvasEngine \n          config={config as Canvas2DConfig} \n          className={className}\n          onReady={onReady}\n        />\n      );\n    case 'webgl':\n      return (\n        <ThreeEngine \n          config={config as WebGLConfig} \n          className={className}\n          onReady={onReady}\n        />\n      );\n    default:\n      return (\n        <div \n          className={className}\n          data-testid=\"visualization-surface-unsupported\"\n          style={{\n            display: 'flex',\n            alignItems: 'center',\n            justifyContent: 'center',\n            padding: '20px',\n            backgroundColor: '#f5f5f5',\n            color: '#666',\n          }}\n        >\n          Unsupported graphics mode\n        </div>\n      );\n  }\n}\n\nexport type { VisualizationSurfaceProps };\n","path":null,"size_bytes":1989,"size_tokens":null},"client/src/hooks/useAsyncHighlight.ts":{"content":"import { useState, useEffect, useRef, useCallback, useMemo } from 'react';\nimport { highlightCode, loadLanguage, getLanguageAlias } from '@/lib/syntaxHighlighter';\n\ninterface PrismWorkerRequest {\n  id: string;\n  code: string;\n  language: string;\n}\n\ninterface PrismWorkerResponse {\n  id: string;\n  html: string;\n  language: string;\n  success: boolean;\n  error?: string;\n}\n\ninterface UseAsyncHighlightResult {\n  html: string;\n  isLoading: boolean;\n  error: string | null;\n  isFromCache: boolean;\n}\n\ninterface CacheEntry {\n  html: string;\n  timestamp: number;\n}\n\nconst SMALL_SNIPPET_THRESHOLD = 50;\nconst CACHE_MAX_SIZE = 100;\nconst CACHE_TTL_MS = 5 * 60 * 1000;\n\nconst highlightCache = new Map<string, CacheEntry>();\n\nfunction getCacheKey(code: string, language: string): string {\n  return `${language}:${code.length}:${code.slice(0, 100)}:${code.slice(-50)}`;\n}\n\nfunction getFromCache(key: string): string | null {\n  const entry = highlightCache.get(key);\n  if (!entry) return null;\n  \n  if (Date.now() - entry.timestamp > CACHE_TTL_MS) {\n    highlightCache.delete(key);\n    return null;\n  }\n  \n  return entry.html;\n}\n\nfunction setCache(key: string, html: string): void {\n  if (highlightCache.size >= CACHE_MAX_SIZE) {\n    const oldestKey = highlightCache.keys().next().value;\n    if (oldestKey) {\n      highlightCache.delete(oldestKey);\n    }\n  }\n  \n  highlightCache.set(key, { html, timestamp: Date.now() });\n}\n\nlet workerInstance: Worker | null = null;\nlet workerSupported = true;\n\nfunction getWorker(): Worker | null {\n  if (!workerSupported) return null;\n  \n  if (!workerInstance) {\n    try {\n      workerInstance = new Worker(\n        new URL('../workers/prismWorker.ts', import.meta.url),\n        { type: 'module' }\n      );\n      \n      workerInstance.onerror = () => {\n        console.warn('[useAsyncHighlight] Worker failed to initialize, falling back to sync');\n        workerSupported = false;\n        workerInstance = null;\n      };\n    } catch (error) {\n      console.warn('[useAsyncHighlight] Worker not supported, using sync highlighting');\n      workerSupported = false;\n      return null;\n    }\n  }\n  \n  return workerInstance;\n}\n\nconst pendingRequests = new Map<string, {\n  resolve: (value: PrismWorkerResponse) => void;\n  reject: (error: Error) => void;\n}>();\n\nfunction setupWorkerMessageHandler(worker: Worker): void {\n  worker.onmessage = (event: MessageEvent<PrismWorkerResponse>) => {\n    const { id } = event.data;\n    const pending = pendingRequests.get(id);\n    \n    if (pending) {\n      pending.resolve(event.data);\n      pendingRequests.delete(id);\n    }\n  };\n}\n\nasync function highlightWithWorker(\n  code: string,\n  language: string,\n  requestId: string\n): Promise<PrismWorkerResponse> {\n  const worker = getWorker();\n  \n  if (!worker) {\n    throw new Error('Worker not available');\n  }\n  \n  if (!pendingRequests.size) {\n    setupWorkerMessageHandler(worker);\n  }\n  \n  return new Promise((resolve, reject) => {\n    const timeoutId = setTimeout(() => {\n      pendingRequests.delete(requestId);\n      reject(new Error('Worker timeout'));\n    }, 10000);\n    \n    pendingRequests.set(requestId, {\n      resolve: (response) => {\n        clearTimeout(timeoutId);\n        resolve(response);\n      },\n      reject: (error) => {\n        clearTimeout(timeoutId);\n        reject(error);\n      },\n    });\n    \n    const request: PrismWorkerRequest = {\n      id: requestId,\n      code,\n      language,\n    };\n    \n    worker.postMessage(request);\n  });\n}\n\nfunction escapeHtml(text: string): string {\n  const htmlEscapes: Record<string, string> = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n  };\n  return text.replace(/[&<>\"']/g, (char) => htmlEscapes[char] || char);\n}\n\nasync function highlightSync(code: string, language: string): Promise<string> {\n  const resolved = getLanguageAlias(language);\n  await loadLanguage(resolved);\n  return highlightCode(code, resolved);\n}\n\nexport function useAsyncHighlight(\n  code: string,\n  language: string\n): UseAsyncHighlightResult {\n  const [html, setHtml] = useState<string>('');\n  const [isLoading, setIsLoading] = useState<boolean>(true);\n  const [error, setError] = useState<string | null>(null);\n  const [isFromCache, setIsFromCache] = useState<boolean>(false);\n  \n  const requestIdRef = useRef<number>(0);\n  const mountedRef = useRef<boolean>(true);\n  \n  const lineCount = useMemo(() => {\n    return code ? code.split('\\n').length : 0;\n  }, [code]);\n  \n  const shouldUseSync = useMemo(() => {\n    return lineCount < SMALL_SNIPPET_THRESHOLD;\n  }, [lineCount]);\n  \n  const cacheKey = useMemo(() => {\n    return getCacheKey(code, language);\n  }, [code, language]);\n  \n  const performHighlight = useCallback(async () => {\n    if (!code) {\n      setHtml('');\n      setIsLoading(false);\n      setError(null);\n      return;\n    }\n    \n    const cached = getFromCache(cacheKey);\n    if (cached !== null) {\n      setHtml(cached);\n      setIsLoading(false);\n      setIsFromCache(true);\n      setError(null);\n      return;\n    }\n    \n    setIsLoading(true);\n    setIsFromCache(false);\n    setError(null);\n    \n    const currentRequestId = ++requestIdRef.current;\n    \n    try {\n      let highlightedHtml: string;\n      \n      if (shouldUseSync || !workerSupported) {\n        highlightedHtml = await highlightSync(code, language);\n      } else {\n        try {\n          const response = await highlightWithWorker(\n            code,\n            language,\n            `req-${currentRequestId}-${Date.now()}`\n          );\n          \n          if (!response.success && response.error) {\n            console.warn('[useAsyncHighlight] Worker error:', response.error);\n          }\n          \n          highlightedHtml = response.html;\n        } catch (workerError) {\n          console.warn('[useAsyncHighlight] Falling back to sync:', workerError);\n          highlightedHtml = await highlightSync(code, language);\n        }\n      }\n      \n      if (!mountedRef.current || currentRequestId !== requestIdRef.current) {\n        return;\n      }\n      \n      setCache(cacheKey, highlightedHtml);\n      setHtml(highlightedHtml);\n      setIsLoading(false);\n    } catch (err) {\n      if (!mountedRef.current || currentRequestId !== requestIdRef.current) {\n        return;\n      }\n      \n      console.error('[useAsyncHighlight] Highlight failed:', err);\n      setHtml(escapeHtml(code));\n      setError(err instanceof Error ? err.message : 'Highlighting failed');\n      setIsLoading(false);\n    }\n  }, [code, language, cacheKey, shouldUseSync]);\n  \n  useEffect(() => {\n    mountedRef.current = true;\n    performHighlight();\n    \n    return () => {\n      mountedRef.current = false;\n    };\n  }, [performHighlight]);\n  \n  return {\n    html,\n    isLoading,\n    error,\n    isFromCache,\n  };\n}\n\nexport function clearHighlightCache(): void {\n  highlightCache.clear();\n}\n\nexport function getHighlightCacheSize(): number {\n  return highlightCache.size;\n}\n\nexport default useAsyncHighlight;\n","path":null,"size_bytes":6960,"size_tokens":null},"client/src/components/charts/visualization-renderer.tsx":{"content":"import { VisualizationConfig } from '@shared/schemas/visualization';\nimport { RechartsChart } from './recharts-chart';\nimport { EChartsChart } from './echarts-chart';\nimport { SmartTable } from './smart-table';\nimport { cn } from '@/lib/utils';\n\ninterface VisualizationRendererProps {\n  config: VisualizationConfig;\n  className?: string;\n  onDataClick?: (data: any) => void;\n}\n\nexport function VisualizationRenderer({ config, className, onDataClick }: VisualizationRendererProps) {\n  if (config.type === 'table' && config.table) {\n    return <SmartTable config={config.table} className={className} />;\n  }\n  \n  if (config.type === 'chart' && config.chart) {\n    if (config.chart.type === 'map' || config.chart.type === 'heatmap') {\n      return <EChartsChart config={config.chart} className={className} onDataClick={onDataClick} />;\n    }\n    return <RechartsChart config={config.chart} className={className} onDataClick={onDataClick} />;\n  }\n  \n  return (\n    <div \n      className={cn('w-full flex items-center justify-center p-8 bg-muted/20 rounded-lg border border-border', className)}\n      data-testid=\"visualization-error\"\n    >\n      <p className=\"text-sm text-muted-foreground\">Invalid visualization config</p>\n    </div>\n  );\n}\n\nexport { SmartTable } from './smart-table';\nexport type { SmartTableProps } from './smart-table';\nexport type { VisualizationRendererProps };\n","path":null,"size_bytes":1381,"size_tokens":null},"client/src/components/code-editor-modal.tsx":{"content":"import { useState, useCallback } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { MonacoCodeEditor } from \"./monaco-code-editor\";\nimport { Save, X, Code2 } from \"lucide-react\";\n\nexport interface CodeEditorModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  code: string;\n  language?: string;\n  title?: string;\n  onSave?: (code: string) => void;\n  onCancel?: () => void;\n  readOnly?: boolean;\n}\n\nexport function CodeEditorModal({\n  open,\n  onOpenChange,\n  code,\n  language = \"javascript\",\n  title,\n  onSave,\n  onCancel,\n  readOnly = false,\n}: CodeEditorModalProps) {\n  const [currentCode, setCurrentCode] = useState(code);\n\n  const handleChange = useCallback((value: string) => {\n    setCurrentCode(value);\n  }, []);\n\n  const handleSave = useCallback(() => {\n    onSave?.(currentCode);\n    onOpenChange(false);\n  }, [currentCode, onSave, onOpenChange]);\n\n  const handleCancel = useCallback(() => {\n    setCurrentCode(code);\n    onCancel?.();\n    onOpenChange(false);\n  }, [code, onCancel, onOpenChange]);\n\n  const handleKeyboardSave = useCallback(\n    (value: string) => {\n      onSave?.(value);\n      onOpenChange(false);\n    },\n    [onSave, onOpenChange]\n  );\n\n  const displayTitle = title || `Edit ${language.charAt(0).toUpperCase() + language.slice(1)} Code`;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent\n        className=\"max-w-[95vw] w-[1200px] h-[85vh] flex flex-col p-0 gap-0 bg-zinc-950 border-zinc-800\"\n        data-testid=\"code-editor-modal\"\n      >\n        <DialogHeader className=\"px-4 py-3 border-b border-zinc-800 flex-shrink-0\">\n          <DialogTitle className=\"flex items-center gap-2 text-zinc-100\">\n            <Code2 className=\"w-5 h-5 text-blue-400\" />\n            <span>{displayTitle}</span>\n            <span className=\"ml-2 text-xs font-mono text-zinc-500 bg-zinc-800 px-2 py-0.5 rounded\">\n              {language}\n            </span>\n            {readOnly && (\n              <span className=\"text-xs text-amber-400 bg-amber-500/10 px-2 py-0.5 rounded\">\n                Read-only\n              </span>\n            )}\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"flex-1 overflow-hidden p-2\" data-testid=\"code-editor-container\">\n          <MonacoCodeEditor\n            code={currentCode}\n            language={language}\n            readOnly={readOnly}\n            onChange={handleChange}\n            onSave={handleKeyboardSave}\n            onCancel={handleCancel}\n            height=\"100%\"\n            theme=\"auto\"\n            showMinimap={true}\n            className=\"h-full\"\n          />\n        </div>\n\n        <DialogFooter className=\"px-4 py-3 border-t border-zinc-800 flex-shrink-0\">\n          <div className=\"flex items-center justify-between w-full\">\n            <div className=\"text-xs text-zinc-500\">\n              <span className=\"hidden sm:inline\">\n                Press <kbd className=\"px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400\">Ctrl+S</kbd> to save,{\" \"}\n                <kbd className=\"px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400\">Esc</kbd> to cancel\n              </span>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={handleCancel}\n                className=\"border-zinc-700 text-zinc-300 hover:bg-zinc-800\"\n                data-testid=\"button-cancel-edit\"\n              >\n                <X className=\"w-4 h-4 mr-2\" />\n                Cancel\n              </Button>\n              {!readOnly && (\n                <Button\n                  onClick={handleSave}\n                  className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n                  data-testid=\"button-save-code\"\n                >\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  Save\n                </Button>\n              )}\n            </div>\n          </div>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":4094,"size_tokens":null},"client/src/components/code-annotation-sidebar.tsx":{"content":"import { useState, useCallback } from \"react\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  ChevronRight,\n  MessageSquare,\n  Pencil,\n  Trash2,\n  Check,\n  X,\n  Info,\n  AlertTriangle,\n  AlertCircle,\n  Lightbulb,\n} from \"lucide-react\";\nimport type { CodeAnnotation } from \"@/hooks/useCodeAnnotations\";\n\nexport interface CodeAnnotationSidebarProps {\n  annotations: CodeAnnotation[];\n  onAnnotationClick?: (annotation: CodeAnnotation) => void;\n  onEdit?: (id: string, content: string) => void;\n  onDelete?: (id: string) => void;\n  isOpen: boolean;\n  onToggle: () => void;\n}\n\nconst typeConfig = {\n  info: {\n    bg: \"bg-blue-500/10\",\n    border: \"border-blue-500/30\",\n    text: \"text-blue-400\",\n    dot: \"bg-blue-500\",\n    icon: Info,\n  },\n  warning: {\n    bg: \"bg-amber-500/10\",\n    border: \"border-amber-500/30\",\n    text: \"text-amber-400\",\n    dot: \"bg-amber-500\",\n    icon: AlertTriangle,\n  },\n  error: {\n    bg: \"bg-red-500/10\",\n    border: \"border-red-500/30\",\n    text: \"text-red-400\",\n    dot: \"bg-red-500\",\n    icon: AlertCircle,\n  },\n  explanation: {\n    bg: \"bg-emerald-500/10\",\n    border: \"border-emerald-500/30\",\n    text: \"text-emerald-400\",\n    dot: \"bg-emerald-500\",\n    icon: Lightbulb,\n  },\n};\n\ninterface AnnotationItemProps {\n  annotation: CodeAnnotation;\n  onClick?: () => void;\n  onEdit?: (id: string, content: string) => void;\n  onDelete?: (id: string) => void;\n}\n\nfunction AnnotationItem({ annotation, onClick, onEdit, onDelete }: AnnotationItemProps) {\n  const [isEditing, setIsEditing] = useState(false);\n  const [editContent, setEditContent] = useState(annotation.content);\n\n  const config = typeConfig[annotation.type];\n  const Icon = config.icon;\n\n  const handleStartEdit = useCallback((e: React.MouseEvent) => {\n    e.stopPropagation();\n    setEditContent(annotation.content);\n    setIsEditing(true);\n  }, [annotation.content]);\n\n  const handleCancelEdit = useCallback((e: React.MouseEvent) => {\n    e.stopPropagation();\n    setEditContent(annotation.content);\n    setIsEditing(false);\n  }, [annotation.content]);\n\n  const handleSaveEdit = useCallback((e: React.MouseEvent) => {\n    e.stopPropagation();\n    if (onEdit && editContent.trim()) {\n      onEdit(annotation.id, editContent.trim());\n    }\n    setIsEditing(false);\n  }, [onEdit, annotation.id, editContent]);\n\n  const handleDelete = useCallback((e: React.MouseEvent) => {\n    e.stopPropagation();\n    if (onDelete) {\n      onDelete(annotation.id);\n    }\n  }, [onDelete, annotation.id]);\n\n  return (\n    <div\n      className={cn(\n        \"group rounded-lg border p-3 transition-all duration-200\",\n        config.border,\n        \"hover:bg-zinc-800/50 cursor-pointer\"\n      )}\n      onClick={onClick}\n      data-testid={`sidebar-annotation-${annotation.id}`}\n    >\n      <div className=\"flex items-start gap-2\">\n        <div className={cn(\"p-1.5 rounded\", config.bg)}>\n          <Icon className={cn(\"w-3.5 h-3.5\", config.text)} />\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center justify-between mb-1\">\n            <span className={cn(\"text-xs font-medium\", config.text)}>\n              Line {annotation.line}\n            </span>\n            {!isEditing && (\n              <div className=\"flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity\">\n                {onEdit && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleStartEdit}\n                    className=\"h-6 w-6 p-0 text-zinc-400 hover:text-white hover:bg-zinc-700\"\n                    data-testid={`sidebar-edit-${annotation.id}`}\n                  >\n                    <Pencil className=\"w-3 h-3\" />\n                  </Button>\n                )}\n                {onDelete && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleDelete}\n                    className=\"h-6 w-6 p-0 text-zinc-400 hover:text-red-400 hover:bg-red-500/10\"\n                    data-testid={`sidebar-delete-${annotation.id}`}\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </Button>\n                )}\n              </div>\n            )}\n          </div>\n\n          {isEditing ? (\n            <div className=\"space-y-2\" onClick={(e) => e.stopPropagation()}>\n              <Textarea\n                value={editContent}\n                onChange={(e) => setEditContent(e.target.value)}\n                className=\"min-h-[60px] text-xs bg-zinc-800 border-zinc-700 resize-none\"\n                autoFocus\n                data-testid={`sidebar-edit-textarea-${annotation.id}`}\n              />\n              <div className=\"flex justify-end gap-1\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleCancelEdit}\n                  className=\"h-6 px-2 text-xs text-zinc-400\"\n                  data-testid={`sidebar-cancel-${annotation.id}`}\n                >\n                  <X className=\"w-3 h-3 mr-1\" />\n                  Cancel\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleSaveEdit}\n                  className={cn(\"h-6 px-2 text-xs\", config.text)}\n                  data-testid={`sidebar-save-${annotation.id}`}\n                >\n                  <Check className=\"w-3 h-3 mr-1\" />\n                  Save\n                </Button>\n              </div>\n            </div>\n          ) : (\n            <p\n              className=\"text-xs text-zinc-400 line-clamp-2\"\n              data-testid={`sidebar-content-${annotation.id}`}\n            >\n              {annotation.content}\n            </p>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport function CodeAnnotationSidebar({\n  annotations,\n  onAnnotationClick,\n  onEdit,\n  onDelete,\n  isOpen,\n  onToggle,\n}: CodeAnnotationSidebarProps) {\n  const sortedAnnotations = [...annotations].sort((a, b) => a.line - b.line);\n\n  return (\n    <Collapsible open={isOpen} onOpenChange={onToggle}>\n      <div\n        className=\"border-l border-zinc-800 bg-zinc-900/50 h-full flex flex-col\"\n        data-testid=\"annotation-sidebar\"\n      >\n        <CollapsibleTrigger asChild>\n          <Button\n            variant=\"ghost\"\n            className=\"w-full flex items-center justify-between px-3 py-2 h-10 rounded-none border-b border-zinc-800 hover:bg-zinc-800\"\n            data-testid=\"sidebar-toggle\"\n          >\n            <div className=\"flex items-center gap-2\">\n              <MessageSquare className=\"w-4 h-4 text-zinc-400\" />\n              <span className=\"text-sm text-zinc-300\">Annotations</span>\n              <span className=\"text-xs text-zinc-500 bg-zinc-800 px-1.5 py-0.5 rounded\">\n                {annotations.length}\n              </span>\n            </div>\n            <ChevronRight\n              className={cn(\n                \"w-4 h-4 text-zinc-400 transition-transform duration-200\",\n                isOpen && \"rotate-90\"\n              )}\n            />\n          </Button>\n        </CollapsibleTrigger>\n\n        <CollapsibleContent className=\"flex-1 overflow-hidden\">\n          <ScrollArea className=\"h-full\" data-testid=\"sidebar-scroll-area\">\n            <div className=\"p-2 space-y-2\">\n              {sortedAnnotations.length === 0 ? (\n                <div\n                  className=\"text-center py-8 text-zinc-500 text-sm\"\n                  data-testid=\"sidebar-empty\"\n                >\n                  <MessageSquare className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                  <p>No annotations yet</p>\n                  <p className=\"text-xs mt-1\">\n                    Click on a line to add one\n                  </p>\n                </div>\n              ) : (\n                sortedAnnotations.map((annotation) => (\n                  <AnnotationItem\n                    key={annotation.id}\n                    annotation={annotation}\n                    onClick={() => onAnnotationClick?.(annotation)}\n                    onEdit={onEdit}\n                    onDelete={onDelete}\n                  />\n                ))\n              )}\n            </div>\n          </ScrollArea>\n        </CollapsibleContent>\n      </div>\n    </Collapsible>\n  );\n}\n\nexport default CodeAnnotationSidebar;\n","path":null,"size_bytes":8575,"size_tokens":null},"client/src/graphics/svg/svg-renderer.tsx":{"content":"import { useRef, useEffect, useCallback, useState } from 'react';\nimport * as d3 from 'd3';\nimport type { SVGConfig } from '@shared/schemas/graphics';\nimport { sanitizeSVG, exportSVGAsString } from './svg-utils';\n\ninterface SVGRendererProps {\n  config: SVGConfig;\n  className?: string;\n  onReady?: (svgElement: SVGSVGElement) => void;\n  onExport?: (svgString: string) => void;\n}\n\nexport function SVGRenderer({ config, className, onReady, onExport }: SVGRendererProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const svgRef = useRef<SVGSVGElement | null>(null);\n  const zoomRef = useRef<d3.ZoomBehavior<SVGSVGElement, unknown> | null>(null);\n  const [dimensions, setDimensions] = useState({ width: 0, height: 0 });\n\n  const parseDimension = useCallback((value: number | string | undefined, fallback: number): number => {\n    if (value === undefined) return fallback;\n    if (typeof value === 'number') return value;\n    if (value.endsWith('%')) return fallback;\n    return parseInt(value, 10) || fallback;\n  }, []);\n\n  useEffect(() => {\n    if (!containerRef.current) return;\n\n    const container = containerRef.current;\n\n    const updateDimensions = () => {\n      const rect = container.getBoundingClientRect();\n      setDimensions({\n        width: parseDimension(config.width, rect.width || 800),\n        height: parseDimension(config.height, rect.height || 600),\n      });\n    };\n\n    updateDimensions();\n\n    if (config.responsive !== false) {\n      const resizeObserver = new ResizeObserver(updateDimensions);\n      resizeObserver.observe(container);\n      return () => resizeObserver.disconnect();\n    }\n  }, [config.width, config.height, config.responsive, parseDimension]);\n\n  useEffect(() => {\n    if (!containerRef.current || dimensions.width === 0) return;\n\n    const container = d3.select(containerRef.current);\n    container.selectAll('svg').remove();\n\n    const svg = container\n      .append('svg')\n      .attr('id', config.id)\n      .attr('width', dimensions.width)\n      .attr('height', dimensions.height)\n      .attr('xmlns', 'http://www.w3.org/2000/svg')\n      .attr('xmlns:xlink', 'http://www.w3.org/1999/xlink');\n\n    if (config.viewBox) {\n      svg.attr('viewBox', config.viewBox);\n    } else {\n      svg.attr('viewBox', `0 0 ${dimensions.width} ${dimensions.height}`);\n    }\n\n    if (config.preserveAspectRatio) {\n      svg.attr('preserveAspectRatio', config.preserveAspectRatio);\n    }\n\n    if (config.background) {\n      svg\n        .append('rect')\n        .attr('class', 'svg-background')\n        .attr('width', '100%')\n        .attr('height', '100%')\n        .attr('fill', config.background);\n    }\n\n    const contentGroup = svg.append('g').attr('class', 'svg-content');\n\n    if (config.content) {\n      const sanitizedContent = sanitizeSVG(config.content);\n      const tempDiv = document.createElement('div');\n      tempDiv.innerHTML = sanitizedContent;\n      \n      const fragment = document.createDocumentFragment();\n      while (tempDiv.firstChild) {\n        fragment.appendChild(tempDiv.firstChild);\n      }\n      contentGroup.node()?.appendChild(fragment);\n    }\n\n    svgRef.current = svg.node();\n\n    if ((config.enableZoom || config.enablePan) && svgRef.current) {\n      const zoom = d3.zoom<SVGSVGElement, unknown>()\n        .scaleExtent([0.1, 10])\n        .on('zoom', (event: d3.D3ZoomEvent<SVGSVGElement, unknown>) => {\n          contentGroup.attr('transform', event.transform.toString());\n        });\n\n      if (!config.enableZoom) {\n        zoom.scaleExtent([1, 1]);\n      }\n\n      if (!config.enablePan) {\n        zoom.translateExtent([[0, 0], [0, 0]]);\n      }\n\n      svg.call(zoom);\n      zoomRef.current = zoom;\n    }\n\n    if (svgRef.current && onReady) {\n      onReady(svgRef.current);\n    }\n\n    return () => {\n      container.selectAll('svg').remove();\n      svgRef.current = null;\n      zoomRef.current = null;\n    };\n  }, [config, dimensions, onReady]);\n\n  const handleExport = useCallback(() => {\n    if (svgRef.current && onExport) {\n      const svgString = exportSVGAsString(svgRef.current);\n      onExport(svgString);\n    }\n  }, [onExport]);\n\n  const resetZoom = useCallback(() => {\n    if (svgRef.current && zoomRef.current) {\n      d3.select(svgRef.current)\n        .transition()\n        .duration(300)\n        .call(zoomRef.current.transform, d3.zoomIdentity);\n    }\n  }, []);\n\n  const zoomIn = useCallback(() => {\n    if (svgRef.current && zoomRef.current) {\n      d3.select(svgRef.current)\n        .transition()\n        .duration(200)\n        .call(zoomRef.current.scaleBy, 1.3);\n    }\n  }, []);\n\n  const zoomOut = useCallback(() => {\n    if (svgRef.current && zoomRef.current) {\n      d3.select(svgRef.current)\n        .transition()\n        .duration(200)\n        .call(zoomRef.current.scaleBy, 0.7);\n    }\n  }, []);\n\n  return (\n    <div\n      ref={containerRef}\n      className={className}\n      style={{\n        width: typeof config.width === 'string' ? config.width : config.width ? `${config.width}px` : '100%',\n        height: typeof config.height === 'string' ? config.height : config.height ? `${config.height}px` : '100%',\n        overflow: 'hidden',\n        position: 'relative',\n      }}\n      data-testid={`svg-renderer-${config.id}`}\n    >\n      {(config.enableZoom || config.enablePan) && (\n        <div \n          className=\"absolute top-2 right-2 flex flex-col gap-1 z-10\"\n          data-testid=\"svg-zoom-controls\"\n        >\n          <button\n            onClick={zoomIn}\n            className=\"w-8 h-8 bg-white/90 dark:bg-gray-800/90 hover:bg-white dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded flex items-center justify-center text-gray-700 dark:text-gray-300 shadow-sm\"\n            data-testid=\"svg-zoom-in\"\n            title=\"Zoom In\"\n          >\n            +\n          </button>\n          <button\n            onClick={zoomOut}\n            className=\"w-8 h-8 bg-white/90 dark:bg-gray-800/90 hover:bg-white dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded flex items-center justify-center text-gray-700 dark:text-gray-300 shadow-sm\"\n            data-testid=\"svg-zoom-out\"\n            title=\"Zoom Out\"\n          >\n            −\n          </button>\n          <button\n            onClick={resetZoom}\n            className=\"w-8 h-8 bg-white/90 dark:bg-gray-800/90 hover:bg-white dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded flex items-center justify-center text-gray-700 dark:text-gray-300 shadow-sm text-xs\"\n            data-testid=\"svg-zoom-reset\"\n            title=\"Reset Zoom\"\n          >\n            ↻\n          </button>\n        </div>\n      )}\n      {config.exportable && onExport && (\n        <button\n          onClick={handleExport}\n          className=\"absolute bottom-2 right-2 px-3 py-1 bg-white/90 dark:bg-gray-800/90 hover:bg-white dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded text-sm text-gray-700 dark:text-gray-300 shadow-sm z-10\"\n          data-testid=\"svg-export-button\"\n        >\n          Export SVG\n        </button>\n      )}\n    </div>\n  );\n}\n\nexport type { SVGRendererProps };\n","path":null,"size_bytes":7107,"size_tokens":null},"client/src/components/charts/echarts-chart-impl.tsx":{"content":"import { useRef, useCallback, useMemo } from 'react';\nimport ReactEChartsCore from 'echarts-for-react/lib/core';\nimport * as echarts from 'echarts/core';\nimport { MapChart, ScatterChart, HeatmapChart } from 'echarts/charts';\nimport {\n  GeoComponent,\n  TooltipComponent,\n  VisualMapComponent,\n  LegendComponent,\n  GridComponent,\n  TitleComponent,\n  ToolboxComponent,\n} from 'echarts/components';\nimport { CanvasRenderer } from 'echarts/renderers';\nimport { Download, Image, FileCode } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport type { ChartConfig, GeoPoint, DataPoint } from '@shared/schemas/visualization';\n\necharts.use([\n  MapChart,\n  ScatterChart,\n  HeatmapChart,\n  GeoComponent,\n  TooltipComponent,\n  VisualMapComponent,\n  LegendComponent,\n  GridComponent,\n  TitleComponent,\n  ToolboxComponent,\n  CanvasRenderer,\n]);\n\nexport interface EChartsChartProps {\n  config: ChartConfig;\n  className?: string;\n  onDataClick?: (data: any) => void;\n}\n\nfunction getDefaultColors(): string[] {\n  return [\n    '#3b82f6',\n    '#10b981',\n    '#f59e0b',\n    '#ef4444',\n    '#8b5cf6',\n    '#ec4899',\n    '#06b6d4',\n    '#84cc16',\n    '#f97316',\n    '#6366f1',\n  ];\n}\n\nfunction isGeoPoint(point: any): point is GeoPoint {\n  return typeof point === 'object' && 'lat' in point && 'lng' in point;\n}\n\nfunction EChartsChartImpl({ config, className, onDataClick }: EChartsChartProps) {\n  const chartRef = useRef<ReactEChartsCore>(null);\n\n  const {\n    type,\n    title,\n    subtitle,\n    data,\n    colors = getDefaultColors(),\n    showLegend = true,\n    showTooltip = true,\n    enableExport = true,\n    height = 400,\n    mapCenter = [0, 20],\n    mapZoom = 1.2,\n  } = config;\n\n  const handleDataClick = useCallback((params: any) => {\n    if (onDataClick && params.data) {\n      onDataClick(params.data);\n    }\n  }, [onDataClick]);\n\n  const handleExportPNG = useCallback(() => {\n    const chartInstance = chartRef.current?.getEchartsInstance();\n    if (!chartInstance) return;\n\n    const url = chartInstance.getDataURL({\n      type: 'png',\n      pixelRatio: 2,\n      backgroundColor: '#ffffff',\n    });\n\n    const link = document.createElement('a');\n    link.download = `chart-${Date.now()}.png`;\n    link.href = url;\n    link.click();\n  }, []);\n\n  const handleExportSVG = useCallback(() => {\n    const chartInstance = chartRef.current?.getEchartsInstance();\n    if (!chartInstance) return;\n\n    const url = chartInstance.getDataURL({\n      type: 'svg',\n    });\n\n    const link = document.createElement('a');\n    link.download = `chart-${Date.now()}.svg`;\n    link.href = url;\n    link.click();\n  }, []);\n\n  const option = useMemo(() => {\n    if (type === 'map') {\n      const geoData = data.filter(isGeoPoint);\n      const scatterData = geoData.map((point) => ({\n        name: point.label || '',\n        value: [point.lng, point.lat, point.value],\n      }));\n\n      const values = geoData.map((p) => p.value);\n      const minValue = Math.min(...values, 0);\n      const maxValue = Math.max(...values, 100);\n\n      return {\n        title: title ? { text: title, subtext: subtitle, left: 'center' } : undefined,\n        tooltip: showTooltip ? {\n          trigger: 'item',\n          formatter: (params: any) => {\n            if (params.value && Array.isArray(params.value)) {\n              return `${params.name || 'Location'}<br/>Value: ${params.value[2]}`;\n            }\n            return params.name || '';\n          },\n        } : undefined,\n        legend: showLegend ? { orient: 'vertical', left: 'left' } : undefined,\n        visualMap: {\n          min: minValue,\n          max: maxValue,\n          calculable: true,\n          inRange: {\n            color: colors.slice(0, 5),\n          },\n          textStyle: { color: '#333' },\n          left: 'right',\n        },\n        geo: {\n          map: 'world',\n          roam: true,\n          center: mapCenter,\n          zoom: mapZoom,\n          itemStyle: {\n            areaColor: '#f3f4f6',\n            borderColor: '#d1d5db',\n          },\n          emphasis: {\n            itemStyle: {\n              areaColor: '#e5e7eb',\n            },\n          },\n        },\n        series: [\n          {\n            name: title || 'Data Points',\n            type: 'scatter',\n            coordinateSystem: 'geo',\n            data: scatterData,\n            symbolSize: (val: number[]) => Math.max(8, Math.min(30, val[2] / 5)),\n            encode: { value: 2 },\n            itemStyle: {\n              color: colors[0],\n            },\n            emphasis: {\n              itemStyle: {\n                borderColor: '#fff',\n                borderWidth: 2,\n              },\n            },\n          },\n        ],\n      };\n    }\n\n    if (type === 'heatmap') {\n      const heatmapData: [number, number, number][] = [];\n      const xLabels: string[] = [];\n      const yLabels: string[] = [];\n\n      if (data.length > 0 && 'x' in data[0] && 'y' in data[0]) {\n        const xSet = new Set<string>();\n        const ySet = new Set<string>();\n        data.forEach((item: any) => {\n          xSet.add(String(item.x));\n          ySet.add(String(item.y));\n        });\n        xLabels.push(...Array.from(xSet));\n        yLabels.push(...Array.from(ySet));\n\n        data.forEach((item: any) => {\n          const xIndex = xLabels.indexOf(String(item.x));\n          const yIndex = yLabels.indexOf(String(item.y));\n          heatmapData.push([xIndex, yIndex, item.value]);\n        });\n      } else {\n        const gridSize = Math.ceil(Math.sqrt(data.length));\n        for (let i = 0; i < gridSize; i++) {\n          xLabels.push(`Col ${i + 1}`);\n          yLabels.push(`Row ${i + 1}`);\n        }\n        data.forEach((item: any, index: number) => {\n          const x = index % gridSize;\n          const y = Math.floor(index / gridSize);\n          heatmapData.push([x, y, (item as DataPoint).value]);\n        });\n      }\n\n      const values = heatmapData.map((d) => d[2]);\n      const minValue = Math.min(...values, 0);\n      const maxValue = Math.max(...values, 100);\n\n      return {\n        title: title ? { text: title, subtext: subtitle, left: 'center' } : undefined,\n        tooltip: showTooltip ? {\n          position: 'top',\n          formatter: (params: any) => {\n            const [x, y, value] = params.value;\n            return `${xLabels[x] || x}, ${yLabels[y] || y}: ${value}`;\n          },\n        } : undefined,\n        grid: {\n          top: title ? 60 : 20,\n          bottom: 60,\n          left: 80,\n          right: 80,\n        },\n        xAxis: {\n          type: 'category',\n          data: xLabels,\n          splitArea: { show: true },\n        },\n        yAxis: {\n          type: 'category',\n          data: yLabels,\n          splitArea: { show: true },\n        },\n        visualMap: {\n          min: minValue,\n          max: maxValue,\n          calculable: true,\n          orient: 'horizontal',\n          left: 'center',\n          bottom: 10,\n          inRange: {\n            color: ['#f0f9ff', '#bae6fd', '#38bdf8', '#0284c7', '#075985'],\n          },\n        },\n        series: [\n          {\n            name: title || 'Heatmap',\n            type: 'heatmap',\n            data: heatmapData,\n            label: {\n              show: heatmapData.length <= 100,\n              formatter: (params: any) => params.value[2],\n            },\n            emphasis: {\n              itemStyle: {\n                shadowBlur: 10,\n                shadowColor: 'rgba(0, 0, 0, 0.5)',\n              },\n            },\n          },\n        ],\n      };\n    }\n\n    return {\n      title: { text: 'Unsupported chart type', left: 'center' },\n      series: [],\n    };\n  }, [type, title, subtitle, data, colors, showLegend, showTooltip, mapCenter, mapZoom]);\n\n  const chartHeight = typeof height === 'number' ? height : parseInt(height as string, 10) || 400;\n\n  const onEvents = useMemo(() => ({\n    click: handleDataClick,\n  }), [handleDataClick]);\n\n  return (\n    <div className={cn('w-full', className)} data-testid=\"echarts-chart\">\n      {(title || subtitle || enableExport) && (\n        <div className=\"flex items-start justify-between mb-4\">\n          <div>\n            {title && <h3 className=\"text-lg font-semibold text-foreground\" data-testid=\"chart-title\">{title}</h3>}\n            {subtitle && <p className=\"text-sm text-muted-foreground\" data-testid=\"chart-subtitle\">{subtitle}</p>}\n          </div>\n          {enableExport && (\n            <div className=\"flex items-center gap-1\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleExportPNG}\n                className=\"h-8 w-8 p-0\"\n                data-testid=\"button-export-png\"\n              >\n                <Image className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleExportSVG}\n                className=\"h-8 w-8 p-0\"\n                data-testid=\"button-export-svg\"\n              >\n                <FileCode className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          )}\n        </div>\n      )}\n\n      <div className=\"w-full\" style={{ height: chartHeight }} data-testid=\"chart-container\">\n        <ReactEChartsCore\n          ref={chartRef}\n          echarts={echarts}\n          option={option}\n          style={{ height: '100%', width: '100%' }}\n          opts={{ renderer: 'canvas' }}\n          onEvents={onEvents}\n          notMerge={true}\n          lazyUpdate={true}\n        />\n      </div>\n    </div>\n  );\n}\n\nexport default EChartsChartImpl;\n","path":null,"size_bytes":9549,"size_tokens":null},"client/src/hooks/useSandboxExecution.ts":{"content":"import { useState, useCallback } from \"react\";\nimport { executeInSandbox, type SandboxRunResult } from \"@/lib/sandboxApi\";\n\nexport interface UseSandboxExecutionReturn {\n  execute: (code: string, language: string, stdin?: string, args?: string[]) => Promise<void>;\n  isRunning: boolean;\n  result: SandboxRunResult | null;\n  error: string | null;\n  errorLines: number[];\n  reset: () => void;\n}\n\nexport function useSandboxExecution(): UseSandboxExecutionReturn {\n  const [isRunning, setIsRunning] = useState(false);\n  const [result, setResult] = useState<SandboxRunResult | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  const execute = useCallback(async (\n    code: string,\n    language: string,\n    stdin?: string,\n    args?: string[]\n  ): Promise<void> => {\n    setIsRunning(true);\n    setError(null);\n    setResult(null);\n\n    try {\n      const execResult = await executeInSandbox(code, language, stdin, args);\n      setResult(execResult);\n    } catch (err: any) {\n      const errorMessage = err?.message || \"Execution failed\";\n      setError(errorMessage);\n      setResult({\n        run: {\n          stdout: \"\",\n          stderr: errorMessage,\n          code: 1,\n          signal: null,\n          output: errorMessage,\n        },\n        errorLines: [],\n        language,\n        version: \"unknown\",\n        usedFallback: false,\n        artifacts: [],\n      });\n    } finally {\n      setIsRunning(false);\n    }\n  }, []);\n\n  const reset = useCallback(() => {\n    setIsRunning(false);\n    setResult(null);\n    setError(null);\n  }, []);\n\n  const errorLines = result?.errorLines?.map(e => e.line) || [];\n\n  return {\n    execute,\n    isRunning,\n    result,\n    error,\n    errorLines,\n    reset,\n  };\n}\n\nexport type { SandboxRunResult } from \"@/lib/sandboxApi\";\n","path":null,"size_bytes":1786,"size_tokens":null},"client/src/lib/sandboxApi.ts":{"content":"export interface SandboxRunOutput {\n  stdout: string;\n  stderr: string;\n  code: number;\n  signal: string | null;\n  output: string;\n}\n\nexport interface SandboxErrorLine {\n  line: number;\n  column?: number;\n  message?: string;\n}\n\nexport interface SandboxRunResult {\n  run: SandboxRunOutput;\n  compile?: SandboxRunOutput;\n  errorLines: SandboxErrorLine[];\n  language: string;\n  version: string;\n  usedFallback: boolean;\n  artifacts: Array<{\n    type: string;\n    name: string;\n    data: string;\n    mimeType: string;\n  }>;\n}\n\nexport interface SandboxRuntime {\n  language: string;\n  version: string;\n  aliases: string[];\n  runtime?: string;\n}\n\nexport interface SandboxRuntimes {\n  runtimes: SandboxRuntime[];\n  supportedLanguages: string[];\n  aliases: Record<string, string[]>;\n}\n\nconst RUNNABLE_LANGUAGES = new Set([\n  \"javascript\", \"js\", \"typescript\", \"ts\",\n  \"python\", \"py\", \"python3\",\n  \"go\", \"golang\",\n  \"rust\", \"rs\",\n  \"c\", \"cpp\", \"c++\",\n  \"java\",\n  \"ruby\", \"rb\",\n  \"php\",\n  \"swift\",\n  \"kotlin\", \"kt\",\n  \"scala\",\n  \"csharp\", \"cs\", \"c#\",\n  \"bash\", \"sh\",\n  \"perl\",\n  \"lua\",\n  \"r\",\n  \"haskell\", \"hs\",\n  \"elixir\", \"ex\",\n  \"clojure\", \"clj\",\n  \"fsharp\", \"f#\",\n  \"ocaml\", \"ml\",\n  \"dart\",\n  \"julia\", \"jl\",\n  \"nim\",\n  \"zig\",\n  \"crystal\",\n  \"d\",\n  \"erlang\",\n  \"fortran\",\n  \"pascal\",\n  \"prolog\",\n  \"racket\",\n  \"scheme\",\n  \"sql\", \"sqlite\",\n  \"cobol\",\n  \"awk\",\n  \"brainfuck\", \"bf\",\n  \"lisp\", \"commonlisp\",\n  \"powershell\", \"ps1\",\n]);\n\nlet cachedRuntimes: SandboxRuntimes | null = null;\nlet cacheTimestamp = 0;\nconst CACHE_TTL_MS = 5 * 60 * 1000;\n\nexport async function getSandboxRuntimes(): Promise<SandboxRuntimes> {\n  const now = Date.now();\n  if (cachedRuntimes && now - cacheTimestamp < CACHE_TTL_MS) {\n    return cachedRuntimes;\n  }\n\n  const response = await fetch(\"/api/sandbox/runtimes\");\n  \n  if (!response.ok) {\n    throw new Error(`Failed to fetch runtimes: ${response.status} ${response.statusText}`);\n  }\n\n  const data = await response.json();\n  cachedRuntimes = {\n    runtimes: data.runtimes || [],\n    supportedLanguages: data.supportedLanguages || [],\n    aliases: data.aliases || {},\n  };\n  cacheTimestamp = now;\n\n  return cachedRuntimes;\n}\n\nexport async function executeInSandbox(\n  code: string,\n  language: string,\n  stdin?: string,\n  args?: string[]\n): Promise<SandboxRunResult> {\n  const response = await fetch(\"/api/sandbox/execute\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      code,\n      language,\n      stdin,\n      args,\n    }),\n  });\n\n  if (!response.ok) {\n    const errorData = await response.json().catch(() => ({}));\n    throw new Error(errorData.error || `Execution failed: ${response.status}`);\n  }\n\n  const result = await response.json();\n  \n  return {\n    run: result.run || {\n      stdout: \"\",\n      stderr: \"\",\n      code: 0,\n      signal: null,\n      output: \"\",\n    },\n    compile: result.compile,\n    errorLines: result.errorLines || [],\n    language: result.language || language,\n    version: result.version || \"unknown\",\n    usedFallback: result.usedFallback || false,\n    artifacts: result.artifacts || [],\n  };\n}\n\nexport function isLanguageRunnable(language: string): boolean {\n  if (!language) return false;\n  return RUNNABLE_LANGUAGES.has(language.toLowerCase());\n}\n\nexport function normalizeLanguage(language: string): string {\n  const lang = language.toLowerCase().trim();\n  \n  const aliases: Record<string, string> = {\n    js: \"javascript\",\n    ts: \"typescript\",\n    py: \"python\",\n    python3: \"python\",\n    golang: \"go\",\n    rs: \"rust\",\n    rb: \"ruby\",\n    kt: \"kotlin\",\n    cs: \"csharp\",\n    \"c#\": \"csharp\",\n    \"c++\": \"cpp\",\n    sh: \"bash\",\n    hs: \"haskell\",\n    ex: \"elixir\",\n    clj: \"clojure\",\n    \"f#\": \"fsharp\",\n    ml: \"ocaml\",\n    jl: \"julia\",\n    bf: \"brainfuck\",\n    commonlisp: \"lisp\",\n    ps1: \"powershell\",\n    sqlite: \"sql\",\n  };\n\n  return aliases[lang] || lang;\n}\n","path":null,"size_bytes":3893,"size_tokens":null},"client/src/lib/syntaxHighlighter.ts":{"content":"import Prism from 'prismjs';\nimport 'prismjs/components/prism-core';\n\nconst languageAliases: Record<string, string> = {\n  'js': 'javascript',\n  'ts': 'typescript',\n  'py': 'python',\n  'rb': 'ruby',\n  'yml': 'yaml',\n  'sh': 'bash',\n  'shell': 'bash',\n  'zsh': 'bash',\n  'dockerfile': 'docker',\n  'md': 'markdown',\n  'htm': 'html',\n  'jsonc': 'json',\n  'tsx': 'tsx',\n  'jsx': 'jsx',\n  'c++': 'cpp',\n  'c#': 'csharp',\n  'cs': 'csharp',\n  'golang': 'go',\n  'rs': 'rust',\n  'kt': 'kotlin',\n  'tf': 'hcl',\n  'terraform': 'hcl',\n  'plaintext': 'text',\n  'txt': 'text',\n};\n\nconst loadedLanguages = new Set<string>(['javascript', 'css', 'markup', 'clike']);\nconst loadingPromises = new Map<string, Promise<void>>();\n\nconst languageDependencies: Record<string, string[]> = {\n  'typescript': ['javascript'],\n  'jsx': ['javascript'],\n  'tsx': ['javascript', 'jsx', 'typescript'],\n  'cpp': ['c'],\n  'csharp': ['clike'],\n  'java': ['clike'],\n  'kotlin': ['clike'],\n  'scala': ['java'],\n  'swift': ['clike'],\n  'objectivec': ['c'],\n  'php': ['markup', 'clike'],\n  'aspnet': ['markup', 'csharp'],\n  'scss': ['css'],\n  'sass': ['css'],\n  'less': ['css'],\n  'stylus': ['css'],\n  'pug': ['markup', 'javascript'],\n  'markdown': ['markup'],\n  'django': ['markup', 'python'],\n  'erb': ['markup', 'ruby'],\n  'handlebars': ['markup'],\n  'twig': ['markup'],\n  'velocity': ['markup'],\n};\n\nconst supportedLanguages = [\n  'javascript', 'typescript', 'python', 'java', 'c', 'cpp', 'csharp',\n  'go', 'rust', 'ruby', 'php', 'swift', 'kotlin', 'scala',\n  'html', 'css', 'scss', 'sass', 'less',\n  'json', 'yaml', 'xml', 'markdown',\n  'sql', 'graphql', 'bash', 'powershell',\n  'docker', 'nginx', 'apache',\n  'jsx', 'tsx', 'vue',\n  'perl', 'r', 'matlab', 'julia',\n  'haskell', 'elixir', 'erlang', 'clojure', 'lisp',\n  'lua', 'dart', 'objectivec',\n  'makefile', 'cmake', 'hcl',\n  'diff', 'git', 'ini', 'toml',\n  'regex', 'latex', 'text',\n];\n\nfunction resolveLanguage(lang: string): string {\n  const normalized = lang.toLowerCase().trim();\n  return languageAliases[normalized] || normalized;\n}\n\nasync function loadLanguageDependencies(lang: string): Promise<void> {\n  const deps = languageDependencies[lang];\n  if (deps) {\n    for (const dep of deps) {\n      await loadLanguage(dep);\n    }\n  }\n}\n\nexport async function loadLanguage(lang: string): Promise<boolean> {\n  const resolved = resolveLanguage(lang);\n  \n  if (resolved === 'text' || resolved === 'plaintext') {\n    return true;\n  }\n  \n  if (loadedLanguages.has(resolved)) {\n    return true;\n  }\n  \n  if (loadingPromises.has(resolved)) {\n    await loadingPromises.get(resolved);\n    return loadedLanguages.has(resolved);\n  }\n  \n  const loadPromise = (async () => {\n    try {\n      await loadLanguageDependencies(resolved);\n      \n      const langModule = await import(/* @vite-ignore */ `prismjs/components/prism-${resolved}.js`);\n      \n      if (langModule) {\n        loadedLanguages.add(resolved);\n      }\n    } catch (error) {\n      console.warn(`Failed to load Prism language: ${resolved}`, error);\n    } finally {\n      loadingPromises.delete(resolved);\n    }\n  })();\n  \n  loadingPromises.set(resolved, loadPromise);\n  await loadPromise;\n  \n  return loadedLanguages.has(resolved);\n}\n\nexport function highlightCode(code: string, language: string): string {\n  const resolved = resolveLanguage(language);\n  \n  if (resolved === 'text' || resolved === 'plaintext' || !code) {\n    return escapeHtml(code);\n  }\n  \n  const grammar = Prism.languages[resolved];\n  \n  if (!grammar) {\n    return escapeHtml(code);\n  }\n  \n  try {\n    return Prism.highlight(code, grammar, resolved);\n  } catch (error) {\n    console.warn(`Error highlighting code with language: ${resolved}`, error);\n    return escapeHtml(code);\n  }\n}\n\nexport async function highlightCodeAsync(code: string, language: string): Promise<string> {\n  const resolved = resolveLanguage(language);\n  \n  if (resolved === 'text' || resolved === 'plaintext' || !code) {\n    return escapeHtml(code);\n  }\n  \n  await loadLanguage(resolved);\n  return highlightCode(code, resolved);\n}\n\nexport function getSupportedLanguages(): string[] {\n  return [...supportedLanguages];\n}\n\nexport function getLoadedLanguages(): string[] {\n  return [...loadedLanguages];\n}\n\nexport function isLanguageLoaded(lang: string): boolean {\n  const resolved = resolveLanguage(lang);\n  return loadedLanguages.has(resolved) || resolved === 'text' || resolved === 'plaintext';\n}\n\nexport function getLanguageAlias(lang: string): string {\n  return resolveLanguage(lang);\n}\n\nfunction escapeHtml(text: string): string {\n  const htmlEscapes: Record<string, string> = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n  };\n  return text.replace(/[&<>\"']/g, (char) => htmlEscapes[char] || char);\n}\n\nexport { Prism };\n","path":null,"size_bytes":4785,"size_tokens":null},"client/src/components/code-block-shell.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { useAsyncHighlight } from \"@/hooks/useAsyncHighlight\";\nimport { useCodeAnnotations, type CodeAnnotation } from \"@/hooks/useCodeAnnotations\";\nimport { CodeAnnotationMarker } from \"./code-annotation-marker\";\nimport { CodeAnnotationTooltip } from \"./code-annotation-tooltip\";\nimport { CodeAnnotationSidebar } from \"./code-annotation-sidebar\";\nimport { CodeEditorModal } from \"./code-editor-modal\";\nimport {\n  Copy,\n  Check,\n  Play,\n  Edit3,\n  MessageSquare,\n  Loader2,\n  PanelRightOpen,\n  PanelRightClose,\n  Plus,\n} from \"lucide-react\";\n\ntype AnnotationType = 'info' | 'warning' | 'error' | 'explanation';\n\ninterface AnnotationFormState {\n  isOpen: boolean;\n  line: number;\n  content: string;\n  type: AnnotationType;\n}\n\nexport interface CodeBlockShellProps {\n  /** The code content to display */\n  code: string;\n  /** Programming language for syntax highlighting */\n  language?: string;\n  /** Show line numbers in the gutter */\n  showLineNumbers?: boolean;\n  /** Maximum height of the code container */\n  maxHeight?: string;\n  /** Line numbers to highlight as errors (red) */\n  errorLines?: number[];\n  /** Line numbers to highlight (yellow) */\n  highlightedLines?: number[];\n  /** Unique identifier for the code block, used for annotation persistence */\n  blockId?: string;\n  /** Enable annotation functionality */\n  enableAnnotations?: boolean;\n  /** Persist annotations to localStorage using blockId */\n  persistAnnotations?: boolean;\n  /** Show run button */\n  runnable?: boolean;\n  /** Show edit button and enable Monaco editor modal */\n  editable?: boolean;\n  /** Callback when code is copied */\n  onCopy?: () => void;\n  /** Callback when code is edited. Receives the new code string. If not provided, edits are stored in internal state. */\n  onEdit?: (newCode: string) => void;\n  /** Callback when run button is clicked */\n  onRun?: () => void;\n  /** Additional className for the container */\n  className?: string;\n}\n\nconst VIRTUALIZATION_THRESHOLD = 100;\nconst BUFFER_LINES = 10;\nconst LINE_HEIGHT = 22;\n\ninterface VirtualizedLinesProps {\n  lines: string[];\n  highlightedHtmlLines: string[];\n  errorLines: Set<number>;\n  highlightedLineSet: Set<number>;\n  annotations: Map<number, CodeAnnotation>;\n  showLineNumbers: boolean;\n  containerHeight: number;\n  onAddAnnotation?: (line: number) => void;\n  onEditAnnotation?: (id: string, content: string) => void;\n  onDeleteAnnotation?: (id: string) => void;\n  onMarkerClick?: (annotation: CodeAnnotation) => void;\n  annotationMode: boolean;\n}\n\nfunction VirtualizedLines({\n  lines,\n  highlightedHtmlLines,\n  errorLines,\n  highlightedLineSet,\n  annotations,\n  showLineNumbers,\n  containerHeight,\n  onAddAnnotation,\n  onEditAnnotation,\n  onDeleteAnnotation,\n  onMarkerClick,\n  annotationMode,\n}: VirtualizedLinesProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const [visibleRange, setVisibleRange] = useState({ start: 0, end: 50 });\n\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const handleScroll = () => {\n      const scrollTop = container.scrollTop;\n      const visibleLines = Math.ceil(containerHeight / LINE_HEIGHT);\n      const start = Math.max(0, Math.floor(scrollTop / LINE_HEIGHT) - BUFFER_LINES);\n      const end = Math.min(lines.length, start + visibleLines + BUFFER_LINES * 2);\n      setVisibleRange({ start, end });\n    };\n\n    handleScroll();\n    container.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => container.removeEventListener(\"scroll\", handleScroll);\n  }, [lines.length, containerHeight]);\n\n  const totalHeight = lines.length * LINE_HEIGHT;\n  const offsetTop = visibleRange.start * LINE_HEIGHT;\n\n  return (\n    <div\n      ref={containerRef}\n      className=\"overflow-auto\"\n      style={{ height: containerHeight, maxHeight: containerHeight }}\n      data-testid=\"code-virtualized-container\"\n    >\n      <div style={{ height: totalHeight, position: \"relative\" }}>\n        <div style={{ transform: `translateY(${offsetTop}px)` }}>\n          {lines.slice(visibleRange.start, visibleRange.end).map((_, idx) => {\n            const lineIndex = visibleRange.start + idx;\n            const lineNum = lineIndex + 1;\n            const isError = errorLines.has(lineNum);\n            const isHighlighted = highlightedLineSet.has(lineNum);\n            const annotation = annotations.get(lineNum);\n            const htmlLine = highlightedHtmlLines[lineIndex] || \"\";\n\n            return (\n              <LineRow\n                key={lineIndex}\n                lineNum={lineNum}\n                htmlLine={htmlLine}\n                isError={isError}\n                isHighlighted={isHighlighted}\n                annotation={annotation}\n                showLineNumbers={showLineNumbers}\n                annotationMode={annotationMode}\n                onAddAnnotation={onAddAnnotation}\n                onEditAnnotation={onEditAnnotation}\n                onDeleteAnnotation={onDeleteAnnotation}\n                onMarkerClick={onMarkerClick}\n              />\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n}\n\ninterface LineRowProps {\n  lineNum: number;\n  htmlLine: string;\n  isError: boolean;\n  isHighlighted: boolean;\n  annotation?: CodeAnnotation;\n  showLineNumbers: boolean;\n  annotationMode: boolean;\n  onAddAnnotation?: (line: number) => void;\n  onEditAnnotation?: (id: string, content: string) => void;\n  onDeleteAnnotation?: (id: string) => void;\n  onMarkerClick?: (annotation: CodeAnnotation) => void;\n}\n\nfunction LineRow({\n  lineNum,\n  htmlLine,\n  isError,\n  isHighlighted,\n  annotation,\n  showLineNumbers,\n  annotationMode,\n  onAddAnnotation,\n  onEditAnnotation,\n  onDeleteAnnotation,\n  onMarkerClick,\n}: LineRowProps) {\n  const handleLineClick = useCallback(() => {\n    if (annotationMode && onAddAnnotation && !annotation) {\n      onAddAnnotation(lineNum);\n    }\n  }, [annotationMode, onAddAnnotation, lineNum, annotation]);\n\n  const handleAnnotationClick = useCallback((ann: CodeAnnotation) => {\n    onMarkerClick?.(ann);\n  }, [onMarkerClick]);\n\n  const markerElement = (\n    <CodeAnnotationMarker\n      lineNumber={lineNum}\n      annotation={annotation}\n      onAddAnnotation={onAddAnnotation}\n      onAnnotationClick={handleAnnotationClick}\n      annotationMode={annotationMode}\n    />\n  );\n\n  return (\n    <div\n      className={cn(\n        \"flex group transition-colors duration-150\",\n        isError && \"bg-red-500/20 border-l-2 border-red-500\",\n        isHighlighted && !isError && \"bg-yellow-500/10 border-l-2 border-yellow-500\",\n        annotation && \"bg-blue-500/5\",\n        annotationMode && !annotation && \"cursor-pointer hover:bg-zinc-800/50\"\n      )}\n      style={{ height: LINE_HEIGHT, lineHeight: `${LINE_HEIGHT}px` }}\n      onClick={handleLineClick}\n      data-testid={`code-line-${lineNum}`}\n    >\n      {showLineNumbers && (\n        <div className=\"flex items-center\">\n          <span\n            className=\"select-none text-zinc-500 text-right pr-2 pl-2 min-w-[2.5rem] text-xs font-mono\"\n            data-testid={`line-number-${lineNum}`}\n          >\n            {lineNum}\n          </span>\n          <div className=\"w-5 flex items-center justify-center border-r border-zinc-800 pr-1\">\n            {annotation ? (\n              <CodeAnnotationTooltip\n                annotation={annotation}\n                onEdit={onEditAnnotation}\n                onDelete={onDeleteAnnotation}\n                trigger={markerElement}\n                side=\"right\"\n              />\n            ) : (\n              markerElement\n            )}\n          </div>\n        </div>\n      )}\n      <code\n        className=\"flex-1 px-4 text-sm font-mono whitespace-pre overflow-hidden text-ellipsis\"\n        dangerouslySetInnerHTML={{ __html: htmlLine || \"&nbsp;\" }}\n      />\n    </div>\n  );\n}\n\nexport function CodeBlockShell({\n  code,\n  language = \"text\",\n  showLineNumbers = true,\n  maxHeight = \"400px\",\n  errorLines = [],\n  highlightedLines = [],\n  blockId,\n  enableAnnotations = false,\n  persistAnnotations = false,\n  runnable = false,\n  editable = false,\n  onCopy,\n  onEdit,\n  onRun,\n  className,\n}: CodeBlockShellProps) {\n  const [copied, setCopied] = useState(false);\n  const [annotationMode, setAnnotationMode] = useState(false);\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [isEditorOpen, setIsEditorOpen] = useState(false);\n  const [editedCode, setEditedCode] = useState(code);\n  const [annotationForm, setAnnotationForm] = useState<AnnotationFormState>({\n    isOpen: false,\n    line: 0,\n    content: '',\n    type: 'info',\n  });\n  const codeContainerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    setEditedCode(code);\n  }, [code]);\n\n  const generatedBlockId = useMemo(() => {\n    return blockId || `code-block-${Math.random().toString(36).substring(2, 11)}`;\n  }, [blockId]);\n\n  const {\n    annotations,\n    addAnnotation,\n    updateAnnotation,\n    removeAnnotation,\n  } = useCodeAnnotations(generatedBlockId, persistAnnotations);\n\n  const displayCode = editedCode;\n  const { html, isLoading, error } = useAsyncHighlight(displayCode, language);\n\n  const openAnnotationForm = useCallback((line: number) => {\n    setAnnotationForm({\n      isOpen: true,\n      line,\n      content: '',\n      type: 'info',\n    });\n  }, []);\n\n  const closeAnnotationForm = useCallback(() => {\n    setAnnotationForm(prev => ({ ...prev, isOpen: false }));\n  }, []);\n\n  const submitAnnotation = useCallback(() => {\n    if (annotationForm.content.trim()) {\n      addAnnotation(annotationForm.line, annotationForm.content.trim(), annotationForm.type);\n    }\n    closeAnnotationForm();\n  }, [annotationForm, addAnnotation, closeAnnotationForm]);\n\n  const handleAddAnnotation = useCallback((line: number) => {\n    openAnnotationForm(line);\n  }, [openAnnotationForm]);\n\n  const lines = useMemo(() => displayCode.split(\"\\n\"), [displayCode]);\n  const lineCount = lines.length;\n  const shouldVirtualize = lineCount > VIRTUALIZATION_THRESHOLD;\n\n  const highlightedHtmlLines = useMemo(() => {\n    if (!html) return lines.map(() => \"\");\n    const tempDiv = document.createElement(\"div\");\n    tempDiv.innerHTML = html;\n    const text = tempDiv.innerHTML;\n    return text.split(\"\\n\");\n  }, [html, lines]);\n\n  const errorLineSet = useMemo(() => new Set(errorLines), [errorLines]);\n  const highlightedLineSet = useMemo(() => new Set(highlightedLines), [highlightedLines]);\n\n  const handleCopy = useCallback(async () => {\n    try {\n      await navigator.clipboard.writeText(displayCode);\n      setCopied(true);\n      onCopy?.();\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      console.error(\"Failed to copy:\", err);\n    }\n  }, [displayCode, onCopy]);\n\n  const handleEdit = useCallback(() => {\n    setIsEditorOpen(true);\n  }, []);\n\n  const handleSaveCode = useCallback((newCode: string) => {\n    setEditedCode(newCode);\n    if (onEdit) {\n      onEdit(newCode);\n    }\n  }, [onEdit]);\n\n  const handleRun = useCallback(() => {\n    onRun?.();\n  }, [onRun]);\n\n  const toggleAnnotationMode = useCallback(() => {\n    setAnnotationMode((prev) => {\n      const newMode = !prev;\n      if (newMode && annotations.size > 0) {\n        setSidebarOpen(true);\n      }\n      return newMode;\n    });\n  }, [annotations.size]);\n\n  const toggleSidebar = useCallback(() => {\n    setSidebarOpen((prev) => !prev);\n  }, []);\n\n  const containerHeightPx = useMemo(() => {\n    const parsed = parseInt(maxHeight, 10);\n    return isNaN(parsed) ? 400 : parsed;\n  }, [maxHeight]);\n\n  const scrollToLine = useCallback((lineNum: number) => {\n    const container = codeContainerRef.current;\n    if (!container) return;\n    \n    const targetScrollTop = (lineNum - 1) * LINE_HEIGHT;\n    container.scrollTo({\n      top: Math.max(0, targetScrollTop - containerHeightPx / 3),\n      behavior: \"smooth\",\n    });\n\n    const lineElement = container.querySelector(`[data-testid=\"code-line-${lineNum}\"]`);\n    if (lineElement) {\n      lineElement.classList.add(\"ring-2\", \"ring-blue-500/50\");\n      setTimeout(() => {\n        lineElement.classList.remove(\"ring-2\", \"ring-blue-500/50\");\n      }, 2000);\n    }\n  }, [containerHeightPx]);\n\n  const handleSidebarAnnotationClick = useCallback((annotation: CodeAnnotation) => {\n    scrollToLine(annotation.line);\n  }, [scrollToLine]);\n\n  const handleMarkerClick = useCallback((annotation: CodeAnnotation) => {\n    if (!sidebarOpen) {\n      setSidebarOpen(true);\n    }\n  }, [sidebarOpen]);\n\n  const annotationsArray = useMemo(() => Array.from(annotations.values()), [annotations]);\n\n  return (\n    <div\n      className={cn(\n        \"rounded-lg border border-zinc-800 bg-zinc-950 overflow-hidden\",\n        className\n      )}\n      data-testid=\"code-block-shell\"\n    >\n      <div\n        className=\"flex items-center justify-between px-3 py-2 bg-zinc-900 border-b border-zinc-800\"\n        data-testid=\"code-block-toolbar\"\n      >\n        <div className=\"flex items-center gap-2\">\n          <span className=\"text-xs text-zinc-400 font-mono uppercase tracking-wide\">\n            {language}\n          </span>\n          <span className=\"text-xs text-zinc-600\">\n            {lineCount} {lineCount === 1 ? \"line\" : \"lines\"}\n          </span>\n        </div>\n\n        <div className=\"flex items-center gap-1\">\n          {enableAnnotations && (\n            <>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className={cn(\n                  \"h-7 w-7 p-0 text-zinc-400 hover:text-white hover:bg-zinc-800\",\n                  annotationMode && \"text-blue-400 bg-blue-500/10\"\n                )}\n                onClick={toggleAnnotationMode}\n                data-testid=\"button-annotate\"\n                title=\"Toggle annotation mode\"\n              >\n                <MessageSquare className=\"w-3.5 h-3.5\" />\n              </Button>\n              {annotationsArray.length > 0 && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className={cn(\n                    \"h-7 w-7 p-0 text-zinc-400 hover:text-white hover:bg-zinc-800\",\n                    sidebarOpen && \"text-blue-400 bg-blue-500/10\"\n                  )}\n                  onClick={toggleSidebar}\n                  data-testid=\"button-toggle-sidebar\"\n                  title=\"Toggle annotations sidebar\"\n                >\n                  {sidebarOpen ? (\n                    <PanelRightClose className=\"w-3.5 h-3.5\" />\n                  ) : (\n                    <PanelRightOpen className=\"w-3.5 h-3.5\" />\n                  )}\n                </Button>\n              )}\n            </>\n          )}\n\n          {editable && onEdit && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-7 w-7 p-0 text-zinc-400 hover:text-white hover:bg-zinc-800\"\n              onClick={handleEdit}\n              data-testid=\"button-edit\"\n              title=\"Edit code\"\n            >\n              <Edit3 className=\"w-3.5 h-3.5\" />\n            </Button>\n          )}\n\n          {runnable && onRun && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-7 w-7 p-0 text-zinc-400 hover:text-emerald-400 hover:bg-emerald-500/10\"\n              onClick={handleRun}\n              data-testid=\"button-run\"\n              title=\"Run code\"\n            >\n              <Play className=\"w-3.5 h-3.5\" />\n            </Button>\n          )}\n\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"h-7 w-7 p-0 text-zinc-400 hover:text-white hover:bg-zinc-800\"\n            onClick={handleCopy}\n            data-testid=\"button-copy\"\n            title=\"Copy code\"\n          >\n            {copied ? (\n              <Check className=\"w-3.5 h-3.5 text-green-400\" />\n            ) : (\n              <Copy className=\"w-3.5 h-3.5\" />\n            )}\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"relative\">\n        {isLoading && (\n          <div\n            className=\"absolute inset-0 flex items-center justify-center bg-zinc-950/80 z-10\"\n            data-testid=\"code-loading\"\n          >\n            <Loader2 className=\"w-5 h-5 text-zinc-400 animate-spin\" />\n          </div>\n        )}\n\n        {error && (\n          <div\n            className=\"absolute top-2 right-2 text-xs text-amber-400 bg-amber-500/10 px-2 py-1 rounded\"\n            data-testid=\"code-error\"\n          >\n            Syntax highlighting unavailable\n          </div>\n        )}\n\n        <div className=\"flex\">\n          <div className={cn(\"flex-1 min-w-0\", sidebarOpen && enableAnnotations && \"max-w-[70%]\")}>\n            {shouldVirtualize ? (\n              <VirtualizedLines\n                lines={lines}\n                highlightedHtmlLines={highlightedHtmlLines}\n                errorLines={errorLineSet}\n                highlightedLineSet={highlightedLineSet}\n                annotations={annotations}\n                showLineNumbers={showLineNumbers}\n                containerHeight={containerHeightPx}\n                onAddAnnotation={enableAnnotations ? handleAddAnnotation : undefined}\n                onEditAnnotation={enableAnnotations ? updateAnnotation : undefined}\n                onDeleteAnnotation={enableAnnotations ? removeAnnotation : undefined}\n                onMarkerClick={enableAnnotations ? handleMarkerClick : undefined}\n                annotationMode={annotationMode}\n              />\n            ) : (\n              <div\n                ref={codeContainerRef}\n                className=\"overflow-auto text-zinc-100\"\n                style={{ maxHeight }}\n                data-testid=\"code-container\"\n              >\n                {lines.map((_, lineIndex) => {\n                  const lineNum = lineIndex + 1;\n                  const isError = errorLineSet.has(lineNum);\n                  const isHighlighted = highlightedLineSet.has(lineNum);\n                  const annotation = annotations.get(lineNum);\n                  const htmlLine = highlightedHtmlLines[lineIndex] || \"\";\n\n                  return (\n                    <LineRow\n                      key={lineIndex}\n                      lineNum={lineNum}\n                      htmlLine={htmlLine}\n                      isError={isError}\n                      isHighlighted={isHighlighted}\n                      annotation={annotation}\n                      showLineNumbers={showLineNumbers}\n                      annotationMode={annotationMode}\n                      onAddAnnotation={enableAnnotations ? handleAddAnnotation : undefined}\n                      onEditAnnotation={enableAnnotations ? updateAnnotation : undefined}\n                      onDeleteAnnotation={enableAnnotations ? removeAnnotation : undefined}\n                      onMarkerClick={enableAnnotations ? handleMarkerClick : undefined}\n                    />\n                  );\n                })}\n              </div>\n            )}\n          </div>\n\n          {enableAnnotations && sidebarOpen && (\n            <div className=\"w-[30%] min-w-[200px] max-w-[300px]\" style={{ height: maxHeight }}>\n              <CodeAnnotationSidebar\n                annotations={annotationsArray}\n                onAnnotationClick={handleSidebarAnnotationClick}\n                onEdit={updateAnnotation}\n                onDelete={removeAnnotation}\n                isOpen={true}\n                onToggle={toggleSidebar}\n              />\n            </div>\n          )}\n        </div>\n      </div>\n\n      {editable && (\n        <CodeEditorModal\n          open={isEditorOpen}\n          onOpenChange={setIsEditorOpen}\n          code={displayCode}\n          language={language}\n          title={`Edit ${language.charAt(0).toUpperCase() + language.slice(1)} Code`}\n          onSave={handleSaveCode}\n        />\n      )}\n\n      {enableAnnotations && (\n        <Dialog open={annotationForm.isOpen} onOpenChange={(open) => !open && closeAnnotationForm()}>\n          <DialogContent\n            className=\"max-w-sm bg-zinc-900 border-zinc-700\"\n            data-testid=\"annotation-dialog\"\n          >\n            <DialogHeader>\n              <DialogTitle className=\"text-zinc-100\">\n                Add Annotation (Line {annotationForm.line})\n              </DialogTitle>\n            </DialogHeader>\n\n            <div className=\"space-y-4 py-2\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"annotation-type\" className=\"text-xs text-zinc-400\">\n                  Type\n                </Label>\n                <Select\n                  value={annotationForm.type}\n                  onValueChange={(value: AnnotationType) =>\n                    setAnnotationForm(prev => ({ ...prev, type: value }))\n                  }\n                >\n                  <SelectTrigger\n                    id=\"annotation-type\"\n                    className=\"bg-zinc-800 border-zinc-700 text-zinc-200\"\n                    data-testid=\"select-annotation-type\"\n                  >\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent className=\"bg-zinc-800 border-zinc-700\">\n                    <SelectItem value=\"info\" className=\"text-blue-400\">\n                      ℹ️ Info\n                    </SelectItem>\n                    <SelectItem value=\"warning\" className=\"text-yellow-400\">\n                      ⚠️ Warning\n                    </SelectItem>\n                    <SelectItem value=\"error\" className=\"text-red-400\">\n                      ❌ Error\n                    </SelectItem>\n                    <SelectItem value=\"explanation\" className=\"text-green-400\">\n                      💡 Explanation\n                    </SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"annotation-content\" className=\"text-xs text-zinc-400\">\n                  Content\n                </Label>\n                <Textarea\n                  id=\"annotation-content\"\n                  value={annotationForm.content}\n                  onChange={(e) =>\n                    setAnnotationForm(prev => ({ ...prev, content: e.target.value }))\n                  }\n                  placeholder=\"Enter your annotation...\"\n                  className=\"bg-zinc-800 border-zinc-700 text-zinc-200 placeholder:text-zinc-500 min-h-[100px] resize-none\"\n                  data-testid=\"textarea-annotation-content\"\n                  autoFocus\n                />\n              </div>\n            </div>\n\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={closeAnnotationForm}\n                className=\"border-zinc-700 text-zinc-300 hover:bg-zinc-800\"\n                data-testid=\"button-cancel-annotation\"\n              >\n                Cancel\n              </Button>\n              <Button\n                size=\"sm\"\n                onClick={submitAnnotation}\n                disabled={!annotationForm.content.trim()}\n                className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n                data-testid=\"button-submit-annotation\"\n              >\n                <Plus className=\"w-3.5 h-3.5 mr-1\" />\n                Add\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      )}\n    </div>\n  );\n}\n\nexport default CodeBlockShell;\n","path":null,"size_bytes":23787,"size_tokens":null},"client/src/graphics/canvas/canvas-utils.ts":{"content":"export function exportCanvasAsPNG(canvas: HTMLCanvasElement): Promise<Blob> {\n  return new Promise((resolve, reject) => {\n    canvas.toBlob((blob) => {\n      if (blob) {\n        resolve(blob);\n      } else {\n        reject(new Error('Failed to export canvas as PNG'));\n      }\n    }, 'image/png');\n  });\n}\n\nexport function exportCanvasAsJPEG(canvas: HTMLCanvasElement, quality: number = 0.92): Promise<Blob> {\n  return new Promise((resolve, reject) => {\n    canvas.toBlob((blob) => {\n      if (blob) {\n        resolve(blob);\n      } else {\n        reject(new Error('Failed to export canvas as JPEG'));\n      }\n    }, 'image/jpeg', quality);\n  });\n}\n\nexport function downloadCanvas(\n  canvas: HTMLCanvasElement, \n  filename: string, \n  format: 'png' | 'jpeg' = 'png'\n): void {\n  const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';\n  const extension = format === 'jpeg' ? '.jpg' : '.png';\n  \n  canvas.toBlob((blob) => {\n    if (!blob) return;\n    \n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename.endsWith(extension) ? filename : `${filename}${extension}`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  }, mimeType, format === 'jpeg' ? 0.92 : undefined);\n}\n\nexport function clearCanvas(ctx: CanvasRenderingContext2D, color?: string): void {\n  const canvas = ctx.canvas;\n  \n  if (color) {\n    ctx.fillStyle = color;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n  } else {\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n  }\n}\n\nexport function setupHiDPICanvas(\n  canvas: HTMLCanvasElement, \n  ctx: CanvasRenderingContext2D, \n  width: number, \n  height: number\n): void {\n  const dpr = window.devicePixelRatio || 1;\n  \n  canvas.width = width * dpr;\n  canvas.height = height * dpr;\n  canvas.style.width = `${width}px`;\n  canvas.style.height = `${height}px`;\n  \n  ctx.scale(dpr, dpr);\n}\n\nexport function getDevicePixelRatio(): number {\n  return window.devicePixelRatio || 1;\n}\n\nexport function createOffscreenCanvas(width: number, height: number): HTMLCanvasElement {\n  const canvas = document.createElement('canvas');\n  canvas.width = width;\n  canvas.height = height;\n  return canvas;\n}\n","path":null,"size_bytes":2276,"size_tokens":null},"client/src/graphics/canvas/index.ts":{"content":"export { CanvasEngine, type CanvasEngineRef } from './canvas-engine';\nexport {\n  exportCanvasAsPNG,\n  exportCanvasAsJPEG,\n  downloadCanvas,\n  clearCanvas,\n  setupHiDPICanvas,\n  getDevicePixelRatio,\n  createOffscreenCanvas,\n} from './canvas-utils';\n","path":null,"size_bytes":248,"size_tokens":null},"client/src/graphics/three/three-engine-impl.tsx":{"content":"import { useRef, useEffect, useCallback, forwardRef, useImperativeHandle } from 'react';\nimport * as THREE from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\nimport type { WebGLConfig } from '@shared/schemas/graphics';\n\nexport interface ThreeEngineRef {\n  getScene: () => THREE.Scene | null;\n  getCamera: () => THREE.Camera | null;\n  getRenderer: () => THREE.WebGLRenderer | null;\n  exportPNG: () => Promise<Blob>;\n  loadModel: (url: string, format?: 'gltf' | 'glb') => Promise<THREE.Group>;\n  dispose: () => void;\n}\n\ninterface ThreeEngineImplProps {\n  config: WebGLConfig;\n  className?: string;\n  onReady?: (scene: THREE.Scene, camera: THREE.Camera, renderer: THREE.WebGLRenderer) => void;\n  onFrame?: (scene: THREE.Scene, camera: THREE.Camera, deltaTime: number) => void;\n}\n\nexport const ThreeEngineImpl = forwardRef<ThreeEngineRef, ThreeEngineImplProps>(\n  function ThreeEngineImpl({ config, className, onReady, onFrame }, ref) {\n    const containerRef = useRef<HTMLDivElement>(null);\n    const sceneRef = useRef<THREE.Scene | null>(null);\n    const cameraRef = useRef<THREE.PerspectiveCamera | null>(null);\n    const rendererRef = useRef<THREE.WebGLRenderer | null>(null);\n    const controlsRef = useRef<OrbitControls | null>(null);\n    const animationFrameRef = useRef<number>(0);\n    const clockRef = useRef<THREE.Clock>(new THREE.Clock());\n    const isRunningRef = useRef<boolean>(false);\n\n    const getNumericDimension = useCallback((value: number | string | undefined, fallback: number): number => {\n      if (value === undefined) return fallback;\n      if (typeof value === 'number') return value;\n      const parsed = parseFloat(value);\n      return isNaN(parsed) ? fallback : parsed;\n    }, []);\n\n    const width = getNumericDimension(config.width, 800);\n    const height = getNumericDimension(config.height, 600);\n\n    const setupLighting = useCallback((scene: THREE.Scene) => {\n      switch (config.lighting) {\n        case 'ambient':\n          scene.add(new THREE.AmbientLight(0xffffff, 0.8));\n          break;\n        case 'directional':\n          const dirLight = new THREE.DirectionalLight(0xffffff, 1);\n          dirLight.position.set(5, 10, 7.5);\n          dirLight.castShadow = true;\n          scene.add(dirLight);\n          scene.add(new THREE.AmbientLight(0xffffff, 0.3));\n          break;\n        case 'point':\n          const pointLight = new THREE.PointLight(0xffffff, 1, 100);\n          pointLight.position.set(0, 10, 0);\n          scene.add(pointLight);\n          scene.add(new THREE.AmbientLight(0xffffff, 0.3));\n          break;\n        case 'custom':\n          break;\n        default:\n          scene.add(new THREE.AmbientLight(0xffffff, 0.5));\n          const defaultDirLight = new THREE.DirectionalLight(0xffffff, 0.8);\n          defaultDirLight.position.set(5, 10, 7.5);\n          scene.add(defaultDirLight);\n      }\n    }, [config.lighting]);\n\n    const loadGLTFModel = useCallback(async (url: string): Promise<THREE.Group> => {\n      return new Promise((resolve, reject) => {\n        const loader = new GLTFLoader();\n        loader.load(\n          url,\n          (gltf) => {\n            const model = gltf.scene;\n            if (sceneRef.current) {\n              sceneRef.current.add(model);\n            }\n            resolve(model);\n          },\n          undefined,\n          (error) => {\n            reject(error);\n          }\n        );\n      });\n    }, []);\n\n    useImperativeHandle(ref, () => ({\n      getScene: () => sceneRef.current,\n      getCamera: () => cameraRef.current,\n      getRenderer: () => rendererRef.current,\n      exportPNG: async () => {\n        const renderer = rendererRef.current;\n        const scene = sceneRef.current;\n        const camera = cameraRef.current;\n        if (!renderer || !scene || !camera) {\n          return Promise.reject(new Error('Renderer not available'));\n        }\n        renderer.render(scene, camera);\n        return new Promise((resolve, reject) => {\n          renderer.domElement.toBlob((blob) => {\n            if (blob) {\n              resolve(blob);\n            } else {\n              reject(new Error('Failed to export canvas'));\n            }\n          }, 'image/png');\n        });\n      },\n      loadModel: loadGLTFModel,\n      dispose: () => {\n        isRunningRef.current = false;\n        if (animationFrameRef.current) {\n          cancelAnimationFrame(animationFrameRef.current);\n        }\n        if (controlsRef.current) {\n          controlsRef.current.dispose();\n        }\n        if (rendererRef.current) {\n          rendererRef.current.dispose();\n        }\n        if (sceneRef.current) {\n          sceneRef.current.traverse((object) => {\n            if (object instanceof THREE.Mesh) {\n              object.geometry.dispose();\n              if (Array.isArray(object.material)) {\n                object.material.forEach((mat) => mat.dispose());\n              } else {\n                object.material.dispose();\n              }\n            }\n          });\n        }\n      },\n    }), [loadGLTFModel]);\n\n    useEffect(() => {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const scene = new THREE.Scene();\n      sceneRef.current = scene;\n\n      if (config.background) {\n        scene.background = new THREE.Color(config.background);\n      }\n\n      const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);\n      camera.position.set(0, 2, 5);\n      cameraRef.current = camera;\n\n      const renderer = new THREE.WebGLRenderer({\n        antialias: true,\n        alpha: !config.background,\n        preserveDrawingBuffer: config.exportable !== false,\n      });\n      renderer.setSize(width, height);\n      renderer.setPixelRatio(window.devicePixelRatio);\n      renderer.shadowMap.enabled = true;\n      renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n      rendererRef.current = renderer;\n\n      container.appendChild(renderer.domElement);\n\n      setupLighting(scene);\n\n      if (config.enableOrbitControls) {\n        const controls = new OrbitControls(camera, renderer.domElement);\n        controls.enableDamping = true;\n        controls.dampingFactor = 0.05;\n        controls.screenSpacePanning = false;\n        controls.minDistance = 1;\n        controls.maxDistance = 100;\n        controls.maxPolarAngle = Math.PI / 2;\n        controlsRef.current = controls;\n      }\n\n      if (config.modelUrl) {\n        loadGLTFModel(config.modelUrl).catch(console.error);\n      }\n\n      if (onReady) {\n        onReady(scene, camera, renderer);\n      }\n\n      const clock = clockRef.current;\n      clock.start();\n\n      const animate = () => {\n        if (!isRunningRef.current) return;\n\n        animationFrameRef.current = requestAnimationFrame(animate);\n        const deltaTime = clock.getDelta();\n\n        if (controlsRef.current) {\n          controlsRef.current.update();\n        }\n\n        if (onFrame && sceneRef.current && cameraRef.current) {\n          onFrame(sceneRef.current, cameraRef.current, deltaTime);\n        }\n\n        if (rendererRef.current && sceneRef.current && cameraRef.current) {\n          rendererRef.current.render(sceneRef.current, cameraRef.current);\n        }\n      };\n\n      isRunningRef.current = true;\n      animate();\n\n      return () => {\n        isRunningRef.current = false;\n        if (animationFrameRef.current) {\n          cancelAnimationFrame(animationFrameRef.current);\n        }\n        if (controlsRef.current) {\n          controlsRef.current.dispose();\n        }\n        if (renderer.domElement.parentNode) {\n          renderer.domElement.parentNode.removeChild(renderer.domElement);\n        }\n        renderer.dispose();\n        scene.traverse((object) => {\n          if (object instanceof THREE.Mesh) {\n            object.geometry.dispose();\n            if (Array.isArray(object.material)) {\n              object.material.forEach((mat) => mat.dispose());\n            } else {\n              object.material.dispose();\n            }\n          }\n        });\n      };\n    }, [width, height, config.background, config.enableOrbitControls, config.modelUrl, config.exportable, setupLighting, loadGLTFModel, onReady, onFrame]);\n\n    useEffect(() => {\n      if (!config.responsive) return;\n\n      const container = containerRef.current;\n      if (!container) return;\n\n      const resizeObserver = new ResizeObserver((entries) => {\n        for (const entry of entries) {\n          const { width: newWidth, height: newHeight } = entry.contentRect;\n          if (newWidth > 0 && newHeight > 0) {\n            if (cameraRef.current) {\n              cameraRef.current.aspect = newWidth / newHeight;\n              cameraRef.current.updateProjectionMatrix();\n            }\n            if (rendererRef.current) {\n              rendererRef.current.setSize(newWidth, newHeight);\n            }\n          }\n        }\n      });\n\n      resizeObserver.observe(container);\n\n      return () => {\n        resizeObserver.disconnect();\n      };\n    }, [config.responsive]);\n\n    return (\n      <div\n        ref={containerRef}\n        className={className}\n        data-testid={`three-engine-${config.id}`}\n        style={{\n          width: config.responsive ? '100%' : width,\n          height: config.responsive ? '100%' : height,\n          display: 'block',\n        }}\n      />\n    );\n  }\n);\n\nexport default ThreeEngineImpl;\n","path":null,"size_bytes":9393,"size_tokens":null},"client/src/components/charts/echarts-chart.tsx":{"content":"import React, { Suspense } from 'react';\nimport { Spinner } from '@/components/ui/spinner';\nimport { cn } from '@/lib/utils';\nimport type { ChartConfig } from '@shared/schemas/visualization';\n\nexport interface EChartsChartProps {\n  config: ChartConfig;\n  className?: string;\n  onDataClick?: (data: any) => void;\n}\n\nconst EChartsChartLazy = React.lazy(() => import('./echarts-chart-impl'));\n\nfunction ChartLoadingState({ className }: { className?: string }) {\n  return (\n    <div \n      className={cn(\n        'w-full flex items-center justify-center bg-muted/20 rounded-lg border border-border',\n        className\n      )}\n      style={{ minHeight: 400 }}\n      data-testid=\"chart-loading\"\n    >\n      <div className=\"flex flex-col items-center gap-3\">\n        <Spinner className=\"h-8 w-8 text-primary\" />\n        <p className=\"text-sm text-muted-foreground\">Loading chart...</p>\n      </div>\n    </div>\n  );\n}\n\nfunction ChartErrorBoundary({ children }: { children: React.ReactNode }) {\n  const [hasError, setHasError] = React.useState(false);\n  const [error, setError] = React.useState<Error | null>(null);\n\n  React.useEffect(() => {\n    const handleError = (event: ErrorEvent) => {\n      if (event.message.includes('echarts')) {\n        setHasError(true);\n        setError(new Error(event.message));\n      }\n    };\n    window.addEventListener('error', handleError);\n    return () => window.removeEventListener('error', handleError);\n  }, []);\n\n  if (hasError) {\n    return (\n      <div \n        className=\"w-full flex items-center justify-center bg-destructive/10 rounded-lg border border-destructive/30 p-6\"\n        style={{ minHeight: 400 }}\n        data-testid=\"chart-error\"\n      >\n        <div className=\"flex flex-col items-center gap-3 text-center\">\n          <p className=\"text-sm font-medium text-destructive\">Failed to load chart</p>\n          <p className=\"text-xs text-muted-foreground max-w-md\">\n            {error?.message || 'An error occurred while loading the chart component.'}\n          </p>\n          <button\n            onClick={() => {\n              setHasError(false);\n              setError(null);\n            }}\n            className=\"text-xs text-primary hover:underline\"\n            data-testid=\"button-retry\"\n          >\n            Try again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return <>{children}</>;\n}\n\nexport function EChartsChart(props: EChartsChartProps) {\n  return (\n    <ChartErrorBoundary>\n      <Suspense fallback={<ChartLoadingState className={props.className} />}>\n        <EChartsChartLazy {...props} />\n      </Suspense>\n    </ChartErrorBoundary>\n  );\n}\n\nexport type { ChartConfig };\n","path":null,"size_bytes":2654,"size_tokens":null},"client/src/graphics/svg/index.ts":{"content":"export { SVGRenderer } from './svg-renderer';\nexport type { SVGRendererProps } from './svg-renderer';\n\nexport {\n  sanitizeSVG,\n  exportSVGAsString,\n  exportSVGAsPNG,\n  downloadBlob,\n  downloadSVG,\n  downloadPNG,\n} from './svg-utils';\n","path":null,"size_bytes":234,"size_tokens":null},"client/src/graphics/three/three-engine.tsx":{"content":"import React, { Suspense, lazy, useMemo } from 'react';\nimport { detectCapabilities, type WebGLConfig, type Canvas2DConfig } from '@shared/schemas/graphics';\nimport { CanvasEngine, type CanvasEngineRef } from '../canvas';\nimport type { ThreeEngineRef } from './three-engine-impl';\nimport * as THREE from 'three';\n\nconst ThreeEngineImpl = lazy(() => import('./three-engine-impl'));\n\ninterface ThreeEngineProps {\n  config: WebGLConfig;\n  className?: string;\n  onReady?: (scene: THREE.Scene, camera: THREE.Camera, renderer: THREE.WebGLRenderer) => void;\n  onFrame?: (scene: THREE.Scene, camera: THREE.Camera, deltaTime: number) => void;\n  ref?: React.Ref<ThreeEngineRef | CanvasEngineRef>;\n}\n\nfunction LoadingState({ width, height }: { width: number | string; height: number | string }) {\n  const w = typeof width === 'number' ? `${width}px` : width;\n  const h = typeof height === 'number' ? `${height}px` : height;\n\n  return (\n    <div\n      data-testid=\"three-engine-loading\"\n      style={{\n        width: w,\n        height: h,\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n        backgroundColor: '#1a1a2e',\n        color: '#ffffff',\n      }}\n    >\n      <div style={{ textAlign: 'center' }}>\n        <div\n          style={{\n            width: '40px',\n            height: '40px',\n            border: '3px solid rgba(255,255,255,0.3)',\n            borderTop: '3px solid #ffffff',\n            borderRadius: '50%',\n            margin: '0 auto 12px',\n            animation: 'spin 1s linear infinite',\n          }}\n        />\n        <style>\n          {`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}\n        </style>\n        <span>Loading 3D Engine...</span>\n      </div>\n    </div>\n  );\n}\n\nfunction WebGLNotSupported({ width, height }: { width: number | string; height: number | string }) {\n  const w = typeof width === 'number' ? `${width}px` : width;\n  const h = typeof height === 'number' ? `${height}px` : height;\n\n  return (\n    <div\n      data-testid=\"three-engine-unsupported\"\n      style={{\n        width: w,\n        height: h,\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n        backgroundColor: '#2d2d2d',\n        color: '#ffffff',\n        padding: '20px',\n        textAlign: 'center',\n      }}\n    >\n      <div>\n        <p style={{ marginBottom: '8px', fontWeight: 'bold' }}>WebGL Not Supported</p>\n        <p style={{ fontSize: '14px', opacity: 0.8 }}>\n          Your browser or device does not support WebGL rendering.\n        </p>\n      </div>\n    </div>\n  );\n}\n\nexport const ThreeEngine = React.forwardRef<ThreeEngineRef | CanvasEngineRef, ThreeEngineProps>(\n  function ThreeEngine({ config, className, onReady, onFrame }, ref) {\n    const capabilities = useMemo(() => detectCapabilities(), []);\n\n    const width = config.width ?? 800;\n    const height = config.height ?? 600;\n\n    if (!capabilities.webgl) {\n      if (config.fallbackMode === 'canvas2d') {\n        const canvas2DConfig: Canvas2DConfig = {\n          id: config.id,\n          mode: 'canvas2d',\n          width: config.width,\n          height: config.height,\n          responsive: config.responsive,\n          background: config.background,\n          exportable: config.exportable,\n          animationLoop: true,\n        };\n        return (\n          <CanvasEngine\n            ref={ref as React.Ref<CanvasEngineRef>}\n            config={canvas2DConfig}\n            className={className}\n          />\n        );\n      }\n\n      if (config.fallbackMode === 'none') {\n        return <WebGLNotSupported width={width} height={height} />;\n      }\n\n      return <WebGLNotSupported width={width} height={height} />;\n    }\n\n    return (\n      <Suspense fallback={<LoadingState width={width} height={height} />}>\n        <ThreeEngineImpl\n          ref={ref as React.Ref<ThreeEngineRef>}\n          config={config}\n          className={className}\n          onReady={onReady}\n          onFrame={onFrame}\n        />\n      </Suspense>\n    );\n  }\n);\n\nexport default ThreeEngine;\n","path":null,"size_bytes":4070,"size_tokens":null},"client/src/components/charts/smart-table.tsx":{"content":"import { useState, useMemo, useRef, useCallback, useEffect } from 'react';\nimport {\n  useReactTable,\n  getCoreRowModel,\n  getSortedRowModel,\n  getFilteredRowModel,\n  getPaginationRowModel,\n  flexRender,\n  createColumnHelper,\n  SortingState,\n  ColumnFiltersState,\n  RowSelectionState,\n  Row,\n} from '@tanstack/react-table';\nimport { useVirtualizer } from '@tanstack/react-virtual';\nimport { TableConfig, ColumnDef as ColumnDefConfig, ColumnType } from '@shared/schemas/visualization';\nimport { cn } from '@/lib/utils';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  ChevronUp,\n  ChevronDown,\n  ChevronsUpDown,\n  ChevronLeft,\n  ChevronRight,\n  ChevronsLeft,\n  ChevronsRight,\n  Search,\n  X,\n} from 'lucide-react';\n\nexport interface SmartTableProps {\n  config: TableConfig;\n  className?: string;\n  onRowClick?: (row: any) => void;\n}\n\nfunction formatCellValue(value: any, type: ColumnType, format?: string): string {\n  if (value === null || value === undefined) return '-';\n  \n  switch (type) {\n    case 'number':\n      return typeof value === 'number' ? value.toLocaleString() : String(value);\n    case 'currency':\n      return typeof value === 'number' \n        ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value)\n        : String(value);\n    case 'date':\n      try {\n        return new Date(value).toLocaleDateString();\n      } catch {\n        return String(value);\n      }\n    case 'boolean':\n      return value ? 'Yes' : 'No';\n    default:\n      return String(value);\n  }\n}\n\ninterface ColumnFilterProps {\n  column: any;\n  columnDef: ColumnDefConfig;\n}\n\nfunction ColumnFilter({ column, columnDef }: ColumnFilterProps) {\n  const filterValue = column.getFilterValue();\n\n  switch (columnDef.type) {\n    case 'number':\n    case 'currency':\n      return (\n        <div className=\"flex gap-1\" data-testid={`filter-number-${columnDef.id}`}>\n          <Input\n            type=\"number\"\n            placeholder=\"Min\"\n            value={(filterValue as [number, number])?.[0] ?? ''}\n            onChange={(e) => {\n              const val = e.target.value ? Number(e.target.value) : undefined;\n              column.setFilterValue((old: [number, number]) => [val, old?.[1]]);\n            }}\n            className=\"h-7 w-16 text-xs\"\n            data-testid={`filter-min-${columnDef.id}`}\n          />\n          <Input\n            type=\"number\"\n            placeholder=\"Max\"\n            value={(filterValue as [number, number])?.[1] ?? ''}\n            onChange={(e) => {\n              const val = e.target.value ? Number(e.target.value) : undefined;\n              column.setFilterValue((old: [number, number]) => [old?.[0], val]);\n            }}\n            className=\"h-7 w-16 text-xs\"\n            data-testid={`filter-max-${columnDef.id}`}\n          />\n        </div>\n      );\n\n    case 'date':\n      return (\n        <div className=\"flex gap-1\" data-testid={`filter-date-${columnDef.id}`}>\n          <Input\n            type=\"date\"\n            value={(filterValue as [string, string])?.[0] ?? ''}\n            onChange={(e) => {\n              column.setFilterValue((old: [string, string]) => [e.target.value || undefined, old?.[1]]);\n            }}\n            className=\"h-7 w-28 text-xs\"\n            data-testid={`filter-date-from-${columnDef.id}`}\n          />\n          <Input\n            type=\"date\"\n            value={(filterValue as [string, string])?.[1] ?? ''}\n            onChange={(e) => {\n              column.setFilterValue((old: [string, string]) => [old?.[0], e.target.value || undefined]);\n            }}\n            className=\"h-7 w-28 text-xs\"\n            data-testid={`filter-date-to-${columnDef.id}`}\n          />\n        </div>\n      );\n\n    case 'select':\n      return (\n        <Select\n          value={filterValue as string ?? ''}\n          onValueChange={(value) => column.setFilterValue(value || undefined)}\n        >\n          <SelectTrigger className=\"h-7 w-32 text-xs\" data-testid={`filter-select-${columnDef.id}`}>\n            <SelectValue placeholder=\"All\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"\">All</SelectItem>\n            {columnDef.filterOptions?.map((option) => (\n              <SelectItem key={option} value={option}>\n                {option}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      );\n\n    case 'boolean':\n      return (\n        <Select\n          value={filterValue as string ?? ''}\n          onValueChange={(value) => column.setFilterValue(value === '' ? undefined : value === 'true')}\n        >\n          <SelectTrigger className=\"h-7 w-24 text-xs\" data-testid={`filter-boolean-${columnDef.id}`}>\n            <SelectValue placeholder=\"All\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"\">All</SelectItem>\n            <SelectItem value=\"true\">Yes</SelectItem>\n            <SelectItem value=\"false\">No</SelectItem>\n          </SelectContent>\n        </Select>\n      );\n\n    default:\n      return (\n        <Input\n          type=\"text\"\n          placeholder=\"Filter...\"\n          value={(filterValue ?? '') as string}\n          onChange={(e) => column.setFilterValue(e.target.value || undefined)}\n          className=\"h-7 w-32 text-xs\"\n          data-testid={`filter-text-${columnDef.id}`}\n        />\n      );\n  }\n}\n\nfunction numberRangeFilter(row: Row<any>, columnId: string, filterValue: [number, number]) {\n  const value = row.getValue(columnId) as number;\n  const [min, max] = filterValue;\n  if (min !== undefined && value < min) return false;\n  if (max !== undefined && value > max) return false;\n  return true;\n}\n\nfunction dateRangeFilter(row: Row<any>, columnId: string, filterValue: [string, string]) {\n  const value = new Date(row.getValue(columnId) as string).getTime();\n  const [from, to] = filterValue;\n  if (from && value < new Date(from).getTime()) return false;\n  if (to && value > new Date(to).getTime()) return false;\n  return true;\n}\n\nexport function SmartTable({ config, className, onRowClick }: SmartTableProps) {\n  const {\n    columns: configColumns,\n    data,\n    pageSize = 10,\n    serverSide = false,\n    totalRows,\n    enableSorting = true,\n    enableFiltering = true,\n    enableGlobalSearch = true,\n    enableRowSelection = false,\n    enableVirtualization = false,\n    onPageChange,\n    onSortChange,\n    onFilterChange,\n    onSearchChange,\n  } = config;\n\n  const [sorting, setSorting] = useState<SortingState>([]);\n  const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([]);\n  const [globalFilter, setGlobalFilter] = useState('');\n  const [rowSelection, setRowSelection] = useState<RowSelectionState>({});\n  const [debouncedSearch, setDebouncedSearch] = useState('');\n\n  const parentRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedSearch(globalFilter);\n      if (onSearchChange) {\n        onSearchChange(globalFilter);\n      }\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [globalFilter, onSearchChange]);\n\n  useEffect(() => {\n    if (onSortChange && sorting.length > 0) {\n      onSortChange(sorting.map((s) => ({ id: s.id, desc: s.desc })));\n    }\n  }, [sorting, onSortChange]);\n\n  useEffect(() => {\n    if (onFilterChange && columnFilters.length > 0) {\n      onFilterChange(columnFilters.map((f) => ({ id: f.id, value: f.value })));\n    }\n  }, [columnFilters, onFilterChange]);\n\n  const columnHelper = createColumnHelper<Record<string, any>>();\n\n  const columns = useMemo(() => {\n    const cols: any[] = [];\n\n    if (enableRowSelection) {\n      cols.push(\n        columnHelper.display({\n          id: 'select',\n          header: ({ table }) => (\n            <Checkbox\n              checked={table.getIsAllPageRowsSelected()}\n              onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}\n              aria-label=\"Select all\"\n              data-testid=\"select-all-checkbox\"\n            />\n          ),\n          cell: ({ row }) => (\n            <Checkbox\n              checked={row.getIsSelected()}\n              onCheckedChange={(value) => row.toggleSelected(!!value)}\n              aria-label=\"Select row\"\n              data-testid={`select-row-${row.index}`}\n            />\n          ),\n          size: 40,\n        })\n      );\n    }\n\n    configColumns.forEach((col) => {\n      cols.push(\n        columnHelper.accessor(col.accessorKey, {\n          id: col.id,\n          header: col.header,\n          cell: (info) => formatCellValue(info.getValue(), col.type, col.format),\n          enableSorting: col.sortable !== false && enableSorting,\n          enableColumnFilter: col.filterable !== false && enableFiltering,\n          filterFn: col.type === 'number' || col.type === 'currency'\n            ? numberRangeFilter\n            : col.type === 'date'\n            ? dateRangeFilter\n            : 'includesString',\n          size: typeof col.width === 'number' ? col.width : undefined,\n          meta: { columnDef: col },\n        })\n      );\n    });\n\n    return cols;\n  }, [configColumns, enableRowSelection, enableSorting, enableFiltering, columnHelper]);\n\n  const table = useReactTable({\n    data,\n    columns,\n    state: {\n      sorting,\n      columnFilters,\n      globalFilter: debouncedSearch,\n      rowSelection,\n    },\n    enableRowSelection,\n    onSortingChange: setSorting,\n    onColumnFiltersChange: setColumnFilters,\n    onRowSelectionChange: setRowSelection,\n    getCoreRowModel: getCoreRowModel(),\n    getSortedRowModel: enableSorting ? getSortedRowModel() : undefined,\n    getFilteredRowModel: enableFiltering || enableGlobalSearch ? getFilteredRowModel() : undefined,\n    getPaginationRowModel: !enableVirtualization ? getPaginationRowModel() : undefined,\n    manualPagination: serverSide,\n    pageCount: serverSide && totalRows ? Math.ceil(totalRows / pageSize) : undefined,\n    initialState: {\n      pagination: {\n        pageSize,\n      },\n    },\n  });\n\n  const { rows } = table.getRowModel();\n  const shouldVirtualize = enableVirtualization && rows.length > 100;\n\n  const virtualizer = useVirtualizer({\n    count: shouldVirtualize ? rows.length : 0,\n    getScrollElement: () => parentRef.current,\n    estimateSize: () => 48,\n    overscan: 10,\n  });\n\n  const handleRowClick = useCallback(\n    (row: Row<Record<string, any>>) => {\n      if (onRowClick) {\n        onRowClick(row.original);\n      }\n    },\n    [onRowClick]\n  );\n\n  const renderSortIcon = (column: any) => {\n    if (!column.getCanSort()) return null;\n    const sorted = column.getIsSorted();\n    if (sorted === 'asc') return <ChevronUp className=\"h-4 w-4\" />;\n    if (sorted === 'desc') return <ChevronDown className=\"h-4 w-4\" />;\n    return <ChevronsUpDown className=\"h-4 w-4 opacity-50\" />;\n  };\n\n  const virtualRows = virtualizer.getVirtualItems();\n  const totalSize = virtualizer.getTotalSize();\n\n  return (\n    <div className={cn('w-full space-y-4', className)} data-testid=\"smart-table\">\n      {enableGlobalSearch && (\n        <div className=\"relative\" data-testid=\"global-search\">\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search all columns...\"\n            value={globalFilter}\n            onChange={(e) => setGlobalFilter(e.target.value)}\n            className=\"pl-9 pr-9\"\n            data-testid=\"global-search-input\"\n          />\n          {globalFilter && (\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"absolute right-1 top-1/2 h-7 w-7 -translate-y-1/2\"\n              onClick={() => setGlobalFilter('')}\n              data-testid=\"clear-search\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n      )}\n\n      <div\n        ref={parentRef}\n        className={cn(\n          'rounded-md border border-border overflow-auto',\n          shouldVirtualize && 'max-h-[600px]'\n        )}\n        data-testid=\"table-container\"\n      >\n        <table className=\"w-full border-collapse\">\n          <thead className=\"sticky top-0 z-10 bg-muted/80 backdrop-blur-sm\">\n            {table.getHeaderGroups().map((headerGroup) => (\n              <tr key={headerGroup.id} className=\"border-b border-border\">\n                {headerGroup.headers.map((header) => {\n                  const columnDef = (header.column.columnDef.meta as any)?.columnDef as ColumnDefConfig | undefined;\n                  return (\n                    <th\n                      key={header.id}\n                      className={cn(\n                        'px-4 py-3 text-sm font-medium text-foreground',\n                        columnDef?.align === 'center' && 'text-center',\n                        columnDef?.align === 'right' && 'text-right',\n                        !columnDef?.align && 'text-left'\n                      )}\n                      style={{ width: header.getSize() !== 150 ? header.getSize() : undefined }}\n                    >\n                      <div className=\"space-y-2\">\n                        <div\n                          className={cn(\n                            'flex items-center gap-1',\n                            header.column.getCanSort() && 'cursor-pointer select-none',\n                            columnDef?.align === 'center' && 'justify-center',\n                            columnDef?.align === 'right' && 'justify-end'\n                          )}\n                          onClick={header.column.getToggleSortingHandler()}\n                          data-testid={`header-${header.id}`}\n                        >\n                          {header.isPlaceholder\n                            ? null\n                            : flexRender(header.column.columnDef.header, header.getContext())}\n                          {renderSortIcon(header.column)}\n                        </div>\n                        {enableFiltering && header.column.getCanFilter() && columnDef && (\n                          <ColumnFilter column={header.column} columnDef={columnDef} />\n                        )}\n                      </div>\n                    </th>\n                  );\n                })}\n              </tr>\n            ))}\n          </thead>\n          <tbody>\n            {shouldVirtualize ? (\n              <>\n                {virtualRows.length > 0 && (\n                  <tr>\n                    <td style={{ height: `${virtualRows[0].start}px` }} />\n                  </tr>\n                )}\n                {virtualRows.map((virtualRow) => {\n                  const row = rows[virtualRow.index];\n                  return (\n                    <tr\n                      key={row.id}\n                      className={cn(\n                        'border-b border-border transition-colors',\n                        onRowClick && 'cursor-pointer hover:bg-muted/30',\n                        row.getIsSelected() && 'bg-muted/50'\n                      )}\n                      onClick={() => handleRowClick(row)}\n                      data-testid={`table-row-${virtualRow.index}`}\n                      style={{ height: `${virtualRow.size}px` }}\n                    >\n                      {row.getVisibleCells().map((cell) => {\n                        const columnDef = (cell.column.columnDef.meta as any)?.columnDef as ColumnDefConfig | undefined;\n                        return (\n                          <td\n                            key={cell.id}\n                            className={cn(\n                              'px-4 py-3 text-sm text-foreground',\n                              columnDef?.align === 'center' && 'text-center',\n                              columnDef?.align === 'right' && 'text-right',\n                              !columnDef?.align && 'text-left'\n                            )}\n                          >\n                            {flexRender(cell.column.columnDef.cell, cell.getContext())}\n                          </td>\n                        );\n                      })}\n                    </tr>\n                  );\n                })}\n                {virtualRows.length > 0 && (\n                  <tr>\n                    <td style={{ height: `${totalSize - (virtualRows[virtualRows.length - 1]?.end ?? 0)}px` }} />\n                  </tr>\n                )}\n              </>\n            ) : (\n              table.getRowModel().rows.map((row, rowIndex) => (\n                <tr\n                  key={row.id}\n                  className={cn(\n                    'border-b border-border transition-colors',\n                    onRowClick && 'cursor-pointer hover:bg-muted/30',\n                    row.getIsSelected() && 'bg-muted/50'\n                  )}\n                  onClick={() => handleRowClick(row)}\n                  data-testid={`table-row-${rowIndex}`}\n                >\n                  {row.getVisibleCells().map((cell) => {\n                    const columnDef = (cell.column.columnDef.meta as any)?.columnDef as ColumnDefConfig | undefined;\n                    return (\n                      <td\n                        key={cell.id}\n                        className={cn(\n                          'px-4 py-3 text-sm text-foreground',\n                          columnDef?.align === 'center' && 'text-center',\n                          columnDef?.align === 'right' && 'text-right',\n                          !columnDef?.align && 'text-left'\n                        )}\n                      >\n                        {flexRender(cell.column.columnDef.cell, cell.getContext())}\n                      </td>\n                    );\n                  })}\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      {!enableVirtualization && (\n        <div className=\"flex items-center justify-between\" data-testid=\"pagination\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <span>\n              Showing {table.getState().pagination.pageIndex * table.getState().pagination.pageSize + 1} to{' '}\n              {Math.min(\n                (table.getState().pagination.pageIndex + 1) * table.getState().pagination.pageSize,\n                serverSide && totalRows ? totalRows : table.getFilteredRowModel().rows.length\n              )}{' '}\n              of {serverSide && totalRows ? totalRows : table.getFilteredRowModel().rows.length} results\n            </span>\n            {enableRowSelection && Object.keys(rowSelection).length > 0 && (\n              <span className=\"text-primary\">\n                ({Object.keys(rowSelection).length} selected)\n              </span>\n            )}\n          </div>\n\n          <div className=\"flex items-center gap-2\">\n            <Select\n              value={String(table.getState().pagination.pageSize)}\n              onValueChange={(value) => {\n                table.setPageSize(Number(value));\n              }}\n            >\n              <SelectTrigger className=\"h-8 w-20\" data-testid=\"page-size-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {[10, 20, 30, 50, 100].map((size) => (\n                  <SelectItem key={size} value={String(size)}>\n                    {size}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            <div className=\"flex items-center gap-1\">\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                className=\"h-8 w-8\"\n                onClick={() => {\n                  table.setPageIndex(0);\n                  if (onPageChange) onPageChange(0);\n                }}\n                disabled={!table.getCanPreviousPage()}\n                data-testid=\"first-page\"\n              >\n                <ChevronsLeft className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                className=\"h-8 w-8\"\n                onClick={() => {\n                  table.previousPage();\n                  if (onPageChange) onPageChange(table.getState().pagination.pageIndex - 1);\n                }}\n                disabled={!table.getCanPreviousPage()}\n                data-testid=\"prev-page\"\n              >\n                <ChevronLeft className=\"h-4 w-4\" />\n              </Button>\n              <span className=\"px-2 text-sm text-muted-foreground\">\n                Page {table.getState().pagination.pageIndex + 1} of {table.getPageCount()}\n              </span>\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                className=\"h-8 w-8\"\n                onClick={() => {\n                  table.nextPage();\n                  if (onPageChange) onPageChange(table.getState().pagination.pageIndex + 1);\n                }}\n                disabled={!table.getCanNextPage()}\n                data-testid=\"next-page\"\n              >\n                <ChevronRight className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                className=\"h-8 w-8\"\n                onClick={() => {\n                  table.setPageIndex(table.getPageCount() - 1);\n                  if (onPageChange) onPageChange(table.getPageCount() - 1);\n                }}\n                disabled={!table.getCanNextPage()}\n                data-testid=\"last-page\"\n              >\n                <ChevronsRight className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":21752,"size_tokens":null},"client/src/components/code-annotation-marker.tsx":{"content":"import { useCallback } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Plus, Info, AlertTriangle, AlertCircle, Lightbulb } from \"lucide-react\";\nimport type { CodeAnnotation } from \"@/hooks/useCodeAnnotations\";\n\nexport interface CodeAnnotationMarkerProps {\n  lineNumber: number;\n  annotation?: CodeAnnotation;\n  onAddAnnotation?: (line: number) => void;\n  onAnnotationClick?: (annotation: CodeAnnotation) => void;\n  annotationMode?: boolean;\n}\n\nconst typeConfig = {\n  info: {\n    bg: \"bg-blue-500\",\n    hoverBg: \"hover:bg-blue-400\",\n    ring: \"ring-blue-500/30\",\n    icon: Info,\n  },\n  warning: {\n    bg: \"bg-amber-500\",\n    hoverBg: \"hover:bg-amber-400\",\n    ring: \"ring-amber-500/30\",\n    icon: AlertTriangle,\n  },\n  error: {\n    bg: \"bg-red-500\",\n    hoverBg: \"hover:bg-red-400\",\n    ring: \"ring-red-500/30\",\n    icon: AlertCircle,\n  },\n  explanation: {\n    bg: \"bg-emerald-500\",\n    hoverBg: \"hover:bg-emerald-400\",\n    ring: \"ring-emerald-500/30\",\n    icon: Lightbulb,\n  },\n};\n\nexport function CodeAnnotationMarker({\n  lineNumber,\n  annotation,\n  onAddAnnotation,\n  onAnnotationClick,\n  annotationMode = false,\n}: CodeAnnotationMarkerProps) {\n  const handleClick = useCallback((e: React.MouseEvent) => {\n    e.stopPropagation();\n    if (annotation && onAnnotationClick) {\n      onAnnotationClick(annotation);\n    } else if (annotationMode && onAddAnnotation) {\n      onAddAnnotation(lineNumber);\n    }\n  }, [annotation, onAnnotationClick, annotationMode, onAddAnnotation, lineNumber]);\n\n  if (annotation) {\n    const config = typeConfig[annotation.type];\n    const Icon = config.icon;\n\n    return (\n      <button\n        onClick={handleClick}\n        className={cn(\n          \"w-4 h-4 rounded-full flex items-center justify-center\",\n          \"transition-all duration-200 ring-2\",\n          config.bg,\n          config.hoverBg,\n          config.ring,\n          \"hover:scale-110 hover:ring-4\"\n        )}\n        title={`${annotation.type}: ${annotation.content.slice(0, 50)}${annotation.content.length > 50 ? '...' : ''}`}\n        data-testid={`marker-annotation-${lineNumber}`}\n      >\n        <Icon className=\"w-2.5 h-2.5 text-white\" />\n      </button>\n    );\n  }\n\n  if (annotationMode) {\n    return (\n      <button\n        onClick={handleClick}\n        className={cn(\n          \"w-4 h-4 rounded-full flex items-center justify-center\",\n          \"bg-zinc-700 hover:bg-zinc-600\",\n          \"transition-all duration-200\",\n          \"opacity-0 group-hover:opacity-100\",\n          \"hover:scale-110\"\n        )}\n        title=\"Add annotation\"\n        data-testid={`marker-add-${lineNumber}`}\n      >\n        <Plus className=\"w-2.5 h-2.5 text-zinc-300\" />\n      </button>\n    );\n  }\n\n  return (\n    <div\n      className=\"w-4 h-4\"\n      data-testid={`marker-empty-${lineNumber}`}\n    />\n  );\n}\n\nexport default CodeAnnotationMarker;\n","path":null,"size_bytes":2838,"size_tokens":null},"client/src/graphics/three/index.ts":{"content":"export { ThreeEngine } from './three-engine';\nexport { ThreeEngineImpl, type ThreeEngineRef } from './three-engine-impl';\n","path":null,"size_bytes":122,"size_tokens":null},"client/src/components/charts/index.ts":{"content":"export { VisualizationRenderer, SmartTable } from './visualization-renderer';\nexport type { VisualizationRendererProps, SmartTableProps } from './visualization-renderer';\n\nexport { RechartsChart, getDefaultColors, exportChartAsPNG, exportChartAsSVG } from './recharts-chart';\nexport type { RechartsChartProps } from './recharts-chart';\n\nexport { EChartsChart } from './echarts-chart';\nexport type { EChartsChartProps } from './echarts-chart';\n\nexport type { \n  ChartConfig, \n  DataPoint, \n  TableConfig, \n  VisualizationConfig,\n  ColumnDef,\n  ChartType \n} from '@shared/schemas/visualization';\n","path":null,"size_bytes":594,"size_tokens":null},"client/src/hooks/useCodeAnnotations.ts":{"content":"import { useState, useCallback, useMemo, useEffect } from \"react\";\n\nexport interface CodeAnnotation {\n  id: string;\n  blockId: string;\n  line: number;\n  content: string;\n  type: 'info' | 'warning' | 'error' | 'explanation';\n  createdAt: Date;\n}\n\nexport interface UseCodeAnnotationsReturn {\n  annotations: Map<number, CodeAnnotation>;\n  addAnnotation: (line: number, content: string, type?: CodeAnnotation['type']) => void;\n  updateAnnotation: (id: string, content: string) => void;\n  removeAnnotation: (id: string) => void;\n  getAnnotationForLine: (line: number) => CodeAnnotation | undefined;\n  getAllAnnotations: () => CodeAnnotation[];\n  clearAllAnnotations: () => void;\n  hasAnnotation: (line: number) => boolean;\n}\n\nconst STORAGE_KEY_PREFIX = \"code-annotations-\";\n\nfunction serializeAnnotations(annotations: Map<number, CodeAnnotation>): string {\n  const arr = Array.from(annotations.entries()).map(([line, annotation]) => ({\n    line,\n    annotation: {\n      ...annotation,\n      createdAt: annotation.createdAt.toISOString(),\n    },\n  }));\n  return JSON.stringify(arr);\n}\n\nfunction deserializeAnnotations(json: string): Map<number, CodeAnnotation> {\n  try {\n    const arr = JSON.parse(json) as Array<{\n      line: number;\n      annotation: Omit<CodeAnnotation, 'createdAt'> & { createdAt: string };\n    }>;\n    const map = new Map<number, CodeAnnotation>();\n    for (const item of arr) {\n      map.set(item.line, {\n        ...item.annotation,\n        createdAt: new Date(item.annotation.createdAt),\n      });\n    }\n    return map;\n  } catch {\n    return new Map();\n  }\n}\n\nexport function useCodeAnnotations(blockId: string, persist: boolean = false): UseCodeAnnotationsReturn {\n  const storageKey = `${STORAGE_KEY_PREFIX}${blockId}`;\n\n  const [annotations, setAnnotations] = useState<Map<number, CodeAnnotation>>(() => {\n    if (persist && typeof window !== \"undefined\") {\n      const stored = localStorage.getItem(storageKey);\n      if (stored) {\n        return deserializeAnnotations(stored);\n      }\n    }\n    return new Map();\n  });\n\n  useEffect(() => {\n    if (persist && typeof window !== \"undefined\") {\n      localStorage.setItem(storageKey, serializeAnnotations(annotations));\n    }\n  }, [annotations, persist, storageKey]);\n\n  const addAnnotation = useCallback(\n    (line: number, content: string, type: CodeAnnotation['type'] = 'info') => {\n      const id = crypto.randomUUID();\n      const annotation: CodeAnnotation = {\n        id,\n        blockId,\n        line,\n        content,\n        type,\n        createdAt: new Date(),\n      };\n      setAnnotations((prev) => {\n        const next = new Map(prev);\n        next.set(line, annotation);\n        return next;\n      });\n    },\n    [blockId]\n  );\n\n  const updateAnnotation = useCallback((id: string, content: string) => {\n    setAnnotations((prev) => {\n      const next = new Map(prev);\n      for (const [line, annotation] of next) {\n        if (annotation.id === id) {\n          next.set(line, { ...annotation, content });\n          break;\n        }\n      }\n      return next;\n    });\n  }, []);\n\n  const removeAnnotation = useCallback((id: string) => {\n    setAnnotations((prev) => {\n      const next = new Map(prev);\n      for (const [line, annotation] of next) {\n        if (annotation.id === id) {\n          next.delete(line);\n          break;\n        }\n      }\n      return next;\n    });\n  }, []);\n\n  const getAnnotationForLine = useCallback(\n    (line: number): CodeAnnotation | undefined => {\n      return annotations.get(line);\n    },\n    [annotations]\n  );\n\n  const getAllAnnotations = useCallback((): CodeAnnotation[] => {\n    return Array.from(annotations.values()).sort((a, b) => a.line - b.line);\n  }, [annotations]);\n\n  const clearAllAnnotations = useCallback(() => {\n    setAnnotations(new Map());\n    if (persist && typeof window !== \"undefined\") {\n      localStorage.removeItem(storageKey);\n    }\n  }, [persist, storageKey]);\n\n  const hasAnnotation = useCallback(\n    (line: number): boolean => {\n      return annotations.has(line);\n    },\n    [annotations]\n  );\n\n  return useMemo(\n    () => ({\n      annotations,\n      addAnnotation,\n      updateAnnotation,\n      removeAnnotation,\n      getAnnotationForLine,\n      getAllAnnotations,\n      clearAllAnnotations,\n      hasAnnotation,\n    }),\n    [\n      annotations,\n      addAnnotation,\n      updateAnnotation,\n      removeAnnotation,\n      getAnnotationForLine,\n      getAllAnnotations,\n      clearAllAnnotations,\n      hasAnnotation,\n    ]\n  );\n}\n\nexport default useCodeAnnotations;\n","path":null,"size_bytes":4521,"size_tokens":null},"server/services/pdfGeneration.ts":{"content":"import { chromium, Browser, BrowserContext } from \"playwright\";\n\nexport interface PdfMargin {\n  top?: string;\n  right?: string;\n  bottom?: string;\n  left?: string;\n}\n\nexport interface PdfOptions {\n  format?: \"A4\" | \"Letter\" | \"Legal\" | \"Tabloid\" | \"A3\" | \"A5\";\n  margin?: PdfMargin;\n  landscape?: boolean;\n  headerTemplate?: string;\n  footerTemplate?: string;\n  printBackground?: boolean;\n  scale?: number;\n  preferCSSPageSize?: boolean;\n}\n\nconst DEFAULT_OPTIONS: PdfOptions = {\n  format: \"A4\",\n  margin: {\n    top: \"20mm\",\n    right: \"20mm\",\n    bottom: \"20mm\",\n    left: \"20mm\",\n  },\n  landscape: false,\n  printBackground: true,\n  scale: 1,\n  preferCSSPageSize: false,\n};\n\nlet browserInstance: Browser | null = null;\n\nasync function getBrowser(): Promise<Browser> {\n  if (!browserInstance || !browserInstance.isConnected()) {\n    browserInstance = await chromium.launch({\n      headless: true,\n      args: [\n        \"--no-sandbox\",\n        \"--disable-setuid-sandbox\",\n        \"--disable-dev-shm-usage\",\n        \"--disable-gpu\",\n      ],\n    });\n  }\n  return browserInstance;\n}\n\nfunction wrapHtmlWithStyles(html: string): string {\n  const hasHtmlTag = /<html[\\s>]/i.test(html);\n  const hasHeadTag = /<head[\\s>]/i.test(html);\n  \n  const printStyles = `\n    <style>\n      @media print {\n        * {\n          -webkit-print-color-adjust: exact !important;\n          print-color-adjust: exact !important;\n          color-adjust: exact !important;\n        }\n        body {\n          margin: 0;\n          padding: 0;\n        }\n        @page {\n          margin: 0;\n        }\n      }\n      body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n        line-height: 1.6;\n        color: #333;\n      }\n      table {\n        border-collapse: collapse;\n        width: 100%;\n      }\n      th, td {\n        border: 1px solid #ddd;\n        padding: 8px;\n        text-align: left;\n      }\n      th {\n        background-color: #f5f5f5;\n      }\n      img {\n        max-width: 100%;\n        height: auto;\n      }\n      pre, code {\n        font-family: 'Courier New', Courier, monospace;\n        background-color: #f5f5f5;\n        padding: 2px 4px;\n        border-radius: 3px;\n      }\n      pre {\n        padding: 12px;\n        overflow-x: auto;\n      }\n      blockquote {\n        border-left: 4px solid #ddd;\n        margin: 0;\n        padding-left: 16px;\n        color: #666;\n      }\n    </style>\n  `;\n\n  if (hasHtmlTag && hasHeadTag) {\n    return html.replace(/<head([^>]*)>/i, `<head$1>${printStyles}`);\n  } else if (hasHtmlTag) {\n    return html.replace(/<html([^>]*)>/i, `<html$1><head>${printStyles}</head>`);\n  } else {\n    return `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  ${printStyles}\n</head>\n<body>\n  ${html}\n</body>\n</html>`;\n  }\n}\n\nfunction validateHtml(html: string): void {\n  if (!html || typeof html !== \"string\") {\n    throw new Error(\"HTML content is required and must be a string\");\n  }\n  \n  if (html.trim().length === 0) {\n    throw new Error(\"HTML content cannot be empty\");\n  }\n\n  const maxSize = 10 * 1024 * 1024; // 10MB limit\n  if (html.length > maxSize) {\n    throw new Error(`HTML content exceeds maximum size of ${maxSize / 1024 / 1024}MB`);\n  }\n}\n\nexport async function generatePdfFromHtml(\n  html: string,\n  options?: PdfOptions\n): Promise<Buffer> {\n  validateHtml(html);\n\n  const mergedOptions: PdfOptions = {\n    ...DEFAULT_OPTIONS,\n    ...options,\n    margin: {\n      ...DEFAULT_OPTIONS.margin,\n      ...options?.margin,\n    },\n  };\n\n  let context: BrowserContext | null = null;\n\n  try {\n    const browser = await getBrowser();\n    context = await browser.newContext();\n    const page = await context.newPage();\n\n    const wrappedHtml = wrapHtmlWithStyles(html);\n    await page.setContent(wrappedHtml, {\n      waitUntil: \"networkidle\",\n      timeout: 30000,\n    });\n\n    await page.waitForLoadState(\"domcontentloaded\");\n    \n    await page.evaluate(() => {\n      return new Promise<void>((resolve) => {\n        if (document.readyState === \"complete\") {\n          resolve();\n        } else {\n          window.addEventListener(\"load\", () => resolve());\n        }\n      });\n    });\n\n    const pdfOptions: Parameters<typeof page.pdf>[0] = {\n      format: mergedOptions.format,\n      margin: mergedOptions.margin,\n      landscape: mergedOptions.landscape,\n      printBackground: mergedOptions.printBackground,\n      scale: mergedOptions.scale,\n      preferCSSPageSize: mergedOptions.preferCSSPageSize,\n    };\n\n    if (mergedOptions.headerTemplate || mergedOptions.footerTemplate) {\n      pdfOptions.displayHeaderFooter = true;\n      pdfOptions.headerTemplate = mergedOptions.headerTemplate || \"<span></span>\";\n      pdfOptions.footerTemplate = mergedOptions.footerTemplate || \"<span></span>\";\n    }\n\n    const pdfBuffer = await page.pdf(pdfOptions);\n\n    return Buffer.from(pdfBuffer);\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    \n    if (errorMessage.includes(\"timeout\") || errorMessage.includes(\"Timeout\")) {\n      throw new Error(`PDF generation timed out: ${errorMessage}`);\n    }\n    \n    if (errorMessage.includes(\"net::ERR_\") || errorMessage.includes(\"Navigation\")) {\n      throw new Error(`Failed to load HTML content: ${errorMessage}`);\n    }\n    \n    throw new Error(`PDF generation failed: ${errorMessage}`);\n  } finally {\n    if (context) {\n      await context.close().catch((err) => {\n        console.error(\"[pdfGeneration] Error closing browser context:\", err);\n      });\n    }\n  }\n}\n\nexport async function closeBrowser(): Promise<void> {\n  if (browserInstance) {\n    try {\n      await browserInstance.close();\n    } catch (error) {\n      console.error(\"[pdfGeneration] Error closing browser:\", error);\n    } finally {\n      browserInstance = null;\n    }\n  }\n}\n\nprocess.on(\"SIGTERM\", async () => {\n  await closeBrowser();\n});\n\nprocess.on(\"SIGINT\", async () => {\n  await closeBrowser();\n});\n","path":null,"size_bytes":6029,"size_tokens":null},"server/services/documentService.ts":{"content":"import { z } from \"zod\";\nimport { randomUUID } from \"crypto\";\nimport { generatePdfFromHtml, PdfOptions } from \"./pdfGeneration\";\nimport { \n  generateWordDocument, \n  generateExcelDocument, \n  generatePptDocument,\n  parseExcelFromText,\n  parseSlidesFromText\n} from \"./documentGeneration\";\n\nexport const DocumentTypeSchema = z.enum([\"pdf\", \"docx\", \"xlsx\", \"pptx\"]);\nexport type DocumentType = z.infer<typeof DocumentTypeSchema>;\n\nexport const DocumentRenderRequestSchema = z.object({\n  templateId: z.string().min(1, \"Template ID is required\"),\n  type: DocumentTypeSchema,\n  data: z.record(z.any()),\n  options: z.object({\n    format: z.enum([\"A4\", \"Letter\", \"Legal\", \"Tabloid\", \"A3\", \"A5\"]).optional(),\n    landscape: z.boolean().optional(),\n    margin: z.object({\n      top: z.string().optional(),\n      right: z.string().optional(),\n      bottom: z.string().optional(),\n      left: z.string().optional(),\n    }).optional(),\n    printBackground: z.boolean().optional(),\n    scale: z.number().min(0.1).max(2).optional(),\n  }).optional(),\n});\n\nexport type DocumentRenderRequest = z.infer<typeof DocumentRenderRequestSchema>;\n\nexport interface DocumentTemplate {\n  id: string;\n  name: string;\n  description: string;\n  type: DocumentType[];\n  requiredFields: string[];\n  optionalFields?: string[];\n  exampleData?: Record<string, any>;\n}\n\nexport interface GeneratedDocument {\n  id: string;\n  fileName: string;\n  mimeType: string;\n  buffer: Buffer;\n  createdAt: Date;\n  expiresAt: Date;\n}\n\nconst documentStore: Map<string, GeneratedDocument> = new Map();\n\nconst DOCUMENT_EXPIRY_MS = 30 * 60 * 1000; // 30 minutes\n\nconst builtInTemplates: DocumentTemplate[] = [\n  {\n    id: \"report\",\n    name: \"Report Template\",\n    description: \"A standard report with title, sections, and content\",\n    type: [\"pdf\", \"docx\"],\n    requiredFields: [\"title\", \"content\"],\n    optionalFields: [\"author\", \"date\", \"sections\"],\n    exampleData: {\n      title: \"Quarterly Report\",\n      content: \"# Introduction\\n\\nThis is the report content...\",\n      author: \"John Doe\",\n      date: \"2024-01-01\"\n    }\n  },\n  {\n    id: \"invoice\",\n    name: \"Invoice Template\",\n    description: \"Professional invoice with line items and totals\",\n    type: [\"pdf\", \"docx\", \"xlsx\"],\n    requiredFields: [\"invoiceNumber\", \"clientName\", \"items\"],\n    optionalFields: [\"companyName\", \"companyAddress\", \"clientAddress\", \"dueDate\", \"notes\"],\n    exampleData: {\n      invoiceNumber: \"INV-001\",\n      clientName: \"Acme Corp\",\n      items: [\n        { description: \"Service A\", quantity: 2, unitPrice: 100 },\n        { description: \"Service B\", quantity: 1, unitPrice: 250 }\n      ]\n    }\n  },\n  {\n    id: \"spreadsheet\",\n    name: \"Data Spreadsheet\",\n    description: \"Tabular data export with headers\",\n    type: [\"xlsx\"],\n    requiredFields: [\"headers\", \"rows\"],\n    optionalFields: [\"sheetName\"],\n    exampleData: {\n      headers: [\"Name\", \"Email\", \"Status\"],\n      rows: [\n        [\"John Doe\", \"john@example.com\", \"Active\"],\n        [\"Jane Smith\", \"jane@example.com\", \"Pending\"]\n      ]\n    }\n  },\n  {\n    id: \"presentation\",\n    name: \"Presentation Template\",\n    description: \"Slide deck with title and bullet points\",\n    type: [\"pptx\"],\n    requiredFields: [\"title\", \"slides\"],\n    optionalFields: [\"author\", \"theme\"],\n    exampleData: {\n      title: \"Project Overview\",\n      slides: [\n        { title: \"Introduction\", content: [\"Overview\", \"Goals\", \"Timeline\"] },\n        { title: \"Details\", content: [\"Feature 1\", \"Feature 2\", \"Feature 3\"] }\n      ]\n    }\n  },\n  {\n    id: \"letter\",\n    name: \"Business Letter\",\n    description: \"Formal letter with recipient and sender details\",\n    type: [\"pdf\", \"docx\"],\n    requiredFields: [\"recipient\", \"subject\", \"body\"],\n    optionalFields: [\"senderName\", \"senderAddress\", \"date\", \"closing\"],\n    exampleData: {\n      recipient: \"Dear Client\",\n      subject: \"Re: Your Inquiry\",\n      body: \"Thank you for reaching out...\",\n      senderName: \"Your Company\",\n      closing: \"Best regards\"\n    }\n  },\n  {\n    id: \"custom\",\n    name: \"Custom Document\",\n    description: \"Flexible template for custom content\",\n    type: [\"pdf\", \"docx\", \"xlsx\", \"pptx\"],\n    requiredFields: [\"content\"],\n    optionalFields: [\"title\", \"format\"],\n    exampleData: {\n      title: \"Custom Document\",\n      content: \"Your content here\"\n    }\n  }\n];\n\nexport function getTemplates(): DocumentTemplate[] {\n  return builtInTemplates;\n}\n\nexport function getTemplateById(id: string): DocumentTemplate | undefined {\n  return builtInTemplates.find(t => t.id === id);\n}\n\nfunction generateDocumentId(): string {\n  return `doc_${Date.now().toString(36)}_${randomUUID().replace(/-/g, '')}`;\n}\n\nfunction getMimeType(type: DocumentType): string {\n  switch (type) {\n    case \"pdf\":\n      return \"application/pdf\";\n    case \"docx\":\n      return \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\";\n    case \"xlsx\":\n      return \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n    case \"pptx\":\n      return \"application/vnd.openxmlformats-officedocument.presentationml.presentation\";\n  }\n}\n\nfunction getFileExtension(type: DocumentType): string {\n  return type === \"pdf\" ? \"pdf\" : type;\n}\n\nfunction sanitizeFileName(name: string): string {\n  return name.replace(/[^a-zA-Z0-9_-]/g, \"_\").substring(0, 100);\n}\n\nfunction renderTemplateToHtml(template: DocumentTemplate, data: Record<string, any>): string {\n  const title = data.title || template.name;\n  \n  switch (template.id) {\n    case \"invoice\":\n      return renderInvoiceHtml(data);\n    case \"report\":\n      return renderReportHtml(data);\n    case \"letter\":\n      return renderLetterHtml(data);\n    default:\n      return renderGenericHtml(title, data);\n  }\n}\n\nfunction renderInvoiceHtml(data: Record<string, any>): string {\n  const items = data.items || [];\n  const total = items.reduce((sum: number, item: any) => {\n    return sum + (item.quantity || 1) * (item.unitPrice || 0);\n  }, 0);\n\n  const itemsHtml = items.map((item: any) => `\n    <tr>\n      <td>${item.description || \"\"}</td>\n      <td style=\"text-align: center\">${item.quantity || 1}</td>\n      <td style=\"text-align: right\">$${(item.unitPrice || 0).toFixed(2)}</td>\n      <td style=\"text-align: right\">$${((item.quantity || 1) * (item.unitPrice || 0)).toFixed(2)}</td>\n    </tr>\n  `).join(\"\");\n\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"UTF-8\">\n      <style>\n        body { font-family: Arial, sans-serif; padding: 40px; }\n        .header { display: flex; justify-content: space-between; margin-bottom: 40px; }\n        .invoice-title { font-size: 32px; color: #333; }\n        .invoice-number { color: #666; }\n        table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n        th, td { padding: 12px; border-bottom: 1px solid #ddd; }\n        th { background: #f5f5f5; text-align: left; }\n        .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 20px; }\n        .notes { margin-top: 40px; padding: 20px; background: #f9f9f9; border-radius: 4px; }\n      </style>\n    </head>\n    <body>\n      <div class=\"header\">\n        <div>\n          <div class=\"invoice-title\">INVOICE</div>\n          <div class=\"invoice-number\">${data.invoiceNumber || \"INV-001\"}</div>\n        </div>\n        <div style=\"text-align: right\">\n          <div><strong>${data.companyName || \"\"}</strong></div>\n          <div>${data.companyAddress || \"\"}</div>\n        </div>\n      </div>\n      \n      <div style=\"margin-bottom: 30px\">\n        <strong>Bill To:</strong><br>\n        ${data.clientName || \"\"}<br>\n        ${data.clientAddress || \"\"}\n      </div>\n      \n      ${data.dueDate ? `<div><strong>Due Date:</strong> ${data.dueDate}</div>` : \"\"}\n      \n      <table>\n        <thead>\n          <tr>\n            <th>Description</th>\n            <th style=\"text-align: center\">Quantity</th>\n            <th style=\"text-align: right\">Unit Price</th>\n            <th style=\"text-align: right\">Amount</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${itemsHtml}\n        </tbody>\n      </table>\n      \n      <div class=\"total\">Total: $${total.toFixed(2)}</div>\n      \n      ${data.notes ? `<div class=\"notes\"><strong>Notes:</strong><br>${data.notes}</div>` : \"\"}\n    </body>\n    </html>\n  `;\n}\n\nfunction renderReportHtml(data: Record<string, any>): string {\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"UTF-8\">\n      <style>\n        body { font-family: Georgia, serif; padding: 40px; line-height: 1.6; }\n        h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }\n        .meta { color: #666; margin-bottom: 30px; }\n        .content { white-space: pre-wrap; }\n      </style>\n    </head>\n    <body>\n      <h1>${data.title || \"Report\"}</h1>\n      <div class=\"meta\">\n        ${data.author ? `<div>Author: ${data.author}</div>` : \"\"}\n        ${data.date ? `<div>Date: ${data.date}</div>` : \"\"}\n      </div>\n      <div class=\"content\">${data.content || \"\"}</div>\n    </body>\n    </html>\n  `;\n}\n\nfunction renderLetterHtml(data: Record<string, any>): string {\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"UTF-8\">\n      <style>\n        body { font-family: Georgia, serif; padding: 60px; line-height: 1.8; }\n        .sender { text-align: right; margin-bottom: 40px; }\n        .date { margin-bottom: 40px; }\n        .recipient { margin-bottom: 30px; }\n        .subject { font-weight: bold; margin-bottom: 30px; }\n        .body { margin-bottom: 40px; white-space: pre-wrap; }\n        .closing { margin-top: 40px; }\n      </style>\n    </head>\n    <body>\n      <div class=\"sender\">\n        ${data.senderName || \"\"}<br>\n        ${data.senderAddress || \"\"}\n      </div>\n      \n      <div class=\"date\">${data.date || new Date().toLocaleDateString()}</div>\n      \n      <div class=\"recipient\">${data.recipient || \"\"}</div>\n      \n      ${data.subject ? `<div class=\"subject\">Subject: ${data.subject}</div>` : \"\"}\n      \n      <div class=\"body\">${data.body || \"\"}</div>\n      \n      <div class=\"closing\">\n        ${data.closing || \"Sincerely\"},<br><br>\n        ${data.senderName || \"\"}\n      </div>\n    </body>\n    </html>\n  `;\n}\n\nfunction renderGenericHtml(title: string, data: Record<string, any>): string {\n  const content = data.content || \"\";\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"UTF-8\">\n      <style>\n        body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; }\n        h1 { color: #333; }\n        .content { white-space: pre-wrap; }\n      </style>\n    </head>\n    <body>\n      <h1>${title}</h1>\n      <div class=\"content\">${content}</div>\n    </body>\n    </html>\n  `;\n}\n\nasync function generatePdf(template: DocumentTemplate, data: Record<string, any>, options?: PdfOptions): Promise<Buffer> {\n  const html = renderTemplateToHtml(template, data);\n  return generatePdfFromHtml(html, options);\n}\n\nasync function generateDocx(template: DocumentTemplate, data: Record<string, any>): Promise<Buffer> {\n  const title = data.title || template.name;\n  const content = data.content || JSON.stringify(data, null, 2);\n  return generateWordDocument(title, content);\n}\n\nasync function generateXlsx(template: DocumentTemplate, data: Record<string, any>): Promise<Buffer> {\n  const title = data.title || data.sheetName || template.name;\n  \n  let excelData: any[][];\n  if (data.headers && data.rows) {\n    excelData = [data.headers, ...data.rows];\n  } else if (data.items && Array.isArray(data.items)) {\n    const headers = Object.keys(data.items[0] || {});\n    const rows = data.items.map((item: any) => headers.map(h => item[h]));\n    excelData = [headers, ...rows];\n  } else if (typeof data.content === \"string\") {\n    excelData = parseExcelFromText(data.content);\n  } else {\n    excelData = [[\"Content\"], [JSON.stringify(data)]];\n  }\n  \n  return generateExcelDocument(title, excelData);\n}\n\nasync function generatePptx(template: DocumentTemplate, data: Record<string, any>): Promise<Buffer> {\n  const title = data.title || template.name;\n  \n  let slides: { title: string; content: string[] }[];\n  if (data.slides && Array.isArray(data.slides)) {\n    slides = data.slides.map((slide: any) => ({\n      title: slide.title || \"Slide\",\n      content: Array.isArray(slide.content) ? slide.content : [slide.content || \"\"]\n    }));\n  } else if (typeof data.content === \"string\") {\n    slides = parseSlidesFromText(data.content);\n  } else {\n    slides = [{ title: title, content: [\"Content\"] }];\n  }\n  \n  return generatePptDocument(title, slides);\n}\n\nexport async function renderDocument(request: DocumentRenderRequest): Promise<GeneratedDocument> {\n  const template = getTemplateById(request.templateId);\n  if (!template) {\n    throw new Error(`Template not found: ${request.templateId}`);\n  }\n  \n  if (!template.type.includes(request.type)) {\n    throw new Error(`Template \"${template.name}\" does not support type \"${request.type}\". Supported types: ${template.type.join(\", \")}`);\n  }\n  \n  for (const field of template.requiredFields) {\n    if (request.data[field] === undefined) {\n      throw new Error(`Missing required field: ${field}`);\n    }\n  }\n  \n  let buffer: Buffer;\n  \n  switch (request.type) {\n    case \"pdf\":\n      buffer = await generatePdf(template, request.data, request.options);\n      break;\n    case \"docx\":\n      buffer = await generateDocx(template, request.data);\n      break;\n    case \"xlsx\":\n      buffer = await generateXlsx(template, request.data);\n      break;\n    case \"pptx\":\n      buffer = await generatePptx(template, request.data);\n      break;\n    default:\n      throw new Error(`Unsupported document type: ${request.type}`);\n  }\n  \n  const docId = generateDocumentId();\n  const title = request.data.title || template.name;\n  const fileName = `${sanitizeFileName(title)}.${getFileExtension(request.type)}`;\n  \n  const document: GeneratedDocument = {\n    id: docId,\n    fileName,\n    mimeType: getMimeType(request.type),\n    buffer,\n    createdAt: new Date(),\n    expiresAt: new Date(Date.now() + DOCUMENT_EXPIRY_MS),\n  };\n  \n  documentStore.set(docId, document);\n  \n  return document;\n}\n\nexport function getGeneratedDocument(id: string): GeneratedDocument | undefined {\n  const doc = documentStore.get(id);\n  if (!doc) return undefined;\n  \n  if (new Date() > doc.expiresAt) {\n    documentStore.delete(id);\n    return undefined;\n  }\n  \n  return doc;\n}\n\nexport function deleteGeneratedDocument(id: string): boolean {\n  return documentStore.delete(id);\n}\n\nexport function cleanupExpiredDocuments(): number {\n  const now = new Date();\n  let cleaned = 0;\n  \n  const entries = Array.from(documentStore.entries());\n  for (const [id, doc] of entries) {\n    if (now > doc.expiresAt) {\n      documentStore.delete(id);\n      cleaned++;\n    }\n  }\n  \n  return cleaned;\n}\n\nsetInterval(() => {\n  const cleaned = cleanupExpiredDocuments();\n  if (cleaned > 0) {\n    console.log(`[documentService] Cleaned up ${cleaned} expired documents`);\n  }\n}, 5 * 60 * 1000);\n","path":null,"size_bytes":14942,"size_tokens":null},"client/src/graphics/svg/svg-utils.ts":{"content":"import DOMPurify from 'dompurify';\n\nexport function sanitizeSVG(content: string): string {\n  return DOMPurify.sanitize(content, {\n    USE_PROFILES: { svg: true, svgFilters: true },\n    ADD_TAGS: ['use', 'defs', 'clipPath', 'mask', 'pattern', 'linearGradient', 'radialGradient', 'stop', 'filter', 'feGaussianBlur', 'feOffset', 'feMerge', 'feMergeNode', 'feBlend', 'feColorMatrix', 'feComposite', 'feFlood', 'feMorphology', 'feTurbulence', 'feDisplacementMap'],\n    ADD_ATTR: ['xmlns', 'xmlns:xlink', 'xlink:href', 'viewBox', 'preserveAspectRatio', 'transform', 'fill', 'stroke', 'stroke-width', 'stroke-linecap', 'stroke-linejoin', 'stroke-dasharray', 'stroke-dashoffset', 'opacity', 'fill-opacity', 'stroke-opacity', 'font-family', 'font-size', 'font-weight', 'text-anchor', 'dominant-baseline', 'clip-path', 'mask', 'filter', 'marker-start', 'marker-mid', 'marker-end'],\n  });\n}\n\nexport function exportSVGAsString(svgElement: SVGSVGElement): string {\n  const clone = svgElement.cloneNode(true) as SVGSVGElement;\n  \n  if (!clone.hasAttribute('xmlns')) {\n    clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n  }\n  if (!clone.hasAttribute('xmlns:xlink')) {\n    clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');\n  }\n  \n  const styles = getComputedStyles(svgElement);\n  if (styles) {\n    const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');\n    styleElement.textContent = styles;\n    clone.insertBefore(styleElement, clone.firstChild);\n  }\n  \n  const serializer = new XMLSerializer();\n  const svgString = serializer.serializeToString(clone);\n  \n  return '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n' + svgString;\n}\n\nfunction getComputedStyles(svgElement: SVGSVGElement): string | null {\n  const styleSheets = document.styleSheets;\n  let cssRules = '';\n  \n  try {\n    for (let i = 0; i < styleSheets.length; i++) {\n      const sheet = styleSheets[i];\n      if (sheet.cssRules) {\n        for (let j = 0; j < sheet.cssRules.length; j++) {\n          const rule = sheet.cssRules[j];\n          if (rule instanceof CSSStyleRule) {\n            try {\n              if (svgElement.querySelector(rule.selectorText)) {\n                cssRules += rule.cssText + '\\n';\n              }\n            } catch {\n              continue;\n            }\n          }\n        }\n      }\n    }\n  } catch {\n    return null;\n  }\n  \n  return cssRules || null;\n}\n\nexport async function exportSVGAsPNG(\n  svgElement: SVGSVGElement,\n  scale: number = 2\n): Promise<Blob> {\n  return new Promise((resolve, reject) => {\n    const svgString = exportSVGAsString(svgElement);\n    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });\n    const url = URL.createObjectURL(svgBlob);\n    \n    const img = new Image();\n    img.onload = () => {\n      const bbox = svgElement.getBBox();\n      const width = (svgElement.width.baseVal.value || bbox.width || 300) * scale;\n      const height = (svgElement.height.baseVal.value || bbox.height || 150) * scale;\n      \n      const canvas = document.createElement('canvas');\n      canvas.width = width;\n      canvas.height = height;\n      \n      const ctx = canvas.getContext('2d');\n      if (!ctx) {\n        URL.revokeObjectURL(url);\n        reject(new Error('Failed to get canvas context'));\n        return;\n      }\n      \n      ctx.fillStyle = 'white';\n      ctx.fillRect(0, 0, width, height);\n      ctx.drawImage(img, 0, 0, width, height);\n      \n      canvas.toBlob((blob) => {\n        URL.revokeObjectURL(url);\n        if (blob) {\n          resolve(blob);\n        } else {\n          reject(new Error('Failed to create PNG blob'));\n        }\n      }, 'image/png');\n    };\n    \n    img.onerror = () => {\n      URL.revokeObjectURL(url);\n      reject(new Error('Failed to load SVG for PNG conversion'));\n    };\n    \n    img.src = url;\n  });\n}\n\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = filename;\n  document.body.appendChild(a);\n  a.click();\n  document.body.removeChild(a);\n  URL.revokeObjectURL(url);\n}\n\nexport function downloadSVG(svgElement: SVGSVGElement, filename: string = 'export.svg'): void {\n  const svgString = exportSVGAsString(svgElement);\n  const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });\n  downloadBlob(blob, filename);\n}\n\nexport async function downloadPNG(\n  svgElement: SVGSVGElement,\n  filename: string = 'export.png',\n  scale: number = 2\n): Promise<void> {\n  const blob = await exportSVGAsPNG(svgElement, scale);\n  downloadBlob(blob, filename);\n}\n","path":null,"size_bytes":4609,"size_tokens":null},"client/src/components/monaco-code-editor.tsx":{"content":"import React, { Suspense, useCallback, useEffect, useRef, useState } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Loader2 } from \"lucide-react\";\nimport type { OnMount } from \"@monaco-editor/react\";\nimport type * as Monaco from \"monaco-editor\";\n\nconst MonacoEditorLazy = React.lazy(() => import(\"@monaco-editor/react\"));\n\nexport interface MonacoCodeEditorProps {\n  code: string;\n  language?: string;\n  readOnly?: boolean;\n  onChange?: (value: string) => void;\n  onSave?: (value: string) => void;\n  onCancel?: () => void;\n  height?: string;\n  theme?: \"dark\" | \"light\" | \"auto\";\n  highlightedLines?: number[];\n  errorLines?: number[];\n  annotations?: Map<number, string>;\n  className?: string;\n  showMinimap?: boolean;\n}\n\nfunction EditorSkeleton({ height }: { height: string }) {\n  return (\n    <div\n      className=\"flex flex-col gap-2 p-4 bg-zinc-950 rounded-lg\"\n      style={{ height }}\n      data-testid=\"monaco-editor-skeleton\"\n    >\n      <div className=\"flex items-center gap-2\">\n        <Loader2 className=\"w-4 h-4 text-zinc-400 animate-spin\" />\n        <span className=\"text-sm text-zinc-400\">Loading editor...</span>\n      </div>\n      <div className=\"flex-1 space-y-2\">\n        <Skeleton className=\"h-4 w-3/4 bg-zinc-800\" />\n        <Skeleton className=\"h-4 w-1/2 bg-zinc-800\" />\n        <Skeleton className=\"h-4 w-5/6 bg-zinc-800\" />\n        <Skeleton className=\"h-4 w-2/3 bg-zinc-800\" />\n        <Skeleton className=\"h-4 w-4/5 bg-zinc-800\" />\n      </div>\n    </div>\n  );\n}\n\nfunction getTheme(themeProp: \"dark\" | \"light\" | \"auto\"): \"vs-dark\" | \"light\" {\n  if (themeProp === \"auto\") {\n    return document.documentElement.classList.contains(\"dark\") ? \"vs-dark\" : \"light\";\n  }\n  return themeProp === \"dark\" ? \"vs-dark\" : \"light\";\n}\n\nfunction MonacoEditorInner({\n  code,\n  language = \"javascript\",\n  readOnly = false,\n  onChange,\n  onSave,\n  onCancel,\n  height = \"400px\",\n  theme = \"auto\",\n  highlightedLines = [],\n  errorLines = [],\n  annotations = new Map(),\n  showMinimap = false,\n}: MonacoCodeEditorProps) {\n  const editorRef = useRef<Monaco.editor.IStandaloneCodeEditor | null>(null);\n  const monacoRef = useRef<typeof Monaco | null>(null);\n  const decorationsRef = useRef<string[]>([]);\n  const [currentValue, setCurrentValue] = useState(code);\n  const [resolvedTheme, setResolvedTheme] = useState<\"vs-dark\" | \"light\">(() => getTheme(theme));\n\n  useEffect(() => {\n    setCurrentValue(code);\n  }, [code]);\n\n  useEffect(() => {\n    if (theme === \"auto\") {\n      const observer = new MutationObserver(() => {\n        setResolvedTheme(getTheme(\"auto\"));\n      });\n      observer.observe(document.documentElement, {\n        attributes: true,\n        attributeFilter: [\"class\"],\n      });\n      return () => observer.disconnect();\n    } else {\n      setResolvedTheme(getTheme(theme));\n    }\n  }, [theme]);\n\n  const updateDecorations = useCallback(() => {\n    if (!editorRef.current || !monacoRef.current) return;\n\n    const monaco = monacoRef.current;\n    const editor = editorRef.current;\n\n    const decorations: Monaco.editor.IModelDeltaDecoration[] = [];\n\n    errorLines.forEach((line) => {\n      decorations.push({\n        range: new monaco.Range(line, 1, line, 1),\n        options: {\n          isWholeLine: true,\n          className: \"monaco-error-line\",\n          glyphMarginClassName: \"monaco-error-glyph\",\n          linesDecorationsClassName: \"monaco-error-line-decoration\",\n        },\n      });\n    });\n\n    highlightedLines.forEach((line) => {\n      if (!errorLines.includes(line)) {\n        decorations.push({\n          range: new monaco.Range(line, 1, line, 1),\n          options: {\n            isWholeLine: true,\n            className: \"monaco-highlighted-line\",\n            linesDecorationsClassName: \"monaco-highlight-line-decoration\",\n          },\n        });\n      }\n    });\n\n    annotations.forEach((annotation, line) => {\n      decorations.push({\n        range: new monaco.Range(line, 1, line, 1),\n        options: {\n          isWholeLine: true,\n          glyphMarginClassName: \"monaco-annotation-glyph\",\n          glyphMarginHoverMessage: { value: annotation },\n        },\n      });\n    });\n\n    decorationsRef.current = editor.deltaDecorations(decorationsRef.current, decorations);\n  }, [errorLines, highlightedLines, annotations]);\n\n  useEffect(() => {\n    updateDecorations();\n  }, [updateDecorations]);\n\n  const handleEditorDidMount: OnMount = useCallback(\n    (editor, monaco) => {\n      editorRef.current = editor;\n      monacoRef.current = monaco;\n\n      updateDecorations();\n\n      editor.addAction({\n        id: \"save-code\",\n        label: \"Save Code\",\n        keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS],\n        run: () => {\n          if (onSave) {\n            const model = editor.getModel();\n            if (model) {\n              onSave(model.getValue());\n            }\n          }\n        },\n      });\n\n      editor.addAction({\n        id: \"cancel-edit\",\n        label: \"Cancel Edit\",\n        keybindings: [monaco.KeyCode.Escape],\n        run: () => {\n          if (onCancel) {\n            onCancel();\n          }\n        },\n      });\n    },\n    [updateDecorations, onSave, onCancel]\n  );\n\n  const handleChange = useCallback(\n    (value: string | undefined) => {\n      const newValue = value || \"\";\n      setCurrentValue(newValue);\n      onChange?.(newValue);\n    },\n    [onChange]\n  );\n\n  return (\n    <div className=\"monaco-editor-wrapper\" data-testid=\"monaco-editor-wrapper\">\n      <style>{`\n        .monaco-error-line {\n          background-color: rgba(239, 68, 68, 0.2) !important;\n        }\n        .monaco-error-glyph {\n          background-color: #ef4444;\n          width: 4px !important;\n          margin-left: 3px;\n        }\n        .monaco-error-line-decoration {\n          background-color: #ef4444;\n          width: 2px !important;\n        }\n        .monaco-highlighted-line {\n          background-color: rgba(234, 179, 8, 0.1) !important;\n        }\n        .monaco-highlight-line-decoration {\n          background-color: #eab308;\n          width: 2px !important;\n        }\n        .monaco-annotation-glyph {\n          background-color: #3b82f6;\n          width: 4px !important;\n          margin-left: 3px;\n          border-radius: 2px;\n        }\n      `}</style>\n      <MonacoEditorLazy\n        height={height}\n        language={language}\n        value={currentValue}\n        theme={resolvedTheme}\n        onChange={handleChange}\n        onMount={handleEditorDidMount}\n        options={{\n          readOnly,\n          minimap: { enabled: showMinimap },\n          fontSize: 14,\n          fontFamily: \"'JetBrains Mono', 'Fira Code', 'Monaco', monospace\",\n          lineNumbers: \"on\",\n          glyphMargin: true,\n          folding: true,\n          lineDecorationsWidth: 10,\n          lineNumbersMinChars: 3,\n          scrollBeyondLastLine: false,\n          automaticLayout: true,\n          tabSize: 2,\n          wordWrap: \"on\",\n          padding: { top: 12, bottom: 12 },\n          renderLineHighlight: \"line\",\n          cursorBlinking: \"smooth\",\n          cursorSmoothCaretAnimation: \"on\",\n          smoothScrolling: true,\n          contextmenu: true,\n          formatOnPaste: true,\n          formatOnType: true,\n        }}\n      />\n    </div>\n  );\n}\n\nexport function MonacoCodeEditor(props: MonacoCodeEditorProps) {\n  return (\n    <div className={cn(\"rounded-lg overflow-hidden border border-zinc-800\", props.className)}>\n      <Suspense fallback={<EditorSkeleton height={props.height || \"400px\"} />}>\n        <MonacoEditorInner {...props} />\n      </Suspense>\n    </div>\n  );\n}\n","path":null,"size_bytes":7614,"size_tokens":null},"client/src/contexts/SettingsContext.tsx":{"content":"import { createContext, useContext, useEffect, ReactNode } from \"react\";\nimport { useSettings, applyTheme, applyAccentColor, UserSettings } from \"@/hooks/use-settings\";\nimport { useAuth } from \"@/hooks/use-auth\";\n\ninterface SettingsContextType {\n  settings: UserSettings;\n  updateSetting: <K extends keyof UserSettings>(key: K, value: UserSettings[K]) => void;\n  updateSettings: (updates: Partial<UserSettings>) => void;\n  resetSettings: () => void;\n  syncSettingsToServer: () => Promise<boolean>;\n  loadSettingsFromServer: () => Promise<boolean>;\n  isSyncing: boolean;\n  isAuthenticated: boolean;\n}\n\nconst SettingsContext = createContext<SettingsContextType | null>(null);\n\nexport function useSettingsContext() {\n  const context = useContext(SettingsContext);\n  if (!context) {\n    throw new Error(\"useSettingsContext must be used within SettingsProvider\");\n  }\n  return context;\n}\n\nexport function SettingsProvider({ children }: { children: ReactNode }) {\n  const { user, isAuthenticated } = useAuth();\n  const { settings, updateSetting, updateSettings, resetSettings, syncSettingsToServer, loadSettingsFromServer, isSyncing } = useSettings(user?.id);\n\n  useEffect(() => {\n    applyTheme(settings.appearance);\n    \n    const mediaQuery = window.matchMedia(\"(prefers-color-scheme: dark)\");\n    const handleChange = () => {\n      if (settings.appearance === \"system\") {\n        applyTheme(\"system\");\n        applyAccentColor(settings.accentColor);\n      }\n    };\n    \n    mediaQuery.addEventListener(\"change\", handleChange);\n    return () => mediaQuery.removeEventListener(\"change\", handleChange);\n  }, [settings.appearance]);\n\n  useEffect(() => {\n    applyAccentColor(settings.accentColor);\n  }, [settings.accentColor, settings.appearance]);\n\n  const wrappedUpdateSetting = <K extends keyof UserSettings>(key: K, value: UserSettings[K]) => {\n    updateSetting(key, value);\n    \n    if (key === \"appearance\") {\n      applyTheme(value as UserSettings[\"appearance\"]);\n      setTimeout(() => applyAccentColor(settings.accentColor), 0);\n    }\n    if (key === \"accentColor\") {\n      applyAccentColor(value as UserSettings[\"accentColor\"]);\n    }\n  };\n\n  return (\n    <SettingsContext.Provider value={{ \n      settings, \n      updateSetting: wrappedUpdateSetting, \n      updateSettings, \n      resetSettings,\n      syncSettingsToServer,\n      loadSettingsFromServer,\n      isSyncing,\n      isAuthenticated,\n    }}>\n      {children}\n    </SettingsContext.Provider>\n  );\n}\n","path":null,"size_bytes":2464,"size_tokens":null},"client/src/hooks/use-settings.ts":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\n\nexport interface UserSettings {\n  // Display\n  appearance: \"system\" | \"light\" | \"dark\";\n  accentColor: \"default\" | \"blue\" | \"green\" | \"purple\" | \"orange\" | \"pink\";\n  fontSize: \"small\" | \"medium\" | \"large\";\n  density: \"compact\" | \"comfortable\" | \"spacious\";\n  \n  // Language & Region\n  spokenLanguage: string;\n  dateFormat: \"dd/mm/yyyy\" | \"mm/dd/yyyy\" | \"yyyy-mm-dd\";\n  timeFormat: \"12h\" | \"24h\";\n  timezone: string;\n  \n  // Voice & Audio\n  voice: string;\n  voiceSpeed: number;\n  voiceVolume: number;\n  independentVoiceMode: boolean;\n  autoPlayResponses: boolean;\n  \n  // AI Models\n  showAdditionalModels: boolean;\n  defaultModel: string;\n  streamResponses: boolean;\n  \n  // Keyboard & Accessibility\n  keyboardShortcuts: boolean;\n  reducedMotion: boolean;\n  highContrast: boolean;\n  \n  // Notifications\n  notifResponses: \"push\" | \"email\" | \"push_email\" | \"none\";\n  notifTasks: \"push\" | \"email\" | \"push_email\" | \"none\";\n  notifProjects: \"push\" | \"email\" | \"push_email\" | \"none\";\n  notifRecommendations: \"push\" | \"email\" | \"push_email\" | \"none\";\n  \n  // Personalization\n  styleAndTone: \"default\" | \"formal\" | \"casual\" | \"concise\";\n  customInstructions: string;\n  nickname: string;\n  occupation: string;\n  aboutYou: string;\n  allowMemories: boolean;\n  allowRecordings: boolean;\n  webSearch: boolean;\n  codeInterpreter: boolean;\n  canvas: boolean;\n  voiceMode: boolean;\n  advancedVoice: boolean;\n  connectorSearch: boolean;\n  \n  // Data controls\n  improveModel: boolean;\n  remoteBrowser: boolean;\n  shareLocation: boolean;\n  \n  // Security\n  authApp: boolean;\n  pushNotifications: boolean;\n  \n  // Account\n  showName: boolean;\n  receiveEmailComments: boolean;\n  linkedInUrl: string;\n  githubUrl: string;\n  websiteDomain: string;\n}\n\ninterface ApiUserSettings {\n  userId: string;\n  responsePreferences: {\n    responseStyle: string;\n    responseTone?: string;\n    customInstructions: string;\n  };\n  userProfile: {\n    nickname: string;\n    occupation: string;\n    bio: string;\n  };\n  featureFlags: {\n    memoryEnabled: boolean;\n    recordingHistoryEnabled: boolean;\n    webSearchAuto: boolean;\n    codeInterpreterEnabled: boolean;\n    canvasEnabled: boolean;\n    voiceEnabled: boolean;\n    voiceAdvanced: boolean;\n    connectorSearchAuto: boolean;\n  };\n}\n\nconst defaultSettings: UserSettings = {\n  // Display\n  appearance: \"system\",\n  accentColor: \"default\",\n  fontSize: \"medium\",\n  density: \"comfortable\",\n  \n  // Language & Region\n  spokenLanguage: \"auto\",\n  dateFormat: \"dd/mm/yyyy\",\n  timeFormat: \"24h\",\n  timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n  \n  // Voice & Audio\n  voice: \"cove\",\n  voiceSpeed: 1.0,\n  voiceVolume: 1.0,\n  independentVoiceMode: false,\n  autoPlayResponses: false,\n  \n  // AI Models\n  showAdditionalModels: true,\n  defaultModel: \"gemini-2.5-flash\",\n  streamResponses: true,\n  \n  // Keyboard & Accessibility\n  keyboardShortcuts: true,\n  reducedMotion: false,\n  highContrast: false,\n  \n  // Notifications\n  notifResponses: \"push\",\n  notifTasks: \"push_email\",\n  notifProjects: \"email\",\n  notifRecommendations: \"push_email\",\n  \n  // Personalization\n  styleAndTone: \"default\",\n  customInstructions: \"\",\n  nickname: \"\",\n  occupation: \"\",\n  aboutYou: \"\",\n  allowMemories: true,\n  allowRecordings: false,\n  webSearch: true,\n  codeInterpreter: true,\n  canvas: true,\n  voiceMode: true,\n  advancedVoice: false,\n  connectorSearch: false,\n  \n  // Data controls\n  improveModel: false,\n  remoteBrowser: true,\n  shareLocation: false,\n  \n  // Security\n  authApp: false,\n  pushNotifications: false,\n  \n  // Account\n  showName: true,\n  receiveEmailComments: false,\n  linkedInUrl: \"\",\n  githubUrl: \"\",\n  websiteDomain: \"\",\n};\n\nconst STORAGE_KEY = \"sira_user_settings\";\nconst SYNC_DEBOUNCE_MS = 500;\n\nfunction loadSettings(): UserSettings {\n  try {\n    const stored = localStorage.getItem(STORAGE_KEY);\n    if (stored) {\n      const parsed = JSON.parse(stored);\n      return { ...defaultSettings, ...parsed };\n    }\n  } catch (e) {\n    console.error(\"Failed to load settings:\", e);\n  }\n  return defaultSettings;\n}\n\nfunction saveSettings(settings: UserSettings): void {\n  try {\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));\n  } catch (e) {\n    console.error(\"Failed to save settings:\", e);\n  }\n}\n\nfunction mapLocalToApiSettings(settings: UserSettings): Omit<ApiUserSettings, 'userId'> {\n  return {\n    responsePreferences: {\n      responseStyle: settings.styleAndTone,\n      customInstructions: settings.customInstructions,\n    },\n    userProfile: {\n      nickname: settings.nickname,\n      occupation: settings.occupation,\n      bio: settings.aboutYou,\n    },\n    featureFlags: {\n      memoryEnabled: settings.allowMemories,\n      recordingHistoryEnabled: settings.allowRecordings,\n      webSearchAuto: settings.webSearch,\n      codeInterpreterEnabled: settings.codeInterpreter,\n      canvasEnabled: settings.canvas,\n      voiceEnabled: settings.voiceMode,\n      voiceAdvanced: settings.advancedVoice,\n      connectorSearchAuto: settings.connectorSearch,\n    },\n  };\n}\n\nfunction mapApiToLocalSettings(apiSettings: ApiUserSettings): Partial<UserSettings> {\n  return {\n    styleAndTone: (apiSettings.responsePreferences?.responseStyle as UserSettings['styleAndTone']) || 'default',\n    customInstructions: apiSettings.responsePreferences?.customInstructions || '',\n    nickname: apiSettings.userProfile?.nickname || '',\n    occupation: apiSettings.userProfile?.occupation || '',\n    aboutYou: apiSettings.userProfile?.bio || '',\n    allowMemories: apiSettings.featureFlags?.memoryEnabled ?? true,\n    allowRecordings: apiSettings.featureFlags?.recordingHistoryEnabled ?? false,\n    webSearch: apiSettings.featureFlags?.webSearchAuto ?? true,\n    codeInterpreter: apiSettings.featureFlags?.codeInterpreterEnabled ?? true,\n    canvas: apiSettings.featureFlags?.canvasEnabled ?? true,\n    voiceMode: apiSettings.featureFlags?.voiceEnabled ?? true,\n    advancedVoice: apiSettings.featureFlags?.voiceAdvanced ?? false,\n    connectorSearch: apiSettings.featureFlags?.connectorSearchAuto ?? false,\n  };\n}\n\nasync function fetchUserSettings(userId: string): Promise<ApiUserSettings | null> {\n  try {\n    const response = await fetch(`/api/users/${userId}/settings`, {\n      credentials: 'include',\n    });\n    if (!response.ok) {\n      if (response.status === 401) {\n        return null;\n      }\n      console.warn(\"Failed to fetch settings from server:\", response.status);\n      return null;\n    }\n    return await response.json();\n  } catch (e) {\n    console.error(\"Error fetching settings from server:\", e);\n    return null;\n  }\n}\n\nasync function saveUserSettings(userId: string, settings: Omit<ApiUserSettings, 'userId'>): Promise<boolean> {\n  try {\n    const response = await fetch(`/api/users/${userId}/settings`, {\n      method: 'PUT',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      credentials: 'include',\n      body: JSON.stringify(settings),\n    });\n    if (!response.ok) {\n      console.error(\"Failed to save settings to server:\", response.status);\n      return false;\n    }\n    return true;\n  } catch (e) {\n    console.error(\"Error saving settings to server:\", e);\n    return false;\n  }\n}\n\nexport function useSettings(userId?: string | null) {\n  const [settings, setSettingsState] = useState<UserSettings>(loadSettings);\n  const [isSyncing, setIsSyncing] = useState(false);\n  const syncTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const lastSyncedRef = useRef<string>('');\n  const prevUserIdRef = useRef<string | null | undefined>(undefined);\n\n  const syncSettingsToServer = useCallback(async (settingsToSync?: UserSettings): Promise<boolean> => {\n    if (!userId) {\n      console.log(\"No user ID found, skipping server sync\");\n      return false;\n    }\n\n    const currentSettings = settingsToSync || settings;\n    const apiSettings = mapLocalToApiSettings(currentSettings);\n    \n    setIsSyncing(true);\n    try {\n      const success = await saveUserSettings(userId, apiSettings);\n      if (success) {\n        lastSyncedRef.current = JSON.stringify(apiSettings);\n      }\n      return success;\n    } finally {\n      setIsSyncing(false);\n    }\n  }, [settings, userId]);\n\n  const loadSettingsFromServer = useCallback(async (): Promise<boolean> => {\n    if (!userId) {\n      console.log(\"No user ID found, skipping server load\");\n      return false;\n    }\n\n    setIsSyncing(true);\n    try {\n      const apiSettings = await fetchUserSettings(userId);\n      if (apiSettings) {\n        const mappedSettings = mapApiToLocalSettings(apiSettings);\n        setSettingsState((prev) => {\n          const merged = { ...prev, ...mappedSettings };\n          saveSettings(merged);\n          return merged;\n        });\n        lastSyncedRef.current = JSON.stringify(mapLocalToApiSettings({ ...settings, ...mappedSettings }));\n        return true;\n      }\n      return false;\n    } finally {\n      setIsSyncing(false);\n    }\n  }, [settings, userId]);\n\n  const debouncedSyncToServer = useCallback((newSettings: UserSettings) => {\n    if (syncTimeoutRef.current) {\n      clearTimeout(syncTimeoutRef.current);\n    }\n\n    syncTimeoutRef.current = setTimeout(() => {\n      const apiSettings = mapLocalToApiSettings(newSettings);\n      const currentApiSettingsStr = JSON.stringify(apiSettings);\n      \n      if (currentApiSettingsStr !== lastSyncedRef.current) {\n        syncSettingsToServer(newSettings);\n      }\n    }, SYNC_DEBOUNCE_MS);\n  }, [syncSettingsToServer]);\n\n  const updateSetting = useCallback(<K extends keyof UserSettings>(\n    key: K,\n    value: UserSettings[K]\n  ) => {\n    setSettingsState((prev) => {\n      const updated = { ...prev, [key]: value };\n      saveSettings(updated);\n      debouncedSyncToServer(updated);\n      return updated;\n    });\n  }, [debouncedSyncToServer]);\n\n  const updateSettings = useCallback((updates: Partial<UserSettings>) => {\n    setSettingsState((prev) => {\n      const updated = { ...prev, ...updates };\n      saveSettings(updated);\n      debouncedSyncToServer(updated);\n      return updated;\n    });\n  }, [debouncedSyncToServer]);\n\n  const resetSettings = useCallback(() => {\n    saveSettings(defaultSettings);\n    setSettingsState(defaultSettings);\n    debouncedSyncToServer(defaultSettings);\n  }, [debouncedSyncToServer]);\n\n  useEffect(() => {\n    if (userId && prevUserIdRef.current !== userId) {\n      loadSettingsFromServer();\n    }\n    prevUserIdRef.current = userId;\n  }, [userId, loadSettingsFromServer]);\n\n  useEffect(() => {\n    const handleStorage = (e: StorageEvent) => {\n      if (e.key === STORAGE_KEY && e.newValue) {\n        try {\n          setSettingsState(JSON.parse(e.newValue));\n        } catch {}\n      }\n    };\n    window.addEventListener(\"storage\", handleStorage);\n    return () => window.removeEventListener(\"storage\", handleStorage);\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      if (syncTimeoutRef.current) {\n        clearTimeout(syncTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  return {\n    settings,\n    updateSetting,\n    updateSettings,\n    resetSettings,\n    syncSettingsToServer,\n    loadSettingsFromServer,\n    isSyncing,\n  };\n}\n\nexport function applyAccentColor(color: UserSettings[\"accentColor\"]) {\n  const root = document.documentElement;\n  \n  const accentColors: Record<UserSettings[\"accentColor\"], { light: string; dark: string }> = {\n    default: { light: \"0 0% 0%\", dark: \"0 0% 100%\" },\n    blue: { light: \"217 91% 50%\", dark: \"217 91% 60%\" },\n    green: { light: \"142 71% 45%\", dark: \"142 71% 55%\" },\n    purple: { light: \"271 81% 56%\", dark: \"271 81% 66%\" },\n    orange: { light: \"25 95% 53%\", dark: \"25 95% 63%\" },\n    pink: { light: \"330 81% 60%\", dark: \"330 81% 70%\" },\n  };\n  \n  const isDark = root.classList.contains(\"dark\");\n  const colors = accentColors[color];\n  const primaryColor = isDark ? colors.dark : colors.light;\n  \n  root.style.setProperty(\"--primary\", primaryColor);\n  root.style.setProperty(\"--ring\", primaryColor);\n  \n  if (color === \"default\") {\n    root.style.removeProperty(\"--primary\");\n    root.style.removeProperty(\"--ring\");\n  }\n}\n\nexport function applyTheme(theme: UserSettings[\"appearance\"]) {\n  const root = document.documentElement;\n  \n  if (theme === \"system\") {\n    const prefersDark = window.matchMedia(\"(prefers-color-scheme: dark)\").matches;\n    root.classList.toggle(\"dark\", prefersDark);\n  } else {\n    root.classList.toggle(\"dark\", theme === \"dark\");\n  }\n}\n","path":null,"size_bytes":12413,"size_tokens":null},"server/services/toolRuntime.ts":{"content":"import { logToolCall } from \"./integrationPolicyService\";\nimport { storage } from \"../storage\";\n\ninterface ToolCallOptions {\n  timeout?: number; // ms, default 30000\n  retries?: number; // default 2\n  idempotencyKey?: string;\n}\n\ninterface ToolCallResult {\n  success: boolean;\n  data?: any;\n  error?: string;\n  latencyMs: number;\n}\n\nconst DEFAULT_TIMEOUT = 30000;\nconst DEFAULT_RETRIES = 2;\n\n// In-memory cache for idempotency (in production, use Redis)\nconst idempotencyCache = new Map<string, ToolCallResult>();\n\nasync function withTimeout<T>(\n  promise: Promise<T>,\n  timeoutMs: number\n): Promise<T> {\n  return Promise.race([\n    promise,\n    new Promise<T>((_, reject) =>\n      setTimeout(() => reject(new Error(\"TIMEOUT\")), timeoutMs)\n    ),\n  ]);\n}\n\nasync function sleep(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport async function executeToolCall(\n  userId: string,\n  toolId: string,\n  providerId: string,\n  accountId: string | null,\n  input: any,\n  executor: () => Promise<any>,\n  options: ToolCallOptions = {}\n): Promise<ToolCallResult> {\n  const {\n    timeout = DEFAULT_TIMEOUT,\n    retries = DEFAULT_RETRIES,\n    idempotencyKey,\n  } = options;\n\n  if (idempotencyKey && idempotencyCache.has(idempotencyKey)) {\n    const cached = idempotencyCache.get(idempotencyKey)!;\n    return cached;\n  }\n\n  const startTime = Date.now();\n  let lastError: Error | null = null;\n  let attempt = 0;\n\n  while (attempt <= retries) {\n    try {\n      const data = await withTimeout(executor(), timeout);\n      const latencyMs = Date.now() - startTime;\n\n      const result: ToolCallResult = {\n        success: true,\n        data,\n        latencyMs,\n      };\n\n      // Log successful call\n      await logToolCall(\n        userId,\n        toolId,\n        providerId,\n        input,\n        data,\n        \"success\",\n        latencyMs\n      );\n\n      // Cache for idempotency\n      if (idempotencyKey) {\n        idempotencyCache.set(idempotencyKey, result);\n        // Clean up after 1 hour\n        setTimeout(() => idempotencyCache.delete(idempotencyKey), 3600000);\n      }\n\n      return result;\n    } catch (error: any) {\n      lastError = error;\n      attempt++;\n\n      if (attempt <= retries) {\n        // Exponential backoff: 1s, 2s, 4s...\n        await sleep(1000 * Math.pow(2, attempt - 1));\n      }\n    }\n  }\n\n  const latencyMs = Date.now() - startTime;\n  const errorStatus = lastError?.message === \"TIMEOUT\" ? \"timeout\" : \"error\";\n\n  // Log failed call\n  await logToolCall(\n    userId,\n    toolId,\n    providerId,\n    input,\n    null,\n    errorStatus,\n    latencyMs,\n    lastError?.message\n  );\n\n  return {\n    success: false,\n    error: lastError?.message || \"Unknown error\",\n    latencyMs,\n  };\n}\n\n// Cleanup old idempotency cache entries periodically\nsetInterval(() => {\n  const oneHourAgo = Date.now() - 3600000;\n  // In a real implementation, we'd track timestamps\n  // For now, the per-key timeout handles cleanup\n}, 60000);\n\nexport { ToolCallOptions, ToolCallResult };\n","path":null,"size_bytes":3020,"size_tokens":null},"server/services/integrationPolicyService.ts":{"content":"import { storage } from \"../storage\";\n\nexport interface PolicyCheckResult {\n  allowed: boolean;\n  reason?: string;\n  requiresConfirmation?: boolean;\n}\n\nexport async function checkToolPolicy(\n  userId: string,\n  toolId: string,\n  providerId: string\n): Promise<PolicyCheckResult> {\n  try {\n    const policy = await storage.getIntegrationPolicy(userId);\n    \n    if (!policy) {\n      return { allowed: true };\n    }\n    \n    if (policy.disabledTools?.includes(toolId)) {\n      return { allowed: false, reason: \"Tool is disabled by user preference\" };\n    }\n    \n    if (policy.enabledApps && policy.enabledApps.length > 0) {\n      if (!policy.enabledApps.includes(providerId)) {\n        return { allowed: false, reason: `Provider ${providerId} is not enabled` };\n      }\n    }\n    \n    const tools = await storage.getIntegrationTools(providerId);\n    const tool = tools.find(t => t.id === toolId);\n    \n    if (tool?.confirmationRequired === \"true\" && policy.autoConfirmPolicy !== \"always\") {\n      return { \n        allowed: true, \n        requiresConfirmation: policy.autoConfirmPolicy === \"ask\" \n      };\n    }\n    \n    return { allowed: true };\n  } catch (error) {\n    console.error(\"Error checking tool policy:\", error);\n    return { allowed: true };\n  }\n}\n\nexport async function logToolCall(\n  userId: string,\n  toolId: string,\n  providerId: string,\n  input: any,\n  output: any,\n  status: string,\n  latencyMs: number,\n  errorMessage?: string\n): Promise<void> {\n  try {\n    const redactSensitive = (obj: any) => {\n      if (!obj) return obj;\n      const redacted = { ...obj };\n      const sensitiveKeys = [\"password\", \"token\", \"secret\", \"key\", \"auth\", \"credential\"];\n      for (const key of Object.keys(redacted)) {\n        if (sensitiveKeys.some(s => key.toLowerCase().includes(s))) {\n          redacted[key] = \"[REDACTED]\";\n        }\n      }\n      return redacted;\n    };\n    \n    await storage.createToolCallLog({\n      userId,\n      toolId,\n      providerId,\n      inputRedacted: redactSensitive(input),\n      outputRedacted: redactSensitive(output),\n      status,\n      latencyMs,\n      errorMessage,\n    });\n  } catch (error) {\n    console.error(\"Error logging tool call:\", error);\n  }\n}\n","path":null,"size_bytes":2196,"size_tokens":null},"server/services/notificationDispatcher.ts":{"content":"import { storage } from \"../storage\";\nimport type { NotificationEventType, NotificationPreference } from \"@shared/schema\";\n\ninterface NotificationPayload {\n  userId: string;\n  eventTypeId: string;\n  title: string;\n  body: string;\n  data?: Record<string, any>;\n  actionUrl?: string;\n}\n\ninterface ChannelResult {\n  sent: boolean;\n  error?: string;\n}\n\ninterface DispatchResult {\n  success: boolean;\n  skipped: boolean;\n  channels: {\n    push?: ChannelResult;\n    email?: ChannelResult;\n  };\n  error?: string;\n}\n\nasync function sendPushNotification(\n  userId: string,\n  title: string,\n  body: string,\n  data?: Record<string, any>,\n  actionUrl?: string\n): Promise<ChannelResult> {\n  try {\n    return { sent: true };\n  } catch (error: any) {\n    console.error(`[Push] Failed for ${userId}:`, error);\n    return { sent: false, error: error.message };\n  }\n}\n\nasync function sendEmailNotification(\n  userId: string,\n  title: string,\n  body: string,\n  data?: Record<string, any>,\n  actionUrl?: string\n): Promise<ChannelResult> {\n  try {\n    const user = await storage.getUser(userId);\n    if (!user?.email) {\n      return { sent: false, error: \"No email address\" };\n    }\n    return { sent: true };\n  } catch (error: any) {\n    console.error(`[Email] Failed for ${userId}:`, error);\n    return { sent: false, error: error.message };\n  }\n}\n\nfunction parseChannels(channels: string): { push: boolean; email: boolean } {\n  return {\n    push: channels === \"push\" || channels === \"push_email\",\n    email: channels === \"email\" || channels === \"push_email\",\n  };\n}\n\nexport async function dispatchNotification(\n  payload: NotificationPayload\n): Promise<DispatchResult> {\n  const { userId, eventTypeId, title, body, data, actionUrl } = payload;\n  const result: DispatchResult = { success: false, skipped: false, channels: {} };\n\n  try {\n    const preferences = await storage.getNotificationPreferences(userId);\n    const pref = preferences.find((p) => p.eventTypeId === eventTypeId);\n\n    if (pref && !pref.enabled) {\n      return { success: false, skipped: true, channels: {} };\n    }\n\n    const eventTypes = await storage.getNotificationEventTypes();\n    const eventType = eventTypes.find((e) => e.id === eventTypeId);\n\n    const channelStr = pref?.channels || eventType?.defaultChannels || \"push\";\n    const channels = parseChannels(channelStr);\n\n    if (!channels.push && !channels.email) {\n      return { success: false, skipped: true, channels: {} };\n    }\n\n    const promises: Promise<void>[] = [];\n\n    if (channels.push) {\n      promises.push(\n        sendPushNotification(userId, title, body, data, actionUrl).then((r) => {\n          result.channels.push = r;\n        })\n      );\n    }\n\n    if (channels.email) {\n      promises.push(\n        sendEmailNotification(userId, title, body, data, actionUrl).then((r) => {\n          result.channels.email = r;\n        })\n      );\n    }\n\n    await Promise.all(promises);\n\n    const channelResults = Object.values(result.channels).filter(Boolean);\n    result.success = channelResults.length > 0 && channelResults.some((c) => c?.sent);\n\n    if (!result.success && channelResults.length > 0) {\n      const errors = channelResults\n        .filter((c) => c?.error)\n        .map((c) => c!.error);\n      if (errors.length > 0) {\n        result.error = errors.join(\"; \");\n      }\n    }\n  } catch (error: any) {\n    console.error(`[Dispatcher] Error:`, error);\n    result.error = error.message;\n  }\n\n  return result;\n}\n\nexport async function dispatchToMultipleUsers(\n  userIds: string[],\n  eventTypeId: string,\n  title: string,\n  body: string,\n  data?: Record<string, any>,\n  actionUrl?: string\n): Promise<Map<string, DispatchResult>> {\n  const results = new Map<string, DispatchResult>();\n\n  await Promise.all(\n    userIds.map(async (userId) => {\n      const result = await dispatchNotification({\n        userId,\n        eventTypeId,\n        title,\n        body,\n        data,\n        actionUrl,\n      });\n      results.set(userId, result);\n    })\n  );\n\n  return results;\n}\n\nexport { NotificationPayload, DispatchResult, ChannelResult };\n","path":null,"size_bytes":4063,"size_tokens":null},"client/src/components/voice-chat-mode.tsx":{"content":"import React, { useState, useRef, useEffect, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { X, Mic, MicOff, Volume2, VolumeX, Loader2, Video, VideoOff, Upload, Camera } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { cn } from \"@/lib/utils\";\n\ninterface VoiceChatModeProps {\n  open: boolean;\n  onClose: () => void;\n}\n\ntype InputMode = \"idle\" | \"mic\" | \"camera\" | \"uploading\";\n\nexport function VoiceChatMode({ open, onClose }: VoiceChatModeProps) {\n  const [inputMode, setInputMode] = useState<InputMode>(\"idle\");\n  const [isListening, setIsListening] = useState(false);\n  const [isSpeaking, setIsSpeaking] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [isCameraActive, setIsCameraActive] = useState(false);\n  const [audioLevel, setAudioLevel] = useState(0);\n  const [transcript, setTranscript] = useState(\"\");\n  const [response, setResponse] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [cameraError, setCameraError] = useState<string | null>(null);\n  \n  const recognitionRef = useRef<any>(null);\n  const audioContextRef = useRef<AudioContext | null>(null);\n  const analyserRef = useRef<AnalyserNode | null>(null);\n  const mediaStreamRef = useRef<MediaStream | null>(null);\n  const videoStreamRef = useRef<MediaStream | null>(null);\n  const videoRef = useRef<HTMLVideoElement | null>(null);\n  const animationFrameRef = useRef<number | null>(null);\n  const speechSynthesisRef = useRef<SpeechSynthesisUtterance | null>(null);\n  const fileInputRef = useRef<HTMLInputElement | null>(null);\n\n  // Clean up on unmount or close\n  useEffect(() => {\n    if (!open) {\n      stopListening();\n      stopSpeaking();\n      stopCamera();\n      cleanupAudio();\n      setInputMode(\"idle\");\n    }\n    return () => {\n      stopListening();\n      stopSpeaking();\n      stopCamera();\n      cleanupAudio();\n    };\n  }, [open]);\n\n  const cleanupAudio = () => {\n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n    }\n    if (mediaStreamRef.current) {\n      mediaStreamRef.current.getTracks().forEach(track => track.stop());\n    }\n    if (audioContextRef.current) {\n      audioContextRef.current.close();\n    }\n  };\n\n  const startAudioAnalysis = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n      mediaStreamRef.current = stream;\n      \n      audioContextRef.current = new AudioContext();\n      analyserRef.current = audioContextRef.current.createAnalyser();\n      analyserRef.current.fftSize = 256;\n      \n      const source = audioContextRef.current.createMediaStreamSource(stream);\n      source.connect(analyserRef.current);\n      \n      const dataArray = new Uint8Array(analyserRef.current.frequencyBinCount);\n      \n      const updateLevel = () => {\n        if (!analyserRef.current) return;\n        analyserRef.current.getByteFrequencyData(dataArray);\n        const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;\n        setAudioLevel(average / 255);\n        animationFrameRef.current = requestAnimationFrame(updateLevel);\n      };\n      \n      updateLevel();\n    } catch (err) {\n      console.error(\"Error accessing microphone:\", err);\n      setError(\"No se pudo acceder al micrófono\");\n    }\n  };\n\n  const startListening = useCallback(() => {\n    const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;\n    \n    if (!SpeechRecognition) {\n      setError(\"Tu navegador no soporta reconocimiento de voz\");\n      return;\n    }\n\n    setError(null);\n    setTranscript(\"\");\n    setInputMode(\"mic\");\n    \n    const recognition = new SpeechRecognition();\n    recognition.continuous = false;\n    recognition.interimResults = true;\n    recognition.lang = 'es-ES';\n\n    recognition.onstart = () => {\n      setIsListening(true);\n      startAudioAnalysis();\n    };\n\n    recognition.onresult = (event: any) => {\n      let finalTranscript = '';\n      let interimTranscript = '';\n      \n      for (let i = 0; i < event.results.length; i++) {\n        const transcript = event.results[i][0].transcript;\n        if (event.results[i].isFinal) {\n          finalTranscript += transcript;\n        } else {\n          interimTranscript = transcript;\n        }\n      }\n      \n      setTranscript(finalTranscript || interimTranscript);\n    };\n\n    recognition.onend = async () => {\n      setIsListening(false);\n      cleanupAudio();\n      setAudioLevel(0);\n      \n      if (transcript.trim()) {\n        await sendToGrok(transcript);\n      }\n      setInputMode(\"idle\");\n    };\n\n    recognition.onerror = (event: any) => {\n      console.error('Speech recognition error:', event.error);\n      setIsListening(false);\n      cleanupAudio();\n      setAudioLevel(0);\n      setInputMode(\"idle\");\n      if (event.error !== 'no-speech') {\n        setError(`Error: ${event.error}`);\n      }\n    };\n\n    recognitionRef.current = recognition;\n    recognition.start();\n  }, [transcript]);\n\n  const stopListening = () => {\n    if (recognitionRef.current) {\n      recognitionRef.current.stop();\n      recognitionRef.current = null;\n    }\n    setIsListening(false);\n    cleanupAudio();\n    setAudioLevel(0);\n    setInputMode(\"idle\");\n  };\n\n  const stopSpeaking = () => {\n    window.speechSynthesis.cancel();\n    setIsSpeaking(false);\n  };\n\n  // Camera functions\n  const startCamera = async () => {\n    try {\n      setCameraError(null);\n      setInputMode(\"camera\");\n      const stream = await navigator.mediaDevices.getUserMedia({ \n        video: { facingMode: \"user\", width: { ideal: 1280 }, height: { ideal: 720 } },\n        audio: true \n      });\n      videoStreamRef.current = stream;\n      setIsCameraActive(true);\n      \n      if (videoRef.current) {\n        videoRef.current.srcObject = stream;\n      }\n    } catch (err: any) {\n      console.error(\"Error accessing camera:\", err);\n      setCameraError(\"No se pudo acceder a la cámara\");\n      setInputMode(\"idle\");\n    }\n  };\n\n  const stopCamera = () => {\n    if (videoStreamRef.current) {\n      videoStreamRef.current.getTracks().forEach(track => track.stop());\n      videoStreamRef.current = null;\n    }\n    setIsCameraActive(false);\n    setInputMode(\"idle\");\n  };\n\n  // File upload functions\n  const handleFileUpload = () => {\n    fileInputRef.current?.click();\n  };\n\n  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files || files.length === 0) return;\n    \n    setInputMode(\"uploading\");\n    const file = files[0];\n    \n    // Validate file\n    const maxSize = 50 * 1024 * 1024; // 50MB\n    if (file.size > maxSize) {\n      setError(\"El archivo es demasiado grande (máximo 50MB)\");\n      setInputMode(\"idle\");\n      return;\n    }\n    \n    try {\n      // Get signed upload URL from server\n      const uploadRes = await fetch(\"/api/objects/upload\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n      \n      if (!uploadRes.ok) {\n        throw new Error(\"No se pudo obtener la URL de subida\");\n      }\n      \n      const { uploadURL, storagePath } = await uploadRes.json();\n      \n      // Upload file directly to storage\n      const putRes = await fetch(uploadURL, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": file.type || \"application/octet-stream\" },\n        body: file,\n      });\n      \n      if (!putRes.ok) {\n        throw new Error(\"Error al subir el archivo al almacenamiento\");\n      }\n      \n      // Register file in database\n      const registerRes = await fetch(\"/api/files/quick\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          name: file.name,\n          type: file.type || \"application/octet-stream\",\n          size: file.size,\n          storagePath,\n        }),\n      });\n      \n      if (!registerRes.ok) {\n        throw new Error(\"Archivo subido pero no se pudo registrar\");\n      }\n      \n      setResponse(`Archivo subido: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);\n      \n    } catch (err: any) {\n      setError(err.message || \"Error al subir el archivo\");\n    } finally {\n      setInputMode(\"idle\");\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    }\n  };\n\n  const sendToGrok = async (text: string) => {\n    setIsProcessing(true);\n    setResponse(\"\");\n    \n    try {\n      const res = await fetch(\"/api/voice-chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ message: text }),\n      });\n      \n      if (!res.ok) {\n        throw new Error(\"Error al comunicarse con el servidor\");\n      }\n      \n      const data = await res.json();\n      setResponse(data.response);\n      \n      // Speak the response\n      speakResponse(data.response);\n    } catch (err: any) {\n      console.error(\"Error sending to Grok:\", err);\n      setError(err.message || \"Error al procesar tu mensaje\");\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const speakResponse = (text: string) => {\n    if (!text) return;\n    \n    // Cancel any ongoing speech\n    window.speechSynthesis.cancel();\n    \n    const utterance = new SpeechSynthesisUtterance(text);\n    utterance.lang = 'es-ES';\n    utterance.rate = 1;\n    utterance.pitch = 1;\n    \n    // Try to get a Spanish voice\n    const voices = window.speechSynthesis.getVoices();\n    const spanishVoice = voices.find(v => v.lang.startsWith('es'));\n    if (spanishVoice) {\n      utterance.voice = spanishVoice;\n    }\n    \n    utterance.onstart = () => setIsSpeaking(true);\n    utterance.onend = () => setIsSpeaking(false);\n    utterance.onerror = () => setIsSpeaking(false);\n    \n    speechSynthesisRef.current = utterance;\n    window.speechSynthesis.speak(utterance);\n  };\n\n  const handleMicToggle = () => {\n    if (isListening) {\n      stopListening();\n    } else if (isSpeaking) {\n      stopSpeaking();\n    } else {\n      startListening();\n    }\n  };\n\n  const handleCameraToggle = () => {\n    if (isCameraActive) {\n      stopCamera();\n    } else {\n      startCamera();\n    }\n  };\n\n  // Calculate bubble scale based on audio level\n  const bubbleScale = 1 + (audioLevel * 0.5);\n  const bubbleGlow = audioLevel * 100;\n\n  if (!open) return null;\n\n  return (\n    <AnimatePresence>\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        exit={{ opacity: 0 }}\n        className=\"fixed inset-0 z-[100] bg-gradient-to-br from-gray-900 via-black to-gray-900 flex flex-col items-center justify-center\"\n        data-testid=\"voice-chat-mode\"\n      >\n        {/* Hidden file input */}\n        <input\n          ref={fileInputRef}\n          type=\"file\"\n          className=\"hidden\"\n          accept=\"image/*,application/pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt\"\n          onChange={handleFileChange}\n        />\n\n        {/* Close button */}\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={onClose}\n          className=\"absolute top-6 right-6 h-12 w-12 rounded-full text-white/70 hover:text-white hover:bg-white/10\"\n          data-testid=\"button-close-voice-chat\"\n        >\n          <X className=\"h-6 w-6\" />\n        </Button>\n\n        {/* Status text */}\n        <motion.div\n          initial={{ opacity: 0, y: -20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"absolute top-8 left-1/2 -translate-x-1/2 text-white/80 text-lg font-medium\"\n        >\n          {isListening ? \"Escuchando...\" : isSpeaking ? \"Hablando...\" : isProcessing ? \"Procesando...\" : isCameraActive ? \"Cámara activa\" : \"Modo conversación\"}\n        </motion.div>\n\n        {/* Camera preview (when active) */}\n        {isCameraActive && (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.9 }}\n            animate={{ opacity: 1, scale: 1 }}\n            className=\"absolute top-20 left-1/2 -translate-x-1/2 w-80 h-60 rounded-2xl overflow-hidden border-2 border-white/20 shadow-2xl\"\n          >\n            <video\n              ref={videoRef}\n              autoPlay\n              playsInline\n              muted\n              className=\"w-full h-full object-cover\"\n            />\n            <div className=\"absolute bottom-2 left-2 px-2 py-1 bg-red-500 rounded-full flex items-center gap-1\">\n              <div className=\"w-2 h-2 bg-white rounded-full animate-pulse\" />\n              <span className=\"text-white text-xs font-medium\">LIVE</span>\n            </div>\n          </motion.div>\n        )}\n\n        {/* Main animated bubble */}\n        <motion.div\n          className=\"relative flex items-center justify-center\"\n          initial={{ scale: 0.8, opacity: 0 }}\n          animate={{ scale: 1, opacity: 1 }}\n          transition={{ duration: 0.5, ease: \"easeOut\" }}\n          style={{ marginTop: isCameraActive ? \"160px\" : \"0\" }}\n        >\n          {/* Outer glow ring */}\n          <motion.div\n            className={cn(\n              \"absolute w-64 h-64 rounded-full\",\n              isListening ? \"bg-blue-500/20\" : isSpeaking ? \"bg-green-500/20\" : isCameraActive ? \"bg-red-500/20\" : \"bg-white/10\"\n            )}\n            animate={{\n              scale: isListening || isSpeaking || isCameraActive ? [1, 1.2, 1] : 1,\n              opacity: isListening || isSpeaking || isCameraActive ? [0.3, 0.5, 0.3] : 0.2,\n            }}\n            transition={{\n              duration: 1.5,\n              repeat: Infinity,\n              ease: \"easeInOut\",\n            }}\n          />\n          \n          {/* Middle ring */}\n          <motion.div\n            className={cn(\n              \"absolute w-48 h-48 rounded-full\",\n              isListening ? \"bg-blue-400/30\" : isSpeaking ? \"bg-green-400/30\" : isCameraActive ? \"bg-red-400/30\" : \"bg-white/15\"\n            )}\n            animate={{\n              scale: isListening ? [1, 1 + audioLevel * 0.3, 1] : isSpeaking || isCameraActive ? [1, 1.15, 1] : 1,\n            }}\n            transition={{\n              duration: isListening ? 0.1 : 1,\n              repeat: isListening ? 0 : Infinity,\n              ease: \"easeOut\",\n            }}\n            style={{\n              transform: `scale(${isListening ? bubbleScale : 1})`,\n            }}\n          />\n          \n          {/* Main bubble - displays current state */}\n          <motion.div\n            className={cn(\n              \"relative w-32 h-32 rounded-full flex items-center justify-center transition-all duration-300\",\n              isListening \n                ? \"bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg shadow-blue-500/50\" \n                : isSpeaking \n                  ? \"bg-gradient-to-br from-green-500 to-green-600 shadow-lg shadow-green-500/50\"\n                  : isProcessing\n                    ? \"bg-gradient-to-br from-amber-500 to-amber-600 shadow-lg shadow-amber-500/50\"\n                    : isCameraActive\n                      ? \"bg-gradient-to-br from-red-500 to-red-600 shadow-lg shadow-red-500/50\"\n                      : \"bg-gradient-to-br from-gray-700 to-gray-800 shadow-lg shadow-black/50\"\n            )}\n            style={{\n              boxShadow: isListening \n                ? `0 0 ${bubbleGlow}px rgba(59, 130, 246, 0.6)` \n                : isSpeaking \n                  ? `0 0 60px rgba(34, 197, 94, 0.5)`\n                  : isCameraActive\n                    ? `0 0 60px rgba(239, 68, 68, 0.5)`\n                    : undefined,\n            }}\n            data-testid=\"voice-bubble-display\"\n          >\n            {isProcessing ? (\n              <Loader2 className=\"h-12 w-12 text-white animate-spin\" />\n            ) : isListening ? (\n              <motion.div\n                animate={{ scale: [1, 1.1, 1] }}\n                transition={{ duration: 0.5, repeat: Infinity }}\n              >\n                <Mic className=\"h-12 w-12 text-white\" />\n              </motion.div>\n            ) : isSpeaking ? (\n              <motion.div\n                animate={{ scale: [1, 1.1, 1] }}\n                transition={{ duration: 0.5, repeat: Infinity }}\n              >\n                <Volume2 className=\"h-12 w-12 text-white\" />\n              </motion.div>\n            ) : isCameraActive ? (\n              <motion.div\n                animate={{ scale: [1, 1.05, 1] }}\n                transition={{ duration: 1, repeat: Infinity }}\n              >\n                <Video className=\"h-12 w-12 text-white\" />\n              </motion.div>\n            ) : (\n              <div className=\"flex flex-col items-center\">\n                <span className=\"text-white/80 text-sm\">Sira</span>\n              </div>\n            )}\n          </motion.div>\n          \n          {/* Audio level visualization rings */}\n          {isListening && (\n            <>\n              {[...Array(3)].map((_, i) => (\n                <motion.div\n                  key={i}\n                  className=\"absolute rounded-full border-2 border-blue-400/30\"\n                  style={{\n                    width: 140 + (i * 40) + (audioLevel * 80),\n                    height: 140 + (i * 40) + (audioLevel * 80),\n                  }}\n                  animate={{\n                    opacity: [0.5 - i * 0.15, 0.2, 0.5 - i * 0.15],\n                    scale: [1, 1.05, 1],\n                  }}\n                  transition={{\n                    duration: 1,\n                    repeat: Infinity,\n                    delay: i * 0.2,\n                  }}\n                />\n              ))}\n            </>\n          )}\n        </motion.div>\n\n        {/* Transcript display */}\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          className=\"absolute bottom-44 left-0 right-0 px-8 text-center\"\n        >\n          {transcript && (\n            <motion.p\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-white/90 text-xl mb-4 max-w-lg mx-auto\"\n            >\n              \"{transcript}\"\n            </motion.p>\n          )}\n          {response && !isListening && (\n            <motion.p\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-white/70 text-lg max-w-lg mx-auto line-clamp-3\"\n            >\n              {response}\n            </motion.p>\n          )}\n          {(error || cameraError) && (\n            <motion.p\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              className=\"text-red-400 text-sm\"\n            >\n              {error || cameraError}\n            </motion.p>\n          )}\n        </motion.div>\n\n        {/* Multimodal input buttons */}\n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.2 }}\n          className=\"absolute bottom-16 flex items-center gap-6\"\n        >\n          {/* Camera/Video button */}\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <motion.button\n                onClick={handleCameraToggle}\n                disabled={isListening || isProcessing}\n                whileHover={{ scale: 1.05 }}\n                whileTap={{ scale: 0.95 }}\n                className={cn(\n                  \"w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300\",\n                  \"focus:outline-none focus:ring-4 focus:ring-white/20\",\n                  isCameraActive \n                    ? \"bg-red-500 text-white shadow-lg shadow-red-500/40\" \n                    : \"bg-gray-800/80 text-white/80 hover:bg-gray-700 hover:text-white\"\n                )}\n                data-testid=\"button-camera-input\"\n              >\n                {isCameraActive ? <VideoOff className=\"h-7 w-7\" /> : <Video className=\"h-7 w-7\" />}\n              </motion.button>\n            </TooltipTrigger>\n            <TooltipContent side=\"top\" className=\"bg-gray-800 text-white border-gray-700\">\n              {isCameraActive ? \"Detener cámara\" : \"Iniciar cámara\"}\n            </TooltipContent>\n          </Tooltip>\n\n          {/* Upload/Attach button */}\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <motion.button\n                onClick={handleFileUpload}\n                disabled={isListening || isProcessing || isCameraActive}\n                whileHover={{ scale: 1.05 }}\n                whileTap={{ scale: 0.95 }}\n                className={cn(\n                  \"w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300\",\n                  \"focus:outline-none focus:ring-4 focus:ring-white/20\",\n                  inputMode === \"uploading\"\n                    ? \"bg-blue-500 text-white shadow-lg shadow-blue-500/40\"\n                    : \"bg-gray-800/80 text-white/80 hover:bg-gray-700 hover:text-white\"\n                )}\n                data-testid=\"button-upload-input\"\n              >\n                {inputMode === \"uploading\" ? (\n                  <Loader2 className=\"h-7 w-7 animate-spin\" />\n                ) : (\n                  <Upload className=\"h-7 w-7\" />\n                )}\n              </motion.button>\n            </TooltipTrigger>\n            <TooltipContent side=\"top\" className=\"bg-gray-800 text-white border-gray-700\">\n              Adjuntar archivo\n            </TooltipContent>\n          </Tooltip>\n\n          {/* Microphone button */}\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <motion.button\n                onClick={handleMicToggle}\n                disabled={isProcessing || isCameraActive}\n                whileHover={{ scale: 1.05 }}\n                whileTap={{ scale: 0.95 }}\n                className={cn(\n                  \"w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300\",\n                  \"focus:outline-none focus:ring-4 focus:ring-white/20\",\n                  isListening \n                    ? \"bg-blue-500 text-white shadow-lg shadow-blue-500/40 animate-pulse\" \n                    : isSpeaking\n                      ? \"bg-green-500 text-white shadow-lg shadow-green-500/40\"\n                      : \"bg-gray-800/80 text-white/80 hover:bg-gray-700 hover:text-white\"\n                )}\n                data-testid=\"button-mic-input\"\n              >\n                {isListening ? <MicOff className=\"h-7 w-7\" /> : <Mic className=\"h-7 w-7\" />}\n              </motion.button>\n            </TooltipTrigger>\n            <TooltipContent side=\"top\" className=\"bg-gray-800 text-white border-gray-700\">\n              {isListening ? \"Detener grabación\" : isSpeaking ? \"Silenciar\" : \"Hablar\"}\n            </TooltipContent>\n          </Tooltip>\n        </motion.div>\n\n        {/* Stop speaking button */}\n        {isSpeaking && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            className=\"absolute bottom-4\"\n          >\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={stopSpeaking}\n              className=\"text-white/70 hover:text-white hover:bg-white/10\"\n              data-testid=\"button-stop-speaking\"\n            >\n              <VolumeX className=\"h-4 w-4 mr-2\" />\n              Silenciar\n            </Button>\n          </motion.div>\n        )}\n      </motion.div>\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":23400,"size_tokens":null},"attached_assets/orchestrator_1766253918030.py":{"content":"from __future__ import annotations\n\nimport json\nfrom abc import ABC, abstractmethod\nfrom typing import Any, Dict, Optional, Tuple, Type\n\nfrom pydantic import BaseModel\n\nfrom .schemas import ExcelSpec, DocSpec\n\n\nclass LLMClient(ABC):\n    \"\"\"Abstracción del proveedor LLM (OpenAI/Anthropic/local).\n\n    Debe devolver un dict JSON que cumpla el schema solicitado.\n    \"\"\"\n\n    @abstractmethod\n    def complete_json(self, *, system: str, user: str, json_schema: Dict[str, Any]) -> Dict[str, Any]:\n        raise NotImplementedError\n\n\ndef _generate_with_repair(\n    model: Type[BaseModel],\n    *,\n    llm: LLMClient,\n    system: str,\n    user: str,\n    max_attempts: int = 3,\n) -> BaseModel:\n    schema = model.model_json_schema()\n\n    last_err: Optional[str] = None\n    current_user = user\n\n    for attempt in range(1, max_attempts + 1):\n        payload = llm.complete_json(system=system, user=current_user, json_schema=schema)\n\n        try:\n            return model.model_validate(payload)\n        except Exception as e:\n            last_err = str(e)\n            # feed back the validation error to repair\n            current_user = (\n                user\n                + \"\\n\\n\"\n                + \"IMPORTANTE: El JSON anterior NO pasó validación.\\n\"\n                + f\"Error de validación: {last_err}\\n\"\n                + \"Devuelve SOLO un JSON corregido que cumpla el schema.\\n\"\n            )\n\n    raise ValueError(f\"LLM could not produce a valid {model.__name__} after {max_attempts} attempts. Last error: {last_err}\")\n\n\ndef generate_excel_spec(prompt: str, *, llm: LLMClient) -> ExcelSpec:\n    system = (\n        \"Eres un agente que diseña un Excel profesional. \"\n        \"Devuelve SOLO JSON válido que cumpla el schema. \"\n        \"Evita celdas combinadas salvo necesidad. \"\n        \"Incluye formatos numéricos correctos y congela encabezados.\"\n    )\n    user = (\n        \"Necesito un Excel (.xlsx) siguiendo estas instrucciones:\\n\"\n        f\"{prompt}\\n\\n\"\n        \"Devuelve un ExcelSpec.\"\n    )\n    return _generate_with_repair(ExcelSpec, llm=llm, system=system, user=user)\n\n\ndef generate_doc_spec(prompt: str, *, llm: LLMClient) -> DocSpec:\n    system = (\n        \"Eres un agente que diseña un documento Word profesional. \"\n        \"Devuelve SOLO JSON válido que cumpla el schema. \"\n        \"Usa headings jerárquicos, tablas cuando aplique y listas.\"\n    )\n    user = (\n        \"Necesito un documento Word (.docx) siguiendo estas instrucciones:\\n\"\n        f\"{prompt}\\n\\n\"\n        \"Devuelve un DocSpec.\"\n    )\n    return _generate_with_repair(DocSpec, llm=llm, system=system, user=user)\n\n\n# ---------\n# Demo stub\n# ---------\nclass DummyLLM(LLMClient):\n    \"\"\"LLM de mentira para pruebas (POC). Sustituye en producción.\"\"\"\n\n    def complete_json(self, *, system: str, user: str, json_schema: Dict[str, Any]) -> Dict[str, Any]:\n        # Very small deterministic example that matches the schemas.\n        if \"ExcelSpec\" in json.dumps(json_schema):\n            return {\n                \"workbook_title\": \"Demo\",\n                \"sheets\": [\n                    {\n                        \"name\": \"Resumen\",\n                        \"tables\": [\n                            {\n                                \"anchor\": \"A1\",\n                                \"headers\": [\"Mes\", \"Ingresos\", \"Crecimiento\"],\n                                \"rows\": [\n                                    [\"2025-01-01\", 120000, 0.12],\n                                    [\"2025-02-01\", 135000, 0.125],\n                                ],\n                                \"column_formats\": {\"Ingresos\": \"$#,##0\", \"Crecimiento\": \"0.0%\"},\n                                \"table_style\": \"TableStyleMedium9\",\n                                \"autofilter\": True,\n                                \"freeze_header\": True,\n                            }\n                        ],\n                        \"charts\": [\n                            {\n                                \"type\": \"line\",\n                                \"title\": \"Ingresos\",\n                                \"categories_range\": \"A2:A3\",\n                                \"values_range\": \"B2:B3\",\n                                \"position\": \"E2\",\n                            }\n                        ],\n                        \"layout\": {\"auto_fit_columns\": True, \"show_gridlines\": True},\n                    }\n                ],\n            }\n        else:\n            return {\n                \"title\": \"Demo\",\n                \"author\": \"docsheets-agent\",\n                \"add_toc\": False,\n                \"blocks\": [\n                    {\"type\": \"heading\", \"level\": 1, \"text\": \"Resumen\"},\n                    {\"type\": \"paragraph\", \"text\": \"Documento generado desde un spec JSON.\"},\n                    {\"type\": \"bullets\", \"items\": [\"Punto 1\", \"Punto 2\"]},\n                    {\n                        \"type\": \"table\",\n                        \"columns\": [\"Producto\", \"Precio\"],\n                        \"rows\": [[\"A\", 10], [\"B\", 20]],\n                        \"style\": \"Light Shading\",\n                    },\n                ],\n            }\n","path":null,"size_bytes":5079,"size_tokens":null},"attached_assets/schemas_1766253918030.py":{"content":"from __future__ import annotations\n\nfrom datetime import date, datetime\nfrom typing import Any, Dict, List, Literal, Optional, Union\n\nfrom pydantic import BaseModel, Field, model_validator\n\n\n# -------------------------\n# Excel (XLSX) specification\n# -------------------------\n\nJsonScalar = Union[str, int, float, bool, None]\n\n\nclass TableSpec(BaseModel):\n    \"\"\"A rectangular table starting at `anchor` (e.g., 'A1').\"\"\"\n\n    anchor: str = Field(..., description=\"Top-left cell, e.g. 'A1'\")\n    headers: List[str] = Field(..., min_length=1)\n    rows: List[List[Any]] = Field(default_factory=list)\n    table_style: str = Field(\n        default=\"TableStyleMedium9\",\n        description=\"Excel table style name (OpenXML), e.g. TableStyleMedium9\",\n    )\n    column_formats: Dict[str, str] = Field(\n        default_factory=dict,\n        description=\"Map header -> Excel number format (e.g. '0.0%', '$#,##0')\",\n    )\n    autofilter: bool = True\n    freeze_header: bool = True\n\n    @model_validator(mode=\"after\")\n    def _validate_rectangular(self) -> \"TableSpec\":\n        # All rows should have len == len(headers)\n        n = len(self.headers)\n        for i, r in enumerate(self.rows):\n            if len(r) != n:\n                raise ValueError(\n                    f\"Row {i} has {len(r)} cells but headers has {n}. \"\n                    \"Make rows rectangular.\"\n                )\n        return self\n\n\nclass ChartSpec(BaseModel):\n    \"\"\"Minimal chart spec.\"\"\"\n\n    type: Literal[\"bar\", \"line\", \"pie\"] = \"bar\"\n    title: str = \"\"\n    categories_range: str = Field(\n        ...,\n        description=\"Excel A1 range for categories (labels). Example: 'A2:A10'\",\n    )\n    values_range: str = Field(\n        ...,\n        description=\"Excel A1 range for values. Example: 'B2:B10'\",\n    )\n    position: str = Field(\n        \"H2\",\n        description=\"Top-left position of the chart, e.g. 'H2'\",\n    )\n\n\nclass SheetLayoutSpec(BaseModel):\n    freeze_panes: Optional[str] = Field(\n        None, description=\"Cell reference for freeze panes, e.g. 'A2'\"\n    )\n    auto_fit_columns: bool = True\n    column_widths: Dict[str, float] = Field(\n        default_factory=dict, description=\"Map column letter -> width\"\n    )\n    show_gridlines: bool = True\n\n\nclass SheetSpec(BaseModel):\n    name: str = Field(..., min_length=1, max_length=31)\n    tables: List[TableSpec] = Field(default_factory=list)\n    charts: List[ChartSpec] = Field(default_factory=list)\n    layout: SheetLayoutSpec = Field(default_factory=SheetLayoutSpec)\n\n\nclass ExcelSpec(BaseModel):\n    \"\"\"Full workbook spec.\"\"\"\n\n    workbook_title: str = \"Report\"\n    sheets: List[SheetSpec] = Field(..., min_length=1)\n\n\n# ------------------------\n# Word (DOCX) specification\n# ------------------------\n\nclass HeadingBlock(BaseModel):\n    type: Literal[\"heading\"] = \"heading\"\n    level: int = Field(1, ge=1, le=6)\n    text: str\n\n\nclass ParagraphBlock(BaseModel):\n    type: Literal[\"paragraph\"] = \"paragraph\"\n    text: str\n\n\nclass BulletsBlock(BaseModel):\n    type: Literal[\"bullets\"] = \"bullets\"\n    items: List[str] = Field(..., min_length=1)\n\n\nclass TableBlock(BaseModel):\n    type: Literal[\"table\"] = \"table\"\n    columns: List[str] = Field(..., min_length=1)\n    rows: List[List[Any]] = Field(default_factory=list)\n    style: str = Field(\"Light Shading\", description=\"Word table style name\")\n\n    @model_validator(mode=\"after\")\n    def _validate_rectangular(self) -> \"TableBlock\":\n        n = len(self.columns)\n        for i, r in enumerate(self.rows):\n            if len(r) != n:\n                raise ValueError(\n                    f\"Row {i} has {len(r)} cells but columns has {n}. \"\n                    \"Make rows rectangular.\"\n                )\n        return self\n\n\nclass PageBreakBlock(BaseModel):\n    type: Literal[\"page_break\"] = \"page_break\"\n\n\nDocBlock = Union[HeadingBlock, ParagraphBlock, BulletsBlock, TableBlock, PageBreakBlock]\n\n\nclass DocSpec(BaseModel):\n    title: str = \"Document\"\n    author: Optional[str] = None\n    add_toc: bool = False\n    blocks: List[DocBlock] = Field(default_factory=list, description=\"Ordered content blocks\")\n","path":null,"size_bytes":4092,"size_tokens":null},"attached_assets/run_example_1766253878801.py":{"content":"import json\nimport sys\nfrom pathlib import Path\n\n# Allow running without installing the package\nROOT = Path(__file__).resolve().parents[1]\nsys.path.insert(0, str(ROOT / \"src\"))\n\nfrom docsheets.excel_renderer import render_excel\nfrom docsheets.word_renderer import render_word\nfrom docsheets.validators import parse_excel_spec, parse_doc_spec, validate_excel_file, validate_docx_file\n\n\ndef main():\n    base = Path(__file__).parent\n    out_dir = base / \"out\"\n    out_dir.mkdir(exist_ok=True)\n\n    excel_payload = json.loads((base / \"example_excel_spec.json\").read_text(encoding=\"utf-8\"))\n    doc_payload = json.loads((base / \"example_doc_spec.json\").read_text(encoding=\"utf-8\"))\n\n    excel_spec = parse_excel_spec(excel_payload)\n    doc_spec = parse_doc_spec(doc_payload)\n\n    xlsx_path = str(out_dir / \"report.xlsx\")\n    docx_path = str(out_dir / \"report.docx\")\n\n    render_excel(excel_spec, xlsx_path)\n    render_word(doc_spec, docx_path)\n\n    print(\"xlsx errors:\", validate_excel_file(xlsx_path))\n    print(\"docx errors:\", validate_docx_file(docx_path))\n    print(\"Wrote:\", xlsx_path)\n    print(\"Wrote:\", docx_path)\n\n\nif __name__ == \"__main__\":\n    main()\n","path":null,"size_bytes":1157,"size_tokens":null},"attached_assets/main_1766253860351.py":{"content":"from __future__ import annotations\n\nimport os\nimport tempfile\nfrom typing import Any, Dict\n\nfrom fastapi import FastAPI, HTTPException\nfrom fastapi.responses import FileResponse\n\nfrom docsheets.excel_renderer import render_excel\nfrom docsheets.word_renderer import render_word\nfrom docsheets.validators import (\n    parse_doc_spec,\n    parse_excel_spec,\n    validate_docx_file,\n    validate_excel_file,\n)\nfrom docsheets.orchestrator import DummyLLM, generate_doc_spec, generate_excel_spec\n\n\napp = FastAPI(title=\"docsheets-agent\", version=\"0.1.0\")\n\n\n@app.post(\"/v1/render/excel\")\ndef render_excel_endpoint(payload: Dict[str, Any]):\n    spec = parse_excel_spec(payload)\n\n    fd, path = tempfile.mkstemp(suffix=\".xlsx\")\n    os.close(fd)\n\n    render_excel(spec, path)\n    errs = validate_excel_file(path)\n    if errs:\n        raise HTTPException(status_code=500, detail={\"errors\": errs})\n\n    return FileResponse(\n        path,\n        filename=f\"{spec.workbook_title or 'report'}.xlsx\",\n        media_type=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    )\n\n\n@app.post(\"/v1/render/word\")\ndef render_word_endpoint(payload: Dict[str, Any]):\n    spec = parse_doc_spec(payload)\n\n    fd, path = tempfile.mkstemp(suffix=\".docx\")\n    os.close(fd)\n\n    render_word(spec, path)\n    errs = validate_docx_file(path)\n    if errs:\n        raise HTTPException(status_code=500, detail={\"errors\": errs})\n\n    return FileResponse(\n        path,\n        filename=f\"{spec.title or 'document'}.docx\",\n        media_type=\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n    )\n\n\n# --- Optional \"agent\" endpoints ---\n# For production you should implement a real LLM client, add auth, rate limits, logging, etc.\n\n@app.post(\"/v1/generate/excel\")\ndef generate_excel_endpoint(payload: Dict[str, Any]):\n    prompt = payload.get(\"prompt\")\n    if not prompt:\n        raise HTTPException(status_code=400, detail=\"Missing 'prompt'.\")\n\n    # Demo only:\n    llm = DummyLLM()\n    spec = generate_excel_spec(prompt, llm=llm)\n\n    fd, path = tempfile.mkstemp(suffix=\".xlsx\")\n    os.close(fd)\n\n    render_excel(spec, path)\n    return FileResponse(\n        path,\n        filename=f\"{spec.workbook_title or 'report'}.xlsx\",\n        media_type=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    )\n\n\n@app.post(\"/v1/generate/word\")\ndef generate_word_endpoint(payload: Dict[str, Any]):\n    prompt = payload.get(\"prompt\")\n    if not prompt:\n        raise HTTPException(status_code=400, detail=\"Missing 'prompt'.\")\n\n    # Demo only:\n    llm = DummyLLM()\n    spec = generate_doc_spec(prompt, llm=llm)\n\n    fd, path = tempfile.mkstemp(suffix=\".docx\")\n    os.close(fd)\n\n    render_word(spec, path)\n    return FileResponse(\n        path,\n        filename=f\"{spec.title or 'document'}.docx\",\n        media_type=\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n    )\n","path":null,"size_bytes":2910,"size_tokens":null},"attached_assets/validators_1766253918030.py":{"content":"from __future__ import annotations\n\nfrom typing import List, Tuple, Union\n\nfrom openpyxl import load_workbook\nfrom docx import Document\n\nfrom .schemas import ExcelSpec, DocSpec\n\n\ndef validate_excel_file(path: str) -> List[str]:\n    errors: List[str] = []\n    try:\n        wb = load_workbook(path)\n        if not wb.sheetnames:\n            errors.append(\"Workbook has no sheets.\")\n    except Exception as e:\n        errors.append(f\"Failed to open xlsx: {e}\")\n    return errors\n\n\ndef validate_docx_file(path: str) -> List[str]:\n    errors: List[str] = []\n    try:\n        doc = Document(path)\n        # basic sanity check\n        _ = len(doc.paragraphs)\n    except Exception as e:\n        errors.append(f\"Failed to open docx: {e}\")\n    return errors\n\n\ndef parse_excel_spec(payload: dict) -> ExcelSpec:\n    return ExcelSpec.model_validate(payload)\n\n\ndef parse_doc_spec(payload: dict) -> DocSpec:\n    return DocSpec.model_validate(payload)\n","path":null,"size_bytes":936,"size_tokens":null},"attached_assets/excel_renderer_1766253918030.py":{"content":"from __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom datetime import datetime, date\nfrom typing import Any, Dict, Iterable, Optional, Tuple\n\nfrom openpyxl import Workbook\nfrom openpyxl.styles import Alignment, Font, PatternFill\nfrom openpyxl.utils.cell import (\n    coordinate_from_string,\n    column_index_from_string,\n    get_column_letter,\n)\nfrom openpyxl.worksheet.table import Table, TableStyleInfo\nfrom openpyxl.chart import BarChart, LineChart, PieChart, Reference\n\nfrom .schemas import ExcelSpec, SheetSpec, TableSpec, ChartSpec\n\n\nHEADER_FILL = PatternFill(start_color=\"1F4E79\", end_color=\"1F4E79\", fill_type=\"solid\")\nHEADER_FONT = Font(color=\"FFFFFF\", bold=True)\nHEADER_ALIGN = Alignment(vertical=\"center\", horizontal=\"center\", wrap_text=True)\nCELL_ALIGN = Alignment(vertical=\"top\", horizontal=\"left\", wrap_text=True)\n\n\ndef _cell_to_rc(cell: str) -> Tuple[int, int]:\n    col, row = coordinate_from_string(cell)\n    return int(row), column_index_from_string(col)\n\n\ndef _rc_to_cell(row: int, col: int) -> str:\n    return f\"{get_column_letter(col)}{row}\"\n\n\ndef _maybe_parse_date(v: Any) -> Any:\n    # Accept ISO date strings and coerce to python date/datetime for Excel\n    if isinstance(v, str):\n        # YYYY-MM-DD\n        try:\n            if len(v) == 10 and v[4] == \"-\" and v[7] == \"-\":\n                return date.fromisoformat(v)\n        except Exception:\n            return v\n        # YYYY-MM-DDTHH:MM:SS...\n        try:\n            if \"T\" in v and v[:4].isdigit():\n                return datetime.fromisoformat(v.replace(\"Z\", \"+00:00\"))\n        except Exception:\n            return v\n    return v\n\n\ndef _auto_fit_columns(ws, min_width: float = 8.0, max_width: float = 60.0) -> None:\n    # Simple heuristic: measure string length of displayed values\n    col_max: Dict[int, int] = {}\n    for row in ws.iter_rows(values_only=True):\n        for j, val in enumerate(row, start=1):\n            if val is None:\n                continue\n            s = str(val)\n            col_max[j] = max(col_max.get(j, 0), len(s))\n    for j, maxlen in col_max.items():\n        # +2 for padding\n        width = max(min_width, min(max_width, maxlen + 2))\n        ws.column_dimensions[get_column_letter(j)].width = float(width)\n\n\ndef _write_table(ws, table: TableSpec, *, table_index: int) -> Tuple[int, int, int, int]:\n    start_r, start_c = _cell_to_rc(table.anchor)\n\n    # headers\n    for j, h in enumerate(table.headers):\n        cell = ws.cell(row=start_r, column=start_c + j, value=h)\n        cell.fill = HEADER_FILL\n        cell.font = HEADER_FONT\n        cell.alignment = HEADER_ALIGN\n\n    # rows\n    for i, row in enumerate(table.rows):\n        for j, val in enumerate(row):\n            v = _maybe_parse_date(val)\n            cell = ws.cell(row=start_r + 1 + i, column=start_c + j, value=v)\n            cell.alignment = CELL_ALIGN\n\n    end_r = start_r + len(table.rows)\n    end_c = start_c + len(table.headers) - 1\n\n    # formats by header\n    header_to_col = {h: start_c + idx for idx, h in enumerate(table.headers)}\n    for header, fmt in (table.column_formats or {}).items():\n        if header not in header_to_col:\n            continue\n        c = header_to_col[header]\n        for r in range(start_r + 1, end_r + 1):\n            ws.cell(row=r, column=c).number_format = fmt\n\n    # Create an Excel Table object (gives styling + autofilter)\n    ref = f\"{_rc_to_cell(start_r, start_c)}:{_rc_to_cell(end_r, end_c)}\"\n    t = Table(displayName=f\"Table{table_index}\", ref=ref)\n\n    style = TableStyleInfo(\n        name=table.table_style or \"TableStyleMedium9\",\n        showFirstColumn=False,\n        showLastColumn=False,\n        showRowStripes=True,\n        showColumnStripes=False,\n    )\n    t.tableStyleInfo = style\n    ws.add_table(t)\n\n    # Freeze header row if requested (unless worksheet layout overrides later)\n    if table.freeze_header:\n        ws.freeze_panes = _rc_to_cell(start_r + 1, start_c)\n\n    return start_r, start_c, end_r, end_c\n\n\ndef _add_chart(ws, ch: ChartSpec) -> None:\n    if ch.type == \"bar\":\n        chart = BarChart()\n    elif ch.type == \"line\":\n        chart = LineChart()\n    else:\n        chart = PieChart()\n\n    chart.title = ch.title or \"\"\n\n    cats = Reference(ws, range_string=f\"{ws.title}!{ch.categories_range}\")\n    vals = Reference(ws, range_string=f\"{ws.title}!{ch.values_range}\")\n\n    if ch.type in (\"bar\", \"line\"):\n        chart.add_data(vals, titles_from_data=False)\n        chart.set_categories(cats)\n    else:  # pie\n        chart.add_data(vals, titles_from_data=False)\n        chart.set_categories(cats)\n\n    ws.add_chart(chart, ch.position)\n\n\ndef render_excel(spec: ExcelSpec, out_path: str) -> str:\n    \"\"\"Render an ExcelSpec into a .xlsx file.\"\"\"\n    wb = Workbook()\n    # remove default sheet\n    if wb.worksheets:\n        wb.remove(wb.worksheets[0])\n\n    for sheet in spec.sheets:\n        _render_sheet(wb, sheet)\n\n    wb.properties.title = spec.workbook_title or \"Report\"\n    wb.save(out_path)\n    return out_path\n\n\ndef _render_sheet(wb: Workbook, sheet: SheetSpec) -> None:\n    ws = wb.create_sheet(title=sheet.name)\n\n    # tables\n    for idx, table in enumerate(sheet.tables, start=1):\n        _write_table(ws, table, table_index=idx)\n\n    # sheet-level layout overrides\n    if sheet.layout.freeze_panes:\n        ws.freeze_panes = sheet.layout.freeze_panes\n\n    ws.sheet_view.showGridLines = bool(sheet.layout.show_gridlines)\n\n    # explicit widths\n    for col_letter, width in (sheet.layout.column_widths or {}).items():\n        ws.column_dimensions[col_letter].width = float(width)\n\n    # auto-fit\n    if sheet.layout.auto_fit_columns and not sheet.layout.column_widths:\n        _auto_fit_columns(ws)\n\n    # charts\n    for ch in sheet.charts:\n        _add_chart(ws, ch)\n","path":null,"size_bytes":5747,"size_tokens":null},"attached_assets/word_renderer_1766253918030.py":{"content":"from __future__ import annotations\n\nfrom typing import Any\n\nfrom docx import Document\nfrom docx.enum.text import WD_BREAK\nfrom docx.shared import Pt\nfrom docx.oxml import OxmlElement\nfrom docx.oxml.ns import qn\n\nfrom .schemas import DocSpec, HeadingBlock, ParagraphBlock, BulletsBlock, TableBlock, PageBreakBlock\n\n\ndef _set_default_styles(doc: Document) -> None:\n    # Sensible defaults. You can extend this with a full design system.\n    style = doc.styles[\"Normal\"]\n    style.font.name = \"Calibri\"\n    style.font.size = Pt(11)\n\n\ndef _add_toc(doc: Document) -> None:\n    # Word will populate the TOC when the user updates fields (or on open depending on settings).\n    p = doc.add_paragraph()\n    fld = OxmlElement(\"w:fldSimple\")\n    fld.set(qn(\"w:instr\"), 'TOC \\\\o \"1-3\" \\\\h \\\\z \\\\u')\n    p._p.addnext(fld)\n    doc.add_paragraph()  # spacing after TOC\n\n\ndef _add_table(doc: Document, block: TableBlock) -> None:\n    n_cols = len(block.columns)\n    table = doc.add_table(rows=1, cols=n_cols)\n    table.style = block.style or \"Table Grid\"\n    hdr_cells = table.rows[0].cells\n    for j, col in enumerate(block.columns):\n        run = hdr_cells[j].paragraphs[0].add_run(str(col))\n        run.bold = True\n\n    for row in block.rows:\n        cells = table.add_row().cells\n        for j, val in enumerate(row):\n            cells[j].text = \"\" if val is None else str(val)\n\n    doc.add_paragraph()  # spacing after table\n\n\ndef render_word(spec: DocSpec, out_path: str) -> str:\n    doc = Document()\n    _set_default_styles(doc)\n\n    # Title\n    if spec.title:\n        doc.add_heading(spec.title, level=0)\n\n    if spec.add_toc:\n        _add_toc(doc)\n\n    # Content blocks\n    for b in spec.blocks:\n        if isinstance(b, HeadingBlock):\n            doc.add_heading(b.text, level=b.level)\n        elif isinstance(b, ParagraphBlock):\n            doc.add_paragraph(b.text)\n        elif isinstance(b, BulletsBlock):\n            for item in b.items:\n                doc.add_paragraph(item, style=\"List Bullet\")\n        elif isinstance(b, TableBlock):\n            _add_table(doc, b)\n        elif isinstance(b, PageBreakBlock):\n            doc.add_paragraph().add_run().add_break(WD_BREAK.PAGE)\n        else:\n            # If you add new block types, handle them here.\n            doc.add_paragraph(str(getattr(b, \"text\", \"\")))\n\n    if spec.author:\n        doc.core_properties.author = spec.author\n\n    doc.save(out_path)\n    return out_path\n","path":null,"size_bytes":2427,"size_tokens":null},"attached_assets/__init___1766253918030.py":{"content":"__all__ = []\n","path":null,"size_bytes":13,"size_tokens":null},"attached_assets/09_extending_1766283299495.md":{"content":"# 09 — Extensión\n\n- Agrega nuevos bloques Word en `schemas/word.py` y renderízalos en `renderers/word.py`.\n- Agrega nuevos charts Excel en `schemas/excel.py` y `_render_chart`.\n- Agrega nuevas reglas en `quality/*`.\n","path":null,"size_bytes":220,"size_tokens":null},"attached_assets/01_architecture_1766283299495.md":{"content":"# 01 — Arquitectura\n\n```\nPrompt/Intención\n  └─ (opcional) LLM → JSON (IR)\n        └─ Repair loop si JSON inválido\n  └─ Quality Gates (errors/warnings)\n  └─ Renderer determinístico\n        ├─ Excel (openpyxl)\n        └─ Word  (python-docx)\n  └─ Validator (reabre output)\n  └─ Entrega (API/archivo)\n```\n\n## Por qué “determinístico”\nPorque los formatos OOXML son estrictos; si el LLM “escribe” un .xlsx en texto, falla.\n","path":null,"size_bytes":466,"size_tokens":null},"attached_assets/04_word_rendering_1766283299495.md":{"content":"# 04 — Word Rendering\n\nRenderer: `src/office_agent/renderers/word.py`\n\nIncluye:\n- Título, headings, párrafos\n- Bullets y numbered\n- Tablas con header\n- Page breaks\n- TOC como campo (se actualiza en el editor)\n\nEstiloset: `modern` o `classic`.\n","path":null,"size_bytes":247,"size_tokens":null},"attached_assets/05_quality_gates_1766283299495.md":{"content":"# 05 — Quality Gates\n\n- Excel: límites, nombres únicos, detección de solape de tablas, warnings de textos tipo fórmula.\n- Word: límites de bloques, párrafos demasiado largos, tamaño total de tablas, warnings sobre TOC/títulos.\n\nImplementación:\n- `src/office_agent/quality/rules_excel.py`\n- `src/office_agent/quality/rules_word.py`\n","path":null,"size_bytes":342,"size_tokens":null},"attached_assets/config_1766283299495.py":{"content":"from __future__ import annotations\nfrom dataclasses import dataclass\nimport os\n\n@dataclass(frozen=True)\nclass Settings:\n    api_title: str = \"Office Agent Pro\"\n    api_version: str = \"0.1.0\"\n\n    max_sheets: int = 20\n    max_total_cells: int = 2_000_000\n    max_total_rows: int = 200_000\n    max_block_count: int = 2_000\n    max_text_len: int = 50_000\n    max_table_cells: int = 200_000\n\n    excel_escape_formula_like_text: bool = True\n    excel_col_min_width: float = 8.0\n    excel_col_max_width: float = 60.0\n\n    log_level: str = os.getenv(\"OFFICE_AGENT_LOG_LEVEL\", \"INFO\")\n    log_json: bool = os.getenv(\"OFFICE_AGENT_LOG_JSON\", \"0\") == \"1\"\n\ndef get_settings() -> Settings:\n    return Settings()\n","path":null,"size_bytes":700,"size_tokens":null},"attached_assets/07_deployment_1766283299495.md":{"content":"# 07 — Deployment sin licencias\n\n## Generación/descarga\nEste repo genera `.docx/.xlsx`. El usuario puede abrir con LibreOffice/OnlyOffice/Google.\n\n## Edición web sin Microsoft\nIntegra:\n- OnlyOffice Document Server (self-host) o\n- Collabora Online (WOPI)\n\nTu backend:\n1) genera y guarda archivo (S3/MinIO)\n2) el editor lo abre por URL y guarda de vuelta (callback)\n","path":null,"size_bytes":368,"size_tokens":null},"server/services/wordSpecRenderer.ts":{"content":"import {\n  Document,\n  Packer,\n  Paragraph,\n  TextRun,\n  HeadingLevel,\n  Table,\n  TableRow,\n  TableCell,\n  WidthType,\n  BorderStyle,\n  PageBreak,\n  TableOfContents,\n  convertInchesToTwip,\n  AlignmentType,\n  ExternalHyperlink,\n  Math as DocxMath,\n  MathRun,\n} from \"docx\";\nimport { DocSpec, DocBlock, TitleBlock, TocBlock, NumberedBlock } from \"../../shared/documentSpecs\";\nimport { tokenizeMarkdown, hasMarkdown, RichTextToken } from \"./richText/markdownTokenizer\";\nimport { createMathFromLatex } from \"./richText/latexMath\";\n\ninterface FontConfig {\n  font: string;\n  size: number;\n}\n\ntype ParagraphChild = TextRun | ExternalHyperlink | DocxMath;\n\nfunction getStylesetConfig(styleset: \"modern\" | \"classic\"): FontConfig {\n  if (styleset === \"classic\") {\n    return { font: \"Times New Roman\", size: 24 };\n  }\n  return { font: \"Calibri\", size: 22 };\n}\n\nconst HEADING_LEVEL_MAP: Record<number, typeof HeadingLevel[keyof typeof HeadingLevel]> = {\n  1: HeadingLevel.HEADING_1,\n  2: HeadingLevel.HEADING_2,\n  3: HeadingLevel.HEADING_3,\n  4: HeadingLevel.HEADING_4,\n  5: HeadingLevel.HEADING_5,\n  6: HeadingLevel.HEADING_6,\n};\n\nfunction tokenToTextRun(token: RichTextToken, fontConfig: FontConfig, extraBold?: boolean): TextRun {\n  return new TextRun({\n    text: token.text,\n    font: token.code ? \"Courier New\" : fontConfig.font,\n    size: fontConfig.size,\n    bold: token.bold || extraBold,\n    italics: token.italic,\n    shading: token.code ? { fill: \"F0F0F0\", type: \"clear\", color: \"auto\" } : undefined,\n  });\n}\n\nasync function tokensToChildren(text: string, fontConfig: FontConfig, extraBold?: boolean): Promise<ParagraphChild[]> {\n  if (!hasMarkdown(text)) {\n    return [\n      new TextRun({\n        text,\n        font: fontConfig.font,\n        size: fontConfig.size,\n        bold: extraBold,\n      }),\n    ];\n  }\n\n  const tokens = tokenizeMarkdown(text);\n  const children: ParagraphChild[] = [];\n\n  for (const token of tokens) {\n    if (token.isMath) {\n      const mathElement = await createMathFromLatex(token.text);\n      if (mathElement) {\n        children.push(mathElement);\n      } else {\n        children.push(new DocxMath({ children: [new MathRun(token.text)] }));\n      }\n    } else if (token.link) {\n      children.push(\n        new ExternalHyperlink({\n          children: [\n            new TextRun({\n              text: token.text,\n              font: fontConfig.font,\n              size: fontConfig.size,\n              bold: token.bold || extraBold,\n              italics: token.italic,\n              style: \"Hyperlink\",\n            }),\n          ],\n          link: token.link,\n        })\n      );\n    } else {\n      children.push(tokenToTextRun(token, fontConfig, extraBold));\n    }\n  }\n\n  return children;\n}\n\nfunction processTitleBlock(block: TitleBlock, fontConfig: FontConfig): Paragraph {\n  return new Paragraph({\n    children: [\n      new TextRun({\n        text: block.text,\n        font: fontConfig.font,\n        size: 56,\n        bold: true,\n      }),\n    ],\n    style: \"Title\",\n    alignment: AlignmentType.CENTER,\n    spacing: { before: 0, after: 400 },\n  });\n}\n\nasync function processHeadingBlock(block: Extract<DocBlock, { type: \"heading\" }>, fontConfig: FontConfig): Promise<Paragraph> {\n  return new Paragraph({\n    children: await tokensToChildren(block.text, fontConfig) as any,\n    heading: HEADING_LEVEL_MAP[block.level] || HeadingLevel.HEADING_1,\n    spacing: { before: 240, after: 120 },\n  });\n}\n\nasync function processParagraphBlock(block: Extract<DocBlock, { type: \"paragraph\" }>, fontConfig: FontConfig): Promise<Paragraph> {\n  const paragraphOptions: any = {\n    children: await tokensToChildren(block.text, fontConfig),\n    spacing: { after: 200, line: 276 },\n  };\n\n  if (block.style) {\n    paragraphOptions.style = block.style;\n  }\n\n  return new Paragraph(paragraphOptions);\n}\n\nasync function processBulletsBlock(block: Extract<DocBlock, { type: \"bullets\" }>, fontConfig: FontConfig): Promise<Paragraph[]> {\n  const paragraphs: Paragraph[] = [];\n  for (const item of block.items) {\n    paragraphs.push(\n      new Paragraph({\n        children: await tokensToChildren(item, fontConfig) as any,\n        bullet: { level: 0 },\n        spacing: { after: 80 },\n      })\n    );\n  }\n  return paragraphs;\n}\n\nasync function processNumberedBlock(block: NumberedBlock, fontConfig: FontConfig): Promise<Paragraph[]> {\n  const paragraphs: Paragraph[] = [];\n  for (const item of block.items) {\n    paragraphs.push(\n      new Paragraph({\n        children: await tokensToChildren(item, fontConfig) as any,\n        numbering: { reference: \"default-numbering\", level: 0 },\n        spacing: { after: 80 },\n      })\n    );\n  }\n  return paragraphs;\n}\n\nfunction processTocBlock(block: TocBlock): TableOfContents {\n  return new TableOfContents(\"Table of Contents\", {\n    hyperlink: true,\n    headingStyleRange: `1-${block.max_level}`,\n  });\n}\n\nasync function processTableBlock(block: Extract<DocBlock, { type: \"table\" }>, fontConfig: FontConfig): Promise<Table> {\n  const rows: TableRow[] = [];\n\n  if (block.header !== false) {\n    const headerCells: TableCell[] = [];\n    for (const col of block.columns) {\n      headerCells.push(\n        new TableCell({\n          children: [\n            new Paragraph({\n              children: await tokensToChildren(col, fontConfig, true) as any,\n            }),\n          ],\n          shading: { fill: \"E7E6E6\", type: \"clear\", color: \"auto\" },\n          borders: {\n            top: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n            bottom: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n            left: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n            right: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n          },\n        })\n      );\n    }\n    rows.push(new TableRow({ children: headerCells }));\n  }\n\n  for (const row of block.rows) {\n    const dataCells: TableCell[] = [];\n    for (const cell of row) {\n      dataCells.push(\n        new TableCell({\n          children: [\n            new Paragraph({\n              children: await tokensToChildren(String(cell ?? \"\"), fontConfig) as any,\n            }),\n          ],\n          borders: {\n            top: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n            bottom: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n            left: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n            right: { style: BorderStyle.SINGLE, size: 1, color: \"CCCCCC\" },\n          },\n        })\n      );\n    }\n    rows.push(new TableRow({ children: dataCells }));\n  }\n\n  return new Table({\n    width: { size: 100, type: WidthType.PERCENTAGE },\n    rows,\n  });\n}\n\nfunction processPageBreakBlock(): Paragraph {\n  return new Paragraph({\n    children: [new PageBreak()],\n  });\n}\n\nasync function processBlock(block: DocBlock, fontConfig: FontConfig): Promise<(Paragraph | Table | TableOfContents)[]> {\n  switch (block.type) {\n    case \"title\":\n      return [processTitleBlock(block, fontConfig)];\n    case \"heading\":\n      return [await processHeadingBlock(block, fontConfig)];\n    case \"paragraph\":\n      return [await processParagraphBlock(block, fontConfig)];\n    case \"bullets\":\n      return await processBulletsBlock(block, fontConfig);\n    case \"numbered\":\n      return await processNumberedBlock(block, fontConfig);\n    case \"table\":\n      return [await processTableBlock(block, fontConfig), new Paragraph({ spacing: { after: 200 } })];\n    case \"page_break\":\n      return [processPageBreakBlock()];\n    case \"toc\":\n      return [processTocBlock(block), new Paragraph({ spacing: { after: 400 } })];\n    default:\n      return [];\n  }\n}\n\nexport async function renderWordFromSpec(spec: DocSpec): Promise<Buffer> {\n  const styleset = spec.styleset || \"modern\";\n  const fontConfig = getStylesetConfig(styleset);\n  const bodyElements: (Paragraph | Table | TableOfContents)[] = [];\n\n  if (spec.add_toc) {\n    bodyElements.push(\n      new TableOfContents(\"Table of Contents\", {\n        hyperlink: true,\n        headingStyleRange: \"1-6\",\n      })\n    );\n    bodyElements.push(new Paragraph({ spacing: { after: 400 } }));\n  }\n\n  for (const block of spec.blocks) {\n    bodyElements.push(...await processBlock(block, fontConfig));\n  }\n\n  const doc = new Document({\n    title: spec.title,\n    creator: spec.author ?? undefined,\n    numbering: {\n      config: [\n        {\n          reference: \"default-numbering\",\n          levels: [\n            {\n              level: 0,\n              format: \"decimal\",\n              text: \"%1.\",\n              alignment: \"start\",\n              style: {\n                paragraph: {\n                  indent: { left: 720, hanging: 360 },\n                },\n              },\n            },\n          ],\n        },\n      ],\n    },\n    styles: {\n      paragraphStyles: [\n        {\n          id: \"Normal\",\n          name: \"Normal\",\n          basedOn: \"Normal\",\n          next: \"Normal\",\n          run: { font: fontConfig.font, size: fontConfig.size },\n          paragraph: { spacing: { line: 276 } },\n        },\n        {\n          id: \"Title\",\n          name: \"Title\",\n          basedOn: \"Normal\",\n          next: \"Normal\",\n          run: { font: fontConfig.font, size: 56, bold: true },\n          paragraph: { spacing: { after: 400 }, alignment: AlignmentType.CENTER },\n        },\n      ],\n    },\n    sections: [\n      {\n        properties: {\n          page: {\n            margin: {\n              top: convertInchesToTwip(1),\n              right: convertInchesToTwip(1),\n              bottom: convertInchesToTwip(1),\n              left: convertInchesToTwip(1),\n            },\n          },\n        },\n        children: bodyElements,\n      },\n    ],\n  });\n\n  return await Packer.toBuffer(doc);\n}\n","path":null,"size_bytes":9698,"size_tokens":null},"client/src/components/document-generator-dialog.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Loader2, FileText, FileSpreadsheet, Download, Sparkles } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface DocumentGeneratorDialogProps {\n  open: boolean;\n  onClose: () => void;\n  documentType: \"word\" | \"excel\";\n  onComplete?: (message: string) => void;\n}\n\ntype GenerateStatus = \"idle\" | \"generating\" | \"success\" | \"error\";\n\nexport function DocumentGeneratorDialog({ \n  open, \n  onClose, \n  documentType,\n  onComplete \n}: DocumentGeneratorDialogProps) {\n  const [prompt, setPrompt] = useState(\"\");\n  const [status, setStatus] = useState<GenerateStatus>(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (open) {\n      setPrompt(\"\");\n      setStatus(\"idle\");\n      setError(null);\n    }\n  }, [open]);\n\n  const generateDocument = async () => {\n    if (!prompt.trim()) {\n      setError(\"Por favor describe el documento que quieres crear\");\n      return;\n    }\n\n    setStatus(\"generating\");\n    setError(null);\n\n    try {\n      const endpoint = documentType === \"excel\" \n        ? \"/api/documents/generate/excel\" \n        : \"/api/documents/generate/word\";\n\n      const res = await fetch(endpoint, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ prompt: prompt.trim() })\n      });\n\n      if (!res.ok) {\n        const errData = await res.json();\n        throw new Error(errData.error || errData.details || \"Error al generar el documento\");\n      }\n\n      const blob = await res.blob();\n      const contentDisposition = res.headers.get(\"Content-Disposition\");\n      const filenameMatch = contentDisposition?.match(/filename=\"?([^\"]+)\"?/);\n      const filename = filenameMatch?.[1] || (documentType === \"excel\" ? \"documento.xlsx\" : \"documento.docx\");\n      \n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      setStatus(\"success\");\n      \n      if (onComplete) {\n        const docTypeLabel = documentType === \"excel\" ? \"Excel\" : \"Word\";\n        onComplete(`Se generó y descargó un documento ${docTypeLabel}: \"${filename}\"`);\n      }\n\n      setTimeout(() => {\n        onClose();\n      }, 1500);\n    } catch (err: any) {\n      setError(err.message || \"Error al generar el documento\");\n      setStatus(\"error\");\n    }\n  };\n\n  const docConfig = {\n    word: {\n      icon: FileText,\n      title: \"Crear Documento Word\",\n      description: \"Describe el documento que quieres crear y la IA lo generará automáticamente\",\n      placeholder: \"Ej: Crea un informe ejecutivo sobre el rendimiento del Q4 2024 con secciones de resumen, análisis de ventas, y recomendaciones...\",\n      color: \"bg-blue-600\",\n      buttonText: \"Generar Word\"\n    },\n    excel: {\n      icon: FileSpreadsheet,\n      title: \"Crear Hoja de Cálculo Excel\",\n      description: \"Describe los datos o análisis que necesitas y la IA creará el archivo Excel\",\n      placeholder: \"Ej: Crea una hoja de cálculo con datos de ventas mensuales del 2024, incluyendo productos, cantidades, precios y totales...\",\n      color: \"bg-green-600\",\n      buttonText: \"Generar Excel\"\n    }\n  };\n\n  const config = docConfig[documentType];\n  const Icon = config.icon;\n\n  return (\n    <Dialog open={open} onOpenChange={(isOpen) => !isOpen && onClose()}>\n      <DialogContent className=\"sm:max-w-lg\" data-testid=\"document-generator-dialog\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <div className={cn(\"flex items-center justify-center w-8 h-8 rounded\", config.color)}>\n              <Icon className=\"h-5 w-5 text-white\" />\n            </div>\n            {config.title}\n          </DialogTitle>\n          <DialogDescription>{config.description}</DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4 py-4\">\n          <Textarea\n            data-testid=\"input-document-prompt\"\n            placeholder={config.placeholder}\n            value={prompt}\n            onChange={(e) => setPrompt(e.target.value)}\n            className=\"min-h-[120px] resize-none\"\n            disabled={status === \"generating\"}\n          />\n\n          {error && (\n            <div className=\"text-sm text-destructive bg-destructive/10 p-3 rounded-md\" data-testid=\"text-error\">\n              {error}\n            </div>\n          )}\n\n          {status === \"success\" && (\n            <div className=\"text-sm text-green-600 bg-green-50 dark:bg-green-950/30 p-3 rounded-md flex items-center gap-2\" data-testid=\"text-success\">\n              <Download className=\"h-4 w-4\" />\n              Documento generado y descargado exitosamente\n            </div>\n          )}\n        </div>\n\n        <DialogFooter className=\"gap-2 sm:gap-0\">\n          <Button \n            variant=\"outline\" \n            onClick={onClose}\n            disabled={status === \"generating\"}\n            data-testid=\"button-cancel\"\n          >\n            Cancelar\n          </Button>\n          <Button \n            onClick={generateDocument}\n            disabled={status === \"generating\" || !prompt.trim()}\n            className={cn(\"gap-2\", documentType === \"excel\" ? \"bg-green-600 hover:bg-green-700\" : \"bg-blue-600 hover:bg-blue-700\")}\n            data-testid=\"button-generate\"\n          >\n            {status === \"generating\" ? (\n              <>\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                Generando...\n              </>\n            ) : (\n              <>\n                <Sparkles className=\"h-4 w-4\" />\n                {config.buttonText}\n              </>\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":6117,"size_tokens":null},"client/src/lib/commands/documentAdapter.ts":{"content":"import type { Editor } from '@tiptap/react';\nimport { commandBus, type CommandDefinition } from './commandBus';\n\nexport const documentCommands: CommandDefinition[] = [\n  {\n    name: 'bold',\n    label: 'Bold',\n    shortcut: 'Ctrl+B',\n    handler: ({ editor }) => editor.chain().focus().toggleBold().run(),\n  },\n  {\n    name: 'italic',\n    label: 'Italic',\n    shortcut: 'Ctrl+I',\n    handler: ({ editor }) => editor.chain().focus().toggleItalic().run(),\n  },\n  {\n    name: 'underline',\n    label: 'Underline',\n    shortcut: 'Ctrl+U',\n    handler: ({ editor }) => editor.chain().focus().toggleUnderline().run(),\n  },\n  {\n    name: 'strikethrough',\n    label: 'Strikethrough',\n    handler: ({ editor }) => editor.chain().focus().toggleStrike().run(),\n  },\n  {\n    name: 'heading1',\n    label: 'Heading 1',\n    handler: ({ editor }) => editor.chain().focus().toggleHeading({ level: 1 }).run(),\n  },\n  {\n    name: 'heading2',\n    label: 'Heading 2',\n    handler: ({ editor }) => editor.chain().focus().toggleHeading({ level: 2 }).run(),\n  },\n  {\n    name: 'heading3',\n    label: 'Heading 3',\n    handler: ({ editor }) => editor.chain().focus().toggleHeading({ level: 3 }).run(),\n  },\n  {\n    name: 'paragraph',\n    label: 'Paragraph',\n    handler: ({ editor }) => editor.chain().focus().setParagraph().run(),\n  },\n  {\n    name: 'bulletList',\n    label: 'Bullet List',\n    handler: ({ editor }) => editor.chain().focus().toggleBulletList().run(),\n  },\n  {\n    name: 'orderedList',\n    label: 'Numbered List',\n    handler: ({ editor }) => editor.chain().focus().toggleOrderedList().run(),\n  },\n  {\n    name: 'alignLeft',\n    label: 'Align Left',\n    handler: ({ editor }) => editor.chain().focus().setTextAlign('left').run(),\n  },\n  {\n    name: 'alignCenter',\n    label: 'Align Center',\n    handler: ({ editor }) => editor.chain().focus().setTextAlign('center').run(),\n  },\n  {\n    name: 'alignRight',\n    label: 'Align Right',\n    handler: ({ editor }) => editor.chain().focus().setTextAlign('right').run(),\n  },\n  {\n    name: 'alignJustify',\n    label: 'Justify',\n    handler: ({ editor }) => editor.chain().focus().setTextAlign('justify').run(),\n  },\n  {\n    name: 'undo',\n    label: 'Undo',\n    shortcut: 'Ctrl+Z',\n    handler: ({ editor }) => editor.chain().focus().undo().run(),\n  },\n  {\n    name: 'redo',\n    label: 'Redo',\n    shortcut: 'Ctrl+Y',\n    handler: ({ editor }) => editor.chain().focus().redo().run(),\n  },\n  {\n    name: 'insertLink',\n    label: 'Insert Link',\n    handler: ({ editor, payload }) => {\n      const url = payload.url as string;\n      if (!url) return false;\n      return editor.chain().focus().setLink({ href: url }).run();\n    },\n  },\n  {\n    name: 'removeLink',\n    label: 'Remove Link',\n    handler: ({ editor }) => editor.chain().focus().unsetLink().run(),\n  },\n  {\n    name: 'insertImage',\n    label: 'Insert Image',\n    handler: ({ editor, payload }) => {\n      const src = payload.src as string;\n      if (!src) return false;\n      return editor.chain().focus().setImage({ src }).run();\n    },\n  },\n  {\n    name: 'insertTable',\n    label: 'Insert Table',\n    handler: ({ editor, payload }) => {\n      const rows = (payload.rows as number) || 3;\n      const cols = (payload.cols as number) || 3;\n      return editor.chain().focus().insertTable({ rows, cols, withHeaderRow: true }).run();\n    },\n  },\n  {\n    name: 'deleteTable',\n    label: 'Delete Table',\n    handler: ({ editor }) => editor.chain().focus().deleteTable().run(),\n  },\n  {\n    name: 'addTableRowBefore',\n    label: 'Add Row Before',\n    handler: ({ editor }) => editor.chain().focus().addRowBefore().run(),\n  },\n  {\n    name: 'addTableRowAfter',\n    label: 'Add Row After',\n    handler: ({ editor }) => editor.chain().focus().addRowAfter().run(),\n  },\n  {\n    name: 'deleteTableRow',\n    label: 'Delete Row',\n    handler: ({ editor }) => editor.chain().focus().deleteRow().run(),\n  },\n  {\n    name: 'addTableColumnBefore',\n    label: 'Add Column Before',\n    handler: ({ editor }) => editor.chain().focus().addColumnBefore().run(),\n  },\n  {\n    name: 'addTableColumnAfter',\n    label: 'Add Column After',\n    handler: ({ editor }) => editor.chain().focus().addColumnAfter().run(),\n  },\n  {\n    name: 'deleteTableColumn',\n    label: 'Delete Column',\n    handler: ({ editor }) => editor.chain().focus().deleteColumn().run(),\n  },\n  {\n    name: 'setFontFamily',\n    label: 'Font Family',\n    handler: ({ editor, payload }) => {\n      const fontFamily = payload.fontFamily as string;\n      if (!fontFamily) return false;\n      return editor.chain().focus().setFontFamily(fontFamily).run();\n    },\n  },\n  {\n    name: 'setTextColor',\n    label: 'Text Color',\n    handler: ({ editor, payload }) => {\n      const color = payload.color as string;\n      if (!color) return false;\n      return editor.chain().focus().setColor(color).run();\n    },\n  },\n  {\n    name: 'setHighlight',\n    label: 'Highlight',\n    handler: ({ editor, payload }) => {\n      const color = payload.color as string;\n      if (!color) return editor.chain().focus().toggleHighlight().run();\n      return editor.chain().focus().toggleHighlight({ color }).run();\n    },\n  },\n  {\n    name: 'clearFormatting',\n    label: 'Clear Formatting',\n    handler: ({ editor }) => editor.chain().focus().clearNodes().unsetAllMarks().run(),\n  },\n  {\n    name: 'insertText',\n    label: 'Insert Text',\n    handler: ({ editor, payload }) => {\n      const text = payload.text as string;\n      if (!text) return false;\n      return editor.chain().focus().insertContent(text).run();\n    },\n  },\n  {\n    name: 'replaceSelection',\n    label: 'Replace Selection',\n    handler: ({ editor, payload }) => {\n      const content = payload.content as string;\n      if (!content) return false;\n      return editor.chain().focus().deleteSelection().insertContent(content).run();\n    },\n  },\n  {\n    name: 'insertHorizontalRule',\n    label: 'Horizontal Rule',\n    handler: ({ editor }) => editor.chain().focus().setHorizontalRule().run(),\n  },\n  {\n    name: 'blockquote',\n    label: 'Blockquote',\n    handler: ({ editor }) => editor.chain().focus().toggleBlockquote().run(),\n  },\n  {\n    name: 'codeBlock',\n    label: 'Code Block',\n    handler: ({ editor }) => editor.chain().focus().toggleCodeBlock().run(),\n  },\n];\n\nexport function initializeDocumentAdapter(editor: Editor): void {\n  commandBus.setEditor(editor);\n  commandBus.registerCommands(documentCommands);\n}\n\nexport function getEditorState(editor: Editor) {\n  return {\n    isBold: editor.isActive('bold'),\n    isItalic: editor.isActive('italic'),\n    isUnderline: editor.isActive('underline'),\n    isStrike: editor.isActive('strike'),\n    isHeading1: editor.isActive('heading', { level: 1 }),\n    isHeading2: editor.isActive('heading', { level: 2 }),\n    isHeading3: editor.isActive('heading', { level: 3 }),\n    isBulletList: editor.isActive('bulletList'),\n    isOrderedList: editor.isActive('orderedList'),\n    isBlockquote: editor.isActive('blockquote'),\n    isCodeBlock: editor.isActive('codeBlock'),\n    textAlign: editor.isActive({ textAlign: 'center' })\n      ? 'center'\n      : editor.isActive({ textAlign: 'right' })\n      ? 'right'\n      : editor.isActive({ textAlign: 'justify' })\n      ? 'justify'\n      : 'left',\n    isLink: editor.isActive('link'),\n    canUndo: editor.can().undo(),\n    canRedo: editor.can().redo(),\n  };\n}\n","path":null,"size_bytes":7322,"size_tokens":null},"attached_assets/__init___1766283299495.py":{"content":"from .agent import generate_excel_spec, generate_word_spec\n__all__=['generate_excel_spec','generate_word_spec']\n","path":null,"size_bytes":112,"size_tokens":null},"client/src/lib/commands/commandBus.ts":{"content":"import type { Editor } from '@tiptap/react';\n\nexport type CommandSource = 'ribbon' | 'keyboard' | 'ai' | 'context-menu';\n\nexport interface CommandPayload {\n  [key: string]: unknown;\n}\n\nexport interface CommandContext {\n  editor: Editor;\n  source: CommandSource;\n  payload: CommandPayload;\n}\n\nexport type CommandHandler = (ctx: CommandContext) => boolean;\n\nexport interface CommandDefinition {\n  name: string;\n  handler: CommandHandler;\n  label?: string;\n  icon?: string;\n  shortcut?: string;\n}\n\nexport interface CommandResult {\n  success: boolean;\n  commandName: string;\n  source: CommandSource;\n  error?: string;\n}\n\ntype CommandListener = (result: CommandResult) => void;\n\nclass CommandBus {\n  private commands: Map<string, CommandDefinition> = new Map();\n  private listeners: Set<CommandListener> = new Set();\n  private editor: Editor | null = null;\n\n  setEditor(editor: Editor) {\n    this.editor = editor;\n  }\n\n  getEditor(): Editor | null {\n    return this.editor;\n  }\n\n  registerCommand(definition: CommandDefinition): void {\n    this.commands.set(definition.name, definition);\n  }\n\n  registerCommands(definitions: CommandDefinition[]): void {\n    definitions.forEach((def) => this.registerCommand(def));\n  }\n\n  unregisterCommand(name: string): void {\n    this.commands.delete(name);\n  }\n\n  getCommand(name: string): CommandDefinition | undefined {\n    return this.commands.get(name);\n  }\n\n  getAllCommands(): CommandDefinition[] {\n    return Array.from(this.commands.values());\n  }\n\n  applyCommand(\n    commandName: string,\n    payload: CommandPayload = {},\n    source: CommandSource = 'ribbon'\n  ): CommandResult {\n    const definition = this.commands.get(commandName);\n    \n    if (!definition) {\n      const result: CommandResult = {\n        success: false,\n        commandName,\n        source,\n        error: `Command \"${commandName}\" not found`,\n      };\n      this.notifyListeners(result);\n      return result;\n    }\n\n    if (!this.editor) {\n      const result: CommandResult = {\n        success: false,\n        commandName,\n        source,\n        error: 'Editor not initialized',\n      };\n      this.notifyListeners(result);\n      return result;\n    }\n\n    try {\n      const success = definition.handler({\n        editor: this.editor,\n        source,\n        payload,\n      });\n\n      const result: CommandResult = {\n        success,\n        commandName,\n        source,\n      };\n      this.notifyListeners(result);\n      return result;\n    } catch (error) {\n      const result: CommandResult = {\n        success: false,\n        commandName,\n        source,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n      this.notifyListeners(result);\n      return result;\n    }\n  }\n\n  applyCommands(\n    commands: Array<{ name: string; payload?: CommandPayload }>,\n    source: CommandSource = 'ai'\n  ): CommandResult[] {\n    return commands.map(({ name, payload }) =>\n      this.applyCommand(name, payload || {}, source)\n    );\n  }\n\n  subscribe(listener: CommandListener): () => void {\n    this.listeners.add(listener);\n    return () => this.listeners.delete(listener);\n  }\n\n  private notifyListeners(result: CommandResult): void {\n    this.listeners.forEach((listener) => listener(result));\n  }\n\n  createSnapshot(): string | null {\n    if (!this.editor) return null;\n    return JSON.stringify(this.editor.getJSON());\n  }\n\n  restoreSnapshot(snapshot: string): boolean {\n    if (!this.editor) return false;\n    try {\n      const content = JSON.parse(snapshot);\n      this.editor.commands.setContent(content);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n}\n\nexport const commandBus = new CommandBus();\n\nexport function useCommandBus() {\n  return commandBus;\n}\n","path":null,"size_bytes":3715,"size_tokens":null},"attached_assets/common_1766283299495.py":{"content":"from __future__ import annotations\nimport re\nfrom typing import Any\n_CELL_RE = re.compile(r\"^[A-Z]{1,3}[1-9][0-9]{0,6}$\")\ndef is_cell_ref(value: str) -> bool: return bool(_CELL_RE.match(value or \"\"))\ndef assert_cell_ref(value: str) -> str:\n    if not is_cell_ref(value):\n        raise ValueError(f\"Invalid cell reference: {value!r} (expected like 'A1')\")\n    return value\ndef safe_str(value: Any) -> str:\n    try: return \"\" if value is None else str(value)\n    except Exception: return \"\"\n","path":null,"size_bytes":489,"size_tokens":null},"server/services/excelSpecRenderer.ts":{"content":"import ExcelJS from \"exceljs\";\nimport type { ExcelSpec, TableSpec, ChartSpec, SheetLayoutSpec, HeaderStyle } from \"../../shared/documentSpecs\";\nimport { tokenizeMarkdown, hasMarkdown, RichTextToken } from \"./richText/markdownTokenizer\";\nimport { formatLatexForExcel } from \"./richText/latexToImage\";\n\nconst FORMULA_PREFIXES = [\"=\", \"+\", \"-\", \"@\"];\n\ninterface ExcelRichTextRun {\n  text: string;\n  font?: Partial<ExcelJS.Font>;\n}\n\nfunction tokensToExcelRichText(tokens: RichTextToken[]): ExcelRichTextRun[] {\n  return tokens.map((token) => {\n    let displayText = token.text;\n    const font: Partial<ExcelJS.Font> = {};\n\n    if (token.bold) font.bold = true;\n    if (token.italic) font.italic = true;\n    if (token.code) {\n      font.name = \"Courier New\";\n      font.color = { argb: \"FF666666\" };\n    }\n    if (token.link) {\n      font.underline = true;\n      font.color = { argb: \"FF0066CC\" };\n    }\n    if (token.isMath) {\n      displayText = formatLatexForExcel(token.text);\n      font.italic = true;\n      font.color = { argb: \"FF336699\" };\n    }\n\n    const run: ExcelRichTextRun = { text: displayText };\n    if (Object.keys(font).length > 0) {\n      run.font = font;\n    }\n    return run;\n  });\n}\n\nfunction applyRichTextToCell(cell: ExcelJS.Cell, value: any): void {\n  if (value === null || value === undefined) {\n    cell.value = \"\";\n    return;\n  }\n\n  const strValue = String(value);\n  if (!hasMarkdown(strValue)) {\n    cell.value = strValue;\n    return;\n  }\n\n  const tokens = tokenizeMarkdown(strValue);\n  const richText = tokensToExcelRichText(tokens);\n  cell.value = { richText } as any;\n}\n\nconst MIN_COL_WIDTH = 8;\nconst MAX_COL_WIDTH = 60;\n\nfunction parseCellReference(ref: string): { col: number; row: number } {\n  const match = ref.match(/^([A-Z]+)(\\d+)$/i);\n  if (!match) {\n    throw new Error(`Invalid cell reference: ${ref}`);\n  }\n  const colLetters = match[1].toUpperCase();\n  const row = parseInt(match[2], 10);\n  let col = 0;\n  for (let i = 0; i < colLetters.length; i++) {\n    col = col * 26 + (colLetters.charCodeAt(i) - 64);\n  }\n  return { col, row };\n}\n\nfunction columnIndexToLetter(index: number): string {\n  let letter = \"\";\n  while (index > 0) {\n    const mod = (index - 1) % 26;\n    letter = String.fromCharCode(65 + mod) + letter;\n    index = Math.floor((index - 1) / 26);\n  }\n  return letter || \"A\";\n}\n\nfunction escapeFormulaText(value: any): any {\n  if (value === null || value === undefined) {\n    return value;\n  }\n  if (typeof value !== \"string\") {\n    return value;\n  }\n  const trimmed = value.trimStart();\n  if (trimmed.length > 0 && FORMULA_PREFIXES.includes(trimmed[0])) {\n    return \"'\" + value;\n  }\n  return value;\n}\n\nfunction sanitizeTableName(name: string | null | undefined, fallbackIndex: number): string {\n  if (!name) {\n    return `Table${fallbackIndex}`;\n  }\n  let cleaned = name.replace(/[^A-Za-z0-9_]/g, \"_\").trim();\n  if (!cleaned) {\n    return `Table${fallbackIndex}`;\n  }\n  if (!/^[A-Za-z_]/.test(cleaned)) {\n    cleaned = `T_${cleaned}`;\n  }\n  return cleaned.slice(0, 255);\n}\n\nfunction heuristicColumnWidth(values: any[]): number {\n  let maxLen = 0;\n  for (const v of values) {\n    const s = v === null || v === undefined ? \"\" : String(v);\n    maxLen = Math.max(maxLen, s.length);\n  }\n  const width = maxLen + 2;\n  return Math.min(Math.max(width, MIN_COL_WIDTH), MAX_COL_WIDTH);\n}\n\nlet tableCounter = 0;\n\nexport async function renderExcelFromSpec(spec: ExcelSpec): Promise<Buffer> {\n  const workbook = new ExcelJS.Workbook();\n  workbook.creator = \"Sira GPT\";\n  workbook.created = new Date();\n  tableCounter = 0;\n\n  if (spec.workbook_title) {\n    workbook.title = spec.workbook_title;\n  }\n\n  for (const sheetSpec of spec.sheets) {\n    const sheetName = sheetSpec.name.replace(/[\\\\/:*?\\[\\]]/g, \"\").slice(0, 31) || \"Sheet\";\n    const worksheet = workbook.addWorksheet(sheetName);\n\n    for (const tableSpec of sheetSpec.tables || []) {\n      renderTable(worksheet, tableSpec);\n    }\n\n    for (const chartSpec of sheetSpec.charts || []) {\n      renderChart(worksheet, chartSpec, sheetName);\n    }\n\n    applyLayout(worksheet, sheetSpec.layout || {});\n  }\n\n  const buffer = await workbook.xlsx.writeBuffer();\n  return Buffer.from(buffer);\n}\n\nfunction renderTable(worksheet: ExcelJS.Worksheet, table: TableSpec): void {\n  const anchor = parseCellReference(table.anchor);\n  const startRow = anchor.row;\n  const startCol = anchor.col;\n  \n  const endCol = startCol + table.headers.length - 1;\n  const endRow = startRow + (table.rows?.length || 0);\n  \n  tableCounter++;\n  const tableName = sanitizeTableName(table.name, tableCounter);\n  \n  const tableStyle = table.table_style || \"TableStyleMedium9\";\n  const formulas = table.formulas || {};\n  const formulaHeaders = new Set(Object.keys(formulas));\n\n  const processedRows = (table.rows || []).map((row, rowIdx) => {\n    const excelRowNum = startRow + 1 + rowIdx;\n    return row.map((value, colIdx) => {\n      const header = table.headers[colIdx];\n      if (formulaHeaders.has(header)) {\n        const template = formulas[header];\n        return template.replace(/\\{row\\}/g, String(excelRowNum));\n      }\n      return escapeFormulaText(value);\n    });\n  });\n\n  worksheet.addTable({\n    name: tableName,\n    ref: table.anchor,\n    headerRow: true,\n    totalsRow: false,\n    style: {\n      theme: tableStyle as any,\n      showRowStripes: true,\n      showColumnStripes: false,\n    },\n    columns: table.headers.map(header => ({\n      name: header,\n      filterButton: table.autofilter !== false,\n    })),\n    rows: processedRows,\n  });\n\n  for (let rowIdx = 0; rowIdx < (table.rows?.length || 0); rowIdx++) {\n    const excelRowNum = startRow + 1 + rowIdx;\n    const excelRow = worksheet.getRow(excelRowNum);\n    const row = table.rows![rowIdx];\n    row.forEach((value, colIdx) => {\n      const header = table.headers[colIdx];\n      if (!formulaHeaders.has(header) && value != null && typeof value === \"string\" && hasMarkdown(value)) {\n        const cell = excelRow.getCell(startCol + colIdx);\n        applyRichTextToCell(cell, value);\n      }\n    });\n  }\n\n  const headerStyle = table.header_style || {};\n  applyHeaderStyle(worksheet, startRow, startCol, table.headers, headerStyle);\n\n  if (table.column_formats) {\n    for (let rowIdx = 1; rowIdx <= (table.rows?.length || 0); rowIdx++) {\n      const excelRow = worksheet.getRow(startRow + rowIdx);\n      table.headers.forEach((header, colIdx) => {\n        if (table.column_formats![header]) {\n          const cell = excelRow.getCell(startCol + colIdx);\n          cell.numFmt = table.column_formats![header];\n        }\n      });\n    }\n  }\n\n  applyAutoFitForTable(worksheet, table, startCol);\n\n  if (table.freeze_header !== false) {\n    worksheet.views = [\n      { state: \"frozen\", xSplit: 0, ySplit: startRow },\n    ];\n  }\n}\n\nfunction applyHeaderStyle(\n  worksheet: ExcelJS.Worksheet,\n  headerRow: number,\n  startCol: number,\n  headers: string[],\n  style: Partial<HeaderStyle>\n): void {\n  const row = worksheet.getRow(headerRow);\n  \n  headers.forEach((_, colIdx) => {\n    const cell = row.getCell(startCol + colIdx);\n    \n    const fontOptions: Partial<ExcelJS.Font> = {};\n    if (style.bold !== false) {\n      fontOptions.bold = true;\n    }\n    if (Object.keys(fontOptions).length > 0) {\n      cell.font = { ...cell.font, ...fontOptions };\n    }\n\n    if (style.fill_color) {\n      cell.fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: `FF${style.fill_color.replace(/^#/, \"\")}` },\n      };\n    }\n\n    const alignmentOptions: Partial<ExcelJS.Alignment> = {};\n    if (style.text_align) {\n      alignmentOptions.horizontal = style.text_align;\n    }\n    if (style.wrap_text !== false) {\n      alignmentOptions.wrapText = true;\n    }\n    alignmentOptions.vertical = \"middle\";\n    \n    if (Object.keys(alignmentOptions).length > 0) {\n      cell.alignment = { ...cell.alignment, ...alignmentOptions };\n    }\n  });\n}\n\nfunction applyAutoFitForTable(\n  worksheet: ExcelJS.Worksheet,\n  table: TableSpec,\n  startCol: number\n): void {\n  table.headers.forEach((header, colIdx) => {\n    const colLetter = columnIndexToLetter(startCol + colIdx);\n    const column = worksheet.getColumn(startCol + colIdx);\n    \n    if (column.width !== undefined && column.width !== 8.43) {\n      return;\n    }\n\n    const columnValues: any[] = [header];\n    for (const row of table.rows || []) {\n      columnValues.push(row[colIdx]);\n    }\n\n    column.width = heuristicColumnWidth(columnValues);\n  });\n}\n\nfunction renderChart(worksheet: ExcelJS.Worksheet, chart: ChartSpec, sheetName: string): void {\n  try {\n    const position = parseCellReference(chart.position || \"H2\");\n    const cell = worksheet.getRow(position.row).getCell(position.col);\n    cell.value = `[Chart placeholder: ${chart.title || chart.type || 'Chart'} - Charts require manual creation in Excel]`;\n    cell.font = { italic: true, color: { argb: \"FF808080\" } };\n  } catch (error) {\n    console.warn(`[ExcelRenderer] Invalid chart position \"${chart.position}\", using default H2`);\n    const cell = worksheet.getRow(2).getCell(8);\n    cell.value = `[Chart: ${chart.title || chart.type || 'Chart'}]`;\n    cell.font = { italic: true, color: { argb: \"FF808080\" } };\n  }\n}\n\nfunction applyLayout(worksheet: ExcelJS.Worksheet, layout: SheetLayoutSpec): void {\n  if (layout.freeze_panes) {\n    const freeze = parseCellReference(layout.freeze_panes);\n    worksheet.views = [\n      { state: \"frozen\", xSplit: freeze.col - 1, ySplit: freeze.row - 1 },\n    ];\n  }\n\n  if (layout.show_gridlines === false) {\n    worksheet.views = worksheet.views?.map(v => ({ ...v, showGridLines: false })) || \n      [{ showGridLines: false }];\n  }\n\n  if (layout.column_widths) {\n    for (const [colLetter, width] of Object.entries(layout.column_widths)) {\n      const colNum = parseCellReference(`${colLetter}1`).col;\n      const column = worksheet.getColumn(colNum);\n      column.width = width;\n    }\n  }\n\n  if (layout.auto_fit_columns !== false) {\n    worksheet.columns?.forEach(column => {\n      if (column.width === undefined || column.width === 8.43) {\n        const values: any[] = [];\n        column.eachCell?.({ includeEmpty: false }, cell => {\n          values.push(cell.value);\n        });\n        if (values.length > 0) {\n          column.width = heuristicColumnWidth(values);\n        }\n      }\n    });\n  }\n}\n","path":null,"size_bytes":10293,"size_tokens":null},"client/src/lib/orchestrator/index.ts":{"content":"export { aiOrchestrator, type DocumentPlan, type PlannedCommand, type ExecutionResult, type OrchestratorOptions } from './aiOrchestrator';\n","path":null,"size_bytes":139,"size_tokens":null},"server/services/documentValidators.ts":{"content":"import {\n  excelSpecSchema,\n  docSpecSchema,\n  type ExcelSpec,\n  type DocSpec,\n} from \"../../shared/documentSpecs\";\n\nexport interface ValidationResult {\n  valid: boolean;\n  errors: string[];\n}\n\n/**\n * Parse a cell reference like \"A1\" into column and row indices\n * @param ref Cell reference string (e.g., \"A1\", \"B2\", \"AA10\")\n * @returns { col: number, row: number } or null if invalid\n */\nexport function parseCellReference(ref: string): { col: number; row: number } | null {\n  const match = ref.match(/^([A-Z]+)(\\d+)$/i);\n  if (!match) return null;\n\n  const colStr = match[1].toUpperCase();\n  const rowStr = match[2];\n\n  // Convert column letters to 0-based index (A=0, B=1, ..., Z=25, AA=26, etc.)\n  let col = 0;\n  for (let i = 0; i < colStr.length; i++) {\n    col = col * 26 + (colStr.charCodeAt(i) - 64);\n  }\n  col -= 1; // Convert to 0-based\n\n  const row = parseInt(rowStr, 10);\n  if (row < 1) return null;\n\n  return { col, row };\n}\n\n/**\n * Validate an Excel specification against the schema and additional business rules\n */\nexport function validateExcelSpec(spec: unknown): ValidationResult {\n  const errors: string[] = [];\n\n  // Validate against Zod schema\n  const parseResult = excelSpecSchema.safeParse(spec);\n  if (!parseResult.success) {\n    for (const issue of parseResult.error.issues) {\n      errors.push(`${issue.path.join(\".\")}: ${issue.message}`);\n    }\n    return { valid: false, errors };\n  }\n\n  const validSpec = parseResult.data as ExcelSpec;\n\n  // Check sheet names are unique\n  const sheetNames = new Set<string>();\n  for (const sheet of validSpec.sheets) {\n    if (sheetNames.has(sheet.name)) {\n      errors.push(`Duplicate sheet name: \"${sheet.name}\"`);\n    }\n    sheetNames.add(sheet.name);\n\n    // Validate tables in each sheet\n    for (let tableIdx = 0; tableIdx < sheet.tables.length; tableIdx++) {\n      const table = sheet.tables[tableIdx];\n\n      // Validate anchor cell reference\n      const anchorParsed = parseCellReference(table.anchor);\n      if (!anchorParsed) {\n        errors.push(\n          `Sheet \"${sheet.name}\", table ${tableIdx + 1}: Invalid anchor cell reference \"${table.anchor}\"`\n        );\n      }\n\n      // Check all rows have same length as headers\n      const headerLength = table.headers.length;\n      for (let rowIdx = 0; rowIdx < table.rows.length; rowIdx++) {\n        const row = table.rows[rowIdx];\n        if (row.length !== headerLength) {\n          errors.push(\n            `Sheet \"${sheet.name}\", table ${tableIdx + 1}, row ${rowIdx + 1}: Row has ${row.length} cells but headers have ${headerLength} columns`\n          );\n        }\n      }\n    }\n\n    // Validate chart ranges (validate all cell references)\n    for (let chartIdx = 0; chartIdx < sheet.charts.length; chartIdx++) {\n      const chart = sheet.charts[chartIdx];\n\n      // Validate position\n      const positionParsed = parseCellReference(chart.position);\n      if (!positionParsed) {\n        errors.push(\n          `Sheet \"${sheet.name}\", chart ${chartIdx + 1}: Invalid position \"${chart.position}\"`\n        );\n      }\n\n      // Validate categories_range (can be a range like \"A2:A10\" or single cell)\n      if (!chart.categories_range || chart.categories_range.trim() === \"\") {\n        errors.push(\n          `Sheet \"${sheet.name}\", chart ${chartIdx + 1}: categories_range is required`\n        );\n      } else {\n        const rangeParts = chart.categories_range.split(\":\");\n        for (const part of rangeParts) {\n          if (!parseCellReference(part.trim())) {\n            errors.push(\n              `Sheet \"${sheet.name}\", chart ${chartIdx + 1}: Invalid categories_range \"${chart.categories_range}\"`\n            );\n            break;\n          }\n        }\n      }\n\n      // Validate values_range (can be a range like \"B2:B10\" or single cell)\n      if (!chart.values_range || chart.values_range.trim() === \"\") {\n        errors.push(\n          `Sheet \"${sheet.name}\", chart ${chartIdx + 1}: values_range is required`\n        );\n      } else {\n        const rangeParts = chart.values_range.split(\":\");\n        for (const part of rangeParts) {\n          if (!parseCellReference(part.trim())) {\n            errors.push(\n              `Sheet \"${sheet.name}\", chart ${chartIdx + 1}: Invalid values_range \"${chart.values_range}\"`\n            );\n            break;\n          }\n        }\n      }\n    }\n  }\n\n  return { valid: errors.length === 0, errors };\n}\n\n/**\n * Validate a Word document specification against the schema and additional business rules\n */\nexport function validateDocSpec(spec: unknown): ValidationResult {\n  const errors: string[] = [];\n\n  // Validate against Zod schema\n  const parseResult = docSpecSchema.safeParse(spec);\n  if (!parseResult.success) {\n    for (const issue of parseResult.error.issues) {\n      errors.push(`${issue.path.join(\".\")}: ${issue.message}`);\n    }\n    return { valid: false, errors };\n  }\n\n  const validSpec = parseResult.data as DocSpec;\n\n  // Validate each block\n  for (let blockIdx = 0; blockIdx < validSpec.blocks.length; blockIdx++) {\n    const block = validSpec.blocks[blockIdx];\n\n    if (block.type === \"heading\") {\n      // Check heading levels are 1-6 (already enforced by schema, but double-check)\n      if (block.level < 1 || block.level > 6) {\n        errors.push(\n          `Block ${blockIdx + 1}: Heading level must be between 1 and 6, got ${block.level}`\n        );\n      }\n    }\n\n    if (block.type === \"table\") {\n      // Check all rows have same length as columns\n      const columnCount = block.columns.length;\n      for (let rowIdx = 0; rowIdx < block.rows.length; rowIdx++) {\n        const row = block.rows[rowIdx];\n        if (row.length !== columnCount) {\n          errors.push(\n            `Block ${blockIdx + 1} (table), row ${rowIdx + 1}: Row has ${row.length} cells but table has ${columnCount} columns`\n          );\n        }\n      }\n    }\n\n    if (block.type === \"title\") {\n      // Validate title text is non-empty\n      if (!block.text || block.text.trim() === \"\") {\n        errors.push(\n          `Block ${blockIdx + 1} (title): Title text must be non-empty`\n        );\n      }\n    }\n\n    if (block.type === \"toc\") {\n      // Validate max_level is 1-6 (already enforced by schema, but double-check)\n      if (block.max_level < 1 || block.max_level > 6) {\n        errors.push(\n          `Block ${blockIdx + 1} (toc): max_level must be between 1 and 6, got ${block.max_level}`\n        );\n      }\n    }\n\n    if (block.type === \"numbered\") {\n      // Validate numbered list items array like bullets\n      if (!block.items || block.items.length === 0) {\n        errors.push(\n          `Block ${blockIdx + 1} (numbered): Numbered list must have at least one item`\n        );\n      }\n    }\n  }\n\n  return { valid: errors.length === 0, errors };\n}\n\n/**\n * Validate that a buffer is a valid XLSX file (ZIP format with PK signature)\n */\nexport function validateExcelFile(buffer: Buffer): ValidationResult {\n  const errors: string[] = [];\n\n  if (buffer.length < 4) {\n    errors.push(\"File is too small to be a valid XLSX file\");\n    return { valid: false, errors };\n  }\n\n  // Check for ZIP/PK signature (0x50, 0x4B, 0x03, 0x04)\n  if (\n    buffer[0] !== 0x50 ||\n    buffer[1] !== 0x4b ||\n    buffer[2] !== 0x03 ||\n    buffer[3] !== 0x04\n  ) {\n    errors.push(\"File does not have valid XLSX signature (expected ZIP/PK header)\");\n    return { valid: false, errors };\n  }\n\n  return { valid: true, errors: [] };\n}\n\n/**\n * Validate that a buffer is a valid DOCX file (ZIP format with PK signature)\n */\nexport function validateDocxFile(buffer: Buffer): ValidationResult {\n  const errors: string[] = [];\n\n  if (buffer.length < 4) {\n    errors.push(\"File is too small to be a valid DOCX file\");\n    return { valid: false, errors };\n  }\n\n  // Check for ZIP/PK signature (0x50, 0x4B, 0x03, 0x04)\n  if (\n    buffer[0] !== 0x50 ||\n    buffer[1] !== 0x4b ||\n    buffer[2] !== 0x03 ||\n    buffer[3] !== 0x04\n  ) {\n    errors.push(\"File does not have valid DOCX signature (expected ZIP/PK header)\");\n    return { valid: false, errors };\n  }\n\n  return { valid: true, errors: [] };\n}\n\nexport interface PostRenderValidationResult {\n  valid: boolean;\n  errors: string[];\n  warnings: string[];\n  metadata?: {\n    sheetCount?: number;\n    worksheetNames?: string[];\n    paragraphCount?: number;\n    tableCount?: number;\n  };\n}\n\n/**\n * Deep validation of a generated Word document buffer by attempting to parse it\n * This validates the actual document structure, not just the ZIP header\n */\nexport async function validateGeneratedWordBuffer(buffer: Buffer): Promise<PostRenderValidationResult> {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n  const metadata: PostRenderValidationResult[\"metadata\"] = {};\n\n  // First check basic ZIP structure\n  const basicValidation = validateDocxFile(buffer);\n  if (!basicValidation.valid) {\n    return { valid: false, errors: basicValidation.errors, warnings };\n  }\n\n  try {\n    // Try to parse the DOCX using JSZip to verify structure\n    const JSZip = (await import(\"jszip\")).default;\n    const zip = await JSZip.loadAsync(buffer);\n    \n    // Check for required DOCX components\n    const contentTypes = zip.file(\"[Content_Types].xml\");\n    if (!contentTypes) {\n      errors.push(\"Missing [Content_Types].xml - invalid DOCX structure\");\n    }\n\n    const documentXml = zip.file(\"word/document.xml\");\n    if (!documentXml) {\n      errors.push(\"Missing word/document.xml - invalid DOCX structure\");\n    } else {\n      // Parse the document XML to count elements\n      const documentContent = await documentXml.async(\"text\");\n      \n      // Count paragraphs (rough estimate)\n      const paragraphMatches = documentContent.match(/<w:p[^>]*>/g);\n      metadata.paragraphCount = paragraphMatches ? paragraphMatches.length : 0;\n      \n      // Count tables\n      const tableMatches = documentContent.match(/<w:tbl[^>]*>/g);\n      metadata.tableCount = tableMatches ? tableMatches.length : 0;\n      \n      if (metadata.paragraphCount === 0 && metadata.tableCount === 0) {\n        warnings.push(\"Document appears to have no content (no paragraphs or tables found)\");\n      }\n    }\n\n    // Check for styles\n    const stylesXml = zip.file(\"word/styles.xml\");\n    if (!stylesXml) {\n      warnings.push(\"Missing word/styles.xml - document may have formatting issues\");\n    }\n\n    // Check relationships file\n    const relsFile = zip.file(\"word/_rels/document.xml.rels\");\n    if (!relsFile) {\n      warnings.push(\"Missing word/_rels/document.xml.rels - some references may not work\");\n    }\n\n  } catch (parseError) {\n    errors.push(`Failed to parse DOCX structure: ${(parseError as Error).message}`);\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n    metadata,\n  };\n}\n\n/**\n * Deep validation of a generated Excel document buffer by attempting to parse it with ExcelJS\n * This validates the actual workbook structure, not just the ZIP header\n */\nexport async function validateGeneratedExcelBuffer(buffer: Buffer): Promise<PostRenderValidationResult> {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n  const metadata: PostRenderValidationResult[\"metadata\"] = {};\n\n  // First check basic ZIP structure\n  const basicValidation = validateExcelFile(buffer);\n  if (!basicValidation.valid) {\n    return { valid: false, errors: basicValidation.errors, warnings };\n  }\n\n  try {\n    // Try to parse with ExcelJS\n    const ExcelJS = await import(\"exceljs\");\n    const workbook = new ExcelJS.Workbook();\n    await workbook.xlsx.load(buffer);\n\n    // Get sheet information\n    metadata.sheetCount = workbook.worksheets.length;\n    metadata.worksheetNames = workbook.worksheets.map(ws => ws.name);\n\n    if (metadata.sheetCount === 0) {\n      errors.push(\"Workbook has no worksheets\");\n    }\n\n    // Validate each worksheet\n    for (const worksheet of workbook.worksheets) {\n      if (!worksheet.name || worksheet.name.trim() === \"\") {\n        warnings.push(`Worksheet at index ${worksheet.id} has no name`);\n      }\n\n      // Check for some data\n      let cellCount = 0;\n      worksheet.eachRow((row, rowNumber) => {\n        row.eachCell((cell, colNumber) => {\n          cellCount++;\n        });\n      });\n\n      if (cellCount === 0) {\n        warnings.push(`Worksheet \"${worksheet.name}\" appears to be empty`);\n      }\n    }\n\n  } catch (parseError) {\n    errors.push(`Failed to parse Excel structure: ${(parseError as Error).message}`);\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n    metadata,\n  };\n}\n","path":null,"size_bytes":12469,"size_tokens":null},"shared/documentSpecs.ts":{"content":"import { z } from \"zod\";\n\n// -------------------------\n// Excel (XLSX) specification\n// -------------------------\n\n// Header styling configuration\nexport const headerStyleSchema = z.object({\n  bold: z.boolean().default(true),\n  fill_color: z.string().nullable().optional().describe(\"Header background color hex, e.g. 'D9E1F2'\"),\n  text_align: z.enum([\"left\", \"center\", \"right\"]).default(\"center\"),\n  wrap_text: z.boolean().default(true),\n});\n\nexport type HeaderStyle = z.infer<typeof headerStyleSchema>;\n\nexport const tableSpecSchema = z.object({\n  name: z.string().nullable().optional().describe(\"Optional table name, auto-generated if not provided\"),\n  anchor: z.string().describe(\"Top-left cell, e.g. 'A1'\"),\n  headers: z.array(z.string()).min(1),\n  rows: z.array(z.array(z.any())).default([]),\n  table_style: z.string().default(\"TableStyleMedium9\").describe(\"Excel table style name (OpenXML)\"),\n  column_formats: z.record(z.string(), z.string()).default({}).describe(\"Map header -> Excel number format\"),\n  formulas: z.record(z.string(), z.string()).default({}).describe(\"Map header -> formula template with {row} placeholder, e.g. {'Total': '=B{row}*C{row}'}\"),\n  header_style: headerStyleSchema.default({}).describe(\"Styling for header row\"),\n  autofilter: z.boolean().default(true),\n  freeze_header: z.boolean().default(true),\n});\n\nexport type TableSpec = z.infer<typeof tableSpecSchema>;\n\nexport const chartSpecSchema = z.object({\n  type: z.enum([\"bar\", \"line\", \"pie\"]).default(\"bar\"),\n  title: z.string().default(\"\"),\n  categories_range: z.string().describe(\"Excel A1 range for categories, e.g. 'A2:A10'\"),\n  values_range: z.string().describe(\"Excel A1 range for values, e.g. 'B2:B10'\"),\n  position: z.string().default(\"H2\").describe(\"Top-left position of the chart\"),\n});\n\nexport type ChartSpec = z.infer<typeof chartSpecSchema>;\n\nexport const sheetLayoutSpecSchema = z.object({\n  freeze_panes: z.string().nullable().optional().describe(\"Cell reference for freeze panes, e.g. 'A2'\"),\n  auto_fit_columns: z.boolean().default(true),\n  column_widths: z.record(z.string(), z.number()).default({}).describe(\"Map column letter -> width\"),\n  show_gridlines: z.boolean().default(true),\n});\n\nexport type SheetLayoutSpec = z.infer<typeof sheetLayoutSpecSchema>;\n\nexport const sheetSpecSchema = z.object({\n  name: z.string().min(1).max(31),\n  tables: z.array(tableSpecSchema).default([]),\n  charts: z.array(chartSpecSchema).default([]),\n  layout: sheetLayoutSpecSchema.default({}),\n});\n\nexport type SheetSpec = z.infer<typeof sheetSpecSchema>;\n\nexport const excelSpecSchema = z.object({\n  workbook_title: z.string().default(\"Report\"),\n  sheets: z.array(sheetSpecSchema).min(1),\n});\n\nexport type ExcelSpec = z.infer<typeof excelSpecSchema>;\n\n// ------------------------\n// Word (DOCX) specification\n// ------------------------\n\n// Title block (document title with Title style)\nexport const titleBlockSchema = z.object({\n  type: z.literal(\"title\"),\n  text: z.string().min(1),\n});\n\nexport type TitleBlock = z.infer<typeof titleBlockSchema>;\n\nexport const headingBlockSchema = z.object({\n  type: z.literal(\"heading\"),\n  level: z.number().int().min(1).max(6).default(1),\n  text: z.string(),\n});\n\nexport type HeadingBlock = z.infer<typeof headingBlockSchema>;\n\nexport const paragraphBlockSchema = z.object({\n  type: z.literal(\"paragraph\"),\n  text: z.string(),\n  style: z.string().nullable().optional().describe(\"Optional paragraph style name\"),\n});\n\nexport type ParagraphBlock = z.infer<typeof paragraphBlockSchema>;\n\nexport const bulletsBlockSchema = z.object({\n  type: z.literal(\"bullets\"),\n  items: z.array(z.string()).min(1),\n});\n\nexport type BulletsBlock = z.infer<typeof bulletsBlockSchema>;\n\n// Numbered list block\nexport const numberedBlockSchema = z.object({\n  type: z.literal(\"numbered\"),\n  items: z.array(z.string()).min(1),\n});\n\nexport type NumberedBlock = z.infer<typeof numberedBlockSchema>;\n\nexport const tableBlockSchema = z.object({\n  type: z.literal(\"table\"),\n  columns: z.array(z.string()).min(1),\n  rows: z.array(z.array(z.any())).default([]),\n  style: z.string().default(\"Table Grid\").describe(\"Word table style name\"),\n  header: z.boolean().default(true).describe(\"Whether to show header row\"),\n});\n\nexport type TableBlock = z.infer<typeof tableBlockSchema>;\n\nexport const pageBreakBlockSchema = z.object({\n  type: z.literal(\"page_break\"),\n});\n\nexport type PageBreakBlock = z.infer<typeof pageBreakBlockSchema>;\n\n// Table of contents block\nexport const tocBlockSchema = z.object({\n  type: z.literal(\"toc\"),\n  max_level: z.number().int().min(1).max(6).default(3).describe(\"Maximum heading level to include\"),\n});\n\nexport type TocBlock = z.infer<typeof tocBlockSchema>;\n\nexport const docBlockSchema = z.discriminatedUnion(\"type\", [\n  titleBlockSchema,\n  headingBlockSchema,\n  paragraphBlockSchema,\n  bulletsBlockSchema,\n  numberedBlockSchema,\n  tableBlockSchema,\n  pageBreakBlockSchema,\n  tocBlockSchema,\n]);\n\nexport type DocBlock = z.infer<typeof docBlockSchema>;\n\nexport const docSpecSchema = z.object({\n  title: z.string().default(\"Document\"),\n  author: z.string().nullable().optional(),\n  styleset: z.enum([\"modern\", \"classic\"]).default(\"modern\").describe(\"Font style: modern=Calibri, classic=Times New Roman\"),\n  add_toc: z.boolean().default(false),\n  blocks: z.array(docBlockSchema).default([]).describe(\"Ordered content blocks\"),\n});\n\nexport type DocSpec = z.infer<typeof docSpecSchema>;\n\n// JSON Schema exports for LLM prompts\nexport const excelSpecJsonSchema = {\n  type: \"object\",\n  properties: {\n    workbook_title: { type: \"string\", default: \"Report\" },\n    sheets: {\n      type: \"array\",\n      minItems: 1,\n      items: {\n        type: \"object\",\n        properties: {\n          name: { type: \"string\", minLength: 1, maxLength: 31 },\n          tables: {\n            type: \"array\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\", description: \"Optional table name\" },\n                anchor: { type: \"string\", description: \"Top-left cell, e.g. 'A1'\" },\n                headers: { type: \"array\", items: { type: \"string\" }, minItems: 1 },\n                rows: { type: \"array\", items: { type: \"array\" } },\n                table_style: { type: \"string\", default: \"TableStyleMedium9\" },\n                column_formats: { type: \"object\", additionalProperties: { type: \"string\" }, description: \"Map header -> Excel number format\" },\n                formulas: { type: \"object\", additionalProperties: { type: \"string\" }, description: \"Map header -> formula template with {row}, e.g. {'Total': '=B{row}*C{row}'}\" },\n                header_style: {\n                  type: \"object\",\n                  properties: {\n                    bold: { type: \"boolean\", default: true },\n                    fill_color: { type: \"string\", description: \"Hex color e.g. 'D9E1F2'\" },\n                    text_align: { type: \"string\", enum: [\"left\", \"center\", \"right\"], default: \"center\" },\n                    wrap_text: { type: \"boolean\", default: true },\n                  },\n                },\n                autofilter: { type: \"boolean\", default: true },\n                freeze_header: { type: \"boolean\", default: true },\n              },\n              required: [\"anchor\", \"headers\"],\n            },\n          },\n          charts: {\n            type: \"array\",\n            items: {\n              type: \"object\",\n              properties: {\n                type: { type: \"string\", enum: [\"bar\", \"line\", \"pie\"], default: \"bar\" },\n                title: { type: \"string\" },\n                categories_range: { type: \"string\" },\n                values_range: { type: \"string\" },\n                position: { type: \"string\", default: \"H2\" },\n              },\n              required: [\"categories_range\", \"values_range\"],\n            },\n          },\n          layout: {\n            type: \"object\",\n            properties: {\n              freeze_panes: { type: \"string\", nullable: true },\n              auto_fit_columns: { type: \"boolean\", default: true },\n              column_widths: { type: \"object\", additionalProperties: { type: \"number\" } },\n              show_gridlines: { type: \"boolean\", default: true },\n            },\n          },\n        },\n        required: [\"name\"],\n      },\n    },\n  },\n  required: [\"sheets\"],\n};\n\nexport const docSpecJsonSchema = {\n  type: \"object\",\n  properties: {\n    title: { type: \"string\", default: \"Document\" },\n    author: { type: \"string\", nullable: true },\n    styleset: { type: \"string\", enum: [\"modern\", \"classic\"], default: \"modern\", description: \"Font style: modern=Calibri, classic=Times New Roman\" },\n    add_toc: { type: \"boolean\", default: false },\n    blocks: {\n      type: \"array\",\n      items: {\n        oneOf: [\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"title\" },\n              text: { type: \"string\" },\n            },\n            required: [\"type\", \"text\"],\n          },\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"heading\" },\n              level: { type: \"integer\", minimum: 1, maximum: 6 },\n              text: { type: \"string\" },\n            },\n            required: [\"type\", \"text\"],\n          },\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"paragraph\" },\n              text: { type: \"string\" },\n              style: { type: \"string\", description: \"Optional paragraph style\" },\n            },\n            required: [\"type\", \"text\"],\n          },\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"bullets\" },\n              items: { type: \"array\", items: { type: \"string\" }, minItems: 1 },\n            },\n            required: [\"type\", \"items\"],\n          },\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"numbered\" },\n              items: { type: \"array\", items: { type: \"string\" }, minItems: 1 },\n            },\n            required: [\"type\", \"items\"],\n          },\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"table\" },\n              columns: { type: \"array\", items: { type: \"string\" }, minItems: 1 },\n              rows: { type: \"array\", items: { type: \"array\" } },\n              style: { type: \"string\", default: \"Table Grid\" },\n              header: { type: \"boolean\", default: true },\n            },\n            required: [\"type\", \"columns\"],\n          },\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"page_break\" },\n            },\n            required: [\"type\"],\n          },\n          {\n            type: \"object\",\n            properties: {\n              type: { const: \"toc\" },\n              max_level: { type: \"integer\", minimum: 1, maximum: 6, default: 3 },\n            },\n            required: [\"type\"],\n          },\n        ],\n      },\n    },\n  },\n  required: [],\n};\n\n// -------------------------\n// CV/Resume specification\n// -------------------------\n\nexport const cvHeaderSchema = z.object({\n  name: z.string().min(1).describe(\"Full name\"),\n  phone: z.string().describe(\"Phone number\"),\n  email: z.string().email().describe(\"Email address\"),\n  address: z.string().describe(\"Physical address or city/country\"),\n  website: z.string().url().nullable().optional().describe(\"Personal website or portfolio URL\"),\n  photo_url: z.string().url().nullable().optional().describe(\"Profile photo URL\"),\n});\n\nexport type CvHeader = z.infer<typeof cvHeaderSchema>;\n\nexport const cvWorkExperienceSchema = z.object({\n  company: z.string().min(1),\n  role: z.string().min(1),\n  start_date: z.string().describe(\"Start date, e.g. 'Jan 2020' or '2020-01'\"),\n  end_date: z.string().nullable().optional().describe(\"End date or null/undefined for 'Present'\"),\n  location: z.string().nullable().optional().describe(\"City, Country\"),\n  description: z.string().nullable().optional().describe(\"Role description\"),\n  achievements: z.array(z.string()).default([]).describe(\"List of key achievements\"),\n});\n\nexport type CvWorkExperience = z.infer<typeof cvWorkExperienceSchema>;\n\nexport const cvEducationSchema = z.object({\n  institution: z.string().min(1),\n  degree: z.string().min(1).describe(\"e.g. 'Bachelor of Science'\"),\n  field: z.string().min(1).describe(\"e.g. 'Computer Science'\"),\n  start_date: z.string().describe(\"Start date\"),\n  end_date: z.string().nullable().optional().describe(\"End date or expected graduation\"),\n  gpa: z.string().nullable().optional().describe(\"GPA or grade, e.g. '3.8/4.0'\"),\n  achievements: z.array(z.string()).default([]).describe(\"Honors, awards, relevant coursework\"),\n});\n\nexport type CvEducation = z.infer<typeof cvEducationSchema>;\n\nexport const cvSkillSchema = z.object({\n  name: z.string().min(1).describe(\"Skill name\"),\n  proficiency: z.number().int().min(1).max(5).describe(\"Proficiency level 1-5\"),\n});\n\nexport type CvSkill = z.infer<typeof cvSkillSchema>;\n\nexport const cvSkillCategorySchema = z.object({\n  name: z.string().min(1).describe(\"Category name, e.g. 'Programming Languages'\"),\n  skills: z.array(cvSkillSchema).min(1),\n});\n\nexport type CvSkillCategory = z.infer<typeof cvSkillCategorySchema>;\n\nexport const cvLanguageSchema = z.object({\n  name: z.string().min(1).describe(\"Language name\"),\n  proficiency: z.number().int().min(1).max(5).describe(\"Proficiency level 1-5 (1=Basic, 5=Native)\"),\n});\n\nexport type CvLanguage = z.infer<typeof cvLanguageSchema>;\n\nexport const cvCertificationSchema = z.object({\n  name: z.string().min(1),\n  issuer: z.string().min(1).describe(\"Issuing organization\"),\n  date: z.string().describe(\"Date obtained\"),\n  url: z.string().url().nullable().optional().describe(\"Verification URL\"),\n});\n\nexport type CvCertification = z.infer<typeof cvCertificationSchema>;\n\nexport const cvProjectSchema = z.object({\n  name: z.string().min(1),\n  description: z.string().describe(\"Project description\"),\n  technologies: z.array(z.string()).default([]).describe(\"Technologies used\"),\n  url: z.string().url().nullable().optional().describe(\"Project URL\"),\n});\n\nexport type CvProject = z.infer<typeof cvProjectSchema>;\n\nexport const cvColorSchemeSchema = z.object({\n  primary: z.string().default(\"#1a1a1a\").describe(\"Primary color hex\"),\n  accent: z.string().default(\"#2563eb\").describe(\"Accent color hex\"),\n});\n\nexport type CvColorScheme = z.infer<typeof cvColorSchemeSchema>;\n\nexport const cvSpecSchema = z.object({\n  header: cvHeaderSchema,\n  profile_summary: z.string().nullable().optional().describe(\"Professional summary or objective\"),\n  work_experience: z.array(cvWorkExperienceSchema).default([]),\n  education: z.array(cvEducationSchema).default([]),\n  skills: z.array(cvSkillCategorySchema).default([]),\n  languages: z.array(cvLanguageSchema).default([]),\n  certifications: z.array(cvCertificationSchema).default([]),\n  projects: z.array(cvProjectSchema).default([]),\n  template_style: z.enum([\"modern\", \"classic\", \"creative\", \"minimalist\"]).default(\"modern\"),\n  color_scheme: cvColorSchemeSchema.default({}),\n});\n\nexport type CvSpec = z.infer<typeof cvSpecSchema>;\n\n// -------------------------\n// Report specification\n// -------------------------\n\nexport const reportHeaderSchema = z.object({\n  title: z.string().min(1),\n  subtitle: z.string().nullable().optional(),\n  author: z.string().nullable().optional(),\n  date: z.string().nullable().optional().describe(\"Report date\"),\n  organization: z.string().nullable().optional(),\n  logo_url: z.string().url().nullable().optional().describe(\"Organization logo URL\"),\n});\n\nexport type ReportHeader = z.infer<typeof reportHeaderSchema>;\n\nexport const reportTextBlockSchema = z.object({\n  type: z.literal(\"text\"),\n  content: z.string(),\n});\n\nexport const reportHeadingBlockSchema = z.object({\n  type: z.literal(\"heading\"),\n  level: z.number().int().min(1).max(4).default(2),\n  text: z.string(),\n});\n\nexport const reportBulletsBlockSchema = z.object({\n  type: z.literal(\"bullets\"),\n  items: z.array(z.string()).min(1),\n});\n\nexport const reportNumberedBlockSchema = z.object({\n  type: z.literal(\"numbered\"),\n  items: z.array(z.string()).min(1),\n});\n\nexport const reportTableBlockSchema = z.object({\n  type: z.literal(\"table\"),\n  columns: z.array(z.string()).min(1),\n  rows: z.array(z.array(z.any())).default([]),\n  caption: z.string().nullable().optional(),\n});\n\nexport const reportImageBlockSchema = z.object({\n  type: z.literal(\"image\"),\n  url: z.string().url(),\n  alt: z.string().nullable().optional(),\n  caption: z.string().nullable().optional(),\n  width: z.number().nullable().optional().describe(\"Width in pixels or percentage\"),\n});\n\nexport const reportChartBlockSchema = z.object({\n  type: z.literal(\"chart\"),\n  chart_type: z.enum([\"bar\", \"line\", \"pie\", \"area\"]).default(\"bar\"),\n  title: z.string().nullable().optional(),\n  data: z.object({\n    labels: z.array(z.string()),\n    values: z.array(z.number()),\n  }),\n});\n\nexport const reportQuoteBlockSchema = z.object({\n  type: z.literal(\"quote\"),\n  text: z.string(),\n  attribution: z.string().nullable().optional(),\n});\n\nexport const reportContentBlockSchema = z.discriminatedUnion(\"type\", [\n  reportTextBlockSchema,\n  reportHeadingBlockSchema,\n  reportBulletsBlockSchema,\n  reportNumberedBlockSchema,\n  reportTableBlockSchema,\n  reportImageBlockSchema,\n  reportChartBlockSchema,\n  reportQuoteBlockSchema,\n]);\n\nexport type ReportContentBlock = z.infer<typeof reportContentBlockSchema>;\n\nexport const reportSectionSchema = z.object({\n  title: z.string().min(1),\n  content: z.array(reportContentBlockSchema).default([]),\n});\n\nexport type ReportSection = z.infer<typeof reportSectionSchema>;\n\nexport const reportSpecSchema = z.object({\n  header: reportHeaderSchema,\n  executive_summary: z.string().nullable().optional().describe(\"Executive summary paragraph\"),\n  sections: z.array(reportSectionSchema).default([]),\n  show_toc: z.boolean().default(false).describe(\"Show table of contents\"),\n  show_page_numbers: z.boolean().default(true),\n  template_style: z.enum([\"corporate\", \"academic\", \"modern\", \"minimal\"]).default(\"corporate\"),\n});\n\nexport type ReportSpec = z.infer<typeof reportSpecSchema>;\n\n// -------------------------\n// Letter specification\n// -------------------------\n\nexport const letterSenderSchema = z.object({\n  name: z.string().min(1),\n  address: z.string().describe(\"Full address with line breaks or comma-separated\"),\n  phone: z.string().nullable().optional(),\n  email: z.string().email().nullable().optional(),\n});\n\nexport type LetterSender = z.infer<typeof letterSenderSchema>;\n\nexport const letterRecipientSchema = z.object({\n  name: z.string().min(1),\n  title: z.string().nullable().optional().describe(\"Job title\"),\n  organization: z.string().nullable().optional(),\n  address: z.string().describe(\"Full address\"),\n});\n\nexport type LetterRecipient = z.infer<typeof letterRecipientSchema>;\n\nexport const letterSpecSchema = z.object({\n  sender: letterSenderSchema,\n  recipient: letterRecipientSchema,\n  date: z.string().describe(\"Letter date\"),\n  subject: z.string().nullable().optional().describe(\"Subject line (optional for some letter types)\"),\n  salutation: z.string().default(\"Dear\").describe(\"Greeting, e.g. 'Dear Mr. Smith'\"),\n  body_paragraphs: z.array(z.string()).min(1).describe(\"Body paragraphs of the letter\"),\n  closing: z.string().default(\"Sincerely\").describe(\"Closing phrase, e.g. 'Sincerely', 'Best regards'\"),\n  signature_name: z.string().describe(\"Name to appear in signature\"),\n  template_style: z.enum([\"formal\", \"business\", \"personal\", \"modern\"]).default(\"formal\"),\n});\n\nexport type LetterSpec = z.infer<typeof letterSpecSchema>;\n\n// -------------------------\n// JSON Schema exports for LLM prompts\n// -------------------------\n\nexport const cvSpecJsonSchema = {\n  type: \"object\",\n  properties: {\n    header: {\n      type: \"object\",\n      properties: {\n        name: { type: \"string\", description: \"Full name\" },\n        phone: { type: \"string\", description: \"Phone number\" },\n        email: { type: \"string\", format: \"email\", description: \"Email address\" },\n        address: { type: \"string\", description: \"Physical address or city/country\" },\n        website: { type: \"string\", format: \"uri\", nullable: true, description: \"Personal website or portfolio URL\" },\n        photo_url: { type: \"string\", format: \"uri\", nullable: true, description: \"Profile photo URL\" },\n      },\n      required: [\"name\", \"phone\", \"email\", \"address\"],\n    },\n    profile_summary: { type: \"string\", nullable: true, description: \"Professional summary or objective\" },\n    work_experience: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        properties: {\n          company: { type: \"string\" },\n          role: { type: \"string\" },\n          start_date: { type: \"string\", description: \"e.g. 'Jan 2020'\" },\n          end_date: { type: \"string\", nullable: true, description: \"End date or null for 'Present'\" },\n          location: { type: \"string\", nullable: true },\n          description: { type: \"string\", nullable: true },\n          achievements: { type: \"array\", items: { type: \"string\" } },\n        },\n        required: [\"company\", \"role\", \"start_date\"],\n      },\n    },\n    education: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        properties: {\n          institution: { type: \"string\" },\n          degree: { type: \"string\" },\n          field: { type: \"string\" },\n          start_date: { type: \"string\" },\n          end_date: { type: \"string\", nullable: true },\n          gpa: { type: \"string\", nullable: true },\n          achievements: { type: \"array\", items: { type: \"string\" } },\n        },\n        required: [\"institution\", \"degree\", \"field\", \"start_date\"],\n      },\n    },\n    skills: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        properties: {\n          name: { type: \"string\", description: \"Category name\" },\n          skills: {\n            type: \"array\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\" },\n                proficiency: { type: \"integer\", minimum: 1, maximum: 5 },\n              },\n              required: [\"name\", \"proficiency\"],\n            },\n          },\n        },\n        required: [\"name\", \"skills\"],\n      },\n    },\n    languages: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        properties: {\n          name: { type: \"string\" },\n          proficiency: { type: \"integer\", minimum: 1, maximum: 5, description: \"1=Basic, 5=Native\" },\n        },\n        required: [\"name\", \"proficiency\"],\n      },\n    },\n    certifications: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        properties: {\n          name: { type: \"string\" },\n          issuer: { type: \"string\" },\n          date: { type: \"string\" },\n          url: { type: \"string\", format: \"uri\", nullable: true },\n        },\n        required: [\"name\", \"issuer\", \"date\"],\n      },\n    },\n    projects: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        properties: {\n          name: { type: \"string\" },\n          description: { type: \"string\" },\n          technologies: { type: \"array\", items: { type: \"string\" } },\n          url: { type: \"string\", format: \"uri\", nullable: true },\n        },\n        required: [\"name\", \"description\"],\n      },\n    },\n    template_style: { type: \"string\", enum: [\"modern\", \"classic\", \"creative\", \"minimalist\"], default: \"modern\" },\n    color_scheme: {\n      type: \"object\",\n      properties: {\n        primary: { type: \"string\", default: \"#1a1a1a\", description: \"Primary color hex\" },\n        accent: { type: \"string\", default: \"#2563eb\", description: \"Accent color hex\" },\n      },\n    },\n  },\n  required: [\"header\"],\n};\n\nexport const reportSpecJsonSchema = {\n  type: \"object\",\n  properties: {\n    header: {\n      type: \"object\",\n      properties: {\n        title: { type: \"string\" },\n        subtitle: { type: \"string\", nullable: true },\n        author: { type: \"string\", nullable: true },\n        date: { type: \"string\", nullable: true },\n        organization: { type: \"string\", nullable: true },\n        logo_url: { type: \"string\", format: \"uri\", nullable: true },\n      },\n      required: [\"title\"],\n    },\n    executive_summary: { type: \"string\", nullable: true, description: \"Executive summary paragraph\" },\n    sections: {\n      type: \"array\",\n      items: {\n        type: \"object\",\n        properties: {\n          title: { type: \"string\" },\n          content: {\n            type: \"array\",\n            items: {\n              oneOf: [\n                {\n                  type: \"object\",\n                  properties: { type: { const: \"text\" }, content: { type: \"string\" } },\n                  required: [\"type\", \"content\"],\n                },\n                {\n                  type: \"object\",\n                  properties: { type: { const: \"heading\" }, level: { type: \"integer\", minimum: 1, maximum: 4 }, text: { type: \"string\" } },\n                  required: [\"type\", \"text\"],\n                },\n                {\n                  type: \"object\",\n                  properties: { type: { const: \"bullets\" }, items: { type: \"array\", items: { type: \"string\" } } },\n                  required: [\"type\", \"items\"],\n                },\n                {\n                  type: \"object\",\n                  properties: { type: { const: \"numbered\" }, items: { type: \"array\", items: { type: \"string\" } } },\n                  required: [\"type\", \"items\"],\n                },\n                {\n                  type: \"object\",\n                  properties: {\n                    type: { const: \"table\" },\n                    columns: { type: \"array\", items: { type: \"string\" } },\n                    rows: { type: \"array\", items: { type: \"array\" } },\n                    caption: { type: \"string\", nullable: true },\n                  },\n                  required: [\"type\", \"columns\"],\n                },\n                {\n                  type: \"object\",\n                  properties: {\n                    type: { const: \"image\" },\n                    url: { type: \"string\", format: \"uri\" },\n                    alt: { type: \"string\", nullable: true },\n                    caption: { type: \"string\", nullable: true },\n                    width: { type: \"number\", nullable: true },\n                  },\n                  required: [\"type\", \"url\"],\n                },\n                {\n                  type: \"object\",\n                  properties: {\n                    type: { const: \"chart\" },\n                    chart_type: { type: \"string\", enum: [\"bar\", \"line\", \"pie\", \"area\"] },\n                    title: { type: \"string\", nullable: true },\n                    data: {\n                      type: \"object\",\n                      properties: {\n                        labels: { type: \"array\", items: { type: \"string\" } },\n                        values: { type: \"array\", items: { type: \"number\" } },\n                      },\n                      required: [\"labels\", \"values\"],\n                    },\n                  },\n                  required: [\"type\", \"data\"],\n                },\n                {\n                  type: \"object\",\n                  properties: {\n                    type: { const: \"quote\" },\n                    text: { type: \"string\" },\n                    attribution: { type: \"string\", nullable: true },\n                  },\n                  required: [\"type\", \"text\"],\n                },\n              ],\n            },\n          },\n        },\n        required: [\"title\"],\n      },\n    },\n    show_toc: { type: \"boolean\", default: false, description: \"Show table of contents\" },\n    show_page_numbers: { type: \"boolean\", default: true },\n    template_style: { type: \"string\", enum: [\"corporate\", \"academic\", \"modern\", \"minimal\"], default: \"corporate\" },\n  },\n  required: [\"header\"],\n};\n\nexport const letterSpecJsonSchema = {\n  type: \"object\",\n  properties: {\n    sender: {\n      type: \"object\",\n      properties: {\n        name: { type: \"string\" },\n        address: { type: \"string\", description: \"Full address\" },\n        phone: { type: \"string\", nullable: true },\n        email: { type: \"string\", format: \"email\", nullable: true },\n      },\n      required: [\"name\", \"address\"],\n    },\n    recipient: {\n      type: \"object\",\n      properties: {\n        name: { type: \"string\" },\n        title: { type: \"string\", nullable: true, description: \"Job title\" },\n        organization: { type: \"string\", nullable: true },\n        address: { type: \"string\" },\n      },\n      required: [\"name\", \"address\"],\n    },\n    date: { type: \"string\", description: \"Letter date\" },\n    subject: { type: \"string\", nullable: true, description: \"Subject line\" },\n    salutation: { type: \"string\", default: \"Dear\", description: \"Greeting\" },\n    body_paragraphs: { type: \"array\", items: { type: \"string\" }, minItems: 1, description: \"Body paragraphs\" },\n    closing: { type: \"string\", default: \"Sincerely\", description: \"Closing phrase\" },\n    signature_name: { type: \"string\", description: \"Name in signature\" },\n    template_style: { type: \"string\", enum: [\"formal\", \"business\", \"personal\", \"modern\"], default: \"formal\" },\n  },\n  required: [\"sender\", \"recipient\", \"date\", \"body_paragraphs\", \"signature_name\"],\n};\n","path":null,"size_bytes":29198,"size_tokens":null},"attached_assets/app_1766283299495.py":{"content":"from __future__ import annotations\nimport os, uuid, logging\nfrom typing import Any, Dict\nfrom fastapi import FastAPI, Request\nfrom fastapi.responses import JSONResponse, Response\n\nfrom ..logging import setup_logging\nfrom ..schemas.excel import ExcelSpec\nfrom ..schemas.word import DocSpec\nfrom ..renderers.excel import render_excel_bytes\nfrom ..renderers.word import render_word_bytes\nfrom ..validators.excel import validate_xlsx_bytes\nfrom ..validators.word import validate_docx_bytes\nfrom ..quality.rules_excel import run_quality_gates_excel\nfrom ..quality.rules_word import run_quality_gates_word\nfrom ..llm.dummy import DummyLLM\nfrom ..llm.openai_compat import OpenAICompatibleChatLLM\nfrom ..orchestrator.agent import generate_excel_spec, generate_word_spec\nfrom ..config import get_settings\n\nsetup_logging()\nlog = logging.getLogger(\"office_agent.api\")\n\ns = get_settings()\napp = FastAPI(title=s.api_title, version=s.api_version)\n\n@app.middleware(\"http\")\nasync def request_id(request: Request, call_next):\n    rid = request.headers.get(\"x-request-id\") or str(uuid.uuid4())\n    request.state.request_id = rid\n    resp = await call_next(request)\n    resp.headers[\"x-request-id\"] = rid\n    return resp\n\n@app.get(\"/health\")\ndef health() -> Dict[str,str]:\n    return {\"status\":\"ok\"}\n\ndef _llm_from_env():\n    provider = os.getenv(\"OFFICE_AGENT_LLM_PROVIDER\",\"dummy\").lower()\n    if provider in (\"oa\",\"openai_compat\",\"openai-compatible\"):\n        return OpenAICompatibleChatLLM.from_env()\n    return DummyLLM()\n\n@app.post(\"/v1/render/excel\")\nasync def render_excel(spec: ExcelSpec) -> Response:\n    q = run_quality_gates_excel(spec)\n    if q.errors:\n        return JSONResponse(status_code=422, content={\"error\":\"quality_gate\",\"report\": q.to_dict()})\n    data = render_excel_bytes(spec)\n    validate_xlsx_bytes(data)\n    return Response(content=data, media_type=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n                    headers={\"Content-Disposition\": 'attachment; filename=\"document.xlsx\"'})\n\n@app.post(\"/v1/render/word\")\nasync def render_word(spec: DocSpec) -> Response:\n    q = run_quality_gates_word(spec)\n    if q.errors:\n        return JSONResponse(status_code=422, content={\"error\":\"quality_gate\",\"report\": q.to_dict()})\n    data = render_word_bytes(spec)\n    validate_docx_bytes(data)\n    return Response(content=data, media_type=\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n                    headers={\"Content-Disposition\": 'attachment; filename=\"document.docx\"'})\n\n@app.post(\"/v1/generate/excel\")\nasync def generate_excel(payload: Dict[str, Any]) -> Response:\n    prompt = str(payload.get(\"prompt\",\"\")).strip()\n    if not prompt:\n        return JSONResponse(status_code=422, content={\"error\":\"missing_prompt\"})\n    llm = _llm_from_env()\n    spec, _ = generate_excel_spec(prompt, llm)\n    data = render_excel_bytes(spec); validate_xlsx_bytes(data)\n    return Response(content=data, media_type=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n                    headers={\"Content-Disposition\": 'attachment; filename=\"generated.xlsx\"'})\n\n@app.post(\"/v1/generate/word\")\nasync def generate_word(payload: Dict[str, Any]) -> Response:\n    prompt = str(payload.get(\"prompt\",\"\")).strip()\n    if not prompt:\n        return JSONResponse(status_code=422, content={\"error\":\"missing_prompt\"})\n    llm = _llm_from_env()\n    spec, _ = generate_word_spec(prompt, llm)\n    data = render_word_bytes(spec); validate_docx_bytes(data)\n    return Response(content=data, media_type=\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n                    headers={\"Content-Disposition\": 'attachment; filename=\"generated.docx\"'})\n","path":null,"size_bytes":3718,"size_tokens":null},"server/services/documentOrchestrator.ts":{"content":"import { geminiClient, GEMINI_MODELS } from \"../lib/gemini\";\nimport { \n  validateExcelSpec, \n  validateDocSpec,\n  validateGeneratedExcelBuffer,\n  validateGeneratedWordBuffer,\n  type PostRenderValidationResult,\n} from \"./documentValidators\";\nimport {\n  validateExcelSpec as qualityGateExcelSpec,\n  validateDocSpec as qualityGateDocSpec,\n  type QualityReport,\n} from \"./documentQualityGates\";\nimport { renderExcelFromSpec } from \"./excelSpecRenderer\";\nimport { renderWordFromSpec } from \"./wordSpecRenderer\";\nimport { renderCvFromSpec } from \"./cvRenderer\";\nimport { selectCvTemplate } from \"./documentMappingService\";\nimport {\n  getDocumentSystemPrompt,\n  getDocumentJsonSchema,\n} from \"./documentPrompts\";\nimport {\n  ExcelSpec,\n  DocSpec,\n  CvSpec,\n  ReportSpec,\n  LetterSpec,\n  excelSpecJsonSchema,\n  docSpecJsonSchema,\n  cvSpecSchema,\n  reportSpecSchema,\n  letterSpecSchema,\n  cvSpecJsonSchema,\n  reportSpecJsonSchema,\n  letterSpecJsonSchema,\n} from \"../../shared/documentSpecs\";\n\nconst MAX_RETRIES = 3;\n\nconst REPAIR_SYSTEM_PROMPT = `You are a JSON repair specialist. Fix validation errors in the provided JSON.\n\nCRITICAL INSTRUCTIONS:\n- Analyze each validation error carefully\n- Fix ONLY the specific issues mentioned\n- Preserve all valid parts unchanged\n- Return ONLY valid JSON, no markdown, no explanations`;\n\nexport interface RepairLoopResult<T> {\n  ok: boolean;\n  iterations: number;\n  errors: string[];\n  finalSpec: T | null;\n}\n\nexport interface GenerationResult<T> {\n  buffer: Buffer;\n  spec: T;\n  qualityReport: QualityReport;\n  postRenderValidation: PostRenderValidationResult;\n  attemptsUsed: number;\n  repairLoop: RepairLoopResult<T>;\n}\n\nfunction buildRepairPrompt(\n  originalPrompt: string,\n  lastBadJson: string,\n  errors: string[],\n  schemaContext: string,\n  docType: \"excel\" | \"word\"\n): string {\n  const specificRules = docType === \"excel\"\n    ? `EXCEL-SPECIFIC REPAIR RULES:\n- Range format must be A1:B10 (start:end), not A1-B10\n- Each table row array length MUST equal headers array length\n- Chart ranges (categories_range, values_range) must match table data extent\n- Anchor cell uses A1 notation (column letters + row number)`\n    : `WORD-SPECIFIC REPAIR RULES:\n- blocks is an array of objects with \"type\" field\n- Valid block types: heading, paragraph, bullets, numbered, table, title, toc, page_break\n- Each table row array length MUST equal columns array length\n- Heading level must be 1-6`;\n\n  return `${schemaContext}\n\n${specificRules}\n\n=== REPAIR REQUEST ===\n\nORIGINAL USER REQUEST:\n${originalPrompt}\n\nYOUR PREVIOUS (INVALID) RESPONSE:\n\\`\\`\\`json\n${lastBadJson}\n\\`\\`\\`\n\nVALIDATION ERRORS (fix each one):\n${errors.map((e, i) => `${i + 1}. ${e}`).join('\\n')}\n\nREQUIRED ACTIONS:\n1. Fix each validation error listed above\n2. Preserve all valid content unchanged\n3. Return ONLY the corrected JSON, no markdown, no explanations\n\nRespond with the fixed JSON now:`;\n}\n\nconst EXCEL_SYSTEM_PROMPT = `You are a JSON generator that creates Excel workbook specifications.\n\nCRITICAL VALIDATION RULES (MUST FOLLOW):\n1. Each table row array length MUST equal headers array length exactly\n2. Chart ranges must use A1:B10 format (start:end) NOT A1-B10\n3. Range consistency: categories_range and values_range must reference cells within table data extent\n   - If table anchor is A1 with 3 headers and 5 rows, data is A2:C6 (row 2-6 for data, columns A-C)\n4. Sheet names: 1-31 chars, no special characters: \\\\ / : * ? [ ]\n\nRICH TEXT FORMATTING (IMPORTANT):\nUse these formatting conventions in cell content - they will be rendered with native Excel styles:\n- **bold text** for bold (double asterisks)\n- *italic text* for italics (single asterisks)\n- \\`code\\` for inline code (backticks)\n- [link text](url) for hyperlinks\n- $LaTeX$ for math formulas (will be rendered with formatting)\n\nMATH FORMULAS - Use LaTeX syntax:\n- Fractions: $\\\\frac{a}{b}$\n- Exponents: $x^2$, $x^{n+1}$\n- Subscripts: $x_1$, $a_{ij}$\n- Greek letters: $\\\\alpha$, $\\\\beta$, $\\\\pi$\n\nYou MUST respond with ONLY valid JSON that conforms to this schema:\n${JSON.stringify(excelSpecJsonSchema, null, 2)}\n\nExample valid response (note how ranges match data):\n{\n  \"workbook_title\": \"Sales Report\",\n  \"sheets\": [\n    {\n      \"name\": \"Data\",\n      \"tables\": [\n        {\n          \"anchor\": \"A1\",\n          \"headers\": [\"Product\", \"Sales\", \"Revenue\"],\n          \"rows\": [\n            [\"Widget A\", 100, 5000],\n            [\"Widget B\", 150, 7500]\n          ],\n          \"table_style\": \"TableStyleMedium9\",\n          \"autofilter\": true,\n          \"freeze_header\": true\n        }\n      ],\n      \"charts\": [\n        {\n          \"type\": \"bar\",\n          \"title\": \"Sales by Product\",\n          \"categories_range\": \"A2:A3\",\n          \"values_range\": \"B2:B3\",\n          \"position\": \"E2\"\n        }\n      ]\n    }\n  ]\n}\n\nRespond with ONLY the JSON, no markdown, no explanations.`;\n\nconst DOC_SYSTEM_PROMPT = `You are a JSON generator that creates Word document specifications.\n\nCRITICAL VALIDATION RULES (MUST FOLLOW):\n1. blocks is an array of objects, each with a \"type\" field\n2. Valid block types: heading, paragraph, bullets, numbered, table, title, toc, page_break\n3. Each table row array length MUST equal columns array length exactly\n4. Heading level must be integer 1-6\n5. bullets and numbered blocks require non-empty \"items\" array\n\nRICH TEXT FORMATTING (IMPORTANT):\nUse these formatting conventions in text content - they will be rendered as native Office styles:\n- **bold text** for bold (double asterisks)\n- *italic text* for italics (single asterisks)\n- \\`code\\` for inline code (backticks)\n- [link text](url) for hyperlinks\n- $LaTeX$ for inline math formulas (single dollar signs)\n- $$LaTeX$$ for block math formulas (double dollar signs)\n\nMATH FORMULAS - Use LaTeX syntax:\n- Fractions: $\\\\frac{a}{b}$\n- Exponents: $x^2$, $x^{n+1}$\n- Subscripts: $x_1$, $a_{ij}$\n- Square roots: $\\\\sqrt{x}$, $\\\\sqrt[n]{x}$\n- Greek letters: $\\\\alpha$, $\\\\beta$, $\\\\pi$\n- Sums/integrals: $\\\\sum_{i=1}^{n}$, $\\\\int_{a}^{b}$\n- Derivatives: $\\\\frac{d}{dx}$, $f'(x)$\n\nYou MUST respond with ONLY valid JSON that conforms to this schema:\n${JSON.stringify(docSpecJsonSchema, null, 2)}\n\nExample valid response with rich text and math:\n{\n  \"title\": \"Math Exercise\",\n  \"author\": \"Teacher\",\n  \"blocks\": [\n    { \"type\": \"title\", \"text\": \"Calculus Exercise\" },\n    { \"type\": \"heading\", \"level\": 1, \"text\": \"Derivatives\" },\n    { \"type\": \"paragraph\", \"text\": \"Calculate the derivative of $f(x) = x^3 + 2x^2 - 5x + 1$\" },\n    { \"type\": \"paragraph\", \"text\": \"**Solution:** Using the power rule $\\\\frac{d}{dx}[x^n] = nx^{n-1}$:\" },\n    { \"type\": \"paragraph\", \"text\": \"$$f'(x) = 3x^2 + 4x - 5$$\" },\n    { \"type\": \"bullets\", \"items\": [\"The *derivative* of $x^3$ is $3x^2$\", \"The derivative of $2x^2$ is $4x$\"] },\n    {\n      \"type\": \"table\",\n      \"columns\": [\"Function\", \"Derivative\"],\n      \"rows\": [\n        [\"$x^3$\", \"$3x^2$\"],\n        [\"$2x^2$\", \"$4x$\"],\n        [\"$-5x$\", \"$-5$\"]\n      ]\n    }\n  ]\n}\n\nRespond with ONLY the JSON, no markdown, no explanations.`;\n\nexport async function callGeminiForSpec(\n  systemPrompt: string,\n  userPrompt: string\n): Promise<string> {\n  const result = await geminiClient.models.generateContent({\n    model: GEMINI_MODELS.FLASH,\n    contents: [\n      {\n        role: \"user\",\n        parts: [{ text: userPrompt }],\n      },\n    ],\n    config: {\n      systemInstruction: systemPrompt,\n      temperature: 0.2,\n      maxOutputTokens: 8192,\n    },\n  });\n\n  return result.text ?? \"\";\n}\n\nfunction extractJsonFromResponse(response: string): string {\n  let cleaned = response.trim();\n  \n  if (cleaned.startsWith(\"```json\")) {\n    cleaned = cleaned.slice(7);\n  } else if (cleaned.startsWith(\"```\")) {\n    cleaned = cleaned.slice(3);\n  }\n  \n  if (cleaned.endsWith(\"```\")) {\n    cleaned = cleaned.slice(0, -3);\n  }\n  \n  return cleaned.trim();\n}\n\nexport async function generateExcelFromPrompt(\n  prompt: string\n): Promise<GenerationResult<ExcelSpec>> {\n  let lastErrors: string[] = [];\n  let lastBadJson: string = \"\";\n  let lastQualityReport: QualityReport | null = null;\n  const allAttemptErrors: string[][] = [];\n\n  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n    console.log(`[DocumentOrchestrator] Excel generation attempt ${attempt}/${MAX_RETRIES}`);\n\n    let systemPrompt: string;\n    let userPrompt: string;\n\n    if (attempt === 1 || lastErrors.length === 0) {\n      systemPrompt = EXCEL_SYSTEM_PROMPT;\n      userPrompt = prompt;\n    } else {\n      systemPrompt = REPAIR_SYSTEM_PROMPT;\n      userPrompt = buildRepairPrompt(\n        prompt,\n        lastBadJson,\n        lastErrors,\n        `SCHEMA REFERENCE:\\n${JSON.stringify(excelSpecJsonSchema, null, 2)}`,\n        \"excel\"\n      );\n    }\n\n    const response = await callGeminiForSpec(systemPrompt, userPrompt);\n    const jsonStr = extractJsonFromResponse(response);\n    lastBadJson = jsonStr;\n\n    let parsed: unknown;\n    try {\n      parsed = JSON.parse(jsonStr);\n    } catch (parseError) {\n      lastErrors = [`JSON parse error: ${(parseError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] JSON parse failed:`, lastErrors[0]);\n      continue;\n    }\n\n    // Basic schema validation\n    const schemaValidation = validateExcelSpec(parsed);\n    if (!schemaValidation.valid) {\n      lastErrors = schemaValidation.errors;\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Schema validation failed:`, schemaValidation.errors);\n      continue;\n    }\n\n    const spec = parsed as ExcelSpec;\n\n    // Run quality gate validation (DoS protection, limits, best practices)\n    const qualityReport = qualityGateExcelSpec(spec);\n    lastQualityReport = qualityReport;\n    \n    if (!qualityReport.valid) {\n      const errorMessages = qualityReport.errors.map(e => `[${e.code}] ${e.message} at ${e.path}`);\n      lastErrors = errorMessages;\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Quality gate failed:`, errorMessages);\n      continue;\n    }\n\n    // Log warnings but continue\n    if (qualityReport.warnings.length > 0) {\n      console.warn(`[DocumentOrchestrator] Quality warnings:`, qualityReport.warnings);\n    }\n    \n    try {\n      const buffer = await renderExcelFromSpec(spec);\n      \n      // Post-render validation - verify the generated buffer is valid\n      const postRenderValidation = await validateGeneratedExcelBuffer(buffer);\n      if (!postRenderValidation.valid) {\n        lastErrors = postRenderValidation.errors;\n        allAttemptErrors.push([...lastErrors]);\n        console.error(`[DocumentOrchestrator] Post-render validation failed:`, postRenderValidation.errors);\n        continue;\n      }\n      \n      console.log(`[DocumentOrchestrator] Excel generated successfully on attempt ${attempt}`);\n      return { \n        buffer, \n        spec, \n        qualityReport,\n        postRenderValidation,\n        attemptsUsed: attempt,\n        repairLoop: {\n          ok: true,\n          iterations: attempt,\n          errors: allAttemptErrors.flat(),\n          finalSpec: spec,\n        },\n      };\n    } catch (renderError) {\n      lastErrors = [`Render error: ${(renderError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Render failed:`, lastErrors[0]);\n      continue;\n    }\n  }\n\n  const allErrors = allAttemptErrors.flat();\n  const error = new Error(\n    `Failed to generate valid Excel spec after ${MAX_RETRIES} attempts. Last errors: ${lastErrors.join(\"; \")}`\n  );\n  (error as any).repairLoopResult = {\n    ok: false,\n    iterations: MAX_RETRIES,\n    errors: allErrors,\n    finalSpec: null,\n  } as RepairLoopResult<ExcelSpec>;\n  throw error;\n}\n\nexport async function generateWordFromPrompt(\n  prompt: string\n): Promise<GenerationResult<DocSpec>> {\n  let lastErrors: string[] = [];\n  let lastBadJson: string = \"\";\n  let lastQualityReport: QualityReport | null = null;\n  const allAttemptErrors: string[][] = [];\n\n  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n    console.log(`[DocumentOrchestrator] Word generation attempt ${attempt}/${MAX_RETRIES}`);\n\n    let systemPrompt: string;\n    let userPrompt: string;\n\n    if (attempt === 1 || lastErrors.length === 0) {\n      systemPrompt = DOC_SYSTEM_PROMPT;\n      userPrompt = prompt;\n    } else {\n      systemPrompt = REPAIR_SYSTEM_PROMPT;\n      userPrompt = buildRepairPrompt(\n        prompt,\n        lastBadJson,\n        lastErrors,\n        `SCHEMA REFERENCE:\\n${JSON.stringify(docSpecJsonSchema, null, 2)}`,\n        \"word\"\n      );\n    }\n\n    const response = await callGeminiForSpec(systemPrompt, userPrompt);\n    const jsonStr = extractJsonFromResponse(response);\n    lastBadJson = jsonStr;\n\n    let parsed: unknown;\n    try {\n      parsed = JSON.parse(jsonStr);\n    } catch (parseError) {\n      lastErrors = [`JSON parse error: ${(parseError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] JSON parse failed:`, lastErrors[0]);\n      continue;\n    }\n\n    // Basic schema validation\n    const schemaValidation = validateDocSpec(parsed);\n    if (!schemaValidation.valid) {\n      lastErrors = schemaValidation.errors;\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Schema validation failed:`, schemaValidation.errors);\n      continue;\n    }\n\n    const spec = parsed as DocSpec;\n\n    // Run quality gate validation (DoS protection, limits, best practices)\n    const qualityReport = qualityGateDocSpec(spec);\n    lastQualityReport = qualityReport;\n    \n    if (!qualityReport.valid) {\n      const errorMessages = qualityReport.errors.map(e => `[${e.code}] ${e.message} at ${e.path}`);\n      lastErrors = errorMessages;\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Quality gate failed:`, errorMessages);\n      continue;\n    }\n\n    // Log warnings but continue\n    if (qualityReport.warnings.length > 0) {\n      console.warn(`[DocumentOrchestrator] Quality warnings:`, qualityReport.warnings);\n    }\n    \n    try {\n      const buffer = await renderWordFromSpec(spec);\n      \n      // Post-render validation - verify the generated buffer is valid\n      const postRenderValidation = await validateGeneratedWordBuffer(buffer);\n      if (!postRenderValidation.valid) {\n        lastErrors = postRenderValidation.errors;\n        allAttemptErrors.push([...lastErrors]);\n        console.error(`[DocumentOrchestrator] Post-render validation failed:`, postRenderValidation.errors);\n        continue;\n      }\n      \n      console.log(`[DocumentOrchestrator] Word generated successfully on attempt ${attempt}`);\n      return { \n        buffer, \n        spec, \n        qualityReport,\n        postRenderValidation,\n        attemptsUsed: attempt,\n        repairLoop: {\n          ok: true,\n          iterations: attempt,\n          errors: allAttemptErrors.flat(),\n          finalSpec: spec,\n        },\n      };\n    } catch (renderError) {\n      lastErrors = [`Render error: ${(renderError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Render failed:`, lastErrors[0]);\n      continue;\n    }\n  }\n\n  const allErrors = allAttemptErrors.flat();\n  const error = new Error(\n    `Failed to generate valid Word spec after ${MAX_RETRIES} attempts. Last errors: ${lastErrors.join(\"; \")}`\n  );\n  (error as any).repairLoopResult = {\n    ok: false,\n    iterations: MAX_RETRIES,\n    errors: allErrors,\n    finalSpec: null,\n  } as RepairLoopResult<DocSpec>;\n  throw error;\n}\n\nfunction buildDocumentRepairPrompt(\n  originalPrompt: string,\n  lastBadJson: string,\n  errors: string[],\n  schemaContext: string,\n  docType: \"cv\" | \"report\" | \"letter\"\n): string {\n  const specificRules: Record<string, string> = {\n    cv: `CV-SPECIFIC REPAIR RULES:\n- header object is REQUIRED with name, phone, email, address fields\n- Skill proficiency MUST be integer 1-5\n- Language proficiency MUST be integer 1-5\n- work_experience and education should be in reverse chronological order\n- end_date can be null for current positions`,\n    report: `REPORT-SPECIFIC REPAIR RULES:\n- header object is REQUIRED with at least title field\n- Each table row array length MUST equal columns array length\n- Chart data.labels and data.values arrays must have same length\n- Heading levels are 1-4`,\n    letter: `LETTER-SPECIFIC REPAIR RULES:\n- sender object is REQUIRED with name and address\n- recipient object is REQUIRED with name and address\n- date field is REQUIRED\n- body_paragraphs array is REQUIRED with at least one paragraph\n- signature_name is REQUIRED`,\n  };\n\n  return `${schemaContext}\n\n${specificRules[docType]}\n\n=== REPAIR REQUEST ===\n\nORIGINAL USER REQUEST:\n${originalPrompt}\n\nYOUR PREVIOUS (INVALID) RESPONSE:\n\\`\\`\\`json\n${lastBadJson}\n\\`\\`\\`\n\nVALIDATION ERRORS (fix each one):\n${errors.map((e, i) => `${i + 1}. ${e}`).join('\\n')}\n\nREQUIRED ACTIONS:\n1. Fix each validation error listed above\n2. Preserve all valid content unchanged\n3. Return ONLY the corrected JSON, no markdown, no explanations\n\nRespond with the fixed JSON now:`;\n}\n\nfunction validateCvSpec(spec: unknown): { valid: boolean; errors: string[] } {\n  const result = cvSpecSchema.safeParse(spec);\n  if (result.success) {\n    return { valid: true, errors: [] };\n  }\n  const errors = result.error.issues.map((issue) => {\n    const path = issue.path.join(\".\");\n    return path ? `${path}: ${issue.message}` : issue.message;\n  });\n  return { valid: false, errors };\n}\n\nfunction validateReportSpec(spec: unknown): { valid: boolean; errors: string[] } {\n  const result = reportSpecSchema.safeParse(spec);\n  if (result.success) {\n    return { valid: true, errors: [] };\n  }\n  const errors = result.error.issues.map((issue) => {\n    const path = issue.path.join(\".\");\n    return path ? `${path}: ${issue.message}` : issue.message;\n  });\n  return { valid: false, errors };\n}\n\nfunction validateLetterSpec(spec: unknown): { valid: boolean; errors: string[] } {\n  const result = letterSpecSchema.safeParse(spec);\n  if (result.success) {\n    return { valid: true, errors: [] };\n  }\n  const errors = result.error.issues.map((issue) => {\n    const path = issue.path.join(\".\");\n    return path ? `${path}: ${issue.message}` : issue.message;\n  });\n  return { valid: false, errors };\n}\n\nfunction createDefaultQualityReport(): QualityReport {\n  return {\n    valid: true,\n    errors: [],\n    warnings: [],\n    info: [],\n  };\n}\n\nexport async function generateCvFromPrompt(\n  prompt: string\n): Promise<GenerationResult<CvSpec>> {\n  let lastErrors: string[] = [];\n  let lastBadJson: string = \"\";\n  const allAttemptErrors: string[][] = [];\n\n  const systemPrompt = getDocumentSystemPrompt(\"cv\");\n  const jsonSchema = getDocumentJsonSchema(\"cv\");\n\n  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n    console.log(`[DocumentOrchestrator] CV generation attempt ${attempt}/${MAX_RETRIES}`);\n\n    let currentSystemPrompt: string;\n    let userPrompt: string;\n\n    if (attempt === 1 || lastErrors.length === 0) {\n      currentSystemPrompt = systemPrompt;\n      userPrompt = prompt;\n    } else {\n      currentSystemPrompt = REPAIR_SYSTEM_PROMPT;\n      userPrompt = buildDocumentRepairPrompt(\n        prompt,\n        lastBadJson,\n        lastErrors,\n        `SCHEMA REFERENCE:\\n${JSON.stringify(jsonSchema, null, 2)}`,\n        \"cv\"\n      );\n    }\n\n    const response = await callGeminiForSpec(currentSystemPrompt, userPrompt);\n    const jsonStr = extractJsonFromResponse(response);\n    lastBadJson = jsonStr;\n\n    let parsed: unknown;\n    try {\n      parsed = JSON.parse(jsonStr);\n    } catch (parseError) {\n      lastErrors = [`JSON parse error: ${(parseError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] JSON parse failed:`, lastErrors[0]);\n      continue;\n    }\n\n    const schemaValidation = validateCvSpec(parsed);\n    if (!schemaValidation.valid) {\n      lastErrors = schemaValidation.errors;\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Schema validation failed:`, schemaValidation.errors);\n      continue;\n    }\n\n    const spec = parsed as CvSpec;\n    const templateConfig = selectCvTemplate(spec.template_style || \"modern\");\n    const qualityReport = createDefaultQualityReport();\n\n    try {\n      const buffer = await renderCvFromSpec(spec, templateConfig);\n      \n      const postRenderValidation = await validateGeneratedWordBuffer(buffer);\n      if (!postRenderValidation.valid) {\n        lastErrors = postRenderValidation.errors;\n        allAttemptErrors.push([...lastErrors]);\n        console.error(`[DocumentOrchestrator] Post-render validation failed:`, postRenderValidation.errors);\n        continue;\n      }\n      \n      console.log(`[DocumentOrchestrator] CV generated successfully on attempt ${attempt}`);\n      return { \n        buffer, \n        spec, \n        qualityReport,\n        postRenderValidation,\n        attemptsUsed: attempt,\n        repairLoop: {\n          ok: true,\n          iterations: attempt,\n          errors: allAttemptErrors.flat(),\n          finalSpec: spec,\n        },\n      };\n    } catch (renderError) {\n      lastErrors = [`Render error: ${(renderError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Render failed:`, lastErrors[0]);\n      continue;\n    }\n  }\n\n  const allErrors = allAttemptErrors.flat();\n  const error = new Error(\n    `Failed to generate valid CV spec after ${MAX_RETRIES} attempts. Last errors: ${lastErrors.join(\"; \")}`\n  );\n  (error as any).repairLoopResult = {\n    ok: false,\n    iterations: MAX_RETRIES,\n    errors: allErrors,\n    finalSpec: null,\n  } as RepairLoopResult<CvSpec>;\n  throw error;\n}\n\nexport async function generateReportFromPrompt(\n  prompt: string\n): Promise<GenerationResult<ReportSpec>> {\n  let lastErrors: string[] = [];\n  let lastBadJson: string = \"\";\n  const allAttemptErrors: string[][] = [];\n\n  const systemPrompt = getDocumentSystemPrompt(\"report\");\n  const jsonSchema = getDocumentJsonSchema(\"report\");\n\n  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n    console.log(`[DocumentOrchestrator] Report generation attempt ${attempt}/${MAX_RETRIES}`);\n\n    let currentSystemPrompt: string;\n    let userPrompt: string;\n\n    if (attempt === 1 || lastErrors.length === 0) {\n      currentSystemPrompt = systemPrompt;\n      userPrompt = prompt;\n    } else {\n      currentSystemPrompt = REPAIR_SYSTEM_PROMPT;\n      userPrompt = buildDocumentRepairPrompt(\n        prompt,\n        lastBadJson,\n        lastErrors,\n        `SCHEMA REFERENCE:\\n${JSON.stringify(jsonSchema, null, 2)}`,\n        \"report\"\n      );\n      console.log(`[DocumentOrchestrator] Retry with ${lastErrors.length} error(s) to fix`);\n    }\n\n    const response = await callGeminiForSpec(currentSystemPrompt, userPrompt);\n    const jsonStr = extractJsonFromResponse(response);\n    lastBadJson = jsonStr;\n\n    let parsed: unknown;\n    try {\n      parsed = JSON.parse(jsonStr);\n    } catch (parseError) {\n      lastErrors = [`JSON parse error: ${(parseError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] JSON parse failed:`, lastErrors[0]);\n      continue;\n    }\n\n    const schemaValidation = validateReportSpec(parsed);\n    if (!schemaValidation.valid) {\n      lastErrors = schemaValidation.errors;\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Schema validation failed:`, schemaValidation.errors);\n      continue;\n    }\n\n    const spec = parsed as ReportSpec;\n    const qualityReport = createDefaultQualityReport();\n\n    try {\n      const buffer = await renderWordFromSpec({\n        title: spec.header.title,\n        author: spec.header.author || undefined,\n        styleset: spec.template_style === \"academic\" ? \"classic\" : \"modern\",\n        add_toc: spec.show_toc,\n        blocks: convertReportToDocBlocks(spec),\n      });\n      \n      const postRenderValidation = await validateGeneratedWordBuffer(buffer);\n      if (!postRenderValidation.valid) {\n        lastErrors = postRenderValidation.errors;\n        allAttemptErrors.push([...lastErrors]);\n        console.error(`[DocumentOrchestrator] Post-render validation failed:`, postRenderValidation.errors);\n        continue;\n      }\n      \n      console.log(`[DocumentOrchestrator] Report generated successfully on attempt ${attempt}`);\n      return { \n        buffer, \n        spec, \n        qualityReport,\n        postRenderValidation,\n        attemptsUsed: attempt,\n        repairLoop: {\n          ok: true,\n          iterations: attempt,\n          errors: allAttemptErrors.flat(),\n          finalSpec: spec,\n        },\n      };\n    } catch (renderError) {\n      lastErrors = [`Render error: ${(renderError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Render failed:`, lastErrors[0]);\n      continue;\n    }\n  }\n\n  const allErrors = allAttemptErrors.flat();\n  const error = new Error(\n    `Failed to generate valid Report spec after ${MAX_RETRIES} attempts. Last errors: ${lastErrors.join(\"; \")}`\n  );\n  (error as any).repairLoopResult = {\n    ok: false,\n    iterations: MAX_RETRIES,\n    errors: allErrors,\n    finalSpec: null,\n  } as RepairLoopResult<ReportSpec>;\n  throw error;\n}\n\nfunction convertReportToDocBlocks(spec: ReportSpec): DocSpec[\"blocks\"] {\n  const blocks: DocSpec[\"blocks\"] = [];\n  \n  blocks.push({ type: \"title\", text: spec.header.title });\n  \n  if (spec.executive_summary) {\n    blocks.push({ type: \"heading\", level: 1, text: \"Executive Summary\" });\n    blocks.push({ type: \"paragraph\", text: spec.executive_summary });\n  }\n  \n  for (const section of spec.sections) {\n    blocks.push({ type: \"heading\", level: 1, text: section.title });\n    \n    for (const content of section.content) {\n      switch (content.type) {\n        case \"text\":\n          blocks.push({ type: \"paragraph\", text: content.content });\n          break;\n        case \"heading\":\n          blocks.push({ type: \"heading\", level: Math.min(content.level + 1, 6), text: content.text });\n          break;\n        case \"bullets\":\n          blocks.push({ type: \"bullets\", items: content.items });\n          break;\n        case \"numbered\":\n          blocks.push({ type: \"numbered\", items: content.items });\n          break;\n        case \"table\":\n          blocks.push({\n            type: \"table\",\n            columns: content.columns,\n            rows: content.rows || [],\n            style: \"Table Grid\",\n            header: true,\n          });\n          break;\n        case \"quote\":\n          const quoteText = content.attribution\n            ? `\"${content.text}\" — ${content.attribution}`\n            : `\"${content.text}\"`;\n          blocks.push({ type: \"paragraph\", text: quoteText, style: \"Quote\" });\n          break;\n      }\n    }\n  }\n  \n  return blocks;\n}\n\nexport async function generateLetterFromPrompt(\n  prompt: string\n): Promise<GenerationResult<LetterSpec>> {\n  let lastErrors: string[] = [];\n  let lastBadJson: string = \"\";\n  const allAttemptErrors: string[][] = [];\n\n  const systemPrompt = getDocumentSystemPrompt(\"letter\");\n  const jsonSchema = getDocumentJsonSchema(\"letter\");\n\n  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n    console.log(`[DocumentOrchestrator] Letter generation attempt ${attempt}/${MAX_RETRIES}`);\n\n    let currentSystemPrompt: string;\n    let userPrompt: string;\n\n    if (attempt === 1 || lastErrors.length === 0) {\n      currentSystemPrompt = systemPrompt;\n      userPrompt = prompt;\n    } else {\n      currentSystemPrompt = REPAIR_SYSTEM_PROMPT;\n      userPrompt = buildDocumentRepairPrompt(\n        prompt,\n        lastBadJson,\n        lastErrors,\n        `SCHEMA REFERENCE:\\n${JSON.stringify(jsonSchema, null, 2)}`,\n        \"letter\"\n      );\n      console.log(`[DocumentOrchestrator] Retry with ${lastErrors.length} error(s) to fix`);\n    }\n\n    const response = await callGeminiForSpec(currentSystemPrompt, userPrompt);\n    const jsonStr = extractJsonFromResponse(response);\n    lastBadJson = jsonStr;\n\n    let parsed: unknown;\n    try {\n      parsed = JSON.parse(jsonStr);\n    } catch (parseError) {\n      lastErrors = [`JSON parse error: ${(parseError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] JSON parse failed:`, lastErrors[0]);\n      continue;\n    }\n\n    const schemaValidation = validateLetterSpec(parsed);\n    if (!schemaValidation.valid) {\n      lastErrors = schemaValidation.errors;\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Schema validation failed:`, schemaValidation.errors);\n      continue;\n    }\n\n    const spec = parsed as LetterSpec;\n    const qualityReport = createDefaultQualityReport();\n\n    try {\n      const buffer = await renderWordFromSpec({\n        title: spec.subject || \"Letter\",\n        styleset: spec.template_style === \"formal\" ? \"classic\" : \"modern\",\n        add_toc: false,\n        blocks: convertLetterToDocBlocks(spec),\n      });\n      \n      const postRenderValidation = await validateGeneratedWordBuffer(buffer);\n      if (!postRenderValidation.valid) {\n        lastErrors = postRenderValidation.errors;\n        allAttemptErrors.push([...lastErrors]);\n        console.error(`[DocumentOrchestrator] Post-render validation failed:`, postRenderValidation.errors);\n        continue;\n      }\n      \n      console.log(`[DocumentOrchestrator] Letter generated successfully on attempt ${attempt}`);\n      return { \n        buffer, \n        spec, \n        qualityReport,\n        postRenderValidation,\n        attemptsUsed: attempt,\n        repairLoop: {\n          ok: true,\n          iterations: attempt,\n          errors: allAttemptErrors.flat(),\n          finalSpec: spec,\n        },\n      };\n    } catch (renderError) {\n      lastErrors = [`Render error: ${(renderError as Error).message}`];\n      allAttemptErrors.push([...lastErrors]);\n      console.error(`[DocumentOrchestrator] Render failed:`, lastErrors[0]);\n      continue;\n    }\n  }\n\n  const allErrors = allAttemptErrors.flat();\n  const error = new Error(\n    `Failed to generate valid Letter spec after ${MAX_RETRIES} attempts. Last errors: ${lastErrors.join(\"; \")}`\n  );\n  (error as any).repairLoopResult = {\n    ok: false,\n    iterations: MAX_RETRIES,\n    errors: allErrors,\n    finalSpec: null,\n  } as RepairLoopResult<LetterSpec>;\n  throw error;\n}\n\nfunction convertLetterToDocBlocks(spec: LetterSpec): DocSpec[\"blocks\"] {\n  const blocks: DocSpec[\"blocks\"] = [];\n  \n  const senderAddress = spec.sender.address.split(/[\\n,]/).map(s => s.trim()).filter(Boolean);\n  blocks.push({ type: \"paragraph\", text: spec.sender.name });\n  for (const line of senderAddress) {\n    blocks.push({ type: \"paragraph\", text: line });\n  }\n  if (spec.sender.phone) {\n    blocks.push({ type: \"paragraph\", text: spec.sender.phone });\n  }\n  if (spec.sender.email) {\n    blocks.push({ type: \"paragraph\", text: spec.sender.email });\n  }\n  \n  blocks.push({ type: \"paragraph\", text: \"\" });\n  blocks.push({ type: \"paragraph\", text: spec.date });\n  blocks.push({ type: \"paragraph\", text: \"\" });\n  \n  blocks.push({ type: \"paragraph\", text: spec.recipient.name });\n  if (spec.recipient.title) {\n    blocks.push({ type: \"paragraph\", text: spec.recipient.title });\n  }\n  if (spec.recipient.organization) {\n    blocks.push({ type: \"paragraph\", text: spec.recipient.organization });\n  }\n  const recipientAddress = spec.recipient.address.split(/[\\n,]/).map(s => s.trim()).filter(Boolean);\n  for (const line of recipientAddress) {\n    blocks.push({ type: \"paragraph\", text: line });\n  }\n  \n  blocks.push({ type: \"paragraph\", text: \"\" });\n  \n  if (spec.subject) {\n    blocks.push({ type: \"paragraph\", text: `Re: ${spec.subject}` });\n    blocks.push({ type: \"paragraph\", text: \"\" });\n  }\n  \n  blocks.push({ type: \"paragraph\", text: `${spec.salutation},` });\n  blocks.push({ type: \"paragraph\", text: \"\" });\n  \n  for (const paragraph of spec.body_paragraphs) {\n    blocks.push({ type: \"paragraph\", text: paragraph });\n    blocks.push({ type: \"paragraph\", text: \"\" });\n  }\n  \n  blocks.push({ type: \"paragraph\", text: `${spec.closing},` });\n  blocks.push({ type: \"paragraph\", text: \"\" });\n  blocks.push({ type: \"paragraph\", text: \"\" });\n  blocks.push({ type: \"paragraph\", text: spec.signature_name });\n  \n  return blocks;\n}\n","path":null,"size_bytes":32411,"size_tokens":null},"client/src/components/ribbon/RibbonShell.tsx":{"content":"import { useState, useCallback } from 'react';\nimport type { Editor } from '@tiptap/react';\nimport { cn } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport { Separator } from '@/components/ui/separator';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from '@/components/ui/popover';\nimport {\n  Bold,\n  Italic,\n  Underline,\n  Strikethrough,\n  AlignLeft,\n  AlignCenter,\n  AlignRight,\n  AlignJustify,\n  List,\n  ListOrdered,\n  Undo,\n  Redo,\n  Link,\n  Image,\n  Table,\n  Heading1,\n  Heading2,\n  Heading3,\n  Quote,\n  Code,\n  Minus,\n  Palette,\n  Highlighter,\n  Save,\n  Printer,\n  FileDown,\n  TableProperties,\n  Plus,\n  Trash2,\n  LayoutGrid,\n  ZoomIn,\n  ZoomOut,\n  Eye,\n  Columns,\n  BookOpen,\n  FileText,\n  Sparkles,\n} from 'lucide-react';\nimport { commandBus, getEditorState } from '@/lib/commands';\n\ntype RibbonTab = 'home' | 'insert' | 'layout' | 'references' | 'review' | 'view' | 'ai';\n\ninterface RibbonShellProps {\n  editor: Editor | null;\n  onDownload?: () => void;\n  onAICommand?: (command: string) => void;\n  children: React.ReactNode;\n}\n\nconst TEXT_COLORS = [\n  '#000000', '#5c5c5c', '#a6a6a6',\n  '#c00000', '#ff0000', '#ffc000',\n  '#ffff00', '#92d050', '#00b050',\n  '#00b0f0', '#0070c0', '#002060',\n  '#7030a0', '#ffffff',\n];\n\nconst HIGHLIGHT_COLORS = [\n  '#ffff00', '#00ff00', '#00ffff',\n  '#ff00ff', '#0000ff', '#ff0000',\n  '#000080', '#008080', '#008000',\n  '#800080', '#800000', '#808000',\n  '#c0c0c0', '#808080',\n];\n\nexport function RibbonShell({ editor, onDownload, onAICommand, children }: RibbonShellProps) {\n  const [activeTab, setActiveTab] = useState<RibbonTab>('home');\n  const editorState = editor ? getEditorState(editor) : null;\n\n  const executeCommand = useCallback((name: string, payload?: Record<string, unknown>) => {\n    commandBus.applyCommand(name, payload || {}, 'ribbon');\n  }, []);\n\n  const renderQuickAccess = () => (\n    <div className=\"flex items-center gap-1 px-2 py-1 border-b bg-muted/30\">\n      <RibbonButton\n        icon={<Save className=\"h-3.5 w-3.5\" />}\n        tooltip=\"Save\"\n        onClick={onDownload}\n        size=\"sm\"\n      />\n      <RibbonButton\n        icon={<Undo className=\"h-3.5 w-3.5\" />}\n        tooltip=\"Undo (Ctrl+Z)\"\n        onClick={() => executeCommand('undo')}\n        disabled={!editorState?.canUndo}\n        size=\"sm\"\n      />\n      <RibbonButton\n        icon={<Redo className=\"h-3.5 w-3.5\" />}\n        tooltip=\"Redo (Ctrl+Y)\"\n        onClick={() => executeCommand('redo')}\n        disabled={!editorState?.canRedo}\n        size=\"sm\"\n      />\n    </div>\n  );\n\n  const renderTabs = () => (\n    <div className=\"flex items-center border-b bg-background\">\n      {(['home', 'insert', 'layout', 'references', 'review', 'view', 'ai'] as RibbonTab[]).map((tab) => (\n        <button\n          key={tab}\n          onClick={() => setActiveTab(tab)}\n          className={cn(\n            'px-4 py-1.5 text-sm font-medium capitalize transition-colors',\n            activeTab === tab\n              ? 'bg-background border-b-2 border-primary text-primary'\n              : 'text-muted-foreground hover:text-foreground hover:bg-muted/50'\n          )}\n          data-testid={`tab-${tab}`}\n        >\n          {tab === 'ai' ? (\n            <span className=\"flex items-center gap-1\">\n              <Sparkles className=\"h-3.5 w-3.5\" />\n              AI\n            </span>\n          ) : tab}\n        </button>\n      ))}\n    </div>\n  );\n\n  const renderHomeTab = () => (\n    <div className=\"flex items-center gap-4 p-2\">\n      <RibbonGroup label=\"Clipboard\">\n        <RibbonButton\n          icon={<FileDown className=\"h-4 w-4\" />}\n          label=\"Paste\"\n          tooltip=\"Paste\"\n          onClick={() => document.execCommand('paste')}\n        />\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Font\">\n        <div className=\"flex flex-col gap-1\">\n          <div className=\"flex items-center gap-1\">\n            <Select\n              defaultValue=\"Inter, sans-serif\"\n              onValueChange={(value) => executeCommand('setFontFamily', { fontFamily: value })}\n            >\n              <SelectTrigger className=\"h-7 w-28 text-xs\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"Inter, sans-serif\">Inter</SelectItem>\n                <SelectItem value=\"Georgia, serif\">Georgia</SelectItem>\n                <SelectItem value=\"Arial, sans-serif\">Arial</SelectItem>\n                <SelectItem value=\"'Times New Roman', serif\">Times</SelectItem>\n              </SelectContent>\n            </Select>\n            <Select defaultValue=\"16\">\n              <SelectTrigger className=\"h-7 w-14 text-xs\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {['12', '14', '16', '18', '20', '24', '28', '32'].map((size) => (\n                  <SelectItem key={size} value={size}>{size}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div className=\"flex items-center gap-0.5\">\n            <RibbonButton\n              icon={<Bold className=\"h-4 w-4\" />}\n              tooltip=\"Bold (Ctrl+B)\"\n              onClick={() => executeCommand('bold')}\n              active={editorState?.isBold}\n              size=\"sm\"\n            />\n            <RibbonButton\n              icon={<Italic className=\"h-4 w-4\" />}\n              tooltip=\"Italic (Ctrl+I)\"\n              onClick={() => executeCommand('italic')}\n              active={editorState?.isItalic}\n              size=\"sm\"\n            />\n            <RibbonButton\n              icon={<Underline className=\"h-4 w-4\" />}\n              tooltip=\"Underline (Ctrl+U)\"\n              onClick={() => executeCommand('underline')}\n              active={editorState?.isUnderline}\n              size=\"sm\"\n            />\n            <RibbonButton\n              icon={<Strikethrough className=\"h-4 w-4\" />}\n              tooltip=\"Strikethrough\"\n              onClick={() => executeCommand('strikethrough')}\n              active={editorState?.isStrike}\n              size=\"sm\"\n            />\n            <Separator orientation=\"vertical\" className=\"h-5 mx-1\" />\n            <ColorPicker\n              colors={TEXT_COLORS}\n              icon={<Palette className=\"h-4 w-4\" />}\n              tooltip=\"Text Color\"\n              onSelect={(color) => executeCommand('setTextColor', { color })}\n            />\n            <ColorPicker\n              colors={HIGHLIGHT_COLORS}\n              icon={<Highlighter className=\"h-4 w-4\" />}\n              tooltip=\"Highlight\"\n              onSelect={(color) => executeCommand('setHighlight', { color })}\n            />\n          </div>\n        </div>\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Paragraph\">\n        <div className=\"flex flex-col gap-1\">\n          <div className=\"flex items-center gap-0.5\">\n            <RibbonButton\n              icon={<List className=\"h-4 w-4\" />}\n              tooltip=\"Bullet List\"\n              onClick={() => executeCommand('bulletList')}\n              active={editorState?.isBulletList}\n              size=\"sm\"\n            />\n            <RibbonButton\n              icon={<ListOrdered className=\"h-4 w-4\" />}\n              tooltip=\"Numbered List\"\n              onClick={() => executeCommand('orderedList')}\n              active={editorState?.isOrderedList}\n              size=\"sm\"\n            />\n          </div>\n          <div className=\"flex items-center gap-0.5\">\n            <RibbonButton\n              icon={<AlignLeft className=\"h-4 w-4\" />}\n              tooltip=\"Align Left\"\n              onClick={() => executeCommand('alignLeft')}\n              active={editorState?.textAlign === 'left'}\n              size=\"sm\"\n            />\n            <RibbonButton\n              icon={<AlignCenter className=\"h-4 w-4\" />}\n              tooltip=\"Align Center\"\n              onClick={() => executeCommand('alignCenter')}\n              active={editorState?.textAlign === 'center'}\n              size=\"sm\"\n            />\n            <RibbonButton\n              icon={<AlignRight className=\"h-4 w-4\" />}\n              tooltip=\"Align Right\"\n              onClick={() => executeCommand('alignRight')}\n              active={editorState?.textAlign === 'right'}\n              size=\"sm\"\n            />\n            <RibbonButton\n              icon={<AlignJustify className=\"h-4 w-4\" />}\n              tooltip=\"Justify\"\n              onClick={() => executeCommand('alignJustify')}\n              active={editorState?.textAlign === 'justify'}\n              size=\"sm\"\n            />\n          </div>\n        </div>\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Styles\">\n        <div className=\"flex items-center gap-1\">\n          <RibbonButton\n            icon={<Heading1 className=\"h-4 w-4\" />}\n            tooltip=\"Heading 1\"\n            onClick={() => executeCommand('heading1')}\n            active={editorState?.isHeading1}\n          />\n          <RibbonButton\n            icon={<Heading2 className=\"h-4 w-4\" />}\n            tooltip=\"Heading 2\"\n            onClick={() => executeCommand('heading2')}\n            active={editorState?.isHeading2}\n          />\n          <RibbonButton\n            icon={<Heading3 className=\"h-4 w-4\" />}\n            tooltip=\"Heading 3\"\n            onClick={() => executeCommand('heading3')}\n            active={editorState?.isHeading3}\n          />\n        </div>\n      </RibbonGroup>\n    </div>\n  );\n\n  const renderInsertTab = () => (\n    <div className=\"flex items-center gap-4 p-2\">\n      <RibbonGroup label=\"Tables\">\n        <RibbonButton\n          icon={<Table className=\"h-5 w-5\" />}\n          label=\"Table\"\n          tooltip=\"Insert Table\"\n          onClick={() => executeCommand('insertTable', { rows: 3, cols: 3 })}\n        />\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Illustrations\">\n        <RibbonButton\n          icon={<Image className=\"h-5 w-5\" />}\n          label=\"Image\"\n          tooltip=\"Insert Image\"\n          onClick={() => {\n            const url = prompt('Enter image URL:');\n            if (url) executeCommand('insertImage', { src: url });\n          }}\n        />\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Links\">\n        <RibbonButton\n          icon={<Link className=\"h-5 w-5\" />}\n          label=\"Link\"\n          tooltip=\"Insert Link\"\n          onClick={() => {\n            const url = prompt('Enter URL:');\n            if (url) executeCommand('insertLink', { url });\n          }}\n          active={editorState?.isLink}\n        />\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Text\">\n        <div className=\"flex items-center gap-1\">\n          <RibbonButton\n            icon={<Quote className=\"h-4 w-4\" />}\n            tooltip=\"Blockquote\"\n            onClick={() => executeCommand('blockquote')}\n            active={editorState?.isBlockquote}\n          />\n          <RibbonButton\n            icon={<Code className=\"h-4 w-4\" />}\n            tooltip=\"Code Block\"\n            onClick={() => executeCommand('codeBlock')}\n            active={editorState?.isCodeBlock}\n          />\n          <RibbonButton\n            icon={<Minus className=\"h-4 w-4\" />}\n            tooltip=\"Horizontal Rule\"\n            onClick={() => executeCommand('insertHorizontalRule')}\n          />\n        </div>\n      </RibbonGroup>\n    </div>\n  );\n\n  const renderLayoutTab = () => (\n    <div className=\"flex items-center gap-4 p-2\">\n      <RibbonGroup label=\"Page Setup\">\n        <div className=\"flex items-center gap-1\">\n          <RibbonButton\n            icon={<FileText className=\"h-5 w-5\" />}\n            label=\"Margins\"\n            tooltip=\"Page Margins\"\n          />\n          <RibbonButton\n            icon={<Columns className=\"h-5 w-5\" />}\n            label=\"Columns\"\n            tooltip=\"Columns\"\n          />\n        </div>\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Paragraph\">\n        <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n          <span>Spacing options</span>\n        </div>\n      </RibbonGroup>\n    </div>\n  );\n\n  const renderReferencesTab = () => (\n    <div className=\"flex items-center gap-4 p-2\">\n      <RibbonGroup label=\"Table of Contents\">\n        <RibbonButton\n          icon={<BookOpen className=\"h-5 w-5\" />}\n          label=\"TOC\"\n          tooltip=\"Insert Table of Contents\"\n        />\n      </RibbonGroup>\n    </div>\n  );\n\n  const renderReviewTab = () => (\n    <div className=\"flex items-center gap-4 p-2\">\n      <RibbonGroup label=\"Proofing\">\n        <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n          <span>Spelling & Grammar</span>\n        </div>\n      </RibbonGroup>\n    </div>\n  );\n\n  const renderViewTab = () => (\n    <div className=\"flex items-center gap-4 p-2\">\n      <RibbonGroup label=\"Zoom\">\n        <div className=\"flex items-center gap-1\">\n          <RibbonButton icon={<ZoomOut className=\"h-4 w-4\" />} tooltip=\"Zoom Out\" />\n          <span className=\"text-xs px-2\">100%</span>\n          <RibbonButton icon={<ZoomIn className=\"h-4 w-4\" />} tooltip=\"Zoom In\" />\n        </div>\n      </RibbonGroup>\n\n      <RibbonGroup label=\"Show\">\n        <div className=\"flex items-center gap-1\">\n          <RibbonButton\n            icon={<LayoutGrid className=\"h-4 w-4\" />}\n            tooltip=\"Gridlines\"\n          />\n          <RibbonButton\n            icon={<Eye className=\"h-4 w-4\" />}\n            tooltip=\"Preview\"\n          />\n        </div>\n      </RibbonGroup>\n    </div>\n  );\n\n  const renderAITab = () => (\n    <div className=\"flex items-center gap-4 p-2\">\n      <RibbonGroup label=\"AI Assistant\">\n        <div className=\"flex items-center gap-2\">\n          <RibbonButton\n            icon={<Sparkles className=\"h-5 w-5\" />}\n            label=\"Ask AI\"\n            tooltip=\"Open AI command bar\"\n            onClick={() => onAICommand?.('open')}\n          />\n        </div>\n      </RibbonGroup>\n      <RibbonGroup label=\"Quick Actions\">\n        <div className=\"flex items-center gap-1\">\n          <RibbonButton\n            label=\"Summarize\"\n            tooltip=\"Summarize selected text\"\n            onClick={() => onAICommand?.('summarize')}\n            size=\"sm\"\n          />\n          <RibbonButton\n            label=\"Improve\"\n            tooltip=\"Improve writing\"\n            onClick={() => onAICommand?.('improve')}\n            size=\"sm\"\n          />\n          <RibbonButton\n            label=\"Simplify\"\n            tooltip=\"Simplify text\"\n            onClick={() => onAICommand?.('simplify')}\n            size=\"sm\"\n          />\n        </div>\n      </RibbonGroup>\n    </div>\n  );\n\n  const renderActiveTab = () => {\n    switch (activeTab) {\n      case 'home': return renderHomeTab();\n      case 'insert': return renderInsertTab();\n      case 'layout': return renderLayoutTab();\n      case 'references': return renderReferencesTab();\n      case 'review': return renderReviewTab();\n      case 'view': return renderViewTab();\n      case 'ai': return renderAITab();\n      default: return null;\n    }\n  };\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"flex flex-col h-full bg-background\">\n        {renderQuickAccess()}\n        {renderTabs()}\n        <div className=\"border-b bg-muted/20 min-h-[72px]\">\n          {renderActiveTab()}\n        </div>\n        <div className=\"flex-1 overflow-auto\">\n          {children}\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n\ninterface RibbonButtonProps {\n  icon?: React.ReactNode;\n  label?: string;\n  tooltip?: string;\n  onClick?: () => void;\n  active?: boolean;\n  disabled?: boolean;\n  size?: 'sm' | 'md';\n}\n\nfunction RibbonButton({ icon, label, tooltip, onClick, active, disabled, size = 'md' }: RibbonButtonProps) {\n  const button = (\n    <Button\n      variant={active ? 'secondary' : 'ghost'}\n      size=\"sm\"\n      onClick={onClick}\n      disabled={disabled}\n      className={cn(\n        'flex flex-col items-center justify-center gap-0.5',\n        size === 'sm' ? 'h-7 w-7 p-1' : 'h-auto min-h-[48px] px-2 py-1',\n        active && 'bg-accent'\n      )}\n      data-testid={`ribbon-btn-${label?.toLowerCase().replace(/\\s+/g, '-') || 'icon'}`}\n    >\n      {icon}\n      {label && size !== 'sm' && <span className=\"text-[10px] leading-tight\">{label}</span>}\n    </Button>\n  );\n\n  if (!tooltip) return button;\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent side=\"bottom\" className=\"text-xs\">\n        {tooltip}\n      </TooltipContent>\n    </Tooltip>\n  );\n}\n\ninterface RibbonGroupProps {\n  label: string;\n  children: React.ReactNode;\n}\n\nfunction RibbonGroup({ label, children }: RibbonGroupProps) {\n  return (\n    <div className=\"flex flex-col\">\n      <div className=\"flex items-end gap-1\">\n        {children}\n      </div>\n      <div className=\"text-[10px] text-muted-foreground text-center mt-1 border-t pt-0.5\">\n        {label}\n      </div>\n    </div>\n  );\n}\n\ninterface ColorPickerProps {\n  colors: string[];\n  icon: React.ReactNode;\n  tooltip: string;\n  onSelect: (color: string) => void;\n}\n\nfunction ColorPicker({ colors, icon, tooltip, onSelect }: ColorPickerProps) {\n  return (\n    <Popover>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <PopoverTrigger asChild>\n            <Button variant=\"ghost\" size=\"sm\" className=\"h-7 w-7 p-1\">\n              {icon}\n            </Button>\n          </PopoverTrigger>\n        </TooltipTrigger>\n        <TooltipContent side=\"bottom\" className=\"text-xs\">\n          {tooltip}\n        </TooltipContent>\n      </Tooltip>\n      <PopoverContent className=\"w-auto p-2\">\n        <div className=\"grid grid-cols-7 gap-1\">\n          {colors.map((color) => (\n            <button\n              key={color}\n              onClick={() => onSelect(color)}\n              className=\"w-5 h-5 rounded border border-border hover:scale-110 transition-transform\"\n              style={{ backgroundColor: color }}\n              data-testid={`color-${color}`}\n            />\n          ))}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n","path":null,"size_bytes":18136,"size_tokens":null},"attached_assets/08_security_1766283299495.md":{"content":"# 08 — Seguridad\n\n## Formula Injection (Excel)\nTextos que empiezan con `= + - @` pueden ser interpretados como fórmula.\nMitigación:\n- si es texto, prefijar `'` (apostrofe) para forzar texto.\n\nVer:\n- `src/office_agent/renderers/excel.py` (`_maybe_escape_text`)\n- `src/office_agent/quality/rules_excel.py` (warning)\n","path":null,"size_bytes":318,"size_tokens":null},"attached_assets/10_llm_integration_1766283299495.md":{"content":"# 10 — Integración LLM (opcional)\n\n- Cliente OpenAI-compatible en `src/office_agent/llm/openai_compat.py`\n- Repair loop en `src/office_agent/orchestrator/*`\n\nRecomendación:\n- usar function calling / schema-guided JSON cuando tu proveedor lo soporte.\n","path":null,"size_bytes":254,"size_tokens":null},"client/src/lib/commands/index.ts":{"content":"export * from './commandBus';\nexport * from './documentAdapter';\n","path":null,"size_bytes":65,"size_tokens":null},"attached_assets/03_excel_rendering_1766283299495.md":{"content":"# 03 — Excel Rendering\n\nRenderer: `src/office_agent/renderers/excel.py`\n\nIncluye:\n- Tablas (openpyxl.Table)\n- Estilos de header\n- Formatos numéricos\n- Fórmulas por columna: `formulas: { \"Total\": \"=C{row}*D{row}\" }`\n- Auto-fit heurístico de columnas\n- Charts básicos (bar/line/pie)\n\nSeguridad: mitigación opcional de **formula injection** (ver `docs/08_security.md`).\n","path":null,"size_bytes":374,"size_tokens":null},"attached_assets/base_1766283299495.py":{"content":"from __future__ import annotations\nfrom abc import ABC, abstractmethod\nfrom typing import List, Dict\n\nclass LLMClient(ABC):\n    @abstractmethod\n    def chat(self, messages: List[Dict[str,str]], *, temperature: float = 0.0) -> str:\n        raise NotImplementedError\n","path":null,"size_bytes":265,"size_tokens":null},"attached_assets/06_api_1766283299495.md":{"content":"# 06 — API\n\n- `GET /health`\n- `POST /v1/render/excel` (ExcelSpec → .xlsx)\n- `POST /v1/render/word`  (DocSpec → .docx)\n- `POST /v1/generate/excel` (prompt → spec → .xlsx) [opcional]\n- `POST /v1/generate/word`  (prompt → spec → .docx) [opcional]\n","path":null,"size_bytes":258,"size_tokens":null},"attached_assets/agent_1766283299495.py":{"content":"from __future__ import annotations\nfrom typing import Dict, List, Tuple\nfrom pydantic import ValidationError as PydanticValidationError\nfrom ..llm.base import LLMClient\nfrom ..schemas.excel import ExcelSpec\nfrom ..schemas.word import DocSpec\nfrom ..quality.rules_excel import run_quality_gates_excel\nfrom ..quality.rules_word import run_quality_gates_word\nfrom ..errors import SchemaValidationError, QualityGateError\nfrom .prompts import EXCEL_SYSTEM, WORD_SYSTEM\nfrom .repair import repair_json\n\ndef generate_excel_spec(prompt: str, llm: LLMClient, *, max_attempts: int = 3) -> Tuple[ExcelSpec, dict]:\n    raw = _first(llm, EXCEL_SYSTEM, prompt)\n    spec = _validate_excel(prompt, llm, raw, max_attempts)\n    q = run_quality_gates_excel(spec)\n    if q.errors: raise QualityGateError(str(q.to_dict()))\n    return spec, q.to_dict()\n\ndef generate_word_spec(prompt: str, llm: LLMClient, *, max_attempts: int = 3) -> Tuple[DocSpec, dict]:\n    raw = _first(llm, WORD_SYSTEM, prompt)\n    spec = _validate_word(prompt, llm, raw, max_attempts)\n    q = run_quality_gates_word(spec)\n    if q.errors: raise QualityGateError(str(q.to_dict()))\n    return spec, q.to_dict()\n\ndef _first(llm: LLMClient, system: str, prompt: str) -> str:\n    return llm.chat([{\"role\":\"system\",\"content\":system},{\"role\":\"user\",\"content\":prompt}], temperature=0.0)\n\ndef _validate_excel(prompt: str, llm: LLMClient, raw: str, max_attempts: int) -> ExcelSpec:\n    cur = raw; last = None\n    for _ in range(max_attempts):\n        try: return ExcelSpec.model_validate_json(cur)\n        except PydanticValidationError as e:\n            last = str(e)\n            cur = repair_json(llm, bad_json=cur, validation_error=last, target=\"excel\", user_prompt=prompt)\n    raise SchemaValidationError(f\"ExcelSpec invalid after {max_attempts}: {last}\")\n\ndef _validate_word(prompt: str, llm: LLMClient, raw: str, max_attempts: int) -> DocSpec:\n    cur = raw; last = None\n    for _ in range(max_attempts):\n        try: return DocSpec.model_validate_json(cur)\n        except PydanticValidationError as e:\n            last = str(e)\n            cur = repair_json(llm, bad_json=cur, validation_error=last, target=\"word\", user_prompt=prompt)\n    raise SchemaValidationError(f\"DocSpec invalid after {max_attempts}: {last}\")\n","path":null,"size_bytes":2264,"size_tokens":null},"client/src/lib/orchestrator/aiOrchestrator.ts":{"content":"import { commandBus, type CommandResult } from '@/lib/commands';\n\nexport interface DocumentPlan {\n  intent: string;\n  commands: PlannedCommand[];\n  validation?: ValidationResult;\n}\n\nexport interface PlannedCommand {\n  name: string;\n  payload?: Record<string, unknown>;\n  description?: string;\n}\n\nexport interface ValidationResult {\n  valid: boolean;\n  errors: string[];\n  warnings: string[];\n}\n\nexport interface OrchestratorOptions {\n  onProgress?: (step: string, index: number, total: number) => void;\n  onError?: (error: string) => void;\n  onComplete?: (results: CommandResult[]) => void;\n}\n\nexport interface ExecutionResult {\n  success: boolean;\n  results: CommandResult[];\n  rollbackAvailable: boolean;\n  snapshot?: string;\n}\n\nclass AIOrchestrator {\n  private snapshot: string | null = null;\n\n  async planFromPrompt(\n    prompt: string,\n    context: {\n      selectedText?: string;\n      documentContent?: string;\n    }\n  ): Promise<DocumentPlan> {\n    try {\n      const response = await fetch('/api/documents/plan', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          prompt,\n          selectedText: context.selectedText,\n          documentContent: context.documentContent,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to generate plan');\n      }\n\n      const plan = await response.json();\n      return this.validatePlan(plan);\n    } catch (error) {\n      return {\n        intent: prompt,\n        commands: [],\n        validation: {\n          valid: false,\n          errors: [error instanceof Error ? error.message : 'Unknown error'],\n          warnings: [],\n        },\n      };\n    }\n  }\n\n  validatePlan(plan: DocumentPlan): DocumentPlan {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n    const seenTOC = new Set<number>();\n\n    for (const cmd of plan.commands) {\n      if (!commandBus.getCommand(cmd.name)) {\n        warnings.push(`Unknown command: ${cmd.name}`);\n      }\n\n      if (cmd.name === 'insertTOC') {\n        const position = (cmd.payload?.position as number) || 0;\n        if (seenTOC.has(position)) {\n          errors.push('Duplicate TOC insertion at same position');\n        }\n        seenTOC.add(position);\n      }\n\n      if (cmd.name === 'insertTable') {\n        const rows = cmd.payload?.rows as number;\n        const cols = cmd.payload?.cols as number;\n        if (rows && rows > 100) {\n          errors.push('Table rows exceed maximum (100)');\n        }\n        if (cols && cols > 26) {\n          errors.push('Table columns exceed maximum (26)');\n        }\n      }\n    }\n\n    return {\n      ...plan,\n      validation: {\n        valid: errors.length === 0,\n        errors,\n        warnings,\n      },\n    };\n  }\n\n  async executePlan(\n    plan: DocumentPlan,\n    options: OrchestratorOptions = {}\n  ): Promise<ExecutionResult> {\n    const { onProgress, onError, onComplete } = options;\n\n    this.snapshot = commandBus.createSnapshot();\n\n    if (!plan.validation?.valid) {\n      const errorMsg = plan.validation?.errors.join(', ') || 'Invalid plan';\n      onError?.(errorMsg);\n      return {\n        success: false,\n        results: [],\n        rollbackAvailable: !!this.snapshot,\n        snapshot: this.snapshot || undefined,\n      };\n    }\n\n    const results: CommandResult[] = [];\n    const total = plan.commands.length;\n\n    for (let i = 0; i < plan.commands.length; i++) {\n      const cmd = plan.commands[i];\n      onProgress?.(cmd.description || cmd.name, i, total);\n\n      const result = commandBus.applyCommand(cmd.name, cmd.payload || {}, 'ai');\n      results.push(result);\n\n      if (!result.success) {\n        onError?.(`Command failed: ${cmd.name} - ${result.error}`);\n        if (this.snapshot) {\n          commandBus.restoreSnapshot(this.snapshot);\n        }\n        return {\n          success: false,\n          results,\n          rollbackAvailable: false,\n          snapshot: undefined,\n        };\n      }\n\n      await new Promise((resolve) => setTimeout(resolve, 50));\n    }\n\n    onComplete?.(results);\n\n    return {\n      success: true,\n      results,\n      rollbackAvailable: !!this.snapshot,\n      snapshot: this.snapshot || undefined,\n    };\n  }\n\n  rollback(): boolean {\n    if (!this.snapshot) return false;\n    const success = commandBus.restoreSnapshot(this.snapshot);\n    if (success) {\n      this.snapshot = null;\n    }\n    return success;\n  }\n\n  parseQuickAction(action: string): PlannedCommand[] {\n    const actions: Record<string, PlannedCommand[]> = {\n      summarize: [\n        {\n          name: 'replaceSelection',\n          payload: { content: '[AI will summarize selected text]' },\n          description: 'Summarize selected text',\n        },\n      ],\n      improve: [\n        {\n          name: 'replaceSelection',\n          payload: { content: '[AI will improve selected text]' },\n          description: 'Improve writing quality',\n        },\n      ],\n      simplify: [\n        {\n          name: 'replaceSelection',\n          payload: { content: '[AI will simplify selected text]' },\n          description: 'Simplify text',\n        },\n      ],\n      'make-formal': [\n        {\n          name: 'replaceSelection',\n          payload: { content: '[AI will make text more formal]' },\n          description: 'Make text more formal',\n        },\n      ],\n      'make-casual': [\n        {\n          name: 'replaceSelection',\n          payload: { content: '[AI will make text more casual]' },\n          description: 'Make text more casual',\n        },\n      ],\n    };\n\n    return actions[action] || [];\n  }\n}\n\nexport const aiOrchestrator = new AIOrchestrator();\n","path":null,"size_bytes":5637,"size_tokens":null},"attached_assets/00_overview_1766283299495.md":{"content":"# 00 — Visión general\n\n## Objetivo\nGenerar `.xlsx` y `.docx` con calidad consistente a partir de una **IR JSON estricta**.\n\n## Principio clave\n**LLM decide qué (estructura/contenido). Renderer decide cómo (OOXML).**\n\n## Componentes\n1) Schemas (IR) — Pydantic estricto  \n2) Quality Gates — reglas mínimas profesionales  \n3) Renderers — openpyxl / python-docx  \n4) Validators — reabrir output (corrupción)  \n5) Orchestrator (opcional) — prompt → spec → repair → render → validate\n","path":null,"size_bytes":503,"size_tokens":null},"client/src/components/ribbon/index.ts":{"content":"export { RibbonShell } from './RibbonShell';\nexport { EnhancedDocumentEditor } from './EnhancedDocumentEditor';\n","path":null,"size_bytes":112,"size_tokens":null},"attached_assets/02_schemas_1766283299495.md":{"content":"# 02 — Schemas (IR)\n\nLos schemas usan Pydantic v2 con `extra=\"forbid\"`.\n- Si el JSON trae campos inesperados → error.\n\nVer ejemplos:\n- `examples/excel_spec_report.json`\n- `examples/doc_spec_report.json`\n","path":null,"size_bytes":207,"size_tokens":null},"client/src/lib/docSpecSerializer.ts":{"content":"import type { DocSpec, DocBlock } from '@shared/documentSpecs';\n\ninterface TipTapNode {\n  type: string;\n  content?: TipTapNode[];\n  text?: string;\n  attrs?: Record<string, unknown>;\n  marks?: Array<{ type: string; attrs?: Record<string, unknown> }>;\n}\n\ninterface TipTapDoc {\n  type: 'doc';\n  content: TipTapNode[];\n}\n\nexport function tiptapToDocSpec(doc: TipTapDoc, title = 'Document'): DocSpec {\n  const blocks: DocBlock[] = [];\n  \n  for (const node of doc.content || []) {\n    const converted = convertNode(node);\n    if (converted) {\n      if (Array.isArray(converted)) {\n        blocks.push(...converted);\n      } else {\n        blocks.push(converted);\n      }\n    }\n  }\n\n  return {\n    title,\n    styleset: 'modern',\n    blocks,\n    add_toc: false,\n  };\n}\n\nfunction convertNode(node: TipTapNode): DocBlock | DocBlock[] | null {\n  switch (node.type) {\n    case 'heading':\n      return {\n        type: 'heading',\n        level: (node.attrs?.level as number) || 1,\n        text: extractText(node),\n      };\n\n    case 'paragraph':\n      const text = extractText(node);\n      if (!text.trim()) return null;\n      return {\n        type: 'paragraph',\n        text,\n      };\n\n    case 'bulletList':\n      return {\n        type: 'bullets',\n        items: (node.content || [])\n          .filter((item) => item.type === 'listItem')\n          .map((item) => extractText(item)),\n      };\n\n    case 'orderedList':\n      return {\n        type: 'bullets',\n        items: (node.content || [])\n          .filter((item) => item.type === 'listItem')\n          .map((item, idx) => `${idx + 1}. ${extractText(item)}`),\n      };\n\n    case 'table':\n      return convertTable(node);\n\n    case 'blockquote':\n      return {\n        type: 'paragraph',\n        text: `> ${extractText(node)}`,\n      };\n\n    case 'codeBlock':\n      return {\n        type: 'paragraph',\n        text: `\\`\\`\\`\\n${extractText(node)}\\n\\`\\`\\``,\n      };\n\n    case 'horizontalRule':\n      return {\n        type: 'page_break',\n      };\n\n    default:\n      return null;\n  }\n}\n\nfunction extractText(node: TipTapNode): string {\n  // Handle math nodes from @aarkue/tiptap-math-extension\n  // The extension uses 'inlineMath' as the node type name\n  if (node.type === 'inlineMath' || node.type === 'math' || node.type === 'mathInline' || node.type === 'mathBlock') {\n    const latex = node.attrs?.latex as string || '';\n    const isBlock = node.type === 'mathBlock' || node.attrs?.display === 'yes';\n    return isBlock ? `$$${latex}$$` : `$${latex}$`;\n  }\n\n  if (node.text) {\n    let text = node.text;\n    if (node.marks) {\n      for (const mark of node.marks) {\n        switch (mark.type) {\n          case 'bold':\n            text = `**${text}**`;\n            break;\n          case 'italic':\n            text = `*${text}*`;\n            break;\n          case 'underline':\n            text = `_${text}_`;\n            break;\n          case 'strike':\n            text = `~~${text}~~`;\n            break;\n          case 'link':\n            text = `[${text}](${mark.attrs?.href || ''})`;\n            break;\n        }\n      }\n    }\n    return text;\n  }\n\n  if (!node.content) return '';\n\n  return node.content.map(extractText).join('');\n}\n\nfunction convertTable(node: TipTapNode): DocBlock | null {\n  if (!node.content) return null;\n\n  const rows = node.content.filter((row) => row.type === 'tableRow');\n  if (rows.length === 0) return null;\n\n  const columns: string[] = [];\n  const dataRows: string[][] = [];\n\n  rows.forEach((row, rowIndex) => {\n    const cells = row.content || [];\n    const rowData: string[] = [];\n\n    cells.forEach((cell) => {\n      const text = extractText(cell);\n      if (rowIndex === 0 && cell.type === 'tableHeader') {\n        columns.push(text);\n      } else {\n        rowData.push(text);\n      }\n    });\n\n    if (rowIndex > 0 || columns.length === 0) {\n      if (rowIndex === 0 && columns.length === 0) {\n        cells.forEach((cell) => columns.push(extractText(cell)));\n      } else if (rowData.length > 0) {\n        dataRows.push(rowData);\n      }\n    }\n  });\n\n  if (columns.length === 0) return null;\n\n  return {\n    type: 'table',\n    columns,\n    rows: dataRows,\n    style: 'Light Shading',\n    header: true,\n  };\n}\n\nexport async function exportToWord(doc: TipTapDoc, title = 'Document'): Promise<Blob> {\n  const spec = tiptapToDocSpec(doc, title);\n  \n  const response = await fetch('/api/documents/render/word', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(spec),\n  });\n\n  if (!response.ok) {\n    throw new Error('Failed to generate Word document');\n  }\n\n  return response.blob();\n}\n","path":null,"size_bytes":4610,"size_tokens":null},"client/src/components/ribbon/EnhancedDocumentEditor.tsx":{"content":"import { useEffect, useCallback, useRef, useState } from 'react';\nimport { useEditor, EditorContent } from '@tiptap/react';\nimport StarterKit from '@tiptap/starter-kit';\nimport Underline from '@tiptap/extension-underline';\nimport TextAlign from '@tiptap/extension-text-align';\nimport { TextStyle } from '@tiptap/extension-text-style';\nimport FontFamily from '@tiptap/extension-font-family';\nimport { Color } from '@tiptap/extension-color';\nimport Highlight from '@tiptap/extension-highlight';\nimport Link from '@tiptap/extension-link';\nimport Image from '@tiptap/extension-image';\nimport { Table } from '@tiptap/extension-table';\nimport { TableRow } from '@tiptap/extension-table-row';\nimport { TableCell } from '@tiptap/extension-table-cell';\nimport { TableHeader } from '@tiptap/extension-table-header';\nimport MathExtension from '@aarkue/tiptap-math-extension';\nimport { RibbonShell } from './RibbonShell';\nimport { initializeDocumentAdapter, commandBus } from '@/lib/commands';\nimport { aiOrchestrator } from '@/lib/orchestrator';\nimport { exportToWord } from '@/lib/docSpecSerializer';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { X, Download, Sparkles, Loader2 } from 'lucide-react';\nimport { cn } from '@/lib/utils';\nimport { markdownToTipTap } from '@/lib/markdownToHtml';\nimport 'katex/dist/katex.min.css';\n\ninterface EnhancedDocumentEditorProps {\n  title: string;\n  content: string;\n  onChange: (content: string) => void;\n  onClose: () => void;\n  onDownload: () => void;\n  onTextSelect?: (text: string, applyRewrite: (newText: string) => void) => void;\n  onTextDeselect?: () => void;\n  onInsertContent?: (insertFn: (content: string, replaceMode?: boolean) => void) => void;\n}\n\nexport function EnhancedDocumentEditor({\n  title,\n  content,\n  onChange,\n  onClose,\n  onDownload,\n  onTextSelect,\n  onTextDeselect,\n  onInsertContent,\n}: EnhancedDocumentEditorProps) {\n  const [aiPrompt, setAiPrompt] = useState('');\n  const [isAiProcessing, setIsAiProcessing] = useState(false);\n  const [showAiBar, setShowAiBar] = useState(false);\n  const savedRangeRef = useRef<Range | null>(null);\n\n  const editor = useEditor({\n    extensions: [\n      StarterKit.configure({\n        heading: { levels: [1, 2, 3] },\n      }),\n      Underline,\n      TextAlign.configure({ types: ['heading', 'paragraph'] }),\n      TextStyle,\n      FontFamily,\n      Color,\n      Highlight.configure({ multicolor: true }),\n      Link.configure({ openOnClick: false }),\n      Image,\n      Table.configure({ resizable: true }),\n      TableRow,\n      TableCell,\n      TableHeader,\n      MathExtension.configure({\n        evaluation: false,\n        delimiters: 'dollar',\n        katexOptions: { throwOnError: false, displayMode: false },\n      }),\n    ],\n    content: markdownToTipTap(content),\n    onUpdate: ({ editor }) => {\n      onChange(editor.getHTML());\n    },\n    editorProps: {\n      attributes: {\n        class: 'prose prose-lg max-w-none focus:outline-none min-h-[800px] p-8',\n      },\n    },\n  });\n\n  useEffect(() => {\n    if (editor) {\n      initializeDocumentAdapter(editor);\n    }\n  }, [editor]);\n\n  const applyRewrite = useCallback((newText: string) => {\n    if (!editor || !savedRangeRef.current) return;\n    const { from, to } = editor.state.selection;\n    editor.chain().focus().deleteRange({ from, to }).insertContent(newText).run();\n    savedRangeRef.current = null;\n  }, [editor]);\n\n  useEffect(() => {\n    if (!editor) return;\n\n    const handleSelectionChange = () => {\n      const selection = window.getSelection();\n      if (selection && selection.toString().trim().length > 0) {\n        savedRangeRef.current = selection.getRangeAt(0).cloneRange();\n        onTextSelect?.(selection.toString(), applyRewrite);\n      } else {\n        onTextDeselect?.();\n      }\n    };\n\n    document.addEventListener('selectionchange', handleSelectionChange);\n    return () => document.removeEventListener('selectionchange', handleSelectionChange);\n  }, [editor, onTextSelect, onTextDeselect, applyRewrite]);\n\n  useEffect(() => {\n    if (!editor || !onInsertContent) return;\n    \n    const insertFn = (text: string, replaceMode = false) => {\n      if (replaceMode) {\n        editor.commands.setContent(markdownToTipTap(text));\n      } else {\n        editor.chain().focus().insertContent(markdownToTipTap(text)).run();\n      }\n    };\n    \n    onInsertContent(insertFn);\n  }, [editor, onInsertContent]);\n\n  const handleAICommand = useCallback(async (action: string) => {\n    if (action === 'open') {\n      setShowAiBar(true);\n      return;\n    }\n\n    if (!editor) return;\n\n    setIsAiProcessing(true);\n    try {\n      const { from, to } = editor.state.selection;\n      const selectedText = editor.state.doc.textBetween(from, to, ' ');\n      \n      const plan = await aiOrchestrator.planFromPrompt(action, {\n        selectedText,\n        documentContent: editor.getHTML(),\n      });\n\n      if (plan.commands.length > 0) {\n        await aiOrchestrator.executePlan(plan);\n      }\n    } catch (error) {\n      console.error('AI command failed:', error);\n    } finally {\n      setIsAiProcessing(false);\n    }\n  }, [editor]);\n\n  const handleAIPromptSubmit = useCallback(async () => {\n    if (!aiPrompt.trim() || !editor) return;\n\n    setIsAiProcessing(true);\n    try {\n      const { from, to } = editor.state.selection;\n      const selectedText = editor.state.doc.textBetween(from, to, ' ');\n\n      const plan = await aiOrchestrator.planFromPrompt(aiPrompt, {\n        selectedText,\n        documentContent: editor.getHTML(),\n      });\n\n      if (plan.commands.length > 0) {\n        await aiOrchestrator.executePlan(plan);\n      }\n\n      setAiPrompt('');\n      setShowAiBar(false);\n    } catch (error) {\n      console.error('AI prompt failed:', error);\n    } finally {\n      setIsAiProcessing(false);\n    }\n  }, [aiPrompt, editor]);\n\n  const handleExportWord = useCallback(async () => {\n    if (!editor) return;\n    \n    try {\n      const doc = editor.getJSON();\n      const blob = await exportToWord(doc as any, title);\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `${title}.docx`;\n      a.click();\n      URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Export failed:', error);\n      onDownload();\n    }\n  }, [editor, title, onDownload]);\n\n  if (!editor) return null;\n\n  return (\n    <div className=\"h-full flex flex-col bg-background relative\">\n      <div className=\"flex items-center justify-between px-4 py-2 border-b bg-muted/30\">\n        <h2 className=\"font-semibold text-lg truncate max-w-md\">{title}</h2>\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={handleExportWord}\n            data-testid=\"btn-export-word\"\n          >\n            <Download className=\"h-4 w-4 mr-1\" />\n            Export\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={onClose}\n            data-testid=\"btn-close-editor\"\n          >\n            <X className=\"h-5 w-5\" />\n          </Button>\n        </div>\n      </div>\n\n      <RibbonShell\n        editor={editor}\n        onDownload={handleExportWord}\n        onAICommand={handleAICommand}\n      >\n        <div className=\"flex-1 overflow-auto bg-gray-100 dark:bg-gray-900\">\n          <div className=\"max-w-4xl mx-auto my-8 bg-white dark:bg-gray-800 shadow-lg rounded-sm min-h-[1100px]\">\n            <EditorContent editor={editor} className=\"min-h-[1100px]\" />\n          </div>\n        </div>\n      </RibbonShell>\n\n      {showAiBar && (\n        <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 w-full max-w-2xl px-4\">\n          <div className=\"flex items-center gap-2 bg-background border rounded-lg shadow-lg p-2\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            <Input\n              value={aiPrompt}\n              onChange={(e) => setAiPrompt(e.target.value)}\n              placeholder=\"Ask AI to edit your document...\"\n              className=\"flex-1 border-0 focus-visible:ring-0\"\n              onKeyDown={(e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                  e.preventDefault();\n                  handleAIPromptSubmit();\n                }\n                if (e.key === 'Escape') {\n                  setShowAiBar(false);\n                }\n              }}\n              disabled={isAiProcessing}\n              autoFocus\n              data-testid=\"input-ai-prompt\"\n            />\n            <Button\n              size=\"sm\"\n              onClick={handleAIPromptSubmit}\n              disabled={isAiProcessing || !aiPrompt.trim()}\n              data-testid=\"btn-ai-submit\"\n            >\n              {isAiProcessing ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                'Apply'\n              )}\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => setShowAiBar(false)}\n              data-testid=\"btn-ai-close\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n      )}\n\n      {isAiProcessing && !showAiBar && (\n        <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2\">\n          <div className=\"flex items-center gap-2 bg-primary text-primary-foreground rounded-full px-4 py-2 shadow-lg\">\n            <Loader2 className=\"h-4 w-4 animate-spin\" />\n            <span className=\"text-sm\">AI is editing...</span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9635,"size_tokens":null},"attached_assets/OfficeAgentPro_AllCode_1766287253841.md":{"content":"# Office Agent Pro — Código completo (un solo documento)\n\n> Copia y pega este documento a tu programador.  \n> Contiene los archivos esenciales del proyecto (Word + Excel) separados por títulos.\n\n---\n\n## FILE: `requirements.txt`\n```txt\npydantic>=2.6,<3\nopenpyxl>=3.1.2,<4\npython-docx>=1.1.0,<2\nfastapi>=0.110,<1\nuvicorn[standard]>=0.27,<1\ntyper>=0.12,<1\nrequests>=2.31,<3\n```\n\n---\n\n## FILE: `src/office_agent/config.py`\n```python\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass\nimport os\n\n\n@dataclass(frozen=True)\nclass Settings:\n    \"\"\"Runtime settings.\n\n    Mantener explícito y pequeño. Extender cuando sea necesario.\n    \"\"\"\n\n    # API\n    api_title: str = \"Office Agent Pro\"\n    api_version: str = \"0.1.0\"\n\n    # Límites (seguridad/DoS)\n    max_sheets: int = 20\n    max_total_cells: int = 2_000_000\n    max_total_rows: int = 200_000\n    max_block_count: int = 2_000\n    max_text_len: int = 50_000\n    max_table_cells: int = 200_000\n\n    # Excel safety: escapar texto que parece fórmula\n    excel_escape_formula_like_text: bool = True\n\n    # Column auto-fit bounds (heurística)\n    excel_col_min_width: float = 8.0\n    excel_col_max_width: float = 60.0\n\n    # Logging\n    log_level: str = os.getenv(\"OFFICE_AGENT_LOG_LEVEL\", \"INFO\")\n    log_json: bool = os.getenv(\"OFFICE_AGENT_LOG_JSON\", \"0\") == \"1\"\n\n\ndef get_settings() -> Settings:\n    return Settings()\n```\n\n---\n\n## FILE: `src/office_agent/errors.py`\n```python\nclass OfficeAgentError(Exception):\n    \"\"\"Base error.\"\"\"\n\n\nclass SchemaValidationError(OfficeAgentError):\n    \"\"\"Spec inválido vs schema.\"\"\"\n\n\nclass QualityGateError(OfficeAgentError):\n    \"\"\"Quality gates con errores bloqueantes.\"\"\"\n\n\nclass RenderError(OfficeAgentError):\n    \"\"\"Falló el render.\"\"\"\n\n\nclass ValidationError(OfficeAgentError):\n    \"\"\"Falló validación post-render (archivo corrupto, etc.).\"\"\"\n```\n\n---\n\n## FILE: `src/office_agent/logging.py`\n```python\nfrom __future__ import annotations\n\nimport json\nimport logging\nimport sys\nfrom typing import Any, Dict\n\nfrom .config import get_settings\n\n\nclass JsonFormatter(logging.Formatter):\n    def format(self, record: logging.LogRecord) -> str:\n        payload: Dict[str, Any] = {\n            \"level\": record.levelname,\n            \"name\": record.name,\n            \"message\": record.getMessage(),\n        }\n        if record.exc_info:\n            payload[\"exc_info\"] = self.formatException(record.exc_info)\n        if hasattr(record, \"extra\") and isinstance(record.extra, dict):\n            payload.update(record.extra)\n        return json.dumps(payload, ensure_ascii=False)\n\n\ndef setup_logging() -> None:\n    settings = get_settings()\n    root = logging.getLogger()\n    root.handlers.clear()\n    root.setLevel(getattr(logging, settings.log_level.upper(), logging.INFO))\n\n    handler = logging.StreamHandler(sys.stdout)\n    if settings.log_json:\n        handler.setFormatter(JsonFormatter())\n    else:\n        handler.setFormatter(logging.Formatter(\"%(asctime)s %(levelname)s %(name)s: %(message)s\"))\n    root.addHandler(handler)\n```\n\n---\n\n## FILE: `src/office_agent/schemas/common.py`\n```python\nfrom __future__ import annotations\n\nimport re\nfrom typing import Any\n\n_CELL_RE = re.compile(r\"^[A-Z]{1,3}[1-9][0-9]{0,6}$\")\n\n\ndef is_cell_ref(value: str) -> bool:\n    return bool(_CELL_RE.match(value or \"\"))\n\n\ndef assert_cell_ref(value: str) -> str:\n    if not is_cell_ref(value):\n        raise ValueError(f\"Invalid cell reference: {value!r} (expected like 'A1')\")\n    return value\n\n\ndef safe_str(value: Any) -> str:\n    try:\n        return \"\" if value is None else str(value)\n    except Exception:\n        return \"\"\n```\n\n---\n\n## FILE: `src/office_agent/schemas/excel.py`\n```python\nfrom __future__ import annotations\n\nfrom typing import Any, Dict, List, Literal, Optional\n\nfrom pydantic import BaseModel, ConfigDict, Field, field_validator, model_validator\n\nfrom .common import assert_cell_ref\n\n_RANGE_RE = r\"^[A-Z]{1,3}[1-9][0-9]{0,6}:[A-Z]{1,3}[1-9][0-9]{0,6}$\"\n\n\nclass WorkbookMeta(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    title: Optional[str] = None\n    author: Optional[str] = None\n\n\nclass TableStyleSpec(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    table_style: str = Field(default=\"TableStyleMedium9\")\n    header_bold: bool = True\n    header_fill: Optional[str] = Field(default=\"D9E1F2\")\n\n\nclass TableSpec(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n\n    name: Optional[str] = None\n    start_cell: str = Field(description=\"Top-left cell, e.g. 'A1'.\")\n    headers: List[str] = Field(min_length=1)\n    rows: List[List[Any]] = Field(default_factory=list)\n    style: TableStyleSpec = Field(default_factory=TableStyleSpec)\n    auto_filter: bool = True\n\n    number_formats: Dict[str, str] = Field(default_factory=dict)\n    formulas: Dict[str, str] = Field(\n        default_factory=dict,\n        description=\"Header -> formula template with '{row}', e.g. {'Total': '=C{row}*D{row}'}\",\n    )\n\n    @field_validator(\"start_cell\")\n    @classmethod\n    def _validate_cell(cls, v: str) -> str:\n        return assert_cell_ref(v)\n\n    @field_validator(\"headers\")\n    @classmethod\n    def _validate_headers(cls, v: List[str]) -> List[str]:\n        if any(not h or not str(h).strip() for h in v):\n            raise ValueError(\"headers must be non-empty strings\")\n        normalized = [h.strip() for h in v]\n        if len(set(normalized)) != len(normalized):\n            raise ValueError(\"headers must be unique\")\n        return normalized\n\n    @model_validator(mode=\"after\")\n    def _validate_rows(self) -> \"TableSpec\":\n        n = len(self.headers)\n        for i, row in enumerate(self.rows):\n            if len(row) != n:\n                raise ValueError(f\"Row {i} has {len(row)} cells but expected {n}\")\n        for k in self.number_formats.keys():\n            if k not in self.headers:\n                raise ValueError(f\"number_formats references unknown header: {k!r}\")\n        for k in self.formulas.keys():\n            if k not in self.headers:\n                raise ValueError(f\"formulas references unknown header: {k!r}\")\n        return self\n\n\nclass CellSpec(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    cell: str\n    value: Any = None\n    formula: Optional[str] = None\n    number_format: Optional[str] = None\n    bold: bool = False\n\n    @field_validator(\"cell\")\n    @classmethod\n    def _validate_cell(cls, v: str) -> str:\n        return assert_cell_ref(v)\n\n    @model_validator(mode=\"after\")\n    def _exclusive_value_formula(self) -> \"CellSpec\":\n        if self.formula is not None and self.value not in (None, \"\"):\n            raise ValueError(\"CellSpec: provide either 'value' or 'formula', not both\")\n        return self\n\n\nclass ChartSpec(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n\n    type: Literal[\"bar\", \"line\", \"pie\"] = \"bar\"\n    title: Optional[str] = None\n    data_range: str = Field(pattern=_RANGE_RE)\n    categories_range: Optional[str] = Field(default=None, pattern=_RANGE_RE)\n    position_cell: str = Field(default=\"H2\")\n\n    @field_validator(\"position_cell\")\n    @classmethod\n    def _validate_pos(cls, v: str) -> str:\n        return assert_cell_ref(v)\n\n\nclass SheetLayout(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    freeze_panes: Optional[str] = None\n    column_widths: Dict[str, float] = Field(default_factory=dict)\n    row_heights: Dict[int, float] = Field(default_factory=dict)\n    auto_filter: bool = False\n\n    @field_validator(\"freeze_panes\")\n    @classmethod\n    def _validate_freeze(cls, v: Optional[str]) -> Optional[str]:\n        if v is None:\n            return None\n        return assert_cell_ref(v)\n\n    @field_validator(\"column_widths\")\n    @classmethod\n    def _validate_col_widths(cls, v: Dict[str, float]) -> Dict[str, float]:\n        for col, w in v.items():\n            if not isinstance(col, str) or not col.isalpha() or len(col) > 3:\n                raise ValueError(f\"Invalid column key: {col!r}\")\n            if w <= 0:\n                raise ValueError(f\"Column width must be > 0 for {col}\")\n        return {col.upper(): float(w) for col, w in v.items()}\n\n\nclass SheetSpec(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    name: str = Field(min_length=1, max_length=31)\n    tables: List[TableSpec] = Field(default_factory=list)\n    cells: List[CellSpec] = Field(default_factory=list)\n    charts: List[ChartSpec] = Field(default_factory=list)\n    layout: SheetLayout = Field(default_factory=SheetLayout)\n\n\nclass ExcelSpec(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    meta: WorkbookMeta = Field(default_factory=WorkbookMeta)\n    sheets: List[SheetSpec] = Field(min_length=1)\n```\n\n---\n\n## FILE: `src/office_agent/schemas/word.py`\n```python\nfrom __future__ import annotations\n\nfrom typing import Any, List, Literal, Optional, Union, Annotated\n\nfrom pydantic import BaseModel, ConfigDict, Field, model_validator, field_validator\n\n\nclass DocMeta(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    title: Optional[str] = None\n    author: Optional[str] = None\n\n\nclass TitleBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"title\"] = \"title\"\n    text: str = Field(min_length=1)\n\n\nclass HeadingBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"heading\"] = \"heading\"\n    level: int = Field(ge=1, le=6)\n    text: str = Field(min_length=1)\n\n\nclass ParagraphBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"paragraph\"] = \"paragraph\"\n    text: str = Field(min_length=1)\n    style: Optional[str] = None\n\n\nclass BulletsBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"bullets\"] = \"bullets\"\n    items: List[str] = Field(min_length=1)\n\n\nclass NumberedBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"numbered\"] = \"numbered\"\n    items: List[str] = Field(min_length=1)\n\n\nclass TableBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"table\"] = \"table\"\n    columns: List[str] = Field(min_length=1)\n    rows: List[List[Any]] = Field(default_factory=list)\n    style: str = Field(default=\"Table Grid\")\n    header: bool = True\n\n    @field_validator(\"columns\")\n    @classmethod\n    def _validate_cols(cls, v: List[str]) -> List[str]:\n        if any(not c or not str(c).strip() for c in v):\n            raise ValueError(\"columns must be non-empty strings\")\n        normalized = [c.strip() for c in v]\n        if len(set(normalized)) != len(normalized):\n            raise ValueError(\"columns must be unique\")\n        return normalized\n\n    @model_validator(mode=\"after\")\n    def _validate_rows(self) -> \"TableBlock\":\n        n = len(self.columns)\n        for i, row in enumerate(self.rows):\n            if len(row) != n:\n                raise ValueError(f\"Row {i} has {len(row)} cells but expected {n}\")\n        return self\n\n\nclass PageBreakBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"page_break\"] = \"page_break\"\n\n\nclass TocBlock(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    type: Literal[\"toc\"] = \"toc\"\n    max_level: int = Field(default=3, ge=1, le=6)\n\n\nDocBlock = Annotated[\n    Union[\n        TitleBlock,\n        HeadingBlock,\n        ParagraphBlock,\n        BulletsBlock,\n        NumberedBlock,\n        TableBlock,\n        PageBreakBlock,\n        TocBlock,\n    ],\n    Field(discriminator=\"type\"),\n]\n\n\nclass DocSpec(BaseModel):\n    model_config = ConfigDict(extra=\"forbid\", strict=True)\n    meta: DocMeta = Field(default_factory=DocMeta)\n    styleset: str = Field(default=\"modern\")\n    blocks: List[DocBlock] = Field(min_length=1)\n```\n\n---\n\n## FILE: `src/office_agent/renderers/utils_excel.py`\n```python\nfrom __future__ import annotations\n\nimport re\nfrom typing import Any, Iterable, Tuple\n\nfrom openpyxl.utils import column_index_from_string, get_column_letter\nfrom openpyxl.utils.cell import coordinate_from_string, range_boundaries\n\n\ndef cell_to_rowcol(cell: str) -> Tuple[int, int]:\n    col_letters, row = coordinate_from_string(cell)\n    return int(row), column_index_from_string(col_letters)\n\n\ndef rowcol_to_cell(row: int, col: int) -> str:\n    return f\"{get_column_letter(col)}{row}\"\n\n\ndef bounds_from_range(rng: str) -> Tuple[int, int, int, int]:\n    return range_boundaries(rng)\n\n\ndef safe_table_name(name: str) -> str:\n    cleaned = re.sub(r\"[^A-Za-z0-9_]\", \"_\", name.strip())\n    if not cleaned:\n        cleaned = \"Table1\"\n    if not re.match(r\"^[A-Za-z_]\", cleaned):\n        cleaned = f\"T_{cleaned}\"\n    return cleaned[:255]\n\n\ndef heuristic_col_width(values: Iterable[Any], min_w: float, max_w: float) -> float:\n    max_len = 0\n    for v in values:\n        s = \"\" if v is None else str(v)\n        max_len = max(max_len, len(s))\n    width = float(max_len + 2)\n    width = max(width, min_w)\n    width = min(width, max_w)\n    return width\n```\n\n---\n\n## FILE: `src/office_agent/renderers/excel.py`\n```python\nfrom __future__ import annotations\n\nfrom io import BytesIO\nfrom typing import Dict, List, Tuple, Any\n\nfrom openpyxl import Workbook\nfrom openpyxl.chart import BarChart, LineChart, PieChart, Reference\nfrom openpyxl.styles import Alignment, Font, PatternFill\nfrom openpyxl.worksheet.table import Table, TableStyleInfo\nfrom openpyxl.utils import get_column_letter\nfrom openpyxl.utils.cell import range_boundaries\n\nfrom ..config import get_settings\nfrom ..errors import RenderError\nfrom ..schemas.excel import ExcelSpec, SheetSpec, TableSpec, ChartSpec, CellSpec\nfrom .utils_excel import cell_to_rowcol, rowcol_to_cell, safe_table_name, heuristic_col_width\n\n_FORMULA_PREFIXES = (\"=\", \"+\", \"-\", \"@\")  # formula injection primitives\n\n\ndef render_excel_bytes(spec: ExcelSpec) -> bytes:\n    try:\n        wb = Workbook()\n        default = wb.active\n        wb.remove(default)\n\n        if spec.meta.title:\n            wb.properties.title = spec.meta.title\n        if spec.meta.author:\n            wb.properties.creator = spec.meta.author\n\n        for sheet_idx, sheet in enumerate(spec.sheets):\n            ws = wb.create_sheet(title=sheet.name, index=sheet_idx)\n            _render_sheet(ws, sheet)\n\n        out = BytesIO()\n        wb.save(out)\n        return out.getvalue()\n    except Exception as e:\n        raise RenderError(f\"Excel render failed: {e}\") from e\n\n\ndef _render_sheet(ws, sheet: SheetSpec) -> None:\n    for c in sheet.cells:\n        _write_cell(ws, c)\n\n    table_ranges: List[Tuple[str, TableSpec]] = []\n    for idx, table in enumerate(sheet.tables, start=1):\n        rng = _write_table(ws, table, idx)\n        table_ranges.append((rng, table))\n\n    if sheet.layout.freeze_panes:\n        ws.freeze_panes = sheet.layout.freeze_panes\n    else:\n        for _rng, t in table_ranges:\n            start_row, _ = cell_to_rowcol(t.start_cell)\n            if start_row == 1:\n                ws.freeze_panes = rowcol_to_cell(start_row + 1, 1)\n                break\n\n    for col, w in sheet.layout.column_widths.items():\n        ws.column_dimensions[col].width = float(w)\n\n    for row, h in sheet.layout.row_heights.items():\n        ws.row_dimensions[int(row)].height = float(h)\n\n    for chart in sheet.charts:\n        _render_chart(ws, chart)\n\n\ndef _write_cell(ws, cell: CellSpec) -> None:\n    settings = get_settings()\n    r, c = cell_to_rowcol(cell.cell)\n    x = ws.cell(row=r, column=c)\n\n    if cell.formula is not None:\n        x.value = cell.formula\n    else:\n        x.value = _maybe_escape_text(cell.value, enabled=settings.excel_escape_formula_like_text)\n\n    if cell.number_format:\n        x.number_format = cell.number_format\n    if cell.bold:\n        x.font = Font(bold=True)\n\n\ndef _write_table(ws, table: TableSpec, index: int) -> str:\n    settings = get_settings()\n\n    start_row, start_col = cell_to_rowcol(table.start_cell)\n    ncols = len(table.headers)\n\n    header_font = Font(bold=table.style.header_bold)\n    header_fill = PatternFill(\"solid\", fgColor=table.style.header_fill) if table.style.header_fill else None\n    header_align = Alignment(horizontal=\"center\", vertical=\"center\", wrap_text=True)\n\n    for j, h in enumerate(table.headers):\n        cell = ws.cell(row=start_row, column=start_col + j, value=h)\n        cell.font = header_font\n        cell.alignment = header_align\n        if header_fill:\n            cell.fill = header_fill\n\n    formula_headers = set(table.formulas.keys())\n\n    for i, row in enumerate(table.rows, start=1):\n        target_row = start_row + i\n        for j, val in enumerate(row):\n            header = table.headers[j]\n            cell_obj = ws.cell(row=target_row, column=start_col + j)\n            if header in formula_headers:\n                cell_obj.value = None\n            else:\n                cell_obj.value = _maybe_escape_text(val, enabled=settings.excel_escape_formula_like_text)\n\n    for header, template in table.formulas.items():\n        col_index = table.headers.index(header)\n        col = start_col + col_index\n        for i in range(1, 1 + len(table.rows)):\n            r = start_row + i\n            ws.cell(row=r, column=col).value = template.format(row=r)\n\n    header_to_col: Dict[str, int] = {h: start_col + idx for idx, h in enumerate(table.headers)}\n    for header, fmt in table.number_formats.items():\n        col = header_to_col[header]\n        for r in range(start_row + 1, start_row + 1 + len(table.rows)):\n            ws.cell(row=r, column=col).number_format = fmt\n\n    end_row = start_row + len(table.rows)\n    end_col = start_col + ncols - 1\n    rng = f\"{get_column_letter(start_col)}{start_row}:{get_column_letter(end_col)}{end_row}\"\n\n    display_name = safe_table_name(table.name or f\"Table_{index}\")\n    excel_table = Table(displayName=display_name, ref=rng)\n    excel_table.tableStyleInfo = TableStyleInfo(\n        name=table.style.table_style,\n        showFirstColumn=False,\n        showLastColumn=False,\n        showRowStripes=True,\n        showColumnStripes=False,\n    )\n    ws.add_table(excel_table)\n\n    for j, h in enumerate(table.headers):\n        col_letter = get_column_letter(start_col + j)\n        if ws.column_dimensions[col_letter].width is not None:\n            continue\n        col_values = [h] + [row[j] for row in table.rows]\n        ws.column_dimensions[col_letter].width = heuristic_col_width(\n            col_values, settings.excel_col_min_width, settings.excel_col_max_width\n        )\n\n    return rng\n\n\ndef _render_chart(ws, chart: ChartSpec) -> None:\n    min_col, min_row, max_col, max_row = range_boundaries(chart.data_range)\n    data_ref = Reference(ws, min_col=min_col, min_row=min_row, max_col=max_col, max_row=max_row)\n\n    if chart.type == \"bar\":\n        ch = BarChart()\n        ch.add_data(data_ref, titles_from_data=True)\n    elif chart.type == \"line\":\n        ch = LineChart()\n        ch.add_data(data_ref, titles_from_data=True)\n    elif chart.type == \"pie\":\n        ch = PieChart()\n        values_ref = Reference(ws, min_col=max_col, min_row=min_row + 1, max_col=max_col, max_row=max_row)\n        ch.add_data(values_ref, titles_from_data=False)\n    else:\n        raise RenderError(f\"Unsupported chart type: {chart.type}\")\n\n    if chart.title:\n        ch.title = chart.title\n\n    if chart.categories_range:\n        cmin_col, cmin_row, cmax_col, cmax_row = range_boundaries(chart.categories_range)\n        cat_ref = Reference(ws, min_col=cmin_col, min_row=cmin_row + 1, max_col=cmax_col, max_row=cmax_row)\n        try:\n            ch.set_categories(cat_ref)\n        except Exception:\n            pass\n    else:\n        if max_col > min_col:\n            cat_ref = Reference(ws, min_col=min_col, min_row=min_row + 1, max_col=min_col, max_row=max_row)\n            try:\n                ch.set_categories(cat_ref)\n            except Exception:\n                pass\n\n    ws.add_chart(ch, chart.position_cell)\n\n\ndef _maybe_escape_text(value: Any, *, enabled: bool) -> Any:\n    if not enabled:\n        return value\n    if isinstance(value, str) and value.startswith(_FORMULA_PREFIXES):\n        return \"'\" + value\n    return value\n```\n\n---\n\n## FILE: `src/office_agent/renderers/utils_word.py`\n```python\nfrom __future__ import annotations\n\nfrom docx.oxml import OxmlElement\nfrom docx.oxml.ns import qn\n\n\ndef add_toc(paragraph, max_level: int = 3) -> None:\n    run = paragraph.add_run()\n\n    fld_begin = OxmlElement(\"w:fldChar\")\n    fld_begin.set(qn(\"w:fldCharType\"), \"begin\")\n\n    instr = OxmlElement(\"w:instrText\")\n    instr.set(qn(\"xml:space\"), \"preserve\")\n    instr.text = f'TOC \\\\o \"1-{max_level}\" \\\\h \\\\z \\\\u'\n\n    fld_sep = OxmlElement(\"w:fldChar\")\n    fld_sep.set(qn(\"w:fldCharType\"), \"separate\")\n\n    fld_end = OxmlElement(\"w:fldChar\")\n    fld_end.set(qn(\"w:fldCharType\"), \"end\")\n\n    run._r.append(fld_begin)\n    run._r.append(instr)\n    run._r.append(fld_sep)\n\n    t = OxmlElement(\"w:t\")\n    t.text = \"Tabla de contenido (actualiza campos en tu editor)\"\n    run._r.append(t)\n\n    run._r.append(fld_end)\n```\n\n---\n\n## FILE: `src/office_agent/renderers/word.py`\n```python\nfrom __future__ import annotations\n\nfrom io import BytesIO\n\nfrom docx import Document\nfrom docx.shared import Pt\nfrom docx.table import Table as DocxTable\n\nfrom ..errors import RenderError\nfrom ..schemas.word import (\n    DocSpec,\n    TitleBlock,\n    HeadingBlock,\n    ParagraphBlock,\n    BulletsBlock,\n    NumberedBlock,\n    TableBlock,\n    PageBreakBlock,\n    TocBlock,\n)\nfrom .utils_word import add_toc\n\n\ndef render_word_bytes(spec: DocSpec) -> bytes:\n    try:\n        doc = Document()\n        _apply_styleset(doc, spec.styleset)\n\n        for block in spec.blocks:\n            if isinstance(block, TitleBlock):\n                doc.add_paragraph(block.text, style=\"Title\")\n            elif isinstance(block, HeadingBlock):\n                doc.add_paragraph(block.text, style=f\"Heading {block.level}\")\n            elif isinstance(block, ParagraphBlock):\n                p = doc.add_paragraph(style=block.style or \"Normal\")\n                p.add_run(block.text)\n            elif isinstance(block, BulletsBlock):\n                for item in block.items:\n                    doc.add_paragraph(str(item), style=\"List Bullet\")\n            elif isinstance(block, NumberedBlock):\n                for item in block.items:\n                    doc.add_paragraph(str(item), style=\"List Number\")\n            elif isinstance(block, TableBlock):\n                _render_table(doc, block)\n            elif isinstance(block, PageBreakBlock):\n                doc.add_page_break()\n            elif isinstance(block, TocBlock):\n                p = doc.add_paragraph()\n                add_toc(p, max_level=block.max_level)\n            else:\n                raise RenderError(f\"Unsupported block type: {type(block)}\")\n\n        out = BytesIO()\n        doc.save(out)\n        return out.getvalue()\n    except Exception as e:\n        raise RenderError(f\"Word render failed: {e}\") from e\n\n\ndef _apply_styleset(doc: Document, styleset: str) -> None:\n    normal = doc.styles[\"Normal\"]\n    font = normal.font\n    if styleset == \"classic\":\n        font.name = \"Times New Roman\"\n        font.size = Pt(12)\n    else:\n        font.name = \"Calibri\"\n        font.size = Pt(11)\n\n\ndef _render_table(doc: Document, block: TableBlock) -> DocxTable:\n    ncols = len(block.columns)\n    nrows = 1 + len(block.rows) if block.header else len(block.rows)\n    table = doc.add_table(rows=nrows, cols=ncols)\n    table.style = block.style\n\n    row_offset = 0\n    if block.header:\n        hdr = table.rows[0].cells\n        for j, col in enumerate(block.columns):\n            hdr[j].text = str(col)\n        row_offset = 1\n\n    for i, row in enumerate(block.rows):\n        cells = table.rows[i + row_offset].cells\n        for j, val in enumerate(row):\n            cells[j].text = \"\" if val is None else str(val)\n\n    return table\n```\n\n---\n\n## FILE: `src/office_agent/validators/excel.py`\n```python\nfrom __future__ import annotations\n\nfrom io import BytesIO\nfrom openpyxl import load_workbook\n\nfrom ..errors import ValidationError\n\n\ndef validate_xlsx_bytes(data: bytes) -> None:\n    try:\n        wb = load_workbook(filename=BytesIO(data), data_only=False)\n        if not wb.sheetnames:\n            raise ValidationError(\"Workbook has no sheets\")\n    except Exception as e:\n        raise ValidationError(f\"Invalid XLSX output: {e}\") from e\n```\n\n---\n\n## FILE: `src/office_agent/validators/word.py`\n```python\nfrom __future__ import annotations\n\nfrom io import BytesIO\nfrom docx import Document\n\nfrom ..errors import ValidationError\n\n\ndef validate_docx_bytes(data: bytes) -> None:\n    try:\n        doc = Document(BytesIO(data))\n        _ = len(doc.paragraphs)\n    except Exception as e:\n        raise ValidationError(f\"Invalid DOCX output: {e}\") from e\n```\n\n---\n\n## FILE: `src/office_agent/quality/report.py`\n```python\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass, field\nfrom typing import List, Literal, Optional\n\nSeverity = Literal[\"error\", \"warning\"]\n\n\n@dataclass(frozen=True)\nclass QualityFinding:\n    severity: Severity\n    code: str\n    message: str\n    location: Optional[str] = None\n\n\n@dataclass\nclass QualityReport:\n    errors: List[QualityFinding] = field(default_factory=list)\n    warnings: List[QualityFinding] = field(default_factory=list)\n\n    def add(self, finding: QualityFinding) -> None:\n        if finding.severity == \"error\":\n            self.errors.append(finding)\n        else:\n            self.warnings.append(finding)\n\n    def to_dict(self) -> dict:\n        return {\n            \"errors\": [f.__dict__ for f in self.errors],\n            \"warnings\": [f.__dict__ for f in self.warnings],\n        }\n```\n\n---\n\n## FILE: `src/office_agent/quality/rules_excel.py`\n```python\nfrom __future__ import annotations\n\nfrom typing import Tuple, List\n\nfrom ..config import get_settings\nfrom ..schemas.excel import ExcelSpec, TableSpec\nfrom ..renderers.utils_excel import cell_to_rowcol\nfrom .report import QualityFinding, QualityReport\n\n_FORMULA_PREFIXES = (\"=\", \"+\", \"-\", \"@\")\n\n\ndef run_quality_gates_excel(spec: ExcelSpec) -> QualityReport:\n    s = get_settings()\n    report = QualityReport()\n\n    if len(spec.sheets) > s.max_sheets:\n        report.add(QualityFinding(\"error\", \"excel.too_many_sheets\",\n                                  f\"Too many sheets: {len(spec.sheets)} > {s.max_sheets}\"))\n\n    names = [sh.name.lower() for sh in spec.sheets]\n    if len(set(names)) != len(names):\n        report.add(QualityFinding(\"error\", \"excel.duplicate_sheet_names\",\n                                  \"Duplicate sheet names (case-insensitive) are not allowed.\"))\n\n    total_rows = 0\n    total_cells = 0\n    table_cells = 0\n\n    for sh in spec.sheets:\n        rects: List[Tuple[int, int, int, int, str]] = []\n        for idx, t in enumerate(sh.tables, start=1):\n            r = _table_rect(t)\n            rects.append((*r, f\"{sh.name}:table[{idx}]\"))\n\n        for i in range(len(rects)):\n            for j in range(i + 1, len(rects)):\n                if _rect_intersect(rects[i][:4], rects[j][:4]):\n                    report.add(QualityFinding(\"error\", \"excel.table_overlap\",\n                                              f\"Tables overlap: {rects[i][4]} intersects {rects[j][4]}\"))\n\n        for t in sh.tables:\n            total_rows += len(t.rows)\n            total_cells += (len(t.headers) * (1 + len(t.rows)))\n            table_cells += (len(t.headers) * (1 + len(t.rows)))\n\n            formula_headers = set(t.formulas.keys())\n            for row_i, row in enumerate(t.rows):\n                for col_i, val in enumerate(row):\n                    if isinstance(val, str) and val.startswith(_FORMULA_PREFIXES):\n                        header = t.headers[col_i]\n                        if header not in formula_headers:\n                            report.add(QualityFinding(\n                                \"warning\", \"excel.formula_like_text\",\n                                f\"Value looks like formula in sheet '{sh.name}', column '{header}', row {row_i+1}. \"\n                                \"It will be escaped as text.\",\n                                location=f\"{sh.name}:{t.start_cell}\",\n                            ))\n\n        total_cells += len(sh.cells)\n\n    if total_rows > s.max_total_rows:\n        report.add(QualityFinding(\"error\", \"excel.too_many_rows\",\n                                  f\"Total rows too large: {total_rows} > {s.max_total_rows}\"))\n\n    if total_cells > s.max_total_cells:\n        report.add(QualityFinding(\"error\", \"excel.too_many_cells\",\n                                  f\"Total cells too large: {total_cells} > {s.max_total_cells}\"))\n\n    if table_cells > s.max_table_cells:\n        report.add(QualityFinding(\"error\", \"excel.too_many_table_cells\",\n                                  f\"Total table cells too large: {table_cells} > {s.max_table_cells}\"))\n\n    return report\n\n\ndef _table_rect(t: TableSpec) -> Tuple[int, int, int, int]:\n    start_row, start_col = cell_to_rowcol(t.start_cell)\n    end_row = start_row + len(t.rows)\n    end_col = start_col + len(t.headers) - 1\n    return start_row, start_col, end_row, end_col\n\n\ndef _rect_intersect(a: Tuple[int, int, int, int], b: Tuple[int, int, int, int]) -> bool:\n    a_min_r, a_min_c, a_max_r, a_max_c = a\n    b_min_r, b_min_c, b_max_r, b_max_c = b\n    return not (a_max_r < b_min_r or b_max_r < a_min_r or a_max_c < b_min_c or b_max_c < a_min_c)\n```\n\n---\n\n## FILE: `src/office_agent/quality/rules_word.py`\n```python\nfrom __future__ import annotations\n\nfrom ..config import get_settings\nfrom ..schemas.word import DocSpec, ParagraphBlock, TableBlock, TitleBlock, TocBlock\nfrom .report import QualityFinding, QualityReport\n\n\ndef run_quality_gates_word(spec: DocSpec) -> QualityReport:\n    s = get_settings()\n    report = QualityReport()\n\n    if len(spec.blocks) > s.max_block_count:\n        report.add(QualityFinding(\"error\", \"word.too_many_blocks\",\n                                  f\"Too many blocks: {len(spec.blocks)} > {s.max_block_count}\"))\n\n    title_count = sum(1 for b in spec.blocks if isinstance(b, TitleBlock))\n    if title_count > 1:\n        report.add(QualityFinding(\"warning\", \"word.multiple_titles\",\n                                  f\"Document has {title_count} title blocks; usually it's 0 or 1.\"))\n\n    toc_positions = [i for i, b in enumerate(spec.blocks) if isinstance(b, TocBlock)]\n    if toc_positions and toc_positions[0] > 5:\n        report.add(QualityFinding(\"warning\", \"word.toc_late\",\n                                  \"TOC appears late; typical placement is near the top.\"))\n\n    table_cells = 0\n    for idx, b in enumerate(spec.blocks):\n        if isinstance(b, ParagraphBlock) and len(b.text) > s.max_text_len:\n            report.add(QualityFinding(\"error\", \"word.paragraph_too_long\",\n                                      f\"Paragraph block {idx} too long: {len(b.text)} > {s.max_text_len}\"))\n        if isinstance(b, TableBlock):\n            table_cells += (len(b.columns) * (len(b.rows) + (1 if b.header else 0)))\n\n    if table_cells > s.max_table_cells:\n        report.add(QualityFinding(\"error\", \"word.too_many_table_cells\",\n                                  f\"Too many table cells: {table_cells} > {s.max_table_cells}\"))\n\n    return report\n```\n\n---\n\n## FILE: `src/office_agent/llm/base.py`\n```python\nfrom __future__ import annotations\n\nfrom abc import ABC, abstractmethod\nfrom typing import List, Dict\n\n\nclass LLMClient(ABC):\n    \"\"\"Interfaz mínima para un LLM tipo chat.\"\"\"\n\n    @abstractmethod\n    def chat(self, messages: List[Dict[str, str]], *, temperature: float = 0.0) -> str:\n        raise NotImplementedError\n```\n\n---\n\n## FILE: `src/office_agent/llm/openai_compat.py`\n```python\nfrom __future__ import annotations\n\nfrom typing import Dict, List\nimport os\nimport requests\n\nfrom .base import LLMClient\n\n\nclass OpenAICompatibleChatLLM(LLMClient):\n    \"\"\"Cliente de Chat Completions estilo OpenAI-compatible.\n\n    POST {base_url}/chat/completions\n    payload: { model, messages, temperature, response_format? }\n    \"\"\"\n\n    def __init__(self, base_url: str, api_key: str, model: str):\n        self.base_url = base_url.rstrip(\"/\")\n        self.api_key = api_key\n        self.model = model\n\n    @classmethod\n    def from_env(cls) -> \"OpenAICompatibleChatLLM\":\n        base_url = os.getenv(\"OA_COMPAT_BASE_URL\", \"http://localhost:8001/v1\")\n        api_key = os.getenv(\"OA_COMPAT_API_KEY\", \"changeme\")\n        model = os.getenv(\"OA_COMPAT_MODEL\", \"gpt-4o-mini\")\n        return cls(base_url=base_url, api_key=api_key, model=model)\n\n    def chat(self, messages: List[Dict[str, str]], *, temperature: float = 0.0) -> str:\n        url = f\"{self.base_url}/chat/completions\"\n        headers = {\"Authorization\": f\"Bearer {self.api_key}\"}\n        payload = {\n            \"model\": self.model,\n            \"messages\": messages,\n            \"temperature\": temperature,\n            \"response_format\": {\"type\": \"json_object\"},\n        }\n        r = requests.post(url, json=payload, headers=headers, timeout=60)\n        r.raise_for_status()\n        data = r.json()\n        return data[\"choices\"][0][\"message\"][\"content\"]\n```\n\n---\n\n## FILE: `src/office_agent/llm/dummy.py`\n```python\nfrom __future__ import annotations\n\nimport json\nfrom typing import Dict, List\n\nfrom .base import LLMClient\n\n\nclass DummyLLM(LLMClient):\n    \"\"\"LLM determinista de demo: devuelve specs válidos pequeños.\"\"\"\n\n    def __init__(self, mode: str = \"excel\"):\n        self.mode = mode\n\n    def chat(self, messages: List[Dict[str, str]], *, temperature: float = 0.0) -> str:\n        user = next((m[\"content\"] for m in reversed(messages) if m[\"role\"] == \"user\"), \"\")\n        if \"word\" in user.lower() or self.mode == \"word\":\n            return json.dumps(_sample_doc_spec(), ensure_ascii=False)\n        return json.dumps(_sample_excel_spec(), ensure_ascii=False)\n\n\ndef _sample_excel_spec() -> dict:\n    return {\n        \"meta\": {\"title\": \"Reporte Demo\", \"author\": \"Office Agent Pro\"},\n        \"sheets\": [\n            {\n                \"name\": \"Resumen\",\n                \"tables\": [\n                    {\n                        \"name\": \"Ventas\",\n                        \"start_cell\": \"A1\",\n                        \"headers\": [\"Producto\", \"Unidades\", \"Precio\", \"Total\"],\n                        \"rows\": [\n                            [\"A\", 120, 9.99, None],\n                            [\"B\", 80, 14.5, None],\n                            [\"C\", 45, 22.0, None],\n                        ],\n                        \"number_formats\": {\"Precio\": \"$#,##0.00\", \"Total\": \"$#,##0.00\"},\n                        \"formulas\": {\"Total\": \"=B{row}*C{row}\"},\n                        \"style\": {\"table_style\": \"TableStyleMedium9\", \"header_bold\": True, \"header_fill\": \"D9E1F2\"},\n                        \"auto_filter\": True,\n                    }\n                ],\n                \"charts\": [\n                    {\"type\": \"bar\", \"title\": \"Unidades por producto\", \"data_range\": \"A1:B4\", \"position_cell\": \"F2\"}\n                ],\n                \"layout\": {\"freeze_panes\": \"A2\"},\n                \"cells\": [],\n            }\n        ],\n    }\n\n\ndef _sample_doc_spec() -> dict:\n    return {\n        \"meta\": {\"title\": \"Reporte Demo\", \"author\": \"Office Agent Pro\"},\n        \"styleset\": \"modern\",\n        \"blocks\": [\n            {\"type\": \"title\", \"text\": \"Reporte Demo\"},\n            {\"type\": \"toc\", \"max_level\": 3},\n            {\"type\": \"heading\", \"level\": 1, \"text\": \"Resumen\"},\n            {\"type\": \"paragraph\", \"text\": \"Documento generado desde JSON estricto.\"},\n            {\"type\": \"heading\", \"level\": 1, \"text\": \"Hallazgos\"},\n            {\"type\": \"bullets\", \"items\": [\"Salida determinística\", \"Validación post-render\", \"Gates de calidad\"]},\n            {\"type\": \"heading\", \"level\": 1, \"text\": \"Tabla\"},\n            {\n                \"type\": \"table\",\n                \"columns\": [\"Plan\", \"Precio\"],\n                \"rows\": [[\"Basic\", \"$999\"], [\"Pro\", \"$2,499\"]],\n                \"style\": \"Table Grid\",\n                \"header\": True,\n            },\n        ],\n    }\n```\n\n---\n\n## FILE: `src/office_agent/orchestrator/prompts.py`\n```python\nfrom __future__ import annotations\n\nEXCEL_SYSTEM = (\n    \"Eres un generador de JSON estrictos para ExcelSpec. \"\n    \"Devuelve SOLO JSON válido y nada más. \"\n    \"No inventes campos. Respeta el schema.\"\n)\n\nWORD_SYSTEM = (\n    \"Eres un generador de JSON estrictos para DocSpec (Word). \"\n    \"Devuelve SOLO JSON válido y nada más. \"\n    \"No inventes campos. Respeta el schema.\"\n)\n\nREPAIR_SYSTEM = (\n    \"Tu tarea es reparar un JSON inválido para que cumpla el schema. \"\n    \"Devuelve SOLO JSON válido. No incluyas explicaciones.\"\n)\n```\n\n---\n\n## FILE: `src/office_agent/orchestrator/repair.py`\n```python\nfrom __future__ import annotations\n\nfrom typing import Dict, List\n\nfrom ..llm.base import LLMClient\nfrom .prompts import REPAIR_SYSTEM\n\n\ndef repair_json(\n    llm: LLMClient,\n    *,\n    bad_json: str,\n    validation_error: str,\n    target: str,\n    user_prompt: str,\n) -> str:\n    messages: List[Dict[str, str]] = [\n        {\"role\": \"system\", \"content\": REPAIR_SYSTEM},\n        {\n            \"role\": \"user\",\n            \"content\": (\n                f\"Objetivo: reparar JSON para target={target}.\\n\"\n                f\"PROMPT ORIGINAL:\\n{user_prompt}\\n\\n\"\n                f\"JSON ACTUAL (inválido):\\n{bad_json}\\n\\n\"\n                f\"ERROR DE VALIDACIÓN:\\n{validation_error}\\n\\n\"\n                \"Devuelve únicamente el JSON corregido.\"\n            ),\n        },\n    ]\n    return llm.chat(messages, temperature=0.0)\n```\n\n---\n\n## FILE: `src/office_agent/orchestrator/agent.py`\n```python\nfrom __future__ import annotations\n\nfrom typing import Dict, List, Tuple\n\nfrom pydantic import ValidationError as PydanticValidationError\n\nfrom ..llm.base import LLMClient\nfrom ..schemas.excel import ExcelSpec\nfrom ..schemas.word import DocSpec\nfrom ..quality.rules_excel import run_quality_gates_excel\nfrom ..quality.rules_word import run_quality_gates_word\nfrom ..errors import SchemaValidationError, QualityGateError\nfrom .prompts import EXCEL_SYSTEM, WORD_SYSTEM\nfrom .repair import repair_json\n\n\ndef generate_excel_spec(prompt: str, llm: LLMClient, *, max_attempts: int = 3) -> Tuple[ExcelSpec, dict]:\n    json_text = _first_attempt(llm, system=EXCEL_SYSTEM, prompt=prompt)\n    spec = _validate_with_repairs_excel(prompt, llm, json_text, max_attempts=max_attempts)\n\n    q = run_quality_gates_excel(spec)\n    if q.errors:\n        raise QualityGateError(str(q.to_dict()))\n    return spec, q.to_dict()\n\n\ndef generate_word_spec(prompt: str, llm: LLMClient, *, max_attempts: int = 3) -> Tuple[DocSpec, dict]:\n    json_text = _first_attempt(llm, system=WORD_SYSTEM, prompt=prompt)\n    spec = _validate_with_repairs_word(prompt, llm, json_text, max_attempts=max_attempts)\n\n    q = run_quality_gates_word(spec)\n    if q.errors:\n        raise QualityGateError(str(q.to_dict()))\n    return spec, q.to_dict()\n\n\ndef _first_attempt(llm: LLMClient, *, system: str, prompt: str) -> str:\n    messages: List[Dict[str, str]] = [\n        {\"role\": \"system\", \"content\": system},\n        {\"role\": \"user\", \"content\": prompt},\n    ]\n    return llm.chat(messages, temperature=0.0)\n\n\ndef _validate_with_repairs_excel(prompt: str, llm: LLMClient, json_text: str, *, max_attempts: int) -> ExcelSpec:\n    current = json_text\n    last_error = None\n    for _ in range(max_attempts):\n        try:\n            return ExcelSpec.model_validate_json(current)\n        except PydanticValidationError as e:\n            last_error = str(e)\n            current = repair_json(llm, bad_json=current, validation_error=last_error, target=\"excel\", user_prompt=prompt)\n    raise SchemaValidationError(f\"ExcelSpec validation failed after {max_attempts} attempts: {last_error}\")\n\n\ndef _validate_with_repairs_word(prompt: str, llm: LLMClient, json_text: str, *, max_attempts: int) -> DocSpec:\n    current = json_text\n    last_error = None\n    for _ in range(max_attempts):\n        try:\n            return DocSpec.model_validate_json(current)\n        except PydanticValidationError as e:\n            last_error = str(e)\n            current = repair_json(llm, bad_json=current, validation_error=last_error, target=\"word\", user_prompt=prompt)\n    raise SchemaValidationError(f\"DocSpec validation failed after {max_attempts} attempts: {last_error}\")\n```\n\n---\n\n## FILE: `src/office_agent/api/app.py`\n```python\nfrom __future__ import annotations\n\nimport logging\nimport os\nimport uuid\nfrom typing import Any, Dict\n\nfrom fastapi import FastAPI, Request\nfrom fastapi.responses import JSONResponse, Response\n\nfrom ..config import get_settings\nfrom ..logging import setup_logging\nfrom ..schemas.excel import ExcelSpec\nfrom ..schemas.word import DocSpec\nfrom ..renderers.excel import render_excel_bytes\nfrom ..renderers.word import render_word_bytes\nfrom ..validators.excel import validate_xlsx_bytes\nfrom ..validators.word import validate_docx_bytes\nfrom ..quality.rules_excel import run_quality_gates_excel\nfrom ..quality.rules_word import run_quality_gates_word\nfrom ..llm.dummy import DummyLLM\nfrom ..llm.openai_compat import OpenAICompatibleChatLLM\nfrom ..orchestrator.agent import generate_excel_spec, generate_word_spec\n\nsetup_logging()\nlog = logging.getLogger(\"office_agent.api\")\n\nsettings = get_settings()\napp = FastAPI(title=settings.api_title, version=settings.api_version)\n\n\n@app.middleware(\"http\")\nasync def add_request_id(request: Request, call_next):\n    rid = request.headers.get(\"x-request-id\") or str(uuid.uuid4())\n    request.state.request_id = rid\n    response = await call_next(request)\n    response.headers[\"x-request-id\"] = rid\n    return response\n\n\n@app.get(\"/health\")\ndef health() -> Dict[str, str]:\n    return {\"status\": \"ok\"}\n\n\ndef _llm_from_env():\n    provider = os.getenv(\"OFFICE_AGENT_LLM_PROVIDER\", \"dummy\").lower()\n    if provider in (\"oa\", \"openai_compat\", \"openai-compatible\"):\n        return OpenAICompatibleChatLLM.from_env()\n    return DummyLLM()\n\n\n@app.post(\"/v1/render/excel\")\nasync def render_excel(spec: ExcelSpec) -> Response:\n    q = run_quality_gates_excel(spec)\n    if q.errors:\n        return JSONResponse(status_code=422, content={\"error\": \"quality_gate\", \"report\": q.to_dict()})\n\n    data = render_excel_bytes(spec)\n    validate_xlsx_bytes(data)\n\n    return Response(\n        content=data,\n        media_type=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n        headers={\"Content-Disposition\": 'attachment; filename=\"document.xlsx\"'},\n    )\n\n\n@app.post(\"/v1/render/word\")\nasync def render_word(spec: DocSpec) -> Response:\n    q = run_quality_gates_word(spec)\n    if q.errors:\n        return JSONResponse(status_code=422, content={\"error\": \"quality_gate\", \"report\": q.to_dict()})\n\n    data = render_word_bytes(spec)\n    validate_docx_bytes(data)\n\n    return Response(\n        content=data,\n        media_type=\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n        headers={\"Content-Disposition\": 'attachment; filename=\"document.docx\"'},\n    )\n\n\n@app.post(\"/v1/generate/excel\")\nasync def generate_excel(payload: Dict[str, Any]) -> Response:\n    prompt = str(payload.get(\"prompt\", \"\")).strip()\n    if not prompt:\n        return JSONResponse(status_code=422, content={\"error\": \"missing_prompt\"})\n\n    llm = _llm_from_env()\n    spec, _ = generate_excel_spec(prompt, llm, max_attempts=3)\n\n    data = render_excel_bytes(spec)\n    validate_xlsx_bytes(data)\n\n    return Response(\n        content=data,\n        media_type=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n        headers={\"Content-Disposition\": 'attachment; filename=\"generated.xlsx\"'},\n    )\n\n\n@app.post(\"/v1/generate/word\")\nasync def generate_word(payload: Dict[str, Any]) -> Response:\n    prompt = str(payload.get(\"prompt\", \"\")).strip()\n    if not prompt:\n        return JSONResponse(status_code=422, content={\"error\": \"missing_prompt\"})\n\n    llm = _llm_from_env()\n    spec, _ = generate_word_spec(prompt, llm, max_attempts=3)\n\n    data = render_word_bytes(spec)\n    validate_docx_bytes(data)\n\n    return Response(\n        content=data,\n        media_type=\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n        headers={\"Content-Disposition\": 'attachment; filename=\"generated.docx\"'},\n    )\n```\n\n---\n\n## FILE: `scripts/generate_demo.py`\n```python\nfrom __future__ import annotations\n\nfrom pathlib import Path\n\nfrom office_agent.llm.dummy import DummyLLM\nfrom office_agent.orchestrator.agent import generate_excel_spec, generate_word_spec\nfrom office_agent.renderers.excel import render_excel_bytes\nfrom office_agent.renderers.word import render_word_bytes\n\nfrom office_agent.validators.excel import validate_xlsx_bytes\nfrom office_agent.validators.word import validate_docx_bytes\n\nOUT = Path(\"out\")\nOUT.mkdir(exist_ok=True)\n\nprompt_excel = \"Genera un Excel de ventas con tabla y gráfico.\"\nprompt_word = \"Genera un Word con secciones y una tabla.\"\n\nllm = DummyLLM()\n\nexcel_spec, _ = generate_excel_spec(prompt_excel, llm)\nword_spec, _ = generate_word_spec(prompt_word, llm)\n\nxlsx = render_excel_bytes(excel_spec)\ndocx = render_word_bytes(word_spec)\n\nvalidate_xlsx_bytes(xlsx)\nvalidate_docx_bytes(docx)\n\n(OUT / \"report.xlsx\").write_bytes(xlsx)\n(OUT / \"report.docx\").write_bytes(docx)\n\nprint(\"Generated:\", OUT / \"report.xlsx\", OUT / \"report.docx\")\n```\n\n---\n\n## FILE: `scripts/validate_files.py`\n```python\nfrom __future__ import annotations\n\nimport sys\nfrom pathlib import Path\n\nfrom office_agent.validators.excel import validate_xlsx_bytes\nfrom office_agent.validators.word import validate_docx_bytes\n\npaths = [Path(p) for p in sys.argv[1:]]\nif not paths:\n    print(\"Usage: validate_files.py <file.xlsx> <file.docx> ...\")\n    raise SystemExit(2)\n\nfor p in paths:\n    if p.suffix.lower() == \".xlsx\":\n        validate_xlsx_bytes(p.read_bytes())\n        print(\"OK XLSX:\", p)\n    elif p.suffix.lower() == \".docx\":\n        validate_docx_bytes(p.read_bytes())\n        print(\"OK DOCX:\", p)\n    else:\n        print(\"Skip:\", p)\n```\n\n---\n\n## Cómo lo ejecuta tu programador (resumen)\n1) Instalar deps  \n2) `PYTHONPATH=src python scripts/generate_demo.py`  \n3) `PYTHONPATH=src uvicorn office_agent.api.app:app --port 8000`  \n4) Usar endpoints `/v1/render/*` o `/v1/generate/*`\n\n","path":null,"size_bytes":46209,"size_tokens":null},"server/services/documentQualityGates.ts":{"content":"import type { DocSpec, DocBlock, ExcelSpec, SheetSpec, TableSpec } from \"../../shared/documentSpecs\";\n\n// Severity levels for validation issues\nexport type Severity = \"error\" | \"warning\" | \"info\";\n\n// Validation issue structure\nexport interface ValidationIssue {\n  code: string;\n  message: string;\n  path: string;\n  severity: Severity;\n}\n\n// Quality report returned by validation functions\nexport interface QualityReport {\n  valid: boolean;\n  errors: Array<{ code: string; message: string; path: string }>;\n  warnings: Array<{ code: string; message: string; path: string }>;\n  info: Array<{ code: string; message: string; path: string }>;\n}\n\n// Error codes for DocSpec validation\nexport const DOC_ERROR_CODES = {\n  TOO_MANY_BLOCKS: \"DOC_E001\",\n  TOO_MANY_BULLETS: \"DOC_E002\",\n  TOO_MANY_TABLE_COLUMNS: \"DOC_E003\",\n  TOO_MANY_TABLE_ROWS: \"DOC_E004\",\n  INVALID_HEADING_LEVEL: \"DOC_E005\",\n  INVALID_TABLE_STYLE: \"DOC_E006\",\n  EMPTY_BLOCKS: \"DOC_E007\",\n  EMPTY_BULLET_ITEMS: \"DOC_E008\",\n  EMPTY_TABLE_COLUMNS: \"DOC_E009\",\n  MISMATCHED_ROW_LENGTH: \"DOC_E010\",\n} as const;\n\n// Warning codes for DocSpec validation\nexport const DOC_WARNING_CODES = {\n  MANY_BLOCKS: \"DOC_W001\",\n  MANY_BULLETS: \"DOC_W002\",\n  LARGE_TABLE: \"DOC_W003\",\n  NO_TITLE: \"DOC_W004\",\n  DEEP_HEADING: \"DOC_W005\",\n  MULTIPLE_TITLES: \"DOC_W006\",\n  TOC_LATE: \"DOC_W007\",\n} as const;\n\n// Error codes for ExcelSpec validation\nexport const EXCEL_ERROR_CODES = {\n  TOO_MANY_SHEETS: \"EXCEL_E001\",\n  TOO_MANY_CELLS: \"EXCEL_E002\",\n  TOO_MANY_TABLE_ROWS: \"EXCEL_E003\",\n  TOO_MANY_TABLE_COLUMNS: \"EXCEL_E004\",\n  INVALID_COLUMN_FORMAT: \"EXCEL_E005\",\n  INVALID_SHEET_NAME: \"EXCEL_E006\",\n  INVALID_ANCHOR: \"EXCEL_E007\",\n  EMPTY_SHEETS: \"EXCEL_E008\",\n  EMPTY_TABLE_HEADERS: \"EXCEL_E009\",\n  MISMATCHED_ROW_LENGTH: \"EXCEL_E010\",\n  INVALID_CHART_RANGE: \"EXCEL_E011\",\n  CHART_RANGE_OUT_OF_BOUNDS: \"EXCEL_E012\",\n} as const;\n\n// Warning codes for ExcelSpec validation\nexport const EXCEL_WARNING_CODES = {\n  MANY_SHEETS: \"EXCEL_W001\",\n  MANY_CELLS: \"EXCEL_W002\",\n  LARGE_TABLE: \"EXCEL_W003\",\n  NO_WORKBOOK_TITLE: \"EXCEL_W004\",\n  DUPLICATE_SHEET_NAMES: \"EXCEL_W005\",\n  TABLE_OVERLAP: \"EXCEL_W006\",\n  FORMULA_LIKE_TEXT: \"EXCEL_W007\",\n} as const;\n\n// Limits for DoS protection\nexport const DOC_LIMITS = {\n  MAX_BLOCKS: 100,\n  MAX_BULLET_ITEMS_TOTAL: 500,\n  MAX_TABLE_COLUMNS: 26,\n  MAX_TABLE_ROWS: 1000,\n  MIN_HEADING_LEVEL: 1,\n  MAX_HEADING_LEVEL: 6,\n  // Warning thresholds\n  WARN_BLOCKS: 75,\n  WARN_BULLET_ITEMS: 300,\n  WARN_TABLE_ROWS: 500,\n} as const;\n\nexport const EXCEL_LIMITS = {\n  MAX_SHEETS: 50,\n  MAX_CELLS_PER_SHEET: 100000,\n  MAX_TABLE_ROWS: 500,\n  MAX_TABLE_COLUMNS: 26,\n  MAX_SHEET_NAME_LENGTH: 31,\n  // Warning thresholds\n  WARN_SHEETS: 30,\n  WARN_CELLS_PER_SHEET: 50000,\n  WARN_TABLE_ROWS: 300,\n} as const;\n\n// Valid Word table styles\nconst VALID_WORD_TABLE_STYLES = new Set([\n  \"Table Grid\",\n  \"Light Shading\",\n  \"Light Shading Accent 1\",\n  \"Light Shading Accent 2\",\n  \"Light Shading Accent 3\",\n  \"Light Shading Accent 4\",\n  \"Light Shading Accent 5\",\n  \"Light Shading Accent 6\",\n  \"Light List\",\n  \"Light Grid\",\n  \"Medium Shading 1\",\n  \"Medium Shading 2\",\n  \"Medium List 1\",\n  \"Medium List 2\",\n  \"Medium Grid 1\",\n  \"Medium Grid 2\",\n  \"Medium Grid 3\",\n  \"Dark List\",\n  \"Colorful Shading\",\n  \"Colorful List\",\n  \"Colorful Grid\",\n]);\n\n// Valid Excel number formats\nconst VALID_EXCEL_FORMATS = new Set([\n  \"General\",\n  \"0\",\n  \"0.00\",\n  \"#,##0\",\n  \"#,##0.00\",\n  \"0%\",\n  \"0.00%\",\n  \"$#,##0\",\n  \"$#,##0.00\",\n  \"mm/dd/yyyy\",\n  \"dd/mm/yyyy\",\n  \"yyyy-mm-dd\",\n  \"h:mm AM/PM\",\n  \"h:mm:ss AM/PM\",\n  \"m/d/yy h:mm\",\n  \"@\", // Text format\n]);\n\n// Cell reference validation regex\nconst CELL_REFERENCE_REGEX = /^[A-Z]{1,3}[1-9][0-9]*$/i;\nconst RANGE_REGEX = /^[A-Z]{1,3}[1-9][0-9]*:[A-Z]{1,3}[1-9][0-9]*$/i;\n\nfunction createIssue(\n  code: string,\n  message: string,\n  path: string,\n  severity: Severity\n): ValidationIssue {\n  return { code, message, path, severity };\n}\n\nfunction isValidCellReference(ref: string): boolean {\n  return CELL_REFERENCE_REGEX.test(ref);\n}\n\nfunction isValidRange(range: string): boolean {\n  return RANGE_REGEX.test(range);\n}\n\ninterface TableBoundingBox {\n  tableIndex: number;\n  minRow: number;\n  maxRow: number;\n  minCol: number;\n  maxCol: number;\n}\n\nfunction parseCellReferenceToCoords(ref: string): { row: number; col: number } | null {\n  const match = ref.match(/^([A-Z]+)(\\d+)$/i);\n  if (!match) return null;\n\n  const colStr = match[1].toUpperCase();\n  const rowNum = parseInt(match[2], 10);\n\n  // Convert column letters to 0-based index (A=0, B=1, ..., Z=25, AA=26, etc.)\n  let col = 0;\n  for (let i = 0; i < colStr.length; i++) {\n    col = col * 26 + (colStr.charCodeAt(i) - 64);\n  }\n  col -= 1; // Convert to 0-based\n\n  return { row: rowNum, col };\n}\n\nfunction getTableBoundingBox(table: TableSpec, tableIndex: number): TableBoundingBox | null {\n  const anchorCoords = parseCellReferenceToCoords(table.anchor);\n  if (!anchorCoords) return null;\n\n  const headers = table.headers || [];\n  const rows = table.rows || [];\n\n  return {\n    tableIndex,\n    minRow: anchorCoords.row,\n    maxRow: anchorCoords.row + rows.length, // +1 for header row is included since anchor is row 1\n    minCol: anchorCoords.col,\n    maxCol: anchorCoords.col + headers.length - 1,\n  };\n}\n\nfunction tablesOverlap(a: TableBoundingBox, b: TableBoundingBox): boolean {\n  // Two rectangles do NOT overlap if one is completely to the left, right, above, or below the other\n  // They overlap if: !(a.maxRow < b.minRow || b.maxRow < a.minRow || a.maxCol < b.minCol || b.maxCol < a.minCol)\n  return !(a.maxRow < b.minRow || b.maxRow < a.minRow || a.maxCol < b.minCol || b.maxCol < a.minCol);\n}\n\nfunction parseRangeToCoords(range: string): { start: { row: number; col: number }; end: { row: number; col: number } } | null {\n  const parts = range.split(\":\");\n  if (parts.length !== 2) return null;\n  \n  const start = parseCellReferenceToCoords(parts[0].trim());\n  const end = parseCellReferenceToCoords(parts[1].trim());\n  \n  if (!start || !end) return null;\n  return { start, end };\n}\n\nfunction isRangeWithinTableBounds(range: string, tables: TableSpec[]): { valid: boolean; reason: string } {\n  const rangeCoords = parseRangeToCoords(range);\n  if (!rangeCoords) {\n    return { valid: false, reason: \"invalid range format\" };\n  }\n\n  for (const table of tables) {\n    const anchorCoords = parseCellReferenceToCoords(table.anchor);\n    if (!anchorCoords) continue;\n\n    const headers = table.headers || [];\n    const rows = table.rows || [];\n\n    const tableMinRow = anchorCoords.row;\n    const tableMaxRow = anchorCoords.row + rows.length;\n    const tableMinCol = anchorCoords.col;\n    const tableMaxCol = anchorCoords.col + headers.length - 1;\n\n    if (\n      rangeCoords.start.row >= tableMinRow &&\n      rangeCoords.end.row <= tableMaxRow &&\n      rangeCoords.start.col >= tableMinCol &&\n      rangeCoords.end.col <= tableMaxCol\n    ) {\n      return { valid: true, reason: \"\" };\n    }\n  }\n\n  return { valid: false, reason: \"range extends beyond all table boundaries\" };\n}\n\nfunction isFormulaLikeText(value: unknown): boolean {\n  if (typeof value !== \"string\") return false;\n  const trimmed = value.trim();\n  if (trimmed.length === 0) return false;\n  const firstChar = trimmed[0];\n  return firstChar === \"=\" || firstChar === \"+\" || firstChar === \"-\" || firstChar === \"@\";\n}\n\n/**\n * Validates a DocSpec for Word document generation\n */\nexport function validateDocSpec(spec: DocSpec): QualityReport {\n  const issues: ValidationIssue[] = [];\n  const blocks = spec.blocks || [];\n\n  // Check total blocks\n  if (blocks.length > DOC_LIMITS.MAX_BLOCKS) {\n    issues.push(\n      createIssue(\n        DOC_ERROR_CODES.TOO_MANY_BLOCKS,\n        `Document has ${blocks.length} blocks, maximum allowed is ${DOC_LIMITS.MAX_BLOCKS}`,\n        \"blocks\",\n        \"error\"\n      )\n    );\n  } else if (blocks.length > DOC_LIMITS.WARN_BLOCKS) {\n    issues.push(\n      createIssue(\n        DOC_WARNING_CODES.MANY_BLOCKS,\n        `Document has ${blocks.length} blocks, consider splitting into multiple documents`,\n        \"blocks\",\n        \"warning\"\n      )\n    );\n  }\n\n  if (blocks.length === 0) {\n    issues.push(\n      createIssue(\n        DOC_ERROR_CODES.EMPTY_BLOCKS,\n        \"Document has no content blocks\",\n        \"blocks\",\n        \"error\"\n      )\n    );\n  }\n\n  // Check title\n  if (!spec.title || spec.title.trim() === \"\") {\n    issues.push(\n      createIssue(\n        DOC_WARNING_CODES.NO_TITLE,\n        \"Document has no title specified\",\n        \"title\",\n        \"warning\"\n      )\n    );\n  }\n\n  // Count total bullet items and validate blocks\n  let totalBulletItems = 0;\n\n  blocks.forEach((block, index) => {\n    const blockPath = `blocks[${index}]`;\n\n    switch (block.type) {\n      case \"heading\":\n        if (block.level < DOC_LIMITS.MIN_HEADING_LEVEL || block.level > DOC_LIMITS.MAX_HEADING_LEVEL) {\n          issues.push(\n            createIssue(\n              DOC_ERROR_CODES.INVALID_HEADING_LEVEL,\n              `Heading level ${block.level} is invalid, must be between 1 and 6`,\n              `${blockPath}.level`,\n              \"error\"\n            )\n          );\n        } else if (block.level >= 5) {\n          issues.push(\n            createIssue(\n              DOC_WARNING_CODES.DEEP_HEADING,\n              `Heading level ${block.level} is very deep, consider restructuring`,\n              `${blockPath}.level`,\n              \"warning\"\n            )\n          );\n        }\n        break;\n\n      case \"bullets\":\n        const items = block.items || [];\n        totalBulletItems += items.length;\n        if (items.length === 0) {\n          issues.push(\n            createIssue(\n              DOC_ERROR_CODES.EMPTY_BULLET_ITEMS,\n              \"Bullet block has no items\",\n              `${blockPath}.items`,\n              \"error\"\n            )\n          );\n        }\n        break;\n\n      case \"table\":\n        const columns = block.columns || [];\n        const rows = block.rows || [];\n\n        if (columns.length === 0) {\n          issues.push(\n            createIssue(\n              DOC_ERROR_CODES.EMPTY_TABLE_COLUMNS,\n              \"Table has no columns defined\",\n              `${blockPath}.columns`,\n              \"error\"\n            )\n          );\n        }\n\n        if (columns.length > DOC_LIMITS.MAX_TABLE_COLUMNS) {\n          issues.push(\n            createIssue(\n              DOC_ERROR_CODES.TOO_MANY_TABLE_COLUMNS,\n              `Table has ${columns.length} columns, maximum allowed is ${DOC_LIMITS.MAX_TABLE_COLUMNS}`,\n              `${blockPath}.columns`,\n              \"error\"\n            )\n          );\n        }\n\n        if (rows.length > DOC_LIMITS.MAX_TABLE_ROWS) {\n          issues.push(\n            createIssue(\n              DOC_ERROR_CODES.TOO_MANY_TABLE_ROWS,\n              `Table has ${rows.length} rows, maximum allowed is ${DOC_LIMITS.MAX_TABLE_ROWS}`,\n              `${blockPath}.rows`,\n              \"error\"\n            )\n          );\n        } else if (rows.length > DOC_LIMITS.WARN_TABLE_ROWS) {\n          issues.push(\n            createIssue(\n              DOC_WARNING_CODES.LARGE_TABLE,\n              `Table has ${rows.length} rows, consider pagination`,\n              `${blockPath}.rows`,\n              \"warning\"\n            )\n          );\n        }\n\n        // Validate row lengths match column count\n        rows.forEach((row, rowIndex) => {\n          if (Array.isArray(row) && row.length !== columns.length) {\n            issues.push(\n              createIssue(\n                DOC_ERROR_CODES.MISMATCHED_ROW_LENGTH,\n                `Row ${rowIndex} has ${row.length} cells but table has ${columns.length} columns`,\n                `${blockPath}.rows[${rowIndex}]`,\n                \"error\"\n              )\n            );\n          }\n        });\n\n        // Validate table style\n        if (block.style && !VALID_WORD_TABLE_STYLES.has(block.style)) {\n          issues.push(\n            createIssue(\n              DOC_ERROR_CODES.INVALID_TABLE_STYLE,\n              `Unknown table style \"${block.style}\"`,\n              `${blockPath}.style`,\n              \"warning\"\n            )\n          );\n        }\n        break;\n    }\n  });\n\n  // Check total bullet items\n  if (totalBulletItems > DOC_LIMITS.MAX_BULLET_ITEMS_TOTAL) {\n    issues.push(\n      createIssue(\n        DOC_ERROR_CODES.TOO_MANY_BULLETS,\n        `Document has ${totalBulletItems} total bullet items, maximum allowed is ${DOC_LIMITS.MAX_BULLET_ITEMS_TOTAL}`,\n        \"blocks\",\n        \"error\"\n      )\n    );\n  } else if (totalBulletItems > DOC_LIMITS.WARN_BULLET_ITEMS) {\n    issues.push(\n      createIssue(\n        DOC_WARNING_CODES.MANY_BULLETS,\n        `Document has ${totalBulletItems} bullet items, consider grouping or summarizing`,\n        \"blocks\",\n        \"warning\"\n      )\n    );\n  }\n\n  // Check for multiple title blocks (should only have 0 or 1)\n  const titleBlocks = blocks.filter((block) => block.type === \"title\");\n  if (titleBlocks.length > 1) {\n    issues.push(\n      createIssue(\n        DOC_WARNING_CODES.MULTIPLE_TITLES,\n        `Document has ${titleBlocks.length} title blocks, should have at most 1`,\n        \"blocks\",\n        \"warning\"\n      )\n    );\n  }\n\n  // Check TOC placement (should be near the top, within first 5 blocks)\n  const tocBlockIndex = blocks.findIndex((block) => block.type === \"toc\");\n  if (tocBlockIndex > 4) {\n    issues.push(\n      createIssue(\n        DOC_WARNING_CODES.TOC_LATE,\n        `Table of contents appears at block ${tocBlockIndex + 1}, should be within first 5 blocks`,\n        `blocks[${tocBlockIndex}]`,\n        \"warning\"\n      )\n    );\n  }\n\n  return buildReport(issues);\n}\n\n/**\n * Validates an ExcelSpec for Excel workbook generation\n */\nexport function validateExcelSpec(spec: ExcelSpec): QualityReport {\n  const issues: ValidationIssue[] = [];\n  const sheets = spec.sheets || [];\n\n  // Check workbook title\n  if (!spec.workbook_title || spec.workbook_title.trim() === \"\") {\n    issues.push(\n      createIssue(\n        EXCEL_WARNING_CODES.NO_WORKBOOK_TITLE,\n        \"Workbook has no title specified\",\n        \"workbook_title\",\n        \"warning\"\n      )\n    );\n  }\n\n  // Check sheet count\n  if (sheets.length === 0) {\n    issues.push(\n      createIssue(\n        EXCEL_ERROR_CODES.EMPTY_SHEETS,\n        \"Workbook has no sheets\",\n        \"sheets\",\n        \"error\"\n      )\n    );\n  }\n\n  if (sheets.length > EXCEL_LIMITS.MAX_SHEETS) {\n    issues.push(\n      createIssue(\n        EXCEL_ERROR_CODES.TOO_MANY_SHEETS,\n        `Workbook has ${sheets.length} sheets, maximum allowed is ${EXCEL_LIMITS.MAX_SHEETS}`,\n        \"sheets\",\n        \"error\"\n      )\n    );\n  } else if (sheets.length > EXCEL_LIMITS.WARN_SHEETS) {\n    issues.push(\n      createIssue(\n        EXCEL_WARNING_CODES.MANY_SHEETS,\n        `Workbook has ${sheets.length} sheets, consider splitting into multiple workbooks`,\n        \"sheets\",\n        \"warning\"\n      )\n    );\n  }\n\n  // Check for duplicate sheet names\n  const sheetNames = new Set<string>();\n  sheets.forEach((sheet, index) => {\n    const normalizedName = sheet.name.toLowerCase();\n    if (sheetNames.has(normalizedName)) {\n      issues.push(\n        createIssue(\n          EXCEL_WARNING_CODES.DUPLICATE_SHEET_NAMES,\n          `Duplicate sheet name \"${sheet.name}\"`,\n          `sheets[${index}].name`,\n          \"warning\"\n        )\n      );\n    }\n    sheetNames.add(normalizedName);\n  });\n\n  // Validate each sheet\n  sheets.forEach((sheet, sheetIndex) => {\n    validateSheet(sheet, sheetIndex, issues);\n  });\n\n  return buildReport(issues);\n}\n\nfunction validateSheet(sheet: SheetSpec, sheetIndex: number, issues: ValidationIssue[]): void {\n  const sheetPath = `sheets[${sheetIndex}]`;\n\n  // Validate sheet name\n  if (!sheet.name || sheet.name.trim() === \"\") {\n    issues.push(\n      createIssue(\n        EXCEL_ERROR_CODES.INVALID_SHEET_NAME,\n        \"Sheet name is empty\",\n        `${sheetPath}.name`,\n        \"error\"\n      )\n    );\n  } else if (sheet.name.length > EXCEL_LIMITS.MAX_SHEET_NAME_LENGTH) {\n    issues.push(\n      createIssue(\n        EXCEL_ERROR_CODES.INVALID_SHEET_NAME,\n        `Sheet name \"${sheet.name}\" exceeds ${EXCEL_LIMITS.MAX_SHEET_NAME_LENGTH} characters`,\n        `${sheetPath}.name`,\n        \"error\"\n      )\n    );\n  } else if (/[\\\\/:*?\\[\\]]/.test(sheet.name)) {\n    issues.push(\n      createIssue(\n        EXCEL_ERROR_CODES.INVALID_SHEET_NAME,\n        `Sheet name \"${sheet.name}\" contains invalid characters`,\n        `${sheetPath}.name`,\n        \"error\"\n      )\n    );\n  }\n\n  // Calculate total cells in sheet\n  let totalCells = 0;\n  const tables = sheet.tables || [];\n\n  tables.forEach((table, tableIndex) => {\n    const tablePath = `${sheetPath}.tables[${tableIndex}]`;\n    const headers = table.headers || [];\n    const rows = table.rows || [];\n\n    // Validate anchor\n    if (!table.anchor || !isValidCellReference(table.anchor)) {\n      issues.push(\n        createIssue(\n          EXCEL_ERROR_CODES.INVALID_ANCHOR,\n          `Invalid table anchor \"${table.anchor}\"`,\n          `${tablePath}.anchor`,\n          \"error\"\n        )\n      );\n    }\n\n    // Validate headers\n    if (headers.length === 0) {\n      issues.push(\n        createIssue(\n          EXCEL_ERROR_CODES.EMPTY_TABLE_HEADERS,\n          \"Table has no headers defined\",\n          `${tablePath}.headers`,\n          \"error\"\n        )\n      );\n    }\n\n    // Check column count\n    if (headers.length > EXCEL_LIMITS.MAX_TABLE_COLUMNS) {\n      issues.push(\n        createIssue(\n          EXCEL_ERROR_CODES.TOO_MANY_TABLE_COLUMNS,\n          `Table has ${headers.length} columns, maximum allowed is ${EXCEL_LIMITS.MAX_TABLE_COLUMNS}`,\n          `${tablePath}.headers`,\n          \"error\"\n        )\n      );\n    }\n\n    // Check row count\n    if (rows.length > EXCEL_LIMITS.MAX_TABLE_ROWS) {\n      issues.push(\n        createIssue(\n          EXCEL_ERROR_CODES.TOO_MANY_TABLE_ROWS,\n          `Table has ${rows.length} rows, maximum allowed is ${EXCEL_LIMITS.MAX_TABLE_ROWS}`,\n          `${tablePath}.rows`,\n          \"error\"\n        )\n      );\n    } else if (rows.length > EXCEL_LIMITS.WARN_TABLE_ROWS) {\n      issues.push(\n        createIssue(\n          EXCEL_WARNING_CODES.LARGE_TABLE,\n          `Table has ${rows.length} rows, performance may be impacted`,\n          `${tablePath}.rows`,\n          \"warning\"\n        )\n      );\n    }\n\n    // Validate row lengths match header count\n    rows.forEach((row, rowIndex) => {\n      if (Array.isArray(row) && row.length !== headers.length) {\n        issues.push(\n          createIssue(\n            EXCEL_ERROR_CODES.MISMATCHED_ROW_LENGTH,\n            `Row ${rowIndex} has ${row.length} cells but table has ${headers.length} headers`,\n            `${tablePath}.rows[${rowIndex}]`,\n            \"error\"\n          )\n        );\n      }\n    });\n\n    // Validate column formats\n    if (table.column_formats) {\n      for (const [header, format] of Object.entries(table.column_formats)) {\n        if (!headers.includes(header)) {\n          issues.push(\n            createIssue(\n              EXCEL_ERROR_CODES.INVALID_COLUMN_FORMAT,\n              `Column format specified for unknown header \"${header}\"`,\n              `${tablePath}.column_formats.${header}`,\n              \"warning\"\n            )\n          );\n        }\n        // Note: We allow custom formats, but warn about unrecognized ones\n        if (!VALID_EXCEL_FORMATS.has(format) && !format.includes(\"#\") && !format.includes(\"0\")) {\n          issues.push(\n            createIssue(\n              EXCEL_ERROR_CODES.INVALID_COLUMN_FORMAT,\n              `Unrecognized column format \"${format}\" for header \"${header}\"`,\n              `${tablePath}.column_formats.${header}`,\n              \"warning\"\n            )\n          );\n        }\n      }\n    }\n\n    // Calculate cells for this table\n    totalCells += headers.length * (rows.length + 1); // +1 for header row\n  });\n\n  // Check total cells per sheet\n  if (totalCells > EXCEL_LIMITS.MAX_CELLS_PER_SHEET) {\n    issues.push(\n      createIssue(\n        EXCEL_ERROR_CODES.TOO_MANY_CELLS,\n        `Sheet \"${sheet.name}\" has approximately ${totalCells} cells, maximum allowed is ${EXCEL_LIMITS.MAX_CELLS_PER_SHEET}`,\n        `${sheetPath}`,\n        \"error\"\n      )\n    );\n  } else if (totalCells > EXCEL_LIMITS.WARN_CELLS_PER_SHEET) {\n    issues.push(\n      createIssue(\n        EXCEL_WARNING_CODES.MANY_CELLS,\n        `Sheet \"${sheet.name}\" has approximately ${totalCells} cells, generation may be slow`,\n        `${sheetPath}`,\n        \"warning\"\n      )\n    );\n  }\n\n  // Validate charts\n  const charts = sheet.charts || [];\n  charts.forEach((chart, chartIndex) => {\n    const chartPath = `${sheetPath}.charts[${chartIndex}]`;\n\n    if (chart.categories_range && !isValidRange(chart.categories_range)) {\n      issues.push(\n        createIssue(\n          EXCEL_ERROR_CODES.INVALID_CHART_RANGE,\n          `Invalid categories range \"${chart.categories_range}\"`,\n          `${chartPath}.categories_range`,\n          \"error\"\n        )\n      );\n    }\n\n    if (chart.values_range && !isValidRange(chart.values_range)) {\n      issues.push(\n        createIssue(\n          EXCEL_ERROR_CODES.INVALID_CHART_RANGE,\n          `Invalid values range \"${chart.values_range}\"`,\n          `${chartPath}.values_range`,\n          \"error\"\n        )\n      );\n    }\n\n    if (chart.position && !isValidCellReference(chart.position)) {\n      issues.push(\n        createIssue(\n          EXCEL_ERROR_CODES.INVALID_CHART_RANGE,\n          `Invalid chart position \"${chart.position}\"`,\n          `${chartPath}.position`,\n          \"warning\"\n        )\n      );\n    }\n\n    // Range consistency: verify chart ranges reference cells within table data\n    if (tables.length > 0) {\n      if (chart.categories_range) {\n        const catBoundsCheck = isRangeWithinTableBounds(chart.categories_range, tables);\n        if (!catBoundsCheck.valid) {\n          issues.push(\n            createIssue(\n              EXCEL_ERROR_CODES.CHART_RANGE_OUT_OF_BOUNDS,\n              `Chart categories_range \"${chart.categories_range}\" extends beyond table data (${catBoundsCheck.reason})`,\n              `${chartPath}.categories_range`,\n              \"error\"\n            )\n          );\n        }\n      }\n\n      if (chart.values_range) {\n        const valBoundsCheck = isRangeWithinTableBounds(chart.values_range, tables);\n        if (!valBoundsCheck.valid) {\n          issues.push(\n            createIssue(\n              EXCEL_ERROR_CODES.CHART_RANGE_OUT_OF_BOUNDS,\n              `Chart values_range \"${chart.values_range}\" extends beyond table data (${valBoundsCheck.reason})`,\n              `${chartPath}.values_range`,\n              \"error\"\n            )\n          );\n        }\n      }\n    }\n  });\n\n  // Table overlap detection\n  const tableBoundingBoxes: TableBoundingBox[] = [];\n  tables.forEach((table, tableIndex) => {\n    const bbox = getTableBoundingBox(table, tableIndex);\n    if (bbox) {\n      tableBoundingBoxes.push(bbox);\n    }\n  });\n\n  // Check each pair of tables for overlap\n  for (let i = 0; i < tableBoundingBoxes.length; i++) {\n    for (let j = i + 1; j < tableBoundingBoxes.length; j++) {\n      const boxA = tableBoundingBoxes[i];\n      const boxB = tableBoundingBoxes[j];\n      if (tablesOverlap(boxA, boxB)) {\n        issues.push(\n          createIssue(\n            EXCEL_WARNING_CODES.TABLE_OVERLAP,\n            `Tables ${boxA.tableIndex + 1} and ${boxB.tableIndex + 1} overlap in sheet \"${sheet.name}\"`,\n            `${sheetPath}.tables`,\n            \"warning\"\n          )\n        );\n      }\n    }\n  }\n\n  // Formula-like text warnings (warn when cell values start with =, +, -, @)\n  tables.forEach((table, tableIndex) => {\n    const tablePath = `${sheetPath}.tables[${tableIndex}]`;\n    const rows = table.rows || [];\n\n    rows.forEach((row, rowIndex) => {\n      if (Array.isArray(row)) {\n        row.forEach((cell, cellIndex) => {\n          if (isFormulaLikeText(cell)) {\n            issues.push(\n              createIssue(\n                EXCEL_WARNING_CODES.FORMULA_LIKE_TEXT,\n                `Value \"${String(cell).substring(0, 20)}${String(cell).length > 20 ? \"...\" : \"\"}\" looks like a formula in data cell`,\n                `${tablePath}.rows[${rowIndex}][${cellIndex}]`,\n                \"warning\"\n              )\n            );\n          }\n        });\n      }\n    });\n  });\n}\n\nfunction buildReport(issues: ValidationIssue[]): QualityReport {\n  const errors = issues\n    .filter((i) => i.severity === \"error\")\n    .map(({ code, message, path }) => ({ code, message, path }));\n  \n  const warnings = issues\n    .filter((i) => i.severity === \"warning\")\n    .map(({ code, message, path }) => ({ code, message, path }));\n  \n  const info = issues\n    .filter((i) => i.severity === \"info\")\n    .map(({ code, message, path }) => ({ code, message, path }));\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n    info,\n  };\n}\n","path":null,"size_bytes":24745,"size_tokens":null},"server/services/richText/latexMath.ts":{"content":"import { Math as DocxMath } from \"docx\";\n\ntype MathElement = ReturnType<typeof import(\"@hungknguyen/docx-math-converter\").convertLatex2Math>;\n\nlet convertLatex2Math: ((latex: string) => MathElement) | null = null;\nlet mathJaxReady: (() => Promise<boolean>) | null = null;\nlet converterInitialized = false;\n\nasync function loadConverter(): Promise<void> {\n  if (converterInitialized) return;\n  converterInitialized = true;\n  \n  try {\n    const converter = await import(\"@hungknguyen/docx-math-converter\");\n    convertLatex2Math = converter.convertLatex2Math;\n    mathJaxReady = converter.mathJaxReady;\n    \n    if (mathJaxReady) {\n      await mathJaxReady();\n      console.log(\"[latexMath] MathJax initialized successfully\");\n    }\n  } catch (err) {\n    console.warn(\"[latexMath] Failed to load converter:\", err);\n    convertLatex2Math = null;\n    mathJaxReady = null;\n  }\n}\n\nexport async function createMathFromLatex(latex: string): Promise<DocxMath | null> {\n  await loadConverter();\n  \n  if (convertLatex2Math) {\n    try {\n      const mathElement = convertLatex2Math(latex);\n      if (mathElement) {\n        return mathElement as unknown as DocxMath;\n      }\n    } catch (err) {\n      console.warn(\"[latexMath] Failed to convert LaTeX:\", latex, err);\n    }\n  }\n  \n  return null;\n}\n\nexport async function createMathPlaceholder(latex: string): Promise<DocxMath | null> {\n  return createMathFromLatex(latex);\n}\n","path":null,"size_bytes":1410,"size_tokens":null},"server/services/richText/markdownTokenizer.ts":{"content":"export interface RichTextToken {\n  text: string;\n  bold?: boolean;\n  italic?: boolean;\n  code?: boolean;\n  link?: string;\n  isMath?: boolean;\n}\n\ninterface TokenPattern {\n  regex: RegExp;\n  handler: (match: RegExpExecArray) => RichTextToken;\n}\n\nconst patterns: TokenPattern[] = [\n  {\n    regex: /\\$\\$(.+?)\\$\\$/,\n    handler: (match) => ({ text: match[1], isMath: true }),\n  },\n  {\n    regex: /\\$(.+?)\\$/,\n    handler: (match) => ({ text: match[1], isMath: true }),\n  },\n  {\n    regex: /\\*\\*\\*(.+?)\\*\\*\\*/,\n    handler: (match) => ({ text: match[1], bold: true, italic: true }),\n  },\n  {\n    regex: /\\*\\*(.+?)\\*\\*/,\n    handler: (match) => ({ text: match[1], bold: true }),\n  },\n  {\n    regex: /\\*(.+?)\\*/,\n    handler: (match) => ({ text: match[1], italic: true }),\n  },\n  {\n    regex: /__(.+?)__/,\n    handler: (match) => ({ text: match[1], bold: true }),\n  },\n  {\n    regex: /_(.+?)_/,\n    handler: (match) => ({ text: match[1], italic: true }),\n  },\n  {\n    regex: /`(.+?)`/,\n    handler: (match) => ({ text: match[1], code: true }),\n  },\n  {\n    regex: /\\[([^\\]]+)\\]\\(([^)]+)\\)/,\n    handler: (match) => ({ text: match[1], link: match[2] }),\n  },\n];\n\nexport function tokenizeMarkdown(text: string): RichTextToken[] {\n  if (!text || typeof text !== \"string\") {\n    return text ? [{ text: String(text) }] : [];\n  }\n\n  const tokens: RichTextToken[] = [];\n  let remaining = text;\n\n  while (remaining.length > 0) {\n    let earliestMatch: { index: number; pattern: TokenPattern; match: RegExpExecArray } | null = null;\n\n    for (const pattern of patterns) {\n      pattern.regex.lastIndex = 0;\n      const match = pattern.regex.exec(remaining);\n      if (match && (earliestMatch === null || match.index < earliestMatch.index)) {\n        earliestMatch = { index: match.index, pattern, match };\n      }\n    }\n\n    if (earliestMatch === null) {\n      if (remaining.length > 0) {\n        tokens.push({ text: remaining });\n      }\n      break;\n    }\n\n    if (earliestMatch.index > 0) {\n      tokens.push({ text: remaining.slice(0, earliestMatch.index) });\n    }\n\n    tokens.push(earliestMatch.pattern.handler(earliestMatch.match));\n    remaining = remaining.slice(earliestMatch.index + earliestMatch.match[0].length);\n  }\n\n  return tokens.filter((t) => t.text.length > 0);\n}\n\nexport function hasMarkdown(text: string): boolean {\n  if (!text || typeof text !== \"string\") {\n    return false;\n  }\n  return patterns.some((p) => {\n    p.regex.lastIndex = 0;\n    return p.regex.test(text);\n  });\n}\n","path":null,"size_bytes":2483,"size_tokens":null},"server/services/richText/latexToImage.ts":{"content":"/**\n * LaTeX to readable text for Excel\n * \n * Converts basic LaTeX symbols to Unicode while preserving the original expression\n * for complex constructs. This ensures formulas remain readable and copyable.\n */\n\n/**\n * Convert basic LaTeX symbols to Unicode for Excel display\n * Preserves complex expressions as-is to avoid corruption\n */\nexport function formatLatexForExcel(latex: string): string {\n  if (!latex || typeof latex !== 'string') {\n    return '';\n  }\n  \n  let formatted = latex.trim();\n  \n  // Only convert simple, standalone Greek letters and symbols\n  // These are safe substitutions that don't affect structure\n  const safeSubstitutions: Record<string, string> = {\n    // Greek lowercase\n    '\\\\alpha': 'α', '\\\\beta': 'β', '\\\\gamma': 'γ', '\\\\delta': 'δ',\n    '\\\\epsilon': 'ε', '\\\\zeta': 'ζ', '\\\\eta': 'η', '\\\\theta': 'θ',\n    '\\\\iota': 'ι', '\\\\kappa': 'κ', '\\\\lambda': 'λ', '\\\\mu': 'μ',\n    '\\\\nu': 'ν', '\\\\xi': 'ξ', '\\\\pi': 'π', '\\\\rho': 'ρ',\n    '\\\\sigma': 'σ', '\\\\tau': 'τ', '\\\\upsilon': 'υ', '\\\\phi': 'φ',\n    '\\\\chi': 'χ', '\\\\psi': 'ψ', '\\\\omega': 'ω',\n    // Greek uppercase\n    '\\\\Gamma': 'Γ', '\\\\Delta': 'Δ', '\\\\Theta': 'Θ', '\\\\Lambda': 'Λ',\n    '\\\\Xi': 'Ξ', '\\\\Pi': 'Π', '\\\\Sigma': 'Σ', '\\\\Phi': 'Φ',\n    '\\\\Psi': 'Ψ', '\\\\Omega': 'Ω',\n    // Common operators and symbols\n    '\\\\infty': '∞', '\\\\partial': '∂', '\\\\nabla': '∇',\n    '\\\\leq': '≤', '\\\\le': '≤', '\\\\geq': '≥', '\\\\ge': '≥',\n    '\\\\neq': '≠', '\\\\ne': '≠', '\\\\approx': '≈', '\\\\equiv': '≡',\n    '\\\\pm': '±', '\\\\times': '×', '\\\\div': '÷', '\\\\cdot': '·',\n    '\\\\ldots': '…', '\\\\cdots': '⋯',\n    '\\\\forall': '∀', '\\\\exists': '∃',\n    '\\\\in': '∈', '\\\\notin': '∉', '\\\\subset': '⊂', '\\\\supset': '⊃',\n    '\\\\cup': '∪', '\\\\cap': '∩', '\\\\emptyset': '∅',\n    '\\\\rightarrow': '→', '\\\\to': '→', '\\\\leftarrow': '←',\n    '\\\\Rightarrow': '⇒', '\\\\Leftarrow': '⇐',\n    '\\\\neg': '¬', '\\\\land': '∧', '\\\\lor': '∨',\n  };\n  \n  // Apply safe substitutions\n  for (const [cmd, symbol] of Object.entries(safeSubstitutions)) {\n    const escapedCmd = cmd.replace(/\\\\/g, '\\\\\\\\');\n    formatted = formatted.replace(new RegExp(escapedCmd + '(?![a-zA-Z])', 'g'), symbol);\n  }\n  \n  return formatted;\n}\n\n/**\n * Extract LaTeX expressions from text with $...$ or $$...$$ delimiters\n */\nexport function extractLatexExpressions(text: string): { latex: string; isBlock: boolean; start: number; end: number }[] {\n  const expressions: { latex: string; isBlock: boolean; start: number; end: number }[] = [];\n  \n  // Block math first ($$...$$)\n  const blockRegex = /\\$\\$([\\s\\S]+?)\\$\\$/g;\n  let match;\n  while ((match = blockRegex.exec(text)) !== null) {\n    expressions.push({\n      latex: match[1].trim(),\n      isBlock: true,\n      start: match.index,\n      end: match.index + match[0].length,\n    });\n  }\n  \n  // Inline math ($...$) - avoid overlapping with block math\n  const inlineRegex = /\\$([^$]+?)\\$/g;\n  while ((match = inlineRegex.exec(text)) !== null) {\n    const overlaps = expressions.some(\n      exp => match!.index >= exp.start && match!.index < exp.end\n    );\n    if (!overlaps) {\n      expressions.push({\n        latex: match[1],\n        isBlock: false,\n        start: match.index,\n        end: match.index + match[0].length,\n      });\n    }\n  }\n  \n  return expressions.sort((a, b) => a.start - b.start);\n}\n\n/**\n * Convert all LaTeX in a text string to readable format\n */\nexport function convertLatexInText(text: string): string {\n  const expressions = extractLatexExpressions(text);\n  if (expressions.length === 0) return text;\n  \n  let result = '';\n  let lastEnd = 0;\n  \n  for (const expr of expressions) {\n    result += text.slice(lastEnd, expr.start);\n    result += formatLatexForExcel(expr.latex);\n    lastEnd = expr.end;\n  }\n  \n  result += text.slice(lastEnd);\n  return result;\n}\n","path":null,"size_bytes":3838,"size_tokens":null},"attached_assets/AI_PPT_Editor_Arquitectura_y_Codigo_1766296353237.md":{"content":"# Editor de Presentaciones (PPT) con IA en Streaming — Arquitectura + Código de Referencia (Monorepo)\n\n> Documento único (copiable) para implementación rápida por el equipo de software.  \n> Incluye: **frontend (React/TS)** + **backend (Node/TS)**, streaming WS/SSE, canvas (Konva), ribbon/tabs, modelo tipo **Delta (Quill)**, export a **PPTX/PDF/PNG**, y colaboración opcional con **CRDT (Yjs)**.\n\n---\n\n## 0) Alcance y notas importantes (léase antes)\n\nEste documento trae un **“reference implementation”**: compila y funciona para el flujo base (UI + canvas + selección + streaming de texto + export PPTX básico).  \nAlgunos objetivos “enterprise” (por ejemplo **embebido real de fuentes dentro del PPTX**, o render 100% vectorial de rich-text en el canvas) requieren trabajo adicional y decisiones de producto/licenciamiento. En el código encontrarás secciones marcadas como:\n\n- `// TODO(PROD): ...` → hardening/producción.\n- `// TODO(VECTOR): ...` → vector/pixel-perfect.\n- `// TODO(FONTS): ...` → fuentes y licencias.\n\nLa meta es que el equipo tenga **una base sólida**: estructura, estado, protocolos, y módulos listos para evolucionar.\n\n---\n\n## 1) Stack propuesto\n\n### Frontend\n- React 18 + TypeScript + Vite\n- Canvas: **Konva.js** vía `react-konva`\n- Rich text: **Quill** (Delta como modelo)\n- State: Zustand (centralizado) + history (undo/redo)\n- Charts: ECharts (renderer SVG) + export a SVG (inserción)\n- Streaming: WebSocket (y alternativa SSE)\n\n### Backend\n- Node 18+ + TypeScript\n- Express\n- WebSocket server (`ws`) y endpoint SSE\n- Adaptador a “tu API de LLM” (streaming tokens)\n- Export: **PptxGenJS** (PPTX)\n- PDF/PNG: (placeholder) Playwright/LibreOffice/CloudConvert o pipeline propio (ver TODO)\n\n### Colaboración opcional\n- CRDT: Yjs\n- y-websocket (servidor) + binding cliente\n\n---\n\n## 2) Arquitectura (alto nivel)\n\n```text\n┌─────────────────────────────── Frontend (React) ────────────────────────────────┐\n│ Header (title inline + Export + Close + Undo/Redo)                              │\n│ Ribbon Tabs: Home | Insert | Layout | References | Review | View | AI           │\n│                                                                               │\n│  ┌─────────────── Split View ───────────────┐                                  │\n│  │ Left: Chat Panel (LLM)                   │  Right: Editor                  │\n│  │ - mensajes + comandos (/img, /chart, …)  │  - Slides list                   │\n│  │ - WS/SSE streaming tokens                │  - Konva Canvas (Stage)          │\n│  │ - queue+rAF -> “typed on slide”          │  - Selection/Transform/Guides    │\n│  └──────────────────────────────────────────┘  - Layers + Properties panel     │\n│                                                                               │\n│ State Central (Zustand): slides[], activeSlideId, selection, history, aiMode  │\n│ Sync bidireccional: store <-> canvas (events) + (opcional) Yjs CRDT           │\n└───────────────────────────────────────────────────────────────────────────────┘\n\n┌────────────────────────────── Backend (Node/Express) ──────────────────────────────┐\n│ /api/chat/stream (SSE)  +  /ws (WebSocket)                                         │\n│ /api/fonts/google (lista + CSS)                                                    │\n│ /api/images/generate (DALL·E/SD) (stub)                                            │\n│ /api/charts/parse (LLM -> spec JSON)                                               │\n│ /api/export/pptx (PptxGenJS)                                                       │\n└────────────────────────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## 3) Modelo de datos (slides + elements + Delta + export)\n\n### Tipos base\n- `Deck`: { title, slides[] }\n- `Slide`: { id, size, background, elements[] }\n- `Element`: común: { id, type, x,y,w,h, rotation, opacity, zIndex, locked }\n- `TextElement`: { delta, defaultTextStyle, paragraphStyle }\n- `ImageElement`: { src, mime, naturalW, naturalH }\n- `ShapeElement`: { shapeType, fill, stroke, radius }\n- `ChartElement`: { spec, svg, data }\n\n### Unidades\n- Canvas: px (96 DPI)\n- PPTX: inches (PptxGenJS)\n- Conversión: `in = px / 96`\n\n> IMPORTANTE: Mantener un **slide size fijo** (ej. 1280×720 px) para que el export sea predecible.\n\n---\n\n## 4) Protocolo de streaming (WS) y render suave (queue + rAF)\n\n### Mensajes WS (JSON)\n- `client -> server`\n  - `chat_start`: { requestId, prompt, context, mode: \"slide_write\" | \"analysis\" }\n  - `chat_stop`: { requestId }\n  - `image_generate`: { requestId, prompt, size }\n  - `chart_parse`: { requestId, prompt }\n\n- `server -> client`\n  - `llm_token`: { requestId, token }\n  - `llm_done`: { requestId }\n  - `llm_error`: { requestId, message }\n  - `image_result`: { requestId, imageUrl | b64 }\n  - `chart_result`: { requestId, spec }\n\n### Render “tipo escritura humana”\n- cola de caracteres (tokens) en memoria\n- `requestAnimationFrame` consume N caracteres por frame\n- actualiza el **elemento activo** en el canvas\n- muestra un **cursor parpadeante** mientras `streaming=true`\n\n---\n\n## 5) Estructura de repositorio (monorepo)\n\n```text\nai-ppt-editor/\n  package.json\n  apps/\n    api/\n      package.json\n      tsconfig.json\n      src/\n        index.ts\n        env.ts\n        ws/\n          wsServer.ts\n          llmStream.ts\n        routes/\n          chat.ts\n          fonts.ts\n          images.ts\n          charts.ts\n          export.ts\n        llm/\n          provider.ts\n          internalSseProvider.ts\n          openaiProvider.ts\n          prompts.ts\n        export/\n          pptxBuilder.ts\n          unit.ts\n          svg.ts\n        utils/\n          sseParser.ts\n          validate.ts\n    web/\n      package.json\n      vite.config.ts\n      tsconfig.json\n      index.html\n      src/\n        main.tsx\n        App.tsx\n        styles.css\n        api/\n          wsClient.ts\n          http.ts\n          fonts.ts\n          export.ts\n        store/\n          deckStore.ts\n          history.ts\n          types.ts\n        editor/\n          EditorShell.tsx\n          CanvasStage.tsx\n          elements/\n            TextNode.tsx\n            ShapeNode.tsx\n            ImageNode.tsx\n            ChartNode.tsx\n          overlays/\n            RichTextOverlay.tsx\n            HyperlinkModal.tsx\n          panels/\n            SlidesPanel.tsx\n            LayersPanel.tsx\n            PropertiesPanel.tsx\n          guides/\n            snap.ts\n            guides.ts\n        ribbon/\n          Ribbon.tsx\n          tabs/\n            HomeTab.tsx\n            InsertTab.tsx\n            LayoutTab.tsx\n            ReferencesTab.tsx\n            ReviewTab.tsx\n            ViewTab.tsx\n            AITab.tsx\n        chat/\n          ChatPanel.tsx\n          commands.ts\n        ai/\n          typingStream.ts\n          context.ts\n        collab/\n          yjs.ts\n```\n\n---\n\n# PARTE A — ROOT (workspaces)\n\n## A1) `package.json` (root)\n\n```json\n{\n  \"name\": \"ai-ppt-editor\",\n  \"private\": true,\n  \"workspaces\": [\"apps/*\"],\n  \"scripts\": {\n    \"dev\": \"npm-run-all -p dev:web dev:api\",\n    \"dev:web\": \"npm --workspace apps/web run dev\",\n    \"dev:api\": \"npm --workspace apps/api run dev\",\n    \"build\": \"npm --workspaces run build\"\n  },\n  \"devDependencies\": {\n    \"npm-run-all\": \"^4.1.5\"\n  }\n}\n```\n\n---\n\n# PARTE B — BACKEND (apps/api)\n\n## B1) `apps/api/package.json`\n\n```json\n{\n  \"name\": \"@ai-ppt-editor/api\",\n  \"private\": true,\n  \"type\": \"module\",\n  \"scripts\": {\n    \"dev\": \"tsx watch src/index.ts\",\n    \"build\": \"tsc -p tsconfig.json\",\n    \"start\": \"node dist/index.js\"\n  },\n  \"dependencies\": {\n    \"cors\": \"^2.8.5\",\n    \"dotenv\": \"^16.4.5\",\n    \"express\": \"^4.19.2\",\n    \"pptxgenjs\": \"^3.12.0\",\n    \"ws\": \"^8.18.0\",\n    \"zod\": \"^3.23.8\"\n  },\n  \"devDependencies\": {\n    \"@types/cors\": \"^2.8.17\",\n    \"@types/express\": \"^4.17.21\",\n    \"@types/node\": \"^20.14.10\",\n    \"@types/ws\": \"^8.5.10\",\n    \"tsx\": \"^4.19.2\",\n    \"typescript\": \"^5.6.3\"\n  }\n}\n```\n\n> Ajusta versiones según tu lockfile estándar.\n\n---\n\n## B2) `apps/api/tsconfig.json`\n\n```json\n{\n  \"compilerOptions\": {\n    \"target\": \"ES2022\",\n    \"lib\": [\"ES2022\", \"DOM\"],\n    \"module\": \"ES2022\",\n    \"moduleResolution\": \"Bundler\",\n    \"outDir\": \"dist\",\n    \"rootDir\": \"src\",\n    \"strict\": true,\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true,\n    \"types\": [\"node\"]\n  },\n  \"include\": [\"src\"]\n}\n```\n\n---\n\n## B3) `apps/api/src/env.ts`\n\n```ts\nimport dotenv from \"dotenv\";\n\ndotenv.config();\n\nexport const env = {\n  PORT: Number(process.env.PORT ?? 3001),\n  CORS_ORIGIN: process.env.CORS_ORIGIN ?? \"http://localhost:5173\",\n\n  // Tu API interna de LLM (streaming). Ejemplo:\n  // LLM_BASE_URL=\"http://localhost:8080\"\n  LLM_BASE_URL: process.env.LLM_BASE_URL ?? \"\",\n\n  // Opcional: OpenAI (si quieres usarlo como provider)\n  OPENAI_API_KEY: process.env.OPENAI_API_KEY ?? \"\",\n\n  // Google Fonts Webfonts API\n  GOOGLE_FONTS_API_KEY: process.env.GOOGLE_FONTS_API_KEY ?? \"\"\n} as const;\n```\n\n---\n\n## B4) `apps/api/src/index.ts` (Express + WS + rutas)\n\n```ts\nimport http from \"node:http\";\nimport express from \"express\";\nimport cors from \"cors\";\n\nimport { env } from \"./env\";\nimport { attachWsServer } from \"./ws/wsServer\";\n\nimport { chatRouter } from \"./routes/chat\";\nimport { fontsRouter } from \"./routes/fonts\";\nimport { imagesRouter } from \"./routes/images\";\nimport { chartsRouter } from \"./routes/charts\";\nimport { exportRouter } from \"./routes/export\";\n\nconst app = express();\napp.use(cors({ origin: env.CORS_ORIGIN, credentials: true }));\napp.use(express.json({ limit: \"20mb\" }));\n\napp.get(\"/health\", (_req, res) => res.json({ ok: true }));\n\napp.use(\"/api/chat\", chatRouter);\napp.use(\"/api/fonts\", fontsRouter);\napp.use(\"/api/images\", imagesRouter);\napp.use(\"/api/charts\", chartsRouter);\napp.use(\"/api/export\", exportRouter);\n\nconst server = http.createServer(app);\nattachWsServer(server);\n\nserver.listen(env.PORT, () => {\n  // eslint-disable-next-line no-console\n  console.log(`[api] listening on http://localhost:${env.PORT}`);\n});\n```\n\n---\n\n## B5) WebSocket server — `apps/api/src/ws/wsServer.ts`\n\n```ts\nimport type http from \"node:http\";\nimport { WebSocketServer } from \"ws\";\nimport { handleWsConnection } from \"./llmStream\";\n\nexport function attachWsServer(server: http.Server) {\n  const wss = new WebSocketServer({ server, path: \"/ws\" });\n\n  wss.on(\"connection\", (socket) => {\n    handleWsConnection(socket);\n  });\n\n  // eslint-disable-next-line no-console\n  console.log(\"[ws] attached at /ws\");\n}\n```\n\n---\n\n## B6) Streaming LLM — `apps/api/src/ws/llmStream.ts`\n\n```ts\nimport type WebSocket from \"ws\";\nimport { z } from \"zod\";\nimport { streamChatCompletion } from \"../llm/provider\";\nimport { parseChartSpecViaLLM } from \"../llm/prompts\";\n\n// -----------------------\n// Schema mensajes\n// -----------------------\nconst ChatStart = z.object({\n  type: z.literal(\"chat_start\"),\n  requestId: z.string(),\n  prompt: z.string(),\n  context: z.any().optional(),\n  mode: z.enum([\"slide_write\", \"analysis\"]).default(\"slide_write\")\n});\n\nconst ChatStop = z.object({\n  type: z.literal(\"chat_stop\"),\n  requestId: z.string()\n});\n\nconst ImageGenerate = z.object({\n  type: z.literal(\"image_generate\"),\n  requestId: z.string(),\n  prompt: z.string(),\n  size: z.enum([\"512\", \"1024\"]).default(\"1024\")\n});\n\nconst ChartParse = z.object({\n  type: z.literal(\"chart_parse\"),\n  requestId: z.string(),\n  prompt: z.string()\n});\n\nconst ClientMsg = z.union([ChatStart, ChatStop, ImageGenerate, ChartParse]);\n\ntype ClientMsg = z.infer<typeof ClientMsg>;\n\nfunction safeSend(ws: WebSocket, data: unknown) {\n  if (ws.readyState === ws.OPEN) {\n    ws.send(JSON.stringify(data));\n  }\n}\n\n// -----------------------\n// Handler principal\n// -----------------------\nexport function handleWsConnection(ws: WebSocket) {\n  let abortByRequest = new Map<string, AbortController>();\n\n  ws.on(\"message\", async (raw) => {\n    let msg: ClientMsg;\n    try {\n      msg = ClientMsg.parse(JSON.parse(String(raw)));\n    } catch (e) {\n      safeSend(ws, { type: \"llm_error\", requestId: \"unknown\", message: \"Invalid message schema\" });\n      return;\n    }\n\n    if (msg.type === \"chat_stop\") {\n      abortByRequest.get(msg.requestId)?.abort();\n      abortByRequest.delete(msg.requestId);\n      return;\n    }\n\n    if (msg.type === \"chart_parse\") {\n      const controller = new AbortController();\n      abortByRequest.set(msg.requestId, controller);\n\n      try {\n        const spec = await parseChartSpecViaLLM({\n          prompt: msg.prompt,\n          signal: controller.signal\n        });\n        safeSend(ws, { type: \"chart_result\", requestId: msg.requestId, spec });\n      } catch (err: any) {\n        safeSend(ws, { type: \"llm_error\", requestId: msg.requestId, message: String(err?.message ?? err) });\n      } finally {\n        abortByRequest.delete(msg.requestId);\n      }\n      return;\n    }\n\n    if (msg.type === \"image_generate\") {\n      // TODO(PROD): Integrar DALL·E / SD (según tu infraestructura).\n      // Retornamos stub para no bloquear el equipo.\n      safeSend(ws, {\n        type: \"image_result\",\n        requestId: msg.requestId,\n        imageUrl: \"data:image/svg+xml;base64,\" + Buffer.from(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"1024\" height=\"1024\"><rect width=\"100%\" height=\"100%\" fill=\"#eee\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" font-family=\"Arial\" font-size=\"36\" fill=\"#555\">IMAGE STUB</text></svg>`).toString(\"base64\")\n      });\n      return;\n    }\n\n    if (msg.type === \"chat_start\") {\n      const controller = new AbortController();\n      abortByRequest.set(msg.requestId, controller);\n\n      try {\n        await streamChatCompletion({\n          prompt: msg.prompt,\n          context: msg.context,\n          mode: msg.mode,\n          signal: controller.signal,\n          onToken: (token) => {\n            safeSend(ws, { type: \"llm_token\", requestId: msg.requestId, token });\n          }\n        });\n\n        safeSend(ws, { type: \"llm_done\", requestId: msg.requestId });\n      } catch (err: any) {\n        safeSend(ws, { type: \"llm_error\", requestId: msg.requestId, message: String(err?.message ?? err) });\n      } finally {\n        abortByRequest.delete(msg.requestId);\n      }\n      return;\n    }\n  });\n\n  ws.on(\"close\", () => {\n    abortByRequest.forEach((c) => c.abort());\n    abortByRequest.clear();\n  });\n\n  safeSend(ws, { type: \"hello\", server: \"ai-ppt-editor-api\" });\n}\n```\n\n---\n\n## B7) Provider genérico LLM — `apps/api/src/llm/provider.ts`\n\n```ts\nimport { env } from \"../env\";\nimport { streamFromInternalSSE } from \"./internalSseProvider\";\nimport { streamFromOpenAI } from \"./openaiProvider\";\n\nexport type StreamChatArgs = {\n  prompt: string;\n  context?: unknown;\n  mode: \"slide_write\" | \"analysis\";\n  signal: AbortSignal;\n  onToken: (token: string) => void;\n};\n\nexport async function streamChatCompletion(args: StreamChatArgs) {\n  if (env.LLM_BASE_URL) {\n    return streamFromInternalSSE(args);\n  }\n\n  // Fallback opcional: OpenAI si no hay LLM_BASE_URL\n  if (env.OPENAI_API_KEY) {\n    return streamFromOpenAI(args);\n  }\n\n  throw new Error(\"No LLM provider configured. Set LLM_BASE_URL or OPENAI_API_KEY.\");\n}\n```\n\n---\n\n## B8) Adaptador a tu LLM (SSE) — `apps/api/src/llm/internalSseProvider.ts`\n\n> Asume que tu API interna expone un endpoint que hace streaming tipo SSE o chunked.\n> Si tu API usa WebSocket, cambia esta implementación.\n\n```ts\nimport { env } from \"../env\";\nimport type { StreamChatArgs } from \"./provider\";\nimport { parseSSEStream } from \"../utils/sseParser\";\n\n/**\n * POST {LLM_BASE_URL}/chat/stream\n * body: { prompt, context, mode }\n * response: text/event-stream con tokens en `data: ...`\n */\nexport async function streamFromInternalSSE(args: StreamChatArgs) {\n  const url = `${env.LLM_BASE_URL.replace(/\\/$/, \"\")}/chat/stream`;\n\n  const res = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\"\n      // Authorization: `Bearer ...` (si aplica)\n    },\n    body: JSON.stringify({\n      prompt: args.prompt,\n      context: args.context ?? {},\n      mode: args.mode\n    }),\n    signal: args.signal\n  });\n\n  if (!res.ok || !res.body) {\n    throw new Error(`LLM stream failed: ${res.status} ${res.statusText}`);\n  }\n\n  await parseSSEStream(res.body, {\n    signal: args.signal,\n    onEvent: (evt) => {\n      // Convención: evt.data contiene token o chunks\n      if (evt.event === \"token\" || evt.event === \"message\" || !evt.event) {\n        if (evt.data) args.onToken(evt.data);\n      }\n      if (evt.event === \"done\") {\n        // noop: el caller enviará llm_done\n      }\n    }\n  });\n}\n```\n\n---\n\n## B9) Provider OpenAI (opcional) — `apps/api/src/llm/openaiProvider.ts`\n\n> Implementación simplificada de streaming SSE de OpenAI. Ajusta a tu SDK oficial si lo prefieres.\n\n```ts\nimport type { StreamChatArgs } from \"./provider\";\nimport { env } from \"../env\";\nimport { parseSSEStream } from \"../utils/sseParser\";\n\nexport async function streamFromOpenAI(args: StreamChatArgs) {\n  const res = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": `Bearer ${env.OPENAI_API_KEY}`\n    },\n    body: JSON.stringify({\n      model: \"gpt-4o-mini\", // TODO(PROD): configura modelo\n      stream: true,\n      messages: [\n        { role: \"system\", content: args.mode === \"slide_write\" ? \"Write slide-ready content.\" : \"Analyze and suggest improvements.\" },\n        { role: \"user\", content: args.prompt }\n      ]\n    }),\n    signal: args.signal\n  });\n\n  if (!res.ok || !res.body) {\n    throw new Error(`OpenAI stream failed: ${res.status} ${res.statusText}`);\n  }\n\n  await parseSSEStream(res.body, {\n    signal: args.signal,\n    onEvent: (evt) => {\n      if (evt.data === \"[DONE]\") return;\n      try {\n        const json = JSON.parse(evt.data);\n        const token = json?.choices?.[0]?.delta?.content ?? \"\";\n        if (token) args.onToken(token);\n      } catch {\n        // ignore parse errors\n      }\n    }\n  });\n}\n```\n\n---\n\n## B10) Parser SSE — `apps/api/src/utils/sseParser.ts`\n\n```ts\nexport type SSEEvent = { event?: string; data: string };\n\nexport async function parseSSEStream(\n  body: ReadableStream<Uint8Array>,\n  opts: {\n    signal: AbortSignal;\n    onEvent: (evt: SSEEvent) => void;\n  }\n) {\n  const reader = body.getReader();\n  const decoder = new TextDecoder(\"utf-8\");\n\n  let buffer = \"\";\n  let currentEvent: Partial<SSEEvent> = {};\n\n  const flush = () => {\n    if (currentEvent.data !== undefined) {\n      opts.onEvent({ event: currentEvent.event, data: currentEvent.data });\n    }\n    currentEvent = {};\n  };\n\n  while (true) {\n    if (opts.signal.aborted) throw new Error(\"aborted\");\n\n    const { value, done } = await reader.read();\n    if (done) break;\n\n    buffer += decoder.decode(value, { stream: true });\n\n    // SSE frames separated by \\n\\n\n    let idx;\n    while ((idx = buffer.indexOf(\"\\n\\n\")) !== -1) {\n      const frame = buffer.slice(0, idx);\n      buffer = buffer.slice(idx + 2);\n\n      const lines = frame.split(\"\\n\");\n      currentEvent = { data: \"\" };\n\n      for (const line of lines) {\n        if (line.startsWith(\"event:\")) {\n          currentEvent.event = line.slice(\"event:\".length).trim();\n        } else if (line.startsWith(\"data:\")) {\n          const d = line.slice(\"data:\".length);\n          currentEvent.data = (currentEvent.data ?? \"\") + d.trim();\n        }\n      }\n\n      flush();\n    }\n  }\n}\n```\n\n---\n\n## B11) Prompts/context analysis — `apps/api/src/llm/prompts.ts`\n\n```ts\nimport { streamChatCompletion } from \"./provider\";\n\nexport async function parseChartSpecViaLLM(args: { prompt: string; signal: AbortSignal }) {\n  // Minimal: usa LLM en modo analysis y luego parsea JSON.\n  // En PROD: usar un esquema Zod y “JSON-only” con retries.\n  let out = \"\";\n  await streamChatCompletion({\n    prompt: `Convert the following request into a valid ECharts option JSON. Return JSON only. Request: ${args.prompt}`,\n    mode: \"analysis\",\n    signal: args.signal,\n    onToken: (t) => (out += t)\n  });\n\n  // Extrae JSON \"best effort\"\n  const first = out.indexOf(\"{\");\n  const last = out.lastIndexOf(\"}\");\n  if (first === -1 || last === -1) throw new Error(\"Could not parse JSON from LLM output\");\n\n  const jsonStr = out.slice(first, last + 1);\n  return JSON.parse(jsonStr);\n}\n```\n\n---\n\n## B12) Routes — Chat SSE (alternativa) `apps/api/src/routes/chat.ts`\n\n```ts\nimport { Router } from \"express\";\nimport { z } from \"zod\";\nimport { streamChatCompletion } from \"../llm/provider\";\n\nexport const chatRouter = Router();\n\nchatRouter.get(\"/stream\", async (req, res) => {\n  const schema = z.object({\n    prompt: z.string().min(1),\n    mode: z.enum([\"slide_write\", \"analysis\"]).optional()\n  });\n\n  const parsed = schema.safeParse(req.query);\n  if (!parsed.success) {\n    res.status(400).json({ error: \"Invalid query params\" });\n    return;\n  }\n\n  const { prompt, mode } = parsed.data;\n\n  res.writeHead(200, {\n    \"Content-Type\": \"text/event-stream\",\n    \"Cache-Control\": \"no-cache, no-transform\",\n    \"Connection\": \"keep-alive\"\n  });\n\n  const controller = new AbortController();\n  req.on(\"close\", () => controller.abort());\n\n  try {\n    await streamChatCompletion({\n      prompt,\n      mode: mode ?? \"slide_write\",\n      signal: controller.signal,\n      onToken: (token) => {\n        res.write(`event: token\\n`);\n        res.write(`data: ${JSON.stringify(token)}\\n\\n`);\n      }\n    });\n\n    res.write(\"event: done\\n\");\n    res.write(\"data: ok\\n\\n\");\n    res.end();\n  } catch (err: any) {\n    res.write(\"event: error\\n\");\n    res.write(`data: ${JSON.stringify(String(err?.message ?? err))}\\n\\n`);\n    res.end();\n  }\n});\n```\n\n---\n\n## B13) Routes — Google Fonts `apps/api/src/routes/fonts.ts`\n\n```ts\nimport { Router } from \"express\";\nimport { env } from \"../env\";\n\nexport const fontsRouter = Router();\n\nlet cache: any = null;\nlet cacheAt = 0;\n\nfontsRouter.get(\"/google\", async (_req, res) => {\n  // TODO(PROD): caching robusto + ETag.\n  if (!env.GOOGLE_FONTS_API_KEY) {\n    res.json({\n      items: [\n        { family: \"Inter\" },\n        { family: \"Roboto\" },\n        { family: \"Open Sans\" },\n        { family: \"Montserrat\" },\n        { family: \"Poppins\" }\n      ],\n      source: \"fallback\"\n    });\n    return;\n  }\n\n  const now = Date.now();\n  if (cache && now - cacheAt < 1000 * 60 * 60 * 6) {\n    res.json(cache);\n    return;\n  }\n\n  const url = `https://www.googleapis.com/webfonts/v1/webfonts?sort=popularity&key=${env.GOOGLE_FONTS_API_KEY}`;\n  const r = await fetch(url);\n  if (!r.ok) {\n    res.status(500).json({ error: \"google fonts fetch failed\" });\n    return;\n  }\n\n  const json = await r.json();\n  cache = json;\n  cacheAt = now;\n  res.json(json);\n});\n\nfontsRouter.get(\"/google/css\", async (req, res) => {\n  // Devuelve un CSS @import o @font-face para una family concreta.\n  const family = String(req.query.family ?? \"\");\n  if (!family) {\n    res.status(400).send(\"missing family\");\n    return;\n  }\n\n  // Google Fonts CSS endpoint (sin key)\n  const cssUrl = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(family).replace(/%20/g, \"+\")}:wght@300;400;500;600;700&display=swap`;\n  const css = await fetch(cssUrl).then((r) => r.text());\n\n  res.setHeader(\"Content-Type\", \"text/css; charset=utf-8\");\n  res.send(css);\n});\n```\n\n---\n\n## B14) Routes — Images (stub) `apps/api/src/routes/images.ts`\n\n```ts\nimport { Router } from \"express\";\nimport { z } from \"zod\";\n\nexport const imagesRouter = Router();\n\nimagesRouter.post(\"/generate\", async (req, res) => {\n  const schema = z.object({\n    prompt: z.string().min(1),\n    size: z.enum([\"512\", \"1024\"]).default(\"1024\")\n  });\n\n  const parsed = schema.safeParse(req.body);\n  if (!parsed.success) {\n    res.status(400).json({ error: \"invalid body\" });\n    return;\n  }\n\n  // TODO(PROD): integrar provider real.\n  const svg = `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${parsed.data.size}\" height=\"${parsed.data.size}\"><rect width=\"100%\" height=\"100%\" fill=\"#eee\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" font-family=\"Arial\" font-size=\"36\" fill=\"#555\">IMAGE STUB</text></svg>`;\n  res.json({ b64: Buffer.from(svg).toString(\"base64\"), mime: \"image/svg+xml\" });\n});\n```\n\n---\n\n## B15) Routes — Charts `apps/api/src/routes/charts.ts`\n\n```ts\nimport { Router } from \"express\";\nimport { z } from \"zod\";\nimport { parseChartSpecViaLLM } from \"../llm/prompts\";\n\nexport const chartsRouter = Router();\n\nchartsRouter.post(\"/parse\", async (req, res) => {\n  const schema = z.object({ prompt: z.string().min(1) });\n  const parsed = schema.safeParse(req.body);\n  if (!parsed.success) {\n    res.status(400).json({ error: \"invalid body\" });\n    return;\n  }\n\n  const controller = new AbortController();\n  req.on(\"close\", () => controller.abort());\n\n  try {\n    const spec = await parseChartSpecViaLLM({ prompt: parsed.data.prompt, signal: controller.signal });\n    res.json({ spec });\n  } catch (err: any) {\n    res.status(500).json({ error: String(err?.message ?? err) });\n  }\n});\n```\n\n---\n\n## B16) Export PPTX — route `apps/api/src/routes/export.ts`\n\n```ts\nimport { Router } from \"express\";\nimport { z } from \"zod\";\nimport { buildPptx } from \"../export/pptxBuilder\";\n\nexport const exportRouter = Router();\n\nexportRouter.post(\"/pptx\", async (req, res) => {\n  const schema = z.object({\n    deck: z.any() // valida en el frontend/contrato real; en PROD usa Zod estricto.\n  });\n\n  const parsed = schema.safeParse(req.body);\n  if (!parsed.success) {\n    res.status(400).json({ error: \"invalid body\" });\n    return;\n  }\n\n  try {\n    const pptxBuffer = await buildPptx(parsed.data.deck);\n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.presentationml.presentation\");\n    res.setHeader(\"Content-Disposition\", \"attachment; filename=\\\"presentation.pptx\\\"\");\n    res.send(pptxBuffer);\n  } catch (err: any) {\n    res.status(500).json({ error: String(err?.message ?? err) });\n  }\n});\n```\n\n---\n\n## B17) Export builder — `apps/api/src/export/unit.ts`\n\n```ts\nexport const PX_PER_IN = 96;\n\nexport function pxToIn(px: number): number {\n  return px / PX_PER_IN;\n}\n\nexport function clamp(n: number, a: number, b: number) {\n  return Math.max(a, Math.min(b, n));\n}\n```\n\n---\n\n## B18) Export builder — `apps/api/src/export/svg.ts`\n\n```ts\nexport function dataUriFromSvg(svg: string): string {\n  const b64 = Buffer.from(svg, \"utf8\").toString(\"base64\");\n  return `data:image/svg+xml;base64,${b64}`;\n}\n```\n\n---\n\n## B19) Export builder — `apps/api/src/export/pptxBuilder.ts`\n\n```ts\nimport pptxgen from \"pptxgenjs\";\nimport { pxToIn } from \"./unit\";\nimport { dataUriFromSvg } from \"./svg\";\n\n/**\n * Contrato esperado (resumen):\n * deck = { title: string, slides: Slide[] }\n * Slide = { id, size:{w,h}, background, elements: Element[] }\n */\nexport async function buildPptx(deck: any): Promise<Buffer> {\n  const pptx = new pptxgen();\n  pptx.layout = \"LAYOUT_WIDE\"; // 13.333 x 7.5\n\n  // TODO(FONTS): embedding real de fuentes requiere OOXML + licencias.\n\n  for (const s of deck.slides ?? []) {\n    const slide = pptx.addSlide();\n\n    // Fondo\n    if (s.background?.color) {\n      slide.background = { color: normalizeHex(s.background.color) };\n    }\n\n    // Elementos ordenados por zIndex\n    const elements = [...(s.elements ?? [])].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\n\n    for (const el of elements) {\n      const x = pxToIn(el.x ?? 0);\n      const y = pxToIn(el.y ?? 0);\n      const w = pxToIn(el.w ?? 100);\n      const h = pxToIn(el.h ?? 40);\n\n      if (el.type === \"text\") {\n        const plain = deltaToPlainText(el.delta);\n        slide.addText(plain, {\n          x,\n          y,\n          w,\n          h,\n          fontFace: el.defaultTextStyle?.fontFamily ?? \"Arial\",\n          fontSize: el.defaultTextStyle?.fontSize ?? 18,\n          color: normalizeHex(el.defaultTextStyle?.color ?? \"#111111\"),\n          bold: !!el.defaultTextStyle?.bold,\n          italic: !!el.defaultTextStyle?.italic,\n          underline: el.defaultTextStyle?.underline ? true : false\n        });\n\n        // TODO(VECTOR): Rich text por runs: si usas PptxGenJS rich text API, construye runs desde Delta.\n        continue;\n      }\n\n      if (el.type === \"shape\") {\n        // PptxGenJS shapes: rect, ellipse, etc.\n        // Simple: rect\n        slide.addShape(pptx.ShapeType.rect, {\n          x, y, w, h,\n          fill: { color: normalizeHex(el.fill ?? \"#FFFFFF\") },\n          line: { color: normalizeHex(el.stroke ?? \"#000000\"), width: el.strokeWidth ?? 1 }\n        });\n        continue;\n      }\n\n      if (el.type === \"image\") {\n        // src puede ser dataURI (png/jpg/svg) o URL\n        slide.addImage({\n          data: el.src,\n          x, y, w, h\n        });\n        continue;\n      }\n\n      if (el.type === \"chart\") {\n        // Preferimos SVG si está disponible\n        if (typeof el.svg === \"string\" && el.svg.trim().startsWith(\"<svg\")) {\n          const uri = dataUriFromSvg(el.svg);\n          slide.addImage({ data: uri, x, y, w, h });\n        } else if (el.src) {\n          slide.addImage({ data: el.src, x, y, w, h });\n        }\n        continue;\n      }\n    }\n  }\n\n  // PptxGenJS -> write en memoria\n  const out = await pptx.write(\"nodebuffer\");\n  return Buffer.from(out);\n}\n\nfunction normalizeHex(hex: string): string {\n  const h = String(hex || \"\").trim();\n  if (!h) return \"000000\";\n  return h.replace(\"#\", \"\").toUpperCase();\n}\n\nfunction deltaToPlainText(delta: any): string {\n  // Delta: { ops: [{ insert: \"text\", attributes?: {} }, ...] }\n  const ops = delta?.ops ?? [];\n  let out = \"\";\n  for (const op of ops) {\n    if (typeof op.insert === \"string\") out += op.insert;\n  }\n  return out;\n}\n```\n\n---\n\n# PARTE C — FRONTEND (apps/web)\n\n## C1) `apps/web/package.json`\n\n```json\n{\n  \"name\": \"@ai-ppt-editor/web\",\n  \"private\": true,\n  \"type\": \"module\",\n  \"scripts\": {\n    \"dev\": \"vite\",\n    \"build\": \"tsc -p tsconfig.json && vite build\",\n    \"preview\": \"vite preview\"\n  },\n  \"dependencies\": {\n    \"konva\": \"^9.3.18\",\n    \"react\": \"^18.3.1\",\n    \"react-dom\": \"^18.3.1\",\n    \"react-konva\": \"^18.2.10\",\n    \"zustand\": \"^4.5.5\",\n    \"quill\": \"^1.3.7\",\n    \"nanoid\": \"^5.0.7\",\n    \"echarts\": \"^5.5.1\"\n  },\n  \"devDependencies\": {\n    \"@types/react\": \"^18.3.3\",\n    \"@types/react-dom\": \"^18.3.0\",\n    \"typescript\": \"^5.6.3\",\n    \"vite\": \"^5.4.10\"\n  }\n}\n```\n\n---\n\n## C2) `apps/web/vite.config.ts`\n\n```ts\nimport { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\n\nexport default defineConfig({\n  plugins: [react()],\n  server: {\n    port: 5173\n  }\n});\n```\n\n---\n\n## C3) `apps/web/tsconfig.json`\n\n```json\n{\n  \"compilerOptions\": {\n    \"target\": \"ES2022\",\n    \"lib\": [\"ES2022\", \"DOM\", \"DOM.Iterable\"],\n    \"module\": \"ES2022\",\n    \"moduleResolution\": \"Bundler\",\n    \"jsx\": \"react-jsx\",\n    \"strict\": true,\n    \"skipLibCheck\": true,\n    \"types\": [\"vite/client\"]\n  },\n  \"include\": [\"src\"]\n}\n```\n\n---\n\n## C4) `apps/web/src/main.tsx`\n\n```tsx\nimport React from \"react\";\nimport ReactDOM from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./styles.css\";\n\nReactDOM.createRoot(document.getElementById(\"root\")!).render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n);\n```\n\n---\n\n## C5) Estilos globales `apps/web/src/styles.css`\n\n```css\n:root {\n  --bg: #f6f7fb;\n  --panel: #ffffff;\n  --line: rgba(0,0,0,0.10);\n  --text: #111;\n  --muted: rgba(0,0,0,0.65);\n  --accent: #d83b01; /* naranja/rojo estilo Office */\n  --blue: #2563eb;\n  --shadow: 0 6px 18px rgba(0,0,0,0.08);\n  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;\n}\n\nhtml, body, #root {\n  height: 100%;\n  margin: 0;\n  background: var(--bg);\n  color: var(--text);\n}\n\nbutton, input, select {\n  font: inherit;\n}\n\n.app {\n  height: 100%;\n  display: grid;\n  grid-template-columns: 380px 1fr;\n}\n\n.leftPanel {\n  border-right: 1px solid var(--line);\n  background: var(--panel);\n  display: grid;\n  grid-template-rows: 1fr auto;\n}\n\n.rightPanel {\n  display: grid;\n  grid-template-rows: 48px 92px 1fr;\n  min-width: 0;\n}\n\n.headerBar {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding: 0 10px;\n  background: var(--panel);\n  border-bottom: 1px solid var(--line);\n}\n\n.headerTitleInput {\n  font-size: 14px;\n  font-weight: 600;\n  padding: 6px 8px;\n  border: 1px solid transparent;\n  border-radius: 6px;\n  background: transparent;\n  min-width: 240px;\n}\n\n.headerTitleInput:focus {\n  outline: none;\n  border-color: rgba(37,99,235,0.35);\n  background: rgba(37,99,235,0.06);\n}\n\n.headerSpacer { flex: 1; }\n\n.pill {\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  border: 1px solid var(--line);\n  background: #fff;\n  border-radius: 999px;\n  padding: 8px 12px;\n  cursor: pointer;\n}\n\n.primary {\n  background: var(--accent);\n  color: #fff;\n  border-color: transparent;\n}\n\n.iconBtn {\n  width: 34px;\n  height: 34px;\n  border-radius: 8px;\n  border: 1px solid var(--line);\n  background: #fff;\n  cursor: pointer;\n}\n\n.iconBtn:disabled {\n  opacity: 0.45;\n  cursor: not-allowed;\n}\n\n.ribbon {\n  background: var(--panel);\n  border-bottom: 1px solid var(--line);\n  display: grid;\n  grid-template-rows: 32px 1fr;\n}\n\n.tabsRow {\n  display: flex;\n  gap: 18px;\n  padding: 0 10px;\n  align-items: center;\n  border-bottom: 1px solid var(--line);\n}\n\n.tab {\n  height: 32px;\n  display: inline-flex;\n  align-items: center;\n  cursor: pointer;\n  font-size: 13px;\n  color: var(--muted);\n  position: relative;\n}\n\n.tab.active {\n  color: var(--text);\n  font-weight: 700;\n}\n\n.tab.active::after {\n  content: \"\";\n  position: absolute;\n  left: 0;\n  bottom: -1px;\n  height: 3px;\n  width: 100%;\n  background: var(--accent);\n  border-radius: 3px 3px 0 0;\n}\n\n.ribbonBody {\n  display: flex;\n  gap: 14px;\n  padding: 10px;\n  overflow-x: auto;\n}\n\n.group {\n  border-right: 1px solid rgba(0,0,0,0.08);\n  padding-right: 14px;\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  min-width: 170px;\n}\n\n.group:last-child { border-right: none; }\n\n.groupTitle {\n  font-size: 11px;\n  color: var(--muted);\n}\n\n.row {\n  display: flex;\n  gap: 8px;\n  align-items: center;\n  flex-wrap: wrap;\n}\n\n.select, .input {\n  border: 1px solid var(--line);\n  border-radius: 6px;\n  padding: 6px 8px;\n  background: #fff;\n}\n\n.toggleBtn {\n  border: 1px solid var(--line);\n  background: #fff;\n  border-radius: 6px;\n  padding: 6px 8px;\n  cursor: pointer;\n  min-width: 34px;\n  text-align: center;\n}\n\n.toggleBtn.active {\n  border-color: rgba(37,99,235,0.35);\n  background: rgba(37,99,235,0.06);\n}\n\n.editorArea {\n  display: grid;\n  grid-template-columns: 190px 1fr 320px;\n  gap: 10px;\n  padding: 10px;\n  min-height: 0;\n}\n\n.panel {\n  background: var(--panel);\n  border: 1px solid var(--line);\n  border-radius: 12px;\n  box-shadow: var(--shadow);\n  min-height: 0;\n  overflow: hidden;\n  display: grid;\n  grid-template-rows: auto 1fr;\n}\n\n.panelHeader {\n  padding: 10px;\n  border-bottom: 1px solid var(--line);\n  font-weight: 700;\n  font-size: 13px;\n}\n\n.panelBody {\n  padding: 10px;\n  overflow: auto;\n}\n\n.canvasWrap {\n  background: linear-gradient(#fff, #fff);\n  border-radius: 12px;\n  border: 1px solid var(--line);\n  box-shadow: var(--shadow);\n  display: grid;\n  place-items: center;\n  min-height: 0;\n  overflow: hidden;\n  position: relative;\n}\n\n.canvasControls {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  display: flex;\n  gap: 8px;\n  z-index: 2;\n}\n\n.canvasControls .pill {\n  padding: 6px 10px;\n}\n\n.chatHeader {\n  padding: 10px;\n  border-bottom: 1px solid var(--line);\n  font-weight: 700;\n}\n\n.chatMessages {\n  padding: 10px;\n  overflow: auto;\n}\n\n.chatMsg {\n  padding: 10px;\n  border: 1px solid var(--line);\n  border-radius: 12px;\n  margin-bottom: 10px;\n  background: #fff;\n}\n\n.chatMsgRole {\n  font-size: 11px;\n  color: var(--muted);\n  margin-bottom: 6px;\n}\n\n.chatComposer {\n  padding: 10px;\n  border-top: 1px solid var(--line);\n  display: flex;\n  gap: 8px;\n}\n\n.chatInput {\n  flex: 1;\n  border: 1px solid var(--line);\n  border-radius: 10px;\n  padding: 10px;\n}\n\n.modalBackdrop {\n  position: absolute;\n  inset: 0;\n  background: rgba(0,0,0,0.28);\n  display: grid;\n  place-items: center;\n  z-index: 50;\n}\n\n.modal {\n  width: 420px;\n  background: #fff;\n  border-radius: 14px;\n  border: 1px solid var(--line);\n  box-shadow: var(--shadow);\n  overflow: hidden;\n}\n\n.modalHeader {\n  padding: 12px;\n  border-bottom: 1px solid var(--line);\n  font-weight: 800;\n}\n\n.modalBody {\n  padding: 12px;\n  display: grid;\n  gap: 10px;\n}\n\n.modalFooter {\n  padding: 12px;\n  border-top: 1px solid var(--line);\n  display: flex;\n  justify-content: flex-end;\n  gap: 10px;\n}\n\n.konvaOverlayEditor {\n  position: absolute;\n  z-index: 30;\n  border: 1px solid rgba(37,99,235,0.35);\n  border-radius: 8px;\n  box-shadow: var(--shadow);\n  background: #fff;\n}\n\n.typingCursor {\n  display: inline-block;\n  width: 2px;\n  height: 1em;\n  vertical-align: -0.15em;\n  margin-left: 2px;\n  background: rgba(0,0,0,0.85);\n  animation: blink 1s steps(1) infinite;\n}\n\n@keyframes blink {\n  50% { opacity: 0; }\n}\n```\n\n---\n\n## C6) Tipos y store — `apps/web/src/store/types.ts`\n\n```ts\nexport type SlideSize = { w: number; h: number };\n\nexport type TextStyle = {\n  fontFamily: string;\n  fontSize: number;\n  color: string;\n  bold?: boolean;\n  italic?: boolean;\n  underline?: boolean;\n  strike?: boolean;\n};\n\nexport type DeltaOp = {\n  insert: string;\n  attributes?: {\n    bold?: boolean;\n    italic?: boolean;\n    underline?: boolean;\n    strike?: boolean;\n    color?: string;\n    link?: string;\n    header?: 1 | 2 | 3; // para H1/H2/H3\n    list?: \"bullet\" | \"ordered\";\n  };\n};\n\nexport type Delta = { ops: DeltaOp[] };\n\nexport type BaseElement = {\n  id: string;\n  type: \"text\" | \"image\" | \"shape\" | \"chart\";\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n  rotation?: number;\n  opacity?: number;\n  zIndex?: number;\n  locked?: boolean;\n};\n\nexport type TextElement = BaseElement & {\n  type: \"text\";\n  delta: Delta;\n  defaultTextStyle: TextStyle;\n};\n\nexport type ImageElement = BaseElement & {\n  type: \"image\";\n  src: string; // dataURI o URL\n  mime?: string;\n  naturalW?: number;\n  naturalH?: number;\n};\n\nexport type ShapeElement = BaseElement & {\n  type: \"shape\";\n  shapeType: \"rect\" | \"ellipse\";\n  fill: string;\n  stroke: string;\n  strokeWidth: number;\n  radius?: number;\n};\n\nexport type ChartElement = BaseElement & {\n  type: \"chart\";\n  spec: any;     // ECharts option JSON\n  svg?: string;  // export SVG\n  src?: string;  // fallback PNG\n};\n\nexport type ElementAny = TextElement | ImageElement | ShapeElement | ChartElement;\n\nexport type Slide = {\n  id: string;\n  size: SlideSize;\n  background: { color: string };\n  elements: ElementAny[];\n};\n\nexport type Deck = {\n  title: string;\n  slides: Slide[];\n};\n\nexport type Selection = { slideId: string; elementId: string } | null;\n```\n\n---\n\n## C7) History (undo/redo) — `apps/web/src/store/history.ts`\n\n```ts\nexport type HistoryState<T> = {\n  past: T[];\n  present: T;\n  future: T[];\n};\n\nexport function createHistory<T>(initial: T): HistoryState<T> {\n  return { past: [], present: initial, future: [] };\n}\n\nexport function pushHistory<T>(h: HistoryState<T>, next: T, limit = 80): HistoryState<T> {\n  const past = [...h.past, h.present];\n  if (past.length > limit) past.shift();\n  return { past, present: next, future: [] };\n}\n\nexport function undoHistory<T>(h: HistoryState<T>): HistoryState<T> {\n  if (h.past.length === 0) return h;\n  const prev = h.past[h.past.length - 1];\n  const past = h.past.slice(0, -1);\n  const future = [h.present, ...h.future];\n  return { past, present: prev, future };\n}\n\nexport function redoHistory<T>(h: HistoryState<T>): HistoryState<T> {\n  if (h.future.length === 0) return h;\n  const next = h.future[0];\n  const future = h.future.slice(1);\n  const past = [...h.past, h.present];\n  return { past, present: next, future };\n}\n```\n\n---\n\n## C8) Store central (Zustand) — `apps/web/src/store/deckStore.ts`\n\n```ts\nimport { create } from \"zustand\";\nimport { nanoid } from \"nanoid\";\nimport type { Deck, ElementAny, Slide, TextElement, TextStyle, Selection, Delta } from \"./types\";\nimport { createHistory, pushHistory, redoHistory, undoHistory, type HistoryState } from \"./history\";\n\nfunction defaultDeck(): Deck {\n  const slide: Slide = {\n    id: nanoid(),\n    size: { w: 1280, h: 720 },\n    background: { color: \"#FFFFFF\" },\n    elements: [\n      {\n        id: nanoid(),\n        type: \"text\",\n        x: 80,\n        y: 80,\n        w: 820,\n        h: 140,\n        zIndex: 1,\n        delta: { ops: [{ insert: \"Título de la diapositiva\\n\" }] },\n        defaultTextStyle: {\n          fontFamily: \"Inter\",\n          fontSize: 44,\n          color: \"#111111\",\n          bold: true\n        }\n      } as TextElement\n    ]\n  };\n\n  return {\n    title: \"Nueva Presentación\",\n    slides: [slide]\n  };\n}\n\nexport type EditorMode = \"manual\" | \"ai\";\n\ntype DeckState = {\n  history: HistoryState<Deck>;\n  selection: Selection;\n  activeSlideId: string;\n  activeTab:\n    | \"Home\"\n    | \"Insert\"\n    | \"Layout\"\n    | \"References\"\n    | \"Review\"\n    | \"View\"\n    | \"AI\";\n  editorMode: EditorMode;\n  streaming: { active: boolean; requestId?: string };\n\n  // actions\n  setTitle(title: string): void;\n  setActiveTab(tab: DeckState[\"activeTab\"]): void;\n  setEditorMode(mode: EditorMode): void;\n\n  undo(): void;\n  redo(): void;\n\n  select(selection: Selection): void;\n  addSlide(): void;\n  setActiveSlide(slideId: string): void;\n\n  addElement(el: ElementAny): void;\n  updateElement(elementId: string, patch: Partial<ElementAny>): void;\n  bringToFront(elementId: string): void;\n  sendToBack(elementId: string): void;\n  deleteElement(elementId: string): void;\n\n  updateTextDelta(elementId: string, delta: Delta): void;\n  applyTextStyleToDefault(elementId: string, patch: Partial<TextStyle>): void;\n\n  setStreaming(active: boolean, requestId?: string): void;\n\n  getDeck(): Deck;\n  getActiveSlide(): Slide;\n  getSelectedElement(): ElementAny | null;\n};\n\nexport const useDeckStore = create<DeckState>((set, get) => {\n  const initial = defaultDeck();\n  const activeSlideId = initial.slides[0].id;\n\n  return {\n    history: createHistory(initial),\n    selection: { slideId: activeSlideId, elementId: initial.slides[0].elements[0].id },\n    activeSlideId,\n    activeTab: \"Home\",\n    editorMode: \"manual\",\n    streaming: { active: false },\n\n    setTitle(title) {\n      const deck = get().history.present;\n      set({ history: pushHistory(get().history, { ...deck, title }) });\n    },\n\n    setActiveTab(tab) {\n      set({ activeTab: tab });\n    },\n\n    setEditorMode(mode) {\n      set({ editorMode: mode });\n    },\n\n    undo() {\n      set({ history: undoHistory(get().history) });\n    },\n\n    redo() {\n      set({ history: redoHistory(get().history) });\n    },\n\n    select(selection) {\n      set({ selection });\n    },\n\n    addSlide() {\n      const deck = get().history.present;\n      const slide: Slide = {\n        id: nanoid(),\n        size: { w: 1280, h: 720 },\n        background: { color: \"#FFFFFF\" },\n        elements: []\n      };\n\n      const next = { ...deck, slides: [...deck.slides, slide] };\n      set({\n        history: pushHistory(get().history, next),\n        activeSlideId: slide.id,\n        selection: null\n      });\n    },\n\n    setActiveSlide(slideId) {\n      set({ activeSlideId: slideId, selection: null });\n    },\n\n    addElement(el) {\n      const deck = get().history.present;\n      const slideId = get().activeSlideId;\n      const slides = deck.slides.map((s) => (s.id === slideId ? { ...s, elements: [...s.elements, el] } : s));\n      set({ history: pushHistory(get().history, { ...deck, slides }) });\n      set({ selection: { slideId, elementId: el.id } });\n    },\n\n    updateElement(elementId, patch) {\n      const deck = get().history.present;\n      const slideId = get().activeSlideId;\n      const slides = deck.slides.map((s) => {\n        if (s.id !== slideId) return s;\n        return {\n          ...s,\n          elements: s.elements.map((e) => (e.id === elementId ? { ...e, ...patch } as any : e))\n        };\n      });\n      set({ history: pushHistory(get().history, { ...deck, slides }) });\n    },\n\n    bringToFront(elementId) {\n      const deck = get().history.present;\n      const slide = deck.slides.find((s) => s.id === get().activeSlideId)!;\n      const maxZ = Math.max(0, ...slide.elements.map((e) => e.zIndex ?? 0));\n      get().updateElement(elementId, { zIndex: maxZ + 1 });\n    },\n\n    sendToBack(elementId) {\n      const deck = get().history.present;\n      const slide = deck.slides.find((s) => s.id === get().activeSlideId)!;\n      const minZ = Math.min(0, ...slide.elements.map((e) => e.zIndex ?? 0));\n      get().updateElement(elementId, { zIndex: minZ - 1 });\n    },\n\n    deleteElement(elementId) {\n      const deck = get().history.present;\n      const slideId = get().activeSlideId;\n      const slides = deck.slides.map((s) =>\n        s.id === slideId ? { ...s, elements: s.elements.filter((e) => e.id !== elementId) } : s\n      );\n      set({ history: pushHistory(get().history, { ...deck, slides }), selection: null });\n    },\n\n    updateTextDelta(elementId, delta) {\n      const deck = get().history.present;\n      const slideId = get().activeSlideId;\n      const slides = deck.slides.map((s) => {\n        if (s.id !== slideId) return s;\n        return {\n          ...s,\n          elements: s.elements.map((e) => (e.id === elementId && e.type === \"text\" ? ({ ...e, delta } as any) : e))\n        };\n      });\n      set({ history: pushHistory(get().history, { ...deck, slides }) });\n    },\n\n    applyTextStyleToDefault(elementId, patch) {\n      const deck = get().history.present;\n      const slideId = get().activeSlideId;\n      const slides = deck.slides.map((s) => {\n        if (s.id !== slideId) return s;\n        return {\n          ...s,\n          elements: s.elements.map((e) => {\n            if (e.id !== elementId) return e;\n            if (e.type !== \"text\") return e;\n            return {\n              ...e,\n              defaultTextStyle: { ...e.defaultTextStyle, ...patch }\n            };\n          })\n        };\n      });\n      set({ history: pushHistory(get().history, { ...deck, slides }) });\n    },\n\n    setStreaming(active, requestId) {\n      set({ streaming: { active, requestId } });\n    },\n\n    getDeck() {\n      return get().history.present;\n    },\n\n    getActiveSlide() {\n      const deck = get().history.present;\n      return deck.slides.find((s) => s.id === get().activeSlideId)!;\n    },\n\n    getSelectedElement() {\n      const sel = get().selection;\n      if (!sel) return null;\n      const deck = get().history.present;\n      const slide = deck.slides.find((s) => s.id === sel.slideId);\n      return slide?.elements.find((e) => e.id === sel.elementId) ?? null;\n    }\n  };\n});\n```\n\n---\n\n## C9) API helpers — `apps/web/src/api/http.ts`\n\n```ts\nexport const API_BASE = \"http://localhost:3001\";\n\nexport async function postJSON<T>(path: string, body: any): Promise<T> {\n  const res = await fetch(`${API_BASE}${path}`, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(body)\n  });\n  if (!res.ok) throw new Error(await res.text());\n  return res.json();\n}\n\nexport async function getJSON<T>(path: string): Promise<T> {\n  const res = await fetch(`${API_BASE}${path}`);\n  if (!res.ok) throw new Error(await res.text());\n  return res.json();\n}\n```\n\n---\n\n## C10) WS client — `apps/web/src/api/wsClient.ts`\n\n```ts\ntype WSMessage =\n  | { type: \"hello\"; server: string }\n  | { type: \"llm_token\"; requestId: string; token: string }\n  | { type: \"llm_done\"; requestId: string }\n  | { type: \"llm_error\"; requestId: string; message: string }\n  | { type: \"image_result\"; requestId: string; imageUrl: string }\n  | { type: \"chart_result\"; requestId: string; spec: any };\n\nexport type WSHandlers = {\n  onMessage(msg: WSMessage): void;\n};\n\nexport class EditorWS {\n  private ws: WebSocket | null = null;\n  private handlers: WSHandlers;\n\n  constructor(handlers: WSHandlers) {\n    this.handlers = handlers;\n  }\n\n  connect() {\n    if (this.ws) return;\n    const ws = new WebSocket(\"ws://localhost:3001/ws\");\n    this.ws = ws;\n\n    ws.onmessage = (ev) => {\n      try {\n        const msg = JSON.parse(ev.data);\n        this.handlers.onMessage(msg);\n      } catch {\n        // ignore\n      }\n    };\n\n    ws.onclose = () => {\n      this.ws = null;\n      // TODO(PROD): reconectar con backoff\n    };\n  }\n\n  send(data: any) {\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;\n    this.ws.send(JSON.stringify(data));\n  }\n\n  close() {\n    this.ws?.close();\n    this.ws = null;\n  }\n}\n```\n\n---\n\n## C11) Fonts loader — `apps/web/src/api/fonts.ts`\n\n```ts\nimport { getJSON, API_BASE } from \"./http\";\n\nexport type GoogleFontsResponse = { items: { family: string }[]; source?: string };\n\nexport async function fetchGoogleFonts(): Promise<string[]> {\n  const json = await getJSON<GoogleFontsResponse>(\"/api/fonts/google\");\n  return (json.items ?? []).map((x) => x.family);\n}\n\nexport async function injectGoogleFontCss(family: string) {\n  const id = `gf-${family.replace(/\\s+/g, \"-\").toLowerCase()}`;\n  if (document.getElementById(id)) return;\n\n  const link = document.createElement(\"link\");\n  link.id = id;\n  link.rel = \"stylesheet\";\n  link.href = `${API_BASE}/api/fonts/google/css?family=${encodeURIComponent(family)}`;\n  document.head.appendChild(link);\n}\n```\n\n---\n\n## C12) Export API — `apps/web/src/api/export.ts`\n\n```ts\nimport { postJSON } from \"./http\";\nimport type { Deck } from \"../store/types\";\n\nexport async function exportPptx(deck: Deck): Promise<Blob> {\n  const res = await fetch(\"http://localhost:3001/api/export/pptx\", {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify({ deck })\n  });\n  if (!res.ok) throw new Error(await res.text());\n  return res.blob();\n}\n\nexport function downloadBlob(blob: Blob, filename: string) {\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement(\"a\");\n  a.href = url;\n  a.download = filename;\n  a.click();\n  URL.revokeObjectURL(url);\n}\n```\n\n---\n\n## C13) App layout — `apps/web/src/App.tsx`\n\n```tsx\nimport React, { useMemo } from \"react\";\nimport { useDeckStore } from \"./store/deckStore\";\nimport { Ribbon } from \"./ribbon/Ribbon\";\nimport { ChatPanel } from \"./chat/ChatPanel\";\nimport { EditorShell } from \"./editor/EditorShell\";\nimport { exportPptx, downloadBlob } from \"./api/export\";\n\nexport default function App() {\n  const deck = useDeckStore((s) => s.history.present);\n  const undo = useDeckStore((s) => s.undo);\n  const redo = useDeckStore((s) => s.redo);\n\n  const canUndo = useDeckStore((s) => s.history.past.length > 0);\n  const canRedo = useDeckStore((s) => s.history.future.length > 0);\n\n  const title = useDeckStore((s) => s.history.present.title);\n  const setTitle = useDeckStore((s) => s.setTitle);\n\n  const [exportOpen, setExportOpen] = React.useState(false);\n\n  const onExport = async (fmt: \"pptx\" | \"pdf\" | \"png\") => {\n    setExportOpen(false);\n\n    if (fmt === \"pptx\") {\n      const blob = await exportPptx(deck);\n      downloadBlob(blob, `${sanitize(title) || \"presentation\"}.pptx`);\n      return;\n    }\n\n    // TODO(PROD): Implementar PDF/PNG por slide en backend.\n    alert(`Export ${fmt} aún no implementado. (TODO)`);\n  };\n\n  return (\n    <div className=\"app\">\n      {/* LEFT: Chat */}\n      <div className=\"leftPanel\">\n        <div className=\"chatHeader\">Chat IA</div>\n        <ChatPanel />\n      </div>\n\n      {/* RIGHT: Editor */}\n      <div className=\"rightPanel\">\n        {/* HEADER BAR */}\n        <div className=\"headerBar\">\n          <button className=\"iconBtn\" onClick={undo} disabled={!canUndo} title=\"Undo\">↶</button>\n          <button className=\"iconBtn\" onClick={redo} disabled={!canRedo} title=\"Redo\">↷</button>\n\n          <input\n            className=\"headerTitleInput\"\n            value={title}\n            onChange={(e) => setTitle(e.target.value)}\n            aria-label=\"Título de la presentación\"\n          />\n\n          <div className=\"headerSpacer\" />\n\n          <div style={{ position: \"relative\" }}>\n            <button className=\"pill primary\" onClick={() => setExportOpen((v) => !v)}>\n              Export ▾\n            </button>\n\n            {exportOpen && (\n              <div\n                style={{\n                  position: \"absolute\",\n                  right: 0,\n                  top: \"calc(100% + 8px)\",\n                  background: \"#fff\",\n                  border: \"1px solid var(--line)\",\n                  borderRadius: 12,\n                  boxShadow: \"var(--shadow)\",\n                  overflow: \"hidden\",\n                  minWidth: 220,\n                  zIndex: 20\n                }}\n              >\n                <MenuItem label=\"Exportar PPTX\" onClick={() => onExport(\"pptx\")} />\n                <MenuItem label=\"Exportar PDF\" onClick={() => onExport(\"pdf\")} />\n                <MenuItem label=\"Exportar PNG (por slide)\" onClick={() => onExport(\"png\")} />\n              </div>\n            )}\n          </div>\n\n          <button className=\"pill\" onClick={() => alert(\"Cerrar (stub).\")}>Cerrar ✕</button>\n        </div>\n\n        {/* RIBBON */}\n        <Ribbon />\n\n        {/* EDITOR */}\n        <EditorShell />\n      </div>\n    </div>\n  );\n}\n\nfunction MenuItem({ label, onClick }: { label: string; onClick: () => void }) {\n  return (\n    <div\n      onClick={onClick}\n      style={{ padding: \"10px 12px\", cursor: \"pointer\", borderBottom: \"1px solid rgba(0,0,0,0.06)\" }}\n    >\n      {label}\n    </div>\n  );\n}\n\nfunction sanitize(s: string) {\n  return s.replace(/[^a-z0-9\\-_ ]/gi, \"\").trim().replace(/\\s+/g, \"_\");\n}\n```\n\n---\n\n# C14) Ribbon (tabs + cuerpos) — `apps/web/src/ribbon/Ribbon.tsx`\n\n```tsx\nimport React from \"react\";\nimport { useDeckStore } from \"../store/deckStore\";\nimport { HomeTab } from \"./tabs/HomeTab\";\nimport { InsertTab } from \"./tabs/InsertTab\";\nimport { LayoutTab } from \"./tabs/LayoutTab\";\nimport { ReferencesTab } from \"./tabs/ReferencesTab\";\nimport { ReviewTab } from \"./tabs/ReviewTab\";\nimport { ViewTab } from \"./tabs/ViewTab\";\nimport { AITab } from \"./tabs/AITab\";\n\nexport function Ribbon() {\n  const activeTab = useDeckStore((s) => s.activeTab);\n  const setActiveTab = useDeckStore((s) => s.setActiveTab);\n\n  return (\n    <div className=\"ribbon\">\n      <div className=\"tabsRow\">\n        {([\"Home\", \"Insert\", \"Layout\", \"References\", \"Review\", \"View\", \"AI\"] as const).map((t) => (\n          <div\n            key={t}\n            className={\"tab \" + (activeTab === t ? \"active\" : \"\")}\n            onClick={() => setActiveTab(t)}\n          >\n            {labelOf(t)}\n          </div>\n        ))}\n      </div>\n\n      <div className=\"ribbonBody\">\n        {activeTab === \"Home\" && <HomeTab />}\n        {activeTab === \"Insert\" && <InsertTab />}\n        {activeTab === \"Layout\" && <LayoutTab />}\n        {activeTab === \"References\" && <ReferencesTab />}\n        {activeTab === \"Review\" && <ReviewTab />}\n        {activeTab === \"View\" && <ViewTab />}\n        {activeTab === \"AI\" && <AITab />}\n      </div>\n    </div>\n  );\n}\n\nfunction labelOf(t: string) {\n  switch (t) {\n    case \"Home\": return \"Inicio\";\n    case \"Insert\": return \"Insertar\";\n    case \"Layout\": return \"Diseño\";\n    case \"References\": return \"Referencias\";\n    case \"Review\": return \"Revisar\";\n    case \"View\": return \"Vista\";\n    case \"AI\": return \"IA\";\n    default: return t;\n  }\n}\n```\n\n---\n\n## C15) Home tab — `apps/web/src/ribbon/tabs/HomeTab.tsx`\n\nIncluye:\n- Clipboard: paste / paste-special (stub)\n- Font: selector Google Fonts, size, toggles (B/I/U/S), link modal, color picker\n- Paragraph: bullets, numbers, align group\n- Styles: H1/H2/H3 presets\n\n```tsx\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport { nanoid } from \"nanoid\";\nimport { useDeckStore } from \"../../store/deckStore\";\nimport type { TextElement } from \"../../store/types\";\nimport { fetchGoogleFonts, injectGoogleFontCss } from \"../../api/fonts\";\nimport { HyperlinkModal } from \"../../editor/overlays/HyperlinkModal\";\n\n// Nota: El formateo real por rango vive en RichTextOverlay (Quill).\n// Aquí emitimos \"comandos\" a un bus sencillo basado en window events.\nfunction emitQuillCommand(cmd: { type: string; payload?: any }) {\n  window.dispatchEvent(new CustomEvent(\"quill-command\", { detail: cmd }));\n}\n\nexport function HomeTab() {\n  const selected = useDeckStore((s) => s.getSelectedElement()) as any;\n  const selection = useDeckStore((s) => s.selection);\n\n  const applyDefaultTextStyle = useDeckStore((s) => s.applyTextStyleToDefault);\n\n  const [fonts, setFonts] = useState<string[]>([\"Inter\", \"Roboto\", \"Open Sans\"]);\n  const [linkOpen, setLinkOpen] = useState(false);\n\n  const isText = selected?.type === \"text\";\n  const textEl: TextElement | null = isText ? selected : null;\n\n  useEffect(() => {\n    fetchGoogleFonts().then(setFonts).catch(() => {});\n  }, []);\n\n  const fontFamily = textEl?.defaultTextStyle.fontFamily ?? \"Inter\";\n  const fontSize = textEl?.defaultTextStyle.fontSize ?? 18;\n  const color = textEl?.defaultTextStyle.color ?? \"#111111\";\n\n  const toggles = {\n    bold: !!textEl?.defaultTextStyle.bold,\n    italic: !!textEl?.defaultTextStyle.italic,\n    underline: !!textEl?.defaultTextStyle.underline,\n    strike: !!textEl?.defaultTextStyle.strike\n  };\n\n  const setFontFamily = async (family: string) => {\n    if (!selection || !textEl) return;\n    await injectGoogleFontCss(family);\n    applyDefaultTextStyle(textEl.id, { fontFamily: family });\n\n    // para selección en Quill (rango), enviamos comando:\n    emitQuillCommand({ type: \"format\", payload: { key: \"font\", value: family } });\n  };\n\n  const setFontSize = (size: number) => {\n    if (!selection || !textEl) return;\n    applyDefaultTextStyle(textEl.id, { fontSize: size });\n    emitQuillCommand({ type: \"format\", payload: { key: \"size\", value: size } });\n  };\n\n  const toggle = (key: keyof typeof toggles) => {\n    if (!selection || !textEl) return;\n    const next = !toggles[key];\n    applyDefaultTextStyle(textEl.id, { [key]: next } as any);\n    emitQuillCommand({ type: \"format\", payload: { key, value: next } });\n  };\n\n  const applyHeading = (h: 1 | 2 | 3) => {\n    // Quill usa 'header' para H1/H2/H3\n    emitQuillCommand({ type: \"format\", payload: { key: \"header\", value: h } });\n    // defaultStyle: ajusta un size sugerido\n    if (textEl) {\n      const preset = h === 1 ? 44 : h === 2 ? 32 : 24;\n      applyDefaultTextStyle(textEl.id, { fontSize: preset, bold: true });\n    }\n  };\n\n  return (\n    <>\n      {/* Clipboard */}\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"Paste (stub)\")}>Pegar ▾</button>\n          <button className=\"pill\" onClick={() => alert(\"Paste Special (stub)\")}>Pegado especial</button>\n        </div>\n        <div className=\"groupTitle\">Portapapeles</div>\n      </div>\n\n      {/* Font */}\n      <div className=\"group\">\n        <div className=\"row\">\n          <select className=\"select\" value={fontFamily} disabled={!isText} onChange={(e) => setFontFamily(e.target.value)}>\n            {fonts.slice(0, 80).map((f) => (\n              <option key={f} value={f}>{f}</option>\n            ))}\n          </select>\n\n          <input\n            className=\"input\"\n            type=\"number\"\n            value={fontSize}\n            min={6}\n            max={160}\n            disabled={!isText}\n            onChange={(e) => setFontSize(Number(e.target.value))}\n            style={{ width: 86 }}\n          />\n\n          <select\n            className=\"select\"\n            disabled={!isText}\n            value={fontSize}\n            onChange={(e) => setFontSize(Number(e.target.value))}\n          >\n            {[10, 12, 14, 16, 18, 20, 24, 28, 32, 36, 44, 54, 64, 72].map((s) => (\n              <option key={s} value={s}>{s}</option>\n            ))}\n          </select>\n        </div>\n\n        <div className=\"row\">\n          <button className={\"toggleBtn \" + (toggles.bold ? \"active\" : \"\")} disabled={!isText} onClick={() => toggle(\"bold\")}><b>B</b></button>\n          <button className={\"toggleBtn \" + (toggles.italic ? \"active\" : \"\")} disabled={!isText} onClick={() => toggle(\"italic\")}><i>I</i></button>\n          <button className={\"toggleBtn \" + (toggles.underline ? \"active\" : \"\")} disabled={!isText} onClick={() => toggle(\"underline\")}><u>U</u></button>\n          <button className={\"toggleBtn \" + (toggles.strike ? \"active\" : \"\")} disabled={!isText} onClick={() => toggle(\"strike\")}><s>S</s></button>\n\n          <button className=\"pill\" disabled={!isText} onClick={() => setLinkOpen(true)}>Enlace</button>\n\n          <input\n            type=\"color\"\n            value={color}\n            disabled={!isText}\n            onChange={(e) => {\n              if (!textEl) return;\n              applyDefaultTextStyle(textEl.id, { color: e.target.value });\n              emitQuillCommand({ type: \"format\", payload: { key: \"color\", value: e.target.value } });\n            }}\n            title=\"Color de texto\"\n            style={{ width: 44, height: 34, border: \"none\", background: \"transparent\" }}\n          />\n        </div>\n\n        <div className=\"groupTitle\">Fuente</div>\n      </div>\n\n      {/* Paragraph */}\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" disabled={!isText} onClick={() => emitQuillCommand({ type: \"list\", payload: \"bullet\" })}>• Lista</button>\n          <button className=\"pill\" disabled={!isText} onClick={() => emitQuillCommand({ type: \"list\", payload: \"ordered\" })}>1. Lista</button>\n        </div>\n\n        <div className=\"row\">\n          <button className=\"pill\" disabled={!isText} onClick={() => emitQuillCommand({ type: \"align\", payload: \"left\" })}>⟸</button>\n          <button className=\"pill\" disabled={!isText} onClick={() => emitQuillCommand({ type: \"align\", payload: \"center\" })}>≡</button>\n          <button className=\"pill\" disabled={!isText} onClick={() => emitQuillCommand({ type: \"align\", payload: \"right\" })}>⟹</button>\n          <button className=\"pill\" disabled={!isText} onClick={() => emitQuillCommand({ type: \"align\", payload: \"justify\" })}>☰</button>\n        </div>\n\n        <div className=\"groupTitle\">Párrafo</div>\n      </div>\n\n      {/* Styles */}\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" disabled={!isText} onClick={() => applyHeading(1)}>H1</button>\n          <button className=\"pill\" disabled={!isText} onClick={() => applyHeading(2)}>H2</button>\n          <button className=\"pill\" disabled={!isText} onClick={() => applyHeading(3)}>H3</button>\n        </div>\n        <div className=\"groupTitle\">Estilos</div>\n      </div>\n\n      {linkOpen && <HyperlinkModal onClose={() => setLinkOpen(false)} />}\n    </>\n  );\n}\n```\n\n---\n\n## C16) Insert tab — `apps/web/src/ribbon/tabs/InsertTab.tsx`\n\nIncluye: imágenes, shapes, gráficos, tablas, videos, iconos (varios stubs).\n\n```tsx\nimport React from \"react\";\nimport { nanoid } from \"nanoid\";\nimport { useDeckStore } from \"../../store/deckStore\";\nimport type { ImageElement, ShapeElement, ChartElement } from \"../../store/types\";\n\nexport function InsertTab() {\n  const addElement = useDeckStore((s) => s.addElement);\n\n  const onInsertRect = () => {\n    const el: ShapeElement = {\n      id: nanoid(),\n      type: \"shape\",\n      shapeType: \"rect\",\n      x: 120,\n      y: 220,\n      w: 260,\n      h: 140,\n      fill: \"#E5E7EB\",\n      stroke: \"#111111\",\n      strokeWidth: 1,\n      zIndex: 10\n    };\n    addElement(el);\n  };\n\n  const onInsertEllipse = () => {\n    const el: ShapeElement = {\n      id: nanoid(),\n      type: \"shape\",\n      shapeType: \"ellipse\",\n      x: 450,\n      y: 240,\n      w: 220,\n      h: 140,\n      fill: \"#DBEAFE\",\n      stroke: \"#111111\",\n      strokeWidth: 1,\n      zIndex: 10\n    };\n    addElement(el);\n  };\n\n  const onInsertImage = async () => {\n    const input = document.createElement(\"input\");\n    input.type = \"file\";\n    input.accept = \"image/*\";\n    input.onchange = async () => {\n      const file = input.files?.[0];\n      if (!file) return;\n      const dataUrl = await fileToDataUrl(file);\n\n      const el: ImageElement = {\n        id: nanoid(),\n        type: \"image\",\n        x: 120,\n        y: 120,\n        w: 420,\n        h: 260,\n        src: dataUrl,\n        mime: file.type,\n        zIndex: 20\n      };\n      addElement(el);\n    };\n    input.click();\n  };\n\n  const onInsertChartStub = () => {\n    const el: ChartElement = {\n      id: nanoid(),\n      type: \"chart\",\n      x: 120,\n      y: 420,\n      w: 520,\n      h: 240,\n      zIndex: 30,\n      spec: {\n        title: { text: \"Chart (stub)\" },\n        xAxis: { type: \"category\", data: [\"A\", \"B\", \"C\"] },\n        yAxis: { type: \"value\" },\n        series: [{ type: \"bar\", data: [5, 20, 36] }]\n      }\n    };\n    addElement(el);\n  };\n\n  return (\n    <>\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={onInsertImage}>Imagen</button>\n          <button className=\"pill\" onClick={() => alert(\"Video (stub)\")}>Video</button>\n          <button className=\"pill\" onClick={() => alert(\"Iconos (stub)\")}>Iconos</button>\n        </div>\n        <div className=\"groupTitle\">Medios</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={onInsertRect}>Rect</button>\n          <button className=\"pill\" onClick={onInsertEllipse}>Elipse</button>\n        </div>\n        <div className=\"groupTitle\">Formas</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={onInsertChartStub}>Gráfico</button>\n          <button className=\"pill\" onClick={() => alert(\"Tabla (stub)\")}>Tabla</button>\n        </div>\n        <div className=\"groupTitle\">Datos</div>\n      </div>\n    </>\n  );\n}\n\nasync function fileToDataUrl(file: File): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(String(reader.result));\n    reader.onerror = reject;\n    reader.readAsDataURL(file);\n  });\n}\n```\n\n---\n\n## C17) Layout tab — `apps/web/src/ribbon/tabs/LayoutTab.tsx`\n\n```tsx\nimport React from \"react\";\n\nexport function LayoutTab() {\n  return (\n    <>\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"Master slides (stub)\")}>Master Slides</button>\n          <button className=\"pill\" onClick={() => alert(\"Templates (stub)\")}>Templates</button>\n        </div>\n        <div className=\"groupTitle\">Maestros</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"Grid presets (stub)\")}>Grids</button>\n          <button className=\"pill\" onClick={() => alert(\"Guides presets (stub)\")}>Guías</button>\n        </div>\n        <div className=\"groupTitle\">Rejillas</div>\n      </div>\n    </>\n  );\n}\n```\n\n---\n\n## C18) References tab — `apps/web/src/ribbon/tabs/ReferencesTab.tsx`\n\n```tsx\nimport React from \"react\";\n\nexport function ReferencesTab() {\n  return (\n    <>\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"Footnotes (stub)\")}>Notas al pie</button>\n          <button className=\"pill\" onClick={() => alert(\"Bibliography (stub)\")}>Bibliografía</button>\n        </div>\n        <div className=\"groupTitle\">Citas</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"TOC auto (stub)\")}>Tabla de contenidos</button>\n        </div>\n        <div className=\"groupTitle\">Índice</div>\n      </div>\n    </>\n  );\n}\n```\n\n---\n\n## C19) Review tab — `apps/web/src/ribbon/tabs/ReviewTab.tsx`\n\n```tsx\nimport React from \"react\";\n\nexport function ReviewTab() {\n  return (\n    <>\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"Comentarios (stub)\")}>Comentarios</button>\n          <button className=\"pill\" onClick={() => alert(\"Historial (stub)\")}>Historial</button>\n        </div>\n        <div className=\"groupTitle\">Revisión</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"Modo presentador (stub)\")}>Modo presentador</button>\n        </div>\n        <div className=\"groupTitle\">Presentación</div>\n      </div>\n    </>\n  );\n}\n```\n\n---\n\n## C20) View tab — `apps/web/src/ribbon/tabs/ViewTab.tsx`\n\n```tsx\nimport React from \"react\";\nimport { useDeckStore } from \"../../store/deckStore\";\n\nexport function ViewTab() {\n  // TODO: conectar con estado de zoom / grid / ruler\n  return (\n    <>\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => window.dispatchEvent(new CustomEvent(\"view-zoom\", { detail: 1 }))}>Zoom 100%</button>\n          <button className=\"pill\" onClick={() => window.dispatchEvent(new CustomEvent(\"view-zoom\", { detail: 1.25 }))}>Zoom 125%</button>\n          <button className=\"pill\" onClick={() => window.dispatchEvent(new CustomEvent(\"view-zoom\", { detail: 0.8 }))}>Zoom 80%</button>\n        </div>\n        <div className=\"groupTitle\">Zoom</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => window.dispatchEvent(new CustomEvent(\"view-grid-toggle\"))}>Grid</button>\n          <button className=\"pill\" onClick={() => window.dispatchEvent(new CustomEvent(\"view-ruler-toggle\"))}>Regla</button>\n        </div>\n        <div className=\"groupTitle\">Guías</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => alert(\"Slide sorter (stub)\")}>Clasificador</button>\n          <button className=\"pill\" onClick={() => alert(\"Outline view (stub)\")}>Esquema</button>\n        </div>\n        <div className=\"groupTitle\">Vistas</div>\n      </div>\n    </>\n  );\n}\n```\n\n---\n\n## C21) AI tab — `apps/web/src/ribbon/tabs/AITab.tsx`\n\nIncluye acciones:\n- generar slide\n- mejorar contenido\n- generar imagen\n- crear gráfico\n- sugerir diseño\n- toggle AI/manual\n\n```tsx\nimport React from \"react\";\nimport { useDeckStore } from \"../../store/deckStore\";\n\nexport function AITab() {\n  const mode = useDeckStore((s) => s.editorMode);\n  const setMode = useDeckStore((s) => s.setEditorMode);\n\n  const sendCommand = (cmd: string) => {\n    window.dispatchEvent(new CustomEvent(\"ai-command\", { detail: cmd }));\n  };\n\n  return (\n    <>\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => sendCommand(\"Genera una diapositiva completa con título y 3 bullets sobre el tema actual.\")}>\n            Generar slide\n          </button>\n          <button className=\"pill\" onClick={() => sendCommand(\"Mejora el texto actual: claridad, concisión y tono ejecutivo.\")}>\n            Mejorar contenido\n          </button>\n        </div>\n        <div className=\"groupTitle\">Contenido</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => sendCommand(\"/img Genera una imagen hero relacionada con el tema de la diapositiva.\")}>\n            Generar imagen\n          </button>\n          <button className=\"pill\" onClick={() => sendCommand(\"/chart Crea un gráfico con los datos mencionados o sugiere un dataset razonable.\")}>\n            Crear gráfico\n          </button>\n        </div>\n        <div className=\"groupTitle\">Visuales</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className=\"pill\" onClick={() => sendCommand(\"Sugiere un diseño: layout, jerarquía tipográfica y paleta.\")}>\n            Sugerir diseño\n          </button>\n        </div>\n        <div className=\"groupTitle\">Diseño</div>\n      </div>\n\n      <div className=\"group\">\n        <div className=\"row\">\n          <button className={\"toggleBtn \" + (mode === \"ai\" ? \"active\" : \"\")} onClick={() => setMode(mode === \"ai\" ? \"manual\" : \"ai\")}>\n            Modo IA: {mode === \"ai\" ? \"ON\" : \"OFF\"}\n          </button>\n        </div>\n        <div className=\"groupTitle\">Modo</div>\n      </div>\n    </>\n  );\n}\n```\n\n---\n\n# PARTE D — EDITOR (Canvas + Panels + RichText)\n\n## D1) Editor shell — `apps/web/src/editor/EditorShell.tsx`\n\n```tsx\nimport React from \"react\";\nimport { SlidesPanel } from \"./panels/SlidesPanel\";\nimport { LayersPanel } from \"./panels/LayersPanel\";\nimport { PropertiesPanel } from \"./panels/PropertiesPanel\";\nimport { CanvasStage } from \"./CanvasStage\";\n\nexport function EditorShell() {\n  return (\n    <div className=\"editorArea\">\n      <div className=\"panel\">\n        <div className=\"panelHeader\">Diapositivas</div>\n        <div className=\"panelBody\">\n          <SlidesPanel />\n        </div>\n      </div>\n\n      <div className=\"canvasWrap\">\n        <CanvasStage />\n      </div>\n\n      <div className=\"panel\">\n        <div className=\"panelHeader\">Capas & Propiedades</div>\n        <div className=\"panelBody\" style={{ display: \"grid\", gap: 12 }}>\n          <PropertiesPanel />\n          <div style={{ height: 1, background: \"rgba(0,0,0,0.08)\" }} />\n          <LayersPanel />\n        </div>\n      </div>\n    </div>\n  );\n}\n```\n\n---\n\n## D2) Slides panel — `apps/web/src/editor/panels/SlidesPanel.tsx`\n\n```tsx\nimport React from \"react\";\nimport { useDeckStore } from \"../../store/deckStore\";\n\nexport function SlidesPanel() {\n  const deck = useDeckStore((s) => s.history.present);\n  const activeSlideId = useDeckStore((s) => s.activeSlideId);\n  const setActiveSlide = useDeckStore((s) => s.setActiveSlide);\n  const addSlide = useDeckStore((s) => s.addSlide);\n\n  return (\n    <div style={{ display: \"grid\", gap: 10 }}>\n      <button className=\"pill\" onClick={addSlide}>+ Nueva diapositiva</button>\n\n      {deck.slides.map((s, idx) => (\n        <div\n          key={s.id}\n          onClick={() => setActiveSlide(s.id)}\n          style={{\n            border: \"1px solid var(--line)\",\n            borderRadius: 12,\n            padding: 10,\n            cursor: \"pointer\",\n            background: activeSlideId === s.id ? \"rgba(37,99,235,0.06)\" : \"#fff\"\n          }}\n        >\n          <div style={{ fontWeight: 800, fontSize: 12, marginBottom: 6 }}>\n            {idx + 1}. Slide\n          </div>\n          <div style={{ fontSize: 12, color: \"var(--muted)\" }}>\n            {s.elements.length} elementos\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n```\n\n---\n\n## D3) Layers panel — `apps/web/src/editor/panels/LayersPanel.tsx`\n\n```tsx\nimport React from \"react\";\nimport { useDeckStore } from \"../../store/deckStore\";\n\nexport function LayersPanel() {\n  const slide = useDeckStore((s) => s.getActiveSlide());\n  const selection = useDeckStore((s) => s.selection);\n  const select = useDeckStore((s) => s.select);\n  const bringToFront = useDeckStore((s) => s.bringToFront);\n  const sendToBack = useDeckStore((s) => s.sendToBack);\n  const del = useDeckStore((s) => s.deleteElement);\n\n  const els = [...slide.elements].sort((a, b) => (b.zIndex ?? 0) - (a.zIndex ?? 0));\n\n  return (\n    <div style={{ display: \"grid\", gap: 8 }}>\n      <div style={{ fontWeight: 800 }}>Capas</div>\n\n      {els.map((e) => {\n        const active = selection?.elementId === e.id;\n        return (\n          <div\n            key={e.id}\n            onClick={() => select({ slideId: slide.id, elementId: e.id })}\n            style={{\n              padding: \"8px 10px\",\n              borderRadius: 10,\n              border: \"1px solid var(--line)\",\n              cursor: \"pointer\",\n              background: active ? \"rgba(37,99,235,0.06)\" : \"#fff\"\n            }}\n          >\n            <div style={{ display: \"flex\", justifyContent: \"space-between\", gap: 10 }}>\n              <div style={{ fontWeight: 700, fontSize: 12 }}>{e.type.toUpperCase()}</div>\n              <div style={{ fontSize: 12, color: \"var(--muted)\" }}>z={e.zIndex ?? 0}</div>\n            </div>\n\n            {active && (\n              <div style={{ display: \"flex\", gap: 8, marginTop: 8, flexWrap: \"wrap\" }}>\n                <button className=\"pill\" onClick={(ev) => { ev.stopPropagation(); bringToFront(e.id); }}>Frente</button>\n                <button className=\"pill\" onClick={(ev) => { ev.stopPropagation(); sendToBack(e.id); }}>Fondo</button>\n                <button className=\"pill\" onClick={(ev) => { ev.stopPropagation(); del(e.id); }}>Eliminar</button>\n              </div>\n            )}\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n```\n\n---\n\n## D4) Properties panel — `apps/web/src/editor/panels/PropertiesPanel.tsx`\n\n```tsx\nimport React from \"react\";\nimport { useDeckStore } from \"../../store/deckStore\";\n\nexport function PropertiesPanel() {\n  const el = useDeckStore((s) => s.getSelectedElement());\n  const update = useDeckStore((s) => s.updateElement);\n\n  if (!el) {\n    return <div style={{ color: \"var(--muted)\" }}>Selecciona un elemento para editar propiedades.</div>;\n  }\n\n  return (\n    <div style={{ display: \"grid\", gap: 10 }}>\n      <div style={{ fontWeight: 800 }}>Propiedades</div>\n\n      <Row label=\"X\">\n        <input className=\"input\" type=\"number\" value={el.x} onChange={(e) => update(el.id, { x: Number(e.target.value) } as any)} />\n      </Row>\n      <Row label=\"Y\">\n        <input className=\"input\" type=\"number\" value={el.y} onChange={(e) => update(el.id, { y: Number(e.target.value) } as any)} />\n      </Row>\n      <Row label=\"W\">\n        <input className=\"input\" type=\"number\" value={el.w} onChange={(e) => update(el.id, { w: Number(e.target.value) } as any)} />\n      </Row>\n      <Row label=\"H\">\n        <input className=\"input\" type=\"number\" value={el.h} onChange={(e) => update(el.id, { h: Number(e.target.value) } as any)} />\n      </Row>\n\n      {el.type === \"shape\" && (\n        <>\n          <Row label=\"Fill\">\n            <input type=\"color\" value={el.fill} onChange={(e) => update(el.id, { fill: e.target.value } as any)} />\n          </Row>\n          <Row label=\"Stroke\">\n            <input type=\"color\" value={el.stroke} onChange={(e) => update(el.id, { stroke: e.target.value } as any)} />\n          </Row>\n        </>\n      )}\n\n      {el.type === \"text\" && (\n        <>\n          <Row label=\"Font\">\n            <div style={{ fontSize: 12, color: \"var(--muted)\" }}>{el.defaultTextStyle.fontFamily}</div>\n          </Row>\n        </>\n      )}\n    </div>\n  );\n}\n\nfunction Row({ label, children }: { label: string; children: React.ReactNode }) {\n  return (\n    <div style={{ display: \"grid\", gridTemplateColumns: \"70px 1fr\", gap: 10, alignItems: \"center\" }}>\n      <div style={{ fontSize: 12, color: \"var(--muted)\" }}>{label}</div>\n      <div>{children}</div>\n    </div>\n  );\n}\n```\n\n---\n\n## D5) Canvas stage — `apps/web/src/editor/CanvasStage.tsx`\n\nIncluye:\n- Stage Konva con zoom\n- Sync store <-> canvas\n- Selection + Transformer\n- Snap-to-grid + guides\n- RichText overlay cuando editas texto (doble click)\n- Cursor animado durante streaming\n\n```tsx\nimport React, { useEffect, useMemo, useRef, useState } from \"react\";\nimport { Stage, Layer, Rect, Transformer, Line } from \"react-konva\";\nimport Konva from \"konva\";\nimport { useDeckStore } from \"../store/deckStore\";\nimport type { ElementAny, TextElement } from \"../store/types\";\nimport { TextNode } from \"./elements/TextNode\";\nimport { ShapeNode } from \"./elements/ShapeNode\";\nimport { ImageNode } from \"./elements/ImageNode\";\nimport { ChartNode } from \"./elements/ChartNode\";\nimport { RichTextOverlay } from \"./overlays/RichTextOverlay\";\nimport { computeGuides, type GuideLine } from \"./guides/guides\";\nimport { snapToGrid } from \"./guides/snap\";\nimport { useTypingStream } from \"../ai/typingStream\";\n\nexport function CanvasStage() {\n  const slide = useDeckStore((s) => s.getActiveSlide());\n  const selection = useDeckStore((s) => s.selection);\n  const select = useDeckStore((s) => s.select);\n  const updateElement = useDeckStore((s) => s.updateElement);\n  const streaming = useDeckStore((s) => s.streaming.active);\n\n  const [zoom, setZoom] = useState(1);\n  const [showGrid, setShowGrid] = useState(true);\n\n  const stageRef = useRef<Konva.Stage>(null);\n  const trRef = useRef<Konva.Transformer>(null);\n\n  const [editingTextId, setEditingTextId] = useState<string | null>(null);\n  const [overlayRect, setOverlayRect] = useState<{ left: number; top: number; width: number; height: number } | null>(null);\n\n  const [guides, setGuides] = useState<GuideLine[]>([]);\n\n  // Streaming typing hook: inserta tokens en el elemento seleccionado (si text)\n  useTypingStream();\n\n  const selectedElement = selection ? slide.elements.find((e) => e.id === selection.elementId) ?? null : null;\n\n  // Attach transformer to selected node\n  useEffect(() => {\n    const stage = stageRef.current;\n    const tr = trRef.current;\n    if (!stage || !tr) return;\n\n    if (!selectedElement) {\n      tr.nodes([]);\n      tr.getLayer()?.batchDraw();\n      return;\n    }\n\n    const node = stage.findOne(`#el-${selectedElement.id}`);\n    if (node) {\n      tr.nodes([node]);\n      tr.getLayer()?.batchDraw();\n    }\n  }, [selectedElement?.id, slide.elements.length]);\n\n  // View events: zoom/grid toggle\n  useEffect(() => {\n    const onZoom = (e: any) => setZoom(Number(e.detail ?? 1));\n    const onGrid = () => setShowGrid((v) => !v);\n    window.addEventListener(\"view-zoom\", onZoom as any);\n    window.addEventListener(\"view-grid-toggle\", onGrid as any);\n    return () => {\n      window.removeEventListener(\"view-zoom\", onZoom as any);\n      window.removeEventListener(\"view-grid-toggle\", onGrid as any);\n    };\n  }, []);\n\n  const onStageMouseDown = (e: any) => {\n    // click en vacío -> deseleccionar\n    if (e.target === e.target.getStage()) {\n      select(null);\n      return;\n    }\n  };\n\n  const onSelectElement = (el: ElementAny) => {\n    select({ slideId: slide.id, elementId: el.id });\n  };\n\n  const onDragMove = (el: ElementAny, ev: any) => {\n    const node = ev.target as Konva.Node;\n    const pos = node.position();\n\n    const snapped = snapToGrid(pos, 8);\n    node.position(snapped);\n\n    // Guides (alineación con otros)\n    const stage = stageRef.current;\n    if (!stage) return;\n    const gs = computeGuides({\n      movingBox: node.getClientRect(),\n      elements: slide.elements.filter((x) => x.id !== el.id),\n      zoom\n    });\n    setGuides(gs);\n  };\n\n  const onDragEnd = (el: ElementAny, ev: any) => {\n    const node = ev.target as Konva.Node;\n    setGuides([]);\n    updateElement(el.id, { x: node.x(), y: node.y() } as any);\n  };\n\n  const onTransformEnd = (el: ElementAny, ev: any) => {\n    const node = ev.target as Konva.Node;\n\n    const scaleX = node.scaleX();\n    const scaleY = node.scaleY();\n\n    node.scaleX(1);\n    node.scaleY(1);\n\n    updateElement(el.id, {\n      x: node.x(),\n      y: node.y(),\n      w: Math.max(10, node.width() * scaleX),\n      h: Math.max(10, node.height() * scaleY),\n      rotation: node.rotation()\n    } as any);\n  };\n\n  const startEditingText = (el: TextElement) => {\n    const stage = stageRef.current;\n    if (!stage) return;\n    const node = stage.findOne(`#el-${el.id}`);\n    if (!node) return;\n\n    const rect = node.getClientRect();\n    const container = stage.container().getBoundingClientRect();\n\n    setOverlayRect({\n      left: container.left + rect.x,\n      top: container.top + rect.y,\n      width: rect.width,\n      height: rect.height\n    });\n\n    setEditingTextId(el.id);\n  };\n\n  const stopEditingText = () => {\n    setEditingTextId(null);\n    setOverlayRect(null);\n  };\n\n  // Grid lines (visual)\n  const gridLines = useMemo(() => {\n    if (!showGrid) return null;\n    const lines: React.ReactNode[] = [];\n    const step = 40;\n    for (let x = 0; x <= slide.size.w; x += step) {\n      lines.push(<Line key={\"gx\" + x} points={[x, 0, x, slide.size.h]} stroke=\"rgba(0,0,0,0.05)\" />);\n    }\n    for (let y = 0; y <= slide.size.h; y += step) {\n      lines.push(<Line key={\"gy\" + y} points={[0, y, slide.size.w, y]} stroke=\"rgba(0,0,0,0.05)\" />);\n    }\n    return lines;\n  }, [showGrid, slide.size.w, slide.size.h]);\n\n  // Cursor “typing” (simple): se dibuja cerca del elemento seleccionado si streaming\n  const typingCursor = useMemo(() => {\n    if (!streaming || !selectedElement || selectedElement.type !== \"text\") return null;\n    const x = selectedElement.x + Math.min(selectedElement.w - 6, 14);\n    const y = selectedElement.y + 14;\n    return <Rect x={x} y={y} width={2} height={24} fill={\"rgba(0,0,0,0.75)\"} opacity={0.9} />;\n  }, [streaming, selectedElement?.id]);\n\n  const sorted = useMemo(() => [...slide.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0)), [slide.elements]);\n\n  return (\n    <div style={{ width: \"100%\", height: \"100%\", position: \"relative\" }}>\n      <div className=\"canvasControls\">\n        <div className=\"pill\">Zoom {Math.round(zoom * 100)}%</div>\n        <button className=\"pill\" onClick={() => setZoom(1)}>Reset</button>\n      </div>\n\n      <Stage\n        ref={stageRef}\n        width={slide.size.w * zoom}\n        height={slide.size.h * zoom}\n        scaleX={zoom}\n        scaleY={zoom}\n        onMouseDown={onStageMouseDown}\n        style={{ background: \"#fff\" }}\n      >\n        <Layer>\n          {/* Fondo */}\n          <Rect x={0} y={0} width={slide.size.w} height={slide.size.h} fill={slide.background.color} />\n          {gridLines}\n        </Layer>\n\n        <Layer>\n          {sorted.map((el) => {\n            const common = {\n              key: el.id,\n              id: `el-${el.id}`,\n              el,\n              isSelected: selection?.elementId === el.id,\n              onSelect: () => onSelectElement(el),\n              onDragMove: (ev: any) => onDragMove(el, ev),\n              onDragEnd: (ev: any) => onDragEnd(el, ev),\n              onTransformEnd: (ev: any) => onTransformEnd(el, ev)\n            };\n\n            if (el.type === \"text\") {\n              return (\n                <TextNode\n                  {...common}\n                  onDblClick={() => startEditingText(el)}\n                />\n              );\n            }\n            if (el.type === \"shape\") return <ShapeNode {...common} />;\n            if (el.type === \"image\") return <ImageNode {...common} />;\n            if (el.type === \"chart\") return <ChartNode {...common} />;\n            return null;\n          })}\n\n          {typingCursor}\n\n          <Transformer\n            ref={trRef}\n            rotateEnabled\n            enabledAnchors={[\"top-left\", \"top-right\", \"bottom-left\", \"bottom-right\"]}\n            boundBoxFunc={(oldBox, newBox) => {\n              // evita tamaños negativos o muy pequeños\n              if (newBox.width < 10 || newBox.height < 10) return oldBox;\n              return newBox;\n            }}\n          />\n        </Layer>\n\n        {/* Guides */}\n        <Layer>\n          {guides.map((g, i) => (\n            <Line\n              key={i}\n              points={g.points}\n              stroke={\"rgba(37,99,235,0.55)\"}\n              strokeWidth={1}\n              dash={[6, 4]}\n            />\n          ))}\n        </Layer>\n      </Stage>\n\n      {/* Overlay editor para texto (Quill) */}\n      {editingTextId && overlayRect && (\n        <RichTextOverlay\n          elementId={editingTextId}\n          rect={overlayRect}\n          onClose={stopEditingText}\n        />\n      )}\n    </div>\n  );\n}\n```\n\n---\n\n## D6) Guides — `apps/web/src/editor/guides/snap.ts`\n\n```ts\nexport function snapToGrid(pos: { x: number; y: number }, gridSize: number) {\n  return {\n    x: Math.round(pos.x / gridSize) * gridSize,\n    y: Math.round(pos.y / gridSize) * gridSize\n  };\n}\n```\n\n---\n\n## D7) Guides — `apps/web/src/editor/guides/guides.ts`\n\n```ts\nimport type { ElementAny } from \"../../store/types\";\n\nexport type GuideLine = { points: number[] };\n\n// Simplificado: crea guías si el movingBox está cerca de bordes/centros de otros elementos.\n// En PROD: ampliar a muchos cases + performance (spatial index).\nexport function computeGuides(args: {\n  movingBox: { x: number; y: number; width: number; height: number };\n  elements: ElementAny[];\n  zoom: number;\n}): GuideLine[] {\n  const snapDist = 6;\n  const lines: GuideLine[] = [];\n\n  const mb = args.movingBox;\n  const mLeft = mb.x;\n  const mRight = mb.x + mb.width;\n  const mTop = mb.y;\n  const mBottom = mb.y + mb.height;\n  const mCx = mb.x + mb.width / 2;\n  const mCy = mb.y + mb.height / 2;\n\n  for (const el of args.elements) {\n    const left = el.x;\n    const right = el.x + el.w;\n    const top = el.y;\n    const bottom = el.y + el.h;\n    const cx = el.x + el.w / 2;\n    const cy = el.y + el.h / 2;\n\n    if (Math.abs(mCx - cx) < snapDist) {\n      lines.push({ points: [cx, 0, cx, 720] });\n    }\n    if (Math.abs(mCy - cy) < snapDist) {\n      lines.push({ points: [0, cy, 1280, cy] });\n    }\n    if (Math.abs(mLeft - left) < snapDist) {\n      lines.push({ points: [left, 0, left, 720] });\n    }\n    if (Math.abs(mRight - right) < snapDist) {\n      lines.push({ points: [right, 0, right, 720] });\n    }\n    if (Math.abs(mTop - top) < snapDist) {\n      lines.push({ points: [0, top, 1280, top] });\n    }\n    if (Math.abs(mBottom - bottom) < snapDist) {\n      lines.push({ points: [0, bottom, 1280, bottom] });\n    }\n  }\n\n  return dedupe(lines);\n}\n\nfunction dedupe(lines: GuideLine[]): GuideLine[] {\n  const set = new Set<string>();\n  const out: GuideLine[] = [];\n  for (const l of lines) {\n    const k = l.points.join(\",\");\n    if (set.has(k)) continue;\n    set.add(k);\n    out.push(l);\n  }\n  return out.slice(0, 10);\n}\n```\n\n---\n\n## D8) Element: Text — `apps/web/src/editor/elements/TextNode.tsx`\n\n```tsx\nimport React, { useMemo } from \"react\";\nimport { Text, Rect, Group } from \"react-konva\";\nimport type { TextElement } from \"../../store/types\";\n\nexport function TextNode(props: {\n  id: string;\n  el: TextElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onDragMove: (ev: any) => void;\n  onDragEnd: (ev: any) => void;\n  onTransformEnd: (ev: any) => void;\n  onDblClick: () => void;\n}) {\n  const { el, isSelected } = props;\n\n  const plainText = useMemo(() => deltaToPlain(el.delta), [el.delta]);\n\n  return (\n    <Group\n      id={props.id}\n      x={el.x}\n      y={el.y}\n      draggable={!el.locked}\n      rotation={el.rotation ?? 0}\n      onClick={props.onSelect}\n      onTap={props.onSelect}\n      onDblClick={props.onDblClick}\n      onDragMove={props.onDragMove}\n      onDragEnd={props.onDragEnd}\n      onTransformEnd={props.onTransformEnd}\n    >\n      {/* hitbox */}\n      <Rect width={el.w} height={el.h} fill=\"rgba(0,0,0,0.001)\" />\n\n      <Text\n        text={plainText}\n        width={el.w}\n        height={el.h}\n        fontFamily={el.defaultTextStyle.fontFamily}\n        fontSize={el.defaultTextStyle.fontSize}\n        fill={el.defaultTextStyle.color}\n        fontStyle={styleToFontStyle(el.defaultTextStyle)}\n        textDecoration={styleToDecoration(el.defaultTextStyle)}\n      />\n\n      {isSelected && (\n        <Rect\n          width={el.w}\n          height={el.h}\n          stroke=\"rgba(37,99,235,0.8)\"\n          strokeWidth={1}\n          dash={[6, 4]}\n        />\n      )}\n    </Group>\n  );\n}\n\nfunction deltaToPlain(delta: any): string {\n  let out = \"\";\n  for (const op of delta?.ops ?? []) {\n    if (typeof op.insert === \"string\") out += op.insert;\n  }\n  return out;\n}\n\nfunction styleToFontStyle(s: any): string {\n  const b = s.bold ? \"bold\" : \"normal\";\n  const i = s.italic ? \"italic\" : \"normal\";\n  // Konva usa string: \"bold italic\" etc.\n  if (b === \"bold\" && i === \"italic\") return \"bold italic\";\n  if (b === \"bold\") return \"bold\";\n  if (i === \"italic\") return \"italic\";\n  return \"normal\";\n}\n\nfunction styleToDecoration(s: any): string {\n  const u = s.underline ? \"underline\" : \"\";\n  const st = s.strike ? \"line-through\" : \"\";\n  return [u, st].filter(Boolean).join(\" \");\n}\n```\n\n---\n\n## D9) Element: Shape — `apps/web/src/editor/elements/ShapeNode.tsx`\n\n```tsx\nimport React from \"react\";\nimport { Rect, Ellipse } from \"react-konva\";\nimport type { ShapeElement } from \"../../store/types\";\n\nexport function ShapeNode(props: {\n  id: string;\n  el: ShapeElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onDragMove: (ev: any) => void;\n  onDragEnd: (ev: any) => void;\n  onTransformEnd: (ev: any) => void;\n}) {\n  const { el, isSelected } = props;\n\n  const common = {\n    id: props.id,\n    x: el.x,\n    y: el.y,\n    width: el.w,\n    height: el.h,\n    draggable: !el.locked,\n    rotation: el.rotation ?? 0,\n    onClick: props.onSelect,\n    onTap: props.onSelect,\n    onDragMove: props.onDragMove,\n    onDragEnd: props.onDragEnd,\n    onTransformEnd: props.onTransformEnd,\n    stroke: isSelected ? \"rgba(37,99,235,0.8)\" : el.stroke,\n    strokeWidth: el.strokeWidth,\n    fill: el.fill\n  };\n\n  if (el.shapeType === \"ellipse\") {\n    return (\n      <Ellipse\n        {...common as any}\n        radiusX={el.w / 2}\n        radiusY={el.h / 2}\n      />\n    );\n  }\n\n  return <Rect {...common as any} cornerRadius={el.radius ?? 10} />;\n}\n```\n\n---\n\n## D10) Element: Image — `apps/web/src/editor/elements/ImageNode.tsx`\n\n```tsx\nimport React, { useEffect, useState } from \"react\";\nimport { Image as KImage, Rect, Group } from \"react-konva\";\nimport type { ImageElement } from \"../../store/types\";\n\n// Nota: react-konva recomienda use-image; pero aquí usamos un hook minimal.\n// Si no quieres deps extra, implementa tu loader. Para simplicidad aquí lo incluimos inline.\nfunction useImageLocal(src: string) {\n  const [image, setImage] = useState<HTMLImageElement | null>(null);\n  useEffect(() => {\n    const img = new window.Image();\n    img.crossOrigin = \"anonymous\";\n    img.onload = () => setImage(img);\n    img.src = src;\n    return () => setImage(null);\n  }, [src]);\n  return image;\n}\n\nexport function ImageNode(props: {\n  id: string;\n  el: ImageElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onDragMove: (ev: any) => void;\n  onDragEnd: (ev: any) => void;\n  onTransformEnd: (ev: any) => void;\n}) {\n  const { el, isSelected } = props;\n  const img = useImageLocal(el.src);\n\n  return (\n    <Group\n      id={props.id}\n      x={el.x}\n      y={el.y}\n      draggable={!el.locked}\n      rotation={el.rotation ?? 0}\n      onClick={props.onSelect}\n      onTap={props.onSelect}\n      onDragMove={props.onDragMove}\n      onDragEnd={props.onDragEnd}\n      onTransformEnd={props.onTransformEnd}\n    >\n      <Rect width={el.w} height={el.h} fill=\"rgba(0,0,0,0.02)\" />\n      {img && <KImage image={img} width={el.w} height={el.h} />}\n      {isSelected && <Rect width={el.w} height={el.h} stroke=\"rgba(37,99,235,0.8)\" dash={[6,4]} />}\n    </Group>\n  );\n}\n```\n\n> Si tu build falla por `use-image`, elimina el import.\n\n---\n\n## D11) Element: Chart — `apps/web/src/editor/elements/ChartNode.tsx`\n\nRenderiza un chart con ECharts -> SVG y lo inserta como imagen en Konva.\n\n```tsx\nimport React, { useEffect, useState } from \"react\";\nimport { Group, Rect, Image as KImage } from \"react-konva\";\nimport type { ChartElement } from \"../../store/types\";\nimport * as echarts from \"echarts/core\";\nimport { BarChart, LineChart, PieChart } from \"echarts/charts\";\nimport { TitleComponent, TooltipComponent, GridComponent, LegendComponent } from \"echarts/components\";\nimport { SVGRenderer } from \"echarts/renderers\";\n\necharts.use([BarChart, LineChart, PieChart, TitleComponent, TooltipComponent, GridComponent, LegendComponent, SVGRenderer]);\n\nfunction svgToDataUri(svg: string) {\n  return \"data:image/svg+xml;base64,\" + btoa(unescape(encodeURIComponent(svg)));\n}\n\nfunction useImageLocal(src: string) {\n  const [image, setImage] = useState<HTMLImageElement | null>(null);\n  useEffect(() => {\n    const img = new window.Image();\n    img.crossOrigin = \"anonymous\";\n    img.onload = () => setImage(img);\n    img.src = src;\n    return () => setImage(null);\n  }, [src]);\n  return image;\n}\n\nexport function ChartNode(props: {\n  id: string;\n  el: ChartElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onDragMove: (ev: any) => void;\n  onDragEnd: (ev: any) => void;\n  onTransformEnd: (ev: any) => void;\n}) {\n  const { el, isSelected } = props;\n  const [uri, setUri] = useState<string>(\"\");\n\n  useEffect(() => {\n    // render fuera de pantalla a SVG\n    const div = document.createElement(\"div\");\n    div.style.width = el.w + \"px\";\n    div.style.height = el.h + \"px\";\n    div.style.position = \"absolute\";\n    div.style.left = \"-99999px\";\n    div.style.top = \"-99999px\";\n    document.body.appendChild(div);\n\n    const chart = echarts.init(div, undefined, { renderer: \"svg\" });\n    chart.setOption(el.spec ?? {}, true);\n\n    // ECharts SVG export\n    const svg = chart.renderToSVGString();\n\n    setUri(svgToDataUri(svg));\n\n    chart.dispose();\n    document.body.removeChild(div);\n  }, [JSON.stringify(el.spec), el.w, el.h]);\n\n  const img = useImageLocal(uri);\n\n  return (\n    <Group\n      id={props.id}\n      x={el.x}\n      y={el.y}\n      draggable={!el.locked}\n      rotation={el.rotation ?? 0}\n      onClick={props.onSelect}\n      onTap={props.onSelect}\n      onDragMove={props.onDragMove}\n      onDragEnd={props.onDragEnd}\n      onTransformEnd={props.onTransformEnd}\n    >\n      <Rect width={el.w} height={el.h} fill=\"rgba(0,0,0,0.02)\" />\n      {img && <KImage image={img} width={el.w} height={el.h} />}\n      {isSelected && <Rect width={el.w} height={el.h} stroke=\"rgba(37,99,235,0.8)\" dash={[6,4]} />}\n    </Group>\n  );\n}\n```\n\n---\n\n## D12) Overlay de edición rich text (Quill) — `apps/web/src/editor/overlays/RichTextOverlay.tsx`\n\n- Se posiciona sobre el elemento de texto seleccionado (bounding rect del canvas)\n- Mantiene Delta en el store\n- Escucha comandos del ribbon (`quill-command`) para aplicar formatos a rango seleccionado\n- Al cerrar, sincroniza a store y el canvas muestra texto plano (por ahora)\n\n```tsx\nimport React, { useEffect, useMemo, useRef } from \"react\";\nimport Quill from \"quill\";\nimport \"quill/dist/quill.snow.css\";\nimport { useDeckStore } from \"../../store/deckStore\";\nimport type { Delta } from \"../../store/types\";\n\nexport function RichTextOverlay(props: {\n  elementId: string;\n  rect: { left: number; top: number; width: number; height: number };\n  onClose: () => void;\n}) {\n  const el = useDeckStore((s) => s.getSelectedElement());\n  const updateDelta = useDeckStore((s) => s.updateTextDelta);\n\n  const rootRef = useRef<HTMLDivElement>(null);\n  const quillRef = useRef<Quill | null>(null);\n\n  useEffect(() => {\n    if (!rootRef.current) return;\n    if (!el || el.type !== \"text\") return;\n\n    const q = new Quill(rootRef.current, {\n      theme: \"snow\",\n      modules: {\n        toolbar: false\n      }\n    });\n\n    quillRef.current = q;\n\n    // Inicializar con Delta\n    q.setContents(el.delta as any);\n\n    // Sync on changes (throttle simple)\n    const onTextChange = () => {\n      const delta = q.getContents() as any;\n      updateDelta(props.elementId, delta);\n    };\n\n    q.on(\"text-change\", onTextChange);\n\n    // Comandos desde ribbon\n    const onCmd = (ev: any) => {\n      const cmd = ev.detail;\n      if (!cmd || !quillRef.current) return;\n      const quill = quillRef.current;\n\n      if (cmd.type === \"format\") {\n        const { key, value } = cmd.payload ?? {};\n        const range = quill.getSelection(true);\n        if (!range) return;\n        quill.format(key, value);\n        return;\n      }\n\n      if (cmd.type === \"list\") {\n        const range = quill.getSelection(true);\n        if (!range) return;\n        quill.format(\"list\", cmd.payload); // 'bullet' | 'ordered'\n        return;\n      }\n\n      if (cmd.type === \"align\") {\n        const range = quill.getSelection(true);\n        if (!range) return;\n        quill.format(\"align\", cmd.payload);\n        return;\n      }\n    };\n\n    window.addEventListener(\"quill-command\", onCmd as any);\n\n    // ESC para cerrar\n    const onKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") props.onClose();\n    };\n    window.addEventListener(\"keydown\", onKey);\n\n    // Focus\n    setTimeout(() => q.focus(), 0);\n\n    return () => {\n      window.removeEventListener(\"quill-command\", onCmd as any);\n      window.removeEventListener(\"keydown\", onKey);\n      q.off(\"text-change\", onTextChange);\n      q.disable();\n      quillRef.current = null;\n    };\n  }, [props.elementId]);\n\n  return (\n    <div\n      className=\"konvaOverlayEditor\"\n      style={{\n        left: props.rect.left,\n        top: props.rect.top,\n        width: props.rect.width,\n        height: props.rect.height\n      }}\n    >\n      <div style={{ display: \"flex\", justifyContent: \"space-between\", padding: 8, borderBottom: \"1px solid rgba(0,0,0,0.08)\" }}>\n        <div style={{ fontWeight: 800, fontSize: 12 }}>Editar texto</div>\n        <button className=\"pill\" onClick={props.onClose}>Listo</button>\n      </div>\n      <div ref={rootRef} style={{ height: `calc(100% - 44px)` }} />\n    </div>\n  );\n}\n```\n\n---\n\n## D13) Modal de hyperlink — `apps/web/src/editor/overlays/HyperlinkModal.tsx`\n\n```tsx\nimport React, { useState } from \"react\";\n\nfunction emitQuillCommand(cmd: { type: string; payload?: any }) {\n  window.dispatchEvent(new CustomEvent(\"quill-command\", { detail: cmd }));\n}\n\nexport function HyperlinkModal({ onClose }: { onClose: () => void }) {\n  const [url, setUrl] = useState(\"https://\");\n\n  const apply = () => {\n    emitQuillCommand({ type: \"format\", payload: { key: \"link\", value: url } });\n    onClose();\n  };\n\n  return (\n    <div className=\"modalBackdrop\" onMouseDown={onClose}>\n      <div className=\"modal\" onMouseDown={(e) => e.stopPropagation()}>\n        <div className=\"modalHeader\">Insertar enlace</div>\n        <div className=\"modalBody\">\n          <div style={{ fontSize: 12, color: \"var(--muted)\" }}>\n            Aplica al texto seleccionado en el editor de texto.\n          </div>\n          <input className=\"input\" value={url} onChange={(e) => setUrl(e.target.value)} />\n        </div>\n        <div className=\"modalFooter\">\n          <button className=\"pill\" onClick={onClose}>Cancelar</button>\n          <button className=\"pill primary\" onClick={apply}>Aplicar</button>\n        </div>\n      </div>\n    </div>\n  );\n}\n```\n\n---\n\n# PARTE E — CHAT + STREAMING TYPING\n\n## E1) Commands parser — `apps/web/src/chat/commands.ts`\n\nSoporta:\n- `/img ...` → image_generate\n- `/chart ...` → chart_parse\n- texto normal → chat_start\n\n```ts\nexport type ParsedCommand =\n  | { kind: \"image\"; prompt: string }\n  | { kind: \"chart\"; prompt: string }\n  | { kind: \"chat\"; prompt: string };\n\nexport function parseCommand(input: string): ParsedCommand {\n  const t = input.trim();\n  if (t.startsWith(\"/img \")) return { kind: \"image\", prompt: t.slice(5).trim() };\n  if (t.startsWith(\"/chart \")) return { kind: \"chart\", prompt: t.slice(7).trim() };\n  return { kind: \"chat\", prompt: t };\n}\n```\n\n---\n\n## E2) Chat panel — `apps/web/src/chat/ChatPanel.tsx`\n\n- conecta WS\n- renderiza mensajes\n- envía comandos\n- cuando llegan tokens: los agrega a la cola (typingStream) para insertarlos en el slide\n\n```tsx\nimport React, { useEffect, useMemo, useRef, useState } from \"react\";\nimport { nanoid } from \"nanoid\";\nimport { EditorWS } from \"../api/wsClient\";\nimport { parseCommand } from \"./commands\";\nimport { useDeckStore } from \"../store/deckStore\";\nimport { enqueueLLMToken, resetTypingTarget } from \"../ai/typingStream\";\nimport type { ChartElement, ImageElement, TextElement } from \"../store/types\";\n\ntype ChatMsg = { id: string; role: \"user\" | \"assistant\" | \"system\"; text: string };\n\nexport function ChatPanel() {\n  const deck = useDeckStore((s) => s.history.present);\n  const slide = useDeckStore((s) => s.getActiveSlide());\n  const selection = useDeckStore((s) => s.selection);\n  const addElement = useDeckStore((s) => s.addElement);\n  const setStreaming = useDeckStore((s) => s.setStreaming);\n\n  const [msgs, setMsgs] = useState<ChatMsg[]>([\n    {\n      id: nanoid(),\n      role: \"system\",\n      text: \"Tip: usa /img para generar imágenes o /chart para crear gráficos.\"\n    }\n  ]);\n\n  const [input, setInput] = useState(\"\");\n\n  const wsRef = useRef<EditorWS | null>(null);\n  const assistantMsgIdRef = useRef<string | null>(null);\n  const requestIdRef = useRef<string | null>(null);\n\n  useEffect(() => {\n    const ws = new EditorWS({\n      onMessage: (msg) => {\n        if (msg.type === \"llm_token\") {\n          // actualizar chat UI\n          if (!assistantMsgIdRef.current) return;\n          setMsgs((prev) =>\n            prev.map((m) => (m.id === assistantMsgIdRef.current ? { ...m, text: m.text + msg.token } : m))\n          );\n\n          // streaming to slide\n          enqueueLLMToken(msg.token);\n          return;\n        }\n\n        if (msg.type === \"llm_done\") {\n          setStreaming(false);\n          requestIdRef.current = null;\n          assistantMsgIdRef.current = null;\n          return;\n        }\n\n        if (msg.type === \"llm_error\") {\n          setStreaming(false);\n          setMsgs((prev) => [...prev, { id: nanoid(), role: \"system\", text: `Error: ${msg.message}` }]);\n          requestIdRef.current = null;\n          assistantMsgIdRef.current = null;\n          return;\n        }\n\n        if (msg.type === \"image_result\") {\n          setStreaming(false);\n\n          const el: ImageElement = {\n            id: nanoid(),\n            type: \"image\",\n            x: 680,\n            y: 150,\n            w: 520,\n            h: 320,\n            zIndex: 50,\n            src: msg.imageUrl\n          };\n          addElement(el);\n\n          setMsgs((prev) => [...prev, { id: nanoid(), role: \"assistant\", text: \"Imagen insertada en el slide.\" }]);\n          return;\n        }\n\n        if (msg.type === \"chart_result\") {\n          setStreaming(false);\n\n          const el: ChartElement = {\n            id: nanoid(),\n            type: \"chart\",\n            x: 680,\n            y: 500,\n            w: 520,\n            h: 200,\n            zIndex: 60,\n            spec: msg.spec\n          };\n          addElement(el);\n\n          setMsgs((prev) => [...prev, { id: nanoid(), role: \"assistant\", text: \"Gráfico insertado en el slide.\" }]);\n          return;\n        }\n      }\n    });\n\n    ws.connect();\n    wsRef.current = ws;\n\n    // Recibe comandos desde tab IA\n    const onAiCmd = (ev: any) => {\n      const text = String(ev.detail ?? \"\");\n      if (!text) return;\n      setInput(text);\n      setTimeout(() => send(text), 0);\n    };\n    window.addEventListener(\"ai-command\", onAiCmd as any);\n\n    return () => {\n      window.removeEventListener(\"ai-command\", onAiCmd as any);\n      ws.close();\n      wsRef.current = null;\n    };\n  }, []);\n\n  const send = (text?: string) => {\n    const t = (text ?? input).trim();\n    if (!t) return;\n\n    const cmd = parseCommand(t);\n\n    setMsgs((prev) => [...prev, { id: nanoid(), role: \"user\", text: t }]);\n    setInput(\"\");\n\n    const requestId = nanoid();\n    requestIdRef.current = requestId;\n\n    // Reset target: elemento activo del canvas (si no hay, crea uno)\n    ensureTextTarget();\n\n    setStreaming(true, requestId);\n\n    if (cmd.kind === \"image\") {\n      wsRef.current?.send({\n        type: \"image_generate\",\n        requestId,\n        prompt: cmd.prompt,\n        size: \"1024\"\n      });\n      return;\n    }\n\n    if (cmd.kind === \"chart\") {\n      wsRef.current?.send({\n        type: \"chart_parse\",\n        requestId,\n        prompt: cmd.prompt\n      });\n      return;\n    }\n\n    // Chat normal (stream tokens)\n    const assistantMsgId = nanoid();\n    assistantMsgIdRef.current = assistantMsgId;\n    setMsgs((prev) => [...prev, { id: assistantMsgId, role: \"assistant\", text: \"\" }]);\n\n    wsRef.current?.send({\n      type: \"chat_start\",\n      requestId,\n      prompt: cmd.prompt,\n      context: {\n        deckTitle: deck.title,\n        activeSlide: slide,\n        selection\n      },\n      mode: \"slide_write\"\n    });\n  };\n\n  const ensureTextTarget = () => {\n    // Si hay selección y es texto, apuntamos a ese.\n    // Si no, creamos un textbox y lo seleccionamos.\n    const store = useDeckStore.getState();\n    const selected = store.getSelectedElement();\n\n    if (selected && selected.type === \"text\") {\n      resetTypingTarget({ slideId: slide.id, elementId: selected.id });\n      return;\n    }\n\n    const el: TextElement = {\n      id: nanoid(),\n      type: \"text\",\n      x: 80,\n      y: 260,\n      w: 560,\n      h: 340,\n      zIndex: 40,\n      delta: { ops: [{ insert: \"\" }] },\n      defaultTextStyle: {\n        fontFamily: \"Inter\",\n        fontSize: 22,\n        color: \"#111111\"\n      }\n    };\n\n    store.addElement(el);\n    resetTypingTarget({ slideId: slide.id, elementId: el.id });\n  };\n\n  return (\n    <>\n      <div className=\"chatMessages\">\n        {msgs.map((m) => (\n          <div key={m.id} className=\"chatMsg\">\n            <div className=\"chatMsgRole\">{m.role}</div>\n            <div style={{ whiteSpace: \"pre-wrap\", fontSize: 13 }}>{m.text}</div>\n          </div>\n        ))}\n      </div>\n\n      <div className=\"chatComposer\">\n        <input\n          className=\"chatInput\"\n          placeholder='Escribe... (ej: \"Resume el proyecto\" o \"/img portada minimalista\")'\n          value={input}\n          onChange={(e) => setInput(e.target.value)}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\") send();\n          }}\n        />\n        <button className=\"pill primary\" onClick={() => send()}>Enviar</button>\n      </div>\n    </>\n  );\n}\n```\n\n---\n\n## E3) Streaming typing (cola + rAF) — `apps/web/src/ai/typingStream.ts`\n\nEsto implementa la parte crítica: **tokens del LLM aparecen en el slide como si alguien tipeara**.\n\n- `enqueueLLMToken(token)` agrega al buffer\n- `useTypingStream()` consume con `requestAnimationFrame`\n- Inserta texto en el `TextElement.delta` activo\n\n```ts\nimport { useEffect, useRef } from \"react\";\nimport { useDeckStore } from \"../store/deckStore\";\nimport type { Selection, Delta } from \"../store/types\";\n\nlet tokenQueue: string[] = [];\nlet target: Selection = null;\n\nexport function resetTypingTarget(sel: Selection) {\n  target = sel;\n  tokenQueue = [];\n}\n\nexport function enqueueLLMToken(token: string) {\n  if (!token) return;\n  tokenQueue.push(token);\n}\n\nfunction appendTextToDelta(delta: Delta, text: string): Delta {\n  const ops = [...(delta.ops ?? [])];\n\n  // Simplificado: concatenar al último insert string si existe\n  const last = ops[ops.length - 1];\n  if (last && typeof last.insert === \"string\" && !last.attributes) {\n    ops[ops.length - 1] = { insert: last.insert + text };\n  } else {\n    ops.push({ insert: text });\n  }\n\n  return { ops };\n}\n\nexport function useTypingStream() {\n  const rafRef = useRef<number | null>(null);\n\n  useEffect(() => {\n    const tick = () => {\n      const store = useDeckStore.getState();\n      const streaming = store.streaming.active;\n\n      if (!streaming) {\n        rafRef.current = requestAnimationFrame(tick);\n        return;\n      }\n\n      if (!target) {\n        // si no hay target, no insertamos\n        rafRef.current = requestAnimationFrame(tick);\n        return;\n      }\n\n      const selected = store.getSelectedElement();\n      if (!selected || selected.type !== \"text\") {\n        rafRef.current = requestAnimationFrame(tick);\n        return;\n      }\n\n      // consumimos de la cola N chars por frame (suave)\n      const chunk = tokenQueue.shift();\n      if (chunk) {\n        // “teclado humano”: parte el chunk en pedazos pequeños\n        const slice = chunk.slice(0, 4);\n        const rest = chunk.slice(4);\n        if (rest) tokenQueue.unshift(rest);\n\n        const nextDelta = appendTextToDelta(selected.delta, slice);\n        store.updateTextDelta(selected.id, nextDelta);\n      }\n\n      rafRef.current = requestAnimationFrame(tick);\n    };\n\n    rafRef.current = requestAnimationFrame(tick);\n    return () => {\n      if (rafRef.current) cancelAnimationFrame(rafRef.current);\n      rafRef.current = null;\n    };\n  }, []);\n}\n```\n\n> En PROD: para exactitud “caret position”, inserta en el cursor actual del Quill overlay si está abierto.\n\n---\n\n# PARTE F — COLABORACIÓN (OPCIONAL) CRDT (Yjs)\n\nEste bloque es un “starter” para multiusuario.  \nDecisión clave: ¿sincronizas **Delta por elemento** o **toda la presentación** como documento?  \nRecomendación práctica: mapear `deck` a un `Y.Map` con `slides` y `elements`, y cada `TextElement.delta` a `Y.Text`.\n\n## F1) `apps/web/src/collab/yjs.ts` (skeleton)\n\n```ts\n// Skeleton de integración Yjs.\n// En PROD: definir esquema Y.Doc y binding con el store (Zustand).\nimport * as Y from \"yjs\";\n// import { WebsocketProvider } from \"y-websocket\";\n\nexport function createYDoc(roomId: string) {\n  const doc = new Y.Doc();\n\n  // const provider = new WebsocketProvider(\"ws://localhost:1234\", roomId, doc);\n  // const awareness = provider.awareness;\n\n  const deckMap = doc.getMap(\"deck\");\n  // deckMap.set(\"title\", \"Nueva Presentación\");\n  // deckMap.set(\"slides\", new Y.Array());\n\n  return { doc, deckMap };\n}\n```\n\n## Servidor y-websocket\nPuedes correr un y-websocket server separado (ej. puerto 1234).\nEsto se suele correr como microservicio.\n\n---\n\n# PARTE G — Export “pixel-perfect” y notas de producción\n\n## G1) Estrategia de fidelidad\nPara pixel-perfect real:\n1) Bloquea ratio y tamaño del slide en canvas (ej. 1280×720 px).\n2) Usa la misma tipografía en preview que en export.\n3) Export:\n   - Text: convertir Delta a **runs** (rich text) si el generador lo soporta.\n   - Shapes: mapear a shapes nativos PPTX (vector).\n   - Charts: exportar a SVG (vector) e insertar.\n   - Imágenes: optimizar (webp->png, etc) en backend.\n\n## G2) Embebido de fuentes\n- PPTX puede embebir fuentes, pero:\n  - depende de licencias (muchas fuentes no permiten embedding)\n  - no está soportado “out of the box” por varias librerías\n- Alternativas:\n  - **(A)** Requerir fuentes instaladas en cliente\n  - **(B)** Convertir texto a SVG outlines (pierde editabilidad)\n  - **(C)** Implementar font embedding OOXML (complejo)\n\n---\n\n# PARTE H — Checklist de features pedidas vs. entregadas aquí\n\n✅ Split-view: chat izquierda + editor derecha  \n✅ Header: título inline (“Nueva Presentación”), Export dropdown, Close, Undo/Redo  \n✅ Ribbon: tabs (Home, Insert, Layout, References, Review, View, AI)  \n✅ Home: Clipboard, Font (Google Fonts dinámico + size), toggles B/I/U/S, hyperlink modal, color picker, Paragraph (bullets/numbers/align), Styles (H1/H2/H3)  \n✅ Insert: imágenes, shapes, chart stub (tabla/video/iconos stubs)  \n✅ AI: acciones + toggle modo IA/manual  \n✅ Streaming: WS tokens -> queue+rAF -> texto “tipeado” en slide  \n✅ Canvas: Konva con elementos interactivos, handles (Transformer), drag, snap, guides, layers, properties  \n✅ Modelo Delta (Quill) + edición rich (overlay Quill)  \n✅ Export PPTX básico (PptxGenJS)\n\n⬜ PDF export (TODO)  \n⬜ PNG por slide export (TODO)  \n⬜ Rich text vectorial completo en preview + export (TODO(VECTOR))  \n⬜ Font embedding real (TODO(FONTS))  \n⬜ Colaboración CRDT completa (starter incluido)\n\n---\n\n# PARTE I — Cómo correr (local)\n\n```bash\n# 1) instalar deps\nnpm install\n\n# 2) correr todo\nnpm run dev\n\n# Web: http://localhost:5173\n# API: http://localhost:3001\n```\n\nVariables de entorno sugeridas (apps/api/.env):\n\n```bash\nPORT=3001\nCORS_ORIGIN=http://localhost:5173\n\n# Provider interno de LLM (si existe)\nLLM_BASE_URL=http://localhost:8080\n\n# Opcional: OpenAI fallback\nOPENAI_API_KEY=...\n\n# Google Fonts API\nGOOGLE_FONTS_API_KEY=...\n```\n\n---\n\n## FIN DEL DOCUMENTO\n","path":null,"size_bytes":115609,"size_tokens":null},"client/src/components/ppt/panels/index.ts":{"content":"export { SlidesPanel } from './SlidesPanel';\nexport { LayersPanel } from './LayersPanel';\nexport { PropertiesPanel } from './PropertiesPanel';\n","path":null,"size_bytes":143,"size_tokens":null},"client/src/components/ppt/canvas/elements/TextNode.tsx":{"content":"import React, { useRef, useEffect, useState } from 'react';\nimport { Text, Rect, Group } from 'react-konva';\nimport type Konva from 'konva';\nimport type { TextElement } from '../../store/types';\n\ninterface TextNodeProps {\n  element: TextElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onTransformEnd: (newAttrs: Partial<TextElement>) => void;\n  onTextChange?: (delta: { ops: { insert: string }[] }) => void;\n}\n\nfunction deltaToPlainText(delta: { ops: { insert: string }[] }): string {\n  return delta.ops.map(op => op.insert).join('');\n}\n\nexport function TextNode({ element, isSelected, onSelect, onTransformEnd }: TextNodeProps) {\n  const textRef = useRef<Konva.Text>(null);\n  const groupRef = useRef<Konva.Group>(null);\n  const [textHeight, setTextHeight] = useState(element.h);\n\n  const text = deltaToPlainText(element.delta);\n  const style = element.defaultTextStyle;\n\n  useEffect(() => {\n    if (textRef.current) {\n      const measuredHeight = textRef.current.height();\n      if (measuredHeight !== textHeight) {\n        setTextHeight(Math.max(element.h, measuredHeight));\n      }\n    }\n  }, [text, style.fontSize, element.w, element.h, textHeight]);\n\n  const handleDragEnd = (e: Konva.KonvaEventObject<DragEvent>) => {\n    onTransformEnd({\n      x: e.target.x(),\n      y: e.target.y()\n    });\n  };\n\n  const handleTransformEnd = () => {\n    const node = groupRef.current;\n    if (!node) return;\n\n    const scaleX = node.scaleX();\n    const scaleY = node.scaleY();\n\n    node.scaleX(1);\n    node.scaleY(1);\n\n    onTransformEnd({\n      x: node.x(),\n      y: node.y(),\n      w: Math.max(50, node.width() * scaleX),\n      h: Math.max(20, node.height() * scaleY),\n      rotation: node.rotation()\n    });\n  };\n\n  return (\n    <Group\n      ref={groupRef}\n      x={element.x}\n      y={element.y}\n      width={element.w}\n      height={element.h}\n      rotation={element.rotation ?? 0}\n      draggable={!element.locked}\n      onClick={onSelect}\n      onTap={onSelect}\n      onDragEnd={handleDragEnd}\n      onTransformEnd={handleTransformEnd}\n      opacity={element.opacity ?? 1}\n    >\n      {isSelected && (\n        <Rect\n          width={element.w}\n          height={element.h}\n          stroke=\"#2563eb\"\n          strokeWidth={1}\n          dash={[4, 4]}\n          fill=\"transparent\"\n        />\n      )}\n      <Text\n        ref={textRef}\n        text={text}\n        width={element.w}\n        height={element.h}\n        fontSize={style.fontSize}\n        fontFamily={style.fontFamily}\n        fontStyle={[\n          style.bold ? 'bold' : '',\n          style.italic ? 'italic' : ''\n        ].filter(Boolean).join(' ') || 'normal'}\n        textDecoration={style.underline ? 'underline' : undefined}\n        fill={style.color}\n        wrap=\"word\"\n        verticalAlign=\"top\"\n      />\n    </Group>\n  );\n}\n","path":null,"size_bytes":2803,"size_tokens":null},"server/services/documentPrompts.ts":{"content":"import {\n  cvSpecJsonSchema,\n  reportSpecJsonSchema,\n  letterSpecJsonSchema,\n} from \"../../shared/documentSpecs\";\n\nexport const CV_SYSTEM_PROMPT = `You are a professional CV/Resume JSON generator that creates structured CV specifications.\n\nCRITICAL VALIDATION RULES (MUST FOLLOW):\n1. The \"header\" object is REQUIRED with name, phone, email, and address fields\n2. work_experience and education arrays should be in reverse chronological order (most recent first)\n3. Skill proficiency levels MUST be integers from 1 to 5 (1=Basic, 2=Intermediate, 3=Proficient, 4=Advanced, 5=Expert)\n4. Language proficiency levels MUST be integers from 1 to 5 (1=Basic, 5=Native)\n5. All dates should use consistent format (e.g., \"Jan 2020\" or \"2020-01\")\n6. Use null for end_date when position/education is current (will display as \"Present\")\n\nCV WRITING BEST PRACTICES (APPLY WHEN GENERATING):\n1. ACTION VERBS - Start achievements with strong action verbs:\n   - Leadership: Led, Directed, Managed, Oversaw, Coordinated, Supervised\n   - Achievement: Achieved, Accomplished, Exceeded, Delivered, Surpassed\n   - Creation: Developed, Designed, Created, Built, Implemented, Launched\n   - Improvement: Improved, Enhanced, Optimized, Streamlined, Increased, Reduced\n   - Communication: Presented, Negotiated, Collaborated, Facilitated\n\n2. QUANTIFIABLE METRICS - Include specific numbers and percentages:\n   - \"Increased sales by 35% within 6 months\"\n   - \"Managed team of 12 developers\"\n   - \"Reduced processing time by 40%\"\n   - \"Handled $2M annual budget\"\n   - \"Served 500+ customers daily\"\n\n3. INDUSTRY KEYWORDS - Include relevant technical terms and skills for the industry\n4. CONCISE DESCRIPTIONS - Keep bullet points to 1-2 lines maximum\n5. IMPACTFUL CONTENT - Focus on results and value delivered, not just duties\n\nSKILL PROFICIENCY GUIDELINES:\n- 1 = Basic: Familiar with concepts, can perform simple tasks with guidance\n- 2 = Intermediate: Can work independently on routine tasks\n- 3 = Proficient: Solid working knowledge, handles most tasks independently\n- 4 = Advanced: Deep expertise, can mentor others, handles complex tasks\n- 5 = Expert: Industry-leading knowledge, recognized authority\n\nTEMPLATE STYLE SELECTION:\n- \"modern\": Clean, contemporary design with blue accents - best for tech, startups, creative\n- \"classic\": Traditional serif fonts, formal layout - best for law, finance, academia\n- \"creative\": Bold sidebar layout, vibrant colors - best for design, marketing, media\n- \"minimalist\": Clean grayscale, minimal styling - best for executives, consultants\n\nHANDLING MESSY INPUT:\n- Extract and structure information from unformatted text\n- Infer missing details where reasonable (e.g., current job if no end date)\n- Improve vague descriptions with more impactful language\n- Organize scattered information into proper sections\n- If user provides incomplete data, fill with realistic placeholders marked clearly\n\nYou MUST respond with ONLY valid JSON that conforms to this schema:\n${JSON.stringify(cvSpecJsonSchema, null, 2)}\n\nExample valid response:\n{\n  \"header\": {\n    \"name\": \"John Smith\",\n    \"phone\": \"+1 (555) 123-4567\",\n    \"email\": \"john.smith@email.com\",\n    \"address\": \"New York, NY\",\n    \"website\": \"https://johnsmith.com\"\n  },\n  \"profile_summary\": \"Results-driven software engineer with 8+ years of experience building scalable web applications. Led teams of up to 15 developers and delivered projects that increased revenue by 40%.\",\n  \"work_experience\": [\n    {\n      \"company\": \"Tech Corp\",\n      \"role\": \"Senior Software Engineer\",\n      \"start_date\": \"Jan 2020\",\n      \"end_date\": null,\n      \"location\": \"New York, NY\",\n      \"description\": \"Lead developer for customer-facing e-commerce platform\",\n      \"achievements\": [\n        \"Architected microservices infrastructure reducing deployment time by 60%\",\n        \"Led team of 8 engineers delivering $5M revenue feature\",\n        \"Implemented CI/CD pipeline improving release frequency by 300%\"\n      ]\n    }\n  ],\n  \"education\": [\n    {\n      \"institution\": \"State University\",\n      \"degree\": \"Bachelor of Science\",\n      \"field\": \"Computer Science\",\n      \"start_date\": \"Sep 2012\",\n      \"end_date\": \"May 2016\",\n      \"gpa\": \"3.8/4.0\",\n      \"achievements\": [\"Dean's List (6 semesters)\", \"Senior Project Award\"]\n    }\n  ],\n  \"skills\": [\n    {\n      \"name\": \"Programming Languages\",\n      \"skills\": [\n        { \"name\": \"JavaScript\", \"proficiency\": 5 },\n        { \"name\": \"TypeScript\", \"proficiency\": 4 },\n        { \"name\": \"Python\", \"proficiency\": 4 }\n      ]\n    }\n  ],\n  \"languages\": [\n    { \"name\": \"English\", \"proficiency\": 5 },\n    { \"name\": \"Spanish\", \"proficiency\": 3 }\n  ],\n  \"template_style\": \"modern\"\n}\n\nRespond with ONLY the JSON, no markdown, no explanations.`;\n\nexport const REPORT_SYSTEM_PROMPT = `You are a professional report JSON generator that creates structured business report specifications.\n\nCRITICAL VALIDATION RULES (MUST FOLLOW):\n1. The \"header\" object is REQUIRED with at least a \"title\" field\n2. Sections array should contain well-organized content blocks\n3. Content block types: text, heading, bullets, numbered, table, image, chart, quote\n4. Each table row array length MUST equal columns array length\n5. Chart data must have matching labels and values arrays\n6. Heading levels are 1-4 (use level 2 for section subheadings)\n\nPROFESSIONAL REPORT STRUCTURE:\n1. EXECUTIVE SUMMARY - Always include when show_toc is true:\n   - Brief overview of key findings (1-2 paragraphs)\n   - Main conclusions and recommendations\n   - Critical metrics or outcomes\n\n2. LOGICAL SECTION FLOW:\n   - Introduction/Background\n   - Methodology (if applicable)\n   - Findings/Analysis (organized by topic)\n   - Data Visualization (charts, tables)\n   - Conclusions\n   - Recommendations (if applicable)\n   - Appendix (if needed)\n\n3. CLEAR HEADINGS AND SUBHEADINGS:\n   - Level 1: Main section titles\n   - Level 2: Subsection titles\n   - Level 3-4: Detailed breakdowns\n\nDATA VISUALIZATION RECOMMENDATIONS:\n- Use \"bar\" charts for comparing categories\n- Use \"line\" charts for trends over time\n- Use \"pie\" charts for showing composition/percentages (max 6-8 segments)\n- Use \"area\" charts for cumulative trends\n- Include captions for tables and charts\n\nWRITING STYLE:\n- Professional, objective tone\n- Third person perspective\n- Clear, jargon-free language (or define technical terms)\n- Evidence-based statements with data support\n- Concise paragraphs (3-5 sentences)\n\nTEMPLATE STYLE SELECTION:\n- \"corporate\": Professional blue palette, formal headers - best for business reports\n- \"academic\": Traditional formatting, citations-friendly - best for research papers\n- \"modern\": Clean contemporary design - best for presentations, proposals\n- \"minimal\": Simple, distraction-free layout - best for internal memos\n\nYou MUST respond with ONLY valid JSON that conforms to this schema:\n${JSON.stringify(reportSpecJsonSchema, null, 2)}\n\nExample valid response:\n{\n  \"header\": {\n    \"title\": \"Q4 2024 Sales Performance Report\",\n    \"subtitle\": \"Regional Analysis and Projections\",\n    \"author\": \"Analytics Team\",\n    \"date\": \"December 2024\",\n    \"organization\": \"Acme Corporation\"\n  },\n  \"executive_summary\": \"Q4 2024 showed a 23% increase in overall sales compared to Q3, with the Northeast region leading growth at 31%. Key drivers included the new product launch and expanded digital marketing efforts. We recommend increasing investment in digital channels for Q1 2025.\",\n  \"sections\": [\n    {\n      \"title\": \"Introduction\",\n      \"content\": [\n        { \"type\": \"text\", \"content\": \"This report analyzes sales performance for Q4 2024 across all regions.\" },\n        { \"type\": \"bullets\", \"items\": [\"Sales data from October-December 2024\", \"Comparison with previous quarters\", \"Regional breakdown analysis\"] }\n      ]\n    },\n    {\n      \"title\": \"Key Findings\",\n      \"content\": [\n        { \"type\": \"heading\", \"level\": 2, \"text\": \"Regional Performance\" },\n        { \"type\": \"table\", \"columns\": [\"Region\", \"Sales ($M)\", \"Growth %\"], \"rows\": [[\"Northeast\", \"12.5\", \"+31%\"], [\"Southwest\", \"8.2\", \"+18%\"]], \"caption\": \"Q4 Sales by Region\" },\n        { \"type\": \"chart\", \"chart_type\": \"bar\", \"title\": \"Regional Sales Comparison\", \"data\": { \"labels\": [\"Northeast\", \"Southwest\", \"Midwest\"], \"values\": [12.5, 8.2, 6.8] } }\n      ]\n    }\n  ],\n  \"show_toc\": true,\n  \"show_page_numbers\": true,\n  \"template_style\": \"corporate\"\n}\n\nRespond with ONLY the JSON, no markdown, no explanations.`;\n\nexport const LETTER_SYSTEM_PROMPT = `You are a professional letter JSON generator that creates structured letter specifications.\n\nCRITICAL VALIDATION RULES (MUST FOLLOW):\n1. \"sender\" object is REQUIRED with name and address fields\n2. \"recipient\" object is REQUIRED with name and address fields\n3. \"date\" field is REQUIRED (format: \"December 21, 2024\" or similar)\n4. \"body_paragraphs\" array is REQUIRED with at least one paragraph\n5. \"signature_name\" field is REQUIRED\n\nLETTER STRUCTURE AND TONE:\n1. SALUTATION - Match formality to relationship:\n   - Formal: \"Dear Mr./Ms./Dr. [Last Name]\" or \"Dear Sir or Madam\"\n   - Business: \"Dear [First Name]\" or \"Dear [Full Name]\"\n   - Personal: \"Dear [First Name]\" or \"Hi [First Name]\"\n   - Unknown recipient: \"To Whom It May Concern\"\n\n2. CLOSING - Match formality to salutation:\n   - Formal: \"Sincerely\", \"Respectfully\", \"Yours faithfully\"\n   - Business: \"Best regards\", \"Kind regards\", \"Warm regards\"\n   - Personal: \"Best\", \"Cheers\", \"Warmly\"\n\n3. BODY PARAGRAPH GUIDELINES:\n   - Opening: State purpose clearly in first paragraph\n   - Middle: Provide details, context, supporting information\n   - Closing: Call to action, next steps, or polite conclusion\n   - Keep paragraphs to 3-5 sentences each\n\nTEMPLATE STYLE SELECTION:\n- \"formal\": Traditional business letter format with full addresses - best for official correspondence, legal, government\n- \"business\": Professional but slightly less rigid - best for business communications, proposals\n- \"personal\": Relaxed formatting - best for personal letters, thank you notes\n- \"modern\": Clean, contemporary design - best for creative industries, startups\n\nWRITING STYLE:\n- Clear, direct language\n- Professional yet personable tone\n- Active voice preferred\n- Avoid jargon unless industry-specific\n- Proofread for grammar and spelling\n\nCOMMON LETTER TYPES:\n- Cover Letter: Highlight relevant experience, express enthusiasm, request interview\n- Recommendation: Specific examples of qualities, relationship context, strong endorsement\n- Business Proposal: Problem statement, solution overview, benefits, call to action\n- Thank You: Express gratitude, mention specific event/help, future relationship\n- Complaint: State issue clearly, provide evidence, request specific resolution\n- Resignation: Clear statement, effective date, gratitude, offer transition help\n\nYou MUST respond with ONLY valid JSON that conforms to this schema:\n${JSON.stringify(letterSpecJsonSchema, null, 2)}\n\nExample valid response:\n{\n  \"sender\": {\n    \"name\": \"Jane Doe\",\n    \"address\": \"123 Main Street, Suite 400\\\\nNew York, NY 10001\",\n    \"phone\": \"+1 (555) 987-6543\",\n    \"email\": \"jane.doe@email.com\"\n  },\n  \"recipient\": {\n    \"name\": \"Mr. John Smith\",\n    \"title\": \"Hiring Manager\",\n    \"organization\": \"Tech Solutions Inc.\",\n    \"address\": \"456 Corporate Blvd\\\\nSan Francisco, CA 94102\"\n  },\n  \"date\": \"December 21, 2024\",\n  \"subject\": \"Application for Senior Software Engineer Position\",\n  \"salutation\": \"Dear Mr. Smith\",\n  \"body_paragraphs\": [\n    \"I am writing to express my strong interest in the Senior Software Engineer position at Tech Solutions Inc. With over eight years of experience in full-stack development and a proven track record of delivering scalable applications, I am confident I would be a valuable addition to your team.\",\n    \"In my current role at Acme Corp, I have led a team of 10 developers in building a microservices architecture that improved system performance by 40%. I have extensive experience with React, Node.js, and cloud technologies including AWS and Kubernetes.\",\n    \"I am particularly drawn to Tech Solutions' commitment to innovation and would welcome the opportunity to contribute to your mission. I have attached my resume for your review and would be delighted to discuss how my background aligns with your needs.\",\n    \"Thank you for considering my application. I look forward to the possibility of speaking with you soon.\"\n  ],\n  \"closing\": \"Sincerely\",\n  \"signature_name\": \"Jane Doe\",\n  \"template_style\": \"formal\"\n}\n\nRespond with ONLY the JSON, no markdown, no explanations.`;\n\nexport function getDocumentSystemPrompt(docType: 'cv' | 'report' | 'letter'): string {\n  switch (docType) {\n    case 'cv':\n      return CV_SYSTEM_PROMPT;\n    case 'report':\n      return REPORT_SYSTEM_PROMPT;\n    case 'letter':\n      return LETTER_SYSTEM_PROMPT;\n    default:\n      throw new Error(`Unknown document type: ${docType}`);\n  }\n}\n\nexport function getDocumentJsonSchema(docType: 'cv' | 'report' | 'letter'): object {\n  switch (docType) {\n    case 'cv':\n      return cvSpecJsonSchema;\n    case 'report':\n      return reportSpecJsonSchema;\n    case 'letter':\n      return letterSpecJsonSchema;\n    default:\n      throw new Error(`Unknown document type: ${docType}`);\n  }\n}\n","path":null,"size_bytes":13189,"size_tokens":null},"client/src/components/ppt/canvas/elements/ImageNode.tsx":{"content":"import React, { useRef, useEffect, useState } from 'react';\nimport { Image, Group, Rect } from 'react-konva';\nimport type Konva from 'konva';\nimport type { ImageElement } from '../../store/types';\n\ninterface ImageNodeProps {\n  element: ImageElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onTransformEnd: (newAttrs: Partial<ImageElement>) => void;\n}\n\nexport function ImageNode({ element, isSelected, onSelect, onTransformEnd }: ImageNodeProps) {\n  const groupRef = useRef<Konva.Group>(null);\n  const [image, setImage] = useState<HTMLImageElement | null>(null);\n\n  useEffect(() => {\n    const img = new window.Image();\n    img.crossOrigin = 'anonymous';\n    img.onload = () => setImage(img);\n    img.src = element.src;\n  }, [element.src]);\n\n  const handleDragEnd = (e: Konva.KonvaEventObject<DragEvent>) => {\n    onTransformEnd({\n      x: e.target.x(),\n      y: e.target.y()\n    });\n  };\n\n  const handleTransformEnd = () => {\n    const node = groupRef.current;\n    if (!node) return;\n\n    const scaleX = node.scaleX();\n    const scaleY = node.scaleY();\n\n    node.scaleX(1);\n    node.scaleY(1);\n\n    onTransformEnd({\n      x: node.x(),\n      y: node.y(),\n      w: Math.max(20, node.width() * scaleX),\n      h: Math.max(20, node.height() * scaleY),\n      rotation: node.rotation()\n    });\n  };\n\n  return (\n    <Group\n      ref={groupRef}\n      x={element.x}\n      y={element.y}\n      width={element.w}\n      height={element.h}\n      rotation={element.rotation ?? 0}\n      draggable={!element.locked}\n      onClick={onSelect}\n      onTap={onSelect}\n      onDragEnd={handleDragEnd}\n      onTransformEnd={handleTransformEnd}\n      opacity={element.opacity ?? 1}\n    >\n      {image ? (\n        <Image\n          image={image}\n          width={element.w}\n          height={element.h}\n        />\n      ) : (\n        <Rect\n          width={element.w}\n          height={element.h}\n          fill=\"#e5e7eb\"\n          stroke=\"#d1d5db\"\n          strokeWidth={1}\n        />\n      )}\n      {isSelected && (\n        <Rect\n          width={element.w}\n          height={element.h}\n          stroke=\"#2563eb\"\n          strokeWidth={2}\n          fill=\"transparent\"\n        />\n      )}\n    </Group>\n  );\n}\n","path":null,"size_bytes":2193,"size_tokens":null},"client/src/components/ppt/canvas/elements/index.ts":{"content":"export { TextNode } from './TextNode';\nexport { ShapeNode } from './ShapeNode';\nexport { ImageNode } from './ImageNode';\nexport { ChartNode } from './ChartNode';\n","path":null,"size_bytes":162,"size_tokens":null},"server/services/cvRenderer.ts":{"content":"import {\n  Document,\n  Packer,\n  Paragraph,\n  TextRun,\n  Table,\n  TableRow,\n  TableCell,\n  WidthType,\n  BorderStyle,\n  convertInchesToTwip,\n  AlignmentType,\n  ExternalHyperlink,\n  ImageRun,\n  VerticalAlign,\n  ShadingType,\n  TabStopPosition,\n  TabStopType,\n} from \"docx\";\nimport { parseAndRenderToDocx, hasRichTextMarkers } from \"./richText\";\nimport {\n  CvSpec,\n  CvHeader,\n  CvWorkExperience,\n  CvEducation,\n  CvSkillCategory,\n  CvLanguage,\n  CvCertification,\n  CvProject,\n} from \"../../shared/documentSpecs\";\nimport { CvTemplateConfig, getCvTemplate } from \"./documentTemplates\";\nimport { formatDateRange, generateSkillDots, generateSkillBar, generateSkillPercentage, generateSkillTags } from \"./documentMappingService\";\n\ninterface InternalRenderConfig {\n  layout: \"single-column\" | \"two-column\" | \"sidebar\";\n  showPhoto: boolean;\n  photoShape: \"circle\" | \"square\" | \"rounded\";\n  skillStyle: \"dots\" | \"bars\" | \"tags\" | \"percentage\" | \"text\";\n  accentColor: string;\n  primaryColor: string;\n  secondaryColor: string;\n  textColor: string;\n  lightTextColor: string;\n  backgroundColor: string;\n  sidebarBgColor: string;\n  headingFont: string;\n  bodyFont: string;\n  accentFont: string;\n  nameSize: number;\n  headingSize: number;\n  sectionHeadingSize: number;\n  bodySize: number;\n  smallSize: number;\n  sectionGap: number;\n  itemGap: number;\n  lineHeight: number;\n  sidebarWidth: number;\n  twoColumnLeftWidth: number;\n  twoColumnRightWidth: number;\n  emptyIndicatorColor: string;\n}\n\nfunction hexToRgb(hex: string): string {\n  return hex.replace(\"#\", \"\");\n}\n\nfunction renderRichText(\n  text: string,\n  config: InternalRenderConfig,\n  options?: { color?: string; extraBold?: boolean }\n): (TextRun | ExternalHyperlink)[] {\n  const fontConfig = { font: config.bodyFont, size: config.bodySize };\n  const color = options?.color || config.textColor;\n\n  if (hasRichTextMarkers(text)) {\n    return parseAndRenderToDocx(text, fontConfig, {\n      extraBold: options?.extraBold,\n      defaultColor: color,\n    });\n  }\n\n  return [\n    new TextRun({\n      text,\n      font: config.bodyFont,\n      size: config.bodySize,\n      color,\n      bold: options?.extraBold,\n    }),\n  ];\n}\n\nfunction templateConfigToInternal(templateConfig: CvTemplateConfig, spec?: CvSpec): InternalRenderConfig {\n  const baseBodySize = 22;\n  \n  let config: InternalRenderConfig = {\n    layout: templateConfig.layout,\n    showPhoto: templateConfig.showPhoto,\n    photoShape: templateConfig.photoShape,\n    skillStyle: templateConfig.skillStyle,\n    accentColor: hexToRgb(templateConfig.colors.accent),\n    primaryColor: hexToRgb(templateConfig.colors.primary),\n    secondaryColor: hexToRgb(templateConfig.colors.secondary),\n    textColor: hexToRgb(templateConfig.colors.text),\n    lightTextColor: hexToRgb(templateConfig.colors.lightText),\n    backgroundColor: hexToRgb(templateConfig.colors.background),\n    sidebarBgColor: hexToRgb(templateConfig.colors.sidebarBg || templateConfig.colors.primary),\n    headingFont: templateConfig.fonts.heading,\n    bodyFont: templateConfig.fonts.body,\n    accentFont: templateConfig.fonts.accent,\n    nameSize: Math.round(baseBodySize * 2.5),\n    headingSize: Math.round(baseBodySize * 1.5),\n    sectionHeadingSize: Math.round(baseBodySize * 1.1),\n    bodySize: baseBodySize,\n    smallSize: baseBodySize - 2,\n    sectionGap: Math.round(templateConfig.spacing.sectionGap * 10),\n    itemGap: Math.round(templateConfig.spacing.itemGap * 5),\n    lineHeight: Math.round(templateConfig.spacing.lineHeight * 240),\n    sidebarWidth: templateConfig.sidebarWidth || 30,\n    twoColumnLeftWidth: templateConfig.twoColumnLeftWidth || 65,\n    twoColumnRightWidth: templateConfig.twoColumnRightWidth || 35,\n    emptyIndicatorColor: hexToRgb(templateConfig.colors.lightText),\n  };\n\n  if (spec?.color_scheme) {\n    if (spec.color_scheme.accent) {\n      config.accentColor = hexToRgb(spec.color_scheme.accent);\n    }\n    if (spec.color_scheme.primary) {\n      config.primaryColor = hexToRgb(spec.color_scheme.primary);\n    }\n    if (spec.color_scheme.text) {\n      config.textColor = hexToRgb(spec.color_scheme.text);\n    }\n    if (spec.color_scheme.background) {\n      config.backgroundColor = hexToRgb(spec.color_scheme.background);\n    }\n  }\n\n  return config;\n}\n\nfunction createSectionHeading(text: string, config: InternalRenderConfig): Paragraph {\n  return new Paragraph({\n    children: [\n      new TextRun({\n        text: text.toUpperCase(),\n        font: config.headingFont,\n        size: config.sectionHeadingSize,\n        bold: true,\n        color: config.accentColor,\n      }),\n    ],\n    spacing: { before: config.sectionGap, after: config.itemGap },\n    border: {\n      bottom: {\n        style: BorderStyle.SINGLE,\n        size: 12,\n        color: config.accentColor,\n      },\n    },\n  });\n}\n\nfunction createSidebarSectionHeading(text: string, config: InternalRenderConfig): Paragraph {\n  return new Paragraph({\n    children: [\n      new TextRun({\n        text: text.toUpperCase(),\n        font: config.headingFont,\n        size: config.sectionHeadingSize - 4,\n        bold: true,\n        color: config.backgroundColor,\n      }),\n    ],\n    spacing: { before: config.sectionGap / 2, after: config.itemGap },\n    border: {\n      bottom: {\n        style: BorderStyle.SINGLE,\n        size: 8,\n        color: config.backgroundColor,\n      },\n    },\n  });\n}\n\nfunction createPhotoPlaceholder(config: InternalRenderConfig, forSidebar: boolean = false): Paragraph {\n  const textColor = forSidebar ? config.backgroundColor : config.accentColor;\n  const borderColor = forSidebar ? config.backgroundColor : config.accentColor;\n  const fontSize = forSidebar ? config.headingSize : config.nameSize;\n  \n  let shapeIndicator: string;\n  switch (config.photoShape) {\n    case \"circle\":\n      shapeIndicator = \"◯\";\n      break;\n    case \"rounded\":\n      shapeIndicator = \"▢\";\n      break;\n    case \"square\":\n    default:\n      shapeIndicator = \"□\";\n      break;\n  }\n  \n  return new Paragraph({\n    children: [\n      new TextRun({\n        text: shapeIndicator,\n        font: config.bodyFont,\n        size: fontSize * 2,\n        color: textColor,\n      }),\n    ],\n    alignment: AlignmentType.CENTER,\n    spacing: { after: config.itemGap },\n  });\n}\n\nfunction createHeaderSection(header: CvHeader, config: InternalRenderConfig): (Paragraph | Table)[] {\n  const showPhoto = config.showPhoto && header.photo_url;\n  \n  const nameParagraph = new Paragraph({\n    children: [\n      new TextRun({\n        text: header.name,\n        font: config.headingFont,\n        size: config.nameSize,\n        bold: true,\n        color: config.accentColor,\n      }),\n    ],\n    alignment: showPhoto ? AlignmentType.LEFT : AlignmentType.CENTER,\n    spacing: { after: config.itemGap },\n  });\n  \n  const contactParts: string[] = [];\n  if (header.phone) contactParts.push(header.phone);\n  if (header.email) contactParts.push(header.email);\n  if (header.address) contactParts.push(header.address);\n  \n  const contactChildren: (TextRun | ExternalHyperlink)[] = [];\n  \n  contactParts.forEach((part, index) => {\n    if (index > 0) {\n      contactChildren.push(\n        new TextRun({\n          text: \"  |  \",\n          font: config.bodyFont,\n          size: config.bodySize,\n          color: config.lightTextColor,\n        })\n      );\n    }\n    contactChildren.push(\n      new TextRun({\n        text: part,\n        font: config.bodyFont,\n        size: config.bodySize,\n        color: config.textColor,\n      })\n    );\n  });\n  \n  if (header.website) {\n    if (contactParts.length > 0) {\n      contactChildren.push(\n        new TextRun({\n          text: \"  |  \",\n          font: config.bodyFont,\n          size: config.bodySize,\n          color: config.lightTextColor,\n        })\n      );\n    }\n    contactChildren.push(\n      new ExternalHyperlink({\n        children: [\n          new TextRun({\n            text: header.website.replace(/^https?:\\/\\//, \"\"),\n            font: config.bodyFont,\n            size: config.bodySize,\n            color: config.accentColor,\n            underline: {},\n          }),\n        ],\n        link: header.website,\n      })\n    );\n  }\n  \n  const contactParagraph = new Paragraph({\n    children: contactChildren,\n    alignment: showPhoto ? AlignmentType.LEFT : AlignmentType.CENTER,\n    spacing: { after: config.sectionGap / 2 },\n  });\n  \n  if (showPhoto) {\n    const noBorder = {\n      style: BorderStyle.NONE,\n      size: 0,\n      color: config.backgroundColor,\n    };\n    \n    const headerTable = new Table({\n      width: { size: 100, type: WidthType.PERCENTAGE },\n      rows: [\n        new TableRow({\n          children: [\n            new TableCell({\n              children: [nameParagraph, contactParagraph],\n              width: { size: 75, type: WidthType.PERCENTAGE },\n              borders: {\n                top: noBorder,\n                bottom: noBorder,\n                left: noBorder,\n                right: noBorder,\n              },\n              verticalAlign: VerticalAlign.CENTER,\n            }),\n            new TableCell({\n              children: [createPhotoPlaceholder(config, false)],\n              width: { size: 25, type: WidthType.PERCENTAGE },\n              borders: {\n                top: noBorder,\n                bottom: noBorder,\n                left: noBorder,\n                right: noBorder,\n              },\n              verticalAlign: VerticalAlign.CENTER,\n            }),\n          ],\n        }),\n      ],\n    });\n    \n    return [headerTable];\n  }\n  \n  return [nameParagraph, contactParagraph];\n}\n\nfunction createProfileSummary(summary: string, config: InternalRenderConfig): Paragraph[] {\n  return [\n    createSectionHeading(\"Profile\", config),\n    new Paragraph({\n      children: renderRichText(summary, config, { color: config.lightTextColor }),\n      spacing: { after: config.sectionGap / 2, line: config.lineHeight },\n    }),\n  ];\n}\n\nfunction createWorkExperienceSection(experiences: CvWorkExperience[], config: InternalRenderConfig): (Paragraph | Table)[] {\n  if (experiences.length === 0) return [];\n  \n  const elements: (Paragraph | Table)[] = [createSectionHeading(\"Work Experience\", config)];\n  \n  for (const exp of experiences) {\n    const headerChildren: TextRun[] = [\n      new TextRun({\n        text: exp.company,\n        font: config.bodyFont,\n        size: config.bodySize,\n        bold: true,\n        color: config.textColor,\n      }),\n    ];\n    \n    if (exp.location) {\n      headerChildren.push(\n        new TextRun({\n          text: `  •  ${exp.location}`,\n          font: config.bodyFont,\n          size: config.smallSize,\n          color: config.lightTextColor,\n        })\n      );\n    }\n    \n    elements.push(\n      new Paragraph({\n        children: headerChildren,\n        tabStops: [\n          {\n            type: TabStopType.RIGHT,\n            position: TabStopPosition.MAX,\n          },\n        ],\n        spacing: { before: config.itemGap * 2, after: config.itemGap / 2 },\n      })\n    );\n    \n    elements.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: exp.role,\n            font: config.bodyFont,\n            size: config.bodySize,\n            italics: true,\n            color: config.textColor,\n          }),\n          new TextRun({\n            text: \"\\t\",\n          }),\n          new TextRun({\n            text: formatDateRange(exp.start_date, exp.end_date),\n            font: config.bodyFont,\n            size: config.smallSize,\n            color: config.lightTextColor,\n          }),\n        ],\n        tabStops: [\n          {\n            type: TabStopType.RIGHT,\n            position: TabStopPosition.MAX,\n          },\n        ],\n        spacing: { after: config.itemGap },\n      })\n    );\n    \n    if (exp.description) {\n      elements.push(\n        new Paragraph({\n          children: renderRichText(exp.description, config, { color: config.lightTextColor }),\n          spacing: { after: config.itemGap, line: config.lineHeight },\n        })\n      );\n    }\n    \n    for (const achievement of exp.achievements || []) {\n      elements.push(\n        new Paragraph({\n          children: renderRichText(achievement, config),\n          bullet: { level: 0 },\n          spacing: { after: config.itemGap / 2 },\n        })\n      );\n    }\n  }\n  \n  return elements;\n}\n\nfunction createEducationSection(education: CvEducation[], config: InternalRenderConfig): Paragraph[] {\n  if (education.length === 0) return [];\n  \n  const elements: Paragraph[] = [createSectionHeading(\"Education\", config)];\n  \n  for (const edu of education) {\n    elements.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: edu.institution,\n            font: config.bodyFont,\n            size: config.bodySize,\n            bold: true,\n            color: config.textColor,\n          }),\n          new TextRun({\n            text: \"\\t\",\n          }),\n          new TextRun({\n            text: formatDateRange(edu.start_date, edu.end_date),\n            font: config.bodyFont,\n            size: config.smallSize,\n            color: config.lightTextColor,\n          }),\n        ],\n        tabStops: [\n          {\n            type: TabStopType.RIGHT,\n            position: TabStopPosition.MAX,\n          },\n        ],\n        spacing: { before: config.itemGap * 2, after: config.itemGap / 2 },\n      })\n    );\n    \n    const degreeText = `${edu.degree} in ${edu.field}`;\n    const degreeChildren: TextRun[] = [\n      new TextRun({\n        text: degreeText,\n        font: config.bodyFont,\n        size: config.bodySize,\n        italics: true,\n        color: config.textColor,\n      }),\n    ];\n    \n    if (edu.gpa) {\n      degreeChildren.push(\n        new TextRun({\n          text: `  •  GPA: ${edu.gpa}`,\n          font: config.bodyFont,\n          size: config.smallSize,\n          color: config.lightTextColor,\n        })\n      );\n    }\n    \n    elements.push(\n      new Paragraph({\n        children: degreeChildren,\n        spacing: { after: config.itemGap },\n      })\n    );\n    \n    for (const achievement of edu.achievements || []) {\n      elements.push(\n        new Paragraph({\n          children: renderRichText(achievement, config),\n          bullet: { level: 0 },\n          spacing: { after: config.itemGap / 2 },\n        })\n      );\n    }\n  }\n  \n  return elements;\n}\n\nfunction createProficiencyVisual(proficiency: number, style: InternalRenderConfig[\"skillStyle\"], config: InternalRenderConfig, forSidebar: boolean = false): TextRun[] {\n  const maxLevel = 5;\n  const textColor = forSidebar ? config.backgroundColor : config.accentColor;\n  const emptyColor = forSidebar ? config.secondaryColor : config.emptyIndicatorColor;\n  const fontSize = forSidebar ? config.smallSize - 2 : config.smallSize;\n  \n  switch (style) {\n    case \"dots\": {\n      const dotsStr = generateSkillDots(proficiency, maxLevel);\n      const filledCount = Math.min(Math.max(0, Math.round(proficiency)), maxLevel);\n      const filled = \"●\".repeat(filledCount);\n      const empty = \"○\".repeat(maxLevel - filledCount);\n      return [\n        new TextRun({\n          text: filled,\n          font: config.bodyFont,\n          size: fontSize,\n          color: textColor,\n        }),\n        new TextRun({\n          text: empty,\n          font: config.bodyFont,\n          size: fontSize,\n          color: emptyColor,\n        }),\n      ];\n    }\n    \n    case \"bars\": {\n      const barInfo = generateSkillBar(proficiency, maxLevel);\n      const filled = \"█\".repeat(barInfo.filled);\n      const empty = \"░\".repeat(barInfo.empty);\n      return [\n        new TextRun({\n          text: filled,\n          font: config.accentFont,\n          size: fontSize,\n          color: textColor,\n        }),\n        new TextRun({\n          text: empty,\n          font: config.accentFont,\n          size: fontSize,\n          color: emptyColor,\n        }),\n      ];\n    }\n    \n    case \"percentage\": {\n      const percentage = generateSkillPercentage(proficiency, maxLevel);\n      return [\n        new TextRun({\n          text: `${percentage}%`,\n          font: config.bodyFont,\n          size: fontSize,\n          color: textColor,\n        }),\n      ];\n    }\n    \n    case \"text\":\n    case \"tags\":\n    default:\n      return [];\n  }\n}\n\nfunction createSkillsSection(skillCategories: CvSkillCategory[], config: InternalRenderConfig): Paragraph[] {\n  if (skillCategories.length === 0) return [];\n  \n  const elements: Paragraph[] = [createSectionHeading(\"Skills\", config)];\n  \n  for (const category of skillCategories) {\n    elements.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: category.name,\n            font: config.bodyFont,\n            size: config.bodySize,\n            bold: true,\n            color: config.textColor,\n          }),\n        ],\n        spacing: { before: config.itemGap, after: config.itemGap / 2 },\n      })\n    );\n    \n    if (config.skillStyle === \"tags\" || config.skillStyle === \"text\") {\n      const skillNames = generateSkillTags(category.skills).join(\", \");\n      elements.push(\n        new Paragraph({\n          children: [\n            new TextRun({\n              text: skillNames,\n              font: config.bodyFont,\n              size: config.bodySize,\n              color: config.lightTextColor,\n            }),\n          ],\n          spacing: { after: config.itemGap },\n        })\n      );\n    } else {\n      for (const skill of category.skills) {\n        const skillChildren: TextRun[] = [\n          new TextRun({\n            text: skill.name + \"  \",\n            font: config.bodyFont,\n            size: config.bodySize,\n            color: config.textColor,\n          }),\n          ...createProficiencyVisual(skill.proficiency, config.skillStyle, config, false),\n        ];\n        \n        elements.push(\n          new Paragraph({\n            children: skillChildren,\n            spacing: { after: config.itemGap / 2 },\n          })\n        );\n      }\n    }\n  }\n  \n  return elements;\n}\n\nfunction createLanguagesSection(languages: CvLanguage[], config: InternalRenderConfig): Paragraph[] {\n  if (languages.length === 0) return [];\n  \n  const elements: Paragraph[] = [createSectionHeading(\"Languages\", config)];\n  \n  if (config.skillStyle === \"text\" || config.skillStyle === \"tags\") {\n    const langNames = languages.map(l => l.name).join(\", \");\n    elements.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: langNames,\n            font: config.bodyFont,\n            size: config.bodySize,\n            color: config.lightTextColor,\n          }),\n        ],\n        spacing: { after: config.itemGap },\n      })\n    );\n  } else {\n    for (const lang of languages) {\n      const langChildren: TextRun[] = [\n        new TextRun({\n          text: lang.name + \"  \",\n          font: config.bodyFont,\n          size: config.bodySize,\n          color: config.textColor,\n        }),\n        ...createProficiencyVisual(lang.proficiency, config.skillStyle, config, false),\n      ];\n      \n      elements.push(\n        new Paragraph({\n          children: langChildren,\n          spacing: { after: config.itemGap },\n        })\n      );\n    }\n  }\n  \n  return elements;\n}\n\nfunction createCertificationsSection(certifications: CvCertification[], config: InternalRenderConfig): Paragraph[] {\n  if (certifications.length === 0) return [];\n  \n  const elements: Paragraph[] = [createSectionHeading(\"Certifications\", config)];\n  \n  for (const cert of certifications) {\n    const certChildren: (TextRun | ExternalHyperlink)[] = [\n      new TextRun({\n        text: cert.name,\n        font: config.bodyFont,\n        size: config.bodySize,\n        bold: true,\n        color: config.textColor,\n      }),\n      new TextRun({\n        text: `  •  ${cert.issuer}  •  ${cert.date}`,\n        font: config.bodyFont,\n        size: config.smallSize,\n        color: config.lightTextColor,\n      }),\n    ];\n    \n    if (cert.url) {\n      certChildren.push(\n        new TextRun({\n          text: \"  \",\n          font: config.bodyFont,\n          size: config.bodySize,\n        })\n      );\n      certChildren.push(\n        new ExternalHyperlink({\n          children: [\n            new TextRun({\n              text: \"Verify →\",\n              font: config.bodyFont,\n              size: config.smallSize,\n              color: config.accentColor,\n              underline: {},\n            }),\n          ],\n          link: cert.url,\n        })\n      );\n    }\n    \n    elements.push(\n      new Paragraph({\n        children: certChildren,\n        spacing: { after: config.itemGap },\n      })\n    );\n  }\n  \n  return elements;\n}\n\nfunction createProjectsSection(projects: CvProject[], config: InternalRenderConfig): Paragraph[] {\n  if (projects.length === 0) return [];\n  \n  const elements: Paragraph[] = [createSectionHeading(\"Projects\", config)];\n  \n  for (const project of projects) {\n    const titleChildren: (TextRun | ExternalHyperlink)[] = [\n      new TextRun({\n        text: project.name,\n        font: config.bodyFont,\n        size: config.bodySize,\n        bold: true,\n        color: config.textColor,\n      }),\n    ];\n    \n    if (project.url) {\n      titleChildren.push(\n        new TextRun({\n          text: \"  \",\n          font: config.bodyFont,\n          size: config.bodySize,\n        })\n      );\n      titleChildren.push(\n        new ExternalHyperlink({\n          children: [\n            new TextRun({\n              text: \"View →\",\n              font: config.bodyFont,\n              size: config.smallSize,\n              color: config.accentColor,\n              underline: {},\n            }),\n          ],\n          link: project.url,\n        })\n      );\n    }\n    \n    elements.push(\n      new Paragraph({\n        children: titleChildren,\n        spacing: { before: config.itemGap, after: config.itemGap / 2 },\n      })\n    );\n    \n    elements.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: project.description,\n            font: config.bodyFont,\n            size: config.bodySize,\n            color: config.lightTextColor,\n          }),\n        ],\n        spacing: { after: config.itemGap / 2, line: config.lineHeight },\n      })\n    );\n    \n    if (project.technologies && project.technologies.length > 0) {\n      const techText = project.technologies.join(\" • \");\n      elements.push(\n        new Paragraph({\n          children: [\n            new TextRun({\n              text: techText,\n              font: config.accentFont,\n              size: config.smallSize,\n              color: config.accentColor,\n              italics: true,\n            }),\n          ],\n          spacing: { after: config.itemGap },\n        })\n      );\n    }\n  }\n  \n  return elements;\n}\n\nfunction createSingleColumnLayout(spec: CvSpec, config: InternalRenderConfig): (Paragraph | Table)[] {\n  const elements: (Paragraph | Table)[] = [];\n  \n  elements.push(...createHeaderSection(spec.header, config));\n  \n  if (spec.profile_summary) {\n    elements.push(...createProfileSummary(spec.profile_summary, config));\n  }\n  \n  elements.push(...createWorkExperienceSection(spec.work_experience || [], config));\n  elements.push(...createEducationSection(spec.education || [], config));\n  elements.push(...createSkillsSection(spec.skills || [], config));\n  elements.push(...createLanguagesSection(spec.languages || [], config));\n  elements.push(...createCertificationsSection(spec.certifications || [], config));\n  elements.push(...createProjectsSection(spec.projects || [], config));\n  \n  return elements;\n}\n\nfunction createTwoColumnLayout(spec: CvSpec, config: InternalRenderConfig): (Paragraph | Table)[] {\n  const elements: (Paragraph | Table)[] = [];\n  \n  elements.push(...createHeaderSection(spec.header, config));\n  \n  if (spec.profile_summary) {\n    elements.push(...createProfileSummary(spec.profile_summary, config));\n  }\n  \n  const leftColumnContent: Paragraph[] = [];\n  \n  const workElements = createWorkExperienceSection(spec.work_experience || [], config);\n  for (const el of workElements) {\n    if (el instanceof Paragraph) {\n      leftColumnContent.push(el);\n    }\n  }\n  \n  leftColumnContent.push(...createEducationSection(spec.education || [], config));\n  leftColumnContent.push(...createProjectsSection(spec.projects || [], config));\n  \n  const rightColumnContent: Paragraph[] = [];\n  rightColumnContent.push(...createSkillsSection(spec.skills || [], config));\n  rightColumnContent.push(...createLanguagesSection(spec.languages || [], config));\n  rightColumnContent.push(...createCertificationsSection(spec.certifications || [], config));\n  \n  const noBorder = {\n    style: BorderStyle.NONE,\n    size: 0,\n    color: config.backgroundColor,\n  };\n  \n  const gutterWidth = 5;\n  const leftWidth = config.twoColumnLeftWidth;\n  const rightWidth = 100 - leftWidth - gutterWidth;\n  \n  const table = new Table({\n    width: { size: 100, type: WidthType.PERCENTAGE },\n    rows: [\n      new TableRow({\n        children: [\n          new TableCell({\n            children: leftColumnContent,\n            width: { size: leftWidth, type: WidthType.PERCENTAGE },\n            borders: {\n              top: noBorder,\n              bottom: noBorder,\n              left: noBorder,\n              right: noBorder,\n            },\n            verticalAlign: VerticalAlign.TOP,\n          }),\n          new TableCell({\n            children: [\n              new Paragraph({ spacing: { after: 0 } }),\n            ],\n            width: { size: gutterWidth, type: WidthType.PERCENTAGE },\n            borders: {\n              top: noBorder,\n              bottom: noBorder,\n              left: noBorder,\n              right: noBorder,\n            },\n          }),\n          new TableCell({\n            children: rightColumnContent,\n            width: { size: rightWidth, type: WidthType.PERCENTAGE },\n            borders: {\n              top: noBorder,\n              bottom: noBorder,\n              left: noBorder,\n              right: noBorder,\n            },\n            verticalAlign: VerticalAlign.TOP,\n          }),\n        ],\n      }),\n    ],\n  });\n  \n  elements.push(table);\n  \n  return elements;\n}\n\nfunction createSidebarSkillsContent(skillCategories: CvSkillCategory[], config: InternalRenderConfig): Paragraph[] {\n  if (skillCategories.length === 0) return [];\n  \n  const elements: Paragraph[] = [createSidebarSectionHeading(\"Skills\", config)];\n  \n  for (const category of skillCategories) {\n    elements.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: category.name,\n            font: config.bodyFont,\n            size: config.smallSize,\n            bold: true,\n            color: config.backgroundColor,\n          }),\n        ],\n        spacing: { before: config.itemGap, after: config.itemGap / 2 },\n      })\n    );\n    \n    if (config.skillStyle === \"tags\" || config.skillStyle === \"text\") {\n      const skillNames = generateSkillTags(category.skills).join(\", \");\n      elements.push(\n        new Paragraph({\n          children: [\n            new TextRun({\n              text: skillNames,\n              font: config.bodyFont,\n              size: config.smallSize,\n              color: config.backgroundColor,\n            }),\n          ],\n          spacing: { after: config.itemGap / 2 },\n        })\n      );\n    } else {\n      for (const skill of category.skills) {\n        const proficiencyVisual = createProficiencyVisual(skill.proficiency, config.skillStyle, config, true);\n        const skillText = proficiencyVisual.length > 0 ? `${skill.name}  ` : skill.name;\n        \n        elements.push(\n          new Paragraph({\n            children: [\n              new TextRun({\n                text: skillText,\n                font: config.bodyFont,\n                size: config.smallSize,\n                color: config.backgroundColor,\n              }),\n              ...proficiencyVisual,\n            ],\n            spacing: { after: config.itemGap / 2 },\n          })\n        );\n      }\n    }\n  }\n  \n  return elements;\n}\n\nfunction createSidebarLanguagesContent(languages: CvLanguage[], config: InternalRenderConfig): Paragraph[] {\n  if (languages.length === 0) return [];\n  \n  const elements: Paragraph[] = [createSidebarSectionHeading(\"Languages\", config)];\n  \n  if (config.skillStyle === \"text\" || config.skillStyle === \"tags\") {\n    const langNames = languages.map(l => l.name).join(\", \");\n    elements.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: langNames,\n            font: config.bodyFont,\n            size: config.smallSize,\n            color: config.backgroundColor,\n          }),\n        ],\n        spacing: { after: config.itemGap / 2 },\n      })\n    );\n  } else {\n    for (const lang of languages) {\n      const proficiencyVisual = createProficiencyVisual(lang.proficiency, config.skillStyle, config, true);\n      const langText = proficiencyVisual.length > 0 ? `${lang.name}  ` : lang.name;\n      \n      elements.push(\n        new Paragraph({\n          children: [\n            new TextRun({\n              text: langText,\n              font: config.bodyFont,\n              size: config.smallSize,\n              color: config.backgroundColor,\n            }),\n            ...proficiencyVisual,\n          ],\n          spacing: { after: config.itemGap / 2 },\n        })\n      );\n    }\n  }\n  \n  return elements;\n}\n\nfunction createSidebarLayout(spec: CvSpec, config: InternalRenderConfig): (Paragraph | Table)[] {\n  const sidebarContent: Paragraph[] = [];\n  \n  if (config.showPhoto && spec.header.photo_url) {\n    sidebarContent.push(createPhotoPlaceholder(config, true));\n  }\n  \n  sidebarContent.push(\n    new Paragraph({\n      children: [\n        new TextRun({\n          text: spec.header.name,\n          font: config.headingFont,\n          size: config.headingSize,\n          bold: true,\n          color: config.backgroundColor,\n        }),\n      ],\n      spacing: { after: config.sectionGap / 2 },\n    })\n  );\n  \n  const contactItems = [\n    { icon: \"📞\", value: spec.header.phone },\n    { icon: \"✉\", value: spec.header.email },\n    { icon: \"📍\", value: spec.header.address },\n  ];\n  \n  for (const item of contactItems) {\n    if (item.value) {\n      sidebarContent.push(\n        new Paragraph({\n          children: [\n            new TextRun({\n              text: `${item.icon} ${item.value}`,\n              font: config.bodyFont,\n              size: config.smallSize,\n              color: config.backgroundColor,\n            }),\n          ],\n          spacing: { after: config.itemGap },\n        })\n      );\n    }\n  }\n  \n  if (spec.header.website) {\n    sidebarContent.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: \"🔗 \",\n            font: config.bodyFont,\n            size: config.smallSize,\n            color: config.backgroundColor,\n          }),\n          new ExternalHyperlink({\n            children: [\n              new TextRun({\n                text: spec.header.website.replace(/^https?:\\/\\//, \"\"),\n                font: config.bodyFont,\n                size: config.smallSize,\n                color: config.backgroundColor,\n                underline: {},\n              }),\n            ],\n            link: spec.header.website,\n          }),\n        ],\n        spacing: { after: config.itemGap * 2 },\n      })\n    );\n  }\n  \n  sidebarContent.push(...createSidebarSkillsContent(spec.skills || [], config));\n  sidebarContent.push(...createSidebarLanguagesContent(spec.languages || [], config));\n  \n  const mainContent: Paragraph[] = [];\n  \n  if (spec.profile_summary) {\n    mainContent.push(createSectionHeading(\"Profile\", config));\n    mainContent.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: spec.profile_summary,\n            font: config.bodyFont,\n            size: config.bodySize,\n            color: config.lightTextColor,\n            italics: true,\n          }),\n        ],\n        spacing: { after: config.sectionGap / 2, line: config.lineHeight },\n      })\n    );\n  }\n  \n  const workElements = createWorkExperienceSection(spec.work_experience || [], config);\n  for (const el of workElements) {\n    if (el instanceof Paragraph) {\n      mainContent.push(el);\n    }\n  }\n  \n  mainContent.push(...createEducationSection(spec.education || [], config));\n  mainContent.push(...createProjectsSection(spec.projects || [], config));\n  mainContent.push(...createCertificationsSection(spec.certifications || [], config));\n  \n  const noBorder = {\n    style: BorderStyle.NONE,\n    size: 0,\n    color: config.backgroundColor,\n  };\n  \n  const table = new Table({\n    width: { size: 100, type: WidthType.PERCENTAGE },\n    rows: [\n      new TableRow({\n        children: [\n          new TableCell({\n            children: sidebarContent,\n            width: { size: config.sidebarWidth, type: WidthType.PERCENTAGE },\n            shading: {\n              fill: config.sidebarBgColor,\n              type: ShadingType.CLEAR,\n              color: \"auto\",\n            },\n            borders: {\n              top: noBorder,\n              bottom: noBorder,\n              left: noBorder,\n              right: noBorder,\n            },\n            verticalAlign: VerticalAlign.TOP,\n          }),\n          new TableCell({\n            children: mainContent,\n            width: { size: 100 - config.sidebarWidth, type: WidthType.PERCENTAGE },\n            borders: {\n              top: noBorder,\n              bottom: noBorder,\n              left: noBorder,\n              right: noBorder,\n            },\n            verticalAlign: VerticalAlign.TOP,\n          }),\n        ],\n      }),\n    ],\n  });\n  \n  return [table];\n}\n\nexport async function renderCvFromSpec(\n  spec: CvSpec,\n  templateConfig: CvTemplateConfig\n): Promise<Buffer> {\n  const config = templateConfigToInternal(templateConfig, spec);\n  \n  let bodyElements: (Paragraph | Table)[];\n  \n  switch (config.layout) {\n    case \"two-column\":\n      bodyElements = createTwoColumnLayout(spec, config);\n      break;\n    case \"sidebar\":\n      bodyElements = createSidebarLayout(spec, config);\n      break;\n    case \"single-column\":\n    default:\n      bodyElements = createSingleColumnLayout(spec, config);\n      break;\n  }\n  \n  const doc = new Document({\n    title: `CV - ${spec.header.name}`,\n    creator: spec.header.name,\n    styles: {\n      paragraphStyles: [\n        {\n          id: \"Normal\",\n          name: \"Normal\",\n          basedOn: \"Normal\",\n          next: \"Normal\",\n          run: { font: config.bodyFont, size: config.bodySize },\n          paragraph: { spacing: { line: config.lineHeight } },\n        },\n      ],\n    },\n    sections: [\n      {\n        properties: {\n          page: {\n            margin: {\n              top: convertInchesToTwip(0.6),\n              right: convertInchesToTwip(0.6),\n              bottom: convertInchesToTwip(0.6),\n              left: convertInchesToTwip(0.6),\n            },\n          },\n        },\n        children: bodyElements,\n      },\n    ],\n  });\n  \n  return await Packer.toBuffer(doc);\n}\n","path":null,"size_bytes":34913,"size_tokens":null},"client/src/components/ppt/canvas/elements/ShapeNode.tsx":{"content":"import React, { useRef } from 'react';\nimport { Rect, Ellipse, Group } from 'react-konva';\nimport type Konva from 'konva';\nimport type { ShapeElement } from '../../store/types';\n\ninterface ShapeNodeProps {\n  element: ShapeElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onTransformEnd: (newAttrs: Partial<ShapeElement>) => void;\n}\n\nexport function ShapeNode({ element, isSelected, onSelect, onTransformEnd }: ShapeNodeProps) {\n  const groupRef = useRef<Konva.Group>(null);\n\n  const handleDragEnd = (e: Konva.KonvaEventObject<DragEvent>) => {\n    onTransformEnd({\n      x: e.target.x(),\n      y: e.target.y()\n    });\n  };\n\n  const handleTransformEnd = () => {\n    const node = groupRef.current;\n    if (!node) return;\n\n    const scaleX = node.scaleX();\n    const scaleY = node.scaleY();\n\n    node.scaleX(1);\n    node.scaleY(1);\n\n    onTransformEnd({\n      x: node.x(),\n      y: node.y(),\n      w: Math.max(20, node.width() * scaleX),\n      h: Math.max(20, node.height() * scaleY),\n      rotation: node.rotation()\n    });\n  };\n\n  return (\n    <Group\n      ref={groupRef}\n      x={element.x}\n      y={element.y}\n      width={element.w}\n      height={element.h}\n      rotation={element.rotation ?? 0}\n      draggable={!element.locked}\n      onClick={onSelect}\n      onTap={onSelect}\n      onDragEnd={handleDragEnd}\n      onTransformEnd={handleTransformEnd}\n      opacity={element.opacity ?? 1}\n    >\n      {element.shapeType === 'rect' ? (\n        <Rect\n          width={element.w}\n          height={element.h}\n          fill={element.fill}\n          stroke={element.stroke}\n          strokeWidth={element.strokeWidth}\n          cornerRadius={element.radius ?? 0}\n        />\n      ) : (\n        <Ellipse\n          x={element.w / 2}\n          y={element.h / 2}\n          radiusX={element.w / 2}\n          radiusY={element.h / 2}\n          fill={element.fill}\n          stroke={element.stroke}\n          strokeWidth={element.strokeWidth}\n        />\n      )}\n      {isSelected && (\n        <Rect\n          width={element.w}\n          height={element.h}\n          stroke=\"#2563eb\"\n          strokeWidth={2}\n          fill=\"transparent\"\n        />\n      )}\n    </Group>\n  );\n}\n","path":null,"size_bytes":2178,"size_tokens":null},"client/src/components/ppt/canvas/CanvasStage.tsx":{"content":"import React, { useRef, useEffect, useCallback } from 'react';\nimport { Stage, Layer, Rect, Transformer } from 'react-konva';\nimport type Konva from 'konva';\nimport { useDeckStore, selectActiveSlide } from '../store/deckStore';\nimport { TextNode, ShapeNode, ImageNode, ChartNode } from './elements';\nimport type { ElementAny, TextElement, ShapeElement, ImageElement, ChartElement } from '../store/types';\nimport { Button } from '@/components/ui/button';\nimport { ZoomIn, ZoomOut, Maximize } from 'lucide-react';\n\nconst CANVAS_WIDTH = 1280;\nconst CANVAS_HEIGHT = 720;\n\nexport function CanvasStage() {\n  const stageRef = useRef<Konva.Stage>(null);\n  const transformerRef = useRef<Konva.Transformer>(null);\n\n  const slide = useDeckStore(selectActiveSlide);\n  const selection = useDeckStore((s) => s.selection);\n  const activeSlideId = useDeckStore((s) => s.activeSlideId);\n  const zoom = useDeckStore((s) => s.zoom);\n  const select = useDeckStore((s) => s.select);\n  const clearSelection = useDeckStore((s) => s.clearSelection);\n  const updateElement = useDeckStore((s) => s.updateElement);\n  const setZoom = useDeckStore((s) => s.setZoom);\n  const deleteElement = useDeckStore((s) => s.deleteElement);\n\n  useEffect(() => {\n    const transformer = transformerRef.current;\n    const stage = stageRef.current;\n    if (!transformer || !stage) return;\n\n    if (selection && selection.slideId === activeSlideId) {\n      const selectedNode = stage.findOne(`#${selection.elementId}`);\n      if (selectedNode) {\n        transformer.nodes([selectedNode]);\n        transformer.getLayer()?.batchDraw();\n        return;\n      }\n    }\n    transformer.nodes([]);\n    transformer.getLayer()?.batchDraw();\n  }, [selection, activeSlideId, slide.elements]);\n\n  const handleStageClick = (e: Konva.KonvaEventObject<MouseEvent>) => {\n    if (e.target === e.target.getStage() || e.target.getClassName() === 'Rect' && e.target.getParent() === e.target.getStage()) {\n      clearSelection();\n    }\n  };\n\n  const handleKeyDown = useCallback((e: KeyboardEvent) => {\n    if (e.key === 'Delete' || e.key === 'Backspace') {\n      const currentSelection = useDeckStore.getState().selection;\n      if (currentSelection) {\n        deleteElement(currentSelection.elementId);\n      }\n    }\n    if (e.key === 'Escape') {\n      clearSelection();\n    }\n  }, [deleteElement, clearSelection]);\n\n  useEffect(() => {\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [handleKeyDown]);\n\n  const handleElementSelect = (elementId: string) => {\n    select({ slideId: activeSlideId, elementId });\n  };\n\n  const handleElementTransform = (elementId: string, patch: Partial<ElementAny>) => {\n    updateElement(elementId, patch);\n  };\n\n  const sortedElements = [...slide.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\n\n  const containerWidth = Math.min(window.innerWidth - 520, CANVAS_WIDTH);\n  const containerHeight = Math.min(window.innerHeight - 250, CANVAS_HEIGHT);\n  const scaleToFit = Math.min(containerWidth / CANVAS_WIDTH, containerHeight / CANVAS_HEIGHT, 1);\n  const displayZoom = zoom * scaleToFit;\n\n  return (\n    <div className=\"relative h-full flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-800\">\n      <div className=\"absolute top-3 right-3 z-10 flex gap-2\">\n        <Button\n          variant=\"outline\"\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => setZoom(zoom - 0.1)}\n          data-testid=\"btn-zoom-out\"\n        >\n          <ZoomOut className=\"h-4 w-4\" />\n        </Button>\n        <span className=\"flex items-center text-sm text-muted-foreground min-w-[60px] justify-center\">\n          {Math.round(zoom * 100)}%\n        </span>\n        <Button\n          variant=\"outline\"\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => setZoom(zoom + 0.1)}\n          data-testid=\"btn-zoom-in\"\n        >\n          <ZoomIn className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant=\"outline\"\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => setZoom(1)}\n          data-testid=\"btn-zoom-reset\"\n        >\n          <Maximize className=\"h-4 w-4\" />\n        </Button>\n      </div>\n\n      <div\n        className=\"shadow-xl rounded-lg overflow-hidden\"\n        style={{\n          width: CANVAS_WIDTH * displayZoom,\n          height: CANVAS_HEIGHT * displayZoom,\n          backgroundColor: slide.background.color\n        }}\n      >\n        <Stage\n          ref={stageRef}\n          width={CANVAS_WIDTH * displayZoom}\n          height={CANVAS_HEIGHT * displayZoom}\n          scaleX={displayZoom}\n          scaleY={displayZoom}\n          onClick={handleStageClick}\n          onTap={handleStageClick}\n          style={{ cursor: 'default' }}\n        >\n          <Layer>\n            <Rect\n              width={CANVAS_WIDTH}\n              height={CANVAS_HEIGHT}\n              fill={slide.background.color}\n            />\n            \n            {sortedElements.map((element) => {\n              const isSelected = selection?.elementId === element.id;\n              const commonProps = {\n                isSelected,\n                onSelect: () => handleElementSelect(element.id),\n                onTransformEnd: (patch: Partial<ElementAny>) => handleElementTransform(element.id, patch)\n              };\n\n              switch (element.type) {\n                case 'text':\n                  return (\n                    <TextNode\n                      key={element.id}\n                      {...commonProps}\n                      element={element as TextElement}\n                    />\n                  );\n                case 'shape':\n                  return (\n                    <ShapeNode\n                      key={element.id}\n                      {...commonProps}\n                      element={element as ShapeElement}\n                    />\n                  );\n                case 'image':\n                  return (\n                    <ImageNode\n                      key={element.id}\n                      {...commonProps}\n                      element={element as ImageElement}\n                    />\n                  );\n                case 'chart':\n                  return (\n                    <ChartNode\n                      key={element.id}\n                      {...commonProps}\n                      element={element as ChartElement}\n                    />\n                  );\n                default:\n                  return null;\n              }\n            })}\n\n            <Transformer\n              ref={transformerRef}\n              boundBoxFunc={(oldBox, newBox) => {\n                if (newBox.width < 20 || newBox.height < 20) {\n                  return oldBox;\n                }\n                return newBox;\n              }}\n              anchorSize={8}\n              anchorCornerRadius={2}\n              borderStroke=\"#2563eb\"\n              anchorStroke=\"#2563eb\"\n              anchorFill=\"#ffffff\"\n            />\n          </Layer>\n        </Stage>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7071,"size_tokens":null},"client/src/components/ppt/PPTEditorShell.tsx":{"content":"import React, { useCallback, useRef, useState } from 'react';\nimport { useDeckStore, selectDeck, selectCanUndo, selectCanRedo } from './store/deckStore';\nimport { CanvasStage } from './canvas/CanvasStage';\nimport { SlidesPanel } from './panels';\nimport { PPTRibbon } from './ribbon/PPTRibbon';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Slider } from '@/components/ui/slider';\nimport { \n  X, \n  Download, \n  MessageSquare,\n  StickyNote,\n  Monitor,\n  Columns,\n  Square,\n  ZoomIn,\n  ZoomOut,\n  Check,\n  ChevronDown\n} from 'lucide-react';\nimport { exportDeckToPptx, downloadBlob } from '@/lib/pptExport';\nimport { cn } from '@/lib/utils';\n\ninterface PPTEditorShellProps {\n  onClose: () => void;\n  onInsertContent?: (insertFn: (content: string) => void) => void;\n}\n\nexport function PPTEditorShell({ onClose, onInsertContent }: PPTEditorShellProps) {\n  const deck = useDeckStore(selectDeck);\n  const activeSlideId = useDeckStore((s) => s.activeSlideId);\n  const zoom = useDeckStore((s) => s.zoom);\n  const setZoom = useDeckStore((s) => s.setZoom);\n  const setTitle = useDeckStore((s) => s.setTitle);\n\n  const [showNotes, setShowNotes] = useState(true);\n\n  const titleRef = useRef<HTMLInputElement>(null);\n\n  const activeSlideIndex = deck.slides.findIndex(s => s.id === activeSlideId) + 1;\n  const totalSlides = deck.slides.length;\n\n  const handleExport = useCallback(async () => {\n    try {\n      const currentDeck = selectDeck(useDeckStore.getState());\n      const blob = await exportDeckToPptx(currentDeck);\n      downloadBlob(blob, `${currentDeck.title || 'presentacion'}.pptx`);\n    } catch (error) {\n      console.error('Export failed:', error);\n    }\n  }, []);\n\n  const handleTitleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    setTitle(e.target.value);\n  };\n\n  return (\n    <div className=\"h-full flex flex-col bg-white\" data-testid=\"ppt-editor-shell\">\n      <PPTRibbon />\n\n      <div className=\"flex-1 flex min-h-0\">\n        <div className=\"w-[72px] border-r border-gray-200 bg-[#f6f7fb]\">\n          <SlidesPanel />\n        </div>\n\n        <div className=\"flex-1 min-w-0 flex flex-col bg-[#f6f7fb]\">\n          <div className=\"flex-1 relative\">\n            <CanvasStage />\n          </div>\n\n          {showNotes && (\n            <div className=\"h-[40px] border-t border-gray-300 bg-white flex items-center px-4\">\n              <input\n                type=\"text\"\n                placeholder=\"Haz clic para agregar notas\"\n                className=\"flex-1 text-sm text-gray-400 bg-transparent border-none outline-none\"\n              />\n            </div>\n          )}\n        </div>\n      </div>\n\n      <footer className=\"h-[24px] flex items-center justify-between px-2 bg-[#f3f3f3] border-t border-gray-300 text-[11px] text-gray-600\">\n        <div className=\"flex items-center gap-3\">\n          <span>Diapositiva {activeSlideIndex} de {totalSlides}</span>\n          <div className=\"w-px h-3 bg-gray-300\" />\n          <button className=\"hover:bg-gray-200 px-1 rounded flex items-center gap-1\">\n            Español (Estados Unidos)\n            <ChevronDown className=\"h-2.5 w-2.5\" />\n          </button>\n          <div className=\"w-px h-3 bg-gray-300\" />\n          <div className=\"flex items-center gap-1\">\n            <Check className=\"h-3 w-3 text-green-600\" />\n            <span>Accesibilidad: todo correcto</span>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <button \n            className={cn(\n              \"flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-gray-200\",\n              showNotes && \"bg-gray-200\"\n            )}\n            onClick={() => setShowNotes(!showNotes)}\n          >\n            <StickyNote className=\"h-3 w-3\" />\n            <span>Notas</span>\n          </button>\n          <button className=\"flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-gray-200\">\n            <MessageSquare className=\"h-3 w-3\" />\n            <span>Comentarios</span>\n          </button>\n\n          <div className=\"w-px h-3 bg-gray-300 mx-1\" />\n\n          <div className=\"flex items-center gap-0.5 bg-gray-200 rounded p-0.5\">\n            <button className=\"p-0.5 rounded hover:bg-gray-300\">\n              <Monitor className=\"h-3 w-3\" />\n            </button>\n            <button className=\"p-0.5 rounded hover:bg-gray-300\">\n              <Columns className=\"h-3 w-3\" />\n            </button>\n            <button className=\"p-0.5 rounded bg-white shadow-sm\">\n              <Square className=\"h-3 w-3\" />\n            </button>\n          </div>\n\n          <div className=\"w-px h-3 bg-gray-300 mx-1\" />\n\n          <div className=\"flex items-center gap-1\">\n            <button \n              className=\"p-0.5 rounded hover:bg-gray-200\"\n              onClick={() => setZoom(Math.max(0.25, zoom - 0.1))}\n            >\n              <ZoomOut className=\"h-3.5 w-3.5\" />\n            </button>\n            <div className=\"w-[80px]\">\n              <Slider\n                value={[zoom * 100]}\n                min={25}\n                max={200}\n                step={5}\n                onValueChange={([val]) => setZoom(val / 100)}\n                className=\"h-1\"\n              />\n            </div>\n            <button \n              className=\"p-0.5 rounded hover:bg-gray-200\"\n              onClick={() => setZoom(Math.min(2, zoom + 0.1))}\n            >\n              <ZoomIn className=\"h-3.5 w-3.5\" />\n            </button>\n            <span className=\"text-[10px] w-10 text-center\">{Math.round(zoom * 100)}%</span>\n          </div>\n\n          <button \n            className=\"ml-2 p-0.5 rounded hover:bg-gray-200\"\n            onClick={handleExport}\n            title=\"Exportar PPTX\"\n          >\n            <Download className=\"h-3.5 w-3.5\" />\n          </button>\n\n          <button \n            className=\"p-0.5 rounded hover:bg-gray-200\"\n            onClick={onClose}\n            title=\"Cerrar\"\n          >\n            <X className=\"h-3.5 w-3.5\" />\n          </button>\n        </div>\n      </footer>\n    </div>\n  );\n}\n\nexport default PPTEditorShell;\n","path":null,"size_bytes":6077,"size_tokens":null},"client/src/components/ppt/panels/LayersPanel.tsx":{"content":"import React from 'react';\nimport { useDeckStore, selectActiveSlide } from '../store/deckStore';\nimport { Button } from '@/components/ui/button';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { \n  Type, \n  Square, \n  Circle, \n  Image, \n  BarChart3,\n  ChevronUp,\n  ChevronDown,\n  ArrowUpToLine,\n  ArrowDownToLine,\n  Trash2,\n  Lock\n} from 'lucide-react';\nimport { cn } from '@/lib/utils';\nimport type { ElementAny } from '../store/types';\n\nfunction getElementIcon(element: ElementAny) {\n  switch (element.type) {\n    case 'text':\n      return <Type className=\"h-4 w-4\" />;\n    case 'shape':\n      return element.shapeType === 'ellipse' \n        ? <Circle className=\"h-4 w-4\" />\n        : <Square className=\"h-4 w-4\" />;\n    case 'image':\n      return <Image className=\"h-4 w-4\" />;\n    case 'chart':\n      return <BarChart3 className=\"h-4 w-4\" />;\n    default:\n      return <Square className=\"h-4 w-4\" />;\n  }\n}\n\nfunction getElementName(element: ElementAny): string {\n  switch (element.type) {\n    case 'text':\n      const text = element.delta.ops.map(op => op.insert).join('').trim();\n      return text.slice(0, 20) || 'Texto';\n    case 'shape':\n      return element.shapeType === 'ellipse' ? 'Elipse' : 'Rectángulo';\n    case 'image':\n      return 'Imagen';\n    case 'chart':\n      return 'Gráfico';\n    default:\n      return 'Elemento';\n  }\n}\n\nexport function LayersPanel() {\n  const slide = useDeckStore(selectActiveSlide);\n  const selection = useDeckStore((s) => s.selection);\n  const activeSlideId = useDeckStore((s) => s.activeSlideId);\n  const select = useDeckStore((s) => s.select);\n  const bringToFront = useDeckStore((s) => s.bringToFront);\n  const sendToBack = useDeckStore((s) => s.sendToBack);\n  const bringForward = useDeckStore((s) => s.bringForward);\n  const sendBackward = useDeckStore((s) => s.sendBackward);\n  const deleteElement = useDeckStore((s) => s.deleteElement);\n\n  const sortedElements = [...slide.elements].sort((a, b) => (b.zIndex ?? 0) - (a.zIndex ?? 0));\n\n  const handleSelect = (elementId: string) => {\n    select({ slideId: activeSlideId, elementId });\n  };\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      <div className=\"p-3 border-b\">\n        <h3 className=\"font-semibold text-sm\">Capas</h3>\n      </div>\n      \n      <ScrollArea className=\"flex-1\">\n        <div className=\"p-2 space-y-1\">\n          {sortedElements.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">\n              No hay elementos\n            </p>\n          ) : (\n            sortedElements.map((element) => {\n              const isSelected = selection?.elementId === element.id;\n              \n              return (\n                <div\n                  key={element.id}\n                  className={cn(\n                    \"flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-colors\",\n                    \"hover:bg-muted/50\",\n                    isSelected && \"bg-primary/10 border border-primary/30\"\n                  )}\n                  onClick={() => handleSelect(element.id)}\n                  data-testid={`layer-item-${element.id}`}\n                >\n                  <span className=\"text-muted-foreground\">\n                    {getElementIcon(element)}\n                  </span>\n                  <span className=\"flex-1 text-sm truncate\">\n                    {getElementName(element)}\n                  </span>\n                  \n                  {element.locked && (\n                    <Lock className=\"h-3 w-3 text-muted-foreground\" />\n                  )}\n                </div>\n              );\n            })\n          )}\n        </div>\n      </ScrollArea>\n\n      {selection && (\n        <div className=\"p-2 border-t space-y-2\">\n          <div className=\"grid grid-cols-4 gap-1\">\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              className=\"h-8 w-8\"\n              onClick={() => bringToFront(selection.elementId)}\n              title=\"Traer al frente\"\n              data-testid=\"btn-bring-to-front\"\n            >\n              <ArrowUpToLine className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              className=\"h-8 w-8\"\n              onClick={() => bringForward(selection.elementId)}\n              title=\"Adelantar\"\n              data-testid=\"btn-bring-forward\"\n            >\n              <ChevronUp className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              className=\"h-8 w-8\"\n              onClick={() => sendBackward(selection.elementId)}\n              title=\"Atrasar\"\n              data-testid=\"btn-send-backward\"\n            >\n              <ChevronDown className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              className=\"h-8 w-8\"\n              onClick={() => sendToBack(selection.elementId)}\n              title=\"Enviar al fondo\"\n              data-testid=\"btn-send-to-back\"\n            >\n              <ArrowDownToLine className=\"h-4 w-4\" />\n            </Button>\n          </div>\n          \n          <Button\n            variant=\"destructive\"\n            size=\"sm\"\n            className=\"w-full\"\n            onClick={() => deleteElement(selection.elementId)}\n            data-testid=\"btn-delete-element\"\n          >\n            <Trash2 className=\"h-4 w-4 mr-2\" />\n            Eliminar\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":5547,"size_tokens":null},"client/src/components/ppt/ribbon/PPTRibbon.tsx":{"content":"import React from 'react';\nimport { useDeckStore, selectSelectedElement, RibbonTab } from '../store/deckStore';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Input } from '@/components/ui/input';\nimport { \n  Type, \n  Square, \n  Circle, \n  Image,\n  Bold,\n  Italic,\n  Underline,\n  Strikethrough,\n  Sparkles,\n  ClipboardPaste,\n  Scissors,\n  Copy,\n  FilePlus,\n  LayoutGrid,\n  RotateCcw,\n  FolderPlus,\n  ChevronDown,\n  AlignLeft,\n  AlignCenter,\n  AlignRight,\n  AlignJustify,\n  List,\n  ListOrdered,\n  ArrowUpDown,\n  IndentIncrease,\n  IndentDecrease,\n  Shapes,\n  Minus,\n  ArrowRight,\n  Layers,\n  Palette,\n  Lightbulb,\n  Highlighter,\n  Subscript,\n  Superscript,\n  PaintBucket,\n  Grid3X3,\n  ImageIcon\n} from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\nconst FONT_FAMILIES = [\n  { label: 'Aptos Display', value: 'Aptos Display' },\n  { label: 'Inter', value: 'Inter' },\n  { label: 'Arial', value: 'Arial' },\n  { label: 'Calibri', value: 'Calibri' },\n  { label: 'Georgia', value: 'Georgia' },\n  { label: 'Times New Roman', value: 'Times New Roman' },\n];\n\nconst FONT_SIZES = [8, 9, 10, 11, 12, 14, 16, 18, 20, 24, 28, 32, 36, 44, 54, 60, 72, 96];\n\nconst TABS = [\n  'Inicio',\n  'Insertar', \n  'Dibujar',\n  'Diseño',\n  'Transiciones',\n  'Animaciones',\n  'Presentación con diapositivas',\n  'Grabar',\n  'Revisar',\n  'Vista'\n];\n\nfunction RibbonGroup({ label, children, className }: { label: string; children: React.ReactNode; className?: string }) {\n  return (\n    <div className={cn(\"flex flex-col h-full\", className)}>\n      <div className=\"flex-1 flex items-start gap-1 pt-1 px-1.5\">\n        {children}\n      </div>\n      <div className=\"text-[10px] text-gray-500 text-center pb-0.5 border-t border-gray-200 mt-1 pt-0.5\">\n        {label}\n      </div>\n    </div>\n  );\n}\n\nfunction RibbonSeparator() {\n  return <div className=\"w-px h-[70px] bg-gray-200 mx-1\" />;\n}\n\nfunction SmallIconButton({ icon: Icon, title, onClick, active, disabled }: { \n  icon: any; \n  title: string; \n  onClick?: () => void;\n  active?: boolean;\n  disabled?: boolean;\n}) {\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\n        \"h-6 w-6 rounded-sm\",\n        active && \"bg-blue-100\"\n      )}\n      onClick={onClick}\n      disabled={disabled}\n      title={title}\n    >\n      <Icon className=\"h-3.5 w-3.5\" />\n    </Button>\n  );\n}\n\nexport function PPTRibbon() {\n  const activeTab = useDeckStore((s) => s.activeTab);\n  const setActiveTab = useDeckStore((s) => s.setActiveTab);\n  const addTextElement = useDeckStore((s) => s.addTextElement);\n  const addShapeElement = useDeckStore((s) => s.addShapeElement);\n  const addImageElement = useDeckStore((s) => s.addImageElement);\n  const applyTextStyleToDefault = useDeckStore((s) => s.applyTextStyleToDefault);\n  const addSlide = useDeckStore((s) => s.addSlide);\n  \n  const selectedElement = useDeckStore(selectSelectedElement);\n  const textStyle = selectedElement?.type === 'text' ? selectedElement.defaultTextStyle : null;\n\n  const handleImageUpload = () => {\n    const input = document.createElement('input');\n    input.type = 'file';\n    input.accept = 'image/*';\n    input.onchange = (e) => {\n      const file = (e.target as HTMLInputElement).files?.[0];\n      if (file) {\n        const reader = new FileReader();\n        reader.onload = (ev) => {\n          const src = ev.target?.result as string;\n          const img = new window.Image();\n          img.onload = () => {\n            addImageElement(src, img.naturalWidth, img.naturalHeight);\n          };\n          img.src = src;\n        };\n        reader.readAsDataURL(file);\n      }\n    };\n    input.click();\n  };\n\n  return (\n    <div className=\"bg-[#f3f3f3] border-b border-gray-300\">\n      <div className=\"flex items-center bg-white border-b border-gray-200\">\n        {TABS.map((tab) => (\n          <button\n            key={tab}\n            onClick={() => setActiveTab(tab as RibbonTab)}\n            className={cn(\n              \"px-3 py-1.5 text-[12px] hover:bg-gray-100 transition-colors relative\",\n              activeTab === tab && \"font-medium\"\n            )}\n          >\n            {tab}\n            {activeTab === tab && (\n              <div className=\"absolute bottom-0 left-0 right-0 h-[2px] bg-[#D83B01]\" />\n            )}\n          </button>\n        ))}\n        <div className=\"flex-1\" />\n        <button className=\"px-3 py-1.5 text-[12px] text-gray-600 hover:bg-gray-100 flex items-center gap-1\">\n          <span className=\"w-2 h-2 rounded-full bg-red-500\" />\n          Grabar\n        </button>\n        <button className=\"px-3 py-1.5 text-[12px] hover:bg-gray-100 flex items-center gap-1.5 mr-2\">\n          Comentarios\n        </button>\n        <button className=\"px-3 py-1.5 text-[12px] bg-[#D83B01] text-white rounded-sm mr-2 flex items-center gap-1.5\">\n          <span className=\"text-sm\">↗</span>\n          Compartir\n        </button>\n      </div>\n\n      <div className=\"h-[82px] flex items-stretch bg-[#f9f9f9]\">\n        {(activeTab === 'Inicio' || activeTab === 'Home') && (\n          <>\n            <RibbonGroup label=\"Pegar\">\n              <div className=\"flex flex-col items-center\">\n                <Button variant=\"ghost\" className=\"h-12 w-12 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 p-1\">\n                  <ClipboardPaste className=\"h-6 w-6 text-gray-700\" />\n                  <div className=\"flex items-center text-[10px] mt-0.5\">\n                    <span>Pegar</span>\n                    <ChevronDown className=\"h-2.5 w-2.5 ml-0.5\" />\n                  </div>\n                </Button>\n                <div className=\"flex gap-0.5 mt-0.5\">\n                  <SmallIconButton icon={Scissors} title=\"Cortar\" />\n                  <SmallIconButton icon={Copy} title=\"Copiar\" />\n                </div>\n              </div>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Diapositivas\">\n              <div className=\"flex gap-1\">\n                <Button \n                  variant=\"ghost\" \n                  className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\"\n                  onClick={addSlide}\n                  data-testid=\"btn-add-slide-ribbon\"\n                >\n                  <div className=\"flex items-center\">\n                    <FilePlus className=\"h-5 w-5 text-gray-700\" />\n                    <ChevronDown className=\"h-2.5 w-2.5 ml-0.5\" />\n                  </div>\n                  <span className=\"text-[10px] mt-0.5\">Nueva</span>\n                  <span className=\"text-[10px]\">diapositiva</span>\n                </Button>\n                <Button variant=\"ghost\" className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\">\n                  <Sparkles className=\"h-5 w-5 text-purple-600\" />\n                  <span className=\"text-[10px] mt-0.5\">Nueva con</span>\n                  <span className=\"text-[10px]\">Copilot</span>\n                </Button>\n              </div>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Sección\">\n              <div className=\"flex flex-col gap-0.5\">\n                <Button variant=\"ghost\" className=\"h-6 text-[11px] justify-start px-2 rounded-sm hover:bg-blue-50\">\n                  <LayoutGrid className=\"h-3.5 w-3.5 mr-1\" />\n                  Diseño\n                  <ChevronDown className=\"h-2.5 w-2.5 ml-1\" />\n                </Button>\n                <Button variant=\"ghost\" className=\"h-6 text-[11px] justify-start px-2 rounded-sm hover:bg-blue-50\">\n                  <RotateCcw className=\"h-3.5 w-3.5 mr-1\" />\n                  Restablecer\n                </Button>\n                <Button variant=\"ghost\" className=\"h-6 text-[11px] justify-start px-2 rounded-sm hover:bg-blue-50\">\n                  <FolderPlus className=\"h-3.5 w-3.5 mr-1\" />\n                  Sección\n                  <ChevronDown className=\"h-2.5 w-2.5 ml-1\" />\n                </Button>\n              </div>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Fuente\">\n              <div className=\"flex flex-col gap-0.5\">\n                <div className=\"flex items-center gap-0.5\">\n                  <Select\n                    value={textStyle?.fontFamily ?? 'Aptos Display'}\n                    onValueChange={(v) => selectedElement && applyTextStyleToDefault(selectedElement.id, { fontFamily: v })}\n                    disabled={!textStyle}\n                  >\n                    <SelectTrigger className=\"h-6 w-[110px] text-[11px] bg-white border-gray-300\" data-testid=\"ribbon-font-family\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {FONT_FAMILIES.map((font) => (\n                        <SelectItem key={font.value} value={font.value} className=\"text-[11px]\">{font.label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <Select\n                    value={String(textStyle?.fontSize ?? 60)}\n                    onValueChange={(v) => selectedElement && applyTextStyleToDefault(selectedElement.id, { fontSize: Number(v) })}\n                    disabled={!textStyle}\n                  >\n                    <SelectTrigger className=\"h-6 w-12 text-[11px] bg-white border-gray-300\" data-testid=\"ribbon-font-size\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {FONT_SIZES.map((size) => (\n                        <SelectItem key={size} value={String(size)} className=\"text-[11px]\">{size}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 rounded-sm\">\n                    <ChevronDown className=\"h-3 w-3 rotate-180\" />\n                  </Button>\n                  <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 rounded-sm\">\n                    <ChevronDown className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n                <div className=\"flex items-center gap-0.5\">\n                  <SmallIconButton \n                    icon={Bold} \n                    title=\"Negrita\" \n                    active={textStyle?.bold}\n                    onClick={() => selectedElement && applyTextStyleToDefault(selectedElement.id, { bold: !textStyle?.bold })}\n                    disabled={!textStyle}\n                  />\n                  <SmallIconButton \n                    icon={Italic} \n                    title=\"Cursiva\"\n                    active={textStyle?.italic}\n                    onClick={() => selectedElement && applyTextStyleToDefault(selectedElement.id, { italic: !textStyle?.italic })}\n                    disabled={!textStyle}\n                  />\n                  <SmallIconButton \n                    icon={Underline} \n                    title=\"Subrayado\"\n                    active={textStyle?.underline}\n                    onClick={() => selectedElement && applyTextStyleToDefault(selectedElement.id, { underline: !textStyle?.underline })}\n                    disabled={!textStyle}\n                  />\n                  <SmallIconButton icon={Strikethrough} title=\"Tachado\" disabled={!textStyle} />\n                  <SmallIconButton icon={Subscript} title=\"Subíndice\" disabled={!textStyle} />\n                  <SmallIconButton icon={Superscript} title=\"Superíndice\" disabled={!textStyle} />\n                  <div className=\"w-px h-4 bg-gray-300 mx-0.5\" />\n                  <div className=\"relative\">\n                    <Input\n                      type=\"color\"\n                      value={textStyle?.color ?? '#111111'}\n                      onChange={(e) => selectedElement && applyTextStyleToDefault(selectedElement.id, { color: e.target.value })}\n                      className=\"w-6 h-6 p-0.5 cursor-pointer\"\n                      disabled={!textStyle}\n                      data-testid=\"ribbon-text-color\"\n                    />\n                  </div>\n                  <SmallIconButton icon={Highlighter} title=\"Resaltado\" disabled={!textStyle} />\n                </div>\n              </div>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Párrafo\">\n              <div className=\"flex flex-col gap-0.5\">\n                <div className=\"flex items-center gap-0.5\">\n                  <SmallIconButton icon={List} title=\"Viñetas\" />\n                  <SmallIconButton icon={ListOrdered} title=\"Numeración\" />\n                  <div className=\"w-px h-4 bg-gray-300 mx-0.5\" />\n                  <SmallIconButton icon={IndentDecrease} title=\"Disminuir sangría\" />\n                  <SmallIconButton icon={IndentIncrease} title=\"Aumentar sangría\" />\n                  <SmallIconButton icon={ArrowUpDown} title=\"Interlineado\" />\n                </div>\n                <div className=\"flex items-center gap-0.5\">\n                  <SmallIconButton icon={AlignLeft} title=\"Alinear a la izquierda\" />\n                  <SmallIconButton icon={AlignCenter} title=\"Centrar\" />\n                  <SmallIconButton icon={AlignRight} title=\"Alinear a la derecha\" />\n                  <SmallIconButton icon={AlignJustify} title=\"Justificar\" />\n                  <SmallIconButton icon={Grid3X3} title=\"Columnas\" />\n                </div>\n              </div>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Dibujo\">\n              <div className=\"flex gap-1\">\n                <Button variant=\"ghost\" className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\">\n                  <Shapes className=\"h-5 w-5 text-gray-700\" />\n                  <span className=\"text-[10px] mt-0.5\">Convertir</span>\n                  <span className=\"text-[10px]\">a SmartArt</span>\n                </Button>\n              </div>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"\">\n              <Button \n                variant=\"ghost\" \n                className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\"\n                onClick={handleImageUpload}\n                data-testid=\"btn-insert-image-ribbon\"\n              >\n                <ImageIcon className=\"h-5 w-5 text-gray-700\" />\n                <span className=\"text-[10px] mt-0.5\">Imagen</span>\n              </Button>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Edición\">\n              <div className=\"flex gap-1\">\n                <Button variant=\"ghost\" className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\">\n                  <Layers className=\"h-5 w-5 text-gray-700\" />\n                  <span className=\"text-[10px] mt-0.5\">Organizar</span>\n                  <ChevronDown className=\"h-2.5 w-2.5\" />\n                </Button>\n                <Button variant=\"ghost\" className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\">\n                  <Palette className=\"h-5 w-5 text-gray-700\" />\n                  <span className=\"text-[10px] mt-0.5\">Estilos</span>\n                  <span className=\"text-[10px]\">rápidos</span>\n                </Button>\n              </div>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"\">\n              <Button variant=\"ghost\" className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\">\n                <div className=\"w-7 h-7 bg-gradient-to-br from-blue-400 to-purple-500 rounded flex items-center justify-center\">\n                  <Lightbulb className=\"h-4 w-4 text-white\" />\n                </div>\n                <span className=\"text-[10px] mt-0.5\">Complementos</span>\n              </Button>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Sugerencias de diseños\">\n              <Button variant=\"ghost\" className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\">\n                <div className=\"w-7 h-7 bg-gradient-to-br from-orange-400 to-pink-500 rounded flex items-center justify-center\">\n                  <Sparkles className=\"h-4 w-4 text-white\" />\n                </div>\n                <span className=\"text-[10px] mt-0.5\">Sugerencias</span>\n                <span className=\"text-[10px]\">de diseños</span>\n              </Button>\n            </RibbonGroup>\n          </>\n        )}\n\n        {activeTab === 'Insertar' && (\n          <>\n            <RibbonGroup label=\"Diapositivas\">\n              <Button \n                variant=\"ghost\" \n                className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\"\n                onClick={addSlide}\n              >\n                <FilePlus className=\"h-5 w-5 text-gray-700\" />\n                <span className=\"text-[10px] mt-0.5\">Nueva</span>\n                <span className=\"text-[10px]\">diapositiva</span>\n              </Button>\n            </RibbonGroup>\n\n            <RibbonSeparator />\n\n            <RibbonGroup label=\"Elementos\">\n              <div className=\"flex gap-1\">\n                <Button\n                  variant=\"ghost\"\n                  className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\"\n                  onClick={addTextElement}\n                  data-testid=\"btn-insert-text\"\n                >\n                  <Type className=\"h-5 w-5 text-gray-700\" />\n                  <span className=\"text-[10px] mt-0.5\">Cuadro de</span>\n                  <span className=\"text-[10px]\">texto</span>\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\"\n                  onClick={() => addShapeElement('rect')}\n                  data-testid=\"btn-insert-rect\"\n                >\n                  <Square className=\"h-5 w-5 text-gray-700\" />\n                  <span className=\"text-[10px] mt-0.5\">Rectángulo</span>\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\"\n                  onClick={() => addShapeElement('ellipse')}\n                  data-testid=\"btn-insert-ellipse\"\n                >\n                  <Circle className=\"h-5 w-5 text-gray-700\" />\n                  <span className=\"text-[10px] mt-0.5\">Elipse</span>\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  className=\"h-14 flex flex-col items-center justify-center rounded-sm hover:bg-blue-50 px-2\"\n                  onClick={handleImageUpload}\n                  data-testid=\"btn-insert-image\"\n                >\n                  <Image className=\"h-5 w-5 text-gray-700\" />\n                  <span className=\"text-[10px] mt-0.5\">Imagen</span>\n                </Button>\n              </div>\n            </RibbonGroup>\n          </>\n        )}\n\n        {(activeTab !== 'Inicio' && activeTab !== 'Home' && activeTab !== 'Insertar' && activeTab !== 'Insert') && (\n          <div className=\"flex items-center justify-center w-full text-sm text-gray-500\">\n            Opciones de \"{activeTab}\" disponibles próximamente\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19623,"size_tokens":null},"client/src/components/ppt/index.ts":{"content":"export { PPTEditorShell } from './PPTEditorShell';\nexport { useDeckStore } from './store/deckStore';\nexport * from './store/types';\n","path":null,"size_bytes":132,"size_tokens":null},"client/src/components/ppt/store/deckStore.ts":{"content":"import { create } from \"zustand\";\nimport { nanoid } from \"nanoid\";\nimport type { Deck, ElementAny, Slide, TextElement, TextStyle, Selection, Delta, ShapeElement, ImageElement, ChartElement } from \"./types\";\nimport { createHistory, pushHistory, redoHistory, undoHistory, canUndo, canRedo, type HistoryState } from \"./history\";\n\nfunction deepCloneElement<T extends ElementAny>(el: T): T {\n  if (el.type === 'text') {\n    return {\n      ...el,\n      delta: { ops: el.delta.ops.map(op => ({ ...op, attributes: op.attributes ? { ...op.attributes } : undefined })) },\n      defaultTextStyle: { ...el.defaultTextStyle }\n    } as T;\n  }\n  return { ...el } as T;\n}\n\nfunction deepCloneSlide(slide: Slide): Slide {\n  return {\n    ...slide,\n    size: { ...slide.size },\n    background: { ...slide.background },\n    elements: slide.elements.map(el => deepCloneElement(el))\n  };\n}\n\nfunction deepCloneDeck(deck: Deck): Deck {\n  return {\n    ...deck,\n    slides: deck.slides.map(s => deepCloneSlide(s))\n  };\n}\n\nfunction defaultDeck(): Deck {\n  const slide: Slide = {\n    id: nanoid(),\n    size: { w: 1280, h: 720 },\n    background: { color: \"#FFFFFF\" },\n    elements: [\n      {\n        id: nanoid(),\n        type: \"text\",\n        x: 80,\n        y: 80,\n        w: 820,\n        h: 140,\n        zIndex: 1,\n        delta: { ops: [{ insert: \"Título de la diapositiva\\n\" }] },\n        defaultTextStyle: {\n          fontFamily: \"Inter\",\n          fontSize: 44,\n          color: \"#111111\",\n          bold: true\n        }\n      } as TextElement\n    ]\n  };\n\n  return {\n    title: \"Nueva Presentación\",\n    slides: [slide]\n  };\n}\n\nexport type EditorMode = \"manual\" | \"ai\";\nexport type RibbonTab = \"Home\" | \"Insert\" | \"Layout\" | \"AI\" | \"Inicio\" | \"Insertar\" | \"Dibujar\" | \"Diseño\" | \"Transiciones\" | \"Animaciones\" | \"Presentación con diapositivas\" | \"Grabar\" | \"Revisar\" | \"Vista\";\n\ntype DeckState = {\n  history: HistoryState<Deck>;\n  selection: Selection;\n  activeSlideId: string;\n  activeTab: RibbonTab;\n  editorMode: EditorMode;\n  streaming: { active: boolean; requestId?: string };\n  zoom: number;\n\n  setTitle(title: string): void;\n  setActiveTab(tab: RibbonTab): void;\n  setEditorMode(mode: EditorMode): void;\n  setZoom(zoom: number): void;\n\n  undo(): void;\n  redo(): void;\n\n  select(selection: Selection): void;\n  clearSelection(): void;\n  addSlide(): void;\n  deleteSlide(slideId: string): void;\n  duplicateSlide(slideId: string): void;\n  setActiveSlide(slideId: string): void;\n  reorderSlides(fromIndex: number, toIndex: number): void;\n  setSlideBackground(slideId: string, color: string): void;\n\n  addElement(el: ElementAny): void;\n  updateElement(elementId: string, patch: Partial<ElementAny>): void;\n  bringToFront(elementId: string): void;\n  sendToBack(elementId: string): void;\n  bringForward(elementId: string): void;\n  sendBackward(elementId: string): void;\n  deleteElement(elementId: string): void;\n\n  updateTextDelta(elementId: string, delta: Delta): void;\n  appendTextDelta(elementId: string, appendText: string): void;\n  applyTextStyleToDefault(elementId: string, patch: Partial<TextStyle>): void;\n\n  addTextElement(): void;\n  createStreamingTextElement(slideId: string, x: number, y: number, initialText?: string): string;\n  addShapeElement(shapeType: \"rect\" | \"ellipse\"): void;\n  addImageElement(src: string, naturalW?: number, naturalH?: number): void;\n  addChartElement(spec: any): void;\n\n  setStreaming(active: boolean, requestId?: string): void;\n};\n\nexport const selectDeck = (state: DeckState): Deck => state.history.present;\nexport const selectActiveSlide = (state: DeckState): Slide => {\n  const deck = state.history.present;\n  return deck.slides.find((s) => s.id === state.activeSlideId) ?? deck.slides[0];\n};\nexport const selectSelectedElement = (state: DeckState): ElementAny | null => {\n  const sel = state.selection;\n  if (!sel) return null;\n  const deck = state.history.present;\n  const slide = deck.slides.find((s) => s.id === sel.slideId);\n  return slide?.elements.find((e) => e.id === sel.elementId) ?? null;\n};\nexport const selectCanUndo = (state: DeckState): boolean => canUndo(state.history);\nexport const selectCanRedo = (state: DeckState): boolean => canRedo(state.history);\n\nexport const useDeckStore = create<DeckState>((set, get) => {\n  const initial = defaultDeck();\n  const activeSlideId = initial.slides[0].id;\n\n  return {\n    history: createHistory(initial),\n    selection: null,\n    activeSlideId,\n    activeTab: \"Inicio\",\n    editorMode: \"manual\",\n    streaming: { active: false },\n    zoom: 1,\n\n    setTitle(title) {\n      const deck = deepCloneDeck(get().history.present);\n      deck.title = title;\n      set({ history: pushHistory(get().history, deck) });\n    },\n\n    setActiveTab(tab) {\n      set({ activeTab: tab });\n    },\n\n    setEditorMode(mode) {\n      set({ editorMode: mode });\n    },\n\n    setZoom(zoom) {\n      set({ zoom: Math.max(0.25, Math.min(2, zoom)) });\n    },\n\n    undo() {\n      const newHistory = undoHistory(get().history);\n      const deck = newHistory.present;\n      const currentActiveSlideId = get().activeSlideId;\n      const slideExists = deck.slides.some(s => s.id === currentActiveSlideId);\n      set({ \n        history: newHistory,\n        activeSlideId: slideExists ? currentActiveSlideId : deck.slides[0].id,\n        selection: null\n      });\n    },\n\n    redo() {\n      const newHistory = redoHistory(get().history);\n      const deck = newHistory.present;\n      const currentActiveSlideId = get().activeSlideId;\n      const slideExists = deck.slides.some(s => s.id === currentActiveSlideId);\n      set({ \n        history: newHistory,\n        activeSlideId: slideExists ? currentActiveSlideId : deck.slides[0].id,\n        selection: null\n      });\n    },\n\n    select(selection) {\n      set({ selection });\n    },\n\n    clearSelection() {\n      set({ selection: null });\n    },\n\n    addSlide() {\n      const deck = deepCloneDeck(get().history.present);\n      const slide: Slide = {\n        id: nanoid(),\n        size: { w: 1280, h: 720 },\n        background: { color: \"#FFFFFF\" },\n        elements: []\n      };\n      deck.slides.push(slide);\n\n      set({\n        history: pushHistory(get().history, deck),\n        activeSlideId: slide.id,\n        selection: null\n      });\n    },\n\n    deleteSlide(slideId) {\n      const deck = deepCloneDeck(get().history.present);\n      if (deck.slides.length <= 1) return;\n      \n      const idx = deck.slides.findIndex(s => s.id === slideId);\n      deck.slides = deck.slides.filter(s => s.id !== slideId);\n      const newActiveId = get().activeSlideId === slideId \n        ? deck.slides[Math.max(0, idx - 1)].id \n        : get().activeSlideId;\n      \n      set({\n        history: pushHistory(get().history, deck),\n        activeSlideId: newActiveId,\n        selection: null\n      });\n    },\n\n    duplicateSlide(slideId) {\n      const deck = deepCloneDeck(get().history.present);\n      const slideIdx = deck.slides.findIndex(s => s.id === slideId);\n      if (slideIdx === -1) return;\n      \n      const slide = deck.slides[slideIdx];\n      const newSlide: Slide = {\n        ...deepCloneSlide(slide),\n        id: nanoid(),\n        elements: slide.elements.map(el => ({\n          ...deepCloneElement(el),\n          id: nanoid()\n        }))\n      };\n\n      deck.slides.splice(slideIdx + 1, 0, newSlide);\n\n      set({\n        history: pushHistory(get().history, deck),\n        activeSlideId: newSlide.id,\n        selection: null\n      });\n    },\n\n    setActiveSlide(slideId) {\n      set({ activeSlideId: slideId, selection: null });\n    },\n\n    reorderSlides(fromIndex, toIndex) {\n      const deck = deepCloneDeck(get().history.present);\n      const [removed] = deck.slides.splice(fromIndex, 1);\n      deck.slides.splice(toIndex, 0, removed);\n      set({ history: pushHistory(get().history, deck) });\n    },\n\n    setSlideBackground(slideId, color) {\n      const deck = deepCloneDeck(get().history.present);\n      const slide = deck.slides.find(s => s.id === slideId);\n      if (slide) {\n        slide.background = { color };\n      }\n      set({ history: pushHistory(get().history, deck) });\n    },\n\n    addElement(el) {\n      const deck = deepCloneDeck(get().history.present);\n      const slideId = get().activeSlideId;\n      const slide = deck.slides.find(s => s.id === slideId);\n      if (slide) {\n        slide.elements.push(deepCloneElement(el));\n      }\n      set({ \n        history: pushHistory(get().history, deck),\n        selection: { slideId, elementId: el.id }\n      });\n    },\n\n    updateElement(elementId, patch) {\n      const deck = deepCloneDeck(get().history.present);\n      const slideId = get().activeSlideId;\n      const slide = deck.slides.find(s => s.id === slideId);\n      if (slide) {\n        const elIdx = slide.elements.findIndex(e => e.id === elementId);\n        if (elIdx !== -1) {\n          slide.elements[elIdx] = { ...slide.elements[elIdx], ...patch } as ElementAny;\n        }\n      }\n      set({ history: pushHistory(get().history, deck) });\n    },\n\n    bringToFront(elementId) {\n      const deck = get().history.present;\n      const slide = deck.slides.find((s) => s.id === get().activeSlideId);\n      if (!slide) return;\n      const maxZ = Math.max(0, ...slide.elements.map((e) => e.zIndex ?? 0));\n      get().updateElement(elementId, { zIndex: maxZ + 1 });\n    },\n\n    sendToBack(elementId) {\n      const deck = get().history.present;\n      const slide = deck.slides.find((s) => s.id === get().activeSlideId);\n      if (!slide) return;\n      const minZ = Math.min(0, ...slide.elements.map((e) => e.zIndex ?? 0));\n      get().updateElement(elementId, { zIndex: minZ - 1 });\n    },\n\n    bringForward(elementId) {\n      const slide = selectActiveSlide(get());\n      const sorted = [...slide.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\n      const idx = sorted.findIndex(e => e.id === elementId);\n      if (idx < sorted.length - 1) {\n        const nextZ = sorted[idx + 1].zIndex ?? 0;\n        get().updateElement(elementId, { zIndex: nextZ + 1 });\n      }\n    },\n\n    sendBackward(elementId) {\n      const slide = selectActiveSlide(get());\n      const sorted = [...slide.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\n      const idx = sorted.findIndex(e => e.id === elementId);\n      if (idx > 0) {\n        const prevZ = sorted[idx - 1].zIndex ?? 0;\n        get().updateElement(elementId, { zIndex: prevZ - 1 });\n      }\n    },\n\n    deleteElement(elementId) {\n      const deck = deepCloneDeck(get().history.present);\n      const slideId = get().activeSlideId;\n      const slide = deck.slides.find(s => s.id === slideId);\n      if (slide) {\n        slide.elements = slide.elements.filter(e => e.id !== elementId);\n      }\n      set({ \n        history: pushHistory(get().history, deck), \n        selection: null \n      });\n    },\n\n    updateTextDelta(elementId, delta) {\n      const deck = deepCloneDeck(get().history.present);\n      const slideId = get().activeSlideId;\n      const slide = deck.slides.find(s => s.id === slideId);\n      if (slide) {\n        const el = slide.elements.find(e => e.id === elementId);\n        if (el && el.type === 'text') {\n          (el as TextElement).delta = delta;\n        }\n      }\n      set({ history: pushHistory(get().history, deck) });\n    },\n\n    appendTextDelta(elementId, appendText) {\n      const deck = deepCloneDeck(get().history.present);\n      const slideId = get().activeSlideId;\n      const slide = deck.slides.find(s => s.id === slideId);\n      if (slide) {\n        const element = slide.elements.find(e => e.id === elementId) as TextElement | undefined;\n        if (element && element.type === 'text') {\n          const ops = element.delta.ops || [];\n          if (ops.length > 0) {\n            const lastOp = ops[ops.length - 1];\n            if (typeof lastOp.insert === 'string' && lastOp.insert.endsWith('\\n')) {\n              ops[ops.length - 1] = { insert: lastOp.insert.slice(0, -1) + appendText + '\\n' };\n            } else if (typeof lastOp.insert === 'string') {\n              ops[ops.length - 1] = { insert: lastOp.insert + appendText };\n            }\n          }\n        }\n      }\n      set({ history: { ...get().history, present: deck } });\n    },\n\n    applyTextStyleToDefault(elementId, patch) {\n      const deck = deepCloneDeck(get().history.present);\n      const slideId = get().activeSlideId;\n      const slide = deck.slides.find(s => s.id === slideId);\n      if (slide) {\n        const el = slide.elements.find(e => e.id === elementId);\n        if (el && el.type === 'text') {\n          (el as TextElement).defaultTextStyle = { ...(el as TextElement).defaultTextStyle, ...patch };\n        }\n      }\n      set({ history: pushHistory(get().history, deck) });\n    },\n\n    addTextElement() {\n      const el: TextElement = {\n        id: nanoid(),\n        type: \"text\",\n        x: 100,\n        y: 200,\n        w: 400,\n        h: 100,\n        zIndex: Date.now(),\n        delta: { ops: [{ insert: \"Texto nuevo\\n\" }] },\n        defaultTextStyle: {\n          fontFamily: \"Inter\",\n          fontSize: 24,\n          color: \"#111111\"\n        }\n      };\n      get().addElement(el);\n    },\n\n    createStreamingTextElement(slideId, x, y, initialText = '') {\n      const previousActiveSlide = get().activeSlideId;\n      if (slideId !== previousActiveSlide) {\n        set({ activeSlideId: slideId });\n      }\n      const el: TextElement = {\n        id: nanoid(),\n        type: \"text\",\n        x,\n        y,\n        w: 600,\n        h: 80,\n        zIndex: Date.now(),\n        delta: { ops: [{ insert: initialText + '\\n' }] },\n        defaultTextStyle: {\n          fontFamily: \"Inter\",\n          fontSize: 24,\n          color: \"#111111\"\n        }\n      };\n      get().addElement(el);\n      return el.id;\n    },\n\n    addShapeElement(shapeType) {\n      const el: ShapeElement = {\n        id: nanoid(),\n        type: \"shape\",\n        shapeType,\n        x: 200,\n        y: 200,\n        w: 200,\n        h: shapeType === \"ellipse\" ? 200 : 150,\n        zIndex: Date.now(),\n        fill: \"#4F46E5\",\n        stroke: \"#3730A3\",\n        strokeWidth: 2\n      };\n      get().addElement(el);\n    },\n\n    addImageElement(src, naturalW, naturalH) {\n      const w = naturalW ? Math.min(400, naturalW) : 400;\n      const h = naturalH ? (w / naturalW!) * naturalH : 300;\n      const el: ImageElement = {\n        id: nanoid(),\n        type: \"image\",\n        x: 200,\n        y: 150,\n        w,\n        h,\n        zIndex: Date.now(),\n        src,\n        naturalW,\n        naturalH\n      };\n      get().addElement(el);\n    },\n\n    addChartElement(spec) {\n      const el: ChartElement = {\n        id: nanoid(),\n        type: \"chart\",\n        x: 200,\n        y: 200,\n        w: 400,\n        h: 300,\n        zIndex: Date.now(),\n        spec\n      };\n      get().addElement(el);\n    },\n\n    setStreaming(active, requestId) {\n      set({ streaming: { active, requestId } });\n    }\n  };\n});\n","path":null,"size_bytes":14860,"size_tokens":null},"client/src/components/ppt/store/history.ts":{"content":"export type HistoryState<T> = {\n  past: T[];\n  present: T;\n  future: T[];\n};\n\nexport function createHistory<T>(initial: T): HistoryState<T> {\n  return { past: [], present: initial, future: [] };\n}\n\nexport function pushHistory<T>(h: HistoryState<T>, next: T, limit = 80): HistoryState<T> {\n  const past = [...h.past, h.present];\n  if (past.length > limit) past.shift();\n  return { past, present: next, future: [] };\n}\n\nexport function undoHistory<T>(h: HistoryState<T>): HistoryState<T> {\n  if (h.past.length === 0) return h;\n  const prev = h.past[h.past.length - 1];\n  const past = h.past.slice(0, -1);\n  const future = [h.present, ...h.future];\n  return { past, present: prev, future };\n}\n\nexport function redoHistory<T>(h: HistoryState<T>): HistoryState<T> {\n  if (h.future.length === 0) return h;\n  const next = h.future[0];\n  const future = h.future.slice(1);\n  const past = [...h.past, h.present];\n  return { past, present: next, future };\n}\n\nexport function canUndo<T>(h: HistoryState<T>): boolean {\n  return h.past.length > 0;\n}\n\nexport function canRedo<T>(h: HistoryState<T>): boolean {\n  return h.future.length > 0;\n}\n","path":null,"size_bytes":1127,"size_tokens":null},"client/src/components/ppt/store/types.ts":{"content":"export type SlideSize = { w: number; h: number };\n\nexport type TextStyle = {\n  fontFamily: string;\n  fontSize: number;\n  color: string;\n  bold?: boolean;\n  italic?: boolean;\n  underline?: boolean;\n  strike?: boolean;\n};\n\nexport type DeltaOp = {\n  insert: string;\n  attributes?: {\n    bold?: boolean;\n    italic?: boolean;\n    underline?: boolean;\n    strike?: boolean;\n    color?: string;\n    link?: string;\n    header?: 1 | 2 | 3;\n    list?: \"bullet\" | \"ordered\";\n  };\n};\n\nexport type Delta = { ops: DeltaOp[] };\n\nexport type BaseElement = {\n  id: string;\n  type: \"text\" | \"image\" | \"shape\" | \"chart\";\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n  rotation?: number;\n  opacity?: number;\n  zIndex?: number;\n  locked?: boolean;\n};\n\nexport type TextElement = BaseElement & {\n  type: \"text\";\n  delta: Delta;\n  defaultTextStyle: TextStyle;\n};\n\nexport type ImageElement = BaseElement & {\n  type: \"image\";\n  src: string;\n  mime?: string;\n  naturalW?: number;\n  naturalH?: number;\n};\n\nexport type ShapeElement = BaseElement & {\n  type: \"shape\";\n  shapeType: \"rect\" | \"ellipse\";\n  fill: string;\n  stroke: string;\n  strokeWidth: number;\n  radius?: number;\n};\n\nexport type ChartElement = BaseElement & {\n  type: \"chart\";\n  spec: any;\n  svg?: string;\n  src?: string;\n};\n\nexport type ElementAny = TextElement | ImageElement | ShapeElement | ChartElement;\n\nexport type Slide = {\n  id: string;\n  size: SlideSize;\n  background: { color: string };\n  elements: ElementAny[];\n};\n\nexport type Deck = {\n  title: string;\n  slides: Slide[];\n};\n\nexport type Selection = { slideId: string; elementId: string } | null;\n","path":null,"size_bytes":1602,"size_tokens":null},"server/services/documentTemplates.ts":{"content":"export interface CvTemplateConfig {\n  name: string;\n  description: string;\n  layout: 'single-column' | 'two-column' | 'sidebar';\n  sidebarWidth?: number;\n  twoColumnLeftWidth?: number;\n  twoColumnRightWidth?: number;\n  fonts: {\n    heading: string;\n    body: string;\n    accent: string;\n  };\n  colors: {\n    primary: string;\n    secondary: string;\n    accent: string;\n    text: string;\n    lightText: string;\n    background: string;\n    sidebarBg?: string;\n  };\n  spacing: {\n    sectionGap: number;\n    itemGap: number;\n    lineHeight: number;\n  };\n  skillStyle: 'dots' | 'bars' | 'tags' | 'percentage' | 'text';\n  showPhoto: boolean;\n  photoShape: 'circle' | 'square' | 'rounded';\n}\n\nexport const cvTemplates: Record<string, CvTemplateConfig> = {\n  modern: {\n    name: 'modern',\n    description: 'A contemporary two-column layout with blue accents and clean typography',\n    layout: 'two-column',\n    twoColumnLeftWidth: 65,\n    twoColumnRightWidth: 35,\n    fonts: {\n      heading: 'Calibri',\n      body: 'Calibri',\n      accent: 'Calibri Light',\n    },\n    colors: {\n      primary: '#1e40af',\n      secondary: '#3b82f6',\n      accent: '#2563eb',\n      text: '#1f2937',\n      lightText: '#6b7280',\n      background: '#ffffff',\n    },\n    spacing: {\n      sectionGap: 24,\n      itemGap: 12,\n      lineHeight: 1.5,\n    },\n    skillStyle: 'bars',\n    showPhoto: true,\n    photoShape: 'circle',\n  },\n\n  classic: {\n    name: 'classic',\n    description: 'A traditional single-column layout with serif fonts and minimal styling',\n    layout: 'single-column',\n    fonts: {\n      heading: 'Times New Roman',\n      body: 'Times New Roman',\n      accent: 'Times New Roman',\n    },\n    colors: {\n      primary: '#1a1a1a',\n      secondary: '#333333',\n      accent: '#4a4a4a',\n      text: '#1a1a1a',\n      lightText: '#666666',\n      background: '#ffffff',\n    },\n    spacing: {\n      sectionGap: 20,\n      itemGap: 10,\n      lineHeight: 1.4,\n    },\n    skillStyle: 'text',\n    showPhoto: false,\n    photoShape: 'square',\n  },\n\n  creative: {\n    name: 'creative',\n    description: 'A bold sidebar layout with vibrant colors and tag-style skill indicators',\n    layout: 'sidebar',\n    sidebarWidth: 35,\n    fonts: {\n      heading: 'Calibri',\n      body: 'Calibri',\n      accent: 'Calibri',\n    },\n    colors: {\n      primary: '#7c3aed',\n      secondary: '#a78bfa',\n      accent: '#8b5cf6',\n      text: '#1f2937',\n      lightText: '#6b7280',\n      background: '#ffffff',\n      sidebarBg: '#7c3aed',\n    },\n    spacing: {\n      sectionGap: 28,\n      itemGap: 14,\n      lineHeight: 1.6,\n    },\n    skillStyle: 'tags',\n    showPhoto: true,\n    photoShape: 'circle',\n  },\n\n  minimalist: {\n    name: 'minimalist',\n    description: 'A clean single-column layout with grayscale palette and dot skill indicators',\n    layout: 'single-column',\n    twoColumnLeftWidth: 60,\n    twoColumnRightWidth: 40,\n    fonts: {\n      heading: 'Helvetica',\n      body: 'Helvetica',\n      accent: 'Helvetica Light',\n    },\n    colors: {\n      primary: '#374151',\n      secondary: '#6b7280',\n      accent: '#9ca3af',\n      text: '#374151',\n      lightText: '#9ca3af',\n      background: '#ffffff',\n    },\n    spacing: {\n      sectionGap: 32,\n      itemGap: 16,\n      lineHeight: 1.7,\n    },\n    skillStyle: 'dots',\n    showPhoto: false,\n    photoShape: 'circle',\n  },\n};\n\nexport function getCvTemplate(style: string): CvTemplateConfig {\n  return cvTemplates[style] || cvTemplates.modern;\n}\n\nexport function getAllCvTemplateNames(): string[] {\n  return Object.keys(cvTemplates);\n}\n","path":null,"size_bytes":3538,"size_tokens":null},"client/src/components/ppt/panels/SlidesPanel.tsx":{"content":"import React from 'react';\nimport { useDeckStore, selectDeck } from '../store/deckStore';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { cn } from '@/lib/utils';\n\nconst THUMB_WIDTH = 50;\nconst THUMB_HEIGHT = 28;\n\nexport function SlidesPanel() {\n  const deck = useDeckStore(selectDeck);\n  const activeSlideId = useDeckStore((s) => s.activeSlideId);\n  const setActiveSlide = useDeckStore((s) => s.setActiveSlide);\n\n  return (\n    <div className=\"h-full flex flex-col bg-[#f6f7fb]\">\n      <ScrollArea className=\"flex-1\">\n        <div className=\"py-2\">\n          {deck.slides.map((slide, index) => (\n            <div\n              key={slide.id}\n              className=\"flex items-start gap-1 px-1 py-1 cursor-pointer group\"\n              onClick={() => setActiveSlide(slide.id)}\n              data-testid={`slide-thumbnail-${index}`}\n            >\n              <span className=\"text-[10px] text-gray-500 w-4 text-right mt-1 flex-shrink-0\">\n                {index + 1}\n              </span>\n              <div\n                className={cn(\n                  \"rounded-sm overflow-hidden transition-all border-2\",\n                  activeSlideId === slide.id \n                    ? \"border-[#D83B01] ring-1 ring-[#D83B01]/30\" \n                    : \"border-gray-300 hover:border-gray-400\"\n                )}\n                style={{\n                  width: THUMB_WIDTH,\n                  height: THUMB_HEIGHT,\n                }}\n              >\n                <div className=\"relative w-full h-full\">\n                  <svg\n                    viewBox=\"0 0 1280 720\"\n                    width={THUMB_WIDTH}\n                    height={THUMB_HEIGHT}\n                    className=\"w-full h-full\"\n                    preserveAspectRatio=\"xMidYMid meet\"\n                  >\n                    <rect\n                      width=\"1280\"\n                      height=\"720\"\n                      fill={slide.background.color}\n                    />\n                    {slide.elements.map((el) => {\n                      if (el.type === 'text') {\n                        const text = el.delta.ops.map(op => op.insert).join('').slice(0, 50);\n                        return (\n                          <text\n                            key={el.id}\n                            x={el.x}\n                            y={el.y + (el.defaultTextStyle?.fontSize || 24)}\n                            fontSize={el.defaultTextStyle?.fontSize || 24}\n                            fill={el.defaultTextStyle?.color || '#000'}\n                            fontFamily={el.defaultTextStyle?.fontFamily || 'sans-serif'}\n                          >\n                            {text.slice(0, 30)}\n                          </text>\n                        );\n                      }\n                      if (el.type === 'shape') {\n                        if (el.shapeType === 'ellipse') {\n                          return (\n                            <ellipse\n                              key={el.id}\n                              cx={el.x + el.w / 2}\n                              cy={el.y + el.h / 2}\n                              rx={el.w / 2}\n                              ry={el.h / 2}\n                              fill={el.fill}\n                              stroke={el.stroke}\n                              strokeWidth={el.strokeWidth}\n                            />\n                          );\n                        }\n                        return (\n                          <rect\n                            key={el.id}\n                            x={el.x}\n                            y={el.y}\n                            width={el.w}\n                            height={el.h}\n                            fill={el.fill}\n                            stroke={el.stroke}\n                            strokeWidth={el.strokeWidth}\n                            rx={el.radius || 0}\n                          />\n                        );\n                      }\n                      if (el.type === 'image' || el.type === 'chart') {\n                        return (\n                          <rect\n                            key={el.id}\n                            x={el.x}\n                            y={el.y}\n                            width={el.w}\n                            height={el.h}\n                            fill=\"#e5e7eb\"\n                            stroke=\"#d1d5db\"\n                          />\n                        );\n                      }\n                      return null;\n                    })}\n                  </svg>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n}\n","path":null,"size_bytes":4672,"size_tokens":null},"server/services/documentMappingService.ts":{"content":"import { cvTemplates, CvTemplateConfig } from './documentTemplates';\nimport { cvSpecSchema } from '@shared/documentSpecs';\n\nexport function formatDate(dateStr: string): string {\n  if (!dateStr) return '';\n  \n  const isoMatch = dateStr.match(/^(\\d{4})-(\\d{2})(?:-\\d{2})?$/);\n  if (isoMatch) {\n    const [, year, month] = isoMatch;\n    const monthNames = [\n      'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'\n    ];\n    const monthIndex = parseInt(month, 10) - 1;\n    if (monthIndex >= 0 && monthIndex < 12) {\n      return `${monthNames[monthIndex]} ${year}`;\n    }\n  }\n  \n  return dateStr;\n}\n\nexport function formatDateRange(start: string, end: string | null | undefined): string {\n  const formattedStart = formatDate(start);\n  \n  if (!end) {\n    return `${formattedStart} - Present`;\n  }\n  \n  const formattedEnd = formatDate(end);\n  return `${formattedStart} - ${formattedEnd}`;\n}\n\nexport function generateSkillDots(proficiency: number, maxLevel: number = 5): string {\n  const filled = Math.min(Math.max(0, Math.round(proficiency)), maxLevel);\n  const empty = maxLevel - filled;\n  return '●'.repeat(filled) + '○'.repeat(empty);\n}\n\nexport function generateSkillBar(proficiency: number, maxLevel: number = 5): { filled: number; empty: number } {\n  const filled = Math.min(Math.max(0, Math.round(proficiency)), maxLevel);\n  const empty = maxLevel - filled;\n  return { filled, empty };\n}\n\nexport function selectCvTemplate(style: string): CvTemplateConfig {\n  const normalizedStyle = style?.toLowerCase().trim() || 'modern';\n  return cvTemplates[normalizedStyle] || cvTemplates.modern;\n}\n\nexport function validateCvSpec(spec: unknown): { valid: boolean; errors: string[] } {\n  const result = cvSpecSchema.safeParse(spec);\n  \n  if (result.success) {\n    return { valid: true, errors: [] };\n  }\n  \n  const errors = result.error.issues.map((issue) => {\n    const path = issue.path.join('.');\n    return path ? `${path}: ${issue.message}` : issue.message;\n  });\n  \n  return { valid: false, errors };\n}\n\nexport function generateSkillPercentage(proficiency: number, maxLevel: number = 5): number {\n  return Math.round((proficiency / maxLevel) * 100);\n}\n\nexport function generateSkillTags(skills: Array<{ name: string; proficiency: number }>): string[] {\n  return skills.map(s => s.name);\n}\n","path":null,"size_bytes":2326,"size_tokens":null},"client/src/components/ppt/panels/PropertiesPanel.tsx":{"content":"import React from 'react';\nimport { useDeckStore, selectActiveSlide, selectSelectedElement } from '../store/deckStore';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Slider } from '@/components/ui/slider';\nimport { Separator } from '@/components/ui/separator';\nimport { \n  Bold, \n  Italic, \n  Underline\n} from 'lucide-react';\nimport type { TextElement, ShapeElement } from '../store/types';\n\nconst FONT_FAMILIES = [\n  { label: 'Inter', value: 'Inter' },\n  { label: 'Arial', value: 'Arial' },\n  { label: 'Georgia', value: 'Georgia' },\n  { label: 'Times New Roman', value: 'Times New Roman' },\n  { label: 'Verdana', value: 'Verdana' },\n  { label: 'Courier New', value: 'Courier New' },\n];\n\nconst FONT_SIZES = [12, 14, 16, 18, 20, 24, 28, 32, 36, 44, 56, 72];\n\nexport function PropertiesPanel() {\n  const element = useDeckStore(selectSelectedElement);\n  const slide = useDeckStore(selectActiveSlide);\n  const updateElement = useDeckStore((s) => s.updateElement);\n  const applyTextStyleToDefault = useDeckStore((s) => s.applyTextStyleToDefault);\n  const setSlideBackground = useDeckStore((s) => s.setSlideBackground);\n\n  if (!element) {\n    return (\n      <div className=\"h-full flex flex-col\">\n        <div className=\"p-3 border-b\">\n          <h3 className=\"font-semibold text-sm\">Propiedades</h3>\n        </div>\n        <div className=\"flex-1 p-4\">\n          <div className=\"text-sm text-muted-foreground text-center py-8\">\n            Selecciona un elemento para ver sus propiedades\n          </div>\n          \n          <Separator className=\"my-4\" />\n          \n          <div className=\"space-y-3\">\n            <Label className=\"text-xs font-medium\">Fondo de diapositiva</Label>\n            <div className=\"flex items-center gap-2\">\n              <Input\n                type=\"color\"\n                value={slide.background.color}\n                onChange={(e) => setSlideBackground(slide.id, e.target.value)}\n                className=\"w-12 h-8 p-1\"\n                data-testid=\"input-slide-bg\"\n              />\n              <Input\n                value={slide.background.color}\n                onChange={(e) => setSlideBackground(slide.id, e.target.value)}\n                className=\"flex-1 h-8 text-sm\"\n              />\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const handleUpdatePosition = (key: 'x' | 'y' | 'w' | 'h', value: number) => {\n    updateElement(element.id, { [key]: value });\n  };\n\n  const handleUpdateOpacity = (value: number) => {\n    updateElement(element.id, { opacity: value / 100 });\n  };\n\n  const handleUpdateRotation = (value: number) => {\n    updateElement(element.id, { rotation: value });\n  };\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      <div className=\"p-3 border-b\">\n        <h3 className=\"font-semibold text-sm\">Propiedades</h3>\n      </div>\n      \n      <ScrollArea className=\"flex-1\">\n        <div className=\"p-3 space-y-4\">\n          <div className=\"space-y-3\">\n            <Label className=\"text-xs font-medium uppercase text-muted-foreground\">Posición</Label>\n            <div className=\"grid grid-cols-2 gap-2\">\n              <div>\n                <Label className=\"text-xs\">X</Label>\n                <Input\n                  type=\"number\"\n                  value={Math.round(element.x)}\n                  onChange={(e) => handleUpdatePosition('x', Number(e.target.value))}\n                  className=\"h-8 text-sm\"\n                  data-testid=\"input-pos-x\"\n                />\n              </div>\n              <div>\n                <Label className=\"text-xs\">Y</Label>\n                <Input\n                  type=\"number\"\n                  value={Math.round(element.y)}\n                  onChange={(e) => handleUpdatePosition('y', Number(e.target.value))}\n                  className=\"h-8 text-sm\"\n                  data-testid=\"input-pos-y\"\n                />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3\">\n            <Label className=\"text-xs font-medium uppercase text-muted-foreground\">Tamaño</Label>\n            <div className=\"grid grid-cols-2 gap-2\">\n              <div>\n                <Label className=\"text-xs\">Ancho</Label>\n                <Input\n                  type=\"number\"\n                  value={Math.round(element.w)}\n                  onChange={(e) => handleUpdatePosition('w', Number(e.target.value))}\n                  className=\"h-8 text-sm\"\n                  data-testid=\"input-size-w\"\n                />\n              </div>\n              <div>\n                <Label className=\"text-xs\">Alto</Label>\n                <Input\n                  type=\"number\"\n                  value={Math.round(element.h)}\n                  onChange={(e) => handleUpdatePosition('h', Number(e.target.value))}\n                  className=\"h-8 text-sm\"\n                  data-testid=\"input-size-h\"\n                />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3\">\n            <Label className=\"text-xs font-medium uppercase text-muted-foreground\">Apariencia</Label>\n            <div>\n              <Label className=\"text-xs\">Rotación</Label>\n              <div className=\"flex items-center gap-2\">\n                <Slider\n                  value={[element.rotation ?? 0]}\n                  onValueChange={([v]) => handleUpdateRotation(v)}\n                  min={0}\n                  max={360}\n                  step={1}\n                  className=\"flex-1\"\n                />\n                <span className=\"text-xs w-10 text-right\">{element.rotation ?? 0}°</span>\n              </div>\n            </div>\n            <div>\n              <Label className=\"text-xs\">Opacidad</Label>\n              <div className=\"flex items-center gap-2\">\n                <Slider\n                  value={[(element.opacity ?? 1) * 100]}\n                  onValueChange={([v]) => handleUpdateOpacity(v)}\n                  min={0}\n                  max={100}\n                  step={1}\n                  className=\"flex-1\"\n                />\n                <span className=\"text-xs w-10 text-right\">{Math.round((element.opacity ?? 1) * 100)}%</span>\n              </div>\n            </div>\n          </div>\n\n          <Separator />\n\n          {element.type === 'text' && (\n            <TextProperties\n              element={element}\n              onUpdateStyle={(patch) => applyTextStyleToDefault(element.id, patch)}\n            />\n          )}\n\n          {element.type === 'shape' && (\n            <ShapeProperties\n              element={element}\n              onUpdate={(patch) => updateElement(element.id, patch)}\n            />\n          )}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n}\n\nfunction TextProperties({ \n  element, \n  onUpdateStyle \n}: { \n  element: TextElement; \n  onUpdateStyle: (patch: Partial<TextElement['defaultTextStyle']>) => void;\n}) {\n  const style = element.defaultTextStyle;\n\n  return (\n    <div className=\"space-y-4\">\n      <Label className=\"text-xs font-medium uppercase text-muted-foreground\">Texto</Label>\n      \n      <div className=\"space-y-2\">\n        <Label className=\"text-xs\">Fuente</Label>\n        <Select\n          value={style.fontFamily}\n          onValueChange={(v) => onUpdateStyle({ fontFamily: v })}\n        >\n          <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-font-family\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            {FONT_FAMILIES.map((font) => (\n              <SelectItem key={font.value} value={font.value}>\n                {font.label}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-2\">\n        <div>\n          <Label className=\"text-xs\">Tamaño</Label>\n          <Select\n            value={String(style.fontSize)}\n            onValueChange={(v) => onUpdateStyle({ fontSize: Number(v) })}\n          >\n            <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-font-size\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {FONT_SIZES.map((size) => (\n                <SelectItem key={size} value={String(size)}>\n                  {size}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n        <div>\n          <Label className=\"text-xs\">Color</Label>\n          <div className=\"flex gap-1\">\n            <Input\n              type=\"color\"\n              value={style.color}\n              onChange={(e) => onUpdateStyle({ color: e.target.value })}\n              className=\"w-12 h-8 p-1\"\n              data-testid=\"input-text-color\"\n            />\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex gap-1\">\n        <Button\n          variant={style.bold ? \"default\" : \"outline\"}\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => onUpdateStyle({ bold: !style.bold })}\n          data-testid=\"btn-text-bold\"\n        >\n          <Bold className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant={style.italic ? \"default\" : \"outline\"}\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => onUpdateStyle({ italic: !style.italic })}\n          data-testid=\"btn-text-italic\"\n        >\n          <Italic className=\"h-4 w-4\" />\n        </Button>\n        <Button\n          variant={style.underline ? \"default\" : \"outline\"}\n          size=\"icon\"\n          className=\"h-8 w-8\"\n          onClick={() => onUpdateStyle({ underline: !style.underline })}\n          data-testid=\"btn-text-underline\"\n        >\n          <Underline className=\"h-4 w-4\" />\n        </Button>\n      </div>\n    </div>\n  );\n}\n\nfunction ShapeProperties({ \n  element, \n  onUpdate \n}: { \n  element: ShapeElement; \n  onUpdate: (patch: Partial<ShapeElement>) => void;\n}) {\n  return (\n    <div className=\"space-y-4\">\n      <Label className=\"text-xs font-medium uppercase text-muted-foreground\">Forma</Label>\n      \n      <div className=\"grid grid-cols-2 gap-2\">\n        <div>\n          <Label className=\"text-xs\">Relleno</Label>\n          <div className=\"flex gap-1\">\n            <Input\n              type=\"color\"\n              value={element.fill}\n              onChange={(e) => onUpdate({ fill: e.target.value })}\n              className=\"w-full h-8 p-1\"\n              data-testid=\"input-shape-fill\"\n            />\n          </div>\n        </div>\n        <div>\n          <Label className=\"text-xs\">Borde</Label>\n          <div className=\"flex gap-1\">\n            <Input\n              type=\"color\"\n              value={element.stroke}\n              onChange={(e) => onUpdate({ stroke: e.target.value })}\n              className=\"w-full h-8 p-1\"\n              data-testid=\"input-shape-stroke\"\n            />\n          </div>\n        </div>\n      </div>\n\n      <div>\n        <Label className=\"text-xs\">Grosor de borde</Label>\n        <div className=\"flex items-center gap-2\">\n          <Slider\n            value={[element.strokeWidth]}\n            onValueChange={([v]) => onUpdate({ strokeWidth: v })}\n            min={0}\n            max={20}\n            step={1}\n            className=\"flex-1\"\n          />\n          <span className=\"text-xs w-8 text-right\">{element.strokeWidth}px</span>\n        </div>\n      </div>\n\n      {element.shapeType === 'rect' && (\n        <div>\n          <Label className=\"text-xs\">Radio de esquinas</Label>\n          <div className=\"flex items-center gap-2\">\n            <Slider\n              value={[element.radius ?? 0]}\n              onValueChange={([v]) => onUpdate({ radius: v })}\n              min={0}\n              max={50}\n              step={1}\n              className=\"flex-1\"\n            />\n            <span className=\"text-xs w-8 text-right\">{element.radius ?? 0}px</span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":12106,"size_tokens":null},"server/routes/pptExport.ts":{"content":"import { Router } from 'express';\nimport pptxgen from 'pptxgenjs';\n\nexport const pptExportRouter = Router();\n\ninterface TextStyle {\n  fontFamily?: string;\n  fontSize?: number;\n  color?: string;\n  bold?: boolean;\n  italic?: boolean;\n  underline?: boolean;\n}\n\ninterface DeltaOp {\n  insert: string;\n  attributes?: Record<string, any>;\n}\n\ninterface Delta {\n  ops: DeltaOp[];\n}\n\ninterface BaseElement {\n  id: string;\n  type: string;\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n  rotation?: number;\n  opacity?: number;\n  zIndex?: number;\n}\n\ninterface TextElement extends BaseElement {\n  type: 'text';\n  delta: Delta;\n  defaultTextStyle: TextStyle;\n}\n\ninterface ShapeElement extends BaseElement {\n  type: 'shape';\n  shapeType: 'rect' | 'ellipse';\n  fill: string;\n  stroke: string;\n  strokeWidth: number;\n  radius?: number;\n}\n\ninterface ImageElement extends BaseElement {\n  type: 'image';\n  src: string;\n}\n\ninterface ChartElement extends BaseElement {\n  type: 'chart';\n  svg?: string;\n  src?: string;\n}\n\ntype ElementAny = TextElement | ShapeElement | ImageElement | ChartElement;\n\ninterface Slide {\n  id: string;\n  size: { w: number; h: number };\n  background: { color: string };\n  elements: ElementAny[];\n}\n\ninterface Deck {\n  title: string;\n  slides: Slide[];\n}\n\nfunction pxToIn(px: number): number {\n  return px / 96;\n}\n\nfunction normalizeHex(hex: string): string {\n  const h = String(hex || '').trim();\n  if (!h) return '000000';\n  return h.replace('#', '').toUpperCase();\n}\n\nfunction deltaToPlainText(delta: Delta): string {\n  return delta.ops.map(op => op.insert).join('');\n}\n\nfunction svgToDataUri(svg: string): string {\n  const base64 = Buffer.from(svg).toString('base64');\n  return `data:image/svg+xml;base64,${base64}`;\n}\n\npptExportRouter.post('/export', async (req, res) => {\n  try {\n    const deck: Deck = req.body;\n\n    const pptx = new pptxgen();\n    pptx.layout = 'LAYOUT_WIDE';\n    pptx.title = deck.title || 'Presentation';\n\n    for (const s of deck.slides ?? []) {\n      const slide = pptx.addSlide();\n\n      if (s.background?.color) {\n        slide.background = { color: normalizeHex(s.background.color) };\n      }\n\n      const elements = [...(s.elements ?? [])].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\n\n      for (const el of elements) {\n        const x = pxToIn(el.x ?? 0);\n        const y = pxToIn(el.y ?? 0);\n        const w = pxToIn(el.w ?? 100);\n        const h = pxToIn(el.h ?? 40);\n\n        if (el.type === 'text') {\n          const textEl = el as TextElement;\n          const plain = deltaToPlainText(textEl.delta);\n          const style = textEl.defaultTextStyle;\n\n          slide.addText(plain, {\n            x,\n            y,\n            w,\n            h,\n            fontFace: style?.fontFamily ?? 'Arial',\n            fontSize: style?.fontSize ?? 18,\n            color: normalizeHex(style?.color ?? '#111111'),\n            bold: !!style?.bold,\n            italic: !!style?.italic,\n            underline: style?.underline ? { style: 'sng' } : undefined,\n            rotate: el.rotation ?? 0\n          });\n          continue;\n        }\n\n        if (el.type === 'shape') {\n          const shapeEl = el as ShapeElement;\n          const shapeType = shapeEl.shapeType === 'ellipse' ? 'ellipse' : 'rect';\n\n          slide.addShape(shapeType, {\n            x,\n            y,\n            w,\n            h,\n            fill: { color: normalizeHex(shapeEl.fill ?? '#FFFFFF') },\n            line: { \n              color: normalizeHex(shapeEl.stroke ?? '#000000'), \n              width: shapeEl.strokeWidth ?? 1 \n            },\n            rotate: el.rotation ?? 0\n          });\n          continue;\n        }\n\n        if (el.type === 'image') {\n          const imgEl = el as ImageElement;\n          if (imgEl.src) {\n            slide.addImage({\n              data: imgEl.src,\n              x,\n              y,\n              w,\n              h,\n              rotate: el.rotation ?? 0\n            });\n          }\n          continue;\n        }\n\n        if (el.type === 'chart') {\n          const chartEl = el as ChartElement;\n          if (chartEl.svg) {\n            const uri = svgToDataUri(chartEl.svg);\n            slide.addImage({ data: uri, x, y, w, h, rotate: el.rotation ?? 0 });\n          } else if (chartEl.src) {\n            slide.addImage({ data: chartEl.src, x, y, w, h, rotate: el.rotation ?? 0 });\n          }\n          continue;\n        }\n      }\n    }\n\n    const buffer = await pptx.write({ outputType: 'nodebuffer' }) as Buffer;\n\n    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.presentationml.presentation');\n    res.setHeader('Content-Disposition', `attachment; filename=\"${deck.title || 'presentation'}.pptx\"`);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error('PPTX export error:', error);\n    res.status(500).json({ error: error.message || 'Failed to export PPTX' });\n  }\n});\n","path":null,"size_bytes":4874,"size_tokens":null},"client/src/components/ppt/store/index.ts":{"content":"export * from './types';\nexport * from './history';\nexport * from './deckStore';\n","path":null,"size_bytes":81,"size_tokens":null},"client/src/components/ppt/canvas/elements/ChartNode.tsx":{"content":"import React, { useRef, useEffect, useState } from 'react';\nimport { Image, Group, Rect, Text } from 'react-konva';\nimport type Konva from 'konva';\nimport type { ChartElement } from '../../store/types';\n\ninterface ChartNodeProps {\n  element: ChartElement;\n  isSelected: boolean;\n  onSelect: () => void;\n  onTransformEnd: (newAttrs: Partial<ChartElement>) => void;\n}\n\nexport function ChartNode({ element, isSelected, onSelect, onTransformEnd }: ChartNodeProps) {\n  const groupRef = useRef<Konva.Group>(null);\n  const [image, setImage] = useState<HTMLImageElement | null>(null);\n\n  useEffect(() => {\n    if (element.svg) {\n      const svgBlob = new Blob([element.svg], { type: 'image/svg+xml;charset=utf-8' });\n      const url = URL.createObjectURL(svgBlob);\n      const img = new window.Image();\n      img.onload = () => {\n        setImage(img);\n        URL.revokeObjectURL(url);\n      };\n      img.src = url;\n    } else if (element.src) {\n      const img = new window.Image();\n      img.crossOrigin = 'anonymous';\n      img.onload = () => setImage(img);\n      img.src = element.src;\n    }\n  }, [element.svg, element.src]);\n\n  const handleDragEnd = (e: Konva.KonvaEventObject<DragEvent>) => {\n    onTransformEnd({\n      x: e.target.x(),\n      y: e.target.y()\n    });\n  };\n\n  const handleTransformEnd = () => {\n    const node = groupRef.current;\n    if (!node) return;\n\n    const scaleX = node.scaleX();\n    const scaleY = node.scaleY();\n\n    node.scaleX(1);\n    node.scaleY(1);\n\n    onTransformEnd({\n      x: node.x(),\n      y: node.y(),\n      w: Math.max(50, node.width() * scaleX),\n      h: Math.max(50, node.height() * scaleY),\n      rotation: node.rotation()\n    });\n  };\n\n  return (\n    <Group\n      ref={groupRef}\n      x={element.x}\n      y={element.y}\n      width={element.w}\n      height={element.h}\n      rotation={element.rotation ?? 0}\n      draggable={!element.locked}\n      onClick={onSelect}\n      onTap={onSelect}\n      onDragEnd={handleDragEnd}\n      onTransformEnd={handleTransformEnd}\n      opacity={element.opacity ?? 1}\n    >\n      {image ? (\n        <Image\n          image={image}\n          width={element.w}\n          height={element.h}\n        />\n      ) : (\n        <>\n          <Rect\n            width={element.w}\n            height={element.h}\n            fill=\"#f3f4f6\"\n            stroke=\"#d1d5db\"\n            strokeWidth={1}\n          />\n          <Text\n            text=\"Chart\"\n            width={element.w}\n            height={element.h}\n            align=\"center\"\n            verticalAlign=\"middle\"\n            fontSize={16}\n            fill=\"#9ca3af\"\n          />\n        </>\n      )}\n      {isSelected && (\n        <Rect\n          width={element.w}\n          height={element.h}\n          stroke=\"#2563eb\"\n          strokeWidth={2}\n          fill=\"transparent\"\n        />\n      )}\n    </Group>\n  );\n}\n","path":null,"size_bytes":2834,"size_tokens":null},"client/src/lib/pptExport.ts":{"content":"import type { Deck } from '@/components/ppt/store/types';\n\nexport async function exportDeckToPptx(deck: Deck): Promise<Blob> {\n  const response = await fetch('/api/ppt/export', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(deck)\n  });\n\n  if (!response.ok) {\n    throw new Error(`Export failed: ${response.statusText}`);\n  }\n\n  return response.blob();\n}\n\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = filename;\n  document.body.appendChild(a);\n  a.click();\n  document.body.removeChild(a);\n  URL.revokeObjectURL(url);\n}\n","path":null,"size_bytes":705,"size_tokens":null},"client/src/lib/pptStreaming.ts":{"content":"import { useDeckStore } from \"@/components/ppt/store/deckStore\";\n\nexport type StreamElementType = 'title' | 'bullet' | 'text' | 'chart';\n\ninterface StreamState {\n  currentSlideId: string | null;\n  currentElementId: string | null;\n  currentType: StreamElementType | null;\n  buffer: string;\n  yOffset: number;\n}\n\nconst ELEMENT_POSITIONS: Record<StreamElementType, { x: number; y: number; fontSize: number; bold?: boolean }> = {\n  title: { x: 80, y: 80, fontSize: 44, bold: true },\n  bullet: { x: 100, y: 200, fontSize: 24 },\n  text: { x: 80, y: 200, fontSize: 24 },\n  chart: { x: 200, y: 200, fontSize: 24 }\n};\n\nconst MARKERS = {\n  slide: '::slide::',\n  title: '::title::',\n  bullet: '::bullet::',\n  text: '::text::',\n  chart: '::chart::',\n  end: '::end'\n} as const;\n\nexport function createPptStreamParser() {\n  let state: StreamState = {\n    currentSlideId: null,\n    currentElementId: null,\n    currentType: null,\n    buffer: '',\n    yOffset: 0\n  };\n\n  const store = useDeckStore.getState;\n\n  function createSlide(): string {\n    store().addSlide();\n    const newSlideId = store().activeSlideId;\n    state.currentSlideId = newSlideId;\n    state.yOffset = 0;\n    return newSlideId;\n  }\n\n  function createTextElement(type: StreamElementType, initialText: string = ''): string {\n    if (!state.currentSlideId) {\n      createSlide();\n    }\n    \n    const pos = ELEMENT_POSITIONS[type];\n    const y = type === 'title' ? pos.y : pos.y + state.yOffset;\n    \n    const elementId = store().createStreamingTextElement(\n      state.currentSlideId!,\n      pos.x,\n      y,\n      initialText\n    );\n\n    if (pos.bold || pos.fontSize !== 24) {\n      store().applyTextStyleToDefault(elementId, {\n        fontSize: pos.fontSize,\n        bold: pos.bold\n      });\n    }\n\n    state.yOffset += 60;\n    return elementId;\n  }\n\n  function appendToElement(text: string): void {\n    if (state.currentElementId) {\n      store().appendTextDelta(state.currentElementId, text);\n    }\n  }\n\n  function finalizeElement(): void {\n    state.currentElementId = null;\n    state.currentType = null;\n  }\n\n  function createChartElement(jsonSpec: string): void {\n    if (!state.currentSlideId) {\n      createSlide();\n    }\n    \n    try {\n      const spec = JSON.parse(jsonSpec);\n      store().addChartElement(spec);\n      state.yOffset += 320;\n    } catch (e) {\n      console.error('Failed to parse chart spec:', e);\n    }\n  }\n\n  function processBuffer(): void {\n    let buffer = state.buffer;\n\n    while (buffer.length > 0) {\n      if (state.currentType === null) {\n        if (buffer.startsWith(MARKERS.slide)) {\n          buffer = buffer.slice(MARKERS.slide.length);\n          createSlide();\n          continue;\n        }\n\n        if (buffer.startsWith(MARKERS.title)) {\n          buffer = buffer.slice(MARKERS.title.length);\n          state.currentType = 'title';\n          state.currentElementId = createTextElement('title');\n          continue;\n        }\n\n        if (buffer.startsWith(MARKERS.bullet)) {\n          buffer = buffer.slice(MARKERS.bullet.length);\n          state.currentType = 'bullet';\n          state.currentElementId = createTextElement('bullet', '• ');\n          continue;\n        }\n\n        if (buffer.startsWith(MARKERS.text)) {\n          buffer = buffer.slice(MARKERS.text.length);\n          state.currentType = 'text';\n          state.currentElementId = createTextElement('text');\n          continue;\n        }\n\n        if (buffer.startsWith(MARKERS.chart)) {\n          buffer = buffer.slice(MARKERS.chart.length);\n          state.currentType = 'chart';\n          continue;\n        }\n\n        let foundMarker = false;\n        for (const marker of Object.values(MARKERS)) {\n          const idx = buffer.indexOf(marker);\n          if (idx > 0) {\n            buffer = buffer.slice(idx);\n            foundMarker = true;\n            break;\n          } else if (idx === 0) {\n            foundMarker = true;\n            break;\n          }\n        }\n\n        if (!foundMarker) {\n          const potentialMarkerStart = buffer.lastIndexOf('::');\n          if (potentialMarkerStart > 0 && potentialMarkerStart > buffer.length - 20) {\n            state.buffer = buffer.slice(potentialMarkerStart);\n            return;\n          }\n          buffer = '';\n        }\n      } else {\n        const endIdx = buffer.indexOf(MARKERS.end);\n        \n        if (endIdx === -1) {\n          const potentialEndStart = buffer.lastIndexOf('::');\n          if (potentialEndStart !== -1 && potentialEndStart > buffer.length - 6) {\n            const textToAppend = buffer.slice(0, potentialEndStart);\n            if (textToAppend && state.currentType !== 'chart') {\n              appendToElement(textToAppend);\n            }\n            state.buffer = buffer.slice(potentialEndStart);\n            return;\n          }\n          \n          if (state.currentType !== 'chart') {\n            appendToElement(buffer);\n          } else {\n            state.buffer = buffer;\n            return;\n          }\n          buffer = '';\n        } else {\n          const content = buffer.slice(0, endIdx);\n          \n          if (state.currentType === 'chart') {\n            createChartElement(content);\n          } else if (content) {\n            appendToElement(content);\n          }\n          \n          finalizeElement();\n          buffer = buffer.slice(endIdx + MARKERS.end.length);\n        }\n      }\n    }\n\n    state.buffer = buffer;\n  }\n\n  return {\n    processChunk(chunk: string): void {\n      state.buffer += chunk;\n      processBuffer();\n    },\n\n    reset(): void {\n      state = {\n        currentSlideId: null,\n        currentElementId: null,\n        currentType: null,\n        buffer: '',\n        yOffset: 0\n      };\n    },\n\n    flush(): void {\n      if (state.buffer && state.currentType && state.currentType !== 'chart') {\n        appendToElement(state.buffer);\n      }\n      state.buffer = '';\n      finalizeElement();\n    },\n\n    getState(): Readonly<StreamState> {\n      return { ...state };\n    }\n  };\n}\n\nexport type PptStreamParser = ReturnType<typeof createPptStreamParser>;\n","path":null,"size_bytes":6037,"size_tokens":null},"client/src/lib/pptPrompts.ts":{"content":"export const PPT_STREAMING_SYSTEM_PROMPT = `You are a presentation creation assistant. Generate slide content using this markup format:\n\n::slide:: - Start a new slide\n::title::Your Title Here::end - Create a slide title\n::bullet::Bullet point text::end - Create a bullet point\n::text::Regular paragraph text::end - Create a text block\n::chart::{\"type\":\"bar\",\"title\":\"Chart Title\",\"labels\":[\"A\",\"B\",\"C\"],\"values\":[10,20,30]}::end - Create a chart\n\nRULES:\n1. Always start with ::slide:: for each new slide\n2. Each slide should have exactly one title\n3. Use bullets for lists, text for paragraphs\n4. Create 3-5 slides for a typical presentation\n5. Keep titles short (5-8 words max)\n6. Bullets should be concise (10-15 words max)\n\nExample:\n::slide::\n::title::Introduction to AI::end\n::bullet::Machine learning fundamentals::end\n::bullet::Neural networks overview::end\n::text::This presentation covers the basics of artificial intelligence.::end\n::slide::\n::title::Key Concepts::end\n...`;\n\nexport function createPptGenerationPrompt(userRequest: string): string {\n  return `Create a professional presentation about: ${userRequest}`;\n}\n","path":null,"size_bytes":1129,"size_tokens":null},"client/src/hooks/usePptStreaming.ts":{"content":"import { useState, useCallback, useRef } from 'react';\nimport { createPptStreamParser } from '@/lib/pptStreaming';\n\nexport function usePptStreaming() {\n  const [isStreaming, setIsStreaming] = useState(false);\n  const isStreamingRef = useRef(false);\n  const parserRef = useRef(createPptStreamParser());\n  \n  const startStreaming = useCallback(() => {\n    parserRef.current.reset();\n    isStreamingRef.current = true;\n    setIsStreaming(true);\n  }, []);\n  \n  const stopStreaming = useCallback(() => {\n    parserRef.current.flush();\n    isStreamingRef.current = false;\n    setIsStreaming(false);\n  }, []);\n  \n  const processChunk = useCallback((chunk: string) => {\n    if (isStreamingRef.current) {\n      parserRef.current.processChunk(chunk);\n    }\n  }, []);\n  \n  return {\n    isStreaming,\n    startStreaming,\n    stopStreaming,\n    processChunk\n  };\n}\n","path":null,"size_bytes":851,"size_tokens":null},"server/services/richText/fontRegistry.ts":{"content":"import { FontFamily, FontRegistry, FontVariant, TextStyle, getFontVariantKey } from \"@shared/richTextTypes\";\n\nexport const defaultFontRegistry: FontRegistry = {\n  families: {\n    \"Calibri\": {\n      name: \"Calibri\",\n      variants: {\n        regular: \"Calibri\",\n        bold: \"Calibri Bold\",\n        italic: \"Calibri Italic\",\n        boldItalic: \"Calibri Bold Italic\",\n      },\n      fallback: [\"Arial\", \"Helvetica\", \"sans-serif\"],\n    },\n    \"Arial\": {\n      name: \"Arial\",\n      variants: {\n        regular: \"Arial\",\n        bold: \"Arial Bold\",\n        italic: \"Arial Italic\",\n        boldItalic: \"Arial Bold Italic\",\n      },\n      fallback: [\"Helvetica\", \"sans-serif\"],\n    },\n    \"Times New Roman\": {\n      name: \"Times New Roman\",\n      variants: {\n        regular: \"Times New Roman\",\n        bold: \"Times New Roman Bold\",\n        italic: \"Times New Roman Italic\",\n        boldItalic: \"Times New Roman Bold Italic\",\n      },\n      fallback: [\"Times\", \"Georgia\", \"serif\"],\n    },\n    \"Georgia\": {\n      name: \"Georgia\",\n      variants: {\n        regular: \"Georgia\",\n        bold: \"Georgia Bold\",\n        italic: \"Georgia Italic\",\n        boldItalic: \"Georgia Bold Italic\",\n      },\n      fallback: [\"Times New Roman\", \"serif\"],\n    },\n    \"Helvetica\": {\n      name: \"Helvetica\",\n      variants: {\n        regular: \"Helvetica\",\n        bold: \"Helvetica Bold\",\n        italic: \"Helvetica Oblique\",\n        boldItalic: \"Helvetica Bold Oblique\",\n      },\n      fallback: [\"Arial\", \"sans-serif\"],\n    },\n    \"Inter\": {\n      name: \"Inter\",\n      variants: {\n        regular: \"Inter\",\n        bold: \"Inter Bold\",\n        italic: \"Inter Italic\",\n        boldItalic: \"Inter Bold Italic\",\n      },\n      fallback: [\"Helvetica\", \"Arial\", \"sans-serif\"],\n    },\n    \"Roboto\": {\n      name: \"Roboto\",\n      variants: {\n        regular: \"Roboto\",\n        bold: \"Roboto Bold\",\n        italic: \"Roboto Italic\",\n        boldItalic: \"Roboto Bold Italic\",\n      },\n      fallback: [\"Helvetica\", \"Arial\", \"sans-serif\"],\n    },\n    \"Open Sans\": {\n      name: \"Open Sans\",\n      variants: {\n        regular: \"Open Sans\",\n        bold: \"Open Sans Bold\",\n        italic: \"Open Sans Italic\",\n        boldItalic: \"Open Sans Bold Italic\",\n      },\n      fallback: [\"Helvetica\", \"Arial\", \"sans-serif\"],\n    },\n    \"Courier New\": {\n      name: \"Courier New\",\n      variants: {\n        regular: \"Courier New\",\n        bold: \"Courier New Bold\",\n        italic: \"Courier New Italic\",\n        boldItalic: \"Courier New Bold Italic\",\n      },\n      fallback: [\"Courier\", \"monospace\"],\n    },\n    \"Consolas\": {\n      name: \"Consolas\",\n      variants: {\n        regular: \"Consolas\",\n        bold: \"Consolas Bold\",\n        italic: \"Consolas Italic\",\n        boldItalic: \"Consolas Bold Italic\",\n      },\n      fallback: [\"Courier New\", \"monospace\"],\n    },\n  },\n  defaultFamily: \"Calibri\",\n  monoFamily: \"Courier New\",\n};\n\nconst missingVariantWarnings = new Set<string>();\n\nexport function resolveFontForStyle(\n  style: TextStyle,\n  registry: FontRegistry = defaultFontRegistry\n): { fontName: string; usedFallback: boolean } {\n  const requestedFamily = style.fontFamily || registry.defaultFamily;\n  const isCode = style.code;\n\n  const familyName = isCode ? registry.monoFamily : requestedFamily;\n  const family = registry.families[familyName];\n\n  if (!family) {\n    const warningKey = `family:${familyName}`;\n    if (!missingVariantWarnings.has(warningKey)) {\n      missingVariantWarnings.add(warningKey);\n      console.warn(`[FontRegistry] Font family \"${familyName}\" not found, using default`);\n    }\n    return { fontName: registry.defaultFamily, usedFallback: true };\n  }\n\n  const variantKey = getFontVariantKey(style);\n  const variantFont = family.variants[variantKey];\n\n  if (variantFont) {\n    return { fontName: variantFont, usedFallback: false };\n  }\n\n  const warningKey = `variant:${familyName}:${variantKey}`;\n  if (!missingVariantWarnings.has(warningKey)) {\n    missingVariantWarnings.add(warningKey);\n    console.warn(\n      `[FontRegistry] Font variant \"${variantKey}\" not found for \"${familyName}\", using fallback`\n    );\n  }\n\n  if (variantKey === \"boldItalic\") {\n    if (family.variants.bold) return { fontName: family.variants.bold, usedFallback: true };\n    if (family.variants.italic) return { fontName: family.variants.italic, usedFallback: true };\n  } else if (variantKey === \"bold\" || variantKey === \"italic\") {\n    if (family.variants.regular) return { fontName: family.variants.regular, usedFallback: true };\n  }\n\n  return {\n    fontName: family.variants.regular || family.name,\n    usedFallback: true,\n  };\n}\n\nexport function getFontFamilyWithFallback(\n  fontName: string,\n  registry: FontRegistry = defaultFontRegistry\n): string {\n  const family = registry.families[fontName];\n  if (family) {\n    return [fontName, ...family.fallback].join(\", \");\n  }\n  return fontName;\n}\n\nexport interface DocxFontOptions {\n  font: string;\n  bold?: boolean;\n  italics?: boolean;\n}\n\nexport function getDocxFontOptions(\n  style: TextStyle,\n  registry: FontRegistry = defaultFontRegistry\n): DocxFontOptions {\n  const baseFamily = style.code ? registry.monoFamily : (style.fontFamily || registry.defaultFamily);\n\n  return {\n    font: baseFamily,\n    bold: style.bold || false,\n    italics: style.italic || false,\n  };\n}\n\nexport function getCssFontStyle(\n  style: TextStyle,\n  registry: FontRegistry = defaultFontRegistry\n): Record<string, string> {\n  const cssStyle: Record<string, string> = {};\n\n  const familyName = style.code\n    ? registry.monoFamily\n    : style.fontFamily || registry.defaultFamily;\n\n  cssStyle.fontFamily = getFontFamilyWithFallback(familyName, registry);\n\n  if (style.bold) cssStyle.fontWeight = \"bold\";\n  if (style.italic) cssStyle.fontStyle = \"italic\";\n  if (style.underline) cssStyle.textDecoration = \"underline\";\n  if (style.strikethrough) {\n    cssStyle.textDecoration = cssStyle.textDecoration\n      ? `${cssStyle.textDecoration} line-through`\n      : \"line-through\";\n  }\n  if (style.color) cssStyle.color = style.color;\n  if (style.backgroundColor) cssStyle.backgroundColor = style.backgroundColor;\n  if (style.fontSize) cssStyle.fontSize = `${style.fontSize}pt`;\n\n  return cssStyle;\n}\n\nexport function getCanvasFontString(\n  style: TextStyle,\n  baseFontSize: number = 12,\n  registry: FontRegistry = defaultFontRegistry\n): string {\n  const fontSize = style.fontSize || baseFontSize;\n  const familyName = style.code\n    ? registry.monoFamily\n    : style.fontFamily || registry.defaultFamily;\n\n  const parts: string[] = [];\n\n  if (style.italic) parts.push(\"italic\");\n  if (style.bold) parts.push(\"bold\");\n\n  parts.push(`${fontSize}px`);\n  parts.push(`\"${familyName}\"`);\n\n  return parts.join(\" \");\n}\n\nexport function registerFont(\n  family: FontFamily,\n  registry: FontRegistry = defaultFontRegistry\n): void {\n  registry.families[family.name] = family;\n}\n\nexport function clearWarnings(): void {\n  missingVariantWarnings.clear();\n}\n","path":null,"size_bytes":6931,"size_tokens":null},"server/services/richText/universalRenderer.ts":{"content":"import {\n  RichTextDocument,\n  RichTextBlock,\n  TextRun,\n  TextStyle,\n  HeadingBlock,\n  ParagraphBlock,\n  BulletListBlock,\n  OrderedListBlock,\n  BlockquoteBlock,\n  CodeBlock,\n  TableBlock,\n  ListItem,\n} from \"@shared/richTextTypes\";\nimport {\n  defaultFontRegistry,\n  FontRegistry,\n  getDocxFontOptions,\n  getCssFontStyle,\n} from \"./fontRegistry\";\nimport {\n  Document,\n  Packer,\n  Paragraph,\n  TextRun as DocxTextRun,\n  HeadingLevel,\n  Table,\n  TableRow,\n  TableCell,\n  WidthType,\n  BorderStyle,\n  AlignmentType,\n  ExternalHyperlink,\n  convertInchesToTwip,\n  IParagraphOptions,\n  ITableCellOptions,\n  PageBreak,\n  TabStopPosition,\n  TabStopType,\n  ShadingType,\n} from \"docx\";\n\nexport interface RenderOptions {\n  fontRegistry?: FontRegistry;\n  defaultFontSize?: number;\n  defaultFontFamily?: string;\n  lineHeight?: number;\n  headingSizes?: Record<number, number>;\n  colors?: {\n    primary?: string;\n    secondary?: string;\n    text?: string;\n    lightText?: string;\n    link?: string;\n  };\n}\n\nconst DEFAULT_OPTIONS: Required<RenderOptions> = {\n  fontRegistry: defaultFontRegistry,\n  defaultFontSize: 11,\n  defaultFontFamily: \"Calibri\",\n  lineHeight: 276,\n  headingSizes: {\n    1: 28,\n    2: 24,\n    3: 20,\n    4: 16,\n    5: 14,\n    6: 12,\n  },\n  colors: {\n    primary: \"#1f2937\",\n    secondary: \"#4b5563\",\n    text: \"#1f2937\",\n    lightText: \"#6b7280\",\n    link: \"#0066cc\",\n  },\n};\n\ntype DocxParagraphChild = DocxTextRun | ExternalHyperlink;\n\nexport function renderRunToDocx(\n  run: TextRun,\n  options: RenderOptions = {}\n): DocxParagraphChild {\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n  const style = run.style || {};\n\n  const fontOptions = getDocxFontOptions(style, opts.fontRegistry);\n  const fontSize = (style.fontSize || opts.defaultFontSize) * 2;\n\n  const textRunOptions: ConstructorParameters<typeof DocxTextRun>[0] = {\n    text: run.text,\n    font: style.fontFamily || fontOptions.font,\n    size: fontSize,\n    bold: fontOptions.bold,\n    italics: fontOptions.italics,\n    underline: style.underline ? {} : undefined,\n    strike: style.strikethrough,\n    color: style.color?.replace(\"#\", \"\"),\n    shading: style.backgroundColor\n      ? { fill: style.backgroundColor.replace(\"#\", \"\"), type: ShadingType.CLEAR, color: \"auto\" }\n      : undefined,\n    superScript: style.superscript,\n    subScript: style.subscript,\n  };\n\n  if (style.code) {\n    textRunOptions.font = opts.fontRegistry?.monoFamily || \"Courier New\";\n    textRunOptions.shading = { fill: \"F0F0F0\", type: ShadingType.CLEAR, color: \"auto\" };\n  }\n\n  if (style.link) {\n    return new ExternalHyperlink({\n      children: [\n        new DocxTextRun({\n          ...textRunOptions,\n          color: (style.color || opts.colors?.link || \"#0066cc\").replace(\"#\", \"\"),\n          underline: {},\n        }),\n      ],\n      link: style.link,\n    });\n  }\n\n  return new DocxTextRun(textRunOptions);\n}\n\nexport function renderRunsToDocx(\n  runs: TextRun[],\n  options: RenderOptions = {}\n): DocxParagraphChild[] {\n  return runs.map((run) => renderRunToDocx(run, options));\n}\n\nexport function renderBlockToDocx(\n  block: RichTextBlock,\n  options: RenderOptions = {}\n): (Paragraph | Table)[] {\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n\n  switch (block.type) {\n    case \"heading\":\n      return [renderHeadingToDocx(block, opts)];\n\n    case \"paragraph\":\n      return [renderParagraphToDocx(block, opts)];\n\n    case \"bullet-list\":\n      return renderBulletListToDocx(block, opts);\n\n    case \"ordered-list\":\n      return renderOrderedListToDocx(block, opts);\n\n    case \"blockquote\":\n      return [renderBlockquoteToDocx(block, opts)];\n\n    case \"code-block\":\n      return [renderCodeBlockToDocx(block, opts)];\n\n    case \"horizontal-rule\":\n      return [\n        new Paragraph({\n          border: {\n            bottom: { style: BorderStyle.SINGLE, size: 6, color: \"CCCCCC\" },\n          },\n          spacing: { after: 200 },\n        }),\n      ];\n\n    case \"table\":\n      return [renderTableToDocx(block, opts)];\n\n    case \"image\":\n      return [];\n\n    default:\n      return [];\n  }\n}\n\nfunction renderHeadingToDocx(\n  block: HeadingBlock,\n  opts: Required<RenderOptions>\n): Paragraph {\n  const headingLevelMap: Record<number, (typeof HeadingLevel)[keyof typeof HeadingLevel]> = {\n    1: HeadingLevel.HEADING_1,\n    2: HeadingLevel.HEADING_2,\n    3: HeadingLevel.HEADING_3,\n    4: HeadingLevel.HEADING_4,\n    5: HeadingLevel.HEADING_5,\n    6: HeadingLevel.HEADING_6,\n  };\n\n  const fontSize = opts.headingSizes[block.level] || 16;\n  const headingRuns = block.runs.map((run) => {\n    const enhancedRun: TextRun = {\n      ...run,\n      style: {\n        ...run.style,\n        bold: true,\n        fontSize: run.style?.fontSize || fontSize,\n      },\n    };\n    return renderRunToDocx(enhancedRun, opts);\n  });\n\n  return new Paragraph({\n    heading: headingLevelMap[block.level],\n    children: headingRuns,\n    alignment: getDocxAlignment(block.alignment),\n    spacing: { before: 240, after: 120 },\n  });\n}\n\nfunction renderParagraphToDocx(\n  block: ParagraphBlock,\n  opts: Required<RenderOptions>\n): Paragraph {\n  return new Paragraph({\n    children: renderRunsToDocx(block.runs, opts),\n    alignment: getDocxAlignment(block.alignment),\n    indent: block.indent\n      ? { left: convertInchesToTwip(block.indent * 0.5) }\n      : undefined,\n    spacing: { after: 200, line: opts.lineHeight },\n  });\n}\n\nfunction renderBulletListToDocx(\n  block: BulletListBlock,\n  opts: Required<RenderOptions>\n): Paragraph[] {\n  return renderListItemsToDocx(block.items, false, 0, opts);\n}\n\nfunction renderOrderedListToDocx(\n  block: OrderedListBlock,\n  opts: Required<RenderOptions>\n): Paragraph[] {\n  return renderListItemsToDocx(block.items, true, 0, opts);\n}\n\nfunction renderListItemsToDocx(\n  items: ListItem[],\n  ordered: boolean,\n  level: number,\n  opts: Required<RenderOptions>\n): Paragraph[] {\n  const paragraphs: Paragraph[] = [];\n\n  items.forEach((item, index) => {\n    const bullet = ordered ? `${index + 1}.` : \"•\";\n    const indent = convertInchesToTwip(0.25 + level * 0.25);\n\n    const bulletRun = new DocxTextRun({\n      text: bullet + \" \",\n      font: opts.defaultFontFamily,\n      size: opts.defaultFontSize * 2,\n    });\n\n    paragraphs.push(\n      new Paragraph({\n        children: [bulletRun, ...renderRunsToDocx(item.runs, opts)],\n        indent: { left: indent, hanging: convertInchesToTwip(0.25) },\n        spacing: { after: 80, line: opts.lineHeight },\n      })\n    );\n\n    if (item.children && item.children.length > 0) {\n      paragraphs.push(\n        ...renderListItemsToDocx(item.children, ordered, level + 1, opts)\n      );\n    }\n  });\n\n  return paragraphs;\n}\n\nfunction renderBlockquoteToDocx(\n  block: BlockquoteBlock,\n  opts: Required<RenderOptions>\n): Paragraph {\n  const quotedRuns = block.runs.map((run) => ({\n    ...run,\n    style: {\n      ...run.style,\n      italic: true,\n      color: run.style?.color || opts.colors.lightText,\n    },\n  }));\n\n  return new Paragraph({\n    children: renderRunsToDocx(quotedRuns, opts),\n    indent: { left: convertInchesToTwip(0.5) },\n    border: {\n      left: { style: BorderStyle.SINGLE, size: 12, color: \"CCCCCC\" },\n    },\n    spacing: { before: 120, after: 120, line: opts.lineHeight },\n  });\n}\n\nfunction renderCodeBlockToDocx(\n  block: CodeBlock,\n  opts: Required<RenderOptions>\n): Paragraph {\n  return new Paragraph({\n    children: [\n      new DocxTextRun({\n        text: block.code,\n        font: opts.fontRegistry.monoFamily,\n        size: opts.defaultFontSize * 2 - 2,\n      }),\n    ],\n    shading: { fill: \"F5F5F5\", type: ShadingType.CLEAR, color: \"auto\" },\n    spacing: { before: 120, after: 120 },\n  });\n}\n\nfunction renderTableToDocx(\n  block: TableBlock,\n  opts: Required<RenderOptions>\n): Table {\n  const rows = block.rows.map((row) => {\n    const cells = row.cells.map((cell) => {\n      const cellOptions: ITableCellOptions = {\n        children: [\n          new Paragraph({\n            children: renderRunsToDocx(cell.runs, opts),\n          }),\n        ],\n        columnSpan: cell.colSpan,\n        rowSpan: cell.rowSpan,\n        shading: cell.isHeader\n          ? { fill: \"F0F0F0\", type: ShadingType.CLEAR, color: \"auto\" }\n          : undefined,\n      };\n      return new TableCell(cellOptions);\n    });\n    return new TableRow({ children: cells });\n  });\n\n  return new Table({\n    rows,\n    width: { size: 100, type: WidthType.PERCENTAGE },\n  });\n}\n\nfunction getDocxAlignment(\n  alignment?: \"left\" | \"center\" | \"right\" | \"justify\"\n): AlignmentType | undefined {\n  if (!alignment) return undefined;\n  const map: Record<string, AlignmentType> = {\n    left: AlignmentType.LEFT,\n    center: AlignmentType.CENTER,\n    right: AlignmentType.RIGHT,\n    justify: AlignmentType.JUSTIFIED,\n  };\n  return map[alignment];\n}\n\nexport function renderDocumentToDocx(\n  doc: RichTextDocument,\n  options: RenderOptions = {}\n): (Paragraph | Table)[] {\n  const elements: (Paragraph | Table)[] = [];\n\n  for (const block of doc.blocks) {\n    elements.push(...renderBlockToDocx(block, options));\n  }\n\n  return elements;\n}\n\nexport async function renderDocumentToDocxBuffer(\n  doc: RichTextDocument,\n  options: RenderOptions = {}\n): Promise<Buffer> {\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n  const bodyElements = renderDocumentToDocx(doc, opts);\n\n  const document = new Document({\n    styles: {\n      paragraphStyles: [\n        {\n          id: \"Normal\",\n          name: \"Normal\",\n          basedOn: \"Normal\",\n          next: \"Normal\",\n          run: {\n            font: opts.defaultFontFamily,\n            size: opts.defaultFontSize * 2,\n          },\n          paragraph: {\n            spacing: { line: opts.lineHeight },\n          },\n        },\n      ],\n    },\n    sections: [\n      {\n        properties: {\n          page: {\n            margin: {\n              top: convertInchesToTwip(0.75),\n              right: convertInchesToTwip(0.75),\n              bottom: convertInchesToTwip(0.75),\n              left: convertInchesToTwip(0.75),\n            },\n          },\n        },\n        children: bodyElements,\n      },\n    ],\n  });\n\n  return await Packer.toBuffer(document);\n}\n\nexport function renderRunToHtml(run: TextRun, options: RenderOptions = {}): string {\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n  const style = run.style || {};\n  const cssStyles = getCssFontStyle(style, opts.fontRegistry);\n\n  let html = escapeHtml(run.text);\n\n  if (style.bold) html = `<strong>${html}</strong>`;\n  if (style.italic) html = `<em>${html}</em>`;\n  if (style.underline) html = `<u>${html}</u>`;\n  if (style.strikethrough) html = `<del>${html}</del>`;\n  if (style.code) html = `<code>${html}</code>`;\n  if (style.superscript) html = `<sup>${html}</sup>`;\n  if (style.subscript) html = `<sub>${html}</sub>`;\n\n  if (style.link) {\n    html = `<a href=\"${escapeHtml(style.link)}\" style=\"color: ${opts.colors.link}; text-decoration: underline;\">${html}</a>`;\n  }\n\n  const inlineStyles: string[] = [];\n  if (style.color) inlineStyles.push(`color: ${style.color}`);\n  if (style.backgroundColor) inlineStyles.push(`background-color: ${style.backgroundColor}`);\n  if (style.fontSize) inlineStyles.push(`font-size: ${style.fontSize}pt`);\n  if (style.fontFamily) inlineStyles.push(`font-family: ${style.fontFamily}`);\n\n  if (inlineStyles.length > 0) {\n    html = `<span style=\"${inlineStyles.join(\"; \")}\">${html}</span>`;\n  }\n\n  return html;\n}\n\nexport function renderRunsToHtml(runs: TextRun[], options: RenderOptions = {}): string {\n  return runs.map((run) => renderRunToHtml(run, options)).join(\"\");\n}\n\nexport function renderBlockToHtml(block: RichTextBlock, options: RenderOptions = {}): string {\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n\n  switch (block.type) {\n    case \"heading\":\n      return `<h${block.level}>${renderRunsToHtml(block.runs, opts)}</h${block.level}>`;\n\n    case \"paragraph\":\n      const pStyle = block.alignment ? ` style=\"text-align: ${block.alignment}\"` : \"\";\n      return `<p${pStyle}>${renderRunsToHtml(block.runs, opts)}</p>`;\n\n    case \"bullet-list\":\n      const ulItems = block.items\n        .map((item) => `<li>${renderRunsToHtml(item.runs, opts)}</li>`)\n        .join(\"\");\n      return `<ul>${ulItems}</ul>`;\n\n    case \"ordered-list\":\n      const olStart = block.start && block.start !== 1 ? ` start=\"${block.start}\"` : \"\";\n      const olItems = block.items\n        .map((item) => `<li>${renderRunsToHtml(item.runs, opts)}</li>`)\n        .join(\"\");\n      return `<ol${olStart}>${olItems}</ol>`;\n\n    case \"blockquote\":\n      return `<blockquote>${renderRunsToHtml(block.runs, opts)}</blockquote>`;\n\n    case \"code-block\":\n      const langClass = block.language ? ` class=\"language-${block.language}\"` : \"\";\n      return `<pre><code${langClass}>${escapeHtml(block.code)}</code></pre>`;\n\n    case \"horizontal-rule\":\n      return \"<hr>\";\n\n    case \"table\":\n      const tableRows = block.rows\n        .map((row) => {\n          const cells = row.cells\n            .map((cell) => {\n              const tag = cell.isHeader ? \"th\" : \"td\";\n              const attrs: string[] = [];\n              if (cell.colSpan && cell.colSpan > 1) attrs.push(`colspan=\"${cell.colSpan}\"`);\n              if (cell.rowSpan && cell.rowSpan > 1) attrs.push(`rowspan=\"${cell.rowSpan}\"`);\n              const attrStr = attrs.length > 0 ? \" \" + attrs.join(\" \") : \"\";\n              return `<${tag}${attrStr}>${renderRunsToHtml(cell.runs, opts)}</${tag}>`;\n            })\n            .join(\"\");\n          return `<tr>${cells}</tr>`;\n        })\n        .join(\"\");\n      return `<table>${tableRows}</table>`;\n\n    case \"image\":\n      const altAttr = block.alt ? ` alt=\"${escapeHtml(block.alt)}\"` : \"\";\n      const titleAttr = block.title ? ` title=\"${escapeHtml(block.title)}\"` : \"\";\n      return `<img src=\"${escapeHtml(block.src)}\"${altAttr}${titleAttr}>`;\n\n    default:\n      return \"\";\n  }\n}\n\nexport function renderDocumentToHtml(\n  doc: RichTextDocument,\n  options: RenderOptions = {}\n): string {\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n\n  const css = `\n    body {\n      font-family: ${opts.defaultFontFamily}, sans-serif;\n      font-size: ${opts.defaultFontSize}pt;\n      line-height: 1.6;\n      color: ${opts.colors.text};\n      max-width: 800px;\n      margin: 0 auto;\n      padding: 20px;\n    }\n    h1, h2, h3, h4, h5, h6 {\n      font-weight: bold;\n      margin-top: 1.5em;\n      margin-bottom: 0.5em;\n    }\n    h1 { font-size: ${opts.headingSizes[1]}pt; }\n    h2 { font-size: ${opts.headingSizes[2]}pt; }\n    h3 { font-size: ${opts.headingSizes[3]}pt; }\n    h4 { font-size: ${opts.headingSizes[4]}pt; }\n    h5 { font-size: ${opts.headingSizes[5]}pt; }\n    h6 { font-size: ${opts.headingSizes[6]}pt; }\n    p { margin: 0.5em 0; }\n    ul, ol { padding-left: 1.5em; }\n    li { margin: 0.25em 0; }\n    blockquote {\n      border-left: 4px solid #ddd;\n      margin: 1em 0;\n      padding-left: 1em;\n      color: ${opts.colors.lightText};\n      font-style: italic;\n    }\n    pre {\n      background-color: #f5f5f5;\n      padding: 12px;\n      border-radius: 4px;\n      overflow-x: auto;\n    }\n    code {\n      font-family: ${opts.fontRegistry.monoFamily}, monospace;\n      background-color: #f5f5f5;\n      padding: 2px 4px;\n      border-radius: 3px;\n    }\n    pre code {\n      background: none;\n      padding: 0;\n    }\n    table {\n      border-collapse: collapse;\n      width: 100%;\n      margin: 1em 0;\n    }\n    th, td {\n      border: 1px solid #ddd;\n      padding: 8px;\n      text-align: left;\n    }\n    th {\n      background-color: #f0f0f0;\n      font-weight: bold;\n    }\n    hr {\n      border: none;\n      border-top: 1px solid #ddd;\n      margin: 1.5em 0;\n    }\n    a {\n      color: ${opts.colors.link};\n      text-decoration: underline;\n    }\n    img {\n      max-width: 100%;\n      height: auto;\n    }\n    strong, b { font-weight: bold; }\n    em, i { font-style: italic; }\n    u { text-decoration: underline; }\n    del, s { text-decoration: line-through; }\n  `;\n\n  const body = doc.blocks.map((block) => renderBlockToHtml(block, opts)).join(\"\\n\");\n\n  return `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <style>${css}</style>\n</head>\n<body>\n${body}\n</body>\n</html>`;\n}\n\nfunction escapeHtml(text: string): string {\n  return text\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#39;\");\n}\n","path":null,"size_bytes":16369,"size_tokens":null},"server/services/richText/index.ts":{"content":"export * from \"./richTextParser\";\nexport * from \"./fontRegistry\";\nexport * from \"./universalRenderer\";\nexport * from \"./markdownTokenizer\";\nexport * from \"./latexMath\";\n\nimport {\n  parseInlineMarkdown,\n  parseMarkdownToDocument,\n  parseHtmlToDocument,\n  detectDocumentType,\n} from \"./richTextParser\";\nimport {\n  defaultFontRegistry,\n  resolveFontForStyle,\n  getDocxFontOptions,\n  getCssFontStyle,\n  getCanvasFontString,\n} from \"./fontRegistry\";\nimport {\n  renderRunToDocx,\n  renderRunsToDocx,\n  renderBlockToDocx,\n  renderDocumentToDocx,\n  renderDocumentToDocxBuffer,\n  renderRunToHtml,\n  renderRunsToHtml,\n  renderBlockToHtml,\n  renderDocumentToHtml,\n  RenderOptions,\n} from \"./universalRenderer\";\nimport { TextRun, TextStyle, RichTextDocument, RichTextBlock } from \"@shared/richTextTypes\";\nimport {\n  TextRun as DocxTextRun,\n  ExternalHyperlink,\n  ShadingType,\n} from \"docx\";\n\nexport interface FontConfig {\n  font: string;\n  size: number;\n}\n\nexport interface ParseRenderOptions {\n  extraBold?: boolean;\n  defaultColor?: string;\n}\n\nexport function parseAndRenderToDocx(\n  text: string,\n  fontConfig: FontConfig,\n  options?: ParseRenderOptions | boolean\n): (DocxTextRun | ExternalHyperlink)[] {\n  const runs = parseInlineMarkdown(text);\n  \n  const opts: ParseRenderOptions = typeof options === 'boolean' \n    ? { extraBold: options } \n    : (options || {});\n\n  return runs.map((run) => {\n    const style: TextStyle = {\n      ...run.style,\n      bold: run.style?.bold || opts.extraBold,\n      fontFamily: fontConfig.font,\n      fontSize: fontConfig.size / 2,\n      color: run.style?.color || opts.defaultColor,\n    };\n\n    const fontOptions = getDocxFontOptions(style, defaultFontRegistry);\n\n    const textRunOptions: ConstructorParameters<typeof DocxTextRun>[0] = {\n      text: run.text,\n      font: style.code ? defaultFontRegistry.monoFamily : fontConfig.font,\n      size: fontConfig.size,\n      bold: fontOptions.bold,\n      italics: fontOptions.italics,\n      underline: style.underline ? {} : undefined,\n      strike: style.strikethrough,\n      color: style.color?.replace(\"#\", \"\"),\n      shading: style.code\n        ? { fill: \"F0F0F0\", type: ShadingType.CLEAR, color: \"auto\" }\n        : style.backgroundColor\n          ? { fill: style.backgroundColor.replace(\"#\", \"\"), type: ShadingType.CLEAR, color: \"auto\" }\n          : undefined,\n    };\n\n    if (style.link) {\n      return new ExternalHyperlink({\n        children: [\n          new DocxTextRun({\n            ...textRunOptions,\n            color: (style.color || \"0066CC\").replace(\"#\", \"\"),\n            underline: {},\n          }),\n        ],\n        link: style.link,\n      });\n    }\n\n    return new DocxTextRun(textRunOptions);\n  });\n}\n\nexport function parseAndRenderToHtml(text: string): string {\n  const runs = parseInlineMarkdown(text);\n  return renderRunsToHtml(runs);\n}\n\nexport function hasRichTextMarkers(text: string): boolean {\n  if (!text || typeof text !== \"string\") return false;\n\n  const patterns = [\n    /\\*\\*.+?\\*\\*/,\n    /\\*.+?\\*/,\n    /__.+?__/,\n    /_.+?_/,\n    /~~.+?~~/,\n    /`.+?`/,\n    /\\[.+?\\]\\(.+?\\)/,\n    /<(strong|em|b|i|u|del|code|mark|span|a)[^>]*>/i,\n  ];\n\n  return patterns.some((p) => p.test(text));\n}\n\nexport const RichText = {\n  parse: {\n    markdown: parseMarkdownToDocument,\n    html: parseHtmlToDocument,\n    inline: parseInlineMarkdown,\n  },\n\n  detect: {\n    documentType: detectDocumentType,\n    hasRichText: hasRichTextMarkers,\n  },\n\n  font: {\n    registry: defaultFontRegistry,\n    resolve: resolveFontForStyle,\n    getDocxOptions: getDocxFontOptions,\n    getCssStyle: getCssFontStyle,\n    getCanvasFont: getCanvasFontString,\n  },\n\n  render: {\n    toDocx: {\n      run: renderRunToDocx,\n      runs: renderRunsToDocx,\n      block: renderBlockToDocx,\n      document: renderDocumentToDocx,\n      buffer: renderDocumentToDocxBuffer,\n    },\n    toHtml: {\n      run: renderRunToHtml,\n      runs: renderRunsToHtml,\n      block: renderBlockToHtml,\n      document: renderDocumentToHtml,\n    },\n  },\n\n  helpers: {\n    parseAndRenderToDocx,\n    parseAndRenderToHtml,\n  },\n};\n\nexport default RichText;\n","path":null,"size_bytes":4087,"size_tokens":null},"shared/richTextTypes.ts":{"content":"import { z } from \"zod\";\n\nexport const TextStyleSchema = z.object({\n  bold: z.boolean().optional(),\n  italic: z.boolean().optional(),\n  underline: z.boolean().optional(),\n  strikethrough: z.boolean().optional(),\n  code: z.boolean().optional(),\n  color: z.string().optional(),\n  backgroundColor: z.string().optional(),\n  fontSize: z.number().optional(),\n  fontFamily: z.string().optional(),\n  link: z.string().optional(),\n  superscript: z.boolean().optional(),\n  subscript: z.boolean().optional(),\n});\n\nexport type TextStyle = z.infer<typeof TextStyleSchema>;\n\nexport const TextRunSchema = z.object({\n  text: z.string(),\n  style: TextStyleSchema.optional(),\n});\n\nexport type TextRun = z.infer<typeof TextRunSchema>;\n\nexport const ListItemSchema: z.ZodType<ListItem> = z.lazy(() =>\n  z.object({\n    runs: z.array(TextRunSchema),\n    children: z.array(ListItemSchema).optional(),\n  })\n);\n\nexport interface ListItem {\n  runs: TextRun[];\n  children?: ListItem[];\n}\n\nexport const BlockTypeSchema = z.enum([\n  \"heading\",\n  \"paragraph\",\n  \"bullet-list\",\n  \"ordered-list\",\n  \"blockquote\",\n  \"code-block\",\n  \"horizontal-rule\",\n  \"table\",\n  \"image\",\n]);\n\nexport type BlockType = z.infer<typeof BlockTypeSchema>;\n\nexport const HeadingBlockSchema = z.object({\n  type: z.literal(\"heading\"),\n  level: z.number().min(1).max(6),\n  runs: z.array(TextRunSchema),\n  alignment: z.enum([\"left\", \"center\", \"right\", \"justify\"]).optional(),\n});\n\nexport type HeadingBlock = z.infer<typeof HeadingBlockSchema>;\n\nexport const ParagraphBlockSchema = z.object({\n  type: z.literal(\"paragraph\"),\n  runs: z.array(TextRunSchema),\n  alignment: z.enum([\"left\", \"center\", \"right\", \"justify\"]).optional(),\n  indent: z.number().optional(),\n});\n\nexport type ParagraphBlock = z.infer<typeof ParagraphBlockSchema>;\n\nexport const BulletListBlockSchema = z.object({\n  type: z.literal(\"bullet-list\"),\n  items: z.array(ListItemSchema),\n  indent: z.number().optional(),\n});\n\nexport type BulletListBlock = z.infer<typeof BulletListBlockSchema>;\n\nexport const OrderedListBlockSchema = z.object({\n  type: z.literal(\"ordered-list\"),\n  items: z.array(ListItemSchema),\n  start: z.number().optional(),\n  indent: z.number().optional(),\n});\n\nexport type OrderedListBlock = z.infer<typeof OrderedListBlockSchema>;\n\nexport const BlockquoteBlockSchema = z.object({\n  type: z.literal(\"blockquote\"),\n  runs: z.array(TextRunSchema),\n});\n\nexport type BlockquoteBlock = z.infer<typeof BlockquoteBlockSchema>;\n\nexport const CodeBlockSchema = z.object({\n  type: z.literal(\"code-block\"),\n  code: z.string(),\n  language: z.string().optional(),\n});\n\nexport type CodeBlock = z.infer<typeof CodeBlockSchema>;\n\nexport const HorizontalRuleBlockSchema = z.object({\n  type: z.literal(\"horizontal-rule\"),\n});\n\nexport type HorizontalRuleBlock = z.infer<typeof HorizontalRuleBlockSchema>;\n\nexport const TableCellSchema = z.object({\n  runs: z.array(TextRunSchema),\n  colSpan: z.number().optional(),\n  rowSpan: z.number().optional(),\n  isHeader: z.boolean().optional(),\n});\n\nexport type TableCell = z.infer<typeof TableCellSchema>;\n\nexport const TableRowSchema = z.object({\n  cells: z.array(TableCellSchema),\n});\n\nexport type TableRow = z.infer<typeof TableRowSchema>;\n\nexport const TableBlockSchema = z.object({\n  type: z.literal(\"table\"),\n  rows: z.array(TableRowSchema),\n  hasHeader: z.boolean().optional(),\n});\n\nexport type TableBlock = z.infer<typeof TableBlockSchema>;\n\nexport const ImageBlockSchema = z.object({\n  type: z.literal(\"image\"),\n  src: z.string(),\n  alt: z.string().optional(),\n  title: z.string().optional(),\n  width: z.number().optional(),\n  height: z.number().optional(),\n});\n\nexport type ImageBlock = z.infer<typeof ImageBlockSchema>;\n\nexport const RichTextBlockSchema = z.discriminatedUnion(\"type\", [\n  HeadingBlockSchema,\n  ParagraphBlockSchema,\n  BulletListBlockSchema,\n  OrderedListBlockSchema,\n  BlockquoteBlockSchema,\n  CodeBlockSchema,\n  HorizontalRuleBlockSchema,\n  TableBlockSchema,\n  ImageBlockSchema,\n]);\n\nexport type RichTextBlock = z.infer<typeof RichTextBlockSchema>;\n\nexport const RichTextDocumentSchema = z.object({\n  blocks: z.array(RichTextBlockSchema),\n  metadata: z\n    .object({\n      title: z.string().optional(),\n      author: z.string().optional(),\n      createdAt: z.string().optional(),\n      documentType: z\n        .enum([\"cv\", \"letter\", \"report\", \"article\", \"contract\", \"generic\"])\n        .optional(),\n    })\n    .optional(),\n});\n\nexport type RichTextDocument = z.infer<typeof RichTextDocumentSchema>;\n\nexport type FontWeight = \"regular\" | \"bold\";\nexport type FontStyle = \"normal\" | \"italic\";\n\nexport interface FontVariant {\n  weight: FontWeight;\n  style: FontStyle;\n}\n\nexport interface FontFamily {\n  name: string;\n  variants: {\n    regular?: string;\n    bold?: string;\n    italic?: string;\n    boldItalic?: string;\n  };\n  fallback: string[];\n}\n\nexport interface FontRegistry {\n  families: Record<string, FontFamily>;\n  defaultFamily: string;\n  monoFamily: string;\n}\n\nexport function getFontVariantKey(style: TextStyle): keyof FontFamily[\"variants\"] {\n  if (style.bold && style.italic) return \"boldItalic\";\n  if (style.bold) return \"bold\";\n  if (style.italic) return \"italic\";\n  return \"regular\";\n}\n\nexport function mergeStyles(base: TextStyle, overlay: TextStyle): TextStyle {\n  return {\n    ...base,\n    ...overlay,\n    bold: overlay.bold ?? base.bold,\n    italic: overlay.italic ?? base.italic,\n    underline: overlay.underline ?? base.underline,\n    strikethrough: overlay.strikethrough ?? base.strikethrough,\n    code: overlay.code ?? base.code,\n    color: overlay.color ?? base.color,\n    backgroundColor: overlay.backgroundColor ?? base.backgroundColor,\n    fontSize: overlay.fontSize ?? base.fontSize,\n    fontFamily: overlay.fontFamily ?? base.fontFamily,\n    link: overlay.link ?? base.link,\n  };\n}\n\nexport function normalizeRuns(runs: TextRun[]): TextRun[] {\n  if (runs.length === 0) return [];\n\n  const normalized: TextRun[] = [];\n  let current: TextRun | null = null;\n\n  for (const run of runs) {\n    if (run.text.length === 0) continue;\n\n    if (current && stylesEqual(current.style, run.style)) {\n      current = { text: current.text + run.text, style: current.style };\n    } else {\n      if (current) normalized.push(current);\n      current = { ...run };\n    }\n  }\n\n  if (current) normalized.push(current);\n  return normalized;\n}\n\nfunction stylesEqual(a?: TextStyle, b?: TextStyle): boolean {\n  if (!a && !b) return true;\n  if (!a || !b) return false;\n  return (\n    a.bold === b.bold &&\n    a.italic === b.italic &&\n    a.underline === b.underline &&\n    a.strikethrough === b.strikethrough &&\n    a.code === b.code &&\n    a.color === b.color &&\n    a.backgroundColor === b.backgroundColor &&\n    a.fontSize === b.fontSize &&\n    a.fontFamily === b.fontFamily &&\n    a.link === b.link\n  );\n}\n","path":null,"size_bytes":6782,"size_tokens":null},"server/services/richText/richTextParser.ts":{"content":"import {\n  RichTextDocument,\n  RichTextBlock,\n  TextRun,\n  TextStyle,\n  HeadingBlock,\n  ParagraphBlock,\n  BulletListBlock,\n  OrderedListBlock,\n  BlockquoteBlock,\n  CodeBlock,\n  TableBlock,\n  ListItem,\n  normalizeRuns,\n} from \"@shared/richTextTypes\";\n\ninterface MarkdownNode {\n  type: string;\n  children?: MarkdownNode[];\n  value?: string;\n  depth?: number;\n  ordered?: boolean;\n  start?: number;\n  lang?: string;\n  url?: string;\n  title?: string;\n  alt?: string;\n}\n\nexport function parseMarkdownToDocument(markdown: string): RichTextDocument {\n  const blocks: RichTextBlock[] = [];\n  const lines = markdown.split(\"\\n\");\n  let i = 0;\n\n  while (i < lines.length) {\n    const line = lines[i];\n\n    if (line.trim() === \"\") {\n      i++;\n      continue;\n    }\n\n    const headingMatch = line.match(/^(#{1,6})\\s+(.+)$/);\n    if (headingMatch) {\n      const level = headingMatch[1].length as 1 | 2 | 3 | 4 | 5 | 6;\n      const content = headingMatch[2];\n      blocks.push({\n        type: \"heading\",\n        level,\n        runs: parseInlineMarkdown(content),\n      });\n      i++;\n      continue;\n    }\n\n    if (line.startsWith(\"```\")) {\n      const langMatch = line.match(/^```(\\w+)?/);\n      const language = langMatch?.[1] || undefined;\n      const codeLines: string[] = [];\n      i++;\n      while (i < lines.length && !lines[i].startsWith(\"```\")) {\n        codeLines.push(lines[i]);\n        i++;\n      }\n      blocks.push({\n        type: \"code-block\",\n        code: codeLines.join(\"\\n\"),\n        language,\n      });\n      i++;\n      continue;\n    }\n\n    if (line.match(/^[-*]\\s+/)) {\n      const items: ListItem[] = [];\n      while (i < lines.length && lines[i].match(/^[-*]\\s+/)) {\n        const itemContent = lines[i].replace(/^[-*]\\s+/, \"\");\n        items.push({ runs: parseInlineMarkdown(itemContent) });\n        i++;\n      }\n      blocks.push({ type: \"bullet-list\", items });\n      continue;\n    }\n\n    if (line.match(/^\\d+\\.\\s+/)) {\n      const items: ListItem[] = [];\n      const startMatch = line.match(/^(\\d+)\\./);\n      const start = startMatch ? parseInt(startMatch[1], 10) : 1;\n      while (i < lines.length && lines[i].match(/^\\d+\\.\\s+/)) {\n        const itemContent = lines[i].replace(/^\\d+\\.\\s+/, \"\");\n        items.push({ runs: parseInlineMarkdown(itemContent) });\n        i++;\n      }\n      blocks.push({ type: \"ordered-list\", items, start });\n      continue;\n    }\n\n    if (line.startsWith(\"> \")) {\n      const quoteLines: string[] = [];\n      while (i < lines.length && lines[i].startsWith(\"> \")) {\n        quoteLines.push(lines[i].replace(/^>\\s*/, \"\"));\n        i++;\n      }\n      blocks.push({\n        type: \"blockquote\",\n        runs: parseInlineMarkdown(quoteLines.join(\" \")),\n      });\n      continue;\n    }\n\n    if (line.match(/^[-*_]{3,}$/)) {\n      blocks.push({ type: \"horizontal-rule\" });\n      i++;\n      continue;\n    }\n\n    if (line.includes(\"|\") && lines[i + 1]?.match(/^\\|?[\\s:|-]+\\|?$/)) {\n      const tableBlock = parseMarkdownTable(lines, i);\n      if (tableBlock) {\n        blocks.push(tableBlock.block);\n        i = tableBlock.endIndex;\n        continue;\n      }\n    }\n\n    const paragraphLines: string[] = [];\n    while (\n      i < lines.length &&\n      lines[i].trim() !== \"\" &&\n      !lines[i].match(/^#{1,6}\\s+/) &&\n      !lines[i].startsWith(\"```\") &&\n      !lines[i].match(/^[-*]\\s+/) &&\n      !lines[i].match(/^\\d+\\.\\s+/) &&\n      !lines[i].startsWith(\"> \") &&\n      !lines[i].match(/^[-*_]{3,}$/)\n    ) {\n      paragraphLines.push(lines[i]);\n      i++;\n    }\n    if (paragraphLines.length > 0) {\n      blocks.push({\n        type: \"paragraph\",\n        runs: parseInlineMarkdown(paragraphLines.join(\" \")),\n      });\n    }\n  }\n\n  return { blocks };\n}\n\nfunction parseMarkdownTable(\n  lines: string[],\n  startIndex: number\n): { block: TableBlock; endIndex: number } | null {\n  const headerLine = lines[startIndex];\n  const separatorLine = lines[startIndex + 1];\n\n  if (!separatorLine?.match(/^\\|?[\\s:|-]+\\|?$/)) {\n    return null;\n  }\n\n  const parseRow = (line: string) => {\n    return line\n      .split(\"|\")\n      .map((cell) => cell.trim())\n      .filter((cell, i, arr) => !(i === 0 && cell === \"\") && !(i === arr.length - 1 && cell === \"\"));\n  };\n\n  const headerCells = parseRow(headerLine);\n  const rows = [\n    {\n      cells: headerCells.map((cell) => ({\n        runs: parseInlineMarkdown(cell),\n        isHeader: true,\n      })),\n    },\n  ];\n\n  let i = startIndex + 2;\n  while (i < lines.length && lines[i].includes(\"|\")) {\n    const cells = parseRow(lines[i]);\n    rows.push({\n      cells: cells.map((cell) => ({\n        runs: parseInlineMarkdown(cell),\n      })),\n    });\n    i++;\n  }\n\n  return {\n    block: { type: \"table\", rows, hasHeader: true },\n    endIndex: i,\n  };\n}\n\nexport function parseInlineMarkdown(text: string): TextRun[] {\n  if (!text || typeof text !== \"string\") {\n    return text ? [{ text: String(text) }] : [];\n  }\n\n  const runs: TextRun[] = [];\n  let remaining = text;\n\n  const patterns: Array<{\n    regex: RegExp;\n    handler: (match: RegExpExecArray) => { run: TextRun; consumed: number };\n  }> = [\n    {\n      regex: /\\$\\$(.+?)\\$\\$/,\n      handler: (m) => ({\n        run: { text: m[1], style: { code: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /\\$(.+?)\\$/,\n      handler: (m) => ({\n        run: { text: m[1], style: { code: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /\\*\\*\\*(.+?)\\*\\*\\*/,\n      handler: (m) => ({\n        run: { text: m[1], style: { bold: true, italic: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /___(.+?)___/,\n      handler: (m) => ({\n        run: { text: m[1], style: { bold: true, italic: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /\\*\\*(.+?)\\*\\*/,\n      handler: (m) => ({\n        run: { text: m[1], style: { bold: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /__(.+?)__/,\n      handler: (m) => ({\n        run: { text: m[1], style: { bold: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /\\*(.+?)\\*/,\n      handler: (m) => ({\n        run: { text: m[1], style: { italic: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /_(.+?)_/,\n      handler: (m) => ({\n        run: { text: m[1], style: { italic: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /~~(.+?)~~/,\n      handler: (m) => ({\n        run: { text: m[1], style: { strikethrough: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /<u>(.+?)<\\/u>/i,\n      handler: (m) => ({\n        run: { text: m[1], style: { underline: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /<mark>(.+?)<\\/mark>/i,\n      handler: (m) => ({\n        run: { text: m[1], style: { backgroundColor: \"#ffff00\" } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /<span\\s+style=[\"']color:\\s*([^\"']+)[\"']>(.+?)<\\/span>/i,\n      handler: (m) => ({\n        run: { text: m[2], style: { color: m[1] } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /`(.+?)`/,\n      handler: (m) => ({\n        run: { text: m[1], style: { code: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /\\[([^\\]]+)\\]\\(([^)]+)\\)/,\n      handler: (m) => ({\n        run: { text: m[1], style: { link: m[2], underline: true, color: \"#0066cc\" } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /<strong>(.+?)<\\/strong>/i,\n      handler: (m) => ({\n        run: { text: m[1], style: { bold: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /<b>(.+?)<\\/b>/i,\n      handler: (m) => ({\n        run: { text: m[1], style: { bold: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /<em>(.+?)<\\/em>/i,\n      handler: (m) => ({\n        run: { text: m[1], style: { italic: true } },\n        consumed: m[0].length,\n      }),\n    },\n    {\n      regex: /<i>(.+?)<\\/i>/i,\n      handler: (m) => ({\n        run: { text: m[1], style: { italic: true } },\n        consumed: m[0].length,\n      }),\n    },\n  ];\n\n  while (remaining.length > 0) {\n    let earliestMatch: {\n      index: number;\n      pattern: (typeof patterns)[0];\n      match: RegExpExecArray;\n    } | null = null;\n\n    for (const pattern of patterns) {\n      pattern.regex.lastIndex = 0;\n      const match = pattern.regex.exec(remaining);\n      if (match && (earliestMatch === null || match.index < earliestMatch.index)) {\n        earliestMatch = { index: match.index, pattern, match };\n      }\n    }\n\n    if (earliestMatch === null) {\n      if (remaining.length > 0) {\n        runs.push({ text: remaining });\n      }\n      break;\n    }\n\n    if (earliestMatch.index > 0) {\n      runs.push({ text: remaining.slice(0, earliestMatch.index) });\n    }\n\n    const { run } = earliestMatch.pattern.handler(earliestMatch.match);\n    runs.push(run);\n    remaining = remaining.slice(earliestMatch.index + earliestMatch.match[0].length);\n  }\n\n  return normalizeRuns(runs.filter((r) => r.text.length > 0));\n}\n\nexport function parseHtmlToDocument(html: string): RichTextDocument {\n  const blocks: RichTextBlock[] = [];\n\n  const cleanHtml = html\n    .replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, \"\")\n    .replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, \"\")\n    .replace(/<!--[\\s\\S]*?-->/g, \"\");\n\n  const blockRegex = /<(h[1-6]|p|ul|ol|blockquote|pre|table|hr)[^>]*>([\\s\\S]*?)<\\/\\1>|<hr\\s*\\/?>/gi;\n  let match;\n\n  while ((match = blockRegex.exec(cleanHtml)) !== null) {\n    const tagName = match[1]?.toLowerCase();\n    const content = match[2] || \"\";\n\n    if (tagName?.startsWith(\"h\") && tagName.length === 2) {\n      const level = parseInt(tagName[1], 10) as 1 | 2 | 3 | 4 | 5 | 6;\n      blocks.push({\n        type: \"heading\",\n        level,\n        runs: parseHtmlInline(content),\n      });\n    } else if (tagName === \"p\") {\n      blocks.push({\n        type: \"paragraph\",\n        runs: parseHtmlInline(content),\n      });\n    } else if (tagName === \"ul\") {\n      const items = parseHtmlListItems(content);\n      blocks.push({ type: \"bullet-list\", items });\n    } else if (tagName === \"ol\") {\n      const items = parseHtmlListItems(content);\n      blocks.push({ type: \"ordered-list\", items });\n    } else if (tagName === \"blockquote\") {\n      blocks.push({\n        type: \"blockquote\",\n        runs: parseHtmlInline(content),\n      });\n    } else if (tagName === \"pre\") {\n      const codeMatch = content.match(/<code[^>]*(?:\\s+class=[\"']language-(\\w+)[\"'])?[^>]*>([\\s\\S]*?)<\\/code>/i);\n      blocks.push({\n        type: \"code-block\",\n        code: decodeHtmlEntities(codeMatch?.[2] || content),\n        language: codeMatch?.[1],\n      });\n    } else if (tagName === \"hr\" || match[0].match(/<hr/i)) {\n      blocks.push({ type: \"horizontal-rule\" });\n    }\n  }\n\n  if (blocks.length === 0 && cleanHtml.trim()) {\n    blocks.push({\n      type: \"paragraph\",\n      runs: parseHtmlInline(cleanHtml),\n    });\n  }\n\n  return { blocks };\n}\n\nfunction parseHtmlListItems(html: string): ListItem[] {\n  const items: ListItem[] = [];\n  const liRegex = /<li[^>]*>([\\s\\S]*?)<\\/li>/gi;\n  let match;\n\n  while ((match = liRegex.exec(html)) !== null) {\n    items.push({ runs: parseHtmlInline(match[1]) });\n  }\n\n  return items;\n}\n\nfunction parseHtmlInline(html: string): TextRun[] {\n  const runs: TextRun[] = [];\n\n  const patterns: Array<{\n    regex: RegExp;\n    handler: (match: RegExpExecArray) => TextRun;\n  }> = [\n    {\n      regex: /<strong[^>]*>([\\s\\S]*?)<\\/strong>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { bold: true } }),\n    },\n    {\n      regex: /<b[^>]*>([\\s\\S]*?)<\\/b>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { bold: true } }),\n    },\n    {\n      regex: /<em[^>]*>([\\s\\S]*?)<\\/em>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { italic: true } }),\n    },\n    {\n      regex: /<i[^>]*>([\\s\\S]*?)<\\/i>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { italic: true } }),\n    },\n    {\n      regex: /<u[^>]*>([\\s\\S]*?)<\\/u>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { underline: true } }),\n    },\n    {\n      regex: /<s[^>]*>([\\s\\S]*?)<\\/s>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { strikethrough: true } }),\n    },\n    {\n      regex: /<del[^>]*>([\\s\\S]*?)<\\/del>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { strikethrough: true } }),\n    },\n    {\n      regex: /<code[^>]*>([\\s\\S]*?)<\\/code>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { code: true } }),\n    },\n    {\n      regex: /<mark[^>]*>([\\s\\S]*?)<\\/mark>/i,\n      handler: (m) => ({ text: stripTags(m[1]), style: { backgroundColor: \"#ffff00\" } }),\n    },\n    {\n      regex: /<a\\s+href=[\"']([^\"']+)[\"'][^>]*>([\\s\\S]*?)<\\/a>/i,\n      handler: (m) => ({\n        text: stripTags(m[2]),\n        style: { link: m[1], underline: true, color: \"#0066cc\" },\n      }),\n    },\n    {\n      regex: /<span[^>]*style=[\"'][^\"']*color:\\s*([^;\"']+)[^\"']*[\"'][^>]*>([\\s\\S]*?)<\\/span>/i,\n      handler: (m) => ({ text: stripTags(m[2]), style: { color: m[1].trim() } }),\n    },\n  ];\n\n  let remaining = html;\n\n  while (remaining.length > 0) {\n    let earliestMatch: {\n      index: number;\n      pattern: (typeof patterns)[0];\n      match: RegExpExecArray;\n    } | null = null;\n\n    for (const pattern of patterns) {\n      pattern.regex.lastIndex = 0;\n      const match = pattern.regex.exec(remaining);\n      if (match && (earliestMatch === null || match.index < earliestMatch.index)) {\n        earliestMatch = { index: match.index, pattern, match };\n      }\n    }\n\n    if (earliestMatch === null) {\n      const text = stripTags(remaining);\n      if (text.length > 0) {\n        runs.push({ text: decodeHtmlEntities(text) });\n      }\n      break;\n    }\n\n    if (earliestMatch.index > 0) {\n      const text = stripTags(remaining.slice(0, earliestMatch.index));\n      if (text.length > 0) {\n        runs.push({ text: decodeHtmlEntities(text) });\n      }\n    }\n\n    const run = earliestMatch.pattern.handler(earliestMatch.match);\n    run.text = decodeHtmlEntities(run.text);\n    runs.push(run);\n    remaining = remaining.slice(earliestMatch.index + earliestMatch.match[0].length);\n  }\n\n  return normalizeRuns(runs.filter((r) => r.text.length > 0));\n}\n\nfunction stripTags(html: string): string {\n  return html.replace(/<[^>]+>/g, \"\");\n}\n\nfunction decodeHtmlEntities(text: string): string {\n  return text\n    .replace(/&amp;/g, \"&\")\n    .replace(/&lt;/g, \"<\")\n    .replace(/&gt;/g, \">\")\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/&nbsp;/g, \" \");\n}\n\nexport function detectDocumentType(\n  content: string\n): \"cv\" | \"letter\" | \"report\" | \"article\" | \"contract\" | \"generic\" {\n  const lowerContent = content.toLowerCase();\n\n  const cvIndicators = [\n    \"experience\",\n    \"education\",\n    \"skills\",\n    \"work history\",\n    \"employment\",\n    \"resume\",\n    \"curriculum\",\n    \"cv\",\n    \"experiencia\",\n    \"educación\",\n    \"habilidades\",\n  ];\n  const letterIndicators = [\n    \"dear\",\n    \"sincerely\",\n    \"regards\",\n    \"yours truly\",\n    \"to whom it may concern\",\n    \"estimado\",\n    \"atentamente\",\n    \"cordialmente\",\n  ];\n  const reportIndicators = [\n    \"executive summary\",\n    \"introduction\",\n    \"methodology\",\n    \"findings\",\n    \"conclusion\",\n    \"recommendations\",\n    \"analysis\",\n    \"resumen ejecutivo\",\n    \"introducción\",\n    \"metodología\",\n  ];\n  const contractIndicators = [\n    \"agreement\",\n    \"parties\",\n    \"terms and conditions\",\n    \"whereas\",\n    \"hereby\",\n    \"obligations\",\n    \"contrato\",\n    \"partes\",\n    \"términos y condiciones\",\n  ];\n  const articleIndicators = [\"abstract\", \"keywords\", \"references\", \"bibliography\"];\n\n  const countMatches = (indicators: string[]) =>\n    indicators.filter((ind) => lowerContent.includes(ind)).length;\n\n  const scores = {\n    cv: countMatches(cvIndicators),\n    letter: countMatches(letterIndicators),\n    report: countMatches(reportIndicators),\n    contract: countMatches(contractIndicators),\n    article: countMatches(articleIndicators),\n  };\n\n  const maxScore = Math.max(...Object.values(scores));\n  if (maxScore === 0) return \"generic\";\n\n  const type = (Object.entries(scores).find(([, score]) => score === maxScore)?.[0] ||\n    \"generic\") as keyof typeof scores;\n  return type;\n}\n","path":null,"size_bytes":16252,"size_tokens":null},"client/src/components/recording-panel.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tooltip, TooltipTrigger, TooltipContent } from \"@/components/ui/tooltip\";\nimport { Trash2, Pause, Play, ArrowUp, Mic, Square, AudioLines } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface RecordingPanelProps {\n  isRecording: boolean;\n  isPaused: boolean;\n  recordingTime: number;\n  canSend: boolean;\n  onDiscard: () => void;\n  onPause: () => void;\n  onResume: () => void;\n  onSend: () => void;\n  onToggleRecording: () => void;\n  onOpenVoiceChat: () => void;\n  onStopChat: () => void;\n  onSubmit: () => void;\n  aiState: \"idle\" | \"thinking\" | \"responding\";\n  hasContent: boolean;\n}\n\nfunction formatRecordingTime(seconds: number): string {\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}\n\nexport function RecordingPanel({\n  isRecording,\n  isPaused,\n  recordingTime,\n  canSend,\n  onDiscard,\n  onPause,\n  onResume,\n  onSend,\n  onToggleRecording,\n  onOpenVoiceChat,\n  onStopChat,\n  onSubmit,\n  aiState,\n  hasContent,\n}: RecordingPanelProps) {\n  if (isRecording) {\n    return (\n      <motion.div\n        initial={{ opacity: 0, scale: 0.9 }}\n        animate={{ opacity: 1, scale: 1 }}\n        exit={{ opacity: 0, scale: 0.9 }}\n        className=\"flex items-center gap-3 px-2\"\n        data-testid=\"recording-ui-compact\"\n      >\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={onDiscard}\n              className=\"h-10 w-10 rounded-full border-2 border-muted-foreground/30 hover:border-red-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-950/30 transition-all\"\n              data-testid=\"button-discard-recording\"\n            >\n              <Trash2 className=\"h-5 w-5\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>Descartar grabación</TooltipContent>\n        </Tooltip>\n\n        <div className=\"flex items-center gap-2\">\n          <motion.div\n            animate={isPaused ? {} : { scale: [1, 1.2, 1] }}\n            transition={{ duration: 1, repeat: Infinity }}\n            className={cn(\n              \"w-2.5 h-2.5 rounded-full\",\n              isPaused ? \"bg-muted-foreground\" : \"bg-red-500\"\n            )}\n          />\n          \n          <span className=\"text-lg font-medium tabular-nums min-w-[48px]\" data-testid=\"recording-timer\">\n            {formatRecordingTime(recordingTime)}\n          </span>\n\n          <div className=\"flex items-center gap-0.5 h-6\">\n            {Array.from({ length: 20 }).map((_, i) => (\n              <motion.div\n                key={i}\n                animate={isPaused ? { height: 4 } : { \n                  height: [4, 8 + Math.random() * 12, 4, 12 + Math.random() * 8, 4]\n                }}\n                transition={{\n                  duration: 0.5 + Math.random() * 0.3,\n                  repeat: Infinity,\n                  delay: i * 0.05\n                }}\n                className=\"w-0.5 bg-muted-foreground/60 rounded-full\"\n                style={{ height: isPaused ? 4 : undefined }}\n              />\n            ))}\n          </div>\n        </div>\n\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={isPaused ? onResume : onPause}\n              className=\"h-10 w-10 rounded-full border-2 border-muted-foreground/30 hover:border-foreground/50 transition-all\"\n              data-testid={isPaused ? \"button-resume-recording\" : \"button-pause-recording\"}\n            >\n              {isPaused ? (\n                <Play className=\"h-5 w-5\" />\n              ) : (\n                <Pause className=\"h-5 w-5\" />\n              )}\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>{isPaused ? \"Continuar\" : \"Pausar\"}</TooltipContent>\n        </Tooltip>\n\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              size=\"icon\"\n              onClick={onSend}\n              disabled={!canSend}\n              className=\"h-10 w-10 rounded-full border-2 border-muted-foreground/30 hover:border-foreground/50 bg-transparent hover:bg-muted text-foreground disabled:opacity-50 transition-all\"\n              data-testid=\"button-send-recording\"\n            >\n              <ArrowUp className=\"h-5 w-5\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>Enviar mensaje</TooltipContent>\n        </Tooltip>\n      </motion.div>\n    );\n  }\n\n  return (\n    <>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button \n            variant=\"ghost\"\n            onClick={onToggleRecording}\n            size=\"icon\" \n            className=\"h-9 w-9 rounded-full transition-all duration-300 text-muted-foreground hover:text-foreground hover:bg-muted\"\n            data-testid=\"button-voice-dictation\"\n          >\n            <Mic className=\"h-5 w-5\" />\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>Dictar texto</TooltipContent>\n      </Tooltip>\n\n      {aiState !== \"idle\" ? (\n        <Button \n          onClick={onStopChat}\n          size=\"icon\" \n          className=\"h-10 w-10 rounded-full bg-red-500 hover:bg-red-600 text-white animate-pulse shadow-lg shadow-red-500/50\"\n          data-testid=\"button-stop-chat\"\n        >\n          <Square className=\"h-5 w-5 fill-current\" />\n        </Button>\n      ) : hasContent ? (\n        <motion.div\n          initial={{ scale: 0.8, opacity: 0 }}\n          animate={{ scale: 1, opacity: 1 }}\n          exit={{ scale: 0.8, opacity: 0 }}\n          transition={{ duration: 0.2, ease: \"easeOut\" }}\n          key=\"send-button\"\n        >\n          <Button \n            onClick={onSubmit}\n            size=\"icon\" \n            className=\"h-9 w-9 rounded-full transition-all duration-300 liquid-btn\"\n            data-testid=\"button-send-message\"\n          >\n            <ArrowUp className=\"h-5 w-5\" />\n          </Button>\n        </motion.div>\n      ) : (\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button \n              onClick={onOpenVoiceChat}\n              size=\"icon\" \n              className=\"h-9 w-9 rounded-full transition-all duration-300 bg-foreground text-background hover:bg-foreground/90\"\n              data-testid=\"button-voice-chat-mode\"\n            >\n              <AudioLines className=\"h-5 w-5\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>Modo conversación por voz</TooltipContent>\n        </Tooltip>\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":6597,"size_tokens":null},"client/src/components/message-list.tsx":{"content":"import React, { memo } from \"react\";\nimport {\n  CheckCircle2,\n  Loader2,\n  MoreHorizontal,\n  X,\n  RefreshCw,\n  Copy,\n  Pencil,\n  Send,\n  ThumbsUp,\n  ThumbsDown,\n  Share2,\n  Volume2,\n  VolumeX,\n  Flag,\n  MessageSquare,\n  Download,\n  FileText,\n  FileSpreadsheet,\n  FileIcon,\n  Image as ImageIcon\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger\n} from \"@/components/ui/tooltip\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger\n} from \"@/components/ui/dropdown-menu\";\nimport { motion } from \"framer-motion\";\n\nimport { Message, storeGeneratedImage, getGeneratedImage } from \"@/hooks/use-chats\";\nimport { MarkdownRenderer } from \"@/components/markdown-renderer\";\nimport { FigmaBlock } from \"@/components/figma-block\";\nimport { CodeExecutionBlock } from \"@/components/code-execution-block\";\nimport { getFileTheme, getFileCategory } from \"@/lib/fileTypeTheme\";\n\ninterface DocumentBlock {\n  type: \"word\" | \"excel\" | \"ppt\";\n  title: string;\n  content: string;\n}\n\nconst extractTextFromChildren = (children: React.ReactNode): string => {\n  if (typeof children === \"string\") return children;\n  if (typeof children === \"number\") return String(children);\n  if (!children) return \"\";\n  if (Array.isArray(children)) {\n    return children.map(extractTextFromChildren).join(\"\");\n  }\n  if (React.isValidElement(children)) {\n    return extractTextFromChildren((children.props as any)?.children);\n  }\n  const childArray = React.Children.toArray(children);\n  return childArray.map(extractTextFromChildren).join(\"\");\n};\n\nconst isNumericValue = (text: string): boolean => {\n  if (!text || typeof text !== \"string\") return false;\n  const cleaned = text.trim().replace(/[$€£¥%,\\s]/g, \"\");\n  return (\n    !isNaN(parseFloat(cleaned)) &&\n    isFinite(Number(cleaned)) &&\n    cleaned.length > 0\n  );\n};\n\nconst CleanDataTableComponents = {\n  table: ({ children }: { children?: React.ReactNode }) => (\n    <div className=\"my-4 overflow-x-auto\">\n      <table className=\"min-w-full border-collapse border border-border text-sm\">\n        {children}\n      </table>\n    </div>\n  ),\n  thead: ({ children }: { children?: React.ReactNode }) => (\n    <thead className=\"bg-muted/50\">{children}</thead>\n  ),\n  tbody: ({ children }: { children?: React.ReactNode }) => (\n    <tbody>{children}</tbody>\n  ),\n  tr: ({ children }: { children?: React.ReactNode }) => (\n    <tr className=\"border-b border-border\">{children}</tr>\n  ),\n  th: ({ children }: { children?: React.ReactNode }) => {\n    const text = extractTextFromChildren(children);\n    const isNumeric = isNumericValue(text);\n    return (\n      <th\n        scope=\"col\"\n        className={cn(\n          \"px-3 py-2 text-left font-semibold\",\n          isNumeric && \"text-right\"\n        )}\n      >\n        {children}\n      </th>\n    );\n  },\n  td: ({ children }: { children?: React.ReactNode }) => {\n    const text = extractTextFromChildren(children);\n    const isNumeric = isNumericValue(text);\n    const isLong = text.length > 50;\n    return (\n      <td\n        className={cn(\n          \"px-3 py-2\",\n          isNumeric && \"text-right\",\n          isLong && \"max-w-xs break-words\"\n        )}\n      >\n        {children}\n      </td>\n    );\n  }\n};\n\nconst parseDocumentBlocks = (\n  content: string\n): { text: string; documents: DocumentBlock[] } => {\n  const documents: DocumentBlock[] = [];\n  const regex = /```document\\s*\\n([\\s\\S]*?)```/g;\n  let match;\n  let cleanText = content;\n  const successfulBlocks: string[] = [];\n\n  while ((match = regex.exec(content)) !== null) {\n    try {\n      let jsonStr = match[1].trim();\n      jsonStr = jsonStr.replace(\n        /\"content\"\\s*:\\s*\"([\\s\\S]*?)\"\\s*\\}/,\n        (m, contentValue) => {\n          const fixedContent = contentValue\n            .replace(/\\n/g, \"\\\\n\")\n            .replace(/\\r/g, \"\\\\r\")\n            .replace(/\\t/g, \"\\\\t\");\n          return `\"content\": \"${fixedContent}\"}`;\n        }\n      );\n\n      const doc = JSON.parse(jsonStr);\n      if (doc.type && doc.title && doc.content) {\n        doc.content = doc.content\n          .replace(/\\\\n/g, \"\\n\")\n          .replace(/\\\\\\\\n/g, \"\\n\");\n        documents.push(doc as DocumentBlock);\n        successfulBlocks.push(match[0]);\n      }\n    } catch (e) {\n      try {\n        const blockContent = match[1];\n        const typeMatch = blockContent.match(\n          /\"type\"\\s*:\\s*\"(word|excel|ppt)\"/\n        );\n        const titleMatch = blockContent.match(/\"title\"\\s*:\\s*\"([^\"]+)\"/);\n        const contentMatch = blockContent.match(\n          /\"content\"\\s*:\\s*\"([\\s\\S]*?)\"\\s*\\}?\\s*$/\n        );\n\n        if (typeMatch && titleMatch && contentMatch) {\n          documents.push({\n            type: typeMatch[1] as \"word\" | \"excel\" | \"ppt\",\n            title: titleMatch[1],\n            content: contentMatch[1]\n              .replace(/\\\\n/g, \"\\n\")\n              .replace(/\\\\\\\\n/g, \"\\n\")\n          });\n          successfulBlocks.push(match[0]);\n        }\n      } catch (fallbackError) {\n        console.error(\"Fallback parsing also failed:\", fallbackError);\n      }\n    }\n  }\n\n  for (const block of successfulBlocks) {\n    cleanText = cleanText.replace(block, \"\").trim();\n  }\n\n  return { text: cleanText, documents };\n};\n\nconst extractCodeBlocks = (\n  content: string\n): { type: \"text\" | \"python\"; content: string }[] => {\n  const pythonBlockRegex = /```(?:python|py)\\n([\\s\\S]*?)```/g;\n  const blocks: { type: \"text\" | \"python\"; content: string }[] = [];\n  let lastIndex = 0;\n  let match;\n\n  while ((match = pythonBlockRegex.exec(content)) !== null) {\n    if (match.index > lastIndex) {\n      blocks.push({\n        type: \"text\",\n        content: content.slice(lastIndex, match.index)\n      });\n    }\n    blocks.push({ type: \"python\", content: match[1] });\n    lastIndex = match.index + match[0].length;\n  }\n\n  if (lastIndex < content.length) {\n    blocks.push({ type: \"text\", content: content.slice(lastIndex) });\n  }\n\n  return blocks.length > 0 ? blocks : [{ type: \"text\" as const, content }];\n};\n\ninterface AttachmentListProps {\n  attachments: Message[\"attachments\"];\n  variant: \"compact\" | \"default\";\n  onOpenPreview?: (attachment: NonNullable<Message[\"attachments\"]>[0]) => void;\n}\n\nconst AttachmentList = memo(function AttachmentList({\n  attachments,\n  variant,\n  onOpenPreview\n}: AttachmentListProps) {\n  if (!attachments || attachments.length === 0) return null;\n\n  return (\n    <div\n      className={cn(\n        \"flex flex-wrap gap-2\",\n        variant === \"default\" && \"mb-2 justify-end\"\n      )}\n    >\n      {attachments.map((att, i) =>\n        att.type === \"image\" && att.imageUrl ? (\n          <div\n            key={i}\n            className={cn(\n              \"relative rounded-xl overflow-hidden border border-border\",\n              variant === \"default\" && \"max-w-[280px] cursor-pointer hover:opacity-90 transition-opacity\"\n            )}\n            onClick={() => onOpenPreview?.(att)}\n            data-testid={`attachment-image-${i}`}\n          >\n            <img\n              src={att.imageUrl}\n              alt={att.name}\n              className=\"w-full h-auto max-h-[200px] object-cover\"\n            />\n          </div>\n        ) : (\n          (() => {\n            const attTheme = getFileTheme(att.name, att.mimeType);\n            return (\n              <div\n                key={i}\n                className={cn(\n                  \"flex items-center gap-2 px-3 py-2 rounded-xl text-sm border bg-card border-border\",\n                  variant === \"default\" && \"cursor-pointer hover:bg-accent transition-colors\"\n                )}\n                onClick={() => onOpenPreview?.(att)}\n                data-testid={`attachment-file-${i}`}\n              >\n                <div\n                  className={cn(\n                    \"flex items-center justify-center w-8 h-8 rounded-lg\",\n                    attTheme.bgColor\n                  )}\n                >\n                  <span className=\"text-white text-xs font-bold\">\n                    {attTheme.icon}\n                  </span>\n                </div>\n                <span className=\"max-w-[200px] truncate font-medium\">\n                  {att.name}\n                </span>\n              </div>\n            );\n          })()\n        )\n      )}\n    </div>\n  );\n});\n\ninterface ActionToolbarProps {\n  messageId: string;\n  content: string;\n  msgIndex: number;\n  copiedMessageId: string | null;\n  messageFeedback: Record<string, \"up\" | \"down\">;\n  speakingMessageId: string | null;\n  aiState: \"idle\" | \"thinking\" | \"responding\";\n  variant: \"compact\" | \"default\";\n  onCopy: (content: string, id: string) => void;\n  onFeedback: (id: string, type: \"up\" | \"down\") => void;\n  onRegenerate: (index: number) => void;\n  onShare: (content: string) => void;\n  onReadAloud: (id: string, content: string) => void;\n}\n\nconst ActionToolbar = memo(function ActionToolbar({\n  messageId,\n  content,\n  msgIndex,\n  copiedMessageId,\n  messageFeedback,\n  speakingMessageId,\n  aiState,\n  variant,\n  onCopy,\n  onFeedback,\n  onRegenerate,\n  onShare,\n  onReadAloud\n}: ActionToolbarProps) {\n  const testIdSuffix = variant === \"compact\" ? messageId : `main-${messageId}`;\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div\n        className=\"flex items-center gap-1 mt-2\"\n        data-testid={`message-actions-${testIdSuffix}`}\n      >\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-7 w-7 text-muted-foreground hover:text-foreground\"\n              onClick={() => onCopy(content, messageId)}\n              data-testid={`button-copy-${testIdSuffix}`}\n            >\n              {copiedMessageId === messageId ? (\n                <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n              ) : (\n                <Copy className=\"h-4 w-4\" />\n              )}\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent side=\"bottom\">\n            <p>Copiar</p>\n          </TooltipContent>\n        </Tooltip>\n\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className={cn(\n                \"h-7 w-7\",\n                messageFeedback[messageId] === \"up\"\n                  ? \"text-green-500\"\n                  : \"text-muted-foreground hover:text-foreground\"\n              )}\n              onClick={() => onFeedback(messageId, \"up\")}\n              data-testid={`button-like-${testIdSuffix}`}\n            >\n              <ThumbsUp className=\"h-4 w-4\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent side=\"bottom\">\n            <p>Me gusta</p>\n          </TooltipContent>\n        </Tooltip>\n\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className={cn(\n                \"h-7 w-7\",\n                messageFeedback[messageId] === \"down\"\n                  ? \"text-red-500\"\n                  : \"text-muted-foreground hover:text-foreground\"\n              )}\n              onClick={() => onFeedback(messageId, \"down\")}\n              data-testid={`button-dislike-${testIdSuffix}`}\n            >\n              <ThumbsDown className=\"h-4 w-4\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent side=\"bottom\">\n            <p>No me gusta</p>\n          </TooltipContent>\n        </Tooltip>\n\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-7 w-7 text-muted-foreground hover:text-foreground\"\n              onClick={() => onRegenerate(msgIndex)}\n              disabled={aiState !== \"idle\"}\n              data-testid={`button-regenerate-${testIdSuffix}`}\n            >\n              <RefreshCw\n                className={cn(\"h-4 w-4\", aiState !== \"idle\" && \"animate-spin\")}\n              />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent side=\"bottom\">\n            <p>Regenerar</p>\n          </TooltipContent>\n        </Tooltip>\n\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-7 w-7 text-muted-foreground hover:text-foreground\"\n              onClick={() => onShare(content)}\n              data-testid={`button-share-${testIdSuffix}`}\n            >\n              <Share2 className=\"h-4 w-4\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent side=\"bottom\">\n            <p>Compartir</p>\n          </TooltipContent>\n        </Tooltip>\n\n        <DropdownMenu>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-7 w-7 text-muted-foreground hover:text-foreground\"\n                  data-testid={`button-more-${testIdSuffix}`}\n                >\n                  <MoreHorizontal className=\"h-4 w-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n            </TooltipTrigger>\n            <TooltipContent side=\"bottom\">\n              <p>Más opciones</p>\n            </TooltipContent>\n          </Tooltip>\n          <DropdownMenuContent align=\"start\" side=\"bottom\">\n            <DropdownMenuItem\n              onClick={() => onReadAloud(messageId, content)}\n              data-testid={`menu-read-aloud-${testIdSuffix}`}\n            >\n              {speakingMessageId === messageId ? (\n                <VolumeX className=\"h-4 w-4 mr-2\" />\n              ) : (\n                <Volume2 className=\"h-4 w-4 mr-2\" />\n              )}\n              {speakingMessageId === messageId\n                ? \"Detener lectura\"\n                : \"Leer en voz alta\"}\n            </DropdownMenuItem>\n            <DropdownMenuItem data-testid={`menu-create-thread-${testIdSuffix}`}>\n              <MessageSquare className=\"h-4 w-4 mr-2\" />\n              Crear hilo desde aquí\n            </DropdownMenuItem>\n            <DropdownMenuItem\n              className=\"text-red-500\"\n              data-testid={`menu-report-${testIdSuffix}`}\n            >\n              <Flag className=\"h-4 w-4 mr-2\" />\n              Reportar mensaje\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n    </TooltipProvider>\n  );\n});\n\ninterface UserMessageProps {\n  message: Message;\n  variant: \"compact\" | \"default\";\n  isEditing: boolean;\n  editContent: string;\n  copiedMessageId: string | null;\n  onEditContentChange: (value: string) => void;\n  onCancelEdit: () => void;\n  onSendEdit: (id: string) => void;\n  onCopyMessage: (content: string, id: string) => void;\n  onStartEdit: (msg: Message) => void;\n  onOpenPreview?: (attachment: NonNullable<Message[\"attachments\"]>[0]) => void;\n}\n\nconst UserMessage = memo(function UserMessage({\n  message,\n  variant,\n  isEditing,\n  editContent,\n  copiedMessageId,\n  onEditContentChange,\n  onCancelEdit,\n  onSendEdit,\n  onCopyMessage,\n  onStartEdit,\n  onOpenPreview\n}: UserMessageProps) {\n  if (variant === \"compact\") {\n    return (\n      <div className=\"bg-primary/10 text-primary-foreground px-3 py-2 rounded-lg max-w-full text-sm\">\n        <span className=\"text-muted-foreground mr-1 font-medium\">\n          Instrucción:\n        </span>\n        <span className=\"text-foreground\">{message.content}</span>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col items-end gap-1\">\n      {isEditing ? (\n        <div className=\"w-full min-w-[300px] max-w-[500px]\">\n          <Textarea\n            value={editContent}\n            onChange={(e) => onEditContentChange(e.target.value)}\n            className=\"w-full px-4 py-3 text-sm min-h-[80px] resize-y rounded-2xl border border-border bg-card focus:border-primary focus:ring-1 focus:ring-primary\"\n            autoFocus\n          />\n          <div className=\"flex items-center justify-end gap-2 mt-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-8 px-3 text-sm text-muted-foreground hover:text-foreground\"\n              onClick={onCancelEdit}\n            >\n              <X className=\"h-4 w-4 mr-1\" />\n              Cancelar\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-8 px-3 text-sm text-muted-foreground hover:text-foreground\"\n              onClick={() => onSendEdit(message.id)}\n            >\n              <Send className=\"h-4 w-4 mr-1\" />\n              Enviar\n            </Button>\n          </div>\n        </div>\n      ) : (\n        <div className=\"group\">\n          <AttachmentList\n            attachments={message.attachments}\n            variant={variant}\n            onOpenPreview={onOpenPreview}\n          />\n          {message.content && (\n            <div className=\"liquid-message-user px-4 py-2.5 text-sm break-words leading-relaxed\">\n              {message.content}\n            </div>\n          )}\n          <div className=\"flex items-center justify-end gap-1 mt-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-6 w-6 text-muted-foreground hover:text-foreground\"\n              onClick={() => onCopyMessage(message.content, message.id)}\n              data-testid={`button-copy-user-${message.id}`}\n            >\n              {copiedMessageId === message.id ? (\n                <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n              ) : (\n                <Copy className=\"h-4 w-4\" />\n              )}\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-6 w-6 text-muted-foreground hover:text-foreground\"\n              onClick={() => onStartEdit(message)}\n              data-testid={`button-edit-user-${message.id}`}\n            >\n              <Pencil className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n});\n\ninterface AssistantMessageProps {\n  message: Message;\n  msgIndex: number;\n  totalMessages: number;\n  variant: \"compact\" | \"default\";\n  copiedMessageId: string | null;\n  messageFeedback: Record<string, \"up\" | \"down\">;\n  speakingMessageId: string | null;\n  aiState: \"idle\" | \"thinking\" | \"responding\";\n  isGeneratingImage: boolean;\n  pendingGeneratedImage: { messageId: string; imageData: string } | null;\n  latestGeneratedImageRef: React.RefObject<{ messageId: string; imageData: string } | null>;\n  onCopyMessage: (content: string, id: string) => void;\n  onFeedback: (id: string, type: \"up\" | \"down\") => void;\n  onRegenerate: (index: number) => void;\n  onShare: (content: string) => void;\n  onReadAloud: (id: string, content: string) => void;\n  onOpenDocumentPreview: (doc: DocumentBlock) => void;\n  onDownloadImage: (imageData: string) => void;\n  onOpenLightbox: (imageData: string) => void;\n}\n\nconst AssistantMessage = memo(function AssistantMessage({\n  message,\n  msgIndex,\n  totalMessages,\n  variant,\n  copiedMessageId,\n  messageFeedback,\n  speakingMessageId,\n  aiState,\n  isGeneratingImage,\n  pendingGeneratedImage,\n  latestGeneratedImageRef,\n  onCopyMessage,\n  onFeedback,\n  onRegenerate,\n  onShare,\n  onReadAloud,\n  onOpenDocumentPreview,\n  onDownloadImage,\n  onOpenLightbox\n}: AssistantMessageProps) {\n  if (variant === \"compact\") {\n    return (\n      <div className=\"bg-green-500/10 text-green-700 dark:text-green-400 px-3 py-1.5 rounded-lg max-w-[90%] text-xs flex items-center gap-1\">\n        <CheckCircle2 className=\"h-3 w-3\" />\n        <span>{message.content}</span>\n      </div>\n    );\n  }\n\n  const { text, documents } = parseDocumentBlocks(message.content);\n  const contentBlocks = extractCodeBlocks(text || \"\");\n\n  const msgImage = message.generatedImage;\n  const storeImage = getGeneratedImage(message.id);\n  const pendingMatch =\n    pendingGeneratedImage?.messageId === message.id\n      ? pendingGeneratedImage.imageData\n      : null;\n  const refMatch =\n    latestGeneratedImageRef.current?.messageId === message.id\n      ? latestGeneratedImageRef.current.imageData\n      : null;\n\n  let imageData = msgImage || storeImage || pendingMatch || refMatch;\n\n  if (imageData && !storeImage) {\n    storeGeneratedImage(message.id, imageData);\n  }\n\n  const showSkeleton =\n    isGeneratingImage &&\n    message.role === \"assistant\" &&\n    msgIndex === totalMessages - 1 &&\n    !imageData;\n\n  return (\n    <div className=\"flex flex-col gap-2 w-full min-w-0\">\n      {message.isThinking && message.steps && (\n        <div className=\"rounded-lg border bg-card p-4 space-y-3 w-full animate-in fade-in slide-in-from-bottom-2\">\n          <div className=\"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2\">\n            <Loader2 className=\"h-3 w-3 animate-spin\" />\n            Processing Goal\n          </div>\n          {message.steps.map((step, idx) => (\n            <div key={idx} className=\"flex items-center gap-3 text-sm\">\n              {step.status === \"complete\" ? (\n                <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n              ) : step.status === \"loading\" ? (\n                <Loader2 className=\"h-4 w-4 animate-spin text-blue-500\" />\n              ) : (\n                <div className=\"h-4 w-4 rounded-full border border-muted-foreground/30\" />\n              )}\n              <span\n                className={cn(\n                  step.status === \"pending\" && \"text-muted-foreground\",\n                  step.status === \"loading\" && \"text-foreground font-medium\",\n                  step.status === \"complete\" &&\n                    \"text-muted-foreground line-through\"\n                )}\n              >\n                {step.title}\n              </span>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {message.content && !message.isThinking && (\n        <>\n          {contentBlocks.map((block, blockIdx) =>\n            block.type === \"python\" ? (\n              <div key={blockIdx} className=\"my-2\">\n                <CodeExecutionBlock\n                  code={block.content.trim()}\n                  language=\"python\"\n                />\n              </div>\n            ) : block.content.trim() ? (\n              <div\n                key={blockIdx}\n                className=\"text-sm prose prose-sm dark:prose-invert max-w-none leading-relaxed min-w-0\"\n              >\n                <MarkdownRenderer\n                  content={block.content}\n                  customComponents={{ ...CleanDataTableComponents }}\n                />\n              </div>\n            ) : null\n          )}\n          {documents.length > 0 && (\n            <div className=\"flex gap-2 flex-wrap mt-3\">\n              {documents.map((doc, idx) => (\n                <Button\n                  key={idx}\n                  variant=\"outline\"\n                  className=\"flex items-center gap-2 px-4 py-2 h-auto\"\n                  onClick={() => onOpenDocumentPreview(doc)}\n                >\n                  {doc.type === \"word\" && (\n                    <FileText className=\"h-5 w-5 text-blue-600\" />\n                  )}\n                  {doc.type === \"excel\" && (\n                    <FileSpreadsheet className=\"h-5 w-5 text-green-600\" />\n                  )}\n                  {doc.type === \"ppt\" && (\n                    <FileIcon className=\"h-5 w-5 text-orange-600\" />\n                  )}\n                  <span className=\"text-sm font-medium\">{doc.title}</span>\n                </Button>\n              ))}\n            </div>\n          )}\n        </>\n      )}\n\n      {showSkeleton && (\n        <div className=\"mt-3\">\n          <div className=\"w-64 h-64 bg-muted rounded-lg animate-pulse flex items-center justify-center\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n        </div>\n      )}\n\n      {imageData && (\n        <div className=\"mt-3 relative group inline-block\">\n          <img\n            src={imageData}\n            alt=\"Imagen generada\"\n            className=\"max-w-full h-auto rounded-lg shadow-md cursor-pointer hover:opacity-95 transition-opacity\"\n            style={{ maxHeight: \"400px\" }}\n            onClick={() => onOpenLightbox(imageData)}\n            data-testid={`generated-image-${message.id}`}\n          />\n          <Button\n            variant=\"secondary\"\n            size=\"icon\"\n            className=\"absolute top-2 right-2 h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity bg-black/60 hover:bg-black/80 text-white\"\n            onClick={(e) => {\n              e.stopPropagation();\n              onDownloadImage(imageData);\n            }}\n            data-testid={`button-download-image-${message.id}`}\n          >\n            <Download className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      )}\n\n      {message.content && !message.isThinking && (\n        <ActionToolbar\n          messageId={message.id}\n          content={message.content}\n          msgIndex={msgIndex}\n          copiedMessageId={copiedMessageId}\n          messageFeedback={messageFeedback}\n          speakingMessageId={speakingMessageId}\n          aiState={aiState}\n          variant={variant}\n          onCopy={onCopyMessage}\n          onFeedback={onFeedback}\n          onRegenerate={onRegenerate}\n          onShare={onShare}\n          onReadAloud={onReadAloud}\n        />\n      )}\n\n      {message.figmaDiagram && (\n        <div className=\"mt-3 w-full\">\n          <FigmaBlock diagram={message.figmaDiagram} />\n        </div>\n      )}\n    </div>\n  );\n});\n\nexport interface MessageListProps {\n  messages: Message[];\n  variant: \"compact\" | \"default\";\n  editingMessageId: string | null;\n  editContent: string;\n  setEditContent: (value: string) => void;\n  copiedMessageId: string | null;\n  messageFeedback: Record<string, \"up\" | \"down\">;\n  speakingMessageId: string | null;\n  isGeneratingImage: boolean;\n  pendingGeneratedImage: { messageId: string; imageData: string } | null;\n  latestGeneratedImageRef: React.RefObject<{ messageId: string; imageData: string } | null>;\n  streamingContent: string;\n  aiState: \"idle\" | \"thinking\" | \"responding\";\n  handleCopyMessage: (content: string, id: string) => void;\n  handleStartEdit: (msg: Message) => void;\n  handleCancelEdit: () => void;\n  handleSendEdit: (id: string) => void;\n  handleFeedback: (id: string, type: \"up\" | \"down\") => void;\n  handleRegenerate: (index: number) => void;\n  handleShare: (content: string) => void;\n  handleReadAloud: (id: string, content: string) => void;\n  handleOpenDocumentPreview: (doc: DocumentBlock) => void;\n  handleOpenFileAttachmentPreview: (attachment: NonNullable<Message[\"attachments\"]>[0]) => void;\n  handleDownloadImage: (imageData: string) => void;\n  setLightboxImage: (imageData: string | null) => void;\n}\n\nexport function MessageList({\n  messages,\n  variant,\n  editingMessageId,\n  editContent,\n  setEditContent,\n  copiedMessageId,\n  messageFeedback,\n  speakingMessageId,\n  isGeneratingImage,\n  pendingGeneratedImage,\n  latestGeneratedImageRef,\n  streamingContent,\n  aiState,\n  handleCopyMessage,\n  handleStartEdit,\n  handleCancelEdit,\n  handleSendEdit,\n  handleFeedback,\n  handleRegenerate,\n  handleShare,\n  handleReadAloud,\n  handleOpenDocumentPreview,\n  handleOpenFileAttachmentPreview,\n  handleDownloadImage,\n  setLightboxImage\n}: MessageListProps) {\n  return (\n    <>\n      {messages.map((msg, msgIndex) => (\n        <div\n          key={msg.id}\n          className={cn(\n            \"flex\",\n            variant === \"compact\"\n              ? cn(\n                  \"gap-2 text-sm\",\n                  msg.role === \"user\" ? \"justify-end\" : \"justify-start\"\n                )\n              : cn(\n                  \"w-full max-w-3xl mx-auto gap-4\",\n                  msg.role === \"user\" ? \"justify-end\" : \"justify-start\"\n                )\n          )}\n        >\n          <div\n            className={cn(\n              \"flex flex-col gap-2\",\n              variant === \"default\" && \"max-w-[85%]\",\n              msg.role === \"user\" ? \"items-end\" : \"items-start\"\n            )}\n          >\n            {msg.role === \"user\" ? (\n              <UserMessage\n                message={msg}\n                variant={variant}\n                isEditing={editingMessageId === msg.id}\n                editContent={editContent}\n                copiedMessageId={copiedMessageId}\n                onEditContentChange={setEditContent}\n                onCancelEdit={handleCancelEdit}\n                onSendEdit={handleSendEdit}\n                onCopyMessage={handleCopyMessage}\n                onStartEdit={handleStartEdit}\n                onOpenPreview={handleOpenFileAttachmentPreview}\n              />\n            ) : (\n              <AssistantMessage\n                message={msg}\n                msgIndex={msgIndex}\n                totalMessages={messages.length}\n                variant={variant}\n                copiedMessageId={copiedMessageId}\n                messageFeedback={messageFeedback}\n                speakingMessageId={speakingMessageId}\n                aiState={aiState}\n                isGeneratingImage={isGeneratingImage}\n                pendingGeneratedImage={pendingGeneratedImage}\n                latestGeneratedImageRef={latestGeneratedImageRef}\n                onCopyMessage={handleCopyMessage}\n                onFeedback={handleFeedback}\n                onRegenerate={handleRegenerate}\n                onShare={handleShare}\n                onReadAloud={handleReadAloud}\n                onOpenDocumentPreview={handleOpenDocumentPreview}\n                onDownloadImage={handleDownloadImage}\n                onOpenLightbox={setLightboxImage}\n              />\n            )}\n          </div>\n        </div>\n      ))}\n\n      {streamingContent && variant === \"default\" && (\n        <div className=\"flex w-full max-w-3xl mx-auto gap-4 justify-start\">\n          <div className=\"flex flex-col gap-2 max-w-[85%] items-start min-w-0\">\n            <div className=\"text-sm prose prose-sm dark:prose-invert max-w-none leading-relaxed min-w-0\">\n              <MarkdownRenderer\n                content={streamingContent}\n                customComponents={{ ...CleanDataTableComponents }}\n              />\n              <span className=\"inline-block w-2 h-4 bg-primary/70 animate-pulse ml-0.5\" />\n            </div>\n          </div>\n        </div>\n      )}\n\n      {aiState !== \"idle\" && !streamingContent && variant === \"default\" && (\n        <motion.div\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"flex w-full max-w-3xl mx-auto gap-4 justify-start\"\n        >\n          <div className=\"flex items-center gap-3 py-3 px-4 text-sm text-muted-foreground bg-muted/30 rounded-lg\">\n            <div className=\"flex gap-1\">\n              <span\n                className=\"w-2 h-2 bg-primary rounded-full animate-bounce\"\n                style={{ animationDelay: \"0ms\" }}\n              />\n              <span\n                className=\"w-2 h-2 bg-primary rounded-full animate-bounce\"\n                style={{ animationDelay: \"150ms\" }}\n              />\n              <span\n                className=\"w-2 h-2 bg-primary rounded-full animate-bounce\"\n                style={{ animationDelay: \"300ms\" }}\n              />\n            </div>\n            <span className=\"font-medium\">\n              {aiState === \"thinking\" ? \"Pensando...\" : \"Escribiendo...\"}\n            </span>\n          </div>\n        </motion.div>\n      )}\n    </>\n  );\n}\n\nexport { CleanDataTableComponents, parseDocumentBlocks };\nexport type { DocumentBlock };\n","path":null,"size_bytes":31694,"size_tokens":null},"server/routes/figma.ts":{"content":"import { Router } from \"express\";\nimport { figmaService } from \"../services/figmaService\";\n\nexport const figmaRouter = Router();\n\nfigmaRouter.post(\"/connect\", async (req, res) => {\n  try {\n    const { accessToken } = req.body;\n    if (!accessToken) {\n      return res.status(400).json({ error: \"Access token is required\" });\n    }\n    \n    figmaService.setAccessToken(accessToken);\n    \n    try {\n      res.json({ success: true, message: \"Figma connected successfully\" });\n    } catch (error: any) {\n      res.status(401).json({ error: \"Invalid Figma access token\" });\n    }\n  } catch (error: any) {\n    console.error(\"Error connecting to Figma:\", error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\nfigmaRouter.get(\"/status\", (req, res) => {\n  const token = figmaService.getAccessToken();\n  res.json({ connected: !!token });\n});\n\nfigmaRouter.post(\"/disconnect\", (req, res) => {\n  figmaService.setAccessToken(\"\");\n  res.json({ success: true });\n});\n\nfigmaRouter.get(\"/file/:fileKey\", async (req, res) => {\n  try {\n    const { fileKey } = req.params;\n    const fileData = await figmaService.getFile(fileKey);\n    res.json(fileData);\n  } catch (error: any) {\n    console.error(\"Error fetching Figma file:\", error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\nfigmaRouter.get(\"/file/:fileKey/tokens\", async (req, res) => {\n  try {\n    const { fileKey } = req.params;\n    const fileData = await figmaService.getFile(fileKey);\n    const tokens = figmaService.extractDesignTokens(fileData);\n    res.json({ tokens });\n  } catch (error: any) {\n    console.error(\"Error extracting design tokens:\", error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\nfigmaRouter.post(\"/code\", async (req, res) => {\n  try {\n    const { fileKey, nodeId } = req.body;\n    if (!fileKey) {\n      return res.status(400).json({ error: \"File key is required\" });\n    }\n    \n    const codeContext = await figmaService.getDesignContext(fileKey, nodeId);\n    res.json(codeContext);\n  } catch (error: any) {\n    console.error(\"Error generating code from Figma:\", error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\nfigmaRouter.post(\"/parse-url\", (req, res) => {\n  try {\n    const { url } = req.body;\n    if (!url) {\n      return res.status(400).json({ error: \"URL is required\" });\n    }\n    \n    const parsed = figmaService.parseFileUrl(url);\n    if (!parsed) {\n      return res.status(400).json({ error: \"Invalid Figma URL\" });\n    }\n    \n    res.json(parsed);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\nfigmaRouter.get(\"/images/:fileKey\", async (req, res) => {\n  try {\n    const { fileKey } = req.params;\n    const { nodeIds, format = \"png\", scale = \"2\" } = req.query;\n    \n    if (!nodeIds || typeof nodeIds !== \"string\") {\n      return res.status(400).json({ error: \"Node IDs are required\" });\n    }\n    \n    const ids = nodeIds.split(\",\");\n    const images = await figmaService.getImages(\n      fileKey, \n      ids, \n      format as \"png\" | \"svg\" | \"jpg\",\n      parseInt(scale as string)\n    );\n    res.json({ images });\n  } catch (error: any) {\n    console.error(\"Error fetching Figma images:\", error);\n    res.status(500).json({ error: error.message });\n  }\n});\n","path":null,"size_bytes":3242,"size_tokens":null},"server/routes/sandbox.ts":{"content":"import { Router } from \"express\";\nimport * as codeInterpreter from \"../services/codeInterpreterService\";\nimport * as pistonService from \"../services/pistonService\";\n\nexport const sandboxRouter = Router();\n\nsandboxRouter.post(\"/code-interpreter/run\", async (req, res) => {\n  try {\n    const { code, conversationId, language } = req.body;\n    \n    if (!code || typeof code !== \"string\" || !code.trim()) {\n      return res.status(400).json({ error: \"Code is required\" });\n    }\n\n    const user = (req as any).user;\n    const userId = user?.claims?.sub;\n\n    const result = await codeInterpreter.executeCode(code, {\n      conversationId,\n      userId,\n      language: language || \"python\",\n    });\n\n    res.json({\n      run: result.run,\n      artifacts: result.artifacts,\n    });\n  } catch (error: any) {\n    console.error(\"Error executing code:\", error);\n    res.status(500).json({ error: \"Failed to execute code\" });\n  }\n});\n\nsandboxRouter.get(\"/code-interpreter/run/:id\", async (req, res) => {\n  try {\n    const run = await codeInterpreter.getRun(req.params.id);\n    if (!run) {\n      return res.status(404).json({ error: \"Run not found\" });\n    }\n    const artifacts = await codeInterpreter.getRunArtifacts(req.params.id);\n    res.json({ run, artifacts });\n  } catch (error: any) {\n    console.error(\"Error getting run:\", error);\n    res.status(500).json({ error: \"Failed to get run\" });\n  }\n});\n\nsandboxRouter.get(\"/sandbox/runtimes\", async (req, res) => {\n  try {\n    const runtimes = await pistonService.getSupportedRuntimes();\n    const languages = pistonService.getSupportedLanguages();\n    const aliases = pistonService.getLanguageAliases();\n    \n    res.json({\n      runtimes,\n      supportedLanguages: languages,\n      aliases,\n    });\n  } catch (error: any) {\n    console.error(\"Error fetching runtimes:\", error);\n    res.status(500).json({ error: \"Failed to fetch available runtimes\" });\n  }\n});\n\nsandboxRouter.post(\"/sandbox/execute\", async (req, res) => {\n  try {\n    const { code, language, stdin, args } = req.body;\n\n    if (!code || typeof code !== \"string\" || !code.trim()) {\n      return res.status(400).json({ error: \"Code is required\" });\n    }\n\n    if (!language || typeof language !== \"string\") {\n      return res.status(400).json({ error: \"Language is required\" });\n    }\n\n    const langInfo = await pistonService.getLanguageInfo(language);\n    if (!langInfo.supported) {\n      const supportedLangs = pistonService.getSupportedLanguages();\n      return res.status(400).json({\n        error: `Unsupported language: ${language}`,\n        supportedLanguages: supportedLangs,\n      });\n    }\n\n    const result = await pistonService.executeCode(\n      language,\n      code,\n      stdin,\n      args\n    );\n\n    res.json({\n      run: result.run,\n      compile: result.compile,\n      errorLines: result.errorLines,\n      language: result.language,\n      version: result.version,\n      usedFallback: result.usedFallback || false,\n      artifacts: result.artifacts || [],\n    });\n  } catch (error: any) {\n    console.error(\"Sandbox execution error:\", error);\n    res.status(500).json({\n      error: \"Failed to execute code\",\n      details: error.message,\n    });\n  }\n});\n","path":null,"size_bytes":3183,"size_tokens":null},"server/routes/documents.ts":{"content":"import { Router } from \"express\";\nimport { \n  generateWordDocument, \n  generateExcelDocument, \n  generatePptDocument,\n  parseExcelFromText,\n  parseSlidesFromText\n} from \"../services/documentGeneration\";\nimport { \n  DocumentRenderRequestSchema,\n  renderDocument,\n  getGeneratedDocument,\n  getTemplates,\n  getTemplateById\n} from \"../services/documentService\";\nimport { renderExcelFromSpec } from \"../services/excelSpecRenderer\";\nimport { renderWordFromSpec } from \"../services/wordSpecRenderer\";\nimport { generateExcelFromPrompt, generateWordFromPrompt, generateCvFromPrompt, generateReportFromPrompt, generateLetterFromPrompt } from \"../services/documentOrchestrator\";\nimport { renderCvFromSpec } from \"../services/cvRenderer\";\nimport { selectCvTemplate } from \"../services/documentMappingService\";\nimport { excelSpecSchema, docSpecSchema, cvSpecSchema } from \"../../shared/documentSpecs\";\nimport { llmGateway } from \"../lib/llmGateway\";\n\nexport const documentsRouter = Router();\n\ndocumentsRouter.post(\"/generate\", async (req, res) => {\n  try {\n    const { type, title, content } = req.body;\n    \n    if (!type || !title || !content) {\n      return res.status(400).json({ error: \"type, title, and content are required\" });\n    }\n\n    let buffer: Buffer;\n    let filename: string;\n    let mimeType: string;\n\n    switch (type) {\n      case \"word\":\n        buffer = await generateWordDocument(title, content);\n        filename = `${title.replace(/[^a-zA-Z0-9]/g, \"_\")}.docx`;\n        mimeType = \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\";\n        break;\n      case \"excel\":\n        const excelData = parseExcelFromText(content);\n        buffer = await generateExcelDocument(title, excelData);\n        filename = `${title.replace(/[^a-zA-Z0-9]/g, \"_\")}.xlsx`;\n        mimeType = \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n        break;\n      case \"ppt\":\n        const slides = parseSlidesFromText(content);\n        buffer = await generatePptDocument(title, slides);\n        filename = `${title.replace(/[^a-zA-Z0-9]/g, \"_\")}.pptx`;\n        mimeType = \"application/vnd.openxmlformats-officedocument.presentationml.presentation\";\n        break;\n      default:\n        return res.status(400).json({ error: \"Invalid document type. Use 'word', 'excel', or 'ppt'\" });\n    }\n\n    res.setHeader(\"Content-Type\", mimeType);\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"Document generation error:\", error);\n    res.status(500).json({ error: \"Failed to generate document\", details: error.message });\n  }\n});\n\ndocumentsRouter.get(\"/templates\", async (req, res) => {\n  try {\n    const templates = getTemplates();\n    const type = req.query.type as string | undefined;\n    \n    if (type) {\n      const filtered = templates.filter(t => t.type.includes(type as any));\n      return res.json(filtered);\n    }\n    \n    res.json(templates);\n  } catch (error: any) {\n    console.error(\"Error fetching templates:\", error);\n    res.status(500).json({ error: \"Failed to fetch templates\" });\n  }\n});\n\ndocumentsRouter.get(\"/templates/:id\", async (req, res) => {\n  try {\n    const template = getTemplateById(req.params.id);\n    if (!template) {\n      return res.status(404).json({ error: \"Template not found\" });\n    }\n    res.json(template);\n  } catch (error: any) {\n    console.error(\"Error fetching template:\", error);\n    res.status(500).json({ error: \"Failed to fetch template\" });\n  }\n});\n\ndocumentsRouter.post(\"/render\", async (req, res) => {\n  try {\n    const parseResult = DocumentRenderRequestSchema.safeParse(req.body);\n    \n    if (!parseResult.success) {\n      return res.status(400).json({ \n        error: \"Invalid request\", \n        details: parseResult.error.flatten().fieldErrors \n      });\n    }\n    \n    const document = await renderDocument(parseResult.data);\n    \n    const baseUrl = `${req.protocol}://${req.get('host')}`;\n    const downloadUrl = `${baseUrl}/api/documents/${document.id}`;\n    \n    res.json({\n      id: document.id,\n      fileName: document.fileName,\n      mimeType: document.mimeType,\n      downloadUrl,\n      expiresAt: document.expiresAt.toISOString(),\n    });\n  } catch (error: any) {\n    console.error(\"Document render error:\", error);\n    res.status(500).json({ error: \"Failed to render document\", details: error.message });\n  }\n});\n\ndocumentsRouter.get(\"/:id\", async (req, res) => {\n  try {\n    const document = getGeneratedDocument(req.params.id);\n    \n    if (!document) {\n      return res.status(404).json({ error: \"Document not found or expired\" });\n    }\n    \n    res.setHeader(\"Content-Type\", document.mimeType);\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"${document.fileName}\"`);\n    res.setHeader(\"Content-Length\", document.buffer.length);\n    res.send(document.buffer);\n  } catch (error: any) {\n    console.error(\"Document download error:\", error);\n    res.status(500).json({ error: \"Failed to download document\" });\n  }\n});\n\ndocumentsRouter.post(\"/render/excel\", async (req, res) => {\n  try {\n    const parseResult = excelSpecSchema.safeParse(req.body);\n    \n    if (!parseResult.success) {\n      return res.status(400).json({ \n        error: \"Invalid Excel spec\", \n        details: parseResult.error.flatten().fieldErrors \n      });\n    }\n    \n    const buffer = await renderExcelFromSpec(parseResult.data);\n    \n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"${parseResult.data.workbook_title || 'workbook'}.xlsx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"Excel render error:\", error);\n    res.status(500).json({ error: \"Failed to render Excel document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/render/word\", async (req, res) => {\n  try {\n    const parseResult = docSpecSchema.safeParse(req.body);\n    \n    if (!parseResult.success) {\n      return res.status(400).json({ \n        error: \"Invalid Word doc spec\", \n        details: parseResult.error.flatten().fieldErrors \n      });\n    }\n    \n    const buffer = await renderWordFromSpec(parseResult.data);\n    \n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"${parseResult.data.title || 'document'}.docx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"Word render error:\", error);\n    res.status(500).json({ error: \"Failed to render Word document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/generate/excel\", async (req, res) => {\n  try {\n    const { prompt, returnMetadata } = req.body;\n    \n    if (!prompt || typeof prompt !== \"string\") {\n      return res.status(400).json({ error: \"Prompt is required\" });\n    }\n    \n    const result = await generateExcelFromPrompt(prompt);\n    const { buffer, spec, qualityReport, postRenderValidation, attemptsUsed } = result;\n    \n    if (qualityReport.warnings.length > 0) {\n      res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n    }\n    if (postRenderValidation.warnings.length > 0) {\n      res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n    }\n    res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n    \n    if (returnMetadata === true) {\n      return res.json({\n        success: true,\n        filename: `${spec.workbook_title || 'generated'}.xlsx`,\n        buffer: buffer.toString(\"base64\"),\n        qualityWarnings: qualityReport.warnings,\n        postRenderWarnings: postRenderValidation.warnings,\n        metadata: postRenderValidation.metadata,\n        attemptsUsed,\n      });\n    }\n    \n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"${spec.workbook_title || 'generated'}.xlsx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"Excel generation error:\", error);\n    res.status(500).json({ error: \"Failed to generate Excel document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/generate/word\", async (req, res) => {\n  try {\n    const { prompt, returnMetadata } = req.body;\n    \n    if (!prompt || typeof prompt !== \"string\") {\n      return res.status(400).json({ error: \"Prompt is required\" });\n    }\n    \n    const result = await generateWordFromPrompt(prompt);\n    const { buffer, spec, qualityReport, postRenderValidation, attemptsUsed } = result;\n    \n    if (qualityReport.warnings.length > 0) {\n      res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n    }\n    if (postRenderValidation.warnings.length > 0) {\n      res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n    }\n    res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n    \n    if (returnMetadata === true) {\n      return res.json({\n        success: true,\n        filename: `${spec.title || 'generated'}.docx`,\n        buffer: buffer.toString(\"base64\"),\n        qualityWarnings: qualityReport.warnings,\n        postRenderWarnings: postRenderValidation.warnings,\n        metadata: postRenderValidation.metadata,\n        attemptsUsed,\n      });\n    }\n    \n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"${spec.title || 'generated'}.docx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"Word generation error:\", error);\n    res.status(500).json({ error: \"Failed to generate Word document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/generate/cv\", async (req, res) => {\n  try {\n    const { prompt } = req.body;\n    \n    if (!prompt || typeof prompt !== \"string\") {\n      return res.status(400).json({ error: \"Prompt is required\" });\n    }\n    \n    const result = await generateCvFromPrompt(prompt);\n    const { buffer, qualityReport, postRenderValidation, attemptsUsed } = result;\n    \n    if (qualityReport.warnings.length > 0) {\n      res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n    }\n    if (postRenderValidation.warnings.length > 0) {\n      res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n    }\n    res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n    \n    const timestamp = Date.now();\n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"cv_${timestamp}.docx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"CV generation error:\", error);\n    res.status(500).json({ error: \"Failed to generate CV document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/generate/report\", async (req, res) => {\n  try {\n    const { prompt } = req.body;\n    \n    if (!prompt || typeof prompt !== \"string\") {\n      return res.status(400).json({ error: \"Prompt is required\" });\n    }\n    \n    const result = await generateReportFromPrompt(prompt);\n    const { buffer, qualityReport, postRenderValidation, attemptsUsed } = result;\n    \n    if (qualityReport.warnings.length > 0) {\n      res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n    }\n    if (postRenderValidation.warnings.length > 0) {\n      res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n    }\n    res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n    \n    const timestamp = Date.now();\n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"report_${timestamp}.docx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"Report generation error:\", error);\n    res.status(500).json({ error: \"Failed to generate Report document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/generate/letter\", async (req, res) => {\n  try {\n    const { prompt } = req.body;\n    \n    if (!prompt || typeof prompt !== \"string\") {\n      return res.status(400).json({ error: \"Prompt is required\" });\n    }\n    \n    const result = await generateLetterFromPrompt(prompt);\n    const { buffer, qualityReport, postRenderValidation, attemptsUsed } = result;\n    \n    if (qualityReport.warnings.length > 0) {\n      res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n    }\n    if (postRenderValidation.warnings.length > 0) {\n      res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n    }\n    res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n    \n    const timestamp = Date.now();\n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"letter_${timestamp}.docx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"Letter generation error:\", error);\n    res.status(500).json({ error: \"Failed to generate Letter document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/render/cv\", async (req, res) => {\n  try {\n    const parseResult = cvSpecSchema.safeParse(req.body);\n    \n    if (!parseResult.success) {\n      return res.status(400).json({ \n        error: \"Invalid CV spec\", \n        details: parseResult.error.flatten().fieldErrors \n      });\n    }\n    \n    const spec = parseResult.data;\n    const templateConfig = selectCvTemplate(spec.template_style || \"modern\");\n    const buffer = await renderCvFromSpec(spec, templateConfig);\n    \n    const timestamp = Date.now();\n    res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"cv_${timestamp}.docx\"`);\n    res.setHeader(\"Content-Length\", buffer.length);\n    res.send(buffer);\n  } catch (error: any) {\n    console.error(\"CV render error:\", error);\n    res.status(500).json({ error: \"Failed to render CV document\", details: error.message });\n  }\n});\n\ndocumentsRouter.post(\"/plan\", async (req, res) => {\n  try {\n    const { prompt, selectedText, documentContent } = req.body;\n    \n    if (!prompt || typeof prompt !== \"string\") {\n      return res.status(400).json({ error: \"Prompt is required\" });\n    }\n\n    const systemPrompt = `You are a document editing assistant. Given a user's instruction, generate a plan of document editing commands.\n\nAvailable commands:\n- bold: Toggle bold formatting\n- italic: Toggle italic formatting\n- underline: Toggle underline formatting\n- strikethrough: Toggle strikethrough\n- heading1, heading2, heading3: Set heading level\n- paragraph: Set as paragraph\n- bulletList: Toggle bullet list\n- orderedList: Toggle numbered list\n- alignLeft, alignCenter, alignRight, alignJustify: Text alignment\n- insertLink: Insert link (payload: {url: string})\n- insertImage: Insert image (payload: {src: string})\n- insertTable: Insert table (payload: {rows: number, cols: number})\n- blockquote: Toggle blockquote\n- codeBlock: Toggle code block\n- insertHorizontalRule: Insert horizontal line\n- setTextColor: Set text color (payload: {color: string})\n- setHighlight: Highlight text (payload: {color: string})\n- insertText: Insert text (payload: {text: string})\n- replaceSelection: Replace selected text (payload: {content: string})\n- clearFormatting: Remove all formatting\n\nRespond with a JSON object containing:\n{\n  \"intent\": \"brief description of what user wants\",\n  \"commands\": [\n    {\"name\": \"commandName\", \"payload\": {...}, \"description\": \"what this step does\"}\n  ]\n}\n\nOnly respond with valid JSON, no markdown code blocks.`;\n\n    const userMessage = `User instruction: ${prompt}\n${selectedText ? `\\nSelected text: \"${selectedText}\"` : ''}\n${documentContent ? `\\nDocument context (first 500 chars): \"${documentContent.substring(0, 500)}\"` : ''}\n\nGenerate the command plan:`;\n\n    const result = await llmGateway.chat([\n      { role: \"system\", content: systemPrompt },\n      { role: \"user\", content: userMessage }\n    ], {\n      temperature: 0.3,\n      maxTokens: 1024,\n    });\n\n    let plan;\n    try {\n      const jsonStr = result.content.replace(/```json\\n?|\\n?```/g, '').trim();\n      plan = JSON.parse(jsonStr);\n    } catch {\n      plan = {\n        intent: prompt,\n        commands: [],\n        error: \"Failed to parse AI response\"\n      };\n    }\n\n    res.json(plan);\n  } catch (error: any) {\n    console.error(\"Document plan error:\", error);\n    res.status(500).json({ error: \"Failed to generate document plan\", details: error.message });\n  }\n});\n","path":null,"size_bytes":17284,"size_tokens":null},"server/routes/files.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { ObjectStorageService, ObjectNotFoundError, objectStorageClient } from \"../objectStorage\";\nimport { ALLOWED_MIME_TYPES, ALLOWED_EXTENSIONS, FILE_UPLOAD_CONFIG, LIMITS } from \"../lib/constants\";\nimport { fileProcessingQueue } from \"../lib/fileProcessingQueue\";\nimport { processDocument } from \"../services/documentProcessing\";\nimport { chunkText, generateEmbeddingsBatch } from \"../embeddingService\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\ninterface MultipartUploadSession {\n  uploadId: string;\n  fileName: string;\n  mimeType: string;\n  fileSize: number;\n  totalChunks: number;\n  storagePath: string;\n  basePath: string;\n  bucketName: string;\n  uploadedParts: Map<number, string>;\n  createdAt: Date;\n}\n\nconst multipartSessions: Map<string, MultipartUploadSession> = new Map();\n\nfunction parseObjectPath(path: string): { bucketName: string; objectName: string } {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n  return { bucketName, objectName };\n}\n\nasync function signObjectURLForMultipart({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(`Failed to sign object URL, errorcode: ${response.status}`);\n  }\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n\nasync function processFileAsync(fileId: string, storagePath: string, mimeType: string, filename?: string) {\n  try {\n    const objectStorageService = new ObjectStorageService();\n    const objectFile = await objectStorageService.getObjectEntityFile(storagePath);\n    const content = await objectStorageService.getFileContent(objectFile);\n    \n    const result = await processDocument(content, mimeType, filename);\n    const chunks = chunkText(result.text, 1500, 150);\n    \n    const chunksWithoutEmbeddings = chunks.map((chunk) => ({\n      fileId,\n      content: chunk.content,\n      embedding: null,\n      chunkIndex: chunk.chunkIndex,\n      pageNumber: chunk.pageNumber || null,\n      metadata: null,\n    }));\n    \n    await storage.createFileChunks(chunksWithoutEmbeddings);\n    await storage.updateFileStatus(fileId, \"ready\");\n    \n    console.log(`File ${fileId} processed: ${chunks.length} chunks created (fast mode)`);\n    \n    generateEmbeddingsAsync(fileId, chunks);\n  } catch (error) {\n    console.error(`Error processing file ${fileId}:`, error);\n    await storage.updateFileStatus(fileId, \"error\");\n  }\n}\n\nasync function generateEmbeddingsAsync(fileId: string, chunks: { content: string; chunkIndex: number; pageNumber?: number }[]) {\n  try {\n    const texts = chunks.map(c => c.content);\n    const embeddings = await generateEmbeddingsBatch(texts);\n    \n    for (let i = 0; i < chunks.length; i++) {\n      await storage.updateFileChunkEmbedding(fileId, chunks[i].chunkIndex, embeddings[i]);\n    }\n    console.log(`File ${fileId} embeddings generated asynchronously`);\n  } catch (error) {\n    console.error(`Error generating embeddings for file ${fileId}:`, error);\n  }\n}\n\nexport function createFilesRouter(): Router {\n  const router = Router();\n  const objectStorageService = new ObjectStorageService();\n\n  router.get(\"/api/files\", async (req, res) => {\n    try {\n      const files = await storage.getFiles();\n      res.json(files);\n    } catch (error: any) {\n      console.error(\"Error getting files:\", error);\n      res.status(500).json({ error: \"Failed to get files\" });\n    }\n  });\n\n  router.post(\"/api/objects/upload\", async (req, res) => {\n    try {\n      const { uploadURL, storagePath } = await objectStorageService.getObjectEntityUploadURLWithPath();\n      res.json({ uploadURL, storagePath });\n    } catch (error: any) {\n      console.error(\"Error getting upload URL:\", error);\n      res.status(500).json({ error: \"Failed to get upload URL\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/create\", async (req, res) => {\n    try {\n      const { fileName, mimeType, fileSize, totalChunks } = req.body;\n\n      if (!fileName || !mimeType || !fileSize || !totalChunks) {\n        return res.status(400).json({ error: \"Missing required fields: fileName, mimeType, fileSize, totalChunks\" });\n      }\n\n      if (!ALLOWED_MIME_TYPES.includes(mimeType as any)) {\n        return res.status(400).json({ error: `Unsupported file type: ${mimeType}` });\n      }\n\n      if (fileSize > LIMITS.MAX_FILE_SIZE_BYTES) {\n        return res.status(400).json({ error: `File size exceeds maximum limit of ${LIMITS.MAX_FILE_SIZE_MB}MB` });\n      }\n\n      const uploadId = `multipart_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;\n      const privateObjectDir = objectStorageService.getPrivateObjectDir();\n      const objectId = `uploads/${uploadId}`;\n      const storagePath = `/objects/${objectId}`;\n\n      const session: MultipartUploadSession = {\n        uploadId,\n        fileName,\n        mimeType,\n        fileSize,\n        totalChunks,\n        storagePath,\n        basePath: `${privateObjectDir}/${objectId}`,\n        bucketName: privateObjectDir.split('/')[1] || '',\n        uploadedParts: new Map(),\n        createdAt: new Date(),\n      };\n\n      multipartSessions.set(uploadId, session);\n\n      res.json({ uploadId, storagePath });\n    } catch (error: any) {\n      console.error(\"Error creating multipart upload:\", error);\n      res.status(500).json({ error: \"Failed to create multipart upload session\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/sign-part\", async (req, res) => {\n    try {\n      const { uploadId, partNumber } = req.body;\n\n      if (!uploadId || partNumber === undefined) {\n        return res.status(400).json({ error: \"Missing required fields: uploadId, partNumber\" });\n      }\n\n      const session = multipartSessions.get(uploadId);\n      if (!session) {\n        return res.status(404).json({ error: \"Upload session not found\" });\n      }\n\n      if (partNumber < 1 || partNumber > session.totalChunks) {\n        return res.status(400).json({ error: `Invalid part number. Must be between 1 and ${session.totalChunks}` });\n      }\n\n      const partPath = `${session.basePath}_part_${partNumber}`;\n      const { bucketName, objectName } = parseObjectPath(partPath);\n      \n      const signedUrl = await signObjectURLForMultipart({\n        bucketName,\n        objectName,\n        method: \"PUT\",\n        ttlSec: 900,\n      });\n\n      res.json({ signedUrl });\n    } catch (error: any) {\n      console.error(\"Error signing multipart part:\", error);\n      res.status(500).json({ error: \"Failed to get signed URL for part\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/complete\", async (req, res) => {\n    try {\n      const { uploadId, parts } = req.body;\n\n      if (!uploadId || !parts || !Array.isArray(parts)) {\n        return res.status(400).json({ error: \"Missing required fields: uploadId, parts\" });\n      }\n\n      const session = multipartSessions.get(uploadId);\n      if (!session) {\n        return res.status(404).json({ error: \"Upload session not found\" });\n      }\n\n      const { bucketName } = parseObjectPath(session.basePath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      \n      const partPaths = parts\n        .sort((a: { partNumber: number }, b: { partNumber: number }) => a.partNumber - b.partNumber)\n        .map((p: { partNumber: number }) => {\n          const partPath = `${session.basePath}_part_${p.partNumber}`;\n          const { objectName } = parseObjectPath(partPath);\n          return objectName;\n        });\n\n      const { objectName: finalObjectName } = parseObjectPath(session.basePath);\n      const destinationFile = bucket.file(finalObjectName);\n\n      try {\n        await bucket.combine(\n          partPaths.map(p => bucket.file(p)),\n          destinationFile\n        );\n        \n        await destinationFile.setMetadata({ contentType: session.mimeType });\n\n        for (const partPath of partPaths) {\n          try {\n            await bucket.file(partPath).delete();\n          } catch (e) {\n            console.warn(`Failed to delete part ${partPath}:`, e);\n          }\n        }\n      } catch (composeError: any) {\n        console.error(\"Failed to compose parts:\", composeError);\n        return res.status(500).json({ error: \"Failed to compose file parts\" });\n      }\n\n      multipartSessions.delete(uploadId);\n\n      const file = await storage.createFile({\n        name: session.fileName,\n        type: session.mimeType,\n        size: session.fileSize,\n        storagePath: session.storagePath,\n        status: \"processing\",\n        userId: null,\n      });\n\n      await storage.createFileJob({\n        fileId: file.id,\n        status: \"pending\",\n      });\n\n      fileProcessingQueue.enqueue({\n        fileId: file.id,\n        storagePath: session.storagePath,\n        mimeType: session.mimeType,\n        fileName: session.fileName,\n      });\n\n      res.json({ success: true, storagePath: session.storagePath, fileId: file.id });\n    } catch (error: any) {\n      console.error(\"Error completing multipart upload:\", error);\n      res.status(500).json({ error: \"Failed to complete multipart upload\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/abort\", async (req, res) => {\n    try {\n      const { uploadId } = req.body;\n\n      if (!uploadId) {\n        return res.status(400).json({ error: \"Missing required field: uploadId\" });\n      }\n\n      const session = multipartSessions.get(uploadId);\n      if (!session) {\n        return res.status(404).json({ error: \"Upload session not found\" });\n      }\n\n      const { bucketName } = parseObjectPath(session.basePath);\n      const bucket = objectStorageClient.bucket(bucketName);\n\n      for (let i = 1; i <= session.totalChunks; i++) {\n        const partPath = `${session.basePath}_part_${i}`;\n        const { objectName } = parseObjectPath(partPath);\n        try {\n          await bucket.file(objectName).delete();\n        } catch (e) {\n        }\n      }\n\n      multipartSessions.delete(uploadId);\n\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error aborting multipart upload:\", error);\n      res.status(500).json({ error: \"Failed to abort multipart upload\" });\n    }\n  });\n\n  router.get(\"/api/files/config\", (req, res) => {\n    res.json({\n      allowedMimeTypes: [...ALLOWED_MIME_TYPES],\n      allowedExtensions: ALLOWED_EXTENSIONS,\n      maxFileSize: LIMITS.MAX_FILE_SIZE_BYTES,\n      maxFileSizeMB: LIMITS.MAX_FILE_SIZE_MB,\n      chunkSize: FILE_UPLOAD_CONFIG.CHUNK_SIZE_BYTES,\n      chunkSizeMB: FILE_UPLOAD_CONFIG.CHUNK_SIZE_MB,\n      maxParallelChunks: FILE_UPLOAD_CONFIG.MAX_PARALLEL_CHUNKS,\n    });\n  });\n\n  router.post(\"/api/files/quick\", async (req, res) => {\n    try {\n      const { name, type, size, storagePath } = req.body;\n\n      if (!name || !type || !size || !storagePath) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      const file = await storage.createFile({\n        name,\n        type,\n        size,\n        storagePath,\n        status: \"ready\",\n        userId: null,\n      });\n\n      res.json(file);\n    } catch (error: any) {\n      console.error(\"Error creating quick file:\", error);\n      res.status(500).json({ error: \"Failed to create file\" });\n    }\n  });\n\n  router.post(\"/api/files\", async (req, res) => {\n    try {\n      const { name, type, size, storagePath } = req.body;\n\n      if (!name || !type || !size || !storagePath) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      if (!ALLOWED_MIME_TYPES.includes(type)) {\n        return res.status(400).json({ error: `Unsupported file type: ${type}` });\n      }\n\n      const file = await storage.createFile({\n        name,\n        type,\n        size,\n        storagePath,\n        status: \"processing\",\n        userId: null,\n      });\n\n      processFileAsync(file.id, storagePath, type, name);\n\n      res.json(file);\n    } catch (error: any) {\n      console.error(\"Error creating file:\", error);\n      res.status(500).json({ error: \"Failed to create file\" });\n    }\n  });\n\n  router.delete(\"/api/files/:id\", async (req, res) => {\n    try {\n      await storage.deleteFile(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting file:\", error);\n      res.status(500).json({ error: \"Failed to delete file\" });\n    }\n  });\n\n  router.get(\"/api/files/:id/content\", async (req, res) => {\n    try {\n      const file = await storage.getFile(req.params.id);\n      if (!file) {\n        return res.status(404).json({ error: \"File not found\" });\n      }\n      if (file.status !== \"ready\") {\n        return res.status(202).json({ status: file.status, content: null });\n      }\n      const chunks = await storage.getFileChunks(req.params.id);\n      const content = chunks\n        .sort((a, b) => a.chunkIndex - b.chunkIndex)\n        .map(c => c.content)\n        .join(\"\\n\");\n      res.json({ status: \"ready\", content, fileName: file.name });\n    } catch (error: any) {\n      console.error(\"Error getting file content:\", error);\n      res.status(500).json({ error: \"Failed to get file content\" });\n    }\n  });\n\n  router.get(\"/objects/:objectPath(*)\", async (req, res) => {\n    try {\n      const objectFile = await objectStorageService.getObjectEntityFile(req.path);\n      objectStorageService.downloadObject(objectFile, res);\n    } catch (error) {\n      if (error instanceof ObjectNotFoundError) {\n        return res.sendStatus(404);\n      }\n      console.error(\"Error serving object:\", error);\n      return res.sendStatus(500);\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":14267,"size_tokens":null},"server/routes/image.ts":{"content":"import { Router } from \"express\";\nimport { generateImage, detectImageRequest, extractImagePrompt } from \"../services/imageGeneration\";\n\nexport const imageRouter = Router();\n\nimageRouter.post(\"/generate\", async (req, res) => {\n  try {\n    const { prompt } = req.body;\n    \n    if (!prompt || typeof prompt !== \"string\") {\n      return res.status(400).json({ error: \"Prompt is required\" });\n    }\n\n    const result = await generateImage(prompt);\n    \n    res.json({\n      success: true,\n      imageData: `data:${result.mimeType};base64,${result.imageBase64}`,\n      prompt: result.prompt\n    });\n  } catch (error: any) {\n    console.error(\"Image generation error:\", error);\n    res.status(500).json({ \n      error: \"Failed to generate image\",\n      details: error.message \n    });\n  }\n});\n\nimageRouter.post(\"/detect\", (req, res) => {\n  const { message } = req.body;\n  if (!message) {\n    return res.status(400).json({ error: \"Message is required\" });\n  }\n  \n  const isImageRequest = detectImageRequest(message);\n  const extractedPrompt = isImageRequest ? extractImagePrompt(message) : null;\n  \n  res.json({ isImageRequest, extractedPrompt });\n});\n","path":null,"size_bytes":1145,"size_tokens":null},"server/routes/agent.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { agentOrchestrator } from \"../agent\";\n\nexport const agentRouter = Router();\n\nagentRouter.get(\"/runs/:id\", async (req, res) => {\n  try {\n    const run = await storage.getAgentRun(req.params.id);\n    if (!run) {\n      return res.status(404).json({ error: \"Run not found\" });\n    }\n    const steps = await storage.getAgentSteps(req.params.id);\n    const assets = await storage.getAgentAssets(req.params.id);\n    res.json({ run, steps, assets });\n  } catch (error: any) {\n    res.status(500).json({ error: \"Failed to get agent run\" });\n  }\n});\n\nagentRouter.post(\"/runs/:id/cancel\", async (req, res) => {\n  try {\n    const success = agentOrchestrator.cancelRun(req.params.id);\n    if (success) {\n      res.json({ success: true });\n    } else {\n      res.status(404).json({ error: \"Run not found or already completed\" });\n    }\n  } catch (error: any) {\n    res.status(500).json({ error: \"Failed to cancel run\" });\n  }\n});\n","path":null,"size_bytes":996,"size_tokens":null},"server/routes/library.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\n\nexport const libraryRouter = Router();\n\nlibraryRouter.get(\"/\", async (req, res) => {\n  try {\n    const user = (req as any).user;\n    const userId = user?.claims?.sub;\n    \n    if (!userId) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n    \n    const mediaType = req.query.type as string | undefined;\n    const items = await storage.getLibraryItems(userId, mediaType);\n    res.json(items);\n  } catch (error: any) {\n    console.error(\"Error getting library items:\", error);\n    res.status(500).json({ error: \"Failed to get library items\" });\n  }\n});\n\nlibraryRouter.post(\"/\", async (req, res) => {\n  try {\n    const user = (req as any).user;\n    const userId = user?.claims?.sub;\n    \n    if (!userId) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n    \n    const { mediaType, title, description, storagePath, thumbnailPath, mimeType, size, metadata, sourceChatId } = req.body;\n    \n    if (!mediaType || !title || !storagePath) {\n      return res.status(400).json({ error: \"mediaType, title, and storagePath are required\" });\n    }\n    \n    const item = await storage.createLibraryItem({\n      userId,\n      mediaType,\n      title,\n      description: description || null,\n      storagePath,\n      thumbnailPath: thumbnailPath || null,\n      mimeType: mimeType || null,\n      size: size || null,\n      metadata: metadata || null,\n      sourceChatId: sourceChatId || null,\n    });\n    \n    res.json(item);\n  } catch (error: any) {\n    console.error(\"Error creating library item:\", error);\n    res.status(500).json({ error: \"Failed to create library item\" });\n  }\n});\n\nlibraryRouter.delete(\"/:id\", async (req, res) => {\n  try {\n    const user = (req as any).user;\n    const userId = user?.claims?.sub;\n    \n    if (!userId) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n    \n    const deleted = await storage.deleteLibraryItem(req.params.id, userId);\n    \n    if (!deleted) {\n      return res.status(404).json({ error: \"Library item not found\" });\n    }\n    \n    res.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Error deleting library item:\", error);\n    res.status(500).json({ error: \"Failed to delete library item\" });\n  }\n});\n","path":null,"size_bytes":2325,"size_tokens":null},"server/routes/browser.ts":{"content":"import { Router } from \"express\";\nimport { browserSessionManager, SessionEvent } from \"../agent/browser\";\nimport { guardrails } from \"../agent\";\n\nexport function createBrowserRouter(broadcastBrowserEvent: (sessionId: string, event: SessionEvent) => void) {\n  const router = Router();\n\n  router.post(\"/session\", async (req, res) => {\n    try {\n      const { objective, config } = req.body;\n      if (!objective) {\n        return res.status(400).json({ error: \"Objective is required\" });\n      }\n      \n      const sessionId = await browserSessionManager.createSession(\n        objective,\n        config || {},\n        (event: SessionEvent) => {\n          broadcastBrowserEvent(event.sessionId, event);\n        }\n      );\n      \n      browserSessionManager.startScreenshotStreaming(sessionId, 1500);\n      \n      res.json({ sessionId });\n    } catch (error: any) {\n      console.error(\"Error creating browser session:\", error);\n      res.status(500).json({ error: \"Failed to create browser session\" });\n    }\n  });\n\n  router.post(\"/session/:id/navigate\", async (req, res) => {\n    try {\n      const { url } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"navigate\", url);\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.navigate(req.params.id, url);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/session/:id/click\", async (req, res) => {\n    try {\n      const { selector } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"click\", selector);\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.click(req.params.id, selector);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/session/:id/type\", async (req, res) => {\n    try {\n      const { selector, text } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"type\", selector, { text });\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.type(req.params.id, selector, text);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/session/:id/scroll\", async (req, res) => {\n    try {\n      const { direction, amount } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"scroll\", \"page\");\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.scroll(req.params.id, direction, amount);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/session/:id/state\", async (req, res) => {\n    try {\n      const state = await browserSessionManager.getPageState(req.params.id);\n      if (!state) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n      res.json(state);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/session/:id/screenshot\", async (req, res) => {\n    try {\n      const screenshot = await browserSessionManager.getScreenshot(req.params.id);\n      if (!screenshot) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n      res.json({ screenshot });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/session/:id\", async (req, res) => {\n    try {\n      const session = browserSessionManager.getSession(req.params.id);\n      if (!session) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n      res.json(session);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/session/:id\", async (req, res) => {\n    try {\n      await browserSessionManager.closeSession(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/session/:id/cancel\", async (req, res) => {\n    try {\n      browserSessionManager.cancelSession(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":4744,"size_tokens":null},"server/routes/gpts.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\n\nexport const gptsRouter = Router();\n\ngptsRouter.get(\"/categories\", async (req, res) => {\n  try {\n    const categories = await storage.getGptCategories();\n    res.json(categories);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.post(\"/categories\", async (req, res) => {\n  try {\n    const { name, slug, description, icon, sortOrder } = req.body;\n    if (!name || !slug) {\n      return res.status(400).json({ error: \"name and slug are required\" });\n    }\n    const category = await storage.createGptCategory({\n      name,\n      slug,\n      description: description || null,\n      icon: icon || null,\n      sortOrder: sortOrder || 0\n    });\n    res.json(category);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.get(\"/\", async (req, res) => {\n  try {\n    const { visibility, categoryId, creatorId } = req.query;\n    const filters: any = {};\n    if (visibility) filters.visibility = visibility as string;\n    if (categoryId) filters.categoryId = categoryId as string;\n    if (creatorId) filters.creatorId = creatorId as string;\n    \n    const gptList = await storage.getGpts(Object.keys(filters).length > 0 ? filters : undefined);\n    res.json(gptList);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.get(\"/popular\", async (req, res) => {\n  try {\n    const limit = parseInt(req.query.limit as string) || 10;\n    const gptList = await storage.getPopularGpts(limit);\n    res.json(gptList);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.post(\"/\", async (req, res) => {\n  try {\n    const { \n      name, slug, description, avatar, categoryId, creatorId,\n      visibility, systemPrompt, temperature, topP, maxTokens,\n      welcomeMessage, capabilities, conversationStarters, isPublished\n    } = req.body;\n    \n    if (!name || !slug || !systemPrompt) {\n      return res.status(400).json({ error: \"name, slug, and systemPrompt are required\" });\n    }\n    \n    const existing = await storage.getGptBySlug(slug);\n    if (existing) {\n      return res.status(409).json({ error: \"A GPT with this slug already exists\" });\n    }\n    \n    const gpt = await storage.createGpt({\n      name,\n      slug,\n      description: description || null,\n      avatar: avatar || null,\n      categoryId: categoryId || null,\n      creatorId: creatorId || null,\n      visibility: visibility || \"private\",\n      systemPrompt,\n      temperature: temperature || \"0.7\",\n      topP: topP || \"1\",\n      maxTokens: maxTokens || 4096,\n      welcomeMessage: welcomeMessage || null,\n      capabilities: capabilities || null,\n      conversationStarters: conversationStarters || null,\n      isPublished: isPublished || \"false\",\n      version: 1\n    });\n    \n    await storage.createGptVersion({\n      gptId: gpt.id,\n      versionNumber: 1,\n      systemPrompt,\n      temperature: temperature || \"0.7\",\n      topP: topP || \"1\",\n      maxTokens: maxTokens || 4096,\n      changeNotes: \"Initial version\",\n      createdBy: creatorId || null\n    });\n    \n    res.json(gpt);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.get(\"/:id\", async (req, res) => {\n  try {\n    const gpt = await storage.getGpt(req.params.id);\n    if (!gpt) {\n      const gptBySlug = await storage.getGptBySlug(req.params.id);\n      if (!gptBySlug) {\n        return res.status(404).json({ error: \"GPT not found\" });\n      }\n      return res.json(gptBySlug);\n    }\n    res.json(gpt);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.patch(\"/:id\", async (req, res) => {\n  try {\n    const updates = req.body;\n    const gpt = await storage.updateGpt(req.params.id, updates);\n    if (!gpt) {\n      return res.status(404).json({ error: \"GPT not found\" });\n    }\n    res.json(gpt);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.delete(\"/:id\", async (req, res) => {\n  try {\n    await storage.deleteGpt(req.params.id);\n    res.json({ success: true });\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.post(\"/:id/use\", async (req, res) => {\n  try {\n    await storage.incrementGptUsage(req.params.id);\n    res.json({ success: true });\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.get(\"/:id/versions\", async (req, res) => {\n  try {\n    const versions = await storage.getGptVersions(req.params.id);\n    res.json(versions);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\ngptsRouter.post(\"/:id/versions\", async (req, res) => {\n  try {\n    const { systemPrompt, temperature, topP, maxTokens, changeNotes, createdBy } = req.body;\n    \n    if (!systemPrompt) {\n      return res.status(400).json({ error: \"systemPrompt is required\" });\n    }\n    \n    const latestVersion = await storage.getLatestGptVersion(req.params.id);\n    const newVersionNumber = latestVersion ? latestVersion.versionNumber + 1 : 1;\n    \n    const version = await storage.createGptVersion({\n      gptId: req.params.id,\n      versionNumber: newVersionNumber,\n      systemPrompt,\n      temperature: temperature || \"0.7\",\n      topP: topP || \"1\",\n      maxTokens: maxTokens || 4096,\n      changeNotes: changeNotes || null,\n      createdBy: createdBy || null\n    });\n    \n    await storage.updateGpt(req.params.id, {\n      version: newVersionNumber,\n      systemPrompt,\n      temperature: temperature || \"0.7\",\n      topP: topP || \"1\",\n      maxTokens: maxTokens || 4096\n    });\n    \n    res.json(version);\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n","path":null,"size_bytes":5819,"size_tokens":null},"server/routes/admin.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { db } from \"../db\";\nimport { users } from \"@shared/schema\";\nimport { llmGateway } from \"../lib/llmGateway\";\n\nexport function createAdminRouter(): Router {\n  const router = Router();\n\n  router.get(\"/api/admin/dashboard\", async (req, res) => {\n    try {\n      const metrics = await storage.getDashboardMetrics();\n      const recentLogs = await storage.getAuditLogs(5);\n      res.json({ metrics, recentActivity: recentLogs });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/users\", async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      res.json(users);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/users/stats\", async (req, res) => {\n    try {\n      const stats = await storage.getUserStats();\n      res.json(stats);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/users\", async (req, res) => {\n    try {\n      const { email, password, plan, role } = req.body;\n      if (!email || !password) {\n        return res.status(400).json({ message: \"Email y contraseña son requeridos\" });\n      }\n      const existingUsers = await storage.getAllUsers();\n      const existingUser = existingUsers.find(u => u.email === email);\n      if (existingUser) {\n        return res.status(400).json({ message: \"Ya existe un usuario con este email\" });\n      }\n      const [user] = await db.insert(users).values({\n        email,\n        password,\n        plan: plan || \"free\",\n        role: role || \"user\",\n        status: \"active\"\n      }).returning();\n      await storage.createAuditLog({\n        action: \"user_create\",\n        resource: \"users\",\n        resourceId: user.id,\n        details: { email, plan, role }\n      });\n      res.json(user);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  router.patch(\"/api/admin/users/:id\", async (req, res) => {\n    try {\n      const user = await storage.updateUser(req.params.id, req.body);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      await storage.createAuditLog({\n        action: \"user_update\",\n        resource: \"users\",\n        resourceId: req.params.id,\n        details: req.body\n      });\n      res.json(user);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/api/admin/users/:id\", async (req, res) => {\n    try {\n      await storage.deleteUser(req.params.id);\n      await storage.createAuditLog({\n        action: \"user_delete\",\n        resource: \"users\",\n        resourceId: req.params.id\n      });\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/models\", async (req, res) => {\n    try {\n      const models = await storage.getAiModels();\n      res.json(models);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/models\", async (req, res) => {\n    try {\n      const { name, provider, modelId, costPer1k, description, status } = req.body;\n      if (!name || !provider || !modelId) {\n        return res.status(400).json({ error: \"name, provider, and modelId are required\" });\n      }\n      const model = await storage.createAiModel({\n        name, provider, modelId, costPer1k, description, status\n      });\n      await storage.createAuditLog({\n        action: \"model_create\",\n        resource: \"ai_models\",\n        resourceId: model.id,\n        details: { name, provider }\n      });\n      res.json(model);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/api/admin/models/:id\", async (req, res) => {\n    try {\n      const model = await storage.updateAiModel(req.params.id, req.body);\n      if (!model) {\n        return res.status(404).json({ error: \"Model not found\" });\n      }\n      await storage.createAuditLog({\n        action: \"model_update\",\n        resource: \"ai_models\",\n        resourceId: req.params.id,\n        details: req.body\n      });\n      res.json(model);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/api/admin/models/:id\", async (req, res) => {\n    try {\n      await storage.deleteAiModel(req.params.id);\n      await storage.createAuditLog({\n        action: \"model_delete\",\n        resource: \"ai_models\",\n        resourceId: req.params.id\n      });\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/payments\", async (req, res) => {\n    try {\n      const payments = await storage.getPayments();\n      res.json(payments);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/payments/stats\", async (req, res) => {\n    try {\n      const stats = await storage.getPaymentStats();\n      res.json(stats);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/payments\", async (req, res) => {\n    try {\n      const payment = await storage.createPayment(req.body);\n      res.json(payment);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/api/admin/payments/:id\", async (req, res) => {\n    try {\n      const payment = await storage.updatePayment(req.params.id, req.body);\n      if (!payment) {\n        return res.status(404).json({ error: \"Payment not found\" });\n      }\n      res.json(payment);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/invoices\", async (req, res) => {\n    try {\n      const invoices = await storage.getInvoices();\n      res.json(invoices);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/invoices\", async (req, res) => {\n    try {\n      const invoice = await storage.createInvoice(req.body);\n      res.json(invoice);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/api/admin/invoices/:id\", async (req, res) => {\n    try {\n      const invoice = await storage.updateInvoice(req.params.id, req.body);\n      if (!invoice) {\n        return res.status(404).json({ error: \"Invoice not found\" });\n      }\n      res.json(invoice);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/analytics\", async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 30;\n      const snapshots = await storage.getAnalyticsSnapshots(days);\n      res.json(snapshots);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/analytics/snapshot\", async (req, res) => {\n    try {\n      const snapshot = await storage.createAnalyticsSnapshot(req.body);\n      res.json(snapshot);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/security/policies\", async (req, res) => {\n    try {\n      const policies = await storage.getDomainPolicies();\n      res.json(policies);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/security/policies\", async (req, res) => {\n    try {\n      const policy = await storage.createDomainPolicy(req.body);\n      res.json(policy);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/api/admin/security/policies/:id\", async (req, res) => {\n    try {\n      const policy = await storage.updateDomainPolicy(req.params.id, req.body);\n      if (!policy) {\n        return res.status(404).json({ error: \"Policy not found\" });\n      }\n      res.json(policy);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/api/admin/security/policies/:id\", async (req, res) => {\n    try {\n      await storage.deleteDomainPolicy(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/security/logs\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 100;\n      const logs = await storage.getAuditLogs(limit);\n      res.json(logs);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/reports\", async (req, res) => {\n    try {\n      const reports = await storage.getReports();\n      res.json(reports);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/reports\", async (req, res) => {\n    try {\n      const report = await storage.createReport({\n        ...req.body,\n        status: \"pending\"\n      });\n      res.json(report);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/api/admin/reports/:id\", async (req, res) => {\n    try {\n      const report = await storage.updateReport(req.params.id, req.body);\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      res.json(report);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/settings\", async (req, res) => {\n    try {\n      const settings = await storage.getSettings();\n      res.json(settings);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/admin/settings\", async (req, res) => {\n    try {\n      const { key, value, description, category } = req.body;\n      if (!key) {\n        return res.status(400).json({ error: \"key is required\" });\n      }\n      const setting = await storage.upsertSetting(key, value, description, category);\n      await storage.createAuditLog({\n        action: \"setting_update\",\n        resource: \"platform_settings\",\n        details: { key, value }\n      });\n      res.json(setting);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/llm/metrics\", async (req, res) => {\n    try {\n      const metrics = llmGateway.getMetrics();\n      res.json(metrics);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/admin/database/info\", async (req, res) => {\n    try {\n      const userStats = await storage.getUserStats();\n      const models = await storage.getAiModels();\n      const payments = await storage.getPayments();\n      const invoices = await storage.getInvoices();\n      \n      res.json({\n        tables: {\n          users: { count: userStats.total },\n          ai_models: { count: models.length },\n          payments: { count: payments.length },\n          invoices: { count: invoices.length }\n        },\n        status: \"healthy\",\n        lastBackup: new Date().toISOString()\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":11508,"size_tokens":null},"client/src/components/composer.tsx":{"content":"import React from \"react\";\nimport { \n  Plus, \n  Upload, \n  Search, \n  Image, \n  Video, \n  Bot, \n  Plug,\n  Globe,\n  FileText,\n  ChevronRight,\n  X,\n  Loader2,\n  CheckCircle2,\n  Maximize2,\n  Minimize2\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { HoverCard, HoverCardContent, HoverCardTrigger } from \"@/components/ui/hover-card\";\nimport { cn } from \"@/lib/utils\";\nimport { RecordingPanel } from \"@/components/recording-panel\";\nimport { VirtualComputer } from \"@/components/virtual-computer\";\nimport { getFileTheme } from \"@/lib/fileTypeTheme\";\n\ninterface UploadedFile {\n  id?: string;\n  name: string;\n  type: string;\n  mimeType?: string;\n  size: number;\n  dataUrl?: string;\n  storagePath?: string;\n  status?: string;\n  content?: string;\n}\n\ninterface BrowserSession {\n  state: \"idle\" | \"connecting\" | \"running\" | \"error\";\n  cancel: () => void;\n}\n\nexport interface ComposerProps {\n  input: string;\n  setInput: (value: string) => void;\n  textareaRef: React.RefObject<HTMLTextAreaElement | null>;\n  composerRef: React.RefObject<HTMLDivElement | null>;\n  fileInputRef: React.RefObject<HTMLInputElement | null>;\n  uploadedFiles: UploadedFile[];\n  removeFile: (index: number) => void;\n  handleSubmit: () => void;\n  handleFileUpload: (e: React.ChangeEvent<HTMLInputElement>) => void;\n  handlePaste: (e: React.ClipboardEvent<HTMLTextAreaElement>) => void;\n  handleDragOver: (e: React.DragEvent) => void;\n  handleDragEnter: (e: React.DragEvent) => void;\n  handleDragLeave: (e: React.DragEvent) => void;\n  handleDrop: (e: React.DragEvent) => void;\n  isDraggingOver: boolean;\n  selectedTool: \"web\" | \"agent\" | \"image\" | null;\n  setSelectedTool: (tool: \"web\" | \"agent\" | \"image\" | null) => void;\n  selectedDocTool: \"word\" | \"excel\" | \"ppt\" | \"figma\" | null;\n  setSelectedDocTool: (tool: \"word\" | \"excel\" | \"ppt\" | \"figma\" | null) => void;\n  closeDocEditor: () => void;\n  openBlankDocEditor: (type: \"word\" | \"excel\" | \"ppt\") => void;\n  aiState: \"idle\" | \"thinking\" | \"responding\";\n  isRecording: boolean;\n  isPaused: boolean;\n  recordingTime: number;\n  toggleVoiceRecording: () => void;\n  discardVoiceRecording: () => void;\n  pauseVoiceRecording: () => void;\n  resumeVoiceRecording: () => void;\n  sendVoiceRecording: () => void;\n  handleStopChat: () => void;\n  setIsVoiceChatOpen: (value: boolean) => void;\n  browserSession: BrowserSession;\n  isBrowserOpen: boolean;\n  setIsBrowserOpen: (value: boolean) => void;\n  isBrowserMaximized: boolean;\n  setIsBrowserMaximized: (value: boolean) => void;\n  browserUrl: string;\n  variant: \"default\" | \"document\";\n  placeholder: string;\n  selectedDocText?: string;\n  handleDocTextDeselect?: () => void;\n  onCloseSidebar?: () => void;\n  setPreviewUploadedImage?: (value: { name: string; dataUrl: string } | null) => void;\n  isFigmaConnected?: boolean;\n  isFigmaConnecting?: boolean;\n  handleFigmaConnect?: () => void;\n  handleFigmaDisconnect?: () => void;\n}\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes === 0) return \"0 B\";\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + \" \" + sizes[i];\n}\n\nexport function Composer({\n  input,\n  setInput,\n  textareaRef,\n  composerRef,\n  fileInputRef,\n  uploadedFiles,\n  removeFile,\n  handleSubmit,\n  handleFileUpload,\n  handlePaste,\n  handleDragOver,\n  handleDragEnter,\n  handleDragLeave,\n  handleDrop,\n  isDraggingOver,\n  selectedTool,\n  setSelectedTool,\n  selectedDocTool,\n  setSelectedDocTool,\n  closeDocEditor,\n  openBlankDocEditor,\n  aiState,\n  isRecording,\n  isPaused,\n  recordingTime,\n  toggleVoiceRecording,\n  discardVoiceRecording,\n  pauseVoiceRecording,\n  resumeVoiceRecording,\n  sendVoiceRecording,\n  handleStopChat,\n  setIsVoiceChatOpen,\n  browserSession,\n  isBrowserOpen,\n  setIsBrowserOpen,\n  isBrowserMaximized,\n  setIsBrowserMaximized,\n  browserUrl,\n  variant,\n  placeholder,\n  selectedDocText,\n  handleDocTextDeselect,\n  onCloseSidebar,\n  setPreviewUploadedImage,\n  isFigmaConnected,\n  isFigmaConnecting,\n  handleFigmaConnect,\n  handleFigmaDisconnect,\n}: ComposerProps) {\n  const isDocumentMode = variant === \"document\";\n  const hasContent = input.trim().length > 0 || uploadedFiles.length > 0;\n\n  const renderAttachmentPreview = () => {\n    if (uploadedFiles.length === 0) return null;\n\n    if (isDocumentMode) {\n      return (\n        <div className=\"flex flex-wrap gap-2 mb-2 px-1\" data-testid=\"inline-attachments-container\">\n          {uploadedFiles.map((file, index) => (\n            <div\n              key={file.id || index}\n              className={cn(\n                \"relative group rounded-lg border overflow-hidden\",\n                file.status === \"error\" \n                  ? \"bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800\" \n                  : \"bg-card border-border\"\n              )}\n              data-testid={`inline-file-${index}`}\n            >\n              <button\n                className=\"absolute top-1 right-1 bg-black/60 hover:bg-black/80 rounded-full p-0.5 text-white z-10 transition-colors opacity-0 group-hover:opacity-100\"\n                onClick={() => removeFile(index)}\n                data-testid={`button-remove-file-${index}`}\n              >\n                <X className=\"h-3 w-3\" />\n              </button>\n              {file.type.startsWith(\"image/\") && file.dataUrl ? (\n                <div className=\"relative w-16 h-16\">\n                  <img \n                    src={file.dataUrl} \n                    alt={file.name}\n                    className=\"w-full h-full object-cover rounded-lg\"\n                  />\n                  {(file.status === \"uploading\" || file.status === \"processing\") && (\n                    <div className=\"absolute inset-0 bg-black/40 flex items-center justify-center rounded-lg\">\n                      <Loader2 className=\"h-4 w-4 animate-spin text-white\" />\n                    </div>\n                  )}\n                  {file.status === \"ready\" && (\n                    <div className=\"absolute bottom-0 right-0 bg-green-500 rounded-tl-md p-0.5\">\n                      <CheckCircle2 className=\"h-2.5 w-2.5 text-white\" />\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <div className=\"flex items-center gap-2 px-2 py-1.5 pr-6 max-w-[180px]\">\n                  <div className={cn(\n                    \"flex items-center justify-center w-8 h-8 rounded flex-shrink-0\",\n                    (file.name.toLowerCase().endsWith(\".pdf\") || file.type.includes(\"pdf\")) ? \"bg-red-500\" :\n                    (file.name.toLowerCase().endsWith(\".docx\") || file.name.toLowerCase().endsWith(\".doc\") || file.type.includes(\"word\") || file.type.includes(\"document\") || file.type.includes(\"wordprocessing\")) ? \"bg-blue-600\" :\n                    (file.name.toLowerCase().endsWith(\".xlsx\") || file.name.toLowerCase().endsWith(\".xls\") || file.name.toLowerCase().endsWith(\".csv\") || file.type.includes(\"sheet\") || file.type.includes(\"excel\") || file.type.includes(\"spreadsheet\")) ? \"bg-green-600\" :\n                    (file.name.toLowerCase().endsWith(\".pptx\") || file.name.toLowerCase().endsWith(\".ppt\") || file.type.includes(\"presentation\") || file.type.includes(\"powerpoint\")) ? \"bg-orange-500\" :\n                    \"bg-muted-foreground\"\n                  )}>\n                    <span className=\"text-white text-[10px] font-bold\">\n                      {(file.name.toLowerCase().endsWith(\".pdf\") || file.type.includes(\"pdf\")) ? \"PDF\" :\n                       (file.name.toLowerCase().endsWith(\".docx\") || file.name.toLowerCase().endsWith(\".doc\") || file.type.includes(\"word\") || file.type.includes(\"document\") || file.type.includes(\"wordprocessing\")) ? \"DOC\" :\n                       (file.name.toLowerCase().endsWith(\".xlsx\") || file.name.toLowerCase().endsWith(\".xls\") || file.name.toLowerCase().endsWith(\".csv\") || file.type.includes(\"sheet\") || file.type.includes(\"excel\") || file.type.includes(\"spreadsheet\")) ? \"XLS\" :\n                       (file.name.toLowerCase().endsWith(\".pptx\") || file.name.toLowerCase().endsWith(\".ppt\") || file.type.includes(\"presentation\") || file.type.includes(\"powerpoint\")) ? \"PPT\" :\n                       \"FILE\"}\n                    </span>\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <span className=\"text-xs font-medium truncate block\">{file.name}</span>\n                    <span className=\"text-[10px] text-muted-foreground\">\n                      {file.status === \"uploading\" ? \"Subiendo...\" :\n                       file.status === \"processing\" ? \"Procesando...\" :\n                       file.status === \"error\" ? \"Error\" :\n                       formatFileSize(file.size)}\n                    </span>\n                  </div>\n                  {(file.status === \"uploading\" || file.status === \"processing\") && (\n                    <Loader2 className=\"h-3 w-3 animate-spin text-blue-500 flex-shrink-0\" />\n                  )}\n                  {file.status === \"ready\" && (\n                    <CheckCircle2 className=\"h-3 w-3 text-green-500 flex-shrink-0\" />\n                  )}\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"flex items-center gap-2 pl-2\">\n        {uploadedFiles.map((file, index) => {\n          const theme = getFileTheme(file.name, file.mimeType);\n          const isImage = file.type?.startsWith(\"image/\") || file.mimeType?.startsWith(\"image/\");\n          \n          if (isImage && file.dataUrl) {\n            return (\n              <div key={file.id} className=\"relative group\">\n                <div \n                  className=\"relative w-14 h-14 rounded-lg overflow-hidden cursor-pointer border border-border hover:border-primary transition-colors\"\n                  onClick={() => setPreviewUploadedImage?.({ name: file.name, dataUrl: file.dataUrl! })}\n                  data-testid={`preview-image-${index}`}\n                >\n                  <img \n                    src={file.dataUrl} \n                    alt={file.name}\n                    className=\"w-full h-full object-cover\"\n                  />\n                  {(file.status === \"uploading\" || file.status === \"processing\") && (\n                    <div className=\"absolute inset-0 bg-black/40 flex items-center justify-center\">\n                      <Loader2 className=\"h-4 w-4 text-white animate-spin\" />\n                    </div>\n                  )}\n                </div>\n                <button\n                  className=\"absolute -top-1.5 -right-1.5 w-5 h-5 rounded-full bg-destructive text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-md\"\n                  onClick={(e) => { e.stopPropagation(); removeFile(index); }}\n                  data-testid={`button-remove-file-${index}`}\n                >\n                  <X className=\"h-3 w-3\" />\n                </button>\n              </div>\n            );\n          }\n          \n          return (\n            <TooltipProvider key={file.id}>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div \n                    className={cn(\n                      \"relative group flex items-center gap-2 px-2 py-1.5 rounded-lg text-xs transition-all duration-200 cursor-pointer\",\n                      file.status === \"uploading\" && \"bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800\",\n                      file.status === \"processing\" && \"bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800\",\n                      file.status === \"ready\" && \"bg-muted/50 border border-border hover:bg-muted\",\n                      file.status === \"error\" && \"bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800\"\n                    )}\n                  >\n                    <div className={cn(\n                      \"flex items-center justify-center w-7 h-7 rounded shrink-0\",\n                      theme.bgColor\n                    )}>\n                      {file.status === \"uploading\" || file.status === \"processing\" ? (\n                        <Loader2 className=\"h-4 w-4 text-white animate-spin\" />\n                      ) : (\n                        <span className=\"text-white text-xs font-bold\">\n                          {theme.icon}\n                        </span>\n                      )}\n                    </div>\n                    <span className=\"max-w-[100px] truncate font-medium\">{file.name}</span>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-5 w-5 shrink-0 text-muted-foreground hover:text-red-500 transition-colors\"\n                      onClick={(e) => { e.stopPropagation(); removeFile(index); }}\n                      data-testid={`button-remove-file-${index}`}\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\">\n                  <p className=\"text-xs\">{file.name} ({formatFileSize(file.size)})</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          );\n        })}\n      </div>\n    );\n  };\n\n  const renderToolsPopover = () => (\n    <Popover>\n      <PopoverTrigger asChild>\n        <Button \n          variant=\"ghost\" \n          size=\"icon\" \n          className={cn(\n            \"h-9 w-9 rounded-full text-muted-foreground hover:text-foreground flex-shrink-0\",\n            isDocumentMode && \"h-10 w-10\"\n          )}\n        >\n          <Plus className=\"h-5 w-5\" />\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className={cn(\"p-1\", isDocumentMode ? \"w-48\" : \"w-56 p-2\")} align=\"start\" side=\"top\">\n        <div className={cn(isDocumentMode ? \"flex flex-col\" : \"grid gap-1\")}>\n          {isDocumentMode ? (\n            <>\n              <Button \n                variant=\"ghost\" \n                className=\"justify-start gap-2 text-sm h-9\"\n                onClick={() => fileInputRef.current?.click()}\n                data-testid=\"button-upload-files\"\n              >\n                <Upload className=\"h-4 w-4\" />\n                Upload Files\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"justify-start gap-2 text-sm h-9\"\n                onClick={() => setIsBrowserOpen(!isBrowserOpen)}\n              >\n                <Search className=\"h-4 w-4\" />\n                Web Search\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-2 text-sm h-9\">\n                <Image className=\"h-4 w-4\" />\n                Image Generation\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-2 text-sm h-9\">\n                <Video className=\"h-4 w-4\" />\n                Video Generation\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-2 text-sm h-9\">\n                <Bot className=\"h-4 w-4\" />\n                Agente\n              </Button>\n              <Button variant=\"ghost\" className=\"justify-start gap-2 text-sm h-9\">\n                <Plug className=\"h-4 w-4\" />\n                Connectors MPC\n              </Button>\n            </>\n          ) : (\n            <>\n              <label className=\"cursor-pointer\">\n                <input\n                  type=\"file\"\n                  className=\"hidden\"\n                  multiple\n                  accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.webp\"\n                  onChange={handleFileUpload}\n                />\n                <Button variant=\"ghost\" className=\"w-full justify-start gap-2 text-sm h-9\" asChild>\n                  <span>\n                    <Upload className=\"h-4 w-4\" />\n                    Subir archivo\n                  </span>\n                </Button>\n              </label>\n              <Button \n                variant=\"ghost\" \n                className=\"justify-start gap-2 text-sm h-9\"\n                onClick={() => { setSelectedTool(\"web\"); onCloseSidebar?.(); }}\n              >\n                <Globe className=\"h-4 w-4\" />\n                Navegar en la web\n              </Button>\n              <Button \n                variant=\"ghost\" \n                className=\"justify-start gap-2 text-sm h-9\"\n                onClick={() => { setSelectedTool(\"image\"); onCloseSidebar?.(); }}\n              >\n                <Image className=\"h-4 w-4\" />\n                Generar imagen\n              </Button>\n              \n              <HoverCard openDelay={100} closeDelay={100}>\n                <HoverCardTrigger asChild>\n                  <Button variant=\"ghost\" className=\"justify-between gap-2 text-sm h-9 w-full\">\n                    <span className=\"flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4\" />\n                      Crear documento\n                    </span>\n                    <ChevronRight className=\"h-4 w-4\" />\n                  </Button>\n                </HoverCardTrigger>\n                <HoverCardContent side=\"right\" align=\"start\" className=\"w-48 p-2\">\n                  <div className=\"grid gap-1\">\n                    <Button \n                      variant=\"ghost\" \n                      className=\"justify-start gap-2 text-sm h-9\"\n                      onClick={() => openBlankDocEditor(\"word\")}\n                      data-testid=\"button-create-word\"\n                    >\n                      <div className=\"flex items-center justify-center w-5 h-5 rounded bg-blue-600\">\n                        <span className=\"text-white text-xs font-bold\">W</span>\n                      </div>\n                      Documento Word\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      className=\"justify-start gap-2 text-sm h-9\"\n                      onClick={() => openBlankDocEditor(\"excel\")}\n                      data-testid=\"button-create-excel\"\n                    >\n                      <div className=\"flex items-center justify-center w-5 h-5 rounded bg-green-600\">\n                        <span className=\"text-white text-xs font-bold\">X</span>\n                      </div>\n                      Hoja Excel\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      className=\"justify-start gap-2 text-sm h-9\"\n                      onClick={() => openBlankDocEditor(\"ppt\")}\n                    >\n                      <div className=\"flex items-center justify-center w-5 h-5 rounded bg-orange-500\">\n                        <span className=\"text-white text-xs font-bold\">P</span>\n                      </div>\n                      Presentación PPT\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      className=\"justify-start gap-2 text-sm h-9\"\n                      onClick={() => { setSelectedDocTool(\"figma\"); onCloseSidebar?.(); }}\n                    >\n                      <div className=\"flex items-center justify-center w-5 h-5 rounded bg-card border border-border\">\n                        <svg width=\"10\" height=\"14\" viewBox=\"0 0 38 57\" fill=\"none\">\n                          <path d=\"M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z\" fill=\"#1ABCFE\"/>\n                          <path d=\"M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z\" fill=\"#0ACF83\"/>\n                          <path d=\"M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z\" fill=\"#FF7262\"/>\n                          <path d=\"M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z\" fill=\"#F24E1E\"/>\n                          <path d=\"M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z\" fill=\"#A259FF\"/>\n                        </svg>\n                      </div>\n                      Diagrama Figma\n                    </Button>\n                  </div>\n                </HoverCardContent>\n              </HoverCard>\n              \n              <Button \n                variant=\"ghost\" \n                className=\"justify-start gap-2 text-sm h-9\"\n                onClick={() => { setSelectedTool(\"agent\"); onCloseSidebar?.(); }}\n              >\n                <Bot className=\"h-4 w-4\" />\n                Agente\n              </Button>\n              \n              <HoverCard openDelay={100} closeDelay={100}>\n                <HoverCardTrigger asChild>\n                  <Button variant=\"ghost\" className=\"justify-between gap-2 text-sm h-9 w-full\">\n                    <span className=\"flex items-center gap-2\">\n                      <Plug className=\"h-4 w-4\" />\n                      Conectores\n                    </span>\n                    <ChevronRight className=\"h-4 w-4\" />\n                  </Button>\n                </HoverCardTrigger>\n                <HoverCardContent side=\"right\" align=\"start\" className=\"w-56 p-2\">\n                  <div className=\"grid gap-1\">\n                    <div className=\"flex items-center justify-between px-2 py-2 rounded-md hover:bg-accent/50\" data-testid=\"mcp-gmail\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 rounded-lg bg-card border border-border flex items-center justify-center\">\n                          <svg width=\"18\" height=\"14\" viewBox=\"0 0 24 18\" fill=\"none\">\n                            <path d=\"M1.5 5.25V15.75C1.5 16.1478 1.65804 16.5294 1.93934 16.8107C2.22064 17.092 2.60218 17.25 3 17.25H21C21.3978 17.25 21.7794 17.092 22.0607 16.8107C22.342 16.5294 22.5 16.1478 22.5 15.75V5.25L12 12L1.5 5.25Z\" fill=\"#EA4335\"/>\n                            <path d=\"M22.5 2.25V5.25L12 12L1.5 5.25V2.25C1.5 1.85218 1.65804 1.47064 1.93934 1.18934C2.22064 0.908035 2.60218 0.75 3 0.75H21C21.3978 0.75 21.7794 0.908035 22.0607 1.18934C22.342 1.47064 22.5 1.85218 22.5 2.25Z\" fill=\"#FBBC05\"/>\n                            <path d=\"M1.5 5.25L12 12L22.5 5.25\" stroke=\"#34A853\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\n                          </svg>\n                        </div>\n                        <span className=\"text-sm font-medium\">Gmail</span>\n                      </div>\n                      <Button size=\"sm\" className=\"h-7 px-3 text-xs bg-primary text-primary-foreground hover:bg-primary/90 rounded-full\">\n                        Conectar\n                      </Button>\n                    </div>\n                    \n                    <div className=\"flex items-center justify-between px-2 py-2 rounded-md hover:bg-accent/50\" data-testid=\"mcp-google-drive\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 rounded-lg bg-card border border-border flex items-center justify-center\">\n                          <svg width=\"20\" height=\"18\" viewBox=\"0 0 87.3 78\" fill=\"none\">\n                            <path d=\"M6.6 66.85L0.8 56.05L28.7 5.8H57.7L85.6 56.05L79.8 66.85L56.1 25.6H30.4L6.6 66.85Z\" fill=\"#0066DA\"/>\n                            <path d=\"M29.2 78L44.1 51.2H87.3L72.4 78H29.2Z\" fill=\"#00AC47\"/>\n                            <path d=\"M0 78L14.9 51.2H29.2L44.1 78H0Z\" fill=\"#EA4335\"/>\n                            <path d=\"M57.7 5.8L72.6 32.6L87.3 51.2H44.1L29.2 24.4L57.7 5.8Z\" fill=\"#00832D\"/>\n                            <path d=\"M14.9 51.2L29.2 24.4L44.1 51.2H14.9Z\" fill=\"#2684FC\"/>\n                            <path d=\"M44.1 51.2L29.2 78H0L14.9 51.2H44.1Z\" fill=\"#FFBA00\"/>\n                          </svg>\n                        </div>\n                        <span className=\"text-sm font-medium\">Google Drive</span>\n                      </div>\n                      <Button size=\"sm\" className=\"h-7 px-3 text-xs bg-primary text-primary-foreground hover:bg-primary/90 rounded-full\">\n                        Conectar\n                      </Button>\n                    </div>\n                    \n                    <div className=\"flex items-center justify-between px-2 py-2 rounded-md hover:bg-accent/50\" data-testid=\"mcp-onedrive\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 rounded-lg bg-card border border-border flex items-center justify-center\">\n                          <svg width=\"20\" height=\"14\" viewBox=\"0 0 24 16\" fill=\"none\">\n                            <path d=\"M14.5 2C12.5 2 10.7 3.1 9.8 4.8C9.3 4.5 8.7 4.4 8 4.4C5.8 4.4 4 6.2 4 8.4C4 8.6 4 8.8 4.1 9C1.8 9.4 0 11.4 0 13.8C0 16.1 1.9 18 4.2 18H19.5C22 18 24 16 24 13.5C24 11.2 22.3 9.3 20 9C20 5.1 17.6 2 14.5 2Z\" fill=\"#0364B8\"/>\n                            <path d=\"M9.8 4.8C10.7 3.1 12.5 2 14.5 2C17.6 2 20 5.1 20 9C22.3 9.3 24 11.2 24 13.5C24 16 22 18 19.5 18H10L9.8 4.8Z\" fill=\"#0078D4\"/>\n                            <path d=\"M8 4.4C8.7 4.4 9.3 4.5 9.8 4.8L10 18H4.2C1.9 18 0 16.1 0 13.8C0 11.4 1.8 9.4 4.1 9C4 8.8 4 8.6 4 8.4C4 6.2 5.8 4.4 8 4.4Z\" fill=\"#1490DF\"/>\n                            <path d=\"M10 18L9.8 4.8C9.3 4.5 8.7 4.4 8 4.4C5.8 4.4 4 6.2 4 8.4C4 8.6 4 8.8 4.1 9C1.8 9.4 0 11.4 0 13.8C0 16.1 1.9 18 4.2 18H10Z\" fill=\"#28A8EA\"/>\n                          </svg>\n                        </div>\n                        <span className=\"text-sm font-medium\">OneDrive</span>\n                      </div>\n                      <Button size=\"sm\" className=\"h-7 px-3 text-xs bg-primary text-primary-foreground hover:bg-primary/90 rounded-full\">\n                        Conectar\n                      </Button>\n                    </div>\n                    \n                    <div className=\"flex flex-col gap-2 px-2 py-2 rounded-md hover:bg-accent/50\" data-testid=\"mcp-figma\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-8 h-8 rounded-lg bg-card border border-border flex items-center justify-center\">\n                            <svg width=\"14\" height=\"20\" viewBox=\"0 0 38 57\" fill=\"none\">\n                              <path d=\"M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z\" fill=\"#1ABCFE\"/>\n                              <path d=\"M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z\" fill=\"#0ACF83\"/>\n                              <path d=\"M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z\" fill=\"#FF7262\"/>\n                              <path d=\"M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z\" fill=\"#F24E1E\"/>\n                              <path d=\"M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z\" fill=\"#A259FF\"/>\n                            </svg>\n                          </div>\n                          <span className=\"text-sm font-medium\">Figma</span>\n                        </div>\n                        {isFigmaConnected ? (\n                          <Button \n                            size=\"sm\" \n                            variant=\"outline\"\n                            className=\"h-7 px-3 text-xs rounded-full\"\n                            onClick={handleFigmaDisconnect}\n                          >\n                            Desconectar\n                          </Button>\n                        ) : (\n                          <Button \n                            size=\"sm\" \n                            className=\"h-7 px-3 text-xs bg-primary text-primary-foreground hover:bg-primary/90 rounded-full\"\n                            onClick={handleFigmaConnect}\n                            disabled={isFigmaConnecting}\n                          >\n                            {isFigmaConnecting ? (\n                              <Loader2 className=\"h-3 w-3 animate-spin\" />\n                            ) : (\n                              \"Conectar\"\n                            )}\n                          </Button>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                </HoverCardContent>\n              </HoverCard>\n            </>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n\n  const renderSelectedToolLogo = () => {\n    if (!selectedTool) return null;\n\n    return (\n      <div className=\"relative group shrink-0\">\n        <div \n          className={cn(\n            \"relative flex items-center justify-center w-10 h-10 rounded-xl cursor-pointer overflow-hidden\",\n            \"transition-all duration-500 ease-out\",\n            \"hover:shadow-lg hover:shadow-current/30\",\n            \"before:absolute before:inset-0 before:rounded-xl before:opacity-0 before:transition-opacity before:duration-300\",\n            \"hover:before:opacity-100 before:bg-gradient-to-br before:from-white/20 before:to-transparent\",\n            \"after:absolute after:inset-0 after:rounded-xl after:opacity-0 after:transition-all after:duration-700\",\n            \"hover:after:opacity-100 after:animate-pulse\",\n            selectedTool === \"web\" && \"bg-gradient-to-br from-cyan-500 to-cyan-700 after:bg-cyan-400/20\",\n            selectedTool === \"agent\" && \"bg-gradient-to-br from-purple-500 to-purple-700 after:bg-purple-400/20\",\n            selectedTool === \"image\" && \"bg-gradient-to-br from-pink-500 to-rose-600 after:bg-pink-400/20\"\n          )}\n          style={{ animation: \"liquid-float 3s ease-in-out infinite\" }}\n          data-testid=\"button-selected-tool\"\n        >\n          {selectedTool === \"web\" ? (\n            <Globe className=\"h-5 w-5 text-white z-10 drop-shadow-md\" />\n          ) : selectedTool === \"image\" ? (\n            <Image className=\"h-5 w-5 text-white z-10 drop-shadow-md\" />\n          ) : (\n            <Bot className=\"h-5 w-5 text-white z-10 drop-shadow-md\" />\n          )}\n        </div>\n        <button\n          onClick={() => setSelectedTool(null)}\n          className={cn(\n            \"absolute -top-1 -right-1 w-4 h-4 rounded-full\",\n            \"bg-red-500 hover:bg-red-600 text-white\",\n            \"flex items-center justify-center\",\n            \"opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100\",\n            \"transition-all duration-200 ease-out\",\n            \"shadow-md hover:shadow-lg\"\n          )}\n          data-testid=\"button-close-tool\"\n        >\n          <X className=\"h-2.5 w-2.5\" />\n        </button>\n      </div>\n    );\n  };\n\n  const renderSelectedDocToolLogo = () => {\n    if (!selectedDocTool) return null;\n\n    return (\n      <div className=\"relative group shrink-0\">\n        <div \n          className={cn(\n            \"relative flex items-center justify-center w-10 h-10 rounded-xl cursor-pointer overflow-hidden\",\n            \"transition-all duration-500 ease-out\",\n            \"hover:shadow-lg hover:shadow-current/30\",\n            isDocumentMode ? \"\" : \"before:absolute before:inset-0 before:rounded-xl before:opacity-0 before:transition-opacity before:duration-300 hover:before:opacity-100 before:bg-gradient-to-br before:from-white/20 before:to-transparent after:absolute after:inset-0 after:rounded-xl after:opacity-0 after:transition-all after:duration-700 hover:after:opacity-100 after:animate-pulse\",\n            selectedDocTool === \"word\" && \"bg-gradient-to-br from-blue-500 to-blue-700\",\n            selectedDocTool === \"excel\" && \"bg-gradient-to-br from-green-500 to-green-700\",\n            selectedDocTool === \"ppt\" && \"bg-gradient-to-br from-orange-400 to-orange-600\",\n            selectedDocTool === \"figma\" && \"bg-gradient-to-br from-purple-500 to-pink-500\",\n            !isDocumentMode && selectedDocTool === \"word\" && \"after:bg-blue-400/20\",\n            !isDocumentMode && selectedDocTool === \"excel\" && \"after:bg-green-400/20\",\n            !isDocumentMode && selectedDocTool === \"ppt\" && \"after:bg-orange-400/20\",\n            !isDocumentMode && selectedDocTool === \"figma\" && \"after:bg-purple-400/20\"\n          )}\n          style={{ animation: \"liquid-float 3s ease-in-out infinite\" }}\n          data-testid=\"button-selected-doc-tool\"\n        >\n          {selectedDocTool === \"figma\" ? (\n            <svg width=\"16\" height=\"24\" viewBox=\"0 0 38 57\" fill=\"none\" className=\"z-10 drop-shadow-md\">\n              <path d=\"M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z\" fill=\"#1ABCFE\"/>\n              <path d=\"M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z\" fill=\"#0ACF83\"/>\n              <path d=\"M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z\" fill=\"#FF7262\"/>\n              <path d=\"M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z\" fill=\"#F24E1E\"/>\n              <path d=\"M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z\" fill=\"#A259FF\"/>\n            </svg>\n          ) : (\n            <span className=\"text-white text-base font-bold z-10 drop-shadow-md\">\n              {selectedDocTool === \"word\" ? \"W\" : selectedDocTool === \"excel\" ? \"E\" : \"P\"}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={isDocumentMode ? closeDocEditor : () => setSelectedDocTool(null)}\n          className={cn(\n            \"absolute -top-1 -right-1 w-4 h-4 rounded-full\",\n            \"bg-red-500 hover:bg-red-600 text-white\",\n            \"flex items-center justify-center\",\n            \"opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100\",\n            \"transition-all duration-200 ease-out\",\n            \"shadow-md hover:shadow-lg\"\n          )}\n          data-testid=\"button-close-doc-tool\"\n        >\n          <X className=\"h-2.5 w-2.5\" />\n        </button>\n      </div>\n    );\n  };\n\n  const containerClass = isDocumentMode\n    ? cn(\n        \"sticky bottom-0 p-4 sm:p-6 w-full max-w-3xl mx-auto relative bg-background z-10\",\n        isDraggingOver && \"ring-2 ring-primary rounded-2xl\"\n      )\n    : \"shrink-0 px-4 pb-4\";\n\n  const inputContainerClass = isDocumentMode\n    ? \"relative flex flex-col rounded-3xl liquid-input-light dark:liquid-input p-2 focus-within:shadow-lg transition-all duration-300\"\n    : cn(\n        \"max-w-3xl mx-auto glass-card-light dark:glass-card rounded-2xl border border-white/30 dark:border-white/10 p-3 relative\",\n        selectedDocText && \"ring-2 ring-primary/50\",\n        isDraggingOver && \"ring-2 ring-primary border-primary\"\n      );\n\n  return (\n    <div \n      ref={composerRef}\n      className={containerClass}\n      onDragOver={handleDragOver}\n      onDragEnter={handleDragEnter}\n      onDragLeave={handleDragLeave}\n      onDrop={handleDrop}\n    >\n      {isDraggingOver && (\n        <div className=\"absolute inset-0 z-50 bg-primary/10 backdrop-blur-sm rounded-2xl flex items-center justify-center border-2 border-dashed border-primary pointer-events-none\">\n          <div className=\"flex flex-col items-center gap-2 text-primary\">\n            <Upload className=\"h-8 w-8\" />\n            <span className=\"text-sm font-medium\">Suelta los archivos aquí</span>\n          </div>\n        </div>\n      )}\n\n      {isDocumentMode && (\n        <>\n          <div className=\"absolute left-4 sm:left-6 bottom-[calc(100%+8px)] z-20\">\n            <VirtualComputer\n              state={browserSession.state}\n              onCancel={browserSession.cancel}\n              compact={true}\n            />\n          </div>\n\n          {(isBrowserOpen || input.trim().length > 0) && !isBrowserMaximized && (\n            <div className=\"absolute left-4 sm:left-6 bottom-[calc(100%-16px)] w-[120px] border rounded-lg overflow-hidden shadow-lg bg-card z-20 transition-all duration-200\">\n              <div className=\"flex items-center justify-between px-1 py-0.5 bg-muted/50 border-b\">\n                <span className=\"text-[8px] font-medium text-muted-foreground\">Computadora Virtual</span>\n                <div className=\"flex items-center\">\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-4 w-4 text-muted-foreground hover:text-foreground\"\n                    onClick={() => setIsBrowserMaximized(true)}\n                  >\n                    <Maximize2 className=\"h-2 w-2\" />\n                  </Button>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-4 w-4 text-muted-foreground hover:text-foreground\"\n                    onClick={() => setIsBrowserOpen(false)}\n                  >\n                    <X className=\"h-2 w-2\" />\n                  </Button>\n                </div>\n              </div>\n              <div className=\"bg-card relative h-[100px]\">\n                <iframe \n                  src={browserUrl}\n                  className=\"w-full h-full border-0\"\n                  sandbox=\"allow-scripts allow-same-origin allow-forms\"\n                  title=\"Virtual Browser\"\n                />\n                {aiState !== \"idle\" && (\n                  <div className=\"absolute inset-0 bg-black/20 flex items-center justify-center\">\n                    <Loader2 className=\"h-4 w-4 animate-spin text-blue-500\" />\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n          \n          {isBrowserMaximized && (\n            <div className=\"fixed inset-4 z-50 border rounded-lg overflow-hidden shadow-lg bg-card\">\n              <div className=\"flex items-center justify-between px-2 py-1 bg-muted/50 border-b\">\n                <span className=\"text-xs font-medium text-muted-foreground\">Computadora Virtual</span>\n                <div className=\"flex items-center gap-1\">\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-6 w-6 text-muted-foreground hover:text-foreground\"\n                    onClick={() => setIsBrowserMaximized(false)}\n                  >\n                    <Minimize2 className=\"h-3 w-3\" />\n                  </Button>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-6 w-6 text-muted-foreground hover:text-foreground\"\n                    onClick={() => { setIsBrowserOpen(false); setIsBrowserMaximized(false); }}\n                  >\n                    <X className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n              </div>\n              <div className=\"bg-card relative h-[calc(100%-28px)]\">\n                <iframe \n                  src={browserUrl}\n                  className=\"w-full h-full border-0\"\n                  sandbox=\"allow-scripts allow-same-origin allow-forms\"\n                  title=\"Virtual Browser\"\n                />\n                {aiState !== \"idle\" && (\n                  <div className=\"absolute inset-0 bg-black/20 flex items-center justify-center\">\n                    <Loader2 className=\"h-6 w-6 animate-spin text-blue-500\" />\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n        </>\n      )}\n\n      <input\n        type=\"file\"\n        ref={fileInputRef}\n        onChange={handleFileUpload}\n        className=\"hidden\"\n        multiple\n        accept=\"*/*\"\n        data-testid=\"input-file-upload\"\n      />\n\n      <div className={inputContainerClass}>\n        <div className={isDocumentMode ? \"\" : \"flex flex-col gap-2\"}>\n          {renderAttachmentPreview()}\n\n          {isDocumentMode && selectedDocText && handleDocTextDeselect && (\n            <div className=\"mb-2 px-1 animate-in fade-in duration-150\" data-testid=\"selected-doc-text-banner\">\n              <div className=\"bg-teal-50/80 dark:bg-teal-900/30 border border-teal-200 dark:border-teal-700 rounded-lg px-3 py-1.5 text-sm text-teal-700 dark:text-teal-300 flex items-center gap-2\">\n                <FileText className=\"h-3.5 w-3.5 flex-shrink-0 opacity-70\" />\n                <span className=\"truncate flex-1\" data-testid=\"selected-doc-text-preview\">\n                  {selectedDocText.length > 50 ? selectedDocText.substring(0, 50) + '...' : selectedDocText}\n                </span>\n                <button \n                  onClick={handleDocTextDeselect}\n                  className=\"text-teal-500 hover:text-teal-700 flex-shrink-0 p-0.5 rounded hover:bg-teal-100 dark:hover:bg-teal-800/50 transition-colors\"\n                  aria-label=\"Deselect text\"\n                  data-testid=\"button-deselect-doc-text\"\n                >\n                  <X className=\"h-3 w-3\" />\n                </button>\n              </div>\n            </div>\n          )}\n          \n          <div className=\"flex items-end gap-2\">\n            {renderToolsPopover()}\n            \n            {!isDocumentMode && renderSelectedToolLogo()}\n            {renderSelectedDocToolLogo()}\n            \n            <Textarea\n              ref={textareaRef}\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              onKeyDown={(e) => {\n                const filesStillLoading = uploadedFiles.some(f => f.status === \"uploading\" || f.status === \"processing\");\n                if (e.key === \"Enter\" && !e.shiftKey && !filesStillLoading) {\n                  e.preventDefault();\n                  handleSubmit();\n                }\n              }}\n              onPaste={handlePaste}\n              placeholder={placeholder}\n              className={cn(\n                \"min-h-[40px] w-full resize-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 text-base\",\n                !isDocumentMode && \"leading-relaxed\"\n              )}\n              rows={1}\n            />\n\n            <div className={cn(\"flex items-center gap-1\", isDocumentMode ? \"pb-1\" : \"pb-1\")}>\n              <RecordingPanel\n                isRecording={isRecording}\n                isPaused={isPaused}\n                recordingTime={recordingTime}\n                canSend={hasContent}\n                onDiscard={discardVoiceRecording}\n                onPause={pauseVoiceRecording}\n                onResume={resumeVoiceRecording}\n                onSend={sendVoiceRecording}\n                onToggleRecording={toggleVoiceRecording}\n                onOpenVoiceChat={() => setIsVoiceChatOpen(true)}\n                onStopChat={handleStopChat}\n                onSubmit={handleSubmit}\n                aiState={aiState}\n                hasContent={hasContent}\n              />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"text-center text-xs text-muted-foreground mt-3\">\n        MICHAT can make mistakes. Check important info.\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":43158,"size_tokens":null},"server/routes/etl.ts":{"content":"import { Router } from \"express\";\nimport { runETLAgent, getAvailableCountries, getAvailableIndicators } from \"../etl\";\n\nexport const etlRouter = Router();\n\netlRouter.get(\"/config\", async (req, res) => {\n  try {\n    res.json({\n      countries: getAvailableCountries(),\n      indicators: getAvailableIndicators()\n    });\n  } catch (error: any) {\n    console.error(\"ETL config error:\", error);\n    res.status(500).json({ error: \"Failed to get ETL config\" });\n  }\n});\n\netlRouter.post(\"/run\", async (req, res) => {\n  try {\n    const { countries, indicators, startDate, endDate } = req.body;\n    \n    if (!countries || !Array.isArray(countries) || countries.length === 0) {\n      return res.status(400).json({ error: \"Countries array is required\" });\n    }\n\n    const result = await runETLAgent({\n      countries,\n      indicators,\n      startDate,\n      endDate\n    });\n\n    if (result.success && result.workbookBuffer) {\n      res.setHeader('Content-Type', 'application/zip');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${result.filename}\"`);\n      res.send(result.workbookBuffer);\n    } else {\n      res.status(result.success ? 200 : 500).json({\n        success: result.success,\n        message: result.message,\n        summary: result.summary,\n        errors: result.errors\n      });\n    }\n  } catch (error: any) {\n    console.error(\"ETL API error:\", error);\n    res.status(500).json({ \n      error: \"ETL pipeline failed\",\n      details: error.message \n    });\n  }\n});\n","path":null,"size_bytes":1490,"size_tokens":null},"server/routes/users.ts":{"content":"import { Router } from \"express\";\nimport crypto from \"crypto\";\nimport { storage } from \"../storage\";\nimport { db } from \"../db\";\nimport { notificationEventTypes, integrationProviders, integrationTools, responsePreferencesSchema, userProfileSchema, featureFlagsSchema } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nexport const usersRouter = Router();\n\nusersRouter.get(\"/notification-event-types\", async (req, res) => {\n  try {\n    const eventTypes = await storage.getNotificationEventTypes();\n    res.json(eventTypes);\n  } catch (error: any) {\n    console.error(\"Error getting notification event types:\", error);\n    res.status(500).json({ error: \"Failed to get notification event types\" });\n  }\n});\n\nusersRouter.get(\"/:id/notification-preferences\", async (req, res) => {\n  try {\n    const { id } = req.params;\n    const eventTypes = await storage.getNotificationEventTypes();\n    const preferences = await storage.getNotificationPreferences(id);\n    \n    const prefsWithEventTypes = eventTypes.map(eventType => {\n      const pref = preferences.find(p => p.eventTypeId === eventType.id);\n      return {\n        eventType,\n        preference: pref || null,\n        enabled: pref ? pref.enabled : eventType.defaultChannels !== 'none',\n        channels: pref ? pref.channels : eventType.defaultChannels\n      };\n    });\n    \n    res.json(prefsWithEventTypes);\n  } catch (error: any) {\n    console.error(\"Error getting notification preferences:\", error);\n    res.status(500).json({ error: \"Failed to get notification preferences\" });\n  }\n});\n\nusersRouter.put(\"/:id/notification-preferences\", async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { eventTypeId, enabled, channels } = req.body;\n    \n    if (!eventTypeId) {\n      return res.status(400).json({ error: \"eventTypeId is required\" });\n    }\n    \n    const preference = await storage.upsertNotificationPreference({\n      userId: id,\n      eventTypeId,\n      enabled: enabled !== undefined ? (enabled ? \"true\" : \"false\") : \"true\",\n      channels: channels || \"push\"\n    });\n    \n    res.json(preference);\n  } catch (error: any) {\n    console.error(\"Error updating notification preference:\", error);\n    res.status(500).json({ error: \"Failed to update notification preference\" });\n  }\n});\n\nusersRouter.post(\"/notification-event-types/seed\", async (req, res) => {\n  try {\n    const eventTypesToSeed = [\n      { id: 'ai_response_ready', name: 'Respuestas de IA', description: 'Notificaciones cuando una respuesta larga está lista', category: 'ai_updates', severity: 'normal', defaultChannels: 'push', sortOrder: 1 },\n      { id: 'task_status_update', name: 'Actualizaciones de tareas', description: 'Cambios en tareas programadas', category: 'tasks', severity: 'normal', defaultChannels: 'push_email', sortOrder: 2 },\n      { id: 'project_invitation', name: 'Invitaciones a proyectos', description: 'Invitaciones a chats compartidos', category: 'social', severity: 'high', defaultChannels: 'push_email', sortOrder: 3 },\n      { id: 'product_recommendation', name: 'Recomendaciones', description: 'Sugerencias personalizadas', category: 'product', severity: 'low', defaultChannels: 'email', sortOrder: 4 },\n      { id: 'feature_announcement', name: 'Novedades', description: 'Nuevas funciones disponibles', category: 'product', severity: 'low', defaultChannels: 'email', sortOrder: 5 }\n    ];\n    \n    const existing = await storage.getNotificationEventTypes();\n    const existingIds = new Set(existing.map(e => e.id));\n    \n    const toInsert = eventTypesToSeed.filter(e => !existingIds.has(e.id));\n    \n    if (toInsert.length > 0) {\n      await db.insert(notificationEventTypes).values(toInsert);\n    }\n    \n    const allEventTypes = await storage.getNotificationEventTypes();\n    res.json({ \n      message: `Seeded ${toInsert.length} new event types`,\n      eventTypes: allEventTypes \n    });\n  } catch (error: any) {\n    console.error(\"Error seeding notification event types:\", error);\n    res.status(500).json({ error: \"Failed to seed notification event types\" });\n  }\n});\n\nusersRouter.get(\"/:id/settings\", async (req, res) => {\n  try {\n    const { id } = req.params;\n    \n    const user = (req as any).user;\n    const userId = user?.claims?.sub;\n    \n    if (!userId) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n    \n    if (userId !== id) {\n      return res.status(403).json({ error: \"Access denied: You can only access your own settings\" });\n    }\n    \n    const settings = await storage.getUserSettings(id);\n    \n    if (!settings) {\n      res.json({\n        userId: id,\n        responsePreferences: {\n          responseStyle: 'default',\n          responseTone: 'professional',\n          customInstructions: ''\n        },\n        userProfile: {\n          nickname: '',\n          occupation: '',\n          bio: ''\n        },\n        featureFlags: {\n          memoryEnabled: true,\n          recordingHistoryEnabled: false,\n          webSearchAuto: true,\n          codeInterpreterEnabled: true,\n          canvasEnabled: true,\n          voiceEnabled: true,\n          voiceAdvanced: false,\n          connectorSearchAuto: false\n        }\n      });\n      return;\n    }\n    \n    res.json(settings);\n  } catch (error: any) {\n    console.error(\"Error getting user settings:\", error);\n    res.status(500).json({ error: \"Failed to get user settings\" });\n  }\n});\n\nusersRouter.put(\"/:id/settings\", async (req, res) => {\n  try {\n    const { id } = req.params;\n    \n    const user = (req as any).user;\n    const userId = user?.claims?.sub;\n    \n    if (!userId) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n    \n    if (userId !== id) {\n      return res.status(403).json({ error: \"Access denied: You can only update your own settings\" });\n    }\n    \n    const { responsePreferences, userProfile, featureFlags } = req.body;\n    \n    const updates: any = {};\n    const validationErrors: string[] = [];\n    \n    if (responsePreferences !== undefined) {\n      const parsed = responsePreferencesSchema.safeParse(responsePreferences);\n      if (!parsed.success) {\n        validationErrors.push(`responsePreferences: ${parsed.error.errors.map(e => e.message).join(', ')}`);\n      } else {\n        updates.responsePreferences = parsed.data;\n      }\n    }\n    \n    if (userProfile !== undefined) {\n      const parsed = userProfileSchema.safeParse(userProfile);\n      if (!parsed.success) {\n        validationErrors.push(`userProfile: ${parsed.error.errors.map(e => e.message).join(', ')}`);\n      } else {\n        updates.userProfile = parsed.data;\n      }\n    }\n    \n    if (featureFlags !== undefined) {\n      const parsed = featureFlagsSchema.safeParse(featureFlags);\n      if (!parsed.success) {\n        validationErrors.push(`featureFlags: ${parsed.error.errors.map(e => e.message).join(', ')}`);\n      } else {\n        updates.featureFlags = parsed.data;\n      }\n    }\n    \n    if (validationErrors.length > 0) {\n      return res.status(400).json({ \n        error: \"Validation failed\", \n        details: validationErrors \n      });\n    }\n    \n    const settings = await storage.upsertUserSettings(id, updates);\n    res.json(settings);\n  } catch (error: any) {\n    console.error(\"Error updating user settings:\", error);\n    res.status(500).json({ error: \"Failed to update user settings\" });\n  }\n});\n\nusersRouter.get(\"/integrations/providers\", async (req, res) => {\n  try {\n    const providers = await storage.getIntegrationProviders();\n    res.json(providers);\n  } catch (error: any) {\n    console.error(\"Error getting providers:\", error);\n    res.status(500).json({ error: \"Failed to get providers\" });\n  }\n});\n\nusersRouter.get(\"/integrations/tools\", async (req, res) => {\n  try {\n    const { providerId } = req.query;\n    const tools = await storage.getIntegrationTools(providerId as string | undefined);\n    res.json(tools);\n  } catch (error: any) {\n    console.error(\"Error getting tools:\", error);\n    res.status(500).json({ error: \"Failed to get tools\" });\n  }\n});\n\nusersRouter.get(\"/:id/integrations\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const [accounts, policy, providers] = await Promise.all([\n      storage.getIntegrationAccounts(id),\n      storage.getIntegrationPolicy(id),\n      storage.getIntegrationProviders()\n    ]);\n    \n    res.json({ accounts, policy, providers });\n  } catch (error: any) {\n    console.error(\"Error getting user integrations:\", error);\n    res.status(500).json({ error: \"Failed to get integrations\" });\n  }\n});\n\nusersRouter.put(\"/:id/integrations/policy\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const { enabledApps, enabledTools, disabledTools, resourceScopes, autoConfirmPolicy, sandboxMode, maxParallelCalls } = req.body;\n    \n    const policy = await storage.upsertIntegrationPolicy(id, {\n      enabledApps,\n      enabledTools,\n      disabledTools,\n      resourceScopes,\n      autoConfirmPolicy,\n      sandboxMode,\n      maxParallelCalls\n    });\n    \n    res.json(policy);\n  } catch (error: any) {\n    console.error(\"Error updating policy:\", error);\n    res.status(500).json({ error: \"Failed to update policy\" });\n  }\n});\n\nusersRouter.post(\"/:id/integrations/:provider/connect\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id, provider } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const providerInfo = await storage.getIntegrationProvider(provider);\n    if (!providerInfo) return res.status(404).json({ error: \"Provider not found\" });\n    \n    res.json({ \n      message: \"OAuth flow not yet implemented\",\n      provider: providerInfo.name,\n      authType: providerInfo.authType\n    });\n  } catch (error: any) {\n    console.error(\"Error initiating connect:\", error);\n    res.status(500).json({ error: \"Failed to initiate connection\" });\n  }\n});\n\nusersRouter.post(\"/:id/integrations/:provider/disconnect\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id, provider } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const account = await storage.getIntegrationAccountByProvider(id, provider);\n    if (!account) return res.status(404).json({ error: \"Account not found\" });\n    \n    await storage.deleteIntegrationAccount(account.id);\n    res.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Error disconnecting:\", error);\n    res.status(500).json({ error: \"Failed to disconnect\" });\n  }\n});\n\nusersRouter.get(\"/:id/integrations/logs\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const limit = parseInt(req.query.limit as string) || 50;\n    const logs = await storage.getToolCallLogs(id, limit);\n    res.json(logs);\n  } catch (error: any) {\n    console.error(\"Error getting logs:\", error);\n    res.status(500).json({ error: \"Failed to get logs\" });\n  }\n});\n\nusersRouter.get(\"/:id/privacy\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const settings = await storage.getUserSettings(id);\n    const logs = await storage.getConsentLogs(id, 10);\n    res.json({ \n      privacySettings: settings?.privacySettings || { trainingOptIn: false, remoteBrowserDataAccess: false },\n      consentHistory: logs\n    });\n  } catch (error: any) {\n    console.error(\"Error getting privacy settings:\", error);\n    res.status(500).json({ error: \"Failed to get privacy settings\" });\n  }\n});\n\nusersRouter.put(\"/:id/privacy\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const { trainingOptIn, remoteBrowserDataAccess } = req.body;\n    const ipAddress = req.ip || (req.headers['x-forwarded-for'] as string)?.split(',')[0] || undefined;\n    const userAgent = req.headers['user-agent'] || undefined;\n    \n    if (trainingOptIn !== undefined) {\n      await storage.logConsent(id, 'training_opt_in', String(trainingOptIn), ipAddress, userAgent);\n    }\n    if (remoteBrowserDataAccess !== undefined) {\n      await storage.logConsent(id, 'remote_browser_access', String(remoteBrowserDataAccess), ipAddress, userAgent);\n    }\n    \n    const settings = await storage.upsertUserSettings(id, {\n      privacySettings: { trainingOptIn: trainingOptIn ?? false, remoteBrowserDataAccess: remoteBrowserDataAccess ?? false }\n    });\n    \n    res.json(settings);\n  } catch (error: any) {\n    console.error(\"Error updating privacy settings:\", error);\n    res.status(500).json({ error: \"Failed to update privacy settings\" });\n  }\n});\n\nusersRouter.get(\"/:id/shared-links\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const links = await storage.getSharedLinks(id);\n    res.json(links);\n  } catch (error: any) {\n    console.error(\"Error getting shared links:\", error);\n    res.status(500).json({ error: \"Failed to get shared links\" });\n  }\n});\n\nusersRouter.post(\"/:id/shared-links\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const { resourceType, resourceId, scope, permissions, expiresAt } = req.body;\n    \n    if (!resourceType || !resourceId) {\n      return res.status(400).json({ error: \"Missing required fields: resourceType, resourceId\" });\n    }\n    \n    const token = crypto.randomBytes(32).toString('hex');\n    \n    const link = await storage.createSharedLink({\n      userId: id,\n      resourceType,\n      resourceId,\n      token,\n      scope: scope || 'link_only',\n      permissions: permissions || 'read',\n      expiresAt: expiresAt ? new Date(expiresAt) : undefined,\n      isRevoked: 'false'\n    });\n    \n    res.json(link);\n  } catch (error: any) {\n    console.error(\"Error creating shared link:\", error);\n    res.status(500).json({ error: \"Failed to create shared link\" });\n  }\n});\n\nusersRouter.delete(\"/:id/shared-links/:linkId\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id, linkId } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    await storage.revokeSharedLink(linkId);\n    res.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Error revoking shared link:\", error);\n    res.status(500).json({ error: \"Failed to revoke shared link\" });\n  }\n});\n\nusersRouter.post(\"/:id/shared-links/:linkId/rotate\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id, linkId } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const link = await storage.rotateSharedLinkToken(linkId);\n    res.json(link);\n  } catch (error: any) {\n    console.error(\"Error rotating shared link token:\", error);\n    res.status(500).json({ error: \"Failed to rotate shared link token\" });\n  }\n});\n\nusersRouter.patch(\"/:id/shared-links/:linkId\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id, linkId } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const { scope, permissions } = req.body;\n    \n    const link = await storage.updateSharedLink(linkId, { scope, permissions });\n    res.json(link);\n  } catch (error: any) {\n    console.error(\"Error updating shared link:\", error);\n    res.status(500).json({ error: \"Failed to update shared link\" });\n  }\n});\n\nusersRouter.get(\"/:id/chats/archived\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const chats = await storage.getArchivedChats(id);\n    res.json(chats);\n  } catch (error: any) {\n    console.error(\"Error getting archived chats:\", error);\n    res.status(500).json({ error: \"Failed to get archived chats\" });\n  }\n});\n\nusersRouter.post(\"/:id/chats/:chatId/unarchive\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id, chatId } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    await storage.unarchiveChat(chatId);\n    res.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Error unarchiving chat:\", error);\n    res.status(500).json({ error: \"Failed to unarchive chat\" });\n  }\n});\n\nusersRouter.post(\"/:id/chats/archive-all\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const count = await storage.archiveAllChats(id);\n    res.json({ count });\n  } catch (error: any) {\n    console.error(\"Error archiving all chats:\", error);\n    res.status(500).json({ error: \"Failed to archive all chats\" });\n  }\n});\n\nusersRouter.get(\"/:id/chats/deleted\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const chats = await storage.getDeletedChats(id);\n    res.json(chats);\n  } catch (error: any) {\n    console.error(\"Error getting deleted chats:\", error);\n    res.status(500).json({ error: \"Failed to get deleted chats\" });\n  }\n});\n\nusersRouter.post(\"/:id/chats/delete-all\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    const count = await storage.softDeleteAllChats(id);\n    \n    const links = await storage.getSharedLinks(id);\n    for (const link of links) {\n      if (link.resourceType === 'chat') {\n        await storage.revokeSharedLink(link.id);\n      }\n    }\n    \n    res.json({ count });\n  } catch (error: any) {\n    console.error(\"Error deleting all chats:\", error);\n    res.status(500).json({ error: \"Failed to delete all chats\" });\n  }\n});\n\nusersRouter.post(\"/:id/chats/:chatId/restore\", async (req, res) => {\n  try {\n    const authUserId = (req as any).user?.claims?.sub;\n    if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n    \n    const { id, chatId } = req.params;\n    if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n    \n    await storage.restoreDeletedChat(chatId);\n    res.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Error restoring chat:\", error);\n    res.status(500).json({ error: \"Failed to restore chat\" });\n  }\n});\n","path":null,"size_bytes":20834,"size_tokens":null},"server/routes/chat.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { handleChatRequest, AVAILABLE_MODELS, DEFAULT_PROVIDER, DEFAULT_MODEL } from \"../services/chatService\";\nimport { llmGateway } from \"../lib/llmGateway\";\nimport { sendShareNotificationEmail } from \"../services/emailService\";\n\nexport function createChatRouter(broadcastAgentUpdate: (runId: string, update: any) => void): Router {\n  const router = Router();\n\n  router.get(\"/api/models\", (req, res) => {\n    res.json(AVAILABLE_MODELS);\n  });\n\n  router.post(\"/api/chat\", async (req, res) => {\n    try {\n      const { messages, useRag = true, conversationId, images, gptConfig, documentMode, figmaMode, provider = DEFAULT_PROVIDER, model = DEFAULT_MODEL } = req.body;\n      \n      if (!messages || !Array.isArray(messages)) {\n        return res.status(400).json({ error: \"Messages array is required\" });\n      }\n\n      const formattedMessages = messages.map((msg: { role: string; content: string }) => ({\n        role: msg.role as \"user\" | \"assistant\" | \"system\",\n        content: msg.content\n      }));\n\n      const response = await handleChatRequest(formattedMessages, {\n        useRag,\n        conversationId,\n        images,\n        gptConfig,\n        documentMode,\n        figmaMode,\n        provider,\n        model,\n        onAgentProgress: (update) => broadcastAgentUpdate(update.runId, update as any)\n      });\n      \n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      if (userId) {\n        try {\n          await storage.createAuditLog({\n            userId,\n            action: \"chat_query\",\n            resource: \"chats\",\n            resourceId: conversationId || null,\n            details: { \n              messageCount: messages.length,\n              useRag,\n              documentMode: documentMode || false,\n              hasImages: !!images && images.length > 0\n            }\n          });\n        } catch (auditError) {\n          console.error(\"Failed to create audit log:\", auditError);\n        }\n      }\n      \n      res.json(response);\n    } catch (error: any) {\n      console.error(\"Chat API error:\", error);\n      res.status(500).json({ \n        error: \"Failed to get AI response\",\n        details: error.message \n      });\n    }\n  });\n\n  router.post(\"/api/voice-chat\", async (req, res) => {\n    try {\n      const { message } = req.body;\n      \n      if (!message || typeof message !== \"string\") {\n        return res.status(400).json({ error: \"Message is required\" });\n      }\n\n      console.log(\"[VoiceChat] Processing voice input:\", message);\n      \n      const result = await llmGateway.chat([\n        {\n          role: \"system\",\n          content: `Eres Sira, un asistente de voz amigable y conversacional. \nResponde de manera natural y concisa, como si estuvieras hablando directamente con el usuario.\nMantén las respuestas cortas (2-3 oraciones máximo) para que sean fáciles de escuchar.\nUsa un tono cálido y conversacional en español.\nNo uses markdown, emojis ni formatos especiales ya que tu respuesta será leída en voz alta.`\n        },\n        {\n          role: \"user\",\n          content: message\n        }\n      ], {\n        model: \"grok-3-fast\",\n        temperature: 0.7,\n        maxTokens: 150,\n      });\n      \n      res.json({ \n        success: true,\n        response: result.content,\n        latencyMs: result.latencyMs\n      });\n    } catch (error: any) {\n      console.error(\"Voice chat error:\", error);\n      res.status(500).json({ \n        error: \"Failed to process voice message\",\n        details: error.message \n      });\n    }\n  });\n\n  router.post(\"/api/chat/stream\", async (req, res) => {\n    const requestId = `stream_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    let heartbeatInterval: NodeJS.Timeout | null = null;\n    let isConnectionClosed = false;\n\n    try {\n      const { messages, conversationId } = req.body;\n      \n      if (!messages || !Array.isArray(messages)) {\n        return res.status(400).json({ error: \"Messages array is required\" });\n      }\n\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n      res.setHeader(\"X-Request-Id\", requestId);\n      res.flushHeaders();\n\n      req.on(\"close\", () => {\n        isConnectionClosed = true;\n        if (heartbeatInterval) {\n          clearInterval(heartbeatInterval);\n        }\n        console.log(`[SSE] Connection closed: ${requestId}`);\n      });\n\n      heartbeatInterval = setInterval(() => {\n        if (!isConnectionClosed) {\n          res.write(`:heartbeat\\n\\n`);\n        }\n      }, 15000);\n\n      const formattedMessages = messages.map((msg: { role: string; content: string }) => ({\n        role: msg.role as \"user\" | \"assistant\" | \"system\",\n        content: msg.content\n      }));\n\n      const systemMessage = {\n        role: \"system\" as const,\n        content: `Eres MICHAT, un asistente de IA avanzado. Responde de manera útil y profesional en el idioma del usuario.`\n      };\n\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n\n      res.write(`event: start\\ndata: ${JSON.stringify({ requestId, timestamp: Date.now() })}\\n\\n`);\n\n      const streamGenerator = llmGateway.streamChat(\n        [systemMessage, ...formattedMessages],\n        {\n          userId: userId || conversationId || \"anonymous\",\n          requestId,\n        }\n      );\n\n      let fullContent = \"\";\n      let lastAckSequence = -1;\n\n      for await (const chunk of streamGenerator) {\n        if (isConnectionClosed) break;\n\n        fullContent += chunk.content;\n        lastAckSequence = chunk.sequenceId;\n\n        if (chunk.done) {\n          res.write(`event: done\\ndata: ${JSON.stringify({\n            sequenceId: chunk.sequenceId,\n            requestId: chunk.requestId,\n            timestamp: Date.now(),\n          })}\\n\\n`);\n        } else {\n          res.write(`event: chunk\\ndata: ${JSON.stringify({\n            content: chunk.content,\n            sequenceId: chunk.sequenceId,\n            requestId: chunk.requestId,\n            timestamp: Date.now(),\n          })}\\n\\n`);\n        }\n      }\n\n      if (!isConnectionClosed) {\n        res.write(`event: complete\\ndata: ${JSON.stringify({ \n          requestId, \n          totalSequences: lastAckSequence + 1,\n          contentLength: fullContent.length,\n          timestamp: Date.now() \n        })}\\n\\n`);\n      }\n\n      if (userId) {\n        try {\n          await storage.createAuditLog({\n            userId,\n            action: \"chat_stream\",\n            resource: \"chats\",\n            resourceId: conversationId || null,\n            details: { \n              messageCount: messages.length,\n              requestId,\n              streaming: true\n            }\n          });\n        } catch (auditError) {\n          console.error(\"Failed to create audit log:\", auditError);\n        }\n      }\n\n    } catch (error: any) {\n      console.error(`[SSE] Stream error ${requestId}:`, error);\n      if (!isConnectionClosed) {\n        try {\n          res.write(`event: error\\ndata: ${JSON.stringify({ \n            error: error.message, \n            requestId,\n            timestamp: Date.now() \n          })}\\n\\n`);\n        } catch (writeError) {\n          console.error(`[SSE] Failed to write error event:`, writeError);\n        }\n      }\n    } finally {\n      if (heartbeatInterval) {\n        clearInterval(heartbeatInterval);\n      }\n      if (!isConnectionClosed) {\n        res.end();\n      }\n    }\n  });\n\n  router.get(\"/api/chats\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.json([]);\n      }\n      \n      const chatList = await storage.getChats(userId);\n      res.json(chatList);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/chats/bulk\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.json([]);\n      }\n      \n      const chatsWithMessages = await storage.getChatsWithMessages(userId);\n      res.json(chatsWithMessages);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/chats\", async (req, res) => {\n    try {\n      const { title } = req.body;\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Authentication required to create chats\" });\n      }\n      \n      const chat = await storage.createChat({ title: title || \"New Chat\", userId });\n      res.json(chat);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/chats/:id\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      \n      const isOwner = chat.userId && chat.userId === userId;\n      \n      let shareRole = null;\n      if (!isOwner && userId) {\n        const share = await storage.getChatShareByUserAndChat(userId, req.params.id);\n        if (share) {\n          shareRole = share.role;\n        }\n      }\n      \n      if (!isOwner && !shareRole) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const messages = await storage.getChatMessages(req.params.id);\n      res.json({ ...chat, messages, shareRole, isOwner });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/api/chats/:id\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const existingChat = await storage.getChat(req.params.id);\n      if (!existingChat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!existingChat.userId || existingChat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { title, archived, hidden } = req.body;\n      const updates: any = {};\n      if (title !== undefined) updates.title = title;\n      if (archived !== undefined) updates.archived = archived.toString();\n      if (hidden !== undefined) updates.hidden = hidden.toString();\n      \n      const chat = await storage.updateChat(req.params.id, updates);\n      res.json(chat);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/api/chats/:id\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      await storage.deleteChat(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/chats/archive-all\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n      \n      const chats = await storage.getChats(userId);\n      let archivedCount = 0;\n      for (const chat of chats) {\n        if (chat.archived !== \"true\") {\n          await storage.updateChat(chat.id, { archived: \"true\" });\n          archivedCount++;\n        }\n      }\n      res.json({ success: true, archivedCount });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/api/chats/delete-all\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n      \n      const chats = await storage.getChats(userId);\n      let deletedCount = 0;\n      for (const chat of chats) {\n        await storage.deleteChat(chat.id);\n        deletedCount++;\n      }\n      res.json({ success: true, deletedCount });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/chats/:id/messages\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { role, content, attachments, sources, figmaDiagram } = req.body;\n      if (!role || !content) {\n        return res.status(400).json({ error: \"role and content are required\" });\n      }\n      const message = await storage.createChatMessage({\n        chatId: req.params.id,\n        role,\n        content,\n        attachments: attachments || null,\n        sources: sources || null,\n        figmaDiagram: figmaDiagram || null\n      });\n      \n      if (chat.title === \"New Chat\" && role === \"user\") {\n        const newTitle = content.slice(0, 30) + (content.length > 30 ? \"...\" : \"\");\n        await storage.updateChat(req.params.id, { title: newTitle });\n      }\n      \n      res.json(message);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/chats/:id/shares\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const shares = await storage.getChatShares(req.params.id);\n      res.json(shares);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/chats/:id/shares\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      const userEmail = user?.claims?.email;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { participants } = req.body;\n      if (!participants || !Array.isArray(participants)) {\n        return res.status(400).json({ error: \"participants array is required\" });\n      }\n      \n      const createdShares = [];\n      const emailsToNotify = [];\n      \n      for (const p of participants) {\n        if (!p.email || !p.role) continue;\n        \n        const normalizedEmail = p.email.toLowerCase().trim();\n        \n        const recipientUser = await storage.getUserByEmail(normalizedEmail);\n        \n        const existing = await storage.getChatShareByEmailAndChat(normalizedEmail, req.params.id);\n        if (existing) {\n          const updates: any = {};\n          if (existing.role !== p.role) updates.role = p.role;\n          if (recipientUser && existing.recipientUserId !== recipientUser.id) {\n            updates.recipientUserId = recipientUser.id;\n          }\n          if (Object.keys(updates).length > 0) {\n            await storage.updateChatShare(existing.id, updates);\n          }\n          continue;\n        }\n        \n        const share = await storage.createChatShare({\n          chatId: req.params.id,\n          email: normalizedEmail,\n          recipientUserId: recipientUser?.id || null,\n          role: p.role,\n          invitedBy: userId,\n          notificationSent: \"false\"\n        });\n        createdShares.push(share);\n        emailsToNotify.push({ email: normalizedEmail, role: p.role, shareId: share.id });\n      }\n      \n      for (const notify of emailsToNotify) {\n        try {\n          await sendShareNotificationEmail({\n            toEmail: notify.email,\n            chatTitle: chat.title,\n            chatId: req.params.id,\n            role: notify.role,\n            inviterEmail: userEmail || \"Un usuario\"\n          });\n          await storage.updateChatShare(notify.shareId, { notificationSent: \"true\" });\n        } catch (emailError) {\n          console.error(\"Failed to send share notification:\", emailError);\n        }\n      }\n      \n      res.json({ success: true, created: createdShares.length });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/api/chats/:id/shares/:shareId\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      await storage.deleteChatShare(req.params.shareId);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/shared-chats\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.json([]);\n      }\n      \n      const shares = await storage.getChatSharesByUserId(userId);\n      const sharedChats = [];\n      \n      for (const share of shares) {\n        const chat = await storage.getChat(share.chatId);\n        if (chat) {\n          sharedChats.push({ ...chat, shareRole: share.role, shareId: share.id });\n        }\n      }\n      \n      res.json(sharedChats);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":18351,"size_tokens":null},"server/routes/figmaRouter.ts":{"content":"import { Router } from \"express\";\nimport { figmaService } from \"../services/figmaService\";\n\nexport function createFigmaRouter() {\n  const router = Router();\n\n  router.get(\"/api/auth/figma\", (req, res) => {\n    const clientId = process.env.FIGMA_CLIENT_ID;\n    if (!clientId) {\n      return res.status(500).json({ error: \"Figma OAuth not configured\" });\n    }\n    \n    const state = Math.random().toString(36).substring(7);\n    const host = req.get('host');\n    const protocol = host?.includes('replit') ? 'https' : req.protocol;\n    const redirectUri = `${protocol}://${host}/api/auth/figma/callback`;\n    \n    console.log(\"Starting Figma OAuth with redirect_uri:\", redirectUri);\n    \n    const authUrl = `https://www.figma.com/oauth?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=file_content:read&state=${state}&response_type=code`;\n    \n    res.redirect(authUrl);\n  });\n\n  router.get(\"/api/auth/figma/callback\", async (req, res) => {\n    console.log(\"Figma OAuth callback received:\", req.query);\n    const { code, state, error, error_description } = req.query;\n    \n    if (error) {\n      console.error(\"Figma OAuth error from Figma:\", error, error_description);\n      return res.redirect(`/?figma_error=${encodeURIComponent(error as string)}`);\n    }\n    \n    if (!code) {\n      console.error(\"No code received from Figma\");\n      return res.redirect(\"/?figma_error=no_code\");\n    }\n    \n    const clientId = process.env.FIGMA_CLIENT_ID;\n    const clientSecret = process.env.FIGMA_CLIENT_SECRET;\n    \n    if (!clientId || !clientSecret) {\n      console.error(\"Figma OAuth not configured\");\n      return res.redirect(\"/?figma_error=not_configured\");\n    }\n    \n    try {\n      const host = req.get('host');\n      const protocol = host?.includes('replit') ? 'https' : req.protocol;\n      const redirectUri = `${protocol}://${host}/api/auth/figma/callback`;\n      \n      console.log(\"Exchanging code for token with redirect_uri:\", redirectUri);\n      \n      const tokenResponse = await fetch(\"https://api.figma.com/v1/oauth/token\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        body: new URLSearchParams({\n          client_id: clientId,\n          client_secret: clientSecret,\n          redirect_uri: redirectUri,\n          code: code as string,\n          grant_type: \"authorization_code\",\n        }),\n      });\n      \n      if (!tokenResponse.ok) {\n        const errorText = await tokenResponse.text();\n        console.error(\"Figma token exchange failed:\", errorText);\n        return res.redirect(\"/?figma_error=token_exchange_failed\");\n      }\n      \n      const tokenData = await tokenResponse.json();\n      console.log(\"Figma token received successfully\");\n      const { access_token } = tokenData;\n      \n      figmaService.setAccessToken(access_token);\n      \n      res.redirect(\"/?figma_connected=true\");\n    } catch (error: any) {\n      console.error(\"Figma OAuth error:\", error);\n      res.redirect(\"/?figma_error=server_error\");\n    }\n  });\n\n  router.post(\"/api/figma/connect\", async (req, res) => {\n    try {\n      const { accessToken } = req.body;\n      if (!accessToken) {\n        return res.status(400).json({ error: \"Access token is required\" });\n      }\n      \n      figmaService.setAccessToken(accessToken);\n      \n      try {\n        res.json({ success: true, message: \"Figma connected successfully\" });\n      } catch (error: any) {\n        res.status(401).json({ error: \"Invalid Figma access token\" });\n      }\n    } catch (error: any) {\n      console.error(\"Error connecting to Figma:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/figma/status\", (req, res) => {\n    const token = figmaService.getAccessToken();\n    res.json({ connected: !!token });\n  });\n\n  router.post(\"/api/figma/disconnect\", (req, res) => {\n    figmaService.setAccessToken(\"\");\n    res.json({ success: true });\n  });\n\n  router.get(\"/api/figma/file/:fileKey\", async (req, res) => {\n    try {\n      const { fileKey } = req.params;\n      const fileData = await figmaService.getFile(fileKey);\n      res.json(fileData);\n    } catch (error: any) {\n      console.error(\"Error fetching Figma file:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/figma/file/:fileKey/tokens\", async (req, res) => {\n    try {\n      const { fileKey } = req.params;\n      const fileData = await figmaService.getFile(fileKey);\n      const tokens = figmaService.extractDesignTokens(fileData);\n      res.json({ tokens });\n    } catch (error: any) {\n      console.error(\"Error extracting design tokens:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/figma/code\", async (req, res) => {\n    try {\n      const { fileKey, nodeId } = req.body;\n      if (!fileKey) {\n        return res.status(400).json({ error: \"File key is required\" });\n      }\n      \n      const codeContext = await figmaService.getDesignContext(fileKey, nodeId);\n      res.json(codeContext);\n    } catch (error: any) {\n      console.error(\"Error generating code from Figma:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/api/figma/parse-url\", (req, res) => {\n    try {\n      const { url } = req.body;\n      if (!url) {\n        return res.status(400).json({ error: \"URL is required\" });\n      }\n      \n      const parsed = figmaService.parseFileUrl(url);\n      if (!parsed) {\n        return res.status(400).json({ error: \"Invalid Figma URL\" });\n      }\n      \n      res.json(parsed);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/api/figma/images/:fileKey\", async (req, res) => {\n    try {\n      const { fileKey } = req.params;\n      const { nodeIds, format = \"png\", scale = \"2\" } = req.query;\n      \n      if (!nodeIds || typeof nodeIds !== \"string\") {\n        return res.status(400).json({ error: \"Node IDs are required\" });\n      }\n      \n      const ids = nodeIds.split(\",\");\n      const images = await figmaService.getImages(\n        fileKey, \n        ids, \n        format as \"png\" | \"svg\" | \"jpg\",\n        parseInt(scale as string)\n      );\n      res.json({ images });\n    } catch (error: any) {\n      console.error(\"Error fetching Figma images:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":6436,"size_tokens":null},"server/routes/chatsRouter.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { sendShareNotificationEmail } from \"../services/emailService\";\n\nexport function createChatsRouter() {\n  const router = Router();\n\n  router.get(\"/chats\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.json([]);\n      }\n      \n      const chatList = await storage.getChats(userId);\n      res.json(chatList);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/chats\", async (req, res) => {\n    try {\n      const { title } = req.body;\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Authentication required to create chats\" });\n      }\n      \n      const chat = await storage.createChat({ title: title || \"New Chat\", userId });\n      res.json(chat);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/chats/:id\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      const userEmail = user?.claims?.email;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      \n      const isOwner = chat.userId && chat.userId === userId;\n      \n      let shareRole = null;\n      if (!isOwner && userId) {\n        const share = await storage.getChatShareByUserAndChat(userId, req.params.id);\n        if (share) {\n          shareRole = share.role;\n        }\n      }\n      \n      if (!isOwner && !shareRole) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const messages = await storage.getChatMessages(req.params.id);\n      res.json({ ...chat, messages, shareRole, isOwner });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/chats/:id\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const existingChat = await storage.getChat(req.params.id);\n      if (!existingChat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!existingChat.userId || existingChat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { title, archived, hidden } = req.body;\n      const updates: any = {};\n      if (title !== undefined) updates.title = title;\n      if (archived !== undefined) updates.archived = archived.toString();\n      if (hidden !== undefined) updates.hidden = hidden.toString();\n      \n      const chat = await storage.updateChat(req.params.id, updates);\n      res.json(chat);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/chats/:id\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      await storage.deleteChat(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/chats/archive-all\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n      \n      const chats = await storage.getChats(userId);\n      let archivedCount = 0;\n      for (const chat of chats) {\n        if (chat.archived !== \"true\") {\n          await storage.updateChat(chat.id, { archived: \"true\" });\n          archivedCount++;\n        }\n      }\n      res.json({ success: true, archivedCount });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/chats/delete-all\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n      \n      const chats = await storage.getChats(userId);\n      let deletedCount = 0;\n      for (const chat of chats) {\n        await storage.deleteChat(chat.id);\n        deletedCount++;\n      }\n      res.json({ success: true, deletedCount });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/chats/:id/messages\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { role, content, attachments, sources, figmaDiagram } = req.body;\n      if (!role || !content) {\n        return res.status(400).json({ error: \"role and content are required\" });\n      }\n      const message = await storage.createChatMessage({\n        chatId: req.params.id,\n        role,\n        content,\n        attachments: attachments || null,\n        sources: sources || null,\n        figmaDiagram: figmaDiagram || null\n      });\n      \n      if (chat.title === \"New Chat\" && role === \"user\") {\n        const newTitle = content.slice(0, 30) + (content.length > 30 ? \"...\" : \"\");\n        await storage.updateChat(req.params.id, { title: newTitle });\n      }\n      \n      res.json(message);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/chats/:id/shares\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const shares = await storage.getChatShares(req.params.id);\n      res.json(shares);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/chats/:id/shares\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      const userEmail = user?.claims?.email;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { participants } = req.body;\n      if (!participants || !Array.isArray(participants)) {\n        return res.status(400).json({ error: \"participants array is required\" });\n      }\n      \n      const createdShares = [];\n      const emailsToNotify = [];\n      \n      for (const p of participants) {\n        if (!p.email || !p.role) continue;\n        \n        const normalizedEmail = p.email.toLowerCase().trim();\n        \n        const recipientUser = await storage.getUserByEmail(normalizedEmail);\n        \n        const existing = await storage.getChatShareByEmailAndChat(normalizedEmail, req.params.id);\n        if (existing) {\n          const updates: any = {};\n          if (existing.role !== p.role) updates.role = p.role;\n          if (recipientUser && existing.recipientUserId !== recipientUser.id) {\n            updates.recipientUserId = recipientUser.id;\n          }\n          if (Object.keys(updates).length > 0) {\n            await storage.updateChatShare(existing.id, updates);\n          }\n          continue;\n        }\n        \n        const share = await storage.createChatShare({\n          chatId: req.params.id,\n          email: normalizedEmail,\n          recipientUserId: recipientUser?.id || null,\n          role: p.role,\n          invitedBy: userId,\n          notificationSent: \"false\"\n        });\n        createdShares.push(share);\n        emailsToNotify.push({ email: normalizedEmail, role: p.role, shareId: share.id });\n      }\n      \n      for (const notify of emailsToNotify) {\n        try {\n          await sendShareNotificationEmail({\n            toEmail: notify.email,\n            chatTitle: chat.title,\n            chatId: req.params.id,\n            role: notify.role,\n            inviterEmail: userEmail || \"Un usuario\"\n          });\n          await storage.updateChatShare(notify.shareId, { notificationSent: \"true\" });\n        } catch (emailError) {\n          console.error(\"Failed to send share notification:\", emailError);\n        }\n      }\n      \n      res.json({ success: true, created: createdShares.length });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/chats/:id/shares/:shareId\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      const chat = await storage.getChat(req.params.id);\n      if (!chat) {\n        return res.status(404).json({ error: \"Chat not found\" });\n      }\n      if (!chat.userId || chat.userId !== userId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      await storage.deleteChatShare(req.params.shareId);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/shared-chats\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.json([]);\n      }\n      \n      const sharedChats = await storage.getSharedChatsWithDetails(userId);\n      res.json(sharedChats);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":10382,"size_tokens":null},"server/routes/adminRouter.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { db } from \"../db\";\nimport { users } from \"@shared/schema\";\nimport { llmGateway } from \"../lib/llmGateway\";\n\nexport function createAdminRouter() {\n  const router = Router();\n\n  router.get(\"/dashboard\", async (req, res) => {\n    try {\n      const metrics = await storage.getDashboardMetrics();\n      const recentLogs = await storage.getAuditLogs(5);\n      res.json({ metrics, recentActivity: recentLogs });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/users\", async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      res.json(users);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/users/stats\", async (req, res) => {\n    try {\n      const stats = await storage.getUserStats();\n      res.json(stats);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/users\", async (req, res) => {\n    try {\n      const { email, password, plan, role } = req.body;\n      if (!email || !password) {\n        return res.status(400).json({ message: \"Email y contraseña son requeridos\" });\n      }\n      const existingUsers = await storage.getAllUsers();\n      const existingUser = existingUsers.find(u => u.email === email);\n      if (existingUser) {\n        return res.status(400).json({ message: \"Ya existe un usuario con este email\" });\n      }\n      const [user] = await db.insert(users).values({\n        email,\n        password,\n        plan: plan || \"free\",\n        role: role || \"user\",\n        status: \"active\"\n      }).returning();\n      await storage.createAuditLog({\n        action: \"user_create\",\n        resource: \"users\",\n        resourceId: user.id,\n        details: { email, plan, role }\n      });\n      res.json(user);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  router.patch(\"/users/:id\", async (req, res) => {\n    try {\n      const user = await storage.updateUser(req.params.id, req.body);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      await storage.createAuditLog({\n        action: \"user_update\",\n        resource: \"users\",\n        resourceId: req.params.id,\n        details: req.body\n      });\n      res.json(user);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/users/:id\", async (req, res) => {\n    try {\n      await storage.deleteUser(req.params.id);\n      await storage.createAuditLog({\n        action: \"user_delete\",\n        resource: \"users\",\n        resourceId: req.params.id\n      });\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/models\", async (req, res) => {\n    try {\n      const models = await storage.getAiModels();\n      res.json(models);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/models\", async (req, res) => {\n    try {\n      const { name, provider, modelId, costPer1k, description, status } = req.body;\n      if (!name || !provider || !modelId) {\n        return res.status(400).json({ error: \"name, provider, and modelId are required\" });\n      }\n      const model = await storage.createAiModel({\n        name, provider, modelId, costPer1k, description, status\n      });\n      await storage.createAuditLog({\n        action: \"model_create\",\n        resource: \"ai_models\",\n        resourceId: model.id,\n        details: { name, provider }\n      });\n      res.json(model);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/models/:id\", async (req, res) => {\n    try {\n      const model = await storage.updateAiModel(req.params.id, req.body);\n      if (!model) {\n        return res.status(404).json({ error: \"Model not found\" });\n      }\n      await storage.createAuditLog({\n        action: \"model_update\",\n        resource: \"ai_models\",\n        resourceId: req.params.id,\n        details: req.body\n      });\n      res.json(model);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/models/:id\", async (req, res) => {\n    try {\n      await storage.deleteAiModel(req.params.id);\n      await storage.createAuditLog({\n        action: \"model_delete\",\n        resource: \"ai_models\",\n        resourceId: req.params.id\n      });\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/payments\", async (req, res) => {\n    try {\n      const payments = await storage.getPayments();\n      res.json(payments);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/payments/stats\", async (req, res) => {\n    try {\n      const stats = await storage.getPaymentStats();\n      res.json(stats);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/payments\", async (req, res) => {\n    try {\n      const payment = await storage.createPayment(req.body);\n      res.json(payment);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/payments/:id\", async (req, res) => {\n    try {\n      const payment = await storage.updatePayment(req.params.id, req.body);\n      if (!payment) {\n        return res.status(404).json({ error: \"Payment not found\" });\n      }\n      res.json(payment);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/invoices\", async (req, res) => {\n    try {\n      const invoices = await storage.getInvoices();\n      res.json(invoices);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/invoices\", async (req, res) => {\n    try {\n      const invoice = await storage.createInvoice(req.body);\n      res.json(invoice);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/invoices/:id\", async (req, res) => {\n    try {\n      const invoice = await storage.updateInvoice(req.params.id, req.body);\n      if (!invoice) {\n        return res.status(404).json({ error: \"Invoice not found\" });\n      }\n      res.json(invoice);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/analytics\", async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 30;\n      const snapshots = await storage.getAnalyticsSnapshots(days);\n      res.json(snapshots);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/analytics/snapshot\", async (req, res) => {\n    try {\n      const snapshot = await storage.createAnalyticsSnapshot(req.body);\n      res.json(snapshot);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/security/policies\", async (req, res) => {\n    try {\n      const policies = await storage.getDomainPolicies();\n      res.json(policies);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/security/policies\", async (req, res) => {\n    try {\n      const policy = await storage.createDomainPolicy(req.body);\n      res.json(policy);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/security/policies/:id\", async (req, res) => {\n    try {\n      const policy = await storage.updateDomainPolicy(req.params.id, req.body);\n      if (!policy) {\n        return res.status(404).json({ error: \"Policy not found\" });\n      }\n      res.json(policy);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/security/policies/:id\", async (req, res) => {\n    try {\n      await storage.deleteDomainPolicy(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/security/logs\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 100;\n      const logs = await storage.getAuditLogs(limit);\n      res.json(logs);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/reports\", async (req, res) => {\n    try {\n      const reports = await storage.getReports();\n      res.json(reports);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/reports\", async (req, res) => {\n    try {\n      const report = await storage.createReport({\n        ...req.body,\n        status: \"pending\"\n      });\n      res.json(report);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/reports/:id\", async (req, res) => {\n    try {\n      const report = await storage.updateReport(req.params.id, req.body);\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      res.json(report);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/settings\", async (req, res) => {\n    try {\n      const settings = await storage.getSettings();\n      res.json(settings);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/settings\", async (req, res) => {\n    try {\n      const { key, value, description, category } = req.body;\n      if (!key) {\n        return res.status(400).json({ error: \"key is required\" });\n      }\n      const setting = await storage.upsertSetting(key, value, description, category);\n      await storage.createAuditLog({\n        action: \"setting_update\",\n        resource: \"platform_settings\",\n        details: { key, value }\n      });\n      res.json(setting);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/llm/metrics\", async (req, res) => {\n    try {\n      const metrics = llmGateway.getMetrics();\n      res.json(metrics);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/database/info\", async (req, res) => {\n    try {\n      const userStats = await storage.getUserStats();\n      const models = await storage.getAiModels();\n      const payments = await storage.getPayments();\n      const invoices = await storage.getInvoices();\n      \n      res.json({\n        tables: {\n          users: { count: userStats.total },\n          ai_models: { count: models.length },\n          payments: { count: payments.length },\n          invoices: { count: invoices.length }\n        },\n        status: \"healthy\",\n        lastBackup: new Date().toISOString()\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":11190,"size_tokens":null},"server/routes/gptRouter.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\n\nexport function createGptRouter() {\n  const router = Router();\n\n  router.get(\"/gpt-categories\", async (req, res) => {\n    try {\n      const categories = await storage.getGptCategories();\n      res.json(categories);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/gpt-categories\", async (req, res) => {\n    try {\n      const { name, slug, description, icon, sortOrder } = req.body;\n      if (!name || !slug) {\n        return res.status(400).json({ error: \"name and slug are required\" });\n      }\n      const category = await storage.createGptCategory({\n        name,\n        slug,\n        description: description || null,\n        icon: icon || null,\n        sortOrder: sortOrder || 0\n      });\n      res.json(category);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/gpts\", async (req, res) => {\n    try {\n      const { visibility, categoryId, creatorId } = req.query;\n      const filters: any = {};\n      if (visibility) filters.visibility = visibility as string;\n      if (categoryId) filters.categoryId = categoryId as string;\n      if (creatorId) filters.creatorId = creatorId as string;\n      \n      const gptList = await storage.getGpts(Object.keys(filters).length > 0 ? filters : undefined);\n      res.json(gptList);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/gpts/popular\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 10;\n      const gptList = await storage.getPopularGpts(limit);\n      res.json(gptList);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/gpts\", async (req, res) => {\n    try {\n      const { \n        name, slug, description, avatar, categoryId, creatorId,\n        visibility, systemPrompt, temperature, topP, maxTokens,\n        welcomeMessage, capabilities, conversationStarters, isPublished\n      } = req.body;\n      \n      if (!name || !slug || !systemPrompt) {\n        return res.status(400).json({ error: \"name, slug, and systemPrompt are required\" });\n      }\n      \n      const existing = await storage.getGptBySlug(slug);\n      if (existing) {\n        return res.status(409).json({ error: \"A GPT with this slug already exists\" });\n      }\n      \n      const gpt = await storage.createGpt({\n        name,\n        slug,\n        description: description || null,\n        avatar: avatar || null,\n        categoryId: categoryId || null,\n        creatorId: creatorId || null,\n        visibility: visibility || \"private\",\n        systemPrompt,\n        temperature: temperature || \"0.7\",\n        topP: topP || \"1\",\n        maxTokens: maxTokens || 4096,\n        welcomeMessage: welcomeMessage || null,\n        capabilities: capabilities || null,\n        conversationStarters: conversationStarters || null,\n        isPublished: isPublished || \"false\",\n        version: 1\n      });\n      \n      await storage.createGptVersion({\n        gptId: gpt.id,\n        versionNumber: 1,\n        systemPrompt,\n        temperature: temperature || \"0.7\",\n        topP: topP || \"1\",\n        maxTokens: maxTokens || 4096,\n        changeNotes: \"Initial version\",\n        createdBy: creatorId || null\n      });\n      \n      res.json(gpt);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/gpts/:id\", async (req, res) => {\n    try {\n      const gpt = await storage.getGpt(req.params.id);\n      if (!gpt) {\n        const gptBySlug = await storage.getGptBySlug(req.params.id);\n        if (!gptBySlug) {\n          return res.status(404).json({ error: \"GPT not found\" });\n        }\n        return res.json(gptBySlug);\n      }\n      res.json(gpt);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.patch(\"/gpts/:id\", async (req, res) => {\n    try {\n      const updates = req.body;\n      const gpt = await storage.updateGpt(req.params.id, updates);\n      if (!gpt) {\n        return res.status(404).json({ error: \"GPT not found\" });\n      }\n      res.json(gpt);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/gpts/:id\", async (req, res) => {\n    try {\n      await storage.deleteGpt(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/gpts/:id/use\", async (req, res) => {\n    try {\n      await storage.incrementGptUsage(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/gpts/:id/versions\", async (req, res) => {\n    try {\n      const versions = await storage.getGptVersions(req.params.id);\n      res.json(versions);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/gpts/:id/versions\", async (req, res) => {\n    try {\n      const { systemPrompt, temperature, topP, maxTokens, changeNotes, createdBy } = req.body;\n      \n      if (!systemPrompt) {\n        return res.status(400).json({ error: \"systemPrompt is required\" });\n      }\n      \n      const latestVersion = await storage.getLatestGptVersion(req.params.id);\n      const newVersionNumber = latestVersion ? latestVersion.versionNumber + 1 : 1;\n      \n      const version = await storage.createGptVersion({\n        gptId: req.params.id,\n        versionNumber: newVersionNumber,\n        systemPrompt,\n        temperature: temperature || \"0.7\",\n        topP: topP || \"1\",\n        maxTokens: maxTokens || 4096,\n        changeNotes: changeNotes || null,\n        createdBy: createdBy || null\n      });\n      \n      await storage.updateGpt(req.params.id, {\n        version: newVersionNumber,\n        systemPrompt,\n        temperature: temperature || \"0.7\",\n        topP: topP || \"1\",\n        maxTokens: maxTokens || 4096\n      });\n      \n      res.json(version);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":6247,"size_tokens":null},"server/lib/wsAuth.ts":{"content":"import { IncomingMessage } from \"http\";\nimport { WebSocket, WebSocketServer } from \"ws\";\nimport session from \"express-session\";\nimport connectPg from \"connect-pg-simple\";\nimport cookie from \"cookie\";\nimport cookieSignature from \"cookie-signature\";\n\nconst sessionTtl = 7 * 24 * 60 * 60 * 1000;\n\nlet sessionStore: session.Store | null = null;\n\nfunction getSessionStore(): session.Store {\n  if (!sessionStore) {\n    const PgStore = connectPg(session);\n    sessionStore = new PgStore({\n      conString: process.env.DATABASE_URL,\n      createTableIfMissing: false,\n      ttl: sessionTtl,\n      tableName: \"sessions\",\n    });\n  }\n  return sessionStore;\n}\n\nexport interface AuthenticatedWebSocket extends WebSocket {\n  userId?: string;\n  userEmail?: string;\n  isAuthenticated: boolean;\n}\n\nexport interface WsAuthResult {\n  isAuthenticated: boolean;\n  userId?: string;\n  userEmail?: string;\n  error?: string;\n}\n\nexport async function authenticateWebSocket(\n  request: IncomingMessage\n): Promise<WsAuthResult> {\n  try {\n    const cookies = cookie.parse(request.headers.cookie || \"\");\n    const sessionCookie = cookies[\"connect.sid\"];\n\n    if (!sessionCookie) {\n      return { isAuthenticated: false, error: \"No session cookie\" };\n    }\n\n    const sessionId = extractSessionId(sessionCookie);\n    if (!sessionId) {\n      return { isAuthenticated: false, error: \"Invalid session cookie format\" };\n    }\n\n    const store = getSessionStore();\n    \n    return new Promise((resolve) => {\n      store.get(sessionId, (err, sessionData) => {\n        if (err) {\n          resolve({ isAuthenticated: false, error: \"Session lookup failed\" });\n          return;\n        }\n\n        if (!sessionData) {\n          resolve({ isAuthenticated: false, error: \"Session not found\" });\n          return;\n        }\n\n        const passport = (sessionData as any).passport;\n        if (!passport || !passport.user) {\n          resolve({ isAuthenticated: false, error: \"Not authenticated\" });\n          return;\n        }\n\n        const user = passport.user;\n        const claims = user.claims;\n        \n        if (!claims || !claims.sub) {\n          resolve({ isAuthenticated: false, error: \"Invalid user claims\" });\n          return;\n        }\n\n        const now = Math.floor(Date.now() / 1000);\n        if (user.expires_at && now > user.expires_at) {\n          resolve({ isAuthenticated: false, error: \"Session expired\" });\n          return;\n        }\n\n        resolve({\n          isAuthenticated: true,\n          userId: claims.sub,\n          userEmail: claims.email,\n        });\n      });\n    });\n  } catch (error) {\n    return { isAuthenticated: false, error: \"Authentication error\" };\n  }\n}\n\nfunction extractSessionId(signedCookie: string): string | null {\n  try {\n    const secret = process.env.SESSION_SECRET;\n    if (!secret) {\n      console.error(\"[wsAuth] SESSION_SECRET not configured\");\n      return null;\n    }\n\n    let value = signedCookie;\n    if (value.startsWith(\"s:\")) {\n      value = value.slice(2);\n    }\n    \n    const unsigned = cookieSignature.unsign(value, secret);\n    \n    if (unsigned === false) {\n      console.warn(\"[wsAuth] Cookie signature verification failed - possible tampering attempt\");\n      return null;\n    }\n    \n    return unsigned;\n  } catch (error) {\n    console.error(\"[wsAuth] Error verifying cookie signature:\", error);\n    return null;\n  }\n}\n\nexport function createAuthenticatedWebSocketHandler(\n  wss: WebSocketServer,\n  requireAuth: boolean = true,\n  onConnection: (ws: AuthenticatedWebSocket, request: IncomingMessage) => void\n) {\n  wss.on(\"connection\", async (ws: WebSocket, request: IncomingMessage) => {\n    const authWs = ws as AuthenticatedWebSocket;\n    const authResult = await authenticateWebSocket(request);\n    \n    authWs.isAuthenticated = authResult.isAuthenticated;\n    authWs.userId = authResult.userId;\n    authWs.userEmail = authResult.userEmail;\n\n    if (requireAuth && !authResult.isAuthenticated) {\n      ws.send(JSON.stringify({ \n        type: \"auth_error\", \n        error: authResult.error || \"Authentication required\" \n      }));\n      ws.close(4001, \"Unauthorized\");\n      return;\n    }\n\n    onConnection(authWs, request);\n  });\n}\n","path":null,"size_bytes":4170,"size_tokens":null},"server/routes/documentsRouter.ts":{"content":"import { Router } from \"express\";\nimport { \n  generateWordDocument, \n  generateExcelDocument, \n  generatePptDocument,\n  parseExcelFromText,\n  parseSlidesFromText\n} from \"../services/documentGeneration\";\nimport { \n  DocumentRenderRequestSchema,\n  renderDocument,\n  getGeneratedDocument,\n  getTemplates,\n  getTemplateById\n} from \"../services/documentService\";\nimport { renderExcelFromSpec } from \"../services/excelSpecRenderer\";\nimport { renderWordFromSpec } from \"../services/wordSpecRenderer\";\nimport { generateExcelFromPrompt, generateWordFromPrompt, generateCvFromPrompt, generateReportFromPrompt, generateLetterFromPrompt } from \"../services/documentOrchestrator\";\nimport { renderCvFromSpec } from \"../services/cvRenderer\";\nimport { selectCvTemplate } from \"../services/documentMappingService\";\nimport { excelSpecSchema, docSpecSchema, cvSpecSchema } from \"../../shared/documentSpecs\";\nimport { llmGateway } from \"../lib/llmGateway\";\n\nexport function createDocumentsRouter() {\n  const router = Router();\n\n  router.post(\"/generate\", async (req, res) => {\n    try {\n      const { type, title, content } = req.body;\n      \n      if (!type || !title || !content) {\n        return res.status(400).json({ error: \"type, title, and content are required\" });\n      }\n\n      let buffer: Buffer;\n      let filename: string;\n      let mimeType: string;\n\n      switch (type) {\n        case \"word\":\n          buffer = await generateWordDocument(title, content);\n          filename = `${title.replace(/[^a-zA-Z0-9]/g, \"_\")}.docx`;\n          mimeType = \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\";\n          break;\n        case \"excel\":\n          const excelData = parseExcelFromText(content);\n          buffer = await generateExcelDocument(title, excelData);\n          filename = `${title.replace(/[^a-zA-Z0-9]/g, \"_\")}.xlsx`;\n          mimeType = \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n          break;\n        case \"ppt\":\n          const slides = parseSlidesFromText(content);\n          buffer = await generatePptDocument(title, slides);\n          filename = `${title.replace(/[^a-zA-Z0-9]/g, \"_\")}.pptx`;\n          mimeType = \"application/vnd.openxmlformats-officedocument.presentationml.presentation\";\n          break;\n        default:\n          return res.status(400).json({ error: \"Invalid document type. Use 'word', 'excel', or 'ppt'\" });\n      }\n\n      res.setHeader(\"Content-Type\", mimeType);\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Document generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate document\", details: error.message });\n    }\n  });\n\n  router.get(\"/templates\", async (req, res) => {\n    try {\n      const templates = getTemplates();\n      const type = req.query.type as string | undefined;\n      \n      if (type) {\n        const filtered = templates.filter(t => t.type.includes(type as any));\n        return res.json(filtered);\n      }\n      \n      res.json(templates);\n    } catch (error: any) {\n      console.error(\"Error fetching templates:\", error);\n      res.status(500).json({ error: \"Failed to fetch templates\" });\n    }\n  });\n\n  router.get(\"/templates/:id\", async (req, res) => {\n    try {\n      const template = getTemplateById(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error: any) {\n      console.error(\"Error fetching template:\", error);\n      res.status(500).json({ error: \"Failed to fetch template\" });\n    }\n  });\n\n  router.post(\"/render\", async (req, res) => {\n    try {\n      const parseResult = DocumentRenderRequestSchema.safeParse(req.body);\n      \n      if (!parseResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid request\", \n          details: parseResult.error.flatten().fieldErrors \n        });\n      }\n      \n      const document = await renderDocument(parseResult.data);\n      \n      const baseUrl = `${req.protocol}://${req.get('host')}`;\n      const downloadUrl = `${baseUrl}/api/documents/${document.id}`;\n      \n      res.json({\n        id: document.id,\n        fileName: document.fileName,\n        mimeType: document.mimeType,\n        downloadUrl,\n        expiresAt: document.expiresAt.toISOString(),\n      });\n    } catch (error: any) {\n      console.error(\"Document render error:\", error);\n      res.status(500).json({ error: \"Failed to render document\", details: error.message });\n    }\n  });\n\n  router.get(\"/:id\", async (req, res) => {\n    try {\n      const document = getGeneratedDocument(req.params.id);\n      \n      if (!document) {\n        return res.status(404).json({ error: \"Document not found or expired\" });\n      }\n      \n      res.setHeader(\"Content-Type\", document.mimeType);\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${document.fileName}\"`);\n      res.setHeader(\"Content-Length\", document.buffer.length);\n      res.send(document.buffer);\n    } catch (error: any) {\n      console.error(\"Document download error:\", error);\n      res.status(500).json({ error: \"Failed to download document\" });\n    }\n  });\n\n  router.post(\"/render/excel\", async (req, res) => {\n    try {\n      const parseResult = excelSpecSchema.safeParse(req.body);\n      \n      if (!parseResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid Excel spec\", \n          details: parseResult.error.flatten().fieldErrors \n        });\n      }\n      \n      const buffer = await renderExcelFromSpec(parseResult.data);\n      \n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${parseResult.data.workbook_title || 'workbook'}.xlsx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Excel render error:\", error);\n      res.status(500).json({ error: \"Failed to render Excel document\", details: error.message });\n    }\n  });\n\n  router.post(\"/render/word\", async (req, res) => {\n    try {\n      const parseResult = docSpecSchema.safeParse(req.body);\n      \n      if (!parseResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid Word doc spec\", \n          details: parseResult.error.flatten().fieldErrors \n        });\n      }\n      \n      const buffer = await renderWordFromSpec(parseResult.data);\n      \n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${parseResult.data.title || 'document'}.docx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Word render error:\", error);\n      res.status(500).json({ error: \"Failed to render Word document\", details: error.message });\n    }\n  });\n\n  router.post(\"/generate/excel\", async (req, res) => {\n    try {\n      const { prompt, returnMetadata } = req.body;\n      \n      if (!prompt || typeof prompt !== \"string\") {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n      \n      const result = await generateExcelFromPrompt(prompt);\n      const { buffer, spec, qualityReport, postRenderValidation, attemptsUsed } = result;\n      \n      if (qualityReport.warnings.length > 0) {\n        res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n      }\n      if (postRenderValidation.warnings.length > 0) {\n        res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n      }\n      res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n      \n      if (returnMetadata === true) {\n        return res.json({\n          success: true,\n          filename: `${spec.workbook_title || 'generated'}.xlsx`,\n          buffer: buffer.toString(\"base64\"),\n          qualityWarnings: qualityReport.warnings,\n          postRenderWarnings: postRenderValidation.warnings,\n          metadata: postRenderValidation.metadata,\n          attemptsUsed,\n        });\n      }\n      \n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${spec.workbook_title || 'generated'}.xlsx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Excel generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate Excel document\", details: error.message });\n    }\n  });\n\n  router.post(\"/generate/word\", async (req, res) => {\n    try {\n      const { prompt, returnMetadata } = req.body;\n      \n      if (!prompt || typeof prompt !== \"string\") {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n      \n      const result = await generateWordFromPrompt(prompt);\n      const { buffer, spec, qualityReport, postRenderValidation, attemptsUsed } = result;\n      \n      if (qualityReport.warnings.length > 0) {\n        res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n      }\n      if (postRenderValidation.warnings.length > 0) {\n        res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n      }\n      res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n      \n      if (returnMetadata === true) {\n        return res.json({\n          success: true,\n          filename: `${spec.title || 'generated'}.docx`,\n          buffer: buffer.toString(\"base64\"),\n          qualityWarnings: qualityReport.warnings,\n          postRenderWarnings: postRenderValidation.warnings,\n          metadata: postRenderValidation.metadata,\n          attemptsUsed,\n        });\n      }\n      \n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${spec.title || 'generated'}.docx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Word generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate Word document\", details: error.message });\n    }\n  });\n\n  router.post(\"/generate/cv\", async (req, res) => {\n    try {\n      const { prompt } = req.body;\n      \n      if (!prompt || typeof prompt !== \"string\") {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n      \n      const result = await generateCvFromPrompt(prompt);\n      const { buffer, qualityReport, postRenderValidation, attemptsUsed } = result;\n      \n      if (qualityReport.warnings.length > 0) {\n        res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n      }\n      if (postRenderValidation.warnings.length > 0) {\n        res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n      }\n      res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n      \n      const timestamp = Date.now();\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"cv_${timestamp}.docx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"CV generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate CV document\", details: error.message });\n    }\n  });\n\n  router.post(\"/generate/report\", async (req, res) => {\n    try {\n      const { prompt } = req.body;\n      \n      if (!prompt || typeof prompt !== \"string\") {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n      \n      const result = await generateReportFromPrompt(prompt);\n      const { buffer, qualityReport, postRenderValidation, attemptsUsed } = result;\n      \n      if (qualityReport.warnings.length > 0) {\n        res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n      }\n      if (postRenderValidation.warnings.length > 0) {\n        res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n      }\n      res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n      \n      const timestamp = Date.now();\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"report_${timestamp}.docx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Report generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate Report document\", details: error.message });\n    }\n  });\n\n  router.post(\"/generate/letter\", async (req, res) => {\n    try {\n      const { prompt } = req.body;\n      \n      if (!prompt || typeof prompt !== \"string\") {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n      \n      const result = await generateLetterFromPrompt(prompt);\n      const { buffer, qualityReport, postRenderValidation, attemptsUsed } = result;\n      \n      if (qualityReport.warnings.length > 0) {\n        res.setHeader(\"X-Quality-Warnings\", JSON.stringify(qualityReport.warnings.map(w => w.message)));\n      }\n      if (postRenderValidation.warnings.length > 0) {\n        res.setHeader(\"X-PostRender-Warnings\", JSON.stringify(postRenderValidation.warnings));\n      }\n      res.setHeader(\"X-Generation-Attempts\", attemptsUsed.toString());\n      \n      const timestamp = Date.now();\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"letter_${timestamp}.docx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"Letter generation error:\", error);\n      res.status(500).json({ error: \"Failed to generate Letter document\", details: error.message });\n    }\n  });\n\n  router.post(\"/render/cv\", async (req, res) => {\n    try {\n      const parseResult = cvSpecSchema.safeParse(req.body);\n      \n      if (!parseResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid CV spec\", \n          details: parseResult.error.flatten().fieldErrors \n        });\n      }\n      \n      const spec = parseResult.data;\n      const templateConfig = selectCvTemplate(spec.template_style || \"modern\");\n      const buffer = await renderCvFromSpec(spec, templateConfig);\n      \n      const timestamp = Date.now();\n      res.setHeader(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"cv_${timestamp}.docx\"`);\n      res.setHeader(\"Content-Length\", buffer.length);\n      res.send(buffer);\n    } catch (error: any) {\n      console.error(\"CV render error:\", error);\n      res.status(500).json({ error: \"Failed to render CV document\", details: error.message });\n    }\n  });\n\n  router.post(\"/plan\", async (req, res) => {\n    try {\n      const { prompt, selectedText, documentContent } = req.body;\n      \n      if (!prompt || typeof prompt !== \"string\") {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n\n      const systemPrompt = `You are a document editing assistant. Given a user's instruction, generate a plan of document editing commands.\n\nAvailable commands:\n- bold: Toggle bold formatting\n- italic: Toggle italic formatting\n- underline: Toggle underline formatting\n- strikethrough: Toggle strikethrough\n- heading1, heading2, heading3: Set heading level\n- paragraph: Set as paragraph\n- bulletList: Toggle bullet list\n- orderedList: Toggle numbered list\n- alignLeft, alignCenter, alignRight, alignJustify: Text alignment\n- insertLink: Insert link (payload: {url: string})\n- insertImage: Insert image (payload: {src: string})\n- insertTable: Insert table (payload: {rows: number, cols: number})\n- blockquote: Toggle blockquote\n- codeBlock: Toggle code block\n- insertHorizontalRule: Insert horizontal line\n- setTextColor: Set text color (payload: {color: string})\n- setHighlight: Highlight text (payload: {color: string})\n- insertText: Insert text (payload: {text: string})\n- replaceSelection: Replace selected text (payload: {content: string})\n- clearFormatting: Remove all formatting\n\nRespond with a JSON object containing:\n{\n  \"intent\": \"brief description of what user wants\",\n  \"commands\": [\n    {\"name\": \"commandName\", \"payload\": {...}, \"description\": \"what this step does\"}\n  ]\n}\n\nOnly respond with valid JSON, no markdown code blocks.`;\n\n      const userMessage = `User instruction: ${prompt}\n${selectedText ? `\\nSelected text: \"${selectedText}\"` : ''}\n${documentContent ? `\\nDocument context (first 500 chars): \"${documentContent.substring(0, 500)}\"` : ''}\n\nGenerate the command plan:`;\n\n      const result = await llmGateway.chat([\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userMessage }\n      ], {\n        temperature: 0.3,\n        maxTokens: 1024,\n      });\n\n      let plan;\n      try {\n        const jsonStr = result.content.replace(/```json\\n?|\\n?```/g, '').trim();\n        plan = JSON.parse(jsonStr);\n      } catch {\n        plan = {\n          intent: prompt,\n          commands: [],\n          error: \"Failed to parse AI response\"\n        };\n      }\n\n      res.json(plan);\n    } catch (error: any) {\n      console.error(\"Document plan error:\", error);\n      res.status(500).json({ error: \"Failed to generate document plan\", details: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":17968,"size_tokens":null},"server/routes/codeRouter.ts":{"content":"import { Router } from \"express\";\nimport * as codeInterpreter from \"../services/codeInterpreterService\";\nimport * as pistonService from \"../services/pistonService\";\n\nexport function createCodeRouter() {\n  const router = Router();\n\n  router.post(\"/api/code-interpreter/run\", async (req, res) => {\n    try {\n      const { code, conversationId, language } = req.body;\n      \n      if (!code || typeof code !== \"string\" || !code.trim()) {\n        return res.status(400).json({ error: \"Code is required\" });\n      }\n\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n\n      const result = await codeInterpreter.executeCode(code, {\n        conversationId,\n        userId,\n        language: language || \"python\",\n      });\n\n      res.json({\n        run: result.run,\n        artifacts: result.artifacts,\n      });\n    } catch (error: any) {\n      console.error(\"Error executing code:\", error);\n      res.status(500).json({ error: \"Failed to execute code\" });\n    }\n  });\n\n  router.get(\"/api/code-interpreter/run/:id\", async (req, res) => {\n    try {\n      const run = await codeInterpreter.getRun(req.params.id);\n      if (!run) {\n        return res.status(404).json({ error: \"Run not found\" });\n      }\n      const artifacts = await codeInterpreter.getRunArtifacts(req.params.id);\n      res.json({ run, artifacts });\n    } catch (error: any) {\n      console.error(\"Error getting run:\", error);\n      res.status(500).json({ error: \"Failed to get run\" });\n    }\n  });\n\n  router.get(\"/api/sandbox/runtimes\", async (req, res) => {\n    try {\n      const runtimes = await pistonService.getSupportedRuntimes();\n      const languages = pistonService.getSupportedLanguages();\n      const aliases = pistonService.getLanguageAliases();\n      \n      res.json({\n        runtimes,\n        supportedLanguages: languages,\n        aliases,\n      });\n    } catch (error: any) {\n      console.error(\"Error fetching runtimes:\", error);\n      res.status(500).json({ error: \"Failed to fetch available runtimes\" });\n    }\n  });\n\n  router.post(\"/api/sandbox/execute\", async (req, res) => {\n    try {\n      const { code, language, stdin, args } = req.body;\n\n      if (!code || typeof code !== \"string\" || !code.trim()) {\n        return res.status(400).json({ error: \"Code is required\" });\n      }\n\n      if (!language || typeof language !== \"string\") {\n        return res.status(400).json({ error: \"Language is required\" });\n      }\n\n      const langInfo = await pistonService.getLanguageInfo(language);\n      if (!langInfo.supported) {\n        const supportedLangs = pistonService.getSupportedLanguages();\n        return res.status(400).json({\n          error: `Unsupported language: ${language}`,\n          supportedLanguages: supportedLangs,\n        });\n      }\n\n      const result = await pistonService.executeCode(\n        language,\n        code,\n        stdin,\n        args\n      );\n\n      res.json({\n        run: result.run,\n        compile: result.compile,\n        errorLines: result.errorLines,\n        language: result.language,\n        version: result.version,\n        usedFallback: result.usedFallback || false,\n        artifacts: result.artifacts || [],\n      });\n    } catch (error: any) {\n      console.error(\"Sandbox execution error:\", error);\n      res.status(500).json({\n        error: \"Failed to execute code\",\n        details: error.message,\n      });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":3400,"size_tokens":null},"client/src/styles/theme.css":{"content":"/* ========================================\n   SIMPLE UI DESIGN SYSTEM\n======================================== */\n\n@theme inline {\n  --radius-sm: calc(var(--radius) - 4px);\n  --radius-md: calc(var(--radius) - 2px);\n  --radius-lg: var(--radius);\n  --radius-xl: calc(var(--radius) + 4px);\n  \n  --color-background: hsl(var(--background));\n  --color-foreground: hsl(var(--foreground));\n  --color-card: hsl(var(--card));\n  --color-card-foreground: hsl(var(--card-foreground));\n  --color-popover: hsl(var(--popover));\n  --color-popover-foreground: hsl(var(--popover-foreground));\n  --color-primary: hsl(var(--primary));\n  --color-primary-foreground: hsl(var(--primary-foreground));\n  --color-secondary: hsl(var(--secondary));\n  --color-secondary-foreground: hsl(var(--secondary-foreground));\n  --color-muted: hsl(var(--muted));\n  --color-muted-foreground: hsl(var(--muted-foreground));\n  --color-accent: hsl(var(--accent));\n  --color-accent-foreground: hsl(var(--accent-foreground));\n  --color-destructive: hsl(var(--destructive));\n  --color-destructive-foreground: hsl(var(--destructive-foreground));\n  --color-border: hsl(var(--border));\n  --color-input: hsl(var(--input));\n  --color-ring: hsl(var(--ring));\n  \n  --color-sidebar: hsl(var(--sidebar));\n  --color-sidebar-foreground: hsl(var(--sidebar-foreground));\n  --color-sidebar-primary: hsl(var(--sidebar-primary));\n  --color-sidebar-primary-foreground: hsl(var(--sidebar-primary-foreground));\n  --color-sidebar-accent: hsl(var(--sidebar-accent));\n  --color-sidebar-accent-foreground: hsl(var(--sidebar-accent-foreground));\n  --color-sidebar-border: hsl(var(--sidebar-border));\n  --color-sidebar-ring: hsl(var(--sidebar-ring));\n}\n\n/* LIGHT MODE - Futuristic Black & White */\n:root {\n  --background: 0 0% 100%;\n  --foreground: 0 0% 5%;\n  \n  --card: 0 0% 100%;\n  --card-foreground: 0 0% 5%;\n  \n  --popover: 0 0% 100%;\n  --popover-foreground: 0 0% 5%;\n  \n  --primary: 0 0% 0%;\n  --primary-foreground: 0 0% 100%;\n  \n  --secondary: 0 0% 96%;\n  --secondary-foreground: 0 0% 10%;\n  \n  --muted: 0 0% 96%;\n  --muted-foreground: 0 0% 45%;\n  \n  --accent: 0 0% 94%;\n  --accent-foreground: 0 0% 10%;\n  \n  --destructive: 0 0% 30%;\n  --destructive-foreground: 0 0% 100%;\n\n  --border: 0 0% 90%;\n  --input: 0 0% 90%;\n  --ring: 0 0% 20%;\n  \n  --radius: 0.5rem;\n\n  /* Sidebar - Futuristic */\n  --sidebar: 0 0% 98%;\n  --sidebar-foreground: 0 0% 20%;\n  --sidebar-primary: 0 0% 0%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 0 0% 94%;\n  --sidebar-accent-foreground: 0 0% 10%;\n  --sidebar-border: 0 0% 90%;\n  --sidebar-ring: 0 0% 30%;\n  \n  --bg-surface-1: 0 0% 100%;\n  --bg-surface-2: 0 0% 98%;\n  --bg-surface-3: 0 0% 96%;\n  --text-primary: 0 0% 5%;\n  --text-secondary: 0 0% 25%;\n  --text-tertiary: 0 0% 45%;\n  --icon-primary: 0 0% 10%;\n  --icon-secondary: 0 0% 35%;\n  --icon-tertiary: 0 0% 55%;\n  --overlay: 0 0% 0% / 0.4;\n  \n  --font-sans: 'Geist', 'Inter', sans-serif;\n}\n\n.dark {\n  --background: 0 0% 4%;\n  --foreground: 0 0% 98%;\n  \n  --card: 0 0% 6%;\n  --card-foreground: 0 0% 98%;\n  \n  --popover: 0 0% 8%;\n  --popover-foreground: 0 0% 98%;\n  \n  --primary: 0 0% 100%;\n  --primary-foreground: 0 0% 4%;\n  \n  --secondary: 0 0% 14%;\n  --secondary-foreground: 0 0% 98%;\n  \n  --muted: 0 0% 14%;\n  --muted-foreground: 0 0% 70%;\n  \n  --accent: 0 0% 18%;\n  --accent-foreground: 0 0% 98%;\n  \n  --destructive: 0 84% 60%;\n  --destructive-foreground: 0 0% 98%;\n  \n  --border: 0 0% 20%;\n  --input: 0 0% 18%;\n  --ring: 0 0% 80%;\n  \n  --sidebar: 0 0% 6%;\n  --sidebar-foreground: 0 0% 95%;\n  --sidebar-primary: 0 0% 100%;\n  --sidebar-primary-foreground: 0 0% 4%;\n  --sidebar-accent: 0 0% 14%;\n  --sidebar-accent-foreground: 0 0% 95%;\n  --sidebar-border: 0 0% 18%;\n  --sidebar-ring: 0 0% 60%;\n  \n  --bg-surface-1: 0 0% 6%;\n  --bg-surface-2: 0 0% 10%;\n  --bg-surface-3: 0 0% 14%;\n  --text-primary: 0 0% 98%;\n  --text-secondary: 0 0% 85%;\n  --text-tertiary: 0 0% 65%;\n  --icon-primary: 0 0% 95%;\n  --icon-secondary: 0 0% 75%;\n  --icon-tertiary: 0 0% 55%;\n  --overlay: 0 0% 0% / 0.6;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n","path":null,"size_bytes":4147,"size_tokens":null},"server/routes/chatAiRouter.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { handleChatRequest, AVAILABLE_MODELS, DEFAULT_PROVIDER, DEFAULT_MODEL } from \"../services/chatService\";\nimport { llmGateway } from \"../lib/llmGateway\";\nimport { generateImage, detectImageRequest, extractImagePrompt } from \"../services/imageGeneration\";\nimport { runETLAgent, getAvailableCountries, getAvailableIndicators } from \"../etl\";\n\nexport function createChatAiRouter(broadcastAgentUpdate: (runId: string, update: any) => void) {\n  const router = Router();\n\n  router.get(\"/models\", (req, res) => {\n    res.json(AVAILABLE_MODELS);\n  });\n\n  router.post(\"/chat\", async (req, res) => {\n    try {\n      const { messages, useRag = true, conversationId, images, gptConfig, documentMode, figmaMode, provider = DEFAULT_PROVIDER, model = DEFAULT_MODEL } = req.body;\n      \n      if (!messages || !Array.isArray(messages)) {\n        return res.status(400).json({ error: \"Messages array is required\" });\n      }\n\n      const formattedMessages = messages.map((msg: { role: string; content: string }) => ({\n        role: msg.role as \"user\" | \"assistant\" | \"system\",\n        content: msg.content\n      }));\n\n      const response = await handleChatRequest(formattedMessages, {\n        useRag,\n        conversationId,\n        images,\n        gptConfig,\n        documentMode,\n        figmaMode,\n        provider,\n        model,\n        onAgentProgress: (update) => broadcastAgentUpdate(update.runId, update)\n      });\n      \n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      if (userId) {\n        try {\n          await storage.createAuditLog({\n            userId,\n            action: \"chat_query\",\n            resource: \"chats\",\n            resourceId: conversationId || null,\n            details: { \n              messageCount: messages.length,\n              useRag,\n              documentMode: documentMode || false,\n              hasImages: !!images && images.length > 0\n            }\n          });\n        } catch (auditError) {\n          console.error(\"Failed to create audit log:\", auditError);\n        }\n      }\n      \n      res.json(response);\n    } catch (error: any) {\n      console.error(\"Chat API error:\", error);\n      res.status(500).json({ \n        error: \"Failed to get AI response\",\n        details: error.message \n      });\n    }\n  });\n\n  router.post(\"/voice-chat\", async (req, res) => {\n    try {\n      const { message } = req.body;\n      \n      if (!message || typeof message !== \"string\") {\n        return res.status(400).json({ error: \"Message is required\" });\n      }\n\n      console.log(\"[VoiceChat] Processing voice input:\", message);\n      \n      const result = await llmGateway.chat([\n        {\n          role: \"system\",\n          content: `Eres Sira, un asistente de voz amigable y conversacional. \nResponde de manera natural y concisa, como si estuvieras hablando directamente con el usuario.\nMantén las respuestas cortas (2-3 oraciones máximo) para que sean fáciles de escuchar.\nUsa un tono cálido y conversacional en español.\nNo uses markdown, emojis ni formatos especiales ya que tu respuesta será leída en voz alta.`\n        },\n        {\n          role: \"user\",\n          content: message\n        }\n      ], {\n        model: \"grok-3-fast\",\n        temperature: 0.7,\n        maxTokens: 150,\n      });\n      \n      res.json({ \n        success: true,\n        response: result.content,\n        latencyMs: result.latencyMs\n      });\n    } catch (error: any) {\n      console.error(\"Voice chat error:\", error);\n      res.status(500).json({ \n        error: \"Failed to process voice message\",\n        details: error.message \n      });\n    }\n  });\n\n  router.post(\"/image/generate\", async (req, res) => {\n    try {\n      const { prompt } = req.body;\n      \n      if (!prompt || typeof prompt !== \"string\") {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n\n      console.log(\"[ImageGen] Generating image for prompt:\", prompt);\n      \n      const result = await generateImage(prompt);\n      \n      res.json({\n        success: true,\n        imageData: `data:${result.mimeType};base64,${result.imageBase64}`,\n        prompt: result.prompt\n      });\n    } catch (error: any) {\n      console.error(\"Image generation error:\", error);\n      res.status(500).json({ \n        error: \"Failed to generate image\",\n        details: error.message \n      });\n    }\n  });\n\n  router.post(\"/image/detect\", (req, res) => {\n    const { message } = req.body;\n    if (!message) {\n      return res.status(400).json({ error: \"Message is required\" });\n    }\n    \n    const isImageRequest = detectImageRequest(message);\n    const extractedPrompt = isImageRequest ? extractImagePrompt(message) : null;\n    \n    res.json({ isImageRequest, extractedPrompt });\n  });\n\n  router.get(\"/etl/config\", async (req, res) => {\n    try {\n      res.json({\n        countries: getAvailableCountries(),\n        indicators: getAvailableIndicators()\n      });\n    } catch (error: any) {\n      console.error(\"ETL config error:\", error);\n      res.status(500).json({ error: \"Failed to get ETL config\" });\n    }\n  });\n\n  router.post(\"/etl/run\", async (req, res) => {\n    try {\n      const { countries, indicators, startDate, endDate } = req.body;\n      \n      if (!countries || !Array.isArray(countries) || countries.length === 0) {\n        return res.status(400).json({ error: \"Countries array is required\" });\n      }\n\n      console.log(\"[ETL API] Starting ETL for countries:\", countries);\n\n      const result = await runETLAgent({\n        countries,\n        indicators,\n        startDate,\n        endDate\n      });\n\n      if (result.success && result.workbookBuffer) {\n        res.setHeader('Content-Type', 'application/zip');\n        res.setHeader('Content-Disposition', `attachment; filename=\"${result.filename}\"`);\n        res.send(result.workbookBuffer);\n      } else {\n        res.status(result.success ? 200 : 500).json({\n          success: result.success,\n          message: result.message,\n          summary: result.summary,\n          errors: result.errors\n        });\n      }\n    } catch (error: any) {\n      console.error(\"ETL API error:\", error);\n      res.status(500).json({ \n        error: \"ETL pipeline failed\",\n        details: error.message \n      });\n    }\n  });\n\n  router.post(\"/chat/stream\", async (req, res) => {\n    const requestId = `stream_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    let heartbeatInterval: NodeJS.Timeout | null = null;\n    let isConnectionClosed = false;\n\n    try {\n      const { messages, conversationId } = req.body;\n      \n      if (!messages || !Array.isArray(messages)) {\n        return res.status(400).json({ error: \"Messages array is required\" });\n      }\n\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n      res.setHeader(\"X-Request-Id\", requestId);\n      res.flushHeaders();\n\n      req.on(\"close\", () => {\n        isConnectionClosed = true;\n        if (heartbeatInterval) {\n          clearInterval(heartbeatInterval);\n        }\n        console.log(`[SSE] Connection closed: ${requestId}`);\n      });\n\n      heartbeatInterval = setInterval(() => {\n        if (!isConnectionClosed) {\n          res.write(`:heartbeat\\n\\n`);\n        }\n      }, 15000);\n\n      const formattedMessages = messages.map((msg: { role: string; content: string }) => ({\n        role: msg.role as \"user\" | \"assistant\" | \"system\",\n        content: msg.content\n      }));\n\n      const systemMessage = {\n        role: \"system\" as const,\n        content: `Eres MICHAT, un asistente de IA avanzado. Responde de manera útil y profesional en el idioma del usuario.`\n      };\n\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n\n      res.write(`event: start\\ndata: ${JSON.stringify({ requestId, timestamp: Date.now() })}\\n\\n`);\n\n      const streamGenerator = llmGateway.streamChat(\n        [systemMessage, ...formattedMessages],\n        {\n          userId: userId || conversationId || \"anonymous\",\n          requestId,\n        }\n      );\n\n      let fullContent = \"\";\n      let lastAckSequence = -1;\n\n      for await (const chunk of streamGenerator) {\n        if (isConnectionClosed) break;\n\n        fullContent += chunk.content;\n        lastAckSequence = chunk.sequenceId;\n\n        if (chunk.done) {\n          res.write(`event: done\\ndata: ${JSON.stringify({\n            sequenceId: chunk.sequenceId,\n            requestId: chunk.requestId,\n            timestamp: Date.now(),\n          })}\\n\\n`);\n        } else {\n          res.write(`event: chunk\\ndata: ${JSON.stringify({\n            content: chunk.content,\n            sequenceId: chunk.sequenceId,\n            requestId: chunk.requestId,\n            timestamp: Date.now(),\n          })}\\n\\n`);\n        }\n      }\n\n      if (!isConnectionClosed) {\n        res.write(`event: complete\\ndata: ${JSON.stringify({ \n          requestId, \n          totalSequences: lastAckSequence + 1,\n          contentLength: fullContent.length,\n          timestamp: Date.now() \n        })}\\n\\n`);\n      }\n\n      if (userId) {\n        try {\n          await storage.createAuditLog({\n            userId,\n            action: \"chat_stream\",\n            resource: \"chats\",\n            resourceId: conversationId || null,\n            details: { \n              messageCount: messages.length,\n              requestId,\n              streaming: true\n            }\n          });\n        } catch (auditError) {\n          console.error(\"Failed to create audit log:\", auditError);\n        }\n      }\n\n    } catch (error: any) {\n      console.error(`[SSE] Stream error ${requestId}:`, error);\n      if (!isConnectionClosed) {\n        try {\n          res.write(`event: error\\ndata: ${JSON.stringify({ \n            error: error.message, \n            requestId,\n            timestamp: Date.now() \n          })}\\n\\n`);\n        } catch (writeError) {\n          console.error(`[SSE] Failed to write error event:`, writeError);\n        }\n      }\n    } finally {\n      if (heartbeatInterval) {\n        clearInterval(heartbeatInterval);\n      }\n      if (!isConnectionClosed) {\n        res.end();\n      }\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":10226,"size_tokens":null},"server/routes/libraryRouter.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\n\nexport function createLibraryRouter() {\n  const router = Router();\n\n  router.get(\"/api/library\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      \n      const mediaType = req.query.type as string | undefined;\n      const items = await storage.getLibraryItems(userId, mediaType);\n      res.json(items);\n    } catch (error: any) {\n      console.error(\"Error getting library items:\", error);\n      res.status(500).json({ error: \"Failed to get library items\" });\n    }\n  });\n\n  router.post(\"/api/library\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      \n      const { mediaType, title, description, storagePath, thumbnailPath, mimeType, size, metadata, sourceChatId } = req.body;\n      \n      if (!mediaType || !title || !storagePath) {\n        return res.status(400).json({ error: \"mediaType, title, and storagePath are required\" });\n      }\n      \n      const item = await storage.createLibraryItem({\n        userId,\n        mediaType,\n        title,\n        description: description || null,\n        storagePath,\n        thumbnailPath: thumbnailPath || null,\n        mimeType: mimeType || null,\n        size: size || null,\n        metadata: metadata || null,\n        sourceChatId: sourceChatId || null,\n      });\n      \n      res.json(item);\n    } catch (error: any) {\n      console.error(\"Error creating library item:\", error);\n      res.status(500).json({ error: \"Failed to create library item\" });\n    }\n  });\n\n  router.delete(\"/api/library/:id\", async (req, res) => {\n    try {\n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      \n      const deleted = await storage.deleteLibraryItem(req.params.id, userId);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Library item not found\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting library item:\", error);\n      res.status(500).json({ error: \"Failed to delete library item\" });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":2530,"size_tokens":null},"client/src/styles/markdown.css":{"content":"/* Markdown Table Styles */\n.prose table {\n  @apply w-full border-collapse my-4 text-sm;\n}\n\n.prose thead {\n  @apply bg-muted;\n}\n\n.prose th {\n  @apply border border-border px-4 py-2 text-left font-semibold;\n}\n\n.prose td {\n  @apply border border-border px-4 py-2;\n}\n\n.prose tr:nth-child(even) {\n  @apply bg-muted/50;\n}\n\n.prose tr:hover {\n  @apply bg-muted/70;\n}\n\n/* Code block styles */\n.prose pre {\n  @apply rounded-lg overflow-x-auto p-4 my-4;\n}\n\n.prose code {\n  @apply px-1.5 py-0.5 rounded bg-muted text-sm;\n}\n\n.prose pre code {\n  @apply p-0 bg-transparent;\n}\n\n/* KaTeX math styles */\n.prose .katex-display {\n  @apply my-4 overflow-x-auto;\n}\n\n.prose .katex {\n  font-size: 1.1em;\n}\n\n/* List styles */\n.prose ul {\n  @apply list-disc pl-6 my-2;\n}\n\n.prose ol {\n  @apply list-decimal pl-6 my-2;\n}\n\n.prose li {\n  @apply my-1;\n}\n\n.prose ul ul, .prose ol ul, .prose ul ol, .prose ol ol {\n  @apply ml-4 my-1;\n}\n\n/* Checklist styles (GFM task lists) */\n.prose ul.contains-task-list {\n  @apply list-none pl-0;\n}\n\n.prose li.task-list-item {\n  @apply flex items-start gap-2;\n}\n\n.prose input[type=\"checkbox\"] {\n  @apply mt-1 h-4 w-4 rounded border-border accent-primary;\n}\n\n/* reStructuredText styles */\n.rst-content h1 { @apply text-2xl font-bold mb-4 mt-6 border-b border-border pb-2; }\n.rst-content h2 { @apply text-xl font-bold mb-3 mt-5; }\n.rst-content h3 { @apply text-lg font-semibold mb-2 mt-4; }\n.rst-content h4 { @apply text-base font-semibold mb-2 mt-3; }\n.rst-content p { @apply mb-3 leading-relaxed; }\n.rst-content pre { @apply rounded-lg overflow-x-auto p-4 my-4 bg-muted; }\n.rst-content code { @apply px-1.5 py-0.5 rounded bg-muted text-sm font-mono; }\n.rst-content pre code { @apply p-0 bg-transparent; }\n.rst-content ul { @apply list-disc pl-6 my-3 space-y-1; }\n.rst-content ol { @apply list-decimal pl-6 my-3 space-y-1; }\n.rst-content li { @apply leading-relaxed; }\n.rst-content blockquote { @apply border-l-4 border-muted-foreground/30 pl-4 italic my-4 text-muted-foreground; }\n.rst-content img { @apply max-w-full h-auto rounded-lg my-4; }\n.rst-content a { @apply text-primary hover:underline; }\n.rst-content .admonition { @apply my-4 p-4 rounded-lg border; }\n.rst-content .admonition.note { @apply bg-blue-500/10 border-blue-500/30; }\n.rst-content .admonition.warning { @apply bg-yellow-500/10 border-yellow-500/30; }\n.rst-content .admonition.tip { @apply bg-green-500/10 border-green-500/30; }\n.rst-content .admonition.danger, .rst-content .admonition.error { @apply bg-red-500/10 border-red-500/30; }\n.rst-content .admonition-title { @apply font-semibold mb-2; }\n.rst-content .role-code { @apply font-mono text-sm bg-muted px-1 rounded; }\n.rst-content .role-emphasis { @apply italic; }\n.rst-content .role-strong { @apply font-bold; }\n","path":null,"size_bytes":2745,"size_tokens":null},"server/routes/userRouter.ts":{"content":"import { Router } from \"express\";\nimport crypto from \"crypto\";\nimport { storage } from \"../storage\";\nimport { db } from \"../db\";\nimport { notificationEventTypes, responsePreferencesSchema, userProfileSchema, featureFlagsSchema, integrationProviders, integrationTools } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nexport function createUserRouter() {\n  const router = Router();\n\n  router.get(\"/api/notification-event-types\", async (req, res) => {\n    try {\n      const eventTypes = await storage.getNotificationEventTypes();\n      res.json(eventTypes);\n    } catch (error: any) {\n      console.error(\"Error getting notification event types:\", error);\n      res.status(500).json({ error: \"Failed to get notification event types\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/notification-preferences\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const eventTypes = await storage.getNotificationEventTypes();\n      const preferences = await storage.getNotificationPreferences(id);\n      \n      const prefsWithEventTypes = eventTypes.map(eventType => {\n        const pref = preferences.find(p => p.eventTypeId === eventType.id);\n        return {\n          eventType,\n          preference: pref || null,\n          enabled: pref ? pref.enabled : eventType.defaultChannels !== 'none',\n          channels: pref ? pref.channels : eventType.defaultChannels\n        };\n      });\n      \n      res.json(prefsWithEventTypes);\n    } catch (error: any) {\n      console.error(\"Error getting notification preferences:\", error);\n      res.status(500).json({ error: \"Failed to get notification preferences\" });\n    }\n  });\n\n  router.put(\"/api/users/:id/notification-preferences\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { eventTypeId, enabled, channels } = req.body;\n      \n      if (!eventTypeId) {\n        return res.status(400).json({ error: \"eventTypeId is required\" });\n      }\n      \n      const preference = await storage.upsertNotificationPreference({\n        userId: id,\n        eventTypeId,\n        enabled: enabled !== undefined ? (enabled ? \"true\" : \"false\") : \"true\",\n        channels: channels || \"push\"\n      });\n      \n      res.json(preference);\n    } catch (error: any) {\n      console.error(\"Error updating notification preference:\", error);\n      res.status(500).json({ error: \"Failed to update notification preference\" });\n    }\n  });\n\n  router.post(\"/api/notification-event-types/seed\", async (req, res) => {\n    try {\n      const eventTypesToSeed = [\n        { id: 'ai_response_ready', name: 'Respuestas de IA', description: 'Notificaciones cuando una respuesta larga está lista', category: 'ai_updates', severity: 'normal', defaultChannels: 'push', sortOrder: 1 },\n        { id: 'task_status_update', name: 'Actualizaciones de tareas', description: 'Cambios en tareas programadas', category: 'tasks', severity: 'normal', defaultChannels: 'push_email', sortOrder: 2 },\n        { id: 'project_invitation', name: 'Invitaciones a proyectos', description: 'Invitaciones a chats compartidos', category: 'social', severity: 'high', defaultChannels: 'push_email', sortOrder: 3 },\n        { id: 'product_recommendation', name: 'Recomendaciones', description: 'Sugerencias personalizadas', category: 'product', severity: 'low', defaultChannels: 'email', sortOrder: 4 },\n        { id: 'feature_announcement', name: 'Novedades', description: 'Nuevas funciones disponibles', category: 'product', severity: 'low', defaultChannels: 'email', sortOrder: 5 }\n      ];\n      \n      const existing = await storage.getNotificationEventTypes();\n      const existingIds = new Set(existing.map(e => e.id));\n      \n      const toInsert = eventTypesToSeed.filter(e => !existingIds.has(e.id));\n      \n      if (toInsert.length > 0) {\n        await db.insert(notificationEventTypes).values(toInsert);\n      }\n      \n      const allEventTypes = await storage.getNotificationEventTypes();\n      res.json({ \n        message: `Seeded ${toInsert.length} new event types`,\n        eventTypes: allEventTypes \n      });\n    } catch (error: any) {\n      console.error(\"Error seeding notification event types:\", error);\n      res.status(500).json({ error: \"Failed to seed notification event types\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/settings\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      \n      if (userId !== id) {\n        return res.status(403).json({ error: \"Access denied: You can only access your own settings\" });\n      }\n      \n      const settings = await storage.getUserSettings(id);\n      \n      if (!settings) {\n        res.json({\n          userId: id,\n          responsePreferences: {\n            responseStyle: 'default',\n            responseTone: 'professional',\n            customInstructions: ''\n          },\n          userProfile: {\n            nickname: '',\n            occupation: '',\n            bio: ''\n          },\n          featureFlags: {\n            memoryEnabled: true,\n            recordingHistoryEnabled: false,\n            webSearchAuto: true,\n            codeInterpreterEnabled: true,\n            canvasEnabled: true,\n            voiceEnabled: true,\n            voiceAdvanced: false,\n            connectorSearchAuto: false\n          }\n        });\n        return;\n      }\n      \n      res.json(settings);\n    } catch (error: any) {\n      console.error(\"Error getting user settings:\", error);\n      res.status(500).json({ error: \"Failed to get user settings\" });\n    }\n  });\n\n  router.put(\"/api/users/:id/settings\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const user = (req as any).user;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      \n      if (userId !== id) {\n        return res.status(403).json({ error: \"Access denied: You can only update your own settings\" });\n      }\n      \n      const { responsePreferences, userProfile, featureFlags } = req.body;\n      \n      const updates: any = {};\n      const validationErrors: string[] = [];\n      \n      if (responsePreferences !== undefined) {\n        const parsed = responsePreferencesSchema.safeParse(responsePreferences);\n        if (!parsed.success) {\n          validationErrors.push(`responsePreferences: ${parsed.error.errors.map(e => e.message).join(', ')}`);\n        } else {\n          updates.responsePreferences = parsed.data;\n        }\n      }\n      \n      if (userProfile !== undefined) {\n        const parsed = userProfileSchema.safeParse(userProfile);\n        if (!parsed.success) {\n          validationErrors.push(`userProfile: ${parsed.error.errors.map(e => e.message).join(', ')}`);\n        } else {\n          updates.userProfile = parsed.data;\n        }\n      }\n      \n      if (featureFlags !== undefined) {\n        const parsed = featureFlagsSchema.safeParse(featureFlags);\n        if (!parsed.success) {\n          validationErrors.push(`featureFlags: ${parsed.error.errors.map(e => e.message).join(', ')}`);\n        } else {\n          updates.featureFlags = parsed.data;\n        }\n      }\n      \n      if (validationErrors.length > 0) {\n        return res.status(400).json({ \n          error: \"Validation failed\", \n          details: validationErrors \n        });\n      }\n      \n      const settings = await storage.upsertUserSettings(id, updates);\n      res.json(settings);\n    } catch (error: any) {\n      console.error(\"Error updating user settings:\", error);\n      res.status(500).json({ error: \"Failed to update user settings\" });\n    }\n  });\n\n  router.get(\"/api/integrations/providers\", async (req, res) => {\n    try {\n      const providers = await storage.getIntegrationProviders();\n      res.json(providers);\n    } catch (error: any) {\n      console.error(\"Error getting providers:\", error);\n      res.status(500).json({ error: \"Failed to get providers\" });\n    }\n  });\n\n  router.get(\"/api/integrations/tools\", async (req, res) => {\n    try {\n      const { providerId } = req.query;\n      const tools = await storage.getIntegrationTools(providerId as string | undefined);\n      res.json(tools);\n    } catch (error: any) {\n      console.error(\"Error getting tools:\", error);\n      res.status(500).json({ error: \"Failed to get tools\" });\n    }\n  });\n\n  router.post(\"/api/integrations/seed\", async (req, res) => {\n    try {\n      const providersToSeed = [\n        {\n          id: \"github\",\n          name: \"GitHub\",\n          description: \"Control de versiones y colaboración de código\",\n          iconUrl: \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",\n          authType: \"oauth2\",\n          authConfig: { authUrl: \"https://github.com/login/oauth/authorize\", tokenUrl: \"https://github.com/login/oauth/access_token\", scopes: [\"repo\", \"user\", \"read:org\"] },\n          category: \"development\",\n          isActive: \"true\"\n        },\n        {\n          id: \"figma\",\n          name: \"Figma\",\n          description: \"Diseño colaborativo y prototipado\",\n          iconUrl: \"https://static.figma.com/app/icon/1/favicon.svg\",\n          authType: \"oauth2\",\n          authConfig: { authUrl: \"https://www.figma.com/oauth\", tokenUrl: \"https://www.figma.com/api/oauth/token\", scopes: [\"file_read\", \"file_write\"] },\n          category: \"design\",\n          isActive: \"true\"\n        },\n        {\n          id: \"canva\",\n          name: \"Canva\",\n          description: \"Diseño gráfico y contenido visual\",\n          iconUrl: \"https://static.canva.com/static/images/canva-logo.svg\",\n          authType: \"oauth2\",\n          authConfig: { authUrl: \"https://www.canva.com/api/oauth/authorize\", tokenUrl: \"https://www.canva.com/api/oauth/token\", scopes: [\"design:content:read\", \"design:content:write\"] },\n          category: \"design\",\n          isActive: \"true\"\n        },\n        {\n          id: \"slack\",\n          name: \"Slack\",\n          description: \"Comunicación y mensajería de equipo\",\n          iconUrl: \"https://a.slack-edge.com/80588/marketing/img/icons/icon_slack_hash_colored.png\",\n          authType: \"oauth2\",\n          authConfig: { authUrl: \"https://slack.com/oauth/v2/authorize\", tokenUrl: \"https://slack.com/api/oauth.v2.access\", scopes: [\"channels:read\", \"chat:write\", \"users:read\"] },\n          category: \"communication\",\n          isActive: \"true\"\n        },\n        {\n          id: \"notion\",\n          name: \"Notion\",\n          description: \"Notas, documentación y gestión de proyectos\",\n          iconUrl: \"https://www.notion.so/images/logo-ios.png\",\n          authType: \"oauth2\",\n          authConfig: { authUrl: \"https://api.notion.com/v1/oauth/authorize\", tokenUrl: \"https://api.notion.com/v1/oauth/token\", scopes: [] },\n          category: \"productivity\",\n          isActive: \"true\"\n        },\n        {\n          id: \"google_drive\",\n          name: \"Google Drive\",\n          description: \"Almacenamiento y documentos en la nube\",\n          iconUrl: \"https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png\",\n          authType: \"oauth2\",\n          authConfig: { authUrl: \"https://accounts.google.com/o/oauth2/v2/auth\", tokenUrl: \"https://oauth2.googleapis.com/token\", scopes: [\"https://www.googleapis.com/auth/drive.readonly\"] },\n          category: \"productivity\",\n          isActive: \"true\"\n        }\n      ];\n\n      for (const provider of providersToSeed) {\n        const existing = await storage.getIntegrationProvider(provider.id);\n        if (!existing) {\n          await db.insert(integrationProviders).values(provider);\n        }\n      }\n\n      const toolsToSeed = [\n        { id: \"github:list_repos\", providerId: \"github\", name: \"Listar repositorios\", description: \"Lista los repositorios del usuario\", requiredScopes: [\"repo\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"github:create_issue\", providerId: \"github\", name: \"Crear issue\", description: \"Crea un nuevo issue en un repositorio\", requiredScopes: [\"repo\"], dataAccessLevel: \"write\", confirmationRequired: \"true\" },\n        { id: \"github:get_file\", providerId: \"github\", name: \"Obtener archivo\", description: \"Lee el contenido de un archivo\", requiredScopes: [\"repo\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"figma:get_file\", providerId: \"figma\", name: \"Obtener archivo\", description: \"Obtiene información de un archivo Figma\", requiredScopes: [\"file_read\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"figma:export_frame\", providerId: \"figma\", name: \"Exportar frame\", description: \"Exporta un frame como imagen\", requiredScopes: [\"file_read\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"canva:list_designs\", providerId: \"canva\", name: \"Listar diseños\", description: \"Lista los diseños del usuario\", requiredScopes: [\"design:content:read\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"canva:export_design\", providerId: \"canva\", name: \"Exportar diseño\", description: \"Exporta un diseño como imagen\", requiredScopes: [\"design:content:read\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"slack:send_message\", providerId: \"slack\", name: \"Enviar mensaje\", description: \"Envía un mensaje a un canal\", requiredScopes: [\"chat:write\"], dataAccessLevel: \"write\", confirmationRequired: \"true\" },\n        { id: \"slack:list_channels\", providerId: \"slack\", name: \"Listar canales\", description: \"Lista los canales disponibles\", requiredScopes: [\"channels:read\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"notion:search\", providerId: \"notion\", name: \"Buscar páginas\", description: \"Busca páginas en el workspace\", requiredScopes: [], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"notion:get_page\", providerId: \"notion\", name: \"Obtener página\", description: \"Obtiene el contenido de una página\", requiredScopes: [], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"google_drive:list_files\", providerId: \"google_drive\", name: \"Listar archivos\", description: \"Lista archivos en Drive\", requiredScopes: [\"https://www.googleapis.com/auth/drive.readonly\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" },\n        { id: \"google_drive:get_file\", providerId: \"google_drive\", name: \"Obtener archivo\", description: \"Obtiene contenido de un archivo\", requiredScopes: [\"https://www.googleapis.com/auth/drive.readonly\"], dataAccessLevel: \"read\", confirmationRequired: \"false\" }\n      ];\n\n      for (const tool of toolsToSeed) {\n        const existing = await db.select().from(integrationTools).where(eq(integrationTools.id, tool.id));\n        if (existing.length === 0) {\n          await db.insert(integrationTools).values({ ...tool, isActive: \"true\" });\n        }\n      }\n\n      const providers = await storage.getIntegrationProviders();\n      const tools = await storage.getIntegrationTools();\n      res.json({ message: \"Catalog seeded\", providers: providers.length, tools: tools.length });\n    } catch (error: any) {\n      console.error(\"Error seeding catalog:\", error);\n      res.status(500).json({ error: \"Failed to seed catalog\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/integrations\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const [accounts, policy, providers] = await Promise.all([\n        storage.getIntegrationAccounts(id),\n        storage.getIntegrationPolicy(id),\n        storage.getIntegrationProviders()\n      ]);\n      \n      res.json({ accounts, policy, providers });\n    } catch (error: any) {\n      console.error(\"Error getting user integrations:\", error);\n      res.status(500).json({ error: \"Failed to get integrations\" });\n    }\n  });\n\n  router.put(\"/api/users/:id/integrations/policy\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const { enabledApps, enabledTools, disabledTools, resourceScopes, autoConfirmPolicy, sandboxMode, maxParallelCalls } = req.body;\n      \n      const policy = await storage.upsertIntegrationPolicy(id, {\n        enabledApps,\n        enabledTools,\n        disabledTools,\n        resourceScopes,\n        autoConfirmPolicy,\n        sandboxMode,\n        maxParallelCalls\n      });\n      \n      res.json(policy);\n    } catch (error: any) {\n      console.error(\"Error updating policy:\", error);\n      res.status(500).json({ error: \"Failed to update policy\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/integrations/:provider/connect\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id, provider } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const providerInfo = await storage.getIntegrationProvider(provider);\n      if (!providerInfo) return res.status(404).json({ error: \"Provider not found\" });\n      \n      res.json({ \n        message: \"OAuth flow not yet implemented\",\n        provider: providerInfo.name,\n        authType: providerInfo.authType\n      });\n    } catch (error: any) {\n      console.error(\"Error initiating connect:\", error);\n      res.status(500).json({ error: \"Failed to initiate connection\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/integrations/:provider/disconnect\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id, provider } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const account = await storage.getIntegrationAccountByProvider(id, provider);\n      if (!account) return res.status(404).json({ error: \"Account not found\" });\n      \n      await storage.deleteIntegrationAccount(account.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error disconnecting:\", error);\n      res.status(500).json({ error: \"Failed to disconnect\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/integrations/logs\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const limit = parseInt(req.query.limit as string) || 50;\n      const logs = await storage.getToolCallLogs(id, limit);\n      res.json(logs);\n    } catch (error: any) {\n      console.error(\"Error getting logs:\", error);\n      res.status(500).json({ error: \"Failed to get logs\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/privacy\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const settings = await storage.getUserSettings(id);\n      const logs = await storage.getConsentLogs(id, 10);\n      res.json({ \n        privacySettings: settings?.privacySettings || { trainingOptIn: false, remoteBrowserDataAccess: false },\n        consentHistory: logs\n      });\n    } catch (error: any) {\n      console.error(\"Error getting privacy settings:\", error);\n      res.status(500).json({ error: \"Failed to get privacy settings\" });\n    }\n  });\n\n  router.put(\"/api/users/:id/privacy\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const { trainingOptIn, remoteBrowserDataAccess } = req.body;\n      const ipAddress = req.ip || (req.headers['x-forwarded-for'] as string)?.split(',')[0] || undefined;\n      const userAgent = req.headers['user-agent'] || undefined;\n      \n      if (trainingOptIn !== undefined) {\n        await storage.logConsent(id, 'training_opt_in', String(trainingOptIn), ipAddress, userAgent);\n      }\n      if (remoteBrowserDataAccess !== undefined) {\n        await storage.logConsent(id, 'remote_browser_access', String(remoteBrowserDataAccess), ipAddress, userAgent);\n      }\n      \n      const settings = await storage.upsertUserSettings(id, {\n        privacySettings: { trainingOptIn: trainingOptIn ?? false, remoteBrowserDataAccess: remoteBrowserDataAccess ?? false }\n      });\n      \n      res.json(settings);\n    } catch (error: any) {\n      console.error(\"Error updating privacy settings:\", error);\n      res.status(500).json({ error: \"Failed to update privacy settings\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/shared-links\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const links = await storage.getSharedLinks(id);\n      res.json(links);\n    } catch (error: any) {\n      console.error(\"Error getting shared links:\", error);\n      res.status(500).json({ error: \"Failed to get shared links\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/shared-links\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const { resourceType, resourceId, scope, permissions, expiresAt } = req.body;\n      \n      if (!resourceType || !resourceId) {\n        return res.status(400).json({ error: \"Missing required fields: resourceType, resourceId\" });\n      }\n      \n      const token = crypto.randomBytes(32).toString('hex');\n      \n      const link = await storage.createSharedLink({\n        userId: id,\n        resourceType,\n        resourceId,\n        token,\n        scope: scope || 'link_only',\n        permissions: permissions || 'read',\n        expiresAt: expiresAt ? new Date(expiresAt) : undefined,\n        isRevoked: 'false'\n      });\n      \n      res.json(link);\n    } catch (error: any) {\n      console.error(\"Error creating shared link:\", error);\n      res.status(500).json({ error: \"Failed to create shared link\" });\n    }\n  });\n\n  router.delete(\"/api/users/:id/shared-links/:linkId\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id, linkId } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      await storage.revokeSharedLink(linkId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error revoking shared link:\", error);\n      res.status(500).json({ error: \"Failed to revoke shared link\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/shared-links/:linkId/rotate\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id, linkId } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const link = await storage.rotateSharedLinkToken(linkId);\n      res.json(link);\n    } catch (error: any) {\n      console.error(\"Error rotating shared link token:\", error);\n      res.status(500).json({ error: \"Failed to rotate shared link token\" });\n    }\n  });\n\n  router.patch(\"/api/users/:id/shared-links/:linkId\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id, linkId } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const { scope, permissions } = req.body;\n      \n      const link = await storage.updateSharedLink(linkId, { scope, permissions });\n      res.json(link);\n    } catch (error: any) {\n      console.error(\"Error updating shared link:\", error);\n      res.status(500).json({ error: \"Failed to update shared link\" });\n    }\n  });\n\n  router.get(\"/api/shared/:token\", async (req, res) => {\n    try {\n      const { token } = req.params;\n      \n      const link = await storage.getSharedLinkByToken(token);\n      \n      if (!link) {\n        return res.status(404).json({ error: \"Shared link not found\" });\n      }\n      \n      if (link.isRevoked === 'true') {\n        return res.status(410).json({ error: \"This shared link has been revoked\" });\n      }\n      \n      if (link.expiresAt && new Date(link.expiresAt) < new Date()) {\n        return res.status(410).json({ error: \"This shared link has expired\" });\n      }\n      \n      await storage.incrementSharedLinkAccess(link.id);\n      \n      res.json({\n        resourceType: link.resourceType,\n        resourceId: link.resourceId,\n        scope: link.scope,\n        permissions: link.permissions,\n        accessCount: (link.accessCount || 0) + 1\n      });\n    } catch (error: any) {\n      console.error(\"Error accessing shared link:\", error);\n      res.status(500).json({ error: \"Failed to access shared link\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/chats/archived\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const chats = await storage.getArchivedChats(id);\n      res.json(chats);\n    } catch (error: any) {\n      console.error(\"Error getting archived chats:\", error);\n      res.status(500).json({ error: \"Failed to get archived chats\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/chats/:chatId/unarchive\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id, chatId } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      await storage.unarchiveChat(chatId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error unarchiving chat:\", error);\n      res.status(500).json({ error: \"Failed to unarchive chat\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/chats/archive-all\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const count = await storage.archiveAllChats(id);\n      res.json({ count });\n    } catch (error: any) {\n      console.error(\"Error archiving all chats:\", error);\n      res.status(500).json({ error: \"Failed to archive all chats\" });\n    }\n  });\n\n  router.get(\"/api/users/:id/chats/deleted\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const chats = await storage.getDeletedChats(id);\n      res.json(chats);\n    } catch (error: any) {\n      console.error(\"Error getting deleted chats:\", error);\n      res.status(500).json({ error: \"Failed to get deleted chats\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/chats/delete-all\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      const count = await storage.softDeleteAllChats(id);\n      \n      const links = await storage.getSharedLinks(id);\n      for (const link of links) {\n        if (link.resourceType === 'chat') {\n          await storage.revokeSharedLink(link.id);\n        }\n      }\n      \n      res.json({ count });\n    } catch (error: any) {\n      console.error(\"Error deleting all chats:\", error);\n      res.status(500).json({ error: \"Failed to delete all chats\" });\n    }\n  });\n\n  router.post(\"/api/users/:id/chats/:chatId/restore\", async (req, res) => {\n    try {\n      const authUserId = (req as any).user?.claims?.sub;\n      if (!authUserId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { id, chatId } = req.params;\n      if (authUserId !== id) return res.status(403).json({ error: \"Forbidden\" });\n      \n      await storage.restoreDeletedChat(chatId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error restoring chat:\", error);\n      res.status(500).json({ error: \"Failed to restore chat\" });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":30012,"size_tokens":null},"server/routes/agentRouter.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { agentOrchestrator, guardrails } from \"../agent\";\nimport { browserSessionManager, SessionEvent } from \"../agent/browser\";\n\nexport function createAgentRouter(broadcastBrowserEvent: (sessionId: string, event: SessionEvent) => void) {\n  const router = Router();\n\n  router.get(\"/agent/runs/:id\", async (req, res) => {\n    try {\n      const run = await storage.getAgentRun(req.params.id);\n      if (!run) {\n        return res.status(404).json({ error: \"Run not found\" });\n      }\n      const steps = await storage.getAgentSteps(req.params.id);\n      const assets = await storage.getAgentAssets(req.params.id);\n      res.json({ run, steps, assets });\n    } catch (error: any) {\n      res.status(500).json({ error: \"Failed to get agent run\" });\n    }\n  });\n\n  router.post(\"/agent/runs/:id/cancel\", async (req, res) => {\n    try {\n      const success = agentOrchestrator.cancelRun(req.params.id);\n      if (success) {\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ error: \"Run not found or already completed\" });\n      }\n    } catch (error: any) {\n      res.status(500).json({ error: \"Failed to cancel run\" });\n    }\n  });\n\n  router.post(\"/browser/session\", async (req, res) => {\n    try {\n      const { objective, config } = req.body;\n      if (!objective) {\n        return res.status(400).json({ error: \"Objective is required\" });\n      }\n      \n      const sessionId = await browserSessionManager.createSession(\n        objective,\n        config || {},\n        (event: SessionEvent) => {\n          broadcastBrowserEvent(event.sessionId, event);\n        }\n      );\n      \n      browserSessionManager.startScreenshotStreaming(sessionId, 1500);\n      \n      res.json({ sessionId });\n    } catch (error: any) {\n      console.error(\"Error creating browser session:\", error);\n      res.status(500).json({ error: \"Failed to create browser session\" });\n    }\n  });\n\n  router.post(\"/browser/session/:id/navigate\", async (req, res) => {\n    try {\n      const { url } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"navigate\", url);\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.navigate(req.params.id, url);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/browser/session/:id/click\", async (req, res) => {\n    try {\n      const { selector } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"click\", selector);\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.click(req.params.id, selector);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/browser/session/:id/type\", async (req, res) => {\n    try {\n      const { selector, text } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"type\", selector, { text });\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.type(req.params.id, selector, text);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/browser/session/:id/scroll\", async (req, res) => {\n    try {\n      const { direction, amount } = req.body;\n      const validation = await guardrails.validateAction(req.params.id, \"scroll\", \"page\");\n      if (!validation.allowed) {\n        return res.status(403).json({ error: validation.reason, blocked: true });\n      }\n      const result = await browserSessionManager.scroll(req.params.id, direction, amount);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/browser/session/:id/state\", async (req, res) => {\n    try {\n      const state = await browserSessionManager.getPageState(req.params.id);\n      if (!state) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n      res.json(state);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/browser/session/:id/screenshot\", async (req, res) => {\n    try {\n      const screenshot = await browserSessionManager.getScreenshot(req.params.id);\n      if (!screenshot) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n      res.json({ screenshot });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.get(\"/browser/session/:id\", async (req, res) => {\n    try {\n      const session = browserSessionManager.getSession(req.params.id);\n      if (!session) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n      res.json(session);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.delete(\"/browser/session/:id\", async (req, res) => {\n    try {\n      await browserSessionManager.closeSession(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  router.post(\"/browser/session/:id/cancel\", async (req, res) => {\n    try {\n      browserSessionManager.cancelSession(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":5771,"size_tokens":null},"client/src/styles/animations.css":{"content":"/* Thinking wave animation - Futuristic B&W */\n@keyframes thinkingWave {\n  0%, 100% { opacity: 0.4; }\n  50% { opacity: 1; }\n}\n\n@keyframes letterWave {\n  0%, 100% { transform: translateY(0); opacity: 0.6; }\n  50% { transform: translateY(-2px); opacity: 1; }\n}\n\n.thinking-wave {\n  display: inline-flex;\n  font-weight: 300;\n  font-size: 0.95em;\n  letter-spacing: 0.5px;\n  position: relative;\n  color: #000000;\n  background: linear-gradient(\n    90deg, \n    #000000 0%, \n    #444444 25%, \n    #888888 50%, \n    #444444 75%, \n    #000000 100%\n  );\n  background-size: 300% 100%;\n  -webkit-background-clip: text;\n  -webkit-text-fill-color: transparent;\n  background-clip: text;\n  animation: shimmerWave 2.5s ease-in-out infinite;\n}\n\n.dark .thinking-wave {\n  color: #ffffff;\n  background: linear-gradient(\n    90deg, \n    #ffffff 0%, \n    #aaaaaa 25%, \n    #666666 50%, \n    #aaaaaa 75%, \n    #ffffff 100%\n  );\n  background-size: 300% 100%;\n  -webkit-background-clip: text;\n  -webkit-text-fill-color: transparent;\n  background-clip: text;\n}\n\n@keyframes shimmerWave {\n  0% { background-position: 100% 50%; }\n  100% { background-position: -100% 50%; }\n}\n\n@keyframes waveGradient {\n  0% { background-position: 0% 50%; }\n  50% { background-position: 100% 50%; }\n  100% { background-position: 0% 50%; }\n}\n\n/* Thinking cursor - elegant blinking - Futuristic B&W */\n@keyframes cursorPulse {\n  0%, 100% { opacity: 0; transform: scaleY(0.8); }\n  50% { opacity: 1; transform: scaleY(1); }\n}\n\n.thinking-cursor {\n  display: inline-block;\n  font-weight: 200;\n  font-size: 1.1em;\n  color: hsl(var(--foreground));\n  animation: cursorPulse 1s ease-in-out infinite;\n  margin-left: 2px;\n}\n\n/* Typing cursor animation */\n@keyframes cursorBlink {\n  0%, 50% { opacity: 1; }\n  51%, 100% { opacity: 0; }\n}\n\n.typing-cursor {\n  display: inline-block;\n  font-weight: bold;\n  font-size: 1.1em;\n  color: hsl(var(--foreground));\n  animation: cursorBlink 0.8s step-end infinite;\n  margin-left: 1px;\n  vertical-align: baseline;\n}\n\n/* ========================================\n   LIQUID BUTTON EFFECTS\n======================================== */\n\n.liquid-button {\n  position: relative;\n  overflow: hidden;\n  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);\n  transform-origin: center;\n}\n\n.liquid-button::before {\n  content: '';\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 0;\n  height: 0;\n  background: radial-gradient(circle, hsl(var(--foreground) / 0.1) 0%, transparent 70%);\n  border-radius: 50%;\n  transform: translate(-50%, -50%);\n  transition: width 0.4s ease, height 0.4s ease;\n  pointer-events: none;\n}\n\n.liquid-button:hover::before {\n  width: 200%;\n  height: 200%;\n}\n\n.liquid-button:hover {\n  transform: scale(1.02) translateY(-1px);\n  background-color: hsl(var(--foreground) / 0.05) !important;\n}\n\n.liquid-button:active {\n  transform: scale(0.97);\n  transition: transform 0.08s ease;\n}\n\n.liquid-button:active::before {\n  background: radial-gradient(circle, hsl(var(--foreground) / 0.2) 0%, transparent 60%);\n  width: 250%;\n  height: 250%;\n}\n\n/* Ripple effect on click */\n@keyframes liquidRipple {\n  0% {\n    transform: translate(-50%, -50%) scale(0);\n    opacity: 0.6;\n  }\n  100% {\n    transform: translate(-50%, -50%) scale(2.5);\n    opacity: 0;\n  }\n}\n\n.liquid-button::after {\n  content: '';\n  position: absolute;\n  top: var(--ripple-y, 50%);\n  left: var(--ripple-x, 50%);\n  width: 100%;\n  height: 100%;\n  background: radial-gradient(circle, hsl(var(--foreground) / 0.15) 0%, transparent 50%);\n  border-radius: 50%;\n  transform: translate(-50%, -50%) scale(0);\n  pointer-events: none;\n  opacity: 0;\n}\n\n.liquid-button.rippling::after {\n  animation: liquidRipple 0.5s ease-out forwards;\n}\n\n/* Icon animation on hover */\n.liquid-button svg {\n  transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.liquid-button:hover svg {\n  transform: scale(1.1);\n}\n\n.liquid-button:active svg {\n  transform: scale(0.9);\n}\n\n/* Liquid Float Animation for Document Tool Icons */\n@keyframes liquid-float {\n  0%, 100% {\n    transform: translateY(0) scale(1);\n    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;\n  }\n  25% {\n    transform: translateY(-2px) scale(1.02);\n    border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%;\n  }\n  50% {\n    transform: translateY(0) scale(1);\n    border-radius: 30% 70% 50% 50% / 50% 30% 70% 50%;\n  }\n  75% {\n    transform: translateY(-1px) scale(1.01);\n    border-radius: 50% 50% 30% 70% / 30% 70% 50% 50%;\n  }\n}\n\n/* Liquid shine effect */\n@keyframes liquid-shine {\n  0% {\n    background-position: -100% 0;\n  }\n  100% {\n    background-position: 200% 0;\n  }\n}\n","path":null,"size_bytes":4560,"size_tokens":null},"client/src/styles/mobile.css":{"content":"/* ========================================\n   iPhone / Mobile Optimizations\n   iPhone 17 Pro Max: ~430px width\n   iPhone 17 Pro: ~393px width\n   iPhone 17: ~390px width\n======================================== */\n\n/* Base mobile styles */\n@media screen and (max-width: 480px) {\n  /* Improve touch targets - minimum 44px for iOS */\n  button, \n  [role=\"button\"],\n  a,\n  input[type=\"submit\"],\n  input[type=\"button\"] {\n    min-height: 44px;\n    min-width: 44px;\n  }\n\n  /* Optimize font sizes for mobile readability */\n  html {\n    font-size: 16px; /* Prevent zoom on input focus */\n    -webkit-text-size-adjust: 100%;\n  }\n\n  body {\n    -webkit-tap-highlight-color: transparent;\n    -webkit-touch-callout: none;\n  }\n\n  /* Prevent horizontal scroll */\n  .prose pre {\n    max-width: calc(100vw - 2rem);\n    overflow-x: auto;\n  }\n\n  /* Optimize message bubbles for mobile */\n  .liquid-message-user,\n  .liquid-message-ai,\n  .liquid-message-ai-light {\n    max-width: 90%;\n    padding: 12px 16px;\n  }\n\n  /* Larger touch-friendly buttons */\n  .liquid-btn {\n    padding: 14px 20px;\n    font-size: 16px;\n  }\n\n  /* Optimize input fields for mobile */\n  .liquid-input,\n  .liquid-input-light {\n    font-size: 16px; /* Prevents zoom on iOS */\n    padding: 14px 16px;\n  }\n\n  /* Floating label adjustments for mobile */\n  .floating-label input {\n    font-size: 16px;\n    padding: 14px 16px;\n    padding-left: 2.75rem;\n  }\n\n  /* Card spacing for mobile */\n  .glass-card,\n  .glass-card-light {\n    border-radius: 12px;\n    padding: 16px;\n  }\n\n  /* Safe area insets for iPhone notch/Dynamic Island */\n  .safe-area-top {\n    padding-top: env(safe-area-inset-top, 0);\n  }\n\n  .safe-area-bottom {\n    padding-bottom: env(safe-area-inset-bottom, 0);\n  }\n\n  .safe-area-left {\n    padding-left: env(safe-area-inset-left, 0);\n  }\n\n  .safe-area-right {\n    padding-right: env(safe-area-inset-right, 0);\n  }\n}\n\n/* iPhone Pro Max and larger phones (430px) */\n@media screen and (min-width: 414px) and (max-width: 480px) {\n  .prose {\n    font-size: 16px;\n    line-height: 1.6;\n  }\n}\n\n/* iPhone Pro and standard sizes (390-393px) */\n@media screen and (max-width: 413px) {\n  .prose {\n    font-size: 15px;\n    line-height: 1.55;\n  }\n\n  /* Compact spacing for smaller screens */\n  .glass-card,\n  .glass-card-light {\n    padding: 12px;\n  }\n}\n\n/* iPhone SE and smaller (375px and below) */\n@media screen and (max-width: 375px) {\n  .prose {\n    font-size: 14px;\n    line-height: 1.5;\n  }\n\n  .liquid-message-user,\n  .liquid-message-ai,\n  .liquid-message-ai-light {\n    padding: 10px 14px;\n  }\n}\n\n/* Landscape orientation on mobile */\n@media screen and (max-height: 500px) and (orientation: landscape) {\n  .safe-area-top {\n    padding-top: 0;\n  }\n}\n\n/* iOS-specific fixes */\n@supports (-webkit-touch-callout: none) {\n  /* Fix for iOS rubber-banding */\n  body {\n    overscroll-behavior: none;\n  }\n\n  /* Smoother scrolling on iOS */\n  .liquid-scroll {\n    -webkit-overflow-scrolling: touch;\n  }\n\n  /* Fix position:fixed issues on iOS */\n  .fixed-bottom {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding-bottom: env(safe-area-inset-bottom, 0);\n  }\n}\n\n/* High contrast for visibility on OLED screens */\n@media (prefers-contrast: high) {\n  .dark {\n    --border: 0 0% 30%;\n  }\n}\n\n/* Reduce motion for accessibility */\n@media (prefers-reduced-motion: reduce) {\n  .liquid-button,\n  .liquid-hover,\n  .thinking-wave,\n  .thinking-cursor,\n  .typing-cursor {\n    animation: none;\n    transition: none;\n  }\n}\n","path":null,"size_bytes":3478,"size_tokens":null},"server/routes/filesRouter.ts":{"content":"import { Router } from \"express\";\nimport { storage } from \"../storage\";\nimport { ObjectStorageService, ObjectNotFoundError, objectStorageClient } from \"../objectStorage\";\nimport { ALLOWED_MIME_TYPES, ALLOWED_EXTENSIONS, FILE_UPLOAD_CONFIG, LIMITS } from \"../lib/constants\";\nimport { fileProcessingQueue } from \"../lib/fileProcessingQueue\";\nimport { processDocument } from \"../services/documentProcessing\";\nimport { chunkText, generateEmbeddingsBatch } from \"../embeddingService\";\n\ninterface MultipartUploadSession {\n  uploadId: string;\n  fileName: string;\n  mimeType: string;\n  fileSize: number;\n  totalChunks: number;\n  storagePath: string;\n  basePath: string;\n  bucketName: string;\n  uploadedParts: Map<number, string>;\n  createdAt: Date;\n}\n\nconst multipartSessions: Map<string, MultipartUploadSession> = new Map();\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n  return { bucketName, objectName };\n}\n\nasync function signObjectURLForMultipart({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}`\n    );\n  }\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n\nasync function processFileAsync(fileId: string, storagePath: string, mimeType: string, filename?: string) {\n  try {\n    const objectStorageService = new ObjectStorageService();\n    const objectFile = await objectStorageService.getObjectEntityFile(storagePath);\n    const content = await objectStorageService.getFileContent(objectFile);\n    \n    const result = await processDocument(content, mimeType, filename);\n    const chunks = chunkText(result.text, 1500, 150);\n    \n    const chunksWithoutEmbeddings = chunks.map((chunk) => ({\n      fileId,\n      content: chunk.content,\n      embedding: null,\n      chunkIndex: chunk.chunkIndex,\n      pageNumber: chunk.pageNumber || null,\n      metadata: null,\n    }));\n    \n    await storage.createFileChunks(chunksWithoutEmbeddings);\n    await storage.updateFileStatus(fileId, \"ready\");\n    \n    console.log(`File ${fileId} processed: ${chunks.length} chunks created (fast mode)`);\n    \n    generateEmbeddingsAsync(fileId, chunks);\n  } catch (error) {\n    console.error(`Error processing file ${fileId}:`, error);\n    await storage.updateFileStatus(fileId, \"error\");\n  }\n}\n\nasync function generateEmbeddingsAsync(fileId: string, chunks: { content: string; chunkIndex: number; pageNumber?: number }[]) {\n  try {\n    const texts = chunks.map(c => c.content);\n    const embeddings = await generateEmbeddingsBatch(texts);\n    \n    for (let i = 0; i < chunks.length; i++) {\n      await storage.updateFileChunkEmbedding(fileId, chunks[i].chunkIndex, embeddings[i]);\n    }\n    console.log(`File ${fileId} embeddings generated asynchronously`);\n  } catch (error) {\n    console.error(`Error generating embeddings for file ${fileId}:`, error);\n  }\n}\n\nexport function createFilesRouter() {\n  const router = Router();\n  const objectStorageService = new ObjectStorageService();\n\n  router.get(\"/api/files\", async (req, res) => {\n    try {\n      const files = await storage.getFiles();\n      res.json(files);\n    } catch (error: any) {\n      console.error(\"Error getting files:\", error);\n      res.status(500).json({ error: \"Failed to get files\" });\n    }\n  });\n\n  router.post(\"/api/objects/upload\", async (req, res) => {\n    try {\n      const { uploadURL, storagePath } = await objectStorageService.getObjectEntityUploadURLWithPath();\n      res.json({ uploadURL, storagePath });\n    } catch (error: any) {\n      console.error(\"Error getting upload URL:\", error);\n      res.status(500).json({ error: \"Failed to get upload URL\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/create\", async (req, res) => {\n    try {\n      const { fileName, mimeType, fileSize, totalChunks } = req.body;\n\n      if (!fileName || !mimeType || !fileSize || !totalChunks) {\n        return res.status(400).json({ error: \"Missing required fields: fileName, mimeType, fileSize, totalChunks\" });\n      }\n\n      if (!ALLOWED_MIME_TYPES.includes(mimeType as any)) {\n        return res.status(400).json({ error: `Unsupported file type: ${mimeType}` });\n      }\n\n      if (fileSize > LIMITS.MAX_FILE_SIZE_BYTES) {\n        return res.status(400).json({ error: `File size exceeds maximum limit of ${LIMITS.MAX_FILE_SIZE_MB}MB` });\n      }\n\n      const uploadId = `multipart_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;\n      const privateObjectDir = objectStorageService.getPrivateObjectDir();\n      const objectId = `uploads/${uploadId}`;\n      const storagePath = `/objects/${objectId}`;\n\n      const session: MultipartUploadSession = {\n        uploadId,\n        fileName,\n        mimeType,\n        fileSize,\n        totalChunks,\n        storagePath,\n        basePath: `${privateObjectDir}/${objectId}`,\n        bucketName: privateObjectDir.split('/')[1] || '',\n        uploadedParts: new Map(),\n        createdAt: new Date(),\n      };\n\n      multipartSessions.set(uploadId, session);\n\n      res.json({ uploadId, storagePath });\n    } catch (error: any) {\n      console.error(\"Error creating multipart upload:\", error);\n      res.status(500).json({ error: \"Failed to create multipart upload session\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/sign-part\", async (req, res) => {\n    try {\n      const { uploadId, partNumber } = req.body;\n\n      if (!uploadId || partNumber === undefined) {\n        return res.status(400).json({ error: \"Missing required fields: uploadId, partNumber\" });\n      }\n\n      const session = multipartSessions.get(uploadId);\n      if (!session) {\n        return res.status(404).json({ error: \"Upload session not found\" });\n      }\n\n      if (partNumber < 1 || partNumber > session.totalChunks) {\n        return res.status(400).json({ error: `Invalid part number. Must be between 1 and ${session.totalChunks}` });\n      }\n\n      const partPath = `${session.basePath}_part_${partNumber}`;\n      const { bucketName, objectName } = parseObjectPath(partPath);\n      \n      const signedUrl = await signObjectURLForMultipart({\n        bucketName,\n        objectName,\n        method: \"PUT\",\n        ttlSec: 900,\n      });\n\n      res.json({ signedUrl });\n    } catch (error: any) {\n      console.error(\"Error signing multipart part:\", error);\n      res.status(500).json({ error: \"Failed to get signed URL for part\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/complete\", async (req, res) => {\n    try {\n      const { uploadId, parts } = req.body;\n\n      if (!uploadId || !parts || !Array.isArray(parts)) {\n        return res.status(400).json({ error: \"Missing required fields: uploadId, parts\" });\n      }\n\n      const session = multipartSessions.get(uploadId);\n      if (!session) {\n        return res.status(404).json({ error: \"Upload session not found\" });\n      }\n\n      const { bucketName } = parseObjectPath(session.basePath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      \n      const partPaths = parts\n        .sort((a: { partNumber: number }, b: { partNumber: number }) => a.partNumber - b.partNumber)\n        .map((p: { partNumber: number }) => {\n          const partPath = `${session.basePath}_part_${p.partNumber}`;\n          const { objectName } = parseObjectPath(partPath);\n          return objectName;\n        });\n\n      const { objectName: finalObjectName } = parseObjectPath(session.basePath);\n      const destinationFile = bucket.file(finalObjectName);\n\n      try {\n        await bucket.combine(\n          partPaths.map(p => bucket.file(p)),\n          destinationFile\n        );\n        \n        await destinationFile.setMetadata({ contentType: session.mimeType });\n\n        for (const partPath of partPaths) {\n          try {\n            await bucket.file(partPath).delete();\n          } catch (e) {\n            console.warn(`Failed to delete part ${partPath}:`, e);\n          }\n        }\n      } catch (composeError: any) {\n        console.error(\"Failed to compose parts:\", composeError);\n        return res.status(500).json({ error: \"Failed to compose file parts\" });\n      }\n\n      multipartSessions.delete(uploadId);\n\n      const file = await storage.createFile({\n        name: session.fileName,\n        type: session.mimeType,\n        size: session.fileSize,\n        storagePath: session.storagePath,\n        status: \"processing\",\n        userId: null,\n      });\n\n      await storage.createFileJob({\n        fileId: file.id,\n        status: \"pending\",\n      });\n\n      fileProcessingQueue.enqueue({\n        fileId: file.id,\n        storagePath: session.storagePath,\n        mimeType: session.mimeType,\n        fileName: session.fileName,\n      });\n\n      res.json({ success: true, storagePath: session.storagePath, fileId: file.id });\n    } catch (error: any) {\n      console.error(\"Error completing multipart upload:\", error);\n      res.status(500).json({ error: \"Failed to complete multipart upload\" });\n    }\n  });\n\n  router.post(\"/api/objects/multipart/abort\", async (req, res) => {\n    try {\n      const { uploadId } = req.body;\n\n      if (!uploadId) {\n        return res.status(400).json({ error: \"Missing required field: uploadId\" });\n      }\n\n      const session = multipartSessions.get(uploadId);\n      if (!session) {\n        return res.status(404).json({ error: \"Upload session not found\" });\n      }\n\n      const { bucketName } = parseObjectPath(session.basePath);\n      const bucket = objectStorageClient.bucket(bucketName);\n\n      for (let i = 1; i <= session.totalChunks; i++) {\n        const partPath = `${session.basePath}_part_${i}`;\n        const { objectName } = parseObjectPath(partPath);\n        try {\n          await bucket.file(objectName).delete();\n        } catch (e) {\n        }\n      }\n\n      multipartSessions.delete(uploadId);\n\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error aborting multipart upload:\", error);\n      res.status(500).json({ error: \"Failed to abort multipart upload\" });\n    }\n  });\n\n  router.get(\"/api/files/config\", (req, res) => {\n    res.json({\n      allowedMimeTypes: [...ALLOWED_MIME_TYPES],\n      allowedExtensions: ALLOWED_EXTENSIONS,\n      maxFileSize: LIMITS.MAX_FILE_SIZE_BYTES,\n      maxFileSizeMB: LIMITS.MAX_FILE_SIZE_MB,\n      chunkSize: FILE_UPLOAD_CONFIG.CHUNK_SIZE_BYTES,\n      chunkSizeMB: FILE_UPLOAD_CONFIG.CHUNK_SIZE_MB,\n      maxParallelChunks: FILE_UPLOAD_CONFIG.MAX_PARALLEL_CHUNKS,\n    });\n  });\n\n  router.post(\"/api/files/quick\", async (req, res) => {\n    try {\n      const { name, type, size, storagePath } = req.body;\n\n      if (!name || !type || !size || !storagePath) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      const file = await storage.createFile({\n        name,\n        type,\n        size,\n        storagePath,\n        status: \"ready\",\n        userId: null,\n      });\n\n      res.json(file);\n    } catch (error: any) {\n      console.error(\"Error creating quick file:\", error);\n      res.status(500).json({ error: \"Failed to create file\" });\n    }\n  });\n\n  router.post(\"/api/files\", async (req, res) => {\n    try {\n      const { name, type, size, storagePath } = req.body;\n\n      if (!name || !type || !size || !storagePath) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      if (!ALLOWED_MIME_TYPES.includes(type)) {\n        return res.status(400).json({ error: `Unsupported file type: ${type}` });\n      }\n\n      const file = await storage.createFile({\n        name,\n        type,\n        size,\n        storagePath,\n        status: \"processing\",\n        userId: null,\n      });\n\n      processFileAsync(file.id, storagePath, type, name);\n\n      res.json(file);\n    } catch (error: any) {\n      console.error(\"Error creating file:\", error);\n      res.status(500).json({ error: \"Failed to create file\" });\n    }\n  });\n\n  router.delete(\"/api/files/:id\", async (req, res) => {\n    try {\n      await storage.deleteFile(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting file:\", error);\n      res.status(500).json({ error: \"Failed to delete file\" });\n    }\n  });\n\n  router.get(\"/api/files/:id/content\", async (req, res) => {\n    try {\n      const file = await storage.getFile(req.params.id);\n      if (!file) {\n        return res.status(404).json({ error: \"File not found\" });\n      }\n      if (file.status !== \"ready\") {\n        return res.status(202).json({ status: file.status, content: null });\n      }\n      const chunks = await storage.getFileChunks(req.params.id);\n      const content = chunks\n        .sort((a, b) => a.chunkIndex - b.chunkIndex)\n        .map(c => c.content)\n        .join(\"\\n\");\n      res.json({ status: \"ready\", content, fileName: file.name });\n    } catch (error: any) {\n      console.error(\"Error getting file content:\", error);\n      res.status(500).json({ error: \"Failed to get file content\" });\n    }\n  });\n\n  router.get(\"/objects/:objectPath(*)\", async (req, res) => {\n    try {\n      const objectFile = await objectStorageService.getObjectEntityFile(req.path);\n      objectStorageService.downloadObject(objectFile, res);\n    } catch (error) {\n      if (error instanceof ObjectNotFoundError) {\n        return res.sendStatus(404);\n      }\n      console.error(\"Error serving object:\", error);\n      return res.sendStatus(500);\n    }\n  });\n\n  return router;\n}\n\nexport { ObjectStorageService, ObjectNotFoundError };\n","path":null,"size_bytes":14331,"size_tokens":null}},"version":2}